
<!DOCTYPE html>
<html lang="zh-tw">
    
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    
      <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/locale/zh-tw.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
    <script>
      window.algoliaConfig = {
        appId: 'AWFC86Q51O',
        apiKey: 'c9d952906eb1b154d75cf863e75c1ede',
        indexName: 'MyBlog'
      };
      var algoliaIndex = algoliasearch(
        algoliaConfig.appId,
        algoliaConfig.apiKey
      ).initIndex(algoliaConfig.indexName);
    </script>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Kein&#39;s blog">
    <title>分類: devops - Kein&#39;s blog</title>
    <meta name="author" content="Kein Chan">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Kein&#39;s blog">
<meta property="og:url" content="https://keinchan.com/categories/devops/index.html">
<meta property="og:site_name" content="Kein&#39;s blog">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Kein Chan">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://keinchan.com../../assets/images/profile.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="../../assets/css/style-l9zwheso7r7pnk98nvirovsz9dl7fhkrc9mlb5vmuxw7tk5movrk0eevsrpr.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="../../index.html"
            aria-label=""
        >
            Kein&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打開鏈接: ../../#about"
            >
        
        
            <img class="header-picture" src="../../assets/images/profile.jpg" alt="作者的圖片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="../../#about"
                    aria-label="閱讀有關作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="../../assets/images/profile.jpg" alt="作者的圖片"/>
                </a>
                <h4 class="sidebar-profile-name">Kein Chan</h4>
                
                    <h5 class="sidebar-profile-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../index.html"
                            
                            rel="noopener"
                            title="首頁"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首頁</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../all-categories"
                            
                            rel="noopener"
                            title="分類"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分類</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../all-tags"
                            
                            rel="noopener"
                            title="標籤"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">標籤</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../all-archives"
                            
                            rel="noopener"
                            title="所有文章"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">所有文章</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜尋"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜尋</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="關於"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">關於</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/chankein/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/profile/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../mailto:kein.chan85@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Email"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Email</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../atom.xml"
                            
                            rel="noopener"
                            title="Atom"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Atom</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/python-cheat-sheet/"
                            aria-label=": python cheat sheet"
                        >
                            python cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T23:48:40+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="python/">python</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="python">python:</h3>


	<div class="row">
    <embed src="/assets/pdf/python-cheat-sheet.pdf" width="100%" height="550" type="application/pdf">
	</div>



                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/python-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/vim-cheat-sheet/"
                            aria-label=": vim cheat sheet"
                        >
                            vim cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T23:41:16+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="vim/">vim</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="python">python:</h3>


	<div class="row">
    <embed src="/assets/pdf/vim-cheat-sheet.pdf" width="100%" height="550" type="application/pdf">
	</div>



                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/vim-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/ansible-cheat-sheet/"
                            aria-label=": ansible cheat sheet"
                        >
                            ansible cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T23:10:52+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="ansible/">ansible</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="ansible-command">ansible command:</h3>


	<div class="row">
    <embed src="/assets/pdf/ansible-cheat-sheet.pdf" width="100%" height="550" type="application/pdf">
	</div>



<h3 id="playbook">playbook:</h3>


	<div class="row">
    <embed src="/assets/pdf/ansible-playbook.pdf" width="100%" height="550" type="application/pdf">
	</div>



                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/ansible-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/curl-cheat-sheet/"
                            aria-label=": curl cheat sheet"
                        >
                            curl cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T19:47:54+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="curl/">curl</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="curl-command">curl command:</h3>


	<div class="row">
    <embed src="/assets/pdf/curl-cheat-sheet.pdf" width="100%" height="550" type="application/pdf">
	</div>




                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/curl-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/docker-cheat-sheet/"
                            aria-label=": docker cheat sheet"
                        >
                            docker cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T19:36:58+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="docker/">docker</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="docker">docker:</h3>
<p><img src="/assets/images/docker-cheat-sheet.webp" alt="image"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/docker-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/14/git/git-cheat-sheet/"
                            aria-label=": git cheat sheet"
                        >
                            git cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-14T08:57:44+08:00">
	
		    2025 年 5 月 14 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="git/">git</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p><img src="/assets/images/gitcheatsheet.png" alt="image"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/14/git/git-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                            aria-label=": Terraform-小技巧"
                        >
                            Terraform-小技巧
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-01-30T17:43:45+08:00">
	
		    2023 年 1 月 30 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="Terraform/">Terraform</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <ul>
<li><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"><strong>1.9.1.1.</strong> 有条件创建</a></li>
</ul>
<p><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"></a></p>
<h2 id="1-9-1-1-有条件创建"><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"></a>1.9.1.1. 有条件创建</h2>
<p>Terraform被设计成声明式而非命令式，例如没有常见的 <code>if</code> 条件语句，后来才加上了 <code>count</code> 和 <code>for_each</code> 实现的循环语句(但循环的次数必须是在 <code>plan</code> 阶段就能够确认的，无法根据其他 <code>resource</code> 的输出动态决定)</p>
<p>有时候我们需要根据某种条件来判断是否创建一个资源。虽然我们无法使用if来完成条件判断，但我们还有 <code>count</code> 和 <code>for_each</code> 可以帮助我们完成这个目标。</p>
<p>我们以 UCloud 为例，假如我们正在编写一个旨在被复用的模块，模块的逻辑要创建一台虚拟机，我们的代码可以是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">data ucloud_vpcs &quot;default&quot; &#123;</span><br><span class="line">  name_regex = &quot;^Default&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-02&quot;</span><br><span class="line">  image_id = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type = &quot;n-basic-2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;uhost_id&quot; &#123;</span><br><span class="line">  value = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常简单。但是如果我们想进一步，让模块的调用者决定创建的主机是否要搭配一个弹性公网 IP 该怎么办？</p>
<p>我们可以在上面的代码后面接上这样的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;allocate_public_ip&quot; &#123;</span><br><span class="line">  description = &quot;Decide whether to allocate a public ip and bind it to the host&quot;</span><br><span class="line">  type = bool</span><br><span class="line">  default = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip&quot; &quot;public_ip&quot; &#123;</span><br><span class="line">  count = var.allocate_public_ip ? 1 : 0</span><br><span class="line">  name = &quot;public_ip_for_$&#123;ucloud_instance.web.name&#125;&quot;</span><br><span class="line">  internet_type = &quot;bgp&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip_association&quot; &quot;public_ip_binding&quot; &#123;</span><br><span class="line">  count = var.allocate_public_ip ? 1 : 0</span><br><span class="line">  eip_id = ucloud_eip.public_ip[0].id</span><br><span class="line">  resource_id = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们首先创建了名为 <code>allocate_public_ip</code> 的输入变量，然后在编写弹性 IP 相关资源代码的时候都声明了 <code>count</code> 参数，值使用了条件表达式，根据 <code>allocate_public_ip</code> 这个输入变量的值决定是 <code>1</code> 还是 <code>0</code>。这实际上实现了按条件创建资源。</p>
<p>需要注意的是，由于我们使用了 <code>count</code>，所以现在弹性 IP 相关的资源实际上是多实例资源类型的。我们在 <code>ucloud_eip_association.public_ip_binding</code> 中引用 <code>ucloud_eip.public</code> 时，还是要加上访问下标。由于 <code>ucloud_eip_association.public_ip_binding</code> 与 <code>ucloud_eip.public</code> 实际上是同生同死，所以在这里他们之间的引用还比较简单；如果是其他没有声明 <code>count</code> 的资源引用它们的话，还要针对 <code>allocate_public_ip</code> 为 <code>false</code> 时 <code>ucloud_eip.public</code> 实际为空做相应处理，比如在 <code>output</code> 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output &quot;public_ip&quot; &#123;</span><br><span class="line">  value = join(&quot;&quot;, ucloud_eip.public_ip[*].public_ip)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>join</code> 函数就可以在即使没有创建弹性 IP 时也能返回空字符串。或者我们也可以用条件表达式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output &quot;public_ip&quot; &#123;</span><br><span class="line">  value = length(ucloud_eip.public_ip[*].public_ip) &gt; 0 ? ucloud_eip.public_ip[0].public_ip : &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"><strong>1.9.2.1.</strong> 依赖反转</a></li>
</ul>
<p><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"></a></p>
<h2 id="1-9-2-1-依赖反转"><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"></a>1.9.2.1. 依赖反转</h2>
<p>Terraform 编排的基础设施对象彼此之间可能互相存在依赖关系，有时我们在编写一些旨在重用的模块时，模块内定义的资源可能本身需要依赖其他一些资源，这些资源可能已经存在，也可能有待创建。</p>
<p>举一个例子，假设我们编写了一个模块，定义了在 UCloud 上同一个 VPC 中的两台服务器；第一台服务器部署了一个 Web 应用，它被分配在一个 DMZ 子网里；第二台服务器部署了一个数据库，它被分配在一个内网子网里。现在的问题是，在我们编写模块时，我们并没有关于 VPC 和子网的任何信息，我们甚至连服务器应该部署在哪个可用区都不知道。VPC 和子网可能已经存在，也可以有待创建。</p>
<p>我们可以定义这样的一个模块代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    ucloud = &#123;</span><br><span class="line">      source  = &quot;ucloud/ucloud&quot;</span><br><span class="line">      version = &quot;~&gt;1.22.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;network_config&quot; &#123;</span><br><span class="line">  type = object(&#123;</span><br><span class="line">    vpc_id         = string</span><br><span class="line">    web_app_config = object(&#123;</span><br><span class="line">      az        = string</span><br><span class="line">      subnet_id = string</span><br><span class="line">    &#125;)</span><br><span class="line">    db_config      = object(&#123;</span><br><span class="line">      az        = string</span><br><span class="line">      subnet_id = string</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;web_app&quot; &#123;</span><br><span class="line">  name_regex = &quot;^WebApp&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;mysql&quot; &#123;</span><br><span class="line">  name_regex = &quot;^MySql 5.7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web_app&quot; &#123;</span><br><span class="line">  availability_zone = var.network_config.web_app_config.az</span><br><span class="line">  image_id          = data.ucloud_images.web_app.images[0].id</span><br><span class="line">  instance_type     = &quot;n-basic-2&quot;</span><br><span class="line">  vpc_id            = var.network_config.vpc_id</span><br><span class="line">  subnet_id         = var.network_config.web_app_config.subnet_id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;mysql&quot; &#123;</span><br><span class="line">  availability_zone = var.network_config.db_config.az</span><br><span class="line">  image_id          = data.ucloud_images.mysql.images[0].id</span><br><span class="line">  instance_type     = &quot;n-basic-2&quot;</span><br><span class="line">  vpc_id            = var.network_config.vpc_id</span><br><span class="line">  subnet_id         = var.network_config.db_config.subnet_id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在代码中我们把依赖的网络参数定义为一个复杂类型，一个强类型对象结构。这样的话模块代码就不用再关注网络层究竟是查询而来的还是创建的，模块中只定义了抽象的网络层定义，其具体实现由调用者从外部注入，从而实现了依赖反转。</p>
<p>如果调用者需要创建网络层，那么代码可以是这样的(假设我们把前面编写的模块保存在 <code>./machine</code> 目录下而成为一个内嵌模块)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  cidr_blocks = [</span><br><span class="line">    &quot;192.168.0.0/16&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;dmz&quot; &#123;</span><br><span class="line">  cidr_block = &quot;192.168.0.0/24&quot;</span><br><span class="line">  vpc_id     = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;db&quot; &#123;</span><br><span class="line">  cidr_block = &quot;192.168.1.0/24&quot;</span><br><span class="line">  vpc_id     = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module &quot;machine&quot; &#123;</span><br><span class="line">  source         = &quot;./machine&quot;</span><br><span class="line">  network_config = &#123;</span><br><span class="line">    vpc_id         = ucloud_vpc.vpc.id</span><br><span class="line">    web_app_config = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = ucloud_subnet.dmz.id</span><br><span class="line">    &#125;</span><br><span class="line">    db_config      = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = ucloud_subnet.db.id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者我们想使用现存的网络来托管服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">data &quot;ucloud_vpcs&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  name_regex = &quot;^AVeryImportantVpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_subnets&quot; dmz_subnet &#123;</span><br><span class="line">  vpc_id     = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">  name_regex = &quot;^DMZ&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_subnets&quot; &quot;db_subnet&quot; &#123;</span><br><span class="line">  vpc_id     = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">  name_regex = &quot;^DataBase&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module &quot;machine&quot; &#123;</span><br><span class="line">  source         = &quot;./machine&quot;</span><br><span class="line">  network_config = &#123;</span><br><span class="line">    vpc_id         = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">    web_app_config = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = data.ucloud_subnets.dmz_subnet.subnets[0].id</span><br><span class="line">    &#125;</span><br><span class="line">    db_config      = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = data.ucloud_subnets.db_subnet.subnets[0].id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于模块代码中对网络层的定义是抽象的，并没有指定必须是 <code>resource</code> 或是 <code>data</code>，所以使得模块的调用者可以自己决定如何构造模块的依赖层，作为参数注入模块。</p>
<ul>
<li><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"><strong>1.9.3.1.</strong> 多可用区分布</a></li>
</ul>
<p><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"></a></p>
<h2 id="1-9-3-1-多可用区分布"><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"></a>1.9.3.1. 多可用区分布</h2>
<p>这是一个相当常见的小技巧。多数公有云为了高可用性，都在单一区域内提供了多可用区的设计。一个可区是一个逻辑上的数据中心，单个可用区可能由于各种自然灾害、网络故障而导致不可用，所以公有云应用部署高可用应用应时刻考虑跨可用区设计。</p>
<p>假如我们想要创建 N 台不同的云主机实例，在 Terraform 0.12 之前的版本中，我们只能用 <code>count</code> 配合模运算来达成这个目的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type    = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;instance_count&quot; &#123;</span><br><span class="line">  type    = number</span><br><span class="line">  default = 4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  count             = var.instance_count</span><br><span class="line">  availability_zone = var.az[count.index % length(var.az)]</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  name              = &quot;$&#123;var.az[count.index % length(var.az)]&#125;-$&#123;floor(count.index/length(var.az))&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说就是使用 <code>count</code> 创建多实例资源时，用 <code>var.az[count.index % length(var.az)]</code> 可以循环使用每个可用区，使得机器尽可能均匀分布在各个可用区。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web[2]: Creating...</span><br><span class="line">ucloud_instance.web[0]: Creating...</span><br><span class="line">ucloud_instance.web[1]: Creating...</span><br><span class="line">ucloud_instance.web[3]: Creating...</span><br><span class="line">ucloud_instance.web[2]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[1]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[3]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[2]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[1]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[3]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[2]: Creation complete after 22s [<span class="built_in">id</span>=uhost-txa2owrp]</span><br><span class="line">ucloud_instance.web[3]: Creation complete after 24s [<span class="built_in">id</span>=uhost-v3qxdbju]</span><br><span class="line">ucloud_instance.web[1]: Creation complete after 26s [<span class="built_in">id</span>=uhost-td3x545p]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Creation complete after 43s [<span class="built_in">id</span>=uhost-scq1prqj]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 4 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure>
<p>我们可以看一下创建的主机信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line">$ terraform show</span><br><span class="line"><span class="comment"># data.ucloud_images.centos:</span></span><br><span class="line">data <span class="string">&quot;ucloud_images&quot;</span> <span class="string">&quot;centos&quot;</span> &#123;</span><br><span class="line">    <span class="built_in">id</span>          = <span class="string">&quot;475496684&quot;</span></span><br><span class="line">    ids         = [</span><br><span class="line">        <span class="string">&quot;uimage-22noyd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-3p0wg0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-4keil1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-aqvo5l&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-f1chxn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-hq5elw&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-rkn1v2&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    images      = [</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-23T17:39:46+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.0 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.0 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:03+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-f1chxn&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.2 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.2 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-09-09T11:40:31+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot; &quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-aqvo5l&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.4 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.4 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2020-05-07T17:40:42+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CloudInit&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-hq5elw&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.6 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.6 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:05+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-3p0wg0&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.3 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.3 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:02+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-4keil1&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.1 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.1 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:04:53+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-22noyd&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.5 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.5 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    most_recent = <span class="literal">false</span></span><br><span class="line">    name_regex  = <span class="string">&quot;^CentOS 7&quot;</span></span><br><span class="line">    total_count = 7</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[1]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-04-0&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[2]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[3]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;31e2cad6-79a1-4475-a9f5-2c5c95605b18&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-v3qxdbju&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-04-1&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[0]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;da27595d-9645-4883-bf95-87b9076ab7e4&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-scq1prqj&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.107.152&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-03-0&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.107.152&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，主机的确是均匀地分散在两个可用区了。</p>
<p>但是这样做在调整可用区时会发生大问题，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">#    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们禁用了 <code>cn-bj2-04</code> 可用区，按道理我们期待的变更计划应该是将两台原本属于 <code>cn-bj2-04</code> 的主机删除，在 <code>cn-bj2-03</code> 可用区新增两台主机。让我们看看会发生什么：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to <span class="built_in">local</span> or remote state storage.</span><br><span class="line"></span><br><span class="line">data.ucloud_images.centos: Refreshing state... [<span class="built_in">id</span>=475496684]</span><br><span class="line">ucloud_instance.web[0]: Refreshing state... [<span class="built_in">id</span>=uhost-scq1prqj]</span><br><span class="line">ucloud_instance.web[3]: Refreshing state... [<span class="built_in">id</span>=uhost-v3qxdbju]</span><br><span class="line">ucloud_instance.web[2]: Refreshing state... [<span class="built_in">id</span>=uhost-txa2owrp]</span><br><span class="line">ucloud_instance.web[1]: Refreshing state... [<span class="built_in">id</span>=uhost-td3x545p]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">An execution plan has been generated and is shown below.</span><br><span class="line">Resource actions are indicated with the following symbols:</span><br><span class="line">  ~ update in-place</span><br><span class="line">-/+ destroy and <span class="keyword">then</span> create replacement</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[1] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.44.37&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[2] will be updated in-place</span></span><br><span class="line">  ~ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">        auto_renew        = <span class="literal">true</span></span><br><span class="line">        availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">        boot_disk_size    = 20</span><br><span class="line">        boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">        cpu               = 1</span><br><span class="line">        cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">        create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">        disk_set          = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">                is_boot = <span class="literal">true</span></span><br><span class="line">                size    = 20</span><br><span class="line">                <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">        expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">        <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">        image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">        ip_set            = [</span><br><span class="line">            &#123;</span><br><span class="line">                internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">                ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">        memory            = 4</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-03-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">        private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">        root_password     = (sensitive value)</span><br><span class="line">        security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">        status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">        subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">        vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[3] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;31e2cad6-79a1-4475-a9f5-2c5c95605b18&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-v3qxdbju&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-3&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.85.40&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 1 to change, 2 to destroy.</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Note: You didn<span class="string">&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraform</span></span><br><span class="line"><span class="string">can&#x27;</span>t guarantee that exactly these actions will be performed <span class="keyword">if</span></span><br><span class="line"><span class="string">&quot;terraform apply&quot;</span> is subsequently run.</span><br></pre></td></tr></table></figure>
<p>变更计划与期望略有不同。我们仔细看细节：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ucloud_instance.web[2] will be updated in-place</span></span><br><span class="line">~ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      auto_renew        = <span class="literal">true</span></span><br><span class="line">      availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      boot_disk_size    = 20</span><br><span class="line">      boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">      charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      cpu               = 1</span><br><span class="line">      cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">      create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">      disk_set          = [</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">              is_boot = <span class="literal">true</span></span><br><span class="line">              size    = 20</span><br><span class="line">              <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">      ]</span><br><span class="line">      expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">      <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">      image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">      instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ip_set            = [</span><br><span class="line">          &#123;</span><br><span class="line">              internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">      ]</span><br><span class="line">      memory            = 4</span><br><span class="line">    ~ name              = <span class="string">&quot;cn-bj2-03-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">      private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">      root_password     = (sensitive value)</span><br><span class="line">      security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">      status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">      subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">      tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>原本名为 <code>cn-bj2-03-1</code> 的主机被更名为 <code>cn-bj2-03-2</code> 了，原本属于 <code>cn-bj2-04</code> 的第一台主机的变更计划是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># ucloud_instance.web[1] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.44.37&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>它的名字从 <code>cn-bj2-04-0</code> 变成了 <code>cn-bj2-03-1</code>。</p>
<p>仔细想想，实际上这是一个比较低效的变更计划。原本属于 <code>cn-bj2-03</code> 的两台主机应该不做任何变更，只需要删除 <code>cn-bj2-04</code> 的主机，再补充两台 <code>cn-bj2-03</code> 的主机即可。这是因为我们使用的是 <code>count</code>，而 <code>count</code> 只看元素在列表中的序号。当我们删除一个可用区时，实际上会引起主机序号的重大变化，导致出现大量低效的变更，这就是我们在讲 <code>count</code> 与 <code>for_each</code> 时强调过的，如果创建的资源实例彼此之间几乎完全一致，那么 <code>count</code> 比较合适。否则，那么使用 <code>for_each</code> 会更加安全。</p>
<p>让我们尝试使用 <code>for_each</code> 改写这段逻辑：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type    = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;instance_count&quot; &#123;</span><br><span class="line">  type    = number</span><br><span class="line">  default = 4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">locals &#123;</span><br><span class="line">  instance_names = [for i in range(var.instance_count):&quot;$&#123;var.az[i%length(var.az)]&#125;-$&#123;floor(i/length(var.az))&#125;&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  for_each          = toset(local.instance_names)</span><br><span class="line">  name              = each.value</span><br><span class="line">  availability_zone = var.az[index(local.instance_names, each.value) % length(var.az)]</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了生成主机独一无二的名字，我们首先用 <code>range</code> 函数生成了一个序号集合，比如目标主机数是 <code>4</code>，那么 <code>range(4)</code> 的结果就是 <code>[0, 1, 2, 3]</code>；然后我们通过取模运算使得名字前缀在可用区列表之间循环递增，最后用 <code>floor(i/length(var.az))</code> 计算出当前序号对应在当前可用区是第几台。例如 4 号主机在第二个可用区就是第二台，生成的名字应该就是 <code>cn-bj-04-1</code>。</p>
<p>执行结果是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Creation complete after 21s [<span class="built_in">id</span>=uhost-fjci1i4o]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Creation complete after 23s [<span class="built_in">id</span>=uhost-bkkhmref]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Creation complete after 26s [<span class="built_in">id</span>=uhost-amosgdaa]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Creation complete after 45s [<span class="built_in">id</span>=uhost-kltudgnf]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 4 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure>
<p>如果我们去掉一个可用区：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">#    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以检查一下执行计划：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to <span class="built_in">local</span> or remote state storage.</span><br><span class="line"></span><br><span class="line">data.ucloud_images.centos: Refreshing state... [<span class="built_in">id</span>=475496684]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-amosgdaa]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-bkkhmref]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-kltudgnf]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-fjci1i4o]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">An execution plan has been generated and is shown below.</span><br><span class="line">Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line">  - destroy</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-03-2&quot;] will be created</span></span><br><span class="line">  + resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      + auto_renew        = (known after apply)</span><br><span class="line">      + availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      + boot_disk_size    = (known after apply)</span><br><span class="line">      + boot_disk_type    = (known after apply)</span><br><span class="line">      + charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      + cpu               = (known after apply)</span><br><span class="line">      + cpu_platform      = (known after apply)</span><br><span class="line">      + create_time       = (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      + disk_set          = (known after apply)</span><br><span class="line">      + expire_time       = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                = (known after apply)</span><br><span class="line">      + image_id          = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">      + instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      + ip_set            = (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      + memory            = (known after apply)</span><br><span class="line">      + name              = <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">      + private_ip        = (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      + root_password     = (sensitive value)</span><br><span class="line">      + security_group    = (known after apply)</span><br><span class="line">      + status            = (known after apply)</span><br><span class="line">      + subnet_id         = (known after apply)</span><br><span class="line">      + tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      + vpc_id            = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-03-3&quot;] will be created</span></span><br><span class="line">  + resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      + auto_renew        = (known after apply)</span><br><span class="line">      + availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      + boot_disk_size    = (known after apply)</span><br><span class="line">      + boot_disk_type    = (known after apply)</span><br><span class="line">      + charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      + cpu               = (known after apply)</span><br><span class="line">      + cpu_platform      = (known after apply)</span><br><span class="line">      + create_time       = (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      + disk_set          = (known after apply)</span><br><span class="line">      + expire_time       = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                = (known after apply)</span><br><span class="line">      + image_id          = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">      + instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      + ip_set            = (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      + memory            = (known after apply)</span><br><span class="line">      + name              = <span class="string">&quot;cn-bj2-03-3&quot;</span></span><br><span class="line">      + private_ip        = (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      + root_password     = (sensitive value)</span><br><span class="line">      + security_group    = (known after apply)</span><br><span class="line">      + status            = (known after apply)</span><br><span class="line">      + subnet_id         = (known after apply)</span><br><span class="line">      + tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      + vpc_id            = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-04-0&quot;] will be destroyed</span></span><br><span class="line">  - resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      - auto_renew        = <span class="literal">true</span> -&gt; null</span><br><span class="line">      - availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; null</span><br><span class="line">      - boot_disk_size    = 20 -&gt; null</span><br><span class="line">      - boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; null</span><br><span class="line">      - charge_type       = <span class="string">&quot;dynamic&quot;</span> -&gt; null</span><br><span class="line">      - cpu               = 1 -&gt; null</span><br><span class="line">      - cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; null</span><br><span class="line">      - create_time       = <span class="string">&quot;2020-11-28T22:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;b214d840-ffec-4958-a3da-3580846fd2a3&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - expire_time       = <span class="string">&quot;2020-11-28T23:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - <span class="built_in">id</span>                = <span class="string">&quot;uhost-bkkhmref&quot;</span> -&gt; null</span><br><span class="line">      - image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; null</span><br><span class="line">      - instance_type     = <span class="string">&quot;n-standard-1&quot;</span> -&gt; null</span><br><span class="line">      - ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.48.82&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - memory            = 4 -&gt; null</span><br><span class="line">      - name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; null</span><br><span class="line">      - private_ip        = <span class="string">&quot;10.9.48.82&quot;</span> -&gt; null</span><br><span class="line">      - root_password     = (sensitive value)</span><br><span class="line">      - security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; null</span><br><span class="line">      - status            = <span class="string">&quot;Running&quot;</span> -&gt; null</span><br><span class="line">      - subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; null</span><br><span class="line">      - tag               = <span class="string">&quot;Default&quot;</span> -&gt; null</span><br><span class="line">      - vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-04-1&quot;] will be destroyed</span></span><br><span class="line">  - resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      - auto_renew        = <span class="literal">true</span> -&gt; null</span><br><span class="line">      - availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; null</span><br><span class="line">      - boot_disk_size    = 20 -&gt; null</span><br><span class="line">      - boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; null</span><br><span class="line">      - charge_type       = <span class="string">&quot;dynamic&quot;</span> -&gt; null</span><br><span class="line">      - cpu               = 1 -&gt; null</span><br><span class="line">      - cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; null</span><br><span class="line">      - create_time       = <span class="string">&quot;2020-11-28T22:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;6a3f274f-e072-4a46-90f8-edc7dbaa27f7&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - expire_time       = <span class="string">&quot;2020-11-28T23:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - <span class="built_in">id</span>                = <span class="string">&quot;uhost-fjci1i4o&quot;</span> -&gt; null</span><br><span class="line">      - image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; null</span><br><span class="line">      - instance_type     = <span class="string">&quot;n-standard-1&quot;</span> -&gt; null</span><br><span class="line">      - ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.176.28&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - memory            = 4 -&gt; null</span><br><span class="line">      - name              = <span class="string">&quot;cn-bj2-04-1&quot;</span> -&gt; null</span><br><span class="line">      - private_ip        = <span class="string">&quot;10.9.176.28&quot;</span> -&gt; null</span><br><span class="line">      - root_password     = (sensitive value)</span><br><span class="line">      - security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; null</span><br><span class="line">      - status            = <span class="string">&quot;Running&quot;</span> -&gt; null</span><br><span class="line">      - subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; null</span><br><span class="line">      - tag               = <span class="string">&quot;Default&quot;</span> -&gt; null</span><br><span class="line">      - vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 2 to destroy.</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Note: You didn<span class="string">&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraform</span></span><br><span class="line"><span class="string">can&#x27;</span>t guarantee that exactly these actions will be performed <span class="keyword">if</span></span><br><span class="line"><span class="string">&quot;terraform apply&quot;</span> is subsequently run.</span><br></pre></td></tr></table></figure>
<p>可以看到，原来属于 <code>cn-bj2-03</code> 的两台主机原封不动，删除了属于 <code>cn-bj2-04</code> 的两台主机，并且在 <code>cn-bj2-03</code> 可用区新增两台主机。</p>
<ul>
<li><a href="#provisioner-%E4%B8%8E-userdata"><strong>1.9.4.1.</strong> provisioner 与 user_data</a></li>
</ul>
<p><a href="#provisioner-%E4%B8%8E-userdata"></a></p>
<h2 id="1-9-4-1-provisioner-与-user-data"><a href="#provisioner-%E4%B8%8E-userdata"></a>1.9.4.1. provisioner 与 user_data</h2>
<p>我们在介绍资源时介绍了<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/6.%E8%B5%84%E6%BA%90.html#provisioner-%E5%92%8C-connection">预置器 <code>provisioner</code></a>。同时不少公有云厂商的虚拟机都提供了 cloud-init 功能，可以让我们在虚拟机实例第一次启动时执行一段自定义的脚本来执行一些初始化操作。例如我们在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/1.Terraform%E5%88%9D%E6%AD%A5%E4%BD%93%E9%AA%8C/">Terraform 初步体验</a>一章里举的例子，在 UCloud 主机第一次启动时我们通过 <code>user_data</code> 来调用 yum 安装并配置了 ngnix 服务。预置器与 cloud-init 都可以用于初始化虚拟机，那么我们应该用哪一种呢？</p>
<p>首先要指出的是，<code>provisioner</code> 的官方文档里明确指出，由于预置器内部的行为 Terraform 无法感知，无法将它执行的变更纳入到声明式的代码管理中，所以预置器应被作为最后的手段使用，那么也就是说，如果 cloud-init 能够满足我们的要求，那么我们应该优先使用 cloud-init。</p>
<p>但是仍然存在一些 cloud-init 无法满足的场景。例如一个最常见的情况是，比如我们要在 cloud-init 当中格式化卷，后续的所有操作都必须在主机成功格式化并挂载卷之后才能顺利进行下去。但是比如 <code>aws_instance</code>，它的创建是不会等待 <code>user_data</code> 代码执行完成的，只要虚拟机创建成功开始启动，Terraform 就会认为资源创建完成从而继续后续的创建了。</p>
<p>解决这个问题目前来看还是只能依靠预置器。我们以一段 UCloud 云主机代码为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone         = &quot;cn-bj2-03&quot;</span><br><span class="line">  image_id                  = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type             = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type               = &quot;dynamic&quot;</span><br><span class="line">  network_interface &#123;</span><br><span class="line">    eip_internet_type = &quot;bgp&quot;</span><br><span class="line">    eip_charge_mode   = &quot;traffic&quot;</span><br><span class="line">    eip_bandwidth     = 1</span><br><span class="line">  &#125;</span><br><span class="line">  delete_eips_with_instance = true</span><br><span class="line">  root_password             = var.root_password</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = [for ipset in self.ip_set: ipset.ip if ipset.internet_type==&quot;BGP&quot;][0]</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">      timeout  = &quot;1h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;sleep 1h&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在资源声明中附加了一个 <code>remote-exec</code> 类型的预置器，它的 <code>host</code> 取值使用了 <code>self.ip_set</code>，<code>self</code> 在当前上下文中指代 <code>provisioner</code> 所属的 <code>ucloud_instance.web</code>，<code>ip_set</code> 是 <code>ucloud_instance</code> 的一个输出属性，内含云主机的内网 IP 以及绑定的弹性公网 IP 信息。我们用一个 <code>for</code> 表达式过滤出弹性公网 IP 地址，然后使用 ssh 连接。预置器执行的脚本代码很简单，休眠一小时。如果我们执行这段代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web: Creating...</span><br><span class="line">ucloud_instance.web: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web: Provisioning with <span class="string">&#x27;remote-exec&#x27;</span>...</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec): Connected!</span><br><span class="line">ucloud_instance.web: Still creating... [50s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m0s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m10s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m20s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m30s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m40s elapsed]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>不出所料的话，该过程会持续一小时，也就是说，无论预置器脚本中执行的操作耗时多长，<code>ucloud_instance</code> 的创建都会等待它完成，或是触发超时。</p>
<p>在这里我们可以使用这种方法的前提是我们使用的 UCloud 云主机的资源定义允许我们定义资源时声明 <code>network_interface</code> 属性，直接绑定一个公网 IP。如果我们使用的云厂商 Provider 无法让我们在创建主机时绑定公网 IP，而是必须事后绑定弹性 IP 呢？又或者，初始化脚本必须在云主机成功绑定了云盘之后才能成功运行？这种情况下我们还有最后的武器，就是 <code>null_resource</code>。</p>
<p><code>null_resource</code> 可能是 Terraform 体系中最“不 Terraform”的存在，它就是我们用来在 Terraform 这样一个声明式世界里干各种命令式脏活的工具。<code>null_resouce</code> 本身是一个空的 <code>resource</code>，只有一个名为 <code>triggers</code> 的参数以及 <code>id</code> 作为输出属性。</p>
<p>我们看下这个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip&quot; &quot;eip&quot; &#123;</span><br><span class="line">  internet_type = &quot;bgp&quot;</span><br><span class="line">  bandwidth     = 1</span><br><span class="line">  charge_mode   = &quot;traffic&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_disk&quot; &quot;data_disk&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  disk_size         = 10</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  disk_type         = &quot;data_disk&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  root_password     = var.root_password</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip_association&quot; &quot;eip_association&quot; &#123;</span><br><span class="line">  eip_id      = ucloud_eip.eip.id</span><br><span class="line">  resource_id = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_disk_attachment&quot; &quot;data_disk&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  disk_id           = ucloud_disk.data_disk.id</span><br><span class="line">  instance_id       = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;web_init&quot; &#123;</span><br><span class="line">  depends_on = [</span><br><span class="line">    ucloud_eip_association.eip_association,</span><br><span class="line">    ucloud_disk_attachment.data_disk</span><br><span class="line">  ]</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = ucloud_eip.eip.public_ip</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">    &#125;</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;echo hello&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们假设需要远程执行的操纵是必须在云盘挂载成功以后才可以运行的，那么我们可以声明一个 <code>null_resource</code>，把 <code>provisioner</code> 声明放在那里，通过显式声明 <code>depends_on</code> 确保它的执行一定是在云盘挂载结束以后。</p>
<p>另外这个例子里我们运行的脚本非常简单，考虑一种更加复杂一些的场景，我们运行的脚本是通过文件读取的，我们希望在文件内容发生变化时能够重新在服务器上运行该脚本，这时我们可以使用 <code>null_resource</code> 的 <code>triggers</code> 参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;null_resource&quot; &quot;web_init&quot; &#123;</span><br><span class="line">  depends_on = [</span><br><span class="line">    ucloud_eip_association.eip_association,</span><br><span class="line">    ucloud_disk_attachment.data_disk</span><br><span class="line">  ]</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    script_hash = filemd5(&quot;$&#123;path.module&#125;/init.sh&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = ucloud_eip.eip.public_ip</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">    &#125;</span><br><span class="line">    script = &quot;$&#123;path.module&#125;/init.sh&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在 <code>provisioner</code> 运行的脚本是通过 <code>script</code> 参数传入的脚本文件路径，而我们通过 <code>filemd5</code> 函数把文件内容的哈希值传入了 <code>triggers</code>。<code>triggers</code> 会在值发生改变时触发 <code>null_resource</code> 的重建，这样脚本发生些许变化都会导致重新执行。</p>
<p>官方文档上还给出了对于 <code>triggers</code> 的另一个妙用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_instance&quot; &quot;cluster&quot; &#123;</span><br><span class="line">  count = 3</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;cluster&quot; &#123;</span><br><span class="line">  # Changes to any instance of the cluster requires re-provisioning</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    cluster_instance_ids = &quot;$&#123;join(&quot;,&quot;, aws_instance.cluster.*.id)&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # Bootstrap script can run on any instance of the cluster</span><br><span class="line">  # So we just choose the first in this case</span><br><span class="line">  connection &#123;</span><br><span class="line">    host = &quot;$&#123;element(aws_instance.cluster.*.public_ip, 0)&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    # Bootstrap script called with private_ip of each node in the clutser</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;bootstrap-cluster.sh $&#123;join(&quot; &quot;, aws_instance.cluster.*.private_ip)&#125;&quot;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子里，我们需要所有 AWS 主机的内网 IP 参与才能够成功初始化集群，可能是类似 Kafka 或是 RabbitMQ 这样的应用，我们需要把集群节点的IP写入配置文件。如何确保未来机器数量发生调整以后，机器上的配置文件始终能够获得完整的集群内网 IP 信息，这里使用 <code>triggers</code> 就可以轻松完成目标。</p>
<p>另外在绝大多数生产环境中，服务器都不允许拥有独立的公网 IP，或是禁止从服务器对外服务的公网 IP 直接连接 ssh。这时一般我们会在集群中配置一台堡垒机，通过堡垒机进行跳转连接。可以访问<a target="_blank" rel="noopener" href="https://www.terraform.io/docs/provisioners/connection.html#connecting-through-a-bastion-host-with-ssh">通过堡垒机使用SSH的官方文档</a>获取详细信息，在此不再赘述。</p>
<h2 id="destroy-provisioner中使用变量"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">destroy-provisioner中使用变量</a></h2>
<ul>
<li>
<p><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"><strong>1.9.5.1.</strong> destroy-provisioner 中使用变量</a></p>
</li>
<li>
<p><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><strong>1.9.5.1.1.</strong> 解决方法</a></p>
</li>
</ul>
<p><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"></a></p>
<h2 id="1-9-5-1-destroy-provisioner-中使用变量"><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"></a>1.9.5.1. destroy-provisioner 中使用变量</h2>
<p>我们可以在定义一个 <code>provisioner</code> 块时设置 <code>when</code> 为 <code>destroy</code>，资源在销毁<strong>之前</strong>会首先执行 <code>provisioner</code>，可以帮助我们执行一些析构逻辑。但是如果我们在 Destroy-Provisioner 中引用了变量的话，比如这样的代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_volume_attachment&quot;</span> <span class="string">&quot;attachement_myservice&quot;</span> &#123;</span><br><span class="line">  count         = <span class="string">&quot;$&#123;length(var.network_myservice_subnet_ids)&#125;&quot;</span></span><br><span class="line">  device_name   = <span class="string">&quot;/dev/xvdg&quot;</span></span><br><span class="line">  volume_id     =   <span class="string">&quot;$&#123;element(aws_ebs_volume.ebs_myservice.*.id, count.index)&#125;&quot;</span></span><br><span class="line">  instance_id   =   <span class="string">&quot;$&#123;element(aws_instance.myservice.*.id, count.index)&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">  provisioner <span class="string">&quot;local-exec&quot;</span> &#123;</span><br><span class="line">    command = <span class="string">&quot;aws ec2 stop-instances --instance-ids $&#123;element(aws_instance.myservice.*.id, count.index)&#125; --region $&#123;var.region&#125; &amp;&amp; sleep 30&quot;</span></span><br><span class="line">    when = <span class="string">&quot;destroy&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们会看见这样的报错信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|  Error: Invalid reference from destroy provisioner</span><br><span class="line">│ </span><br><span class="line">│ Destroy-time provisioners and their connection configurations may only reference attributes of the related resource, via &#x27;self&#x27;, &#x27;count.index&#x27;, or &#x27;each.key&#x27;.</span><br><span class="line">│ </span><br><span class="line">│ References to other resources during the destroy phase can cause dependency cycles and interact poorly with create_before_destroy.</span><br></pre></td></tr></table></figure>
<p>从 <code>0.12</code> 开始 Terraform 会对在 Destroy-Time Provisioner 中引用除 <code>self</code>、<code>count.index</code>、<code>each.key</code> 以外的变量做警告，从 <code>0.13</code> 开始则会直接报错。</p>
<h2 id="1-9-5-1-1-解决方法"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"></a>1.9.5.1.1. 解决方法</h2>
<p>目前官方推荐的做法是把需要引用的变量值通过 <code>triggers</code> “捕获”一下再引用，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">&quot;null_resource&quot;</span> <span class="string">&quot;foo&quot;</span> &#123;</span><br><span class="line">  triggers &#123;</span><br><span class="line">    interpreter = <span class="keyword">var</span>.local_exec_interpreter</span><br><span class="line">  &#125;</span><br><span class="line">  provisioner &#123;</span><br><span class="line">    when = destroy</span><br><span class="line"></span><br><span class="line">    interpreter = self.triggers.interpreter</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这种方法就可以避免这个问题。</p>
<ul>
<li>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"><strong>1.9.6.1.</strong> 利用 null_resource 的 triggers 触发其他资源更新</a></p>
</li>
<li>
<p><a href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><strong>1.9.6.1.1.</strong> 问题描述</a></p>
</li>
<li>
<p><a href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><strong>1.9.6.1.2.</strong> 问题原因</a></p>
</li>
<li>
<p><a href="#%E5%B7%A7%E7%94%A8-nullresource-%E7%9A%84-triggers"><strong>1.9.6.1.3.</strong> 巧用 null_resource 的 triggers</a></p>
</li>
<li>
<p><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%AE%9E%E9%AA%8C"><strong>1.9.6.1.4.</strong> 一个小实验</a></p>
</li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"></a></p>
<h2 id="1-9-6-1-利用-null-resource-的-triggers-触发其他资源更新"><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"></a>1.9.6.1. 利用 null_resource 的 triggers 触发其他资源更新</h2>
<p>社区有人提了一个 Terraform 问题，他写了这样一段 Terraform 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;service_bus_connection_string&quot; &#123;</span><br><span class="line">  name = &quot;service-bus-connection-string&quot;</span><br><span class="line"></span><br><span class="line">  value        = azurerm_servicebus_topic_authorization_rule.mysb.primary_connection_string</span><br><span class="line">  key_vault_id = azurerm_key_vault.main.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_function_app&quot; &quot;main&quot; &#123;</span><br><span class="line">  name                = &quot;myfn&quot;</span><br><span class="line">  location            = azurerm_resource_group.main.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.main.name</span><br><span class="line"></span><br><span class="line">  app_service_plan_id = azurerm_app_service_plan.main.id</span><br><span class="line"></span><br><span class="line">  enable_builtin_logging = true</span><br><span class="line">  https_only             = true</span><br><span class="line">  os_type                = &quot;linux&quot;</span><br><span class="line"></span><br><span class="line">  storage_account_name       = azurerm_storage_account.main.name</span><br><span class="line">  storage_account_access_key = azurerm_storage_account.main.primary_access_key</span><br><span class="line"></span><br><span class="line">  version = &quot;~3&quot;</span><br><span class="line"></span><br><span class="line">  app_settings = &#123;</span><br><span class="line">    AzureWebJobsServiceBus      = &quot;@Microsoft.KeyVault(SecretUri=$&#123;azurerm_key_vault_secret.service_bus_connection_string.id&#125;)&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>意思大概是他把一段含有机密信息的连接字符串保存在 Azure KeyVault 服务中，然后创建了一个 Azure Faas 函数，通过 KeyVault 机密引用地址传递该机密。</p>
<h2 id="1-9-6-1-1-问题描述"><a href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"></a>1.9.6.1.1. 问题描述</h2>
<p>这位老兄发现，如果他修改了机密的内容，也就是 <code>azurerm_key_vault_secret</code> 声明里的 <code>value = azurerm_servicebus_topic_authorization_rule.mysb.primary_connection_string</code> 这一段的值的时候，KeyVault 保存的机密内容的确会正确更新，但 Azure Function 读取到的还是旧的机密引用地址，也就是这段代码中得到的 KeyVault 机密引用地址没有更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app_settings = &#123;</span><br><span class="line">  AzureWebJobsServiceBus      = &quot;@Microsoft.KeyVault(SecretUri=$&#123;azurerm_key_vault_secret.service_bus_connection_string.id&#125;)&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更加奇怪的是，这之后他什么都没有做，只是重新再执行一次 <code>terraform apply</code>，该引用地址又被正确更新了？！</p>
<h2 id="1-9-6-1-2-问题原因"><a href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"></a>1.9.6.1.2. 问题原因</h2>
<p>因为 KeyVault Secret 被设计成是不可变的，所以更新 <code>azurerm_key_vault_secret</code> 的 <code>value</code> 会导致资源被重新创建。Terraform 官网上的相关文档中对该参数的定义如下：</p>
<blockquote>
<p><code>value</code> - (Required) Specifies the value of the Key Vault Secret.</p>
</blockquote>
<p>在 Terraform 中 ，一个参数如果被标记为 <code>Required</code>，那么它不但是必填项，同时类似数据库记录的主键的概念，主键不同的记录被认定是两条不同的记录，修改记录的主键值可以看作是删除重建之。Terraform 资源的 <code>Required</code> 参数如果发生变化会触发重新创建资源，这就导致了修改 <code>value</code> 后，该 <code>azurerm_key_vault_secret</code> 的 <code>id</code> 也会发生变化。</p>
<p>那么为什么在 <code>azurerm_key_vault_secret</code> 被重新创建之后，我们会发现 <code>azurerm_function_app</code> 中引用的 <code>id</code> 没有变化呢？</p>
<p>Terraform 的工作流含有 Plan 和 Apply 两个主要阶段，首先会分析 Terraform 代码，调用 <code>terraform refresh</code>（可以用参数跳过该步骤）读取资源在云端目前的最新状态，再加上 State 文件中记录的状态，三个状态对比出一个执行计划，使得最终产生的云端状态能够符合当前代码描述的状态。</p>
<p>就这个场景而言，Terraform 能够意识到 <code>azurerm_key_vault_secret</code> 的参数发生了变化，这会导致某种程度的更新，但它无法意识到这个更新会导致 <code>azurerm_key_vault_secret</code> 的 <code>id</code> 发生变化，进而导致 <code>azurerm_function_app</code> 也必须进行更新，所以就发生了他第一次执行 <code>terraform apply</code> 后看到的情况。</p>
<p>当他第二次执行 <code>terraform apply</code> 时，Terraform 记录的 State 文件里，<code>azurerm_key_vault_secret</code> 的 <code>id</code>和<code>azurerm_function_app</code> 里使用的 <code>id</code> 已经对不上了，这时 Terraform 会再生成一个更新 <code>azurerm_function_app</code> 的 Plan，执行后一切恢复正常。</p>
<p>有没有办法让 <code>azurerm_function_app</code> 能在第一次生成 Plan 时就感知到这个变更？</p>
<h2 id="1-9-6-1-3-巧用-null-resource-的-triggers"><a href="#%E5%B7%A7%E7%94%A8-nullresource-%E7%9A%84-triggers"></a>1.9.6.1.3. 巧用 null_resource 的 triggers</h2>
<p>HashiCorp 提供了一个非常常用的内建 Provider —— <code>null</code>。其中最知名的资源就是 <code>null_resource</code> 了，一般它都是和 <code>provisioner</code> 搭配出现，可以用来在某些资源创建完成后执行一些自定义脚本等等。但是它还有一个很有用的参数：</p>
<blockquote>
<p>The <code>triggers</code> argument allows specifying an arbitrary set of values that, when changed, will cause the resource to be replaced.</p>
</blockquote>
<p><code>triggers</code> 参数可以用来指向一些值，只要这些值的内容发生了变动，会导致 <code>null_resource</code> 资源被重新创建，从而生成一个新的 <code>id</code>。</p>
<h2 id="1-9-6-1-4-一个小实验"><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%AE%9E%E9%AA%8C"></a>1.9.6.1.4. 一个小实验</h2>
<p>我们尝试构建一个简单的实验环境来验证一下，首先是这样一段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;example&quot; &#123;</span><br><span class="line">  name         = &quot;secret-sauce&quot;</span><br><span class="line">  value        = &quot;szechuan&quot;</span><br><span class="line">  key_vault_id = azurerm_key_vault.example.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;local_file&quot; &quot;output&quot; &#123;</span><br><span class="line">  filename = &quot;$&#123;path.module&#125;/output.txt&quot;</span><br><span class="line">  content = azurerm_key_vault_secret.example.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们创建一个 <code>azurerm_key_vault_secret</code>，然后把它的 <code>id</code> 输出到一个文件里。随后我们复制一下该文件，比如叫 <code>output.bak</code> 好了。随后我们修改 <code>azurerm_key_vault_secret</code> 的 <code>value</code> 到一个新的值，执行 <code>terraform apply</code> 以后，我们会发现 <code>output.txt</code> 与 <code>output.bak</code> 的内容完全一样，说明 <code>value</code> 的更新并没有触发 <code>local_file</code> 的更新。</p>
<p>随后我们把代码改成这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;example&quot; &#123;</span><br><span class="line">  name         = &quot;secret-sauce&quot;</span><br><span class="line">  value        = &quot;szechuan2&quot;</span><br><span class="line">  key_vault_id = azurerm_key_vault.example.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;example&quot; &#123;</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    trigger = azurerm_key_vault_secret.example.value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;local_file&quot; &quot;output&quot; &#123;</span><br><span class="line">  filename = &quot;$&#123;path.module&#125;/output.txt&quot;</span><br><span class="line">  content = null_resource.example.id == null_resource.example.id ? azurerm_key_vault_secret.example.id : &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在代码中插入了一个 <code>null_resource</code>，并设置 <code>triggers</code> 的内容，盯住 <code>azurerm_key_vault_secret.example.value</code>。在 <code>value</code> 发生变化时，<code>null_resource</code> 的 <code>id</code> 也会发生变化。</p>
<p>然后我们在 <code>local_file</code> 的代码中，<code>content</code> 的赋值改成了这样一个三目表达式：<code>null_resource.example.id == null_resource.example.id ? azurerm_key_vault_secret.example.id : &quot;&quot;</code>。这个表达式里实际上 <code>null_resource.example.id</code> 是不起作用的，自己等于自己的永真条件会导致仍然使用 <code>azurerm_key_vault_secret.example.id</code> 作为值，但是由于掺入了 <code>null_resource.example.id</code>，使得 Terraform 在第一次计算 Plan 时就感知到 <code>local_file</code> 的内容发生了变化，从而使得我们可以一次 <code>terraform apply</code> 搞定。</p>
<ul>
<li><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"><strong>1.9.7.1.</strong> 利用 null_resource 搭配 replace_triggered_by 更新无法从服务端读取内容的属性</a></li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"></a></p>
<h2 id="1-9-7-1-利用-null-resource-搭配-replace-triggered-by-更新无法从服务端读取内容的属性"><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"></a>1.9.7.1. 利用 null_resource 搭配 replace_triggered_by 更新无法从服务端读取内容的属性</h2>
<p>曾经处理的一个提问，有人写了这样一段 Terraform 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_container_group&quot; &quot;this&quot; &#123;</span><br><span class="line">  name                = var.name</span><br><span class="line">  location            = var.location</span><br><span class="line">  resource_group_name = var.resource_group_name</span><br><span class="line">  ip_address_type     = &quot;Private&quot;</span><br><span class="line">  network_profile_id  = azurerm_network_profile.this.id</span><br><span class="line">  os_type             = &quot;Linux&quot;</span><br><span class="line"></span><br><span class="line">  container &#123;</span><br><span class="line">    name   = &quot;someName&quot;</span><br><span class="line">    image  = &quot;someImage&quot;</span><br><span class="line">    cpu    = &quot;0.5&quot;</span><br><span class="line">    memory = &quot;0.5&quot;</span><br><span class="line"></span><br><span class="line">    commands = [&quot;some&quot;, &quot;commands&quot;]</span><br><span class="line"></span><br><span class="line">    ports &#123;</span><br><span class="line">      port     = 53</span><br><span class="line">      protocol = &quot;UDP&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    volume &#123;</span><br><span class="line">      mount_path = &quot;/app/conf&quot;</span><br><span class="line">      name       = &quot;someName&quot;</span><br><span class="line">      read_only  = true</span><br><span class="line">      secret = &#123;</span><br><span class="line">        Corefile = base64encode(someContent)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tags = var.tags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果每次执行 <code>apply</code> 操作时，都会发现 Terraform 试图重建这个容器：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># module.dns_forwarder.azurerm_container_group.this must be replaced</span><br><span class="line">-/+ resource &quot;azurerm_container_group&quot; &quot;this&quot; &#123;</span><br><span class="line">      ~ exposed_port        = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - port     = 53</span><br><span class="line">              - protocol = &quot;UDP&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + fqdn                = (known after apply)</span><br><span class="line">      ~ id                  = &quot;/subscriptions/&lt;mySubId&gt;/resourceGroups/&lt;myRgName&gt;/providers/Microsoft.ContainerInstance/containerGroups/&lt;myContainerGroupName&gt;&quot; -&gt; (known after apply)</span><br><span class="line">      ~ ip_address          = &quot;someIp&quot; -&gt; (known after apply)</span><br><span class="line">        name                = &quot;someName&quot;</span><br><span class="line">      - tags                = &#123;&#125; -&gt; null</span><br><span class="line">        # (6 unchanged attributes hidden)</span><br><span class="line"></span><br><span class="line">      ~ container &#123;</span><br><span class="line">          - environment_variables        = &#123;&#125; -&gt; null</span><br><span class="line">            name                         = &quot;someName&quot;</span><br><span class="line">          - secure_environment_variables = (sensitive value)</span><br><span class="line">            # (4 unchanged attributes hidden)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          ~ volume &#123;</span><br><span class="line">                name       = &quot;someName&quot;</span><br><span class="line">              ~ secret     = (sensitive value) # forces replacement</span><br><span class="line">                # (3 unchanged attributes hidden)</span><br><span class="line">            &#125;</span><br><span class="line">            # (1 unchanged block hidden)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个问题的原因是 API 在读取容器信息时不会返回 <code>volume</code> 的 <code>secret</code> 数据，这其实是一个还挺合理的设定，机密数据的确不应该可以直接从 API 返回，但这就导致 Terraform 每次制定变更计划时都会试图重新设置这个值(因为会理解成服务端这个值被修改成了空)，而容器是不可变的，要修改容器的任何配置都会导致容器被重建。</p>
<p>有没有办法能够避免这种问题？经验告诉我们，可以使用 <code>ignore_changes</code> 让 Terraform 忽略这个属性的变更来避免重建，但如果 <code>secret</code> 真的变了怎么办？</p>
<p>我们可以这样干，第一，在 <code>azurerm_container_group</code> 添加这样一段 <code>lifecycle</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lifecycle &#123;</span><br><span class="line">    ignore_changes       = [container[0].volume[0].secret]</span><br><span class="line">    replace_triggered_by = [null_resource.secret_trigger.id]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这会忽略 <code>secret</code> 的变化，但我们同时声明了一个 <code>replace_triggered_by</code>，在 <code>null_resource.secret_trigger.id</code> 的值发生变化时可以删除重建 <code>azurerm_container_group</code> 实例。</p>
<p>其次，我们把 <code>secret</code> 的内容提取到一个 <code>local</code> 里，这时 <code>azurerm_container_group</code> 的 <code>volume</code> 看起来大概是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">volume &#123;</span><br><span class="line">    mount_path = &quot;/app/conf&quot;</span><br><span class="line">    name       = &quot;somename&quot;</span><br><span class="line">    read_only  = true</span><br><span class="line">    secret     = &#123;</span><br><span class="line">      Corefile = local.secret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>local.secret</code> 存放着使用的机密数据。这时我们再定义一个 <code>null_resource</code> 充当触发器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  secret = base64encode(&quot;abcdefg&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;secret_trigger&quot; &#123;</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    trigger = local.secret</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在机密数据真的发生变化的时候，<code>triggers</code> 会触发 <code>null_resource</code> 的重建，导致 <code>null_resource.secret_trigger.id</code> 发生变化，进而触发 <code>azurerm_container_group</code> 的重建。</p>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"><strong>1.9.8.1.</strong> 创建资源的条件依赖另一个资源的输出时怎么办</a></li>
</ul>
<p><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"></a></p>
<h2 id="1-9-8-1-创建资源的条件依赖另一个资源的输出时怎么办"><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"></a>1.9.8.1. 创建资源的条件依赖另一个资源的输出时怎么办</h2>
<p>我们在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/8.%E6%8A%80%E5%B7%A7/1.%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA">有条件创建</a>当中介绍了如何可以通过判断用户的输入参数来决定是否要创建某个资源，让我们来看一下这样一个 Module 的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;vpc_id&quot; &#123;</span><br><span class="line">  type    = string</span><br><span class="line">  default = null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  count       = var.vpc_id == null ? 1 : 0</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">  cidr_block = &quot;10.0.0.0/24&quot;</span><br><span class="line">  vpc_id     = var.vpc_id == null ? ucloud_vpc.vpc[0].id : var.vpc_id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们想在 Module 中创建一个 <code>ucloud_subnet</code>，用户可以输入一个 <code>vpc_id</code> 配置给它，也可以不输入，这时 Module 会创建一个 <code>ucloud_vpc</code> 来用。</p>
<p>假如我们使用这个模块，不传入 <code>vpc_id</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module vpc &#123;</span><br><span class="line">  source = &quot;./vpc&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码生成的 Plan 内容如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_subnet.subnet will be created</span><br><span class="line">  + resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">      + cidr_block  = &quot;10.0.0.0/24&quot;</span><br><span class="line">      + create_time = (known after apply)</span><br><span class="line">      + id          = (known after apply)</span><br><span class="line">      + name        = (known after apply)</span><br><span class="line">      + remark      = (known after apply)</span><br><span class="line">      + tag         = &quot;Default&quot;</span><br><span class="line">      + vpc_id      = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_vpc.vpc[0] will be created</span><br><span class="line">  + resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">      + cidr_blocks  = [</span><br><span class="line">          + &quot;10.0.0.0/16&quot;,</span><br><span class="line">        ]</span><br><span class="line">      + create_time  = (known after apply)</span><br><span class="line">      + id           = (known after apply)</span><br><span class="line">      + name         = &quot;vpc&quot;</span><br><span class="line">      + network_info = (known after apply)</span><br><span class="line">      + remark       = (known after apply)</span><br><span class="line">      + tag          = &quot;Default&quot;</span><br><span class="line">      + update_time  = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>
<p>完全符合预期。假如我们希望由模块的调用者来创建 Vpc 的话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module vpc &#123;</span><br><span class="line">  source = &quot;./vpc&quot;</span><br><span class="line"></span><br><span class="line">  vpc_id = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们执行 <code>terraform plan</code> 的话，会得到这样的结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Invalid count argument</span><br><span class="line">│ </span><br><span class="line">│   on vpc/main.tf line 16, in resource &quot;ucloud_vpc&quot; &quot;vpc&quot;:</span><br><span class="line">│   16:   count       = var.vpc_id == null ? 1 : 0</span><br><span class="line">│ </span><br><span class="line">│ The &quot;count&quot; value depends on resource attributes that cannot be determined until apply, so Terraform cannot predict how many instances will be created. To work around this,</span><br><span class="line">│ use the -target argument to first apply only the resources that the count depends on.</span><br><span class="line">╵</span><br></pre></td></tr></table></figure>
<p>Terraform 试图向我们抱怨，我们在 <code>count</code> 参数的表达式里使用了一个必须在 <code>apply</code> 阶段才能知道的值，所以它无法在 <code>plan</code> 阶段就计算出 <code>count</code> 的值。它建议我们先用 <code>terraform apply</code> 命令搭配 <code>-target</code> 参数把 Vpc 先创建出来，消除后续计算 Plan 时尚不知晓的值来解决这个问题。</p>
<p>这当然是一种很麻烦的方法，所以我们在设计 Module 时就要考虑到这种问题。有一种很简单的方法可以解决这个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;vpc&quot; &#123;</span><br><span class="line">  type    = object(</span><br><span class="line">    &#123;</span><br><span class="line">      id = string</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  default = null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  count       = var.vpc == null ? 1 : 0</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">  cidr_block = &quot;10.0.0.0/24&quot;</span><br><span class="line">  vpc_id     = var.vpc == null ? ucloud_vpc.vpc[0].id : var.vpc.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把用来判断创建条件的输入参数类型改成 <code>object</code>，调用 Module 的代码就变成了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  # ucloud_vpc.vpc will be created</span><br><span class="line">  + resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">      + cidr_blocks  = [</span><br><span class="line">          + &quot;10.0.0.0/16&quot;,</span><br><span class="line">        ]</span><br><span class="line">      + create_time  = (known after apply)</span><br><span class="line">      + id           = (known after apply)</span><br><span class="line">      + name         = &quot;vpc&quot;</span><br><span class="line">      + network_info = (known after apply)</span><br><span class="line">      + remark       = (known after apply)</span><br><span class="line">      + tag          = &quot;Default&quot;</span><br><span class="line">      + update_time  = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_subnet.subnet will be created</span><br><span class="line">  + resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">      + cidr_block  = &quot;10.0.0.0/24&quot;</span><br><span class="line">      + create_time = (known after apply)</span><br><span class="line">      + id          = (known after apply)</span><br><span class="line">      + name        = (known after apply)</span><br><span class="line">      + remark      = (known after apply)</span><br><span class="line">      + tag         = &quot;Default&quot;</span><br><span class="line">      + vpc_id      = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>
<p>成功计算出 Plan。请注意虽然这个 Plan 仍然是创建两个资源，但 <code>ucloud_vpc</code> 资源并不是 Module 创建的。</p>
<p>这个方法的原理就是虽然 <code>var.vpc.id</code> 仍然是一个只有在 <code>apply</code> 阶段才能知道的值，但 <code>var.vpc</code> 本身是一个在 <code>plan</code> 阶段就可以知道的值，直接可以判读它是否为 <code>null</code>，所以该方法可以绕过这个限制。</p>
<ul>
<li><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><strong>1.9.9.1.</strong> 利用 create_before_destroy 调整资源 Update 的执行顺序</a></li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"></a></p>
<h2 id="1-9-9-1-利用-create-before-destroy-调整资源-Update-的执行顺序"><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"></a>1.9.9.1. 利用 create_before_destroy 调整资源 Update 的执行顺序</h2>
<p>最近处理了一个问题，有人写了这样一段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;azurerm&quot; &#123;</span><br><span class="line">  features &#123;</span><br><span class="line">    resource_group &#123;</span><br><span class="line">      prevent_deletion_if_contains_resources = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_resource_group&quot; &quot;rg&quot; &#123;</span><br><span class="line">  location = &quot;eastus&quot;</span><br><span class="line">  name     = &quot;example&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">locals &#123;</span><br><span class="line">  environments = toset([&quot;one&quot;, &quot;two&quot;, &quot;three&quot;])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_public_ip&quot; &quot;lb&quot; &#123;</span><br><span class="line">  for_each = local.environments</span><br><span class="line"></span><br><span class="line">  name                = &quot;frontend-lb-$&#123;each.key&#125;&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  allocation_method   = &quot;Static&quot;</span><br><span class="line">  ip_version          = &quot;IPv4&quot;</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line">  zones               = [1, 2, 3]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_lb&quot; &quot;this&quot; &#123;</span><br><span class="line">  name                = &quot;azurelb&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line"></span><br><span class="line">  dynamic &quot;frontend_ip_configuration&quot; &#123;</span><br><span class="line">    for_each = local.environments</span><br><span class="line">    content &#123;</span><br><span class="line">      name                 = frontend_ip_configuration.key</span><br><span class="line">      public_ip_address_id = azurerm_public_ip.lb[frontend_ip_configuration.key].id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当他从 <code>local.environments</code> 中删除一个元素，然后执行 <code>terraform apply</code> 时，他遇到了下面的问题：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">│ Error: deleting Public Ip Address: (Name &quot;azurelb&quot; / Resource Group &quot;example&quot;): network.PublicIPAddressesClient#Delete: Failure sending request: StatusCode=400 -- Original Error: Code=&quot;PublicIPAddressCannotBeDeleted&quot; Message=&quot;Public IP address /subscriptions/subscription-id/resourceGroups/resource-group/providers/Microsoft.Network/publicIPAddresses/one can not be deleted since it is still allocated to resource /subscriptions/subscription-id/resourceGroups/resource-group/providers/Microsoft.Network/loadBalancers/azurelb/frontendIPConfigurations/one. In order to delete the public IP, disassociate/detach the Public IP address from the resource.  To learn how to do this, see aka.ms/deletepublicip.&quot; Details=[]</span><br></pre></td></tr></table></figure>
<p>这其实是一个还挺常见的问题，<code>azurerm_lb.this</code> 依赖于 <code>azurerm_public_ip.lb[index]</code>，正确的变更顺序应该是先更新 <code>azurerm_lb.this</code>，再删除 <code>azurerm_public_ip.lb</code> 的成员，但是 Terraform 默认的执行顺序会首先尝试执行删除操作，这时因为 ip 仍然被 LoadBalancer 使用着，所以会引发一个错误。</p>
<p>解决方法是给 <code>azurerm_public.lb</code> 添加一个 <code>create_before_destroy</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_public_ip&quot; &quot;lb&quot; &#123;</span><br><span class="line">  for_each = local.environments</span><br><span class="line"></span><br><span class="line">  name                = &quot;frontend-lb-$&#123;each.key&#125;&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  allocation_method   = &quot;Static&quot;</span><br><span class="line">  ip_version          = &quot;IPv4&quot;</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line">  zones               = [1, 2, 3]</span><br><span class="line"></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    create_before_destroy = true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>create_before_destroy</code> 名字里虽然看起来是与 Create 有关，实际上它也会将 Update 与 Create 放在一起调整，声明该参数后实际上是将 <code>azurerm_public_ip.lb</code> 的 Delete 推迟到执行 Update 之后再执行了，该问题得解。</p>
<ul>
<li>
<p><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"><strong>1.9.10.1.</strong> Terraform 与自动化</a></p>
</li>
<li>
<p><a href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84-terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E4%BD%9C%E6%B5%81"><strong>1.9.10.1.1.</strong> 自动化的 Terraform 命令行工作流</a></p>
</li>
<li>
<p><a href="#%E6%8E%A7%E5%88%B6%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%AD%E7%9A%84-terraform-%E8%BE%93%E5%87%BA"><strong>1.9.10.1.2.</strong> 控制自动化中的 Terraform 输出</a></p>
</li>
<li>
<p><a href="#%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%9C%BA%E5%99%A8%E4%B8%8A%E8%BF%90%E8%A1%8C-plan-%E5%92%8C-apply"><strong>1.9.10.1.3.</strong> 在不同的机器上运行 plan 和 apply</a></p>
</li>
<li>
<p><a href="#%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%AE%A1%E6%89%B9%E8%AE%A1%E5%88%92"><strong>1.9.10.1.4.</strong> 交互式审批计划</a></p>
</li>
<li>
<p><a href="#%E8%87%AA%E5%8A%A8%E6%89%B9%E5%87%86%E8%AE%A1%E5%88%92"><strong>1.9.10.1.5.</strong> 自动批准计划</a></p>
</li>
<li>
<p><a href="#%E7%94%A8-terraform-plan-%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95-pull-requests"><strong>1.9.10.1.6.</strong> 用 terraform plan 命令测试 Pull Requests</a></p>
</li>
<li>
<p><a href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><strong>1.9.10.1.7.</strong> 多环境部署</a></p>
</li>
<li>
<p><a href="#%E9%A2%84%E5%85%88%E5%AE%89%E8%A3%85%E7%9A%84%E6%8F%92%E4%BB%B6"><strong>1.9.10.1.8.</strong> 预先安装的插件</a></p>
</li>
</ul>
<p><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"></a></p>
<h2 id="1-9-10-1-Terraform-与自动化"><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"></a>1.9.10.1. Terraform 与自动化</h2>
<p>如果团队使用 Terraform 作为变更管理和部署管道的核心工具，可能需要以某种自动化方式编排 Terraform 的运行，以确保运行之间的一致性，并提供其他有趣的功能，例如与版本控制系统钩子的集成。</p>
<p>Terraform 的自动化可以有多种形式，并且程度不同。一些团队继续在本地运行 Terraform，但使用脚本代码来准备一致的工作目录来运行 Terraform，而另一些团队则完全在 Jenkins 等 CI 工具中运行 Terraform。</p>
<p>本篇涵盖了实现此类自动化时应考虑的一些事项，既确保 Terraform 的安全运行，又适应 Terraform 工作流程中当前需要仔细注意的一些限制。它假设 Terraform 将在非交互式环境中运行，无法在终端提示输入。对于脚本代码来说不一定如此，但在 CI 工具中运行时通常如此。</p>
<h2 id="1-9-10-1-1-自动化的-Terraform-命令行工作流"><a href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84-terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E4%BD%9C%E6%B5%81"></a>1.9.10.1.1. 自动化的 Terraform 命令行工作流</h2>
<p>在自动化流程中运行 Terraform 时，重点通常是核心的 <code>plan</code>/<code>apply</code> 循环。那么，使用 Terraform 命令行的流程大体如下：</p>
<ol>
<li>初始化 Terraform 工作目录。</li>
<li>针对当前代码，为产生变化的资源计算变更计划</li>
<li>让操作员审查计划，以确保其可接受</li>
<li>应用计划描述的更改。</li>
</ol>
<p>步骤 1、2 和 4 可以使用熟悉的 Terraform 命令以及一些附加选项来执行：</p>
<ul>
<li><code>terraform init -input=false</code> 初始化工作目录。</li>
<li><code>terraform plan -out=tfplan -input=false</code> 创建计划文件并将其保存到名为 <code>tfplan</code> 的本地文件。</li>
<li><code>terraform apply -input=false tfplan</code> 执行存储在文件 <code>tfplan</code> 中的计划。</li>
</ul>
<p><code>-input=false</code> 参数命令 Terraform 不应尝试提示输入，而是要求配置文件或命令行提供所有必要的值。因此，可能需要在 <code>terraform plan</code> 上使用 <code>-var</code> 和 <code>-var-file</code> 参数来指定所有传统上在交互式使用下手动输入的变量值。</p>
<p>强烈建议使用支持远程状态的 Backend，因为 Terraform 可以自动将持久保存状态，后续运行可以在找回并更新状态。选择支持状态锁定的 Backend 还将提供针对 Terraform 并发运行的竞争安全保障。</p>
<h2 id="1-9-10-1-2-控制自动化中的-Terraform-输出"><a href="#%E6%8E%A7%E5%88%B6%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%AD%E7%9A%84-terraform-%E8%BE%93%E5%87%BA"></a>1.9.10.1.2. 控制自动化中的 Terraform 输出</h2>
<p>默认情况下，一些 Terraform 命令会提示用户下一步可能执行的步骤，通常包括具体的下一步要运行的命令。</p>
<p>自动化工具通常会封装正在运行的命令的具体细节，只提供抽象的步骤，这时 Terraform 输出的此类消息反而令人困惑，且无法操作，如果它们无意中鼓励用户完全绕过自动化工具，则可能还是有害的。</p>
<p>当环境变量 <code>TF_IN_AUTOMATION</code> 设置为任何非空值时，Terraform 会对其输出进行一些细微调整，不再强调要运行的特定命令。所做的具体更改会随着时间的推移而变化，但一般来说，Terraform 发现该变量时，会认为存在某种包装了 Terraform 的应用程序，它们会帮助用户进行下一步。</p>
<p>为了降低复杂性，该功能主要针对 Terraform 主要的工作流程命令实现。无论该变量为何值如何，其他辅助命令仍可能会产生命令行建议。</p>
<h2 id="1-9-10-1-3-在不同的机器上运行-plan-和-apply"><a href="#%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%9C%BA%E5%99%A8%E4%B8%8A%E8%BF%90%E8%A1%8C-plan-%E5%92%8C-apply"></a>1.9.10.1.3. 在不同的机器上运行 plan 和 apply</h2>
<p>在 CI 工具中运行时，可能很难或无法确保 <code>plan</code> 和 <code>apply</code> 命令在同一台计算机上的同一目录中运行，并且所有的文件都保持相同。</p>
<p>在不同的机器上运行 <code>plan</code> 和 <code>apply</code> 需要一些额外的步骤来确保正确的行为。稳健的策略如下：</p>
<ul>
<li><code>plan</code> 完成后，保存整个工作目录，包括 <code>init</code> 期间创建的 <code>.terraform</code> 子目录，并将其保存在 <code>apply</code> 阶段可以访问得到的位置。常见的选择是作为所选 CI 工具中的“Build Artifact”。</li>
<li>在运行 <code>apply</code> 之前，获取上一步中创建的存档并将其解压到相同的绝对路径。这会重新创建 <code>plan</code> 后出现的所有内容，避免在 <code>plan</code> 步骤期间创建本地文件的奇怪问题。</li>
</ul>
<p>Terraform 目前为此类自动化系统设置了一些必须满足的前提条件：</p>
<ul>
<li>保存的计划文件可以包含子模块的绝对路径以及代码中引用的其他数据文件。因此，必须确保在相同的绝对路径中还原保存的工作目录。这通常是通过在某种隔离中运行 Terraform 来实现的，例如可以控制文件系统布局的 Docker 容器。</li>
<li>Terraform 假设该计划将在与其创建时相同的操作系统和 CPU 架构上 Apply。例如，这意味着无法在 Windows 计算机上创建计划，然后将其应用到 Linux 服务器上。</li>
<li>Terraform 期望用于生成计划的 Provider 程序插件在应用计划时可用且相同，以确保正确执行计划。如果在创建和应用计划之间升级 Terraform 或任何插件，将会产生错误。</li>
<li>Terraform 无法自动检测用于创建计划的凭据是否授予对用于应用该计划的相同资源的访问权限。如果对每个凭据使用不同的凭据（例如，使用只读凭据生成计划），那么确保两套凭据在它们所属的相应服务的帐户中保持一致非常重要。</li>
</ul>
<p><strong>警告</strong>：计划文件包含代码的完整副本、计划所要应用的状态数据以及传递给 <code>terraform plan</code> 的所有变量。如果其中包含任意敏感数据，则包含计划文件的存档工作目录应受到相应保护。对于 Provider 使用的身份验证凭据，建议尽可能使用环境变量，因为这些变量不会被包含在计划中或由 Terraform 以任何其他方式保存到磁盘。</p>
<h2 id="1-9-10-1-4-交互式审批计划"><a href="#%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%AE%A1%E6%89%B9%E8%AE%A1%E5%88%92"></a>1.9.10.1.4. 交互式审批计划</h2>
<p>自动化 Terraform 工作流程的另一个挑战是需要在计划和应用之间进行交互式审批步骤。为了稳健地实现这一点，重要的是要确保一次只能有一个计划未完成，或者两个步骤相互连接，以便批准计划将足够的信息传递到应用步骤，以确保应用正确的计划，与后来也存在的一些计划相反。</p>
<p>不同的 CI 工具以不同的方式解决这个问题，但通常这是通过构建管道功能实现的，其中可以按顺序应用不同的步骤，后面的步骤可以访问前面步骤生成的数据。</p>
<p>推荐的方法是一次只允许一个计划处于未应用状态。应用计划时，针对同一状态生成的任何其他现有计划都会失效，因为现在必须相对于新状态重新计算它们。通过强制计划按顺序获得批准（或驳回），可以避免这种情况。</p>
<h2 id="1-9-10-1-5-自动批准计划"><a href="#%E8%87%AA%E5%8A%A8%E6%89%B9%E5%87%86%E8%AE%A1%E5%88%92"></a>1.9.10.1.5. 自动批准计划</h2>
<p>虽然强烈建议对生产环境应用计划前要进行人工审查，但有时在预生产或开发环境中部署时需要采取更自动化的方法。</p>
<p>如果不需要手动批准，可以使用更简单的命令序列：</p>
<ul>
<li><code>terraform init -input=false</code></li>
<li><code>terraform apply -input=false -auto-approve</code></li>
</ul>
<p><code>apply</code> 命令的这个变体隐式地创建一个新计划，然后立即应用它。 <code>-auto-approve</code> 选项告诉 Terraform 在应用计划之前不需要对计划进行交互式批准。</p>
<p><strong>警告</strong>：当 Terraform 有权对基础设施进行破坏性更改时，始终建议对计划进行人工审查，除非在发生意外更改时可以容忍停机。仅对非关键基础设施使用自动批准。</p>
<h2 id="1-9-10-1-6-用-terraform-plan-命令测试-Pull-Requests"><a href="#%E7%94%A8-terraform-plan-%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95-pull-requests"></a>1.9.10.1.6. 用 terraform plan 命令测试 Pull Requests</h2>
<p><code>terraform plan</code> 可以用来对 Terraform 配置的有效性进行某些有限的验证，而不影响实际的基础设施。尽管 <code>plan</code> 命令会更新状态以匹配实际资源，从而确保准确的计划，但更新后的状态文件并不会持久保存，因此可以安全地使用该命令来生成仅为了帮助代码审查而创建的“一次性”计划。</p>
<p>实现此类工作流程时，可以在相关代码审查工具（例如，Github Pull Request）中使用钩子，为每个正在审查的新提交触发 CI 工具。在这种情况下，Terraform 可以按如下方式运行：</p>
<ul>
<li><code>terraform plan -input=false</code></li>
</ul>
<p>与在“主”工作流程中一样，可能需要根据需要设置 <code>-var</code> 或 <code>-var-file</code>。在这种情况下不使用 <code>-out</code> 选项，因为为代码审查目的而生成的计划永远不会被应用。相反，一旦合并更改，就可以从主版本控制分支创建并应用新计划。</p>
<p><strong>警告</strong>：请注意，通过输入变量或环境变量将敏感秘密数据传递给 Terraform 将使任何可以提交 PR 的人都可以看到，因此在开源项目或任何私人项目上必须谨慎使用此流程部分，或所有贡献者不应能够直接访问凭据等。</p>
<h2 id="1-9-10-1-7-多环境部署"><a href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"></a>1.9.10.1.7. 多环境部署</h2>
<p>Terraform 的自动化通常会被用来创建数个相同的配置，比如为预发布、测试或多租户基础设施等场景生成平行的环境。这种情况下的自动化可以帮助确保为每个环境使用正确的设置，并且在每次操作之前正确配置工作目录。</p>
<p>多环境编排最有趣的两个命令是 <code>terraform init</code> 和 <code>terraform workspace</code>。前者可以与其他参数一起使用，以针对环境之间的差异定制 Backend 配置，而后者可用于在单个 Backend 中存储的相同配置的多个状态之间安全切换。</p>
<p>如果可能，建议对所有环境使用单一后端配置，并使用 <code>terraform workspace</code> 命令在工作空间之间切换：</p>
<ul>
<li><code>terraform init -input=false</code></li>
<li><code>terraform workspace select QA</code></li>
</ul>
<p>在此使用模型中，Backend 存储中使用固定的命名方案，以允许多个状态共存，而无需任何进一步的配置。</p>
<p>或者，自动化工具可以将环境变量 <code>TF_WORKSPACE</code> 设置为现有工作空间名称，这将覆盖使用 <code>terraform workspace select</code> 命令所做的任何选择。建议仅在非交互式使用中使用此环境变量，因为在本地 shell 环境中，很容易忘记设置该变量并将变更应用到错误的状态。</p>
<p>在一些更复杂的情况下，不可能跨环境共享相同的 Backend 配置。例如，环境可能运行在完全独立的不同帐户的服务里，因此需要对 Backend 本身使用不同的凭据或端点。在这种情况下，可以通过 <code>terraform init</code> 的 <code>-backend-config</code> 选项覆盖后端配置设置。</p>
<h2 id="1-9-10-1-8-预先安装的插件"><a href="#%E9%A2%84%E5%85%88%E5%AE%89%E8%A3%85%E7%9A%84%E6%8F%92%E4%BB%B6"></a>1.9.10.1.8. 预先安装的插件</h2>
<p>在默认使用情况下，<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/12.init.html"><code>terraform init</code></a> 会自动下载并安装代码中使用的所有 Provider 程序的插件，并将它们放置在 <code>.terraform</code> 目录的子目录中。这为简单的情况提供了更简单的工作流程，并允许每段代码可以使用不同版本的插件。</p>
<p>在自动化环境中，可能需要禁用此行为，而是提供一组已安装在运行 Terraform 的系统上的固定插件。这样就避免了每次执行时重新下载插件的开销，并允许系统管理员控制可以使用哪些插件。</p>
<p>要使用此机制，请在系统上的某个位置创建一个 Terraform 运行时会将插件可执行文件放入其中的目录。已发布的插件文件可在 <a target="_blank" rel="noopener" href="https://releases.hashicorp.com/">releases.hashicorp.com</a> 上下载。请务必下载适合目标操作系统和体系结构的文件。</p>
<p>提取必要的插件后，新插件目录的内容将如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -lah /usr/lib/custom-terraform-plugins</span></span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:13 terraform-provider-aws-v1.0.0-x3</span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:15 terraform-provider-rundeck-v2.3.0-x3</span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:15 terraform-provider-mysql-v1.2.0-x3</span><br></pre></td></tr></table></figure>
<p>文件名末尾的版本信息很重要，它使得 Terraform 可以推断每个插件的版本号。可以安装同一 Provider 程序插件的多个版本，Terraform 将使用与 Terraform 代码中的 Provider 程序版本约束相匹配的最新版本。</p>
<p>填充此目录后，可以使用 <code>terraform init</code> 的 <code>-plugin-dir</code> 选项跳过常规的自动下载和插件发现行为：</p>
<ul>
<li><code>terraform init -input=false -plugin-dir=/usr/lib/custom-terraform-plugins</code></li>
</ul>
<p>使用该组参数时，只有给定目录中的插件可以被使用。这使系统管理员可以对执行环境进行强力控制，但另一方面，它会阻止使用尚未安装到本地插件目录中的较新插件版本。哪种方法更合适将取决于每个组织内的特定情况。</p>
<p>还可以通过创建 <code>terraform.d/plugins/OS_ARCH</code> 目录与配置一起提前安装插件，在自动下载其他插件之前将搜索该目录。 <code>-get-plugins=false</code> 参数可禁止 Terraform 自动下载其他插件。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                            aria-label=": Terraform-测试"
                        >
                            Terraform-测试
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-01-29T17:43:45+08:00">
	
		    2023 年 1 月 29 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="Terraform/">Terraform</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <ul>
<li>
<p><a href="#%E6%B5%8B%E8%AF%95"><strong>1.8.1.</strong> 测试</a></p>
</li>
<li>
<p><a href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%88%96%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><strong>1.8.1.1.</strong> 集成测试或单元测试</a></p>
</li>
<li>
<p><a href="#%E8%AF%AD%E6%B3%95"><strong>1.8.1.2.</strong> 语法</a></p>
</li>
<li>
<p><a href="#%E7%A4%BA%E4%BE%8B"><strong>1.8.1.2.1.</strong> 示例</a></p>
</li>
<li>
<p><a href="#run-%E5%9D%97"><strong>1.8.1.3.</strong> run 块</a></p>
</li>
<li>
<p><a href="#%E6%96%AD%E8%A8%80"><strong>1.8.1.3.1.</strong> 断言</a></p>
</li>
<li>
<p><a href="#variable-%E5%9D%97"><strong>1.8.1.4.</strong> variable 块</a></p>
</li>
<li>
<p><a href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%88%96%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9A%E5%8F%98%E9%87%8F"><strong>1.8.1.4.1.</strong> 通过命令行或定义文件指定变量</a></p>
</li>
<li>
<p><a href="#%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E4%BC%98%E5%85%88%E7%BA%A7"><strong>1.8.1.4.2.</strong> 变量定义优先级</a></p>
</li>
<li>
<p><a href="#%E5%8F%98%E9%87%8F%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"><strong>1.8.1.4.3.</strong> 变量中的引用</a></p>
</li>
<li>
<p><a href="#provider-%E5%9D%97"><strong>1.8.1.5.</strong> provider 块</a></p>
</li>
<li>
<p><a href="#module-%E5%9D%97"><strong>1.8.1.6.</strong> module 块</a></p>
</li>
<li>
<p><a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81"><strong>1.8.1.6.1.</strong> 模块状态</a></p>
</li>
<li>
<p><a href="#%E9%A2%84%E6%9C%9F%E5%A4%B1%E8%B4%A5"><strong>1.8.1.7.</strong> 预期失败</a></p>
</li>
</ul>
<p><a href="#%E6%B5%8B%E8%AF%95"></a></p>
<h2 id="1-8-1-测试"><a href="#%E6%B5%8B%E8%AF%95"></a>1.8.1. 测试</h2>
<p>-&gt; <strong>注意：</strong> 该测试框架在 Terraform v1.6.0 及以后版本中可用。</p>
<p>Terraform 测试功能允许模块作者验证配置变更不会引入破坏性更改。测试针对特定的、临时的资源进行，防止对现有的基础设施或状态产生任何风险。</p>
<h2 id="1-8-1-1-集成测试或单元测试"><a href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%88%96%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"></a>1.8.1.1. 集成测试或单元测试</h2>
<p>默认情况下，Terraform 测试会创建真实的基础设施，并可以对这些基础设施进行断言和验证。这相当于集成测试，它通过调用 Terraform 创建基础设施并对其进行验证来测试 Terraform 的核心功能。</p>
<p>你可以通过更新 <a href="#run-%E5%9D%97"><code>run</code></a> 块中的 <code>command</code> 属性（下面有示例）来覆盖默认的测试行为。默认情况下，每个 <code>run</code> 块都会执行 <code>command = apply</code>，命令 Terraform 对你的配置执行完整的 <code>apply</code> 操作。将 <code>command</code> 值替换为 <code>command = plan</code> 会告诉 Terraform 不为这个 <code>run</code> 块创建新的基础设施。这将允许测试作者验证他们的基础设施中的逻辑操作和自定义条件，相当于编写了单元测试。</p>
<p>Terraform v1.7.0 引入了在 <code>terraform test</code> 执行期间模拟 Provider 返回数据的能力。这可以用于编写更详细和完整的单元测试。</p>
<h2 id="1-8-1-2-语法"><a href="#%E8%AF%AD%E6%B3%95"></a>1.8.1.2. 语法</h2>
<p>每个 Terraform 测试都保存在一个测试文件中。Terraform 根据文件扩展名发现测试文件：<code>.tftest.hcl</code> 或 <code>.tftest.json</code>。</p>
<p>每个测试文件包含以下根级别的属性和块：</p>
<ul>
<li>一个到多个 <a href="#run-%E5%9D%97"><code>run</code></a> 块。</li>
<li>零个到一个 <a href="#variable-%E5%9D%97"><code>variables</code></a> 块。</li>
<li>零个到多个 <a href="#provider-%E5%9D%97"><code>provider</code></a> 块。</li>
</ul>
<p>Terraform 按顺序执行 <code>run</code> 块，模拟一系列直接在配置目录中执行的 Terraform 命令。 <code>variables</code> 和 <code>provider</code> 块的顺序并不重要，Terraform 在测试操作开始时处理这些块中的所有值。我们建议首先在测试文件的开头定义你的 <code>variables</code> 和 <code>provider</code> 块。</p>
<h3 id="1-8-1-2-1-示例"><a href="#%E7%A4%BA%E4%BE%8B"></a>1.8.1.2.1. 示例</h3>
<p>以下示例演示了一个简单的 Terraform 配置，该配置创建了一个 AWS S3 存储桶，并使用输入变量来修改其名称。我们将创建一个示例测试文件（如下）来验证存储桶的名称是否如预期那样被创建。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-bucket&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;bucket_name&quot; &#123;</span><br><span class="line">  value = aws_s3_bucket.bucket.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下测试文件运行了一个单独的Terraform <code>plan</code> 命令，该命令创建了S3存储桶，然后通过检查实际名称是否与预期名称匹配，来验证计算名称的逻辑是否正确。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># valid_string_concat.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;valid_string_concat&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-8-1-3-run-块"><a href="#run-%E5%9D%97"></a>1.8.1.3. run 块</h2>
<p>每个 <code>run</code> 块都有以下字段和块：</p>
<table>
<thead>
<tr>
<th>字段或块名称</th>
<th>描述</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>一个可选属性，可以是 <code>apply</code> 或 <code>plan</code>。</td>
<td><code>apply</code></td>
</tr>
<tr>
<td><code>plan_options.mode</code></td>
<td>一个可选属性，可以是 <code>normal</code> 或 <code>refresh-only</code>。</td>
<td><code>normal</code></td>
</tr>
<tr>
<td><code>plan_options.refresh</code></td>
<td>一个可选的 <code>bool</code> 属性。</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>plan_options.replace</code></td>
<td>一个可选属性，包含一个资源地址列表，引用测试配置中的资源。</td>
<td></td>
</tr>
<tr>
<td><code>plan_options.target</code></td>
<td>一个可选属性，包含一个资源地址列表，引用测试配置中的资源。</td>
<td></td>
</tr>
<tr>
<td><a href="#variable-%E5%9D%97"><code>variables</code></a></td>
<td>一个可选的 <code>variables</code> 块。</td>
<td></td>
</tr>
<tr>
<td><a href="#module-%E5%9D%97"><code>module</code></a></td>
<td>一个可选的 <code>module</code> 块。</td>
<td></td>
</tr>
<tr>
<td><a href="#provider-%E5%9D%97"><code>providers</code></a></td>
<td>一个可选的 <code>providers</code> 属性。</td>
<td></td>
</tr>
<tr>
<td><a href="#%E6%96%AD%E8%A8%80"><code>assert</code></a></td>
<td>可选的 <code>assert</code> 块。</td>
<td></td>
</tr>
<tr>
<td><code>expect_failures</code></td>
<td>一个可选属性。</td>
<td></td>
</tr>
</tbody>
</table>
<p><code>command</code> 属性和 <code>plan_options</code> 块告诉 Terraform 对于每个 <code>run</code> 块执行哪个命令和选项。如果您没有指定 <code>command</code> 属性或 <code>plan_options</code> 块，那么默认操作是普通的 <code>terraform apply</code> 操作。</p>
<p><code>command</code> 属性指明操作应该是一个 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan"><code>plan</code></a> 操作还是一个 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/4.apply"><code>apply</code></a> 操作。</p>
<p><code>plan_options</code> 块允许测试的作者定义他们通常需要通过命令行标志和选项定义的 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/commands/plan#planning-modes">plan mode</a> 和 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/commands/plan#planning-options">选项</a>。我们将在 <a href="#variable-%E5%9D%97">变量</a> 部分介绍 <code>-var</code> 和 <code>-var-file</code> 选项。</p>
<h3 id="1-8-1-3-1-断言"><a href="#%E6%96%AD%E8%A8%80"></a>1.8.1.3.1. 断言</h3>
<p>Terraform 测试的 <code>run</code> 块断言是<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">自定义条件</a>，由<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">条件</a>和<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions#error-messages">错误消息</a>组成。</p>
<p>在 Terraform 测试命令执行结束时，Terraform 会将所有失败的断言作为测试通过或失败状态的一部分展示出来。</p>
<h4 id="断言中的引用"><a href="#%E6%96%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"></a>断言中的引用</h4>
<p>测试中的断言可以引用主 Terraform 配置中的其他自定义条件可用的任何现有<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/8.%E8%A1%A8%E8%BE%BE%E5%BC%8F#%E5%BC%95%E7%94%A8%E5%91%BD%E5%90%8D%E5%80%BC">命名值</a>。</p>
<p>此外，测试断言可以直接引用当前和先前 <code>run</code> 块的输出。比如引用了<a href="#%E7%A4%BA%E4%BE%8B">上一个示例</a>中的输出的一个合法的表达式条件：<code>condition = output.bucket_name == &quot;test_bucket&quot;</code>。</p>
<h2 id="1-8-1-4-variable-块"><a href="#variable-%E5%9D%97"></a>1.8.1.4. variable 块</h2>
<p>你可以直接在你的测试文件中为 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F">输入变量</a> 设置值。</p>
<p>你可以在测试文件的根级别或者 <code>run</code> 块内部定义 <code>variables</code> 块。Terraform 将测试文件中的所有变量值传递到文件中的所有 <code>run</code> 块。你可以通过在某个 <code>run</code> 块中直接设置变量值来覆盖从根部继承的值。</p>
<p>在上述 <a href="#%E7%A4%BA%E4%BE%8B">示例</a> 的测试文件中添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># variable_precedence.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;uses_root_level_value&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;overrides_root_level_value&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    bucket_prefix = &quot;other&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;other-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们添加了第二个 <code>run</code> 块，该块指定 <code>bucket_prefix</code> 变量值为 <code>other</code>，覆盖了测试文件提供的，并在第一个 <code>run</code> 块中使用的值 —— <code>test</code>。</p>
<h3 id="1-8-1-4-1-通过命令行或定义文件指定变量"><a href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%88%96%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9A%E5%8F%98%E9%87%8F"></a>1.8.1.4.1. 通过命令行或定义文件指定变量</h3>
<p>除了通过测试文件指定变量值外，Terraform <code>test</code> 命令还支持指定变量值的其他方法。</p>
<p>您可以通过 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0">命令行</a> 和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%8F%82%E6%95%B0%E6%96%87%E4%BB%B6">变量定义文件</a> 为所有测试指定变量值。</p>
<p>像普通的 Terraform 命令一样，Terraform 会自动加载测试目录中定义的任何变量文件。自动变量文件包括 <code>terraform.tfvars</code>、<code>terraform.tfvars.json</code>，以及所有以 <code>.auto.tfvars</code> 或 <code>.auto.tfvars.json</code> 结尾的文件。</p>
<p><strong>注意：</strong> 从测试目录中的自动变量文件加载的变量值只适用于在同一测试目录中定义的测试。以所有其他方式定义的变量将适用于给定测试运行中的所有测试。</p>
<p>这在使用敏感变量值和设置 Provider 配置时特别有用。否则，测试文件可能会直接暴露这些敏感值。</p>
<h3 id="1-8-1-4-2-变量定义优先级"><a href="#%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E4%BC%98%E5%85%88%E7%BA%A7"></a>1.8.1.4.2. 变量定义优先级</h3>
<p>除了测试文件中设置的变量值，<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F%E8%B5%8B%E5%80%BC%E4%BC%98%E5%85%88%E7%BA%A7">变量定义优先级</a> 在测试中保持不变。在测试文件中定义的变量具有最高优先级，可以覆盖环境变量、变量文件或命令行输入。</p>
<p>对于在测试目录中定义的测试，任何在测试目录的自动变量文件中定义的变量值都将覆盖主配置目录的自动变量文件中定义的值。</p>
<h3 id="1-8-1-4-3-变量中的引用"><a href="#%E5%8F%98%E9%87%8F%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"></a>1.8.1.4.3. 变量中的引用</h3>
<p>在 <code>run</code> 块中定义的 <code>variable</code> 中可以引用在先前 <code>run</code> 块中执行的模块的输出和在更高优先级定义的变量。</p>
<p>例如，以下代码块显示了变量如何引用更高优先级的变量和先前的 <code>run</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">variables &#123;</span><br><span class="line">  global_value = &quot;some value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;run_block_one&quot; &#123;</span><br><span class="line">  variables &#123;</span><br><span class="line">    local_value = var.global_value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">  # 这里应该有一些测试断言</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;run_block_two&quot; &#123;</span><br><span class="line">  variables &#123;</span><br><span class="line">    local_value = run.run_block_one.output_one</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">  # 这里应该有一些测试断言</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面，<code>run_block_one</code> 中的 <code>local_value</code> 从 <code>global_value</code> 变量获取值。如果你想给多个变量分配相同的值，这种模式很有用。你可以在文件级别一次指定一个变量的值，然后与不同的变量共享它。</p>
<p>相比之下，<code>run_block_two</code> 中的 <code>local_value</code> 引用了 <code>run_block_one</code> 的 <code>output_one</code> 的输出值。这种模式对于在 <code>run</code> 块之间传递值特别有用，特别是如果 <code>run</code> 块正在执行<a href="#module-%E5%9D%97">模块</a>部分中详细描述的不同模块。</p>
<h2 id="1-8-1-5-provider-块"><a href="#provider-%E5%9D%97"></a>1.8.1.5. provider 块</h2>
<p>您可以通过使用 <code>provider</code> 和 <code>providers</code> 块和属性，在测试文件中设置或覆盖 Terraform 代码所需的 Provider。</p>
<p>您可以在 Terraform 测试文件的根级别，定义 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/providers/configuration"><code>provider</code> 块</a>，就像在 Terraform <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/providers">配置代码中</a>创建它们一样。然后，Terraform 会将这些 <code>provider</code> 块传递到其配置中，每个 <code>run</code> 块执行时都是如此。</p>
<p>默认情况下，您指定的每个 Provider 都直接在每个 <code>run</code> 块中可用。您可以通过使用 <code>providers</code> 属性在特定 <code>run</code> 块中设置 Provider 的可用性。这个块的行为和语法与 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/meta-arguments/module-providers">providers meta-argument</a> 的行为相匹配。</p>
<p>如果您在测试文件中不提供 Provider 配置，Terraform 会尝试使用 Provider 的默认设置初始化其配置中的所有 Provider。例如，任何旨在配置 Provider 的环境变量仍然可用，并且 Terraform 可以使用它们来创建默认 Provider。</p>
<p>下面，我们将扩展我们之前的 <a href="#%E7%A4%BA%E4%BE%8B">示例</a>，用测试代码而不是 Terraform 配置代码来指定 <code>region</code>。在这个示例中，我们将测试以下配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source = &quot;hashicorp/aws&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-bucket&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;bucket_name&quot; &#123;</span><br><span class="line">  value = aws_s3_bucket.bucket.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们现在可以在以下测试文件中定义如下的 <code>provider</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># customised_provider.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;valid_string_concat&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们也可以创建一个更复杂的示例配置，使用多个 Provider 以及别名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source                = &quot;hashicorp/aws&quot;</span><br><span class="line">      configuration_aliases = [aws.secondary]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  default = &quot;test&quot;</span><br><span class="line">  type    = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;primary_bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-primary&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;secondary_bucket&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">  bucket   = &quot;$&#123;var.bucket_prefix&#125;-secondary&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们的测试文件中，我们可以设定多个 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># customised_providers.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;secondary&quot;</span><br><span class="line">  region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们也可以在特定 <code>run</code> 块中声明特定的 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source                = &quot;hashicorp/aws&quot;</span><br><span class="line">      configuration_aliases = [aws.secondary]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_region&quot; &quot;primary&quot; &#123;&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_region&quot; &quot;secondary&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  default = &quot;test&quot;</span><br><span class="line">  type    = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;primary_bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-$&#123;data.aws_region.primary.name&#125;-primary&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;secondary_bucket&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">  bucket   = &quot;$&#123;var.bucket_prefix&#125;-$&#123;data.aws_region.secondary.name&#125;-secondary&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的测试文件可以为不同的 <code>run</code> 块配置的 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># customised_providers.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;secondary&quot;</span><br><span class="line">  region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;tertiary&quot;</span><br><span class="line">  region = &quot;eu-west-2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;default_providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-us-east-1-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-eu-central-1-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;customised_providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws           = aws</span><br><span class="line">    aws.secondary = aws.tertiary</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-us-east-1-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-eu-west-2-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> 在使用 <code>command = apply</code> 运行测试时，<code>run</code> 块之间切换 Provider 可能会导致运行和测试失败，因为由一个 Provider 定义创建的资源在被另一个修改时将无法使用。</p>
<p>从 Terraform v1.7.0 开始，<code>provider</code> 块也可以引用测试文件变量和 <code>run</code> 块输出。这意味着测试框架可以从一个 Provider 获取凭证和其他设置信息，并在初始化第二个 Provider 时使用这些信息。</p>
<p>在下面的示例中，首先初始化 <code>vault</code> Provider，然后在一个设置模块中使用它来提取 <code>aws</code> Provider 的凭证。有关 setup 模块的更多信息，请参阅 <a href="#module-%E5%9D%97">模块</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">provider &quot;vault&quot; &#123;</span><br><span class="line">  # ... vault configuration ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region     = &quot;us-east-1&quot;</span><br><span class="line"></span><br><span class="line">  # The `aws` provider can reference the outputs of the &quot;vault_setup&quot; run block.</span><br><span class="line">  access_key = run.vault_setup.aws_access_key</span><br><span class="line">  secret_key = run.vault_setup.aws_secret_key</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;vault_setup&quot; &#123;</span><br><span class="line">  module &#123;</span><br><span class="line">    # This module should only include reference to the Vault provider. Terraform</span><br><span class="line">    # will automatically work out which providers to supply based on the module</span><br><span class="line">    # configuration. The tests will error if a run block requires access to a</span><br><span class="line">    # provider that references outputs from a run block that has not executed.</span><br><span class="line">    source = &quot;./testing/vault-setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;use_aws_provider&quot; &#123;</span><br><span class="line">  # This run block can then use both the `aws` and `vault` providers, as the</span><br><span class="line">  # previous run block provided all the data required for the `aws` provider.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-8-1-6-module-块"><a href="#module-%E5%9D%97"></a>1.8.1.6. module 块</h2>
<p>您可以修改特定的 <code>run</code> 块执行的模块。</p>
<p>默认情况下，Terraform 针对正在测试的配置代码，依次执行所有 <code>run</code> 块中设定的命令。Terraform 在您执行 <code>terraform test</code> 命令的目录（或者您用 <code>-chdir</code> 参数指向的目录）内测试配置。每个 <code>run</code> 块也允许用户使用 <code>module</code> 块更改目标配置。</p>
<p>与传统的 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97"><code>module</code> 块</a>不同，测试文件中的 <code>module</code> 块 <em>仅</em> 支持 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%A8%A1%E5%9D%97%E6%BA%90"><code>source</code></a> 属性和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%A8%A1%E5%9D%97%E7%89%88%E6%9C%AC%E7%BA%A6%E6%9D%9F"><code>version</code></a> 属性。通常通过传统的 <code>module</code> 块提供的其余属性应由 <code>run</code> 块内的替代属性和块提供。</p>
<p><strong>注意：</strong> Terraform 测试文件只支持 <code>source</code> 属性中的 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%9C%AC%E5%9C%B0%E8%B7%AF%E5%BE%84">本地</a> 和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#terraform-registry">注册表</a> 模块。</p>
<p>在执行其他模块时，<code>run</code> 块内的所有其他块和属性都受支持，<code>assert</code> 块执行时使用来自其他模块的值。这在 <a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81">模块状态</a> 中有更详细的说明。</p>
<p>测试文件中 <code>modules</code> 块的两个示例用例是：</p>
<ol>
<li>一个设置模块，为待测 Terraform 配置代码创建测试所需的基础设施。</li>
<li>一个加载模块，用于加载和验证 Terraform 配置代码未直接创建的次要基础设施（如数据源）。</li>
</ol>
<p>以下示例演示了这两种用例。</p>
<p>首先，我们有一个模块，它将创建并将多个文件加载到已创建的 S3 存储桶中。这是我们要测试的配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;files&quot; &#123;</span><br><span class="line">  type = map(string)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_object&quot; &quot;object&quot; &#123;</span><br><span class="line">  for_each = var.files</span><br><span class="line"></span><br><span class="line">  bucket = data.aws_s3_bucket.bucket.id</span><br><span class="line">  key = each.key</span><br><span class="line">  source = each.value</span><br><span class="line"></span><br><span class="line">  etag = filemd5(each.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们使用配置模块创建这个 S3 存储桶，这样在测试时就可以使用它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># testing/setup/main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三步，我们使用一个加载模块，读取 S3 存储桶中的文件。这是一个比较牵强的例子，因为我们完全可以直接在创建这些文件的模块中创建这些数据源，但它在这里可以很好地演示如何编写测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># testing/loader/main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_s3_objects&quot; &quot;objects&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们使用测试文件把刚才创建的多个助手模块以及待测模块编织在一起形成一个有效的测试配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># file_count.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket = &quot;my_test_bucket&quot;</span><br><span class="line">  files = &#123;</span><br><span class="line">    &quot;file-one.txt&quot;: &quot;data/files/file_one.txt&quot;</span><br><span class="line">    &quot;file-two.txt&quot;: &quot;data/files/file_two.txt&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;setup&quot; &#123;</span><br><span class="line">  # Create the S3 bucket we will use later.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;execute&quot; &#123;</span><br><span class="line">  # This is empty, we just run the configuration under test using all the default settings.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;verify&quot; &#123;</span><br><span class="line">  # Load and count the objects created in the &quot;execute&quot; run block.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/loader&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition = length(data.aws_s3_objects.objects.keys) == 2</span><br><span class="line">    error_message = &quot;created the wrong number of s3 objects&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-8-1-6-1-模块状态"><a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81"></a>1.8.1.6.1. 模块状态</h3>
<p>当 Terraform 执行 <code>terraform test</code> 命令时，Terraform 会为每个测试文件在内存中维护一个或多个状态文件。</p>
<p>总是至少有一个状态文件维护在测试下的 Terraform 配置代码的状态。这个状态文件由所有没有 <code>module</code> 块指定要加载的替代模块的 <code>run</code> 块共享。</p>
<p>此外，Terraform 加载的每个替代模块都有一个状态文件。一个替代模块的状态文件被执行给定模块的所有 <code>run</code> 块共享。</p>
<p>Terraform 团队对任何需要手动状态管理或在 <code>test</code> 命令中对同一状态执行不同配置的用例感兴趣。如果你有一个用例，请提交一个 <a target="_blank" rel="noopener" href="https://github.com/hashicorp/terraform/issues/new/choose">issue</a>并与我们分享。</p>
<p>以下示例使用注释来解释每个 <code>run</code> 块的状态文件的来源。在下面的示例中，Terraform 创建并管理了总共三个状态文件。第一个状态文件是针对测试下的主模块，第二个是针对设置模块，第三个是针对加载模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">run &quot;setup&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block references an alternate module and is the first run block</span><br><span class="line">  # to reference this particular alternate module. Therefore, Terraform creates</span><br><span class="line">  # and populates a new empty state file for this run block.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;init&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block does not reference an alternate module, so it uses the main</span><br><span class="line">  # state file for the configuration under test. As this is the first run block</span><br><span class="line">  # to reference the main configuration, the previously empty state file now</span><br><span class="line">  # contains the resources created by this run block.</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    # In practice we&#x27;d do some interesting checks and tests here but the</span><br><span class="line">    # assertions aren&#x27;t important for this example.</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ... more assertions ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;update_setup&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # We&#x27;ve now re-referenced the setup module, so the state file that was created</span><br><span class="line">  # for the first &quot;setup&quot; run block will be reused. It will contain any</span><br><span class="line">  # resources that were created as part of the other run block before this run</span><br><span class="line">  # block executes and will be updated with any changes made by this run block</span><br><span class="line">  # after.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    # In practice, we&#x27;d likely make some changes to the module compared to the</span><br><span class="line">    # first run block here. Otherwise, there would be no point recalling the</span><br><span class="line">    # module.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;update&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # As with the &quot;init&quot; run block, we are executing against the main configuration</span><br><span class="line">  # again. This means we&#x27;d load the main state file that was initially populated</span><br><span class="line">  # by the &quot;init&quot; run block, and any changes made by this &quot;run&quot; block will be</span><br><span class="line">  # carried forward to any future run blocks that execute against the main</span><br><span class="line">  # configuration.</span><br><span class="line"></span><br><span class="line">  # ... updated variables ...</span><br><span class="line"></span><br><span class="line">  # ... assertions ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;loader&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block is now referencing our second alternate module so will create</span><br><span class="line">  # our third and final state file. The other two state files are managing</span><br><span class="line">  # resources from the main configuration and resources from the setup module.</span><br><span class="line">  # We are getting a new state file for this run block as the loader module has</span><br><span class="line">  # not previously been referenced by any run blocks.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/loader&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="模块的清理"><a href="#%E6%A8%A1%E5%9D%97%E7%9A%84%E6%B8%85%E7%90%86"></a>模块的清理</h4>
<p>在测试文件执行结束时，Terraform 会试图销毁在该测试文件执行过程中创建的每个资源。当 Terraform 加载替代模块时，Terraform 销毁这些对象的顺序很重要。例如，在第一个 <a href="#module-%E5%9D%97">模块</a> 示例中，Terraform 不能在 “execute” <code>run</code> 块中创建的对象之前销毁在 “setup” <code>run</code> 块中创建的资源，因为我们在 “setup” 步骤中创建的 S3 桶在包含对象的情况下无法被销毁。</p>
<p>Terraform 按照 <code>run</code> 块的反向顺序销毁资源。在最近的 <a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81">例子</a> 中，有三个状态文件。一个用于主状态，一个用于 <code>./testing/loader</code> 模块，还有一个用于 <code>./testing/setup</code> 模块。由于 <code>./testing/loader</code> 状态文件最近被最后一个运行块引用，因此首先被销毁。主状态文件将被第二个销毁，因为它被 “update” <code>run</code> 块引用。然后 <code>./testing/setup</code> 状态文件将被最后销毁。</p>
<p>请注意，前两个 <code>run</code> 块 “setup” 和 “init” 在销毁操作中不做任何事情，因为它们的状态文件被后续的 run 块使用，并且已经被销毁。</p>
<p>如果你使用单个设置模块作为替代模块，并且它首先执行，或者你不使用任何替代模块，那么销毁顺序不会影响你。更复杂的情况可能需要仔细考虑，以确保资源的销毁可以自动完成。</p>
<h2 id="1-8-1-7-预期失败"><a href="#%E9%A2%84%E6%9C%9F%E5%A4%B1%E8%B4%A5"></a>1.8.1.7. 预期失败</h2>
<p>默认情况下，如果在执行 Terraform 测试文件期间，任何<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">自定义条件</a>，包括 <code>check</code> 块断言失败，则整体命令会将测试报告为失败。</p>
<p>然而，我们经常想要测试代码运行失败时的行为。Terraform 为此用例提供了 <code>expect_failures</code> 属性。</p>
<p>在每个 <code>run</code> 块中，<code>expect_failures</code> 属性可以设置应该导致自定义条件检查失败的可检查对象（资源，数据源，检查块，输入变量和输出）的列表。如果您指定的可检查对象报告问题，测则试通过，如果没有报告错误，那么测试总体上失败。</p>
<p>您仍然可以在 <code>expect_failures</code> 块附近编写断言，但您应该注意，除了 <code>check</code> 块断言外，所有自定义条件都会停止 Terraform 的执行。这在测试执行期间仍然适用，所以这些断言应该只考虑你确定会在可检查对象应该失败之前可知的值。您可以使用引用或在主配置中的 <code>depends_on</code> 元参数来管理这一点。</p>
<p>这也意味着，除了 <code>check</code> 块，你只能可靠地包含一个可检查的对象。我们支持在 <code>expect_failures</code> 属性中列出可检查对象的列表，仅用于 <code>check</code> 块。</p>
<p>下面的一个快速示例演示了测试输入变量的 <code>validation</code> 块。配置文件接受一个必须是偶数的单一输入变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;input&quot; &#123;</span><br><span class="line">  type = number</span><br><span class="line"></span><br><span class="line">  validation &#123;</span><br><span class="line">    condition = var.input % 2 == 0</span><br><span class="line">    error_message = &quot;must be even number&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试文件包含了两个 <code>run</code> 块。一个验证了我们的自定义条件在偶数条件下是通过的，另一个验证输入奇数时会失败。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># input_validation.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  input = 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;zero&quot; &#123;</span><br><span class="line">  # The variable defined above is even, so we expect the validation to pass.</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;one&quot; &#123;</span><br><span class="line">  # This time we set the variable is odd, so we expect the validation to fail.</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    input = 1</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  expect_failures = [</span><br><span class="line">    var.input,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：Terraform 只期望在 <code>run</code> 块的 <code>command</code> 属性指定的操作中出现失败。</p>
<p>在使用 <code>command = apply</code> 的 <code>run</code> 块中使用 <code>expect_failures</code> 时要小心。一个 <code>run</code> 块中的 <code>command = apply</code> 如果期望自定义条件失败，那么如果该自定义条件在 <code>plan</code> 期间失败，整体将会失败。</p>
<p>这在逻辑上是正确的，因为 <code>run</code> 块期望能够运行应用操作，但由于 <code>plan</code> 失败而不能运行，但这也可能会引起混淆，因为即使那个失败被标记为预期的，你还是会在诊断中看到失败。</p>
<p>有时，Terraform 在计划阶段不执行自定义条件，因为该条件依赖于只有在 Terraform 创建引用资源后才可用的计算属性。在这些情况下，你可以在设置 <code>command = apply</code> 时使用 <code>expect_failures</code> 块。然而，大多数情况下，我们建议只在 <code>command = plan</code> 时使用 <code>expect_failures</code>。</p>
<p><strong>注意</strong>：预期的失败只适用于用户定义的自定义条件。</p>
<p>除了在可检查对象中指定的预期失败之外的其他种类的失败仍会导致整体测试失败。例如，一个期望布尔值作为输入的变量，如果 Terraform 收到的是错误的值类型，即使该变量包含在 <code>expect_failures</code> 属性中，也会导致周围的测试失败。</p>
<p><code>expect_failures</code> 属性包含在其中是为了允许作者测试他们的配置和任何定义的逻辑。像前面的例子中的类型不匹配错误，不是 Terraform 作者应该担心和测试的事情，因为 Terraform 本身会处理强制类型约束。因此，你只能在自定义条件中 <code>expect_failures</code>。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2023/01/28/Teraform/Terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C2/"
                            aria-label=": Terraform-命令行2"
                        >
                            Terraform-命令行2
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-01-28T17:43:45+08:00">
	
		    2023 年 1 月 28 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="Terraform/">Terraform</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <ul>
<li>
<p><a href="#refresh"><strong>1.7.16.1.</strong> refresh</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.16.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#refresh"></a></p>
<h2 id="1-7-16-1-refresh"><a href="#refresh"></a>1.7.16.1. refresh</h2>
<p><code>terraform refresh</code> 命令将实际存在的基础设施对象的状态同步到状态文件中记录的对象状态。它可以用来检测真实状态与记录状态之间的漂移并更新状态文件。</p>
<blockquote>
<p>警告！！！该命令已在最新版本 Terraform 中被废弃，因为该命令的默认行为在当前用户错误配置了使用的云平台令牌时会引发对状态文件错误的变更。</p>
</blockquote>
<p>该命令并不会修改基础设施对象，只修改<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/2.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86.html">状态文件</a>。</p>
<p>我们一般不需要使用该命令，因为 Terraform 会自动执行相同的刷新操作，作为在 <code>terraform plan</code> 和 <code>terraform apply</code> 命令中创建计划的一部分。本命令在这里主要是为了向后兼容，但我们不建议使用它，因为它没有提供在更新状态之前检查操作效果的机会。</p>
<h2 id="1-7-16-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.16.1.1. 用法</h2>
<p><code>terraform refresh [options]</code></p>
<p>该命令本质上是以下命令的别名，具有完全相同的效果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply -refresh-only -auto-approve</span><br></pre></td></tr></table></figure>
<p>因此，该命令支持所有 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/4.apply.html"><code>terraform apply</code></a> 所支持的参数，除了它不接受一个现存的变更计划文件，不允许选择 “refresh only” 之外的模式，并且始终应用 <code>-auto-approve</code> 选项。</p>
<p>自动执行 <code>refresh</code> 是很危险的，因为如果当前用户错误配置了使用的 Provider 的令牌，那么 Terraform 会错误地以为当前状态文件中记录的所有资源都被删除了，随即从状态文件中无预警地删除所有相关记录。</p>
<p>我们推荐运行如下命令来取得相同的效果，同时可以在修改状态文件之前预览即将对其作出的修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply -refresh-only</span><br></pre></td></tr></table></figure>
<p>该命令将会在交互界面中提示用户检测到的变更，并提示用户确认执行。</p>
<p><code>terraform apply</code> 和 <code>terraform plan</code> 命令的 <code>-refresh-only</code> 选项是从 Terraform v0.15.4 版本开始被引入的。对更早的版本，用户只能直接使用 <code>terraform refresh</code> 命令，同时要小心本篇警告过的危险副作用。尽可能避免显式使用 <code>terraform refresh</code> 命令，Terraform 在执行 <code>terraform plan</code> 和 <code>terraform apply</code> 命令时都会自动执行刷新状态的操作以生成变更计划，尽可能依赖该机制来维持状态文件的同步。</p>
<h2 id="show"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">show</a></h2>
<ul>
<li>
<p><a href="#show"><strong>1.7.17.1.</strong> show</a></p>
</li>
<li>
<p><a href="#json-%E8%BE%93%E5%87%BA"><strong>1.7.17.1.1.</strong> JSON 输出</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.17.1.2.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#show"></a></p>
<h2 id="1-7-17-1-show"><a href="#show"></a>1.7.17.1. show</h2>
<p><code>terraform show</code> 命令从状态文件或是变更计划文件中打印人类可读的输出信息。这可以用来检查变更计划以确定所有操作都是符合预期的，或是审查当前的状态文件。</p>
<p>可以通过添加 <code>-json</code> 参数输出机器可读的 JSON 格式输出。</p>
<p>需要注意的是，使用 <code>-json</code> 输出时所有标记为 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F.html#%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%BE%93%E5%87%BA%E4%B8%AD%E9%9A%90%E8%97%8F%E5%80%BC-sensitive"><code>sensitive</code></a> 的敏感数据都会以明文形式被输出。</p>
<h2 id="1-7-17-1-1-JSON-输出"><a href="#json-%E8%BE%93%E5%87%BA"></a>1.7.17.1.1. JSON 输出</h2>
<p>可以使用 <code>terraform show -json</code> 命令打印 JSON 格式的状态信息。</p>
<p>如果指定了一个变更计划文件，<code>terraform show -json</code> 会以 JSON 格式记录变更计划、配置以及当前状态。</p>
<p>如果在写入状态文件后更新了包含新架构版本的 Provider 程序，则需要先升级状态，然后才能使用 <code>show -json</code> 显示状态。如果要查看计划，必须先在不使用 <code>-refresh=false</code> 的情况下创建计划文件。如果要查看当前状态，请先运行 <code>terraform refresh</code>。</p>
<h2 id="1-7-17-1-2-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.17.1.2. 用法</h2>
<p><code>terraform show [options] [file]</code></p>
<p>您可以将为 <code>file</code> 指定状态文件或计划文件的路径。如果不指定文件路径，Terraform 将显示最新的状态快照。</p>
<p>该命令支持以下参数：</p>
<ul>
<li><code>-json</code>：以 JSON 格式输出</li>
<li><code>-no-color</code>：与 <code>apply</code> 类似，不再赘述</li>
</ul>
<h2 id="state"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">state</a></h2>
<ul>
<li>
<p><a href="#state"><strong>1.7.18.1.</strong> state</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.18.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E8%BF%9C%E7%A8%8B%E7%8A%B6%E6%80%81"><strong>1.7.18.1.2.</strong> 远程状态</a></p>
</li>
<li>
<p><a href="#%E5%A4%87%E4%BB%BD"><strong>1.7.18.1.3.</strong> 备份</a></p>
</li>
<li>
<p><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%8B%E5%A5%BD"><strong>1.7.18.1.4.</strong> 命令行友好</a></p>
</li>
<li>
<p><a href="#%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80"><strong>1.7.18.1.5.</strong> 资源地址</a></p>
</li>
</ul>
<p><a href="#state"></a></p>
<h2 id="1-7-18-1-state"><a href="#state"></a>1.7.18.1. state</h2>
<p><code>terraform state</code> 命令可以用来进行复杂的状态管理操作。随着你对 Terraform 的使用越来越深入，有时候你需要对状态文件进行一些修改。由于我们在状态管理章节中提到过的，状态文件的格式属于 HashiCorp 未公开的私有格式，所以直接修改状态文件是不适合的，我们可以使用 <code>terraform state</code> 命令来执行修改。</p>
<p>该命令含有数个子命令，我们会一一介绍。</p>
<h2 id="1-7-18-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.18.1.1. 用法</h2>
<p><code>terraform state &lt;subcommand&gt; [options] [args]</code></p>
<h2 id="1-7-18-1-2-远程状态"><a href="#%E8%BF%9C%E7%A8%8B%E7%8A%B6%E6%80%81"></a>1.7.18.1.2. 远程状态</h2>
<p>所有的 <code>state</code> 子命令都可以搭配本地状态文件以及远程状态使用。使用远程状态时读写操作可能用时稍长，因为读写都要通过网络完成。备份文件仍然会被写入本地磁盘。</p>
<h2 id="1-7-18-1-3-备份"><a href="#%E5%A4%87%E4%BB%BD"></a>1.7.18.1.3. 备份</h2>
<p>所有会修改状态文件的 <code>terraform state</code> 子命令都会生成备份文件。可以通过 <code>-backup</code> 参数指定备份文件的位置。</p>
<p>只读子命令(例如 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/18.state/1.list.html"><code>list</code></a> )由于不会修改状态，所以不会生成备份文件。</p>
<p>注意修改状态的 <code>state</code> 子命令无法禁用备份。由于状态文件的敏感性，Terraform 强制所有修改状态的子命令都必须生成备份文件。如果你不想保存备份，可以手动删除。</p>
<h2 id="1-7-18-1-4-命令行友好"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%8B%E5%A5%BD"></a>1.7.18.1.4. 命令行友好</h2>
<p><code>state</code> 子命令的输出以及命令结构都被设计得易于同 Unix 下其他命令行工具搭配使用，例如 grep、awk 等等。同样的，输出结果也可以在 Windows 上轻松使用 PowerShell 处理。</p>
<p>对于复杂场景，我们建议使用管道组合 <code>state</code> 子命令与其他命令行工具一同使用。</p>
<h2 id="1-7-18-1-5-资源地址"><a href="#%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80"></a>1.7.18.1.5. 资源地址</h2>
<p><code>state</code> 子命令中大量使用了资源地址，我们在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/3.%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80.html">资源地址</a>章节中做了相关的介绍。</p>
<h2 id="list"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">list</a></h2>
<ul>
<li>
<p><a href="#list"><strong>1.7.18.1.1.</strong> list</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.18.1.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E8%B5%84%E6%BA%90"><strong>1.7.18.1.1.2.</strong> 例子：列出所有资源</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%A0%B9%E6%8D%AE%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80%E8%BF%87%E6%BB%A4"><strong>1.7.18.1.1.3.</strong> 例子：根据资源地址过滤</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%A0%B9%E6%8D%AE%E6%A8%A1%E5%9D%97%E8%BF%87%E6%BB%A4"><strong>1.7.18.1.1.4.</strong> 例子：根据模块过滤</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%A0%B9%E6%8D%AEid%E8%BF%87%E6%BB%A4"><strong>1.7.18.1.1.5.</strong> 例子：根据ID过滤</a></p>
</li>
</ul>
<p><a href="#list"></a></p>
<h2 id="1-7-18-1-1-list"><a href="#list"></a>1.7.18.1.1. list</h2>
<p><code>terraform state list</code> 命令可以列出<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/2.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86.html">状态文件</a>中记录的资源对象。</p>
<h2 id="1-7-18-1-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.18.1.1.1. 用法</h2>
<p><code>terraform state list [options] [address...]</code></p>
<p>该命令会根据 address 列出状态文件中相关资源的信息(如果给定了 address 的话)。如果没有给定 address，那么所有资源都会被列出。</p>
<p>列出的资源根据模块深度以及字典序进行排序，这意味着根模块的资源在前，越深的子模块定义的资源越在后。</p>
<p>对于复杂的基础设施，状态文件可能包含成千上万到的资源对象。可以指定一个或多个资源地址来进行过滤。</p>
<p>可以使用的可选参数有：</p>
<ul>
<li><code>-state=path</code>：指定使用的状态文件地址。默认为 <code>terraform.tfstate</code>。使用远程 Backend 时该参数设置无效</li>
<li><code>-id=id</code>：要显示的资源 ID</li>
</ul>
<h2 id="1-7-18-1-1-2-例子：列出所有资源"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89%E8%B5%84%E6%BA%90"></a>1.7.18.1.1.2. 例子：列出所有资源</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state list</span><br><span class="line">aws_instance.foo</span><br><span class="line">aws_instance.bar[0]</span><br><span class="line">aws_instance.bar[1]</span><br><span class="line">module.elb.aws_elb.main</span><br></pre></td></tr></table></figure>
<h2 id="1-7-18-1-1-3-例子：根据资源地址过滤"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%A0%B9%E6%8D%AE%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80%E8%BF%87%E6%BB%A4"></a>1.7.18.1.1.3. 例子：根据资源地址过滤</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state list aws_instance.bar</span><br><span class="line">aws_instance.bar[0]</span><br><span class="line">aws_instance.bar[1]</span><br></pre></td></tr></table></figure>
<h2 id="1-7-18-1-1-4-例子：根据模块过滤"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%A0%B9%E6%8D%AE%E6%A8%A1%E5%9D%97%E8%BF%87%E6%BB%A4"></a>1.7.18.1.1.4. 例子：根据模块过滤</h2>
<p>该例子列出给定模块及其子模块的所有资源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state list module.elb</span><br><span class="line">module.elb.aws_elb.main</span><br><span class="line">module.elb.module.secgroups.aws_security_group.sg</span><br></pre></td></tr></table></figure>
<h2 id="1-7-18-1-1-5-例子：根据ID过滤"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%A0%B9%E6%8D%AEid%E8%BF%87%E6%BB%A4"></a>1.7.18.1.1.5. 例子：根据ID过滤</h2>
<p>此示例将仅列出在命令行中指定 ID 的资源，查找特定资源在代码中的位置时非常有用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state list -<span class="built_in">id</span>=sg-1234abcd</span><br><span class="line">module.elb.aws_security_group.sg</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#mv"><strong>1.7.18.2.1.</strong> mv</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.18.2.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E9%87%8D%E5%91%BD%E5%90%8D%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90"><strong>1.7.18.2.1.2.</strong> 例子：重命名一个资源</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E5%B0%86%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%A7%BB%E5%8A%A8%E8%BF%9B%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97"><strong>1.7.18.2.1.3.</strong> 例子：将一个资源移动进一个模块</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E7%A7%BB%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97%E8%BF%9B%E5%85%A5%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97"><strong>1.7.18.2.1.4.</strong> 例子：移动一个模块进入另一个模块</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E7%A7%BB%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E6%96%87%E4%BB%B6"><strong>1.7.18.2.1.5.</strong> 例子：移动一个模块到另一个状态文件</a></p>
</li>
<li>
<p><a href="#%E7%A7%BB%E5%8A%A8%E4%B8%80%E4%B8%AA%E5%B8%A6%E6%9C%89-count-%E5%8F%82%E6%95%B0%E7%9A%84%E8%B5%84%E6%BA%90"><strong>1.7.18.2.1.6.</strong> 移动一个带有 count 参数的资源</a></p>
</li>
<li>
<p><a href="#%E7%A7%BB%E5%8A%A8%E4%B8%80%E4%B8%AA%E5%B8%A6%E6%9C%89-foreach-%E5%8F%82%E6%95%B0%E7%9A%84%E8%B5%84%E6%BA%90"><strong>1.7.18.2.1.7.</strong> 移动一个带有 for_each 参数的资源</a></p>
</li>
</ul>
<p><a href="#mv"></a></p>
<h2 id="1-7-18-2-1-mv"><a href="#mv"></a>1.7.18.2.1. mv</h2>
<p><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/2.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86.html">Terraform 状态</a>的主要功能是记录下代码中的资源实例地址与其代表的远程对象之间的绑定。通常，Terraform 会自动更新状态以响应应用计划时采取的操作，例如删除已被删除的远程对象的绑定。</p>
<p>在修改了 <code>resource</code> 块名称，或是将资源移动到代码中的不同模块时，如果想保留现有的远程对象，可以使用 <code>terraform state mv</code> 命令。</p>
<h2 id="1-7-18-2-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.18.2.1.1. 用法</h2>
<p><code>terraform state mv [options] SOURCE DESTINATION</code></p>
<p>Terraform 将在当前状态中查找与给定地址匹配的资源实例、资源或模块，如果找到，则将原本由源地址跟踪的远程对象移动到目标地址下。</p>
<p>源地址和目标地址都必须使用<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/3.%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80.html">资源地址语法</a>，并且它们引用对象的类型必须相同：我们只能将一个资源实例移动到另一个资源实例，将整个模块实例移动到另一个整个模块实例，等等。此外，如果我们要移动资源或资源实例，则只能将其移动到具有相同资源类型的新地址。</p>
<p><code>terraform state mv</code> 最常见的用途是当我们在代码中重命名 <code>resource</code> 块，或是将 <code>resource</code> 块移动到子模块中时，这两种情况都是为了保留现有对象但以新地址跟踪它。默认情况下，Terraform 会将移动或重命名资源配置理解为删除旧对象并在新地址创建新对象的请求，因此 <code>terraform state mv</code> 允许我们已经存在的对象附加到Terraform 中的新地址上。</p>
<p>警告：如果我们在多人协作环境中使用 Terraform，则必须确保当我们使用 <code>terraform state mv</code> 进行代码重构时，我们与同事进行了仔细沟通，以确保没有人在我们的配置更改和 terraform 状态之间进行任何其他更改mv 命令，因为否则他们可能会无意中创建一个计划，该计划将销毁旧对象并在新地址创建新对象。</p>
<p>该命令提供以下可选参数：</p>
<ul>
<li><code>-dry-run</code>：报告与给定地址匹配的所有资源实例。</li>
<li><code>-lock=false</code>：执行时是否先锁定状态文件。如果其他人可能同时对同一工作区运行命令，则这是危险的。</li>
<li><code>-lock-timeout=DURATION</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则命令 Terraform 为上锁操作设置一个超时时长。持续时间语法是一个数字后跟一个时间单位字母，例如“3s”表示三秒。</li>
</ul>
<p>以下是使用 <code>local</code> Backend 时可用的遗留参数：</p>
<ul>
<li><code>-backup=FILENAME</code>：指定源状态文件的备份地址，默认为源状态文件加上&quot;.backup&quot;后缀</li>
<li><code>-bakcup-out=FILENAME</code>：指定目标状态文件的备份地址，默认为目标状态文件加上&quot;.backup&quot;后缀</li>
<li><code>-state=FILENAME</code>：源状态文件地址，默认为当前 Backend 或是&quot;terraform.tfstate&quot;</li>
<li><code>-state-out=FILENAME</code>：目标状态文件地址。如果不指定则使用源状态文件。可以是一个已经存在的文件或新建一个文件</li>
</ul>
<h2 id="1-7-18-2-1-2-例子：重命名一个资源"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E9%87%8D%E5%91%BD%E5%90%8D%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90"></a>1.7.18.2.1.2. 例子：重命名一个资源</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">mv</span> <span class="string">&#x27;packet_device.worker&#x27;</span> <span class="string">&#x27;packet_device.helper&#x27;</span></span><br><span class="line">...</span><br><span class="line">-resource <span class="string">&quot;packet_device&quot;</span> <span class="string">&quot;worker&quot;</span> &#123;</span><br><span class="line">+resource <span class="string">&quot;packet_device&quot;</span> <span class="string">&quot;helper&quot;</span> &#123;</span><br><span class="line">   <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-7-18-2-1-3-例子：将一个资源移动进一个模块"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E5%B0%86%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%A7%BB%E5%8A%A8%E8%BF%9B%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97"></a>1.7.18.2.1.3. 例子：将一个资源移动进一个模块</h2>
<p>如果我们最初在根模块中编写了资源，但现在希望将其重构进子模块，则可以将 <code>resource</code> 块移动到子模块代码中，删除根模块中的原始资源，然后运行以下命令告诉 Terraform 将其视为一次移动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">mv</span> <span class="string">&#x27;packet_device.worker&#x27;</span> <span class="string">&#x27;module.app.packet_device.worker&#x27;</span></span><br></pre></td></tr></table></figure>
<p>在上面的示例中，新资源具有相同的名称，但模块地址不同。如果新的模块组织建议不同的命名方案，您还可以同时更改资源名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">mv</span> packet_device.worker module.worker.packet_device.main</span><br></pre></td></tr></table></figure>
<h2 id="1-7-18-2-1-4-例子：移动一个模块进入另一个模块"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E7%A7%BB%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97%E8%BF%9B%E5%85%A5%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97"></a>1.7.18.2.1.4. 例子：移动一个模块进入另一个模块</h2>
<p>我们还可以将整个模块重构为子模块。在配置中，将代表模块的 <code>module</code> 块移动到不同的模块中，然后使用如下命令将更改配对：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">mv</span> <span class="string">&#x27;module.app&#x27;</span> <span class="string">&#x27;module.parent.module.app&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-7-18-2-1-5-例子：移动一个模块到另一个状态文件"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E7%A7%BB%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E6%96%87%E4%BB%B6"></a>1.7.18.2.1.5. 例子：移动一个模块到另一个状态文件</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">mv</span> -state-out=other.tfstate <span class="string">&#x27;module.app&#x27;</span> <span class="string">&#x27;module.app&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-7-18-2-1-6-移动一个带有-count-参数的资源"><a href="#%E7%A7%BB%E5%8A%A8%E4%B8%80%E4%B8%AA%E5%B8%A6%E6%9C%89-count-%E5%8F%82%E6%95%B0%E7%9A%84%E8%B5%84%E6%BA%90"></a>1.7.18.2.1.6. 移动一个带有 count 参数的资源</h2>
<p>使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/6.%E8%B5%84%E6%BA%90.html#count"><code>count</code> 元参数</a>定义的资源具有多个实例，每个实例都由一个整数标识。我们可以通过在给定地址中包含显式索引来选择特定实例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">mv</span> <span class="string">&#x27;packet_device.worker[0]&#x27;</span> <span class="string">&#x27;packet_device.helper[0]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>不使用 <code>count</code> 或 <code>for_each</code> 的资源只有一个资源实例，其地址与资源本身相同，因此我们可以从不包含索引的地址移动到包含索引的地址，或相反：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">mv</span> <span class="string">&#x27;packet_device.main&#x27;</span> <span class="string">&#x27;packet_device.all[0]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>方括号 (<code>[</code>, <code>]</code>) 在某些 shell 中具有特殊含义，因此您可能需要引用或转义地址，以便将其逐字传递给 Terraform。上面的示例显示了 Unix 风格 shell 的典型引用语法。</p>
<h2 id="1-7-18-2-1-7-移动一个带有-for-each-参数的资源"><a href="#%E7%A7%BB%E5%8A%A8%E4%B8%80%E4%B8%AA%E5%B8%A6%E6%9C%89-foreach-%E5%8F%82%E6%95%B0%E7%9A%84%E8%B5%84%E6%BA%90"></a>1.7.18.2.1.7. 移动一个带有 for_each 参数的资源</h2>
<p>使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/6.%E8%B5%84%E6%BA%90.html#for_each"><code>for_each</code> 元参数</a>定义的资源具有多个实例，每个实例都由一个字符串标识。我们可以通过在给定地址中包含显式的键来选择特定实例。</p>
<p>但是，字符串的语法包含引号，并且引号符号通常在命令 shell 中具有特殊含义，因此我们需要为正在使用的 shell 使用适当的引用和/或转义语法。例如：</p>
<p>Linux、MacOS 以及 Unix：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">mv</span> <span class="string">&#x27;packet_device.worker[&quot;example123&quot;]&#x27;</span> <span class="string">&#x27;packet_device.helper[&quot;example456&quot;]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>PowerShell：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> terraform state <span class="built_in">mv</span> <span class="string">&#x27;packet_device.worker[\&quot;example123\&quot;]&#x27;</span> <span class="string">&#x27;packet_device.helper[\&quot;example456\&quot;]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Windows 命令行（<code>cmd.exe</code>）：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state mv packet_device.worker[\&quot;example123\&quot;] packet_device.helper[\&quot;example456\&quot;]</span><br></pre></td></tr></table></figure>
<p>除了使用字符串而不是整数作为实例键之外，<code>for_each</code> 资源的处理与 <code>count</code> 资源类似，因此具有和不具有索引组件的相同地址组合都是有效的，如上一节所述。</p>
<ul>
<li>
<p><a href="#pull"><strong>1.7.18.3.1.</strong> pull</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.18.3.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#pull"></a></p>
<h2 id="1-7-18-3-1-pull"><a href="#pull"></a>1.7.18.3.1. pull</h2>
<p><code>terraform state pull</code> 命令可以从远程 Backend 中人工下载状态并输出。该命令也可搭配本地状态文件使用。</p>
<h2 id="1-7-18-3-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.18.3.1.1. 用法</h2>
<p><code>terraform state pull</code></p>
<p>该命令下载当前位置对应的状态文件，并以原始格式打印到标准输出流。</p>
<p>由于状态文件使用 JSON 格式，该功能可以搭配例如 <a target="_blank" rel="noopener" href="https://stedolan.github.io/jq/">jq</a> 这样的命令行工具使用，也可以用来人工修改状态文件。</p>
<p>注意：Terraform 状态文件必须采用 UTF-8 格式，不带字节顺序标记 (BOM)。对于 Windows 上的 PowerShell，使用 Set-Content 自动以 UTF-8 格式对文件进行编码。例如，运行 <code>terraform state pull</code> | <code>sc terraform.tfstate</code></p>
<h2 id="push"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">push</a></h2>
<ul>
<li>
<p><a href="#push"><strong>1.7.18.4.1.</strong> push</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.18.4.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#push"></a></p>
<h2 id="1-7-18-4-1-push"><a href="#push"></a>1.7.18.4.1. push</h2>
<p><code>terraform push</code> 命令被用来手动上传本地状态文件到远程 Backend。该命令也可以被用在当前使用的本地状态文件上。</p>
<p>该命令应该很少使用。它时一种需要对远程状态进行手动干预的情况下使用的工具。</p>
<h2 id="1-7-18-4-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.18.4.1.1. 用法</h2>
<p><code>terraform state push [options] PATH</code></p>
<p>该命令会把 PATH 位置的状态文件推送到当前使用的 Backend 上(可以是当前使用的 terraform.tfstate 文件)。</p>
<p>如果 PATH 为 <code>-</code>，则从标准输入流读取要推送的状态数据。该数据在写入目标状态之前被完全加载到内存中并进行验证。</p>
<p>注意：Terraform 状态文件必须采用 UTF-8 格式，不带字节顺序标记 (BOM)。对于 Windows 上的 PowerShell，使用 Set-Content 自动以 UTF-8 格式对文件进行编码。例如，运行 <code>terraform state push | sc terraform.tfstate</code>。</p>
<p>Terraform 会进行一系列检查以防止你进行一些不安全的变更：</p>
<ul>
<li>检查 lineage：如果两个状态文件的 lineage 值不同，Terraform 会禁止推送。一个不同的 lineage 说明两个状态文件描述的是完全不同的基础设而你可能会因此丢失重要数据</li>
<li>序列号检查：如果目标状态文件的 serial 值大于你要推送的状态的 serial 值，Terraform 会禁止推送。一个更高的 serial 值说明目标状态文件已经无法与要推送的状态文件对应上了</li>
</ul>
<p>这两种检查都可以通过添加 <code>-force</code> 参数禁用，但<strong>不推荐这样做</strong>。如果禁用安全检查直接推送，那么目标状态文件将被覆盖。</p>
<h2 id="replace-provider"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">replace-provider</a></h2>
<ul>
<li>
<p><a href="#replace-provider"><strong>1.7.18.5.1.</strong> replace-provider</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.18.5.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E6%A0%B7%E4%BE%8B"><strong>1.7.18.5.1.2.</strong> 样例</a></p>
</li>
</ul>
<p><a href="#replace-provider"></a></p>
<h2 id="1-7-18-5-1-replace-provider"><a href="#replace-provider"></a>1.7.18.5.1. replace-provider</h2>
<p><code>terraform state replace-provider</code> 命令可以替换<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/2.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86.html">状态文件</a>中资源对象所使用的 Provider.</p>
<h2 id="1-7-18-5-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.18.5.1.1. 用法</h2>
<p><code>terraform state replace-provider [options] FROM_PROVIDER_FQN TO_PROVIDER_FQN</code></p>
<p>该命令会更新所有使用 from 的 Provider 的资源，将它们使用的 Provider 更新为 to Provider。这让我们可以更新状态文件中资源所使用的 Provider 的源。</p>
<p>该命令在进行任意修改之前会先生成一个备份文件。备份机制不可关闭。</p>
<p>支持以下可选参数：</p>
<ul>
<li><code>-auto-approve</code>：跳过交互式提示确认环节</li>
<li><code>-lock=false</code>：执行时是否先锁定状态文件。如果其他人可能同时对同一工作区运行命令，则这是危险的。</li>
<li><code>-lock-timeout=0s</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则命令 Terraform 为上锁操作设置一个超时时长。持续时间语法是一个数字后跟一个时间单位字母，例如“3s”表示三秒。</li>
</ul>
<p>以下是使用 <code>local</code> Backend 时可用的遗留参数：</p>
<ul>
<li><code>-backup=FILENAME</code>：指定源状态文件的备份地址，默认为源状态文件加上&quot;.backup&quot;后缀</li>
<li><code>-bakcup-out=FILENAME</code>：指定目标状态文件的备份地址，默认为目标状态文件加上&quot;.backup&quot;后缀</li>
<li><code>-state=FILENAME</code>：源状态文件地址，默认为当前 Backend 或是&quot;terraform.tfstate&quot;</li>
<li><code>-state-out=FILENAME</code>：目标状态文件地址。如果不指定则使用源状态文件。可以是一个已经存在的文件或新建一个文件</li>
</ul>
<h2 id="1-7-18-5-1-2-样例"><a href="#%E6%A0%B7%E4%BE%8B"></a>1.7.18.5.1.2. 样例</h2>
<p>下面的示例将 <code>hashicorp/aws</code> Provider 程序替换为 <code>acme</code> 的复刻版本，该 Provider 托管在 <code>registry.acme.corp</code> 的私有注册表中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state replace-provider hashicorp/aws registry.acme.corp/acme/aws</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#rm"><strong>1.7.18.6.1.</strong> rm</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.18.6.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90"><strong>1.7.18.6.1.1.1.</strong> 删除一个资源</a></p>
</li>
<li>
<p><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97"><strong>1.7.18.6.1.1.2.</strong> 删除一个模块</a></p>
</li>
<li>
<p><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%86%85%E8%B5%84%E6%BA%90"><strong>1.7.18.6.1.1.3.</strong> 删除一个模块内资源</a></p>
</li>
<li>
<p><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E5%A3%B0%E6%98%8Ecount%E7%9A%84%E8%B5%84%E6%BA%90"><strong>1.7.18.6.1.1.4.</strong> 删除一个声明count的资源</a></p>
</li>
<li>
<p><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E5%A3%B0%E6%98%8Eforeach%E7%9A%84%E8%B5%84%E6%BA%90"><strong>1.7.18.6.1.1.5.</strong> 删除一个声明for_each的资源</a></p>
</li>
</ul>
<p><a href="#rm"></a></p>
<h2 id="1-7-18-6-1-rm"><a href="#rm"></a>1.7.18.6.1. rm</h2>
<p><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/2.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86.html">Terraform 状态</a>的主要功能是记录下代码中的资源实例地址与其代表的远程对象之间的绑定。通常，Terraform 会自动更新状态以响应应用计划时采取的操作，例如删除已被删除的远程对象的绑定。</p>
<p><code>terraform state rm</code> 命令可以用来从状态文件中删除对象和实际远程对象的绑定，该命令只是删除绑定，不会删除实际存在的远程对象，删除后 Terraform 会“忘记”这个对象的存在。</p>
<p>注意：从 Terraform v1.7.0 开始支持 <code>removed</code> 块。与 <code>terraform state rm</code> 命令不同，您可以使用 <code>removed</code> 块一次删除多个资源，并且您可以将删除操作作为正常计划和执行工作流程的一部分进行审查。了解有关将 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/6.%E8%B5%84%E6%BA%90.html#%E5%88%A0%E9%99%A4%E8%B5%84%E6%BA%90"><code>removed</code> 块与资源一起使用</a>以及将 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/5.Terraform%E6%A8%A1%E5%9D%97/4.%E9%87%8D%E6%9E%84.html#%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97"><code>removed</code> 块与模块一起使用</a>的更多信息。</p>
<h2 id="1-7-18-6-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.18.6.1.1. 用法</h2>
<p><code>terraform state rm [options] ADDRESS...</code></p>
<p>Terraform 将在状态中搜索与给定<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/3.%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80.html">资源地址</a>匹配的任何实例，并删除所有实例对应的记录，以便 Terraform 将不再跟踪相应的远程对象。</p>
<p>这意味着尽管这些对象仍将继续存在于远程系统中，但后续的 <code>terraform plan</code> 会尝试新建这些被“遗忘”的实例。根据远程系统施加的约束，如果这些对象的名称或其他标识符与仍然存在的旧对象发生冲突，创建这些对象可能会失败。</p>
<p>可以使用如下可选参数：</p>
<ul>
<li><code>-dry-run</code>：报告与给定地址匹配的所有资源实例（由于此时并未执行删除，所以 Terraform 这时还不会“遗忘”任何资源）。</li>
<li><code>-lock=false</code>：执行时是否先锁定状态文件。如果其他人可能同时对同一工作区运行命令，则这是危险的。</li>
<li><code>-lock-timeout=DURATION</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则命令 Terraform 为上锁操作设置一个超时时长。持续时间语法是一个数字后跟一个时间单位字母，例如“3s”表示三秒。</li>
</ul>
<p>以下是使用 <code>local</code> Backend 时可用的遗留参数：</p>
<ul>
<li><code>-backup=FILENAME</code>：指定源状态文件的备份地址，默认为源状态文件加上&quot;.backup&quot;后缀</li>
<li><code>-bakcup-out=FILENAME</code>：指定目标状态文件的备份地址，默认为目标状态文件加上&quot;.backup&quot;后缀</li>
<li><code>-state=FILENAME</code>：源状态文件地址，默认为当前 Backend 或是&quot;terraform.tfstate&quot;</li>
<li><code>-state-out=FILENAME</code>：目标状态文件地址。如果不指定则使用源状态文件。可以是一个已经存在的文件或新建一个文件</li>
</ul>
<h3 id="1-7-18-6-1-1-1-删除一个资源"><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90"></a>1.7.18.6.1.1.1. 删除一个资源</h3>
<p>下面的例子演示了如何让 Terraform “遗忘”所有类型为 <code>packet_device</code>，并且名为 <code>worker</code> 的资源实例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">rm</span> <span class="string">&#x27;packet_device.worker&#x27;</span></span><br></pre></td></tr></table></figure>
<p>不使用 <code>count</code> 或 <code>for_each</code> 的资源只有一个实例，因此该示例也是选择该单个实例的正确语法。</p>
<h3 id="1-7-18-6-1-1-2-删除一个模块"><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97"></a>1.7.18.6.1.1.2. 删除一个模块</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">rm</span> <span class="string">&#x27;module.foo&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="1-7-18-6-1-1-3-删除一个模块内资源"><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%86%85%E8%B5%84%E6%BA%90"></a>1.7.18.6.1.1.3. 删除一个模块内资源</h3>
<p>要选择在子模块中定义的资源，我们必须指定该模块的路径作为资源地址的一部分：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">rm</span> <span class="string">&#x27;module.foo.packet_device.worker&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="1-7-18-6-1-1-4-删除一个声明count的资源"><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E5%A3%B0%E6%98%8Ecount%E7%9A%84%E8%B5%84%E6%BA%90"></a>1.7.18.6.1.1.4. 删除一个声明count的资源</h3>
<p>使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/6.%E8%B5%84%E6%BA%90.html#count"><code>count</code> 元参数</a>定义的资源具有多个实例，每个实例都由一个整数标识。我们可以通过在给定地址中包含显式索引来选择特定实例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">rm</span> <span class="string">&#x27;packet_device.worker[0]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>方括号 (<code>[</code>, <code>]</code>) 在某些 shell 中具有特殊含义，因此我们可能需要引用或转义地址，以便将其逐字传递给 Terraform。上面的例子使用了 Unix 风格 shell 的典型引用语法。</p>
<h3 id="1-7-18-6-1-1-5-删除一个声明for-each的资源"><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E5%A3%B0%E6%98%8Eforeach%E7%9A%84%E8%B5%84%E6%BA%90"></a>1.7.18.6.1.1.5. 删除一个声明for_each的资源</h3>
<p>使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/6.%E8%B5%84%E6%BA%90.html#for_each"><code>for_each</code> 元参数</a>定义的资源具有多个实例，每个实例都由一个字符串标识。我们可以通过在给定地址中包含显式密钥来选择特定实例。</p>
<p>但是，字符串的语法包含引号，并且引号符号通常在命令 shell 中具有特殊含义，因此我们需要为我们正在使用的 shell 使用适当的引用和/或转义语法。例如：</p>
<p>Linux, MacOS, and Unix：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state <span class="built_in">rm</span> <span class="string">&#x27;packet_device.worker[&quot;example&quot;]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>PowerShell：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> terraform state <span class="built_in">rm</span> <span class="string">&#x27;packet_device.worker[\&quot;example\&quot;]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Windows命令行（<code>cmd.exe</code>）：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state rm packet_device.worker[\&quot;example\&quot;]</span><br></pre></td></tr></table></figure>
<h2 id="show-2"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">show</a></h2>
<ul>
<li>
<p><a href="#show"><strong>1.7.18.7.1.</strong> show</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.18.7.1.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E5%B1%95%E7%A4%BA%E5%8D%95%E4%B8%AA%E8%B5%84%E6%BA%90"><strong>1.7.18.7.1.1.2.</strong> 展示单个资源</a></p>
</li>
<li>
<p><a href="#%E5%B1%95%E7%A4%BA%E5%8D%95%E4%B8%AA%E6%A8%A1%E5%9D%97%E8%B5%84%E6%BA%90"><strong>1.7.18.7.1.1.3.</strong> 展示单个模块资源</a></p>
</li>
<li>
<p><a href="#%E5%B1%95%E7%A4%BA%E5%A3%B0%E6%98%8Ecount%E8%B5%84%E6%BA%90%E4%B8%AD%E7%89%B9%E5%AE%9A%E5%AE%9E%E4%BE%8B"><strong>1.7.18.7.1.1.4.</strong> 展示声明count资源中特定实例</a></p>
</li>
<li>
<p><a href="#%E5%B1%95%E7%A4%BA%E5%A3%B0%E6%98%8Eforeach%E8%B5%84%E6%BA%90%E4%B8%AD%E7%89%B9%E5%AE%9A%E5%AE%9E%E4%BE%8B"><strong>1.7.18.7.1.1.5.</strong> 展示声明for_each资源中特定实例</a></p>
</li>
</ul>
<p><a href="#show"></a></p>
<h2 id="1-7-18-7-1-show"><a href="#show"></a>1.7.18.7.1. show</h2>
<p><code>terraform state show</code> 命令可以展示状态文件中单个资源的属性。</p>
<h3 id="1-7-18-7-1-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.18.7.1.1.1. 用法</h3>
<p><code>terraform state show [options] ADDRESS</code></p>
<p>该命令需要指定一个资源地址。资源地址需要遵循<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/3.%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80.html">资源地址格式</a>。</p>
<p>该命令支持以下可选参数：</p>
<ul>
<li><code>-state=path</code>：指向状态文件的路径。默认情况下是 <code>terraform.tfstate</code>。如果启用了远程 Backend 则该参数设置无效</li>
</ul>
<p><code>terraform state show</code> 的输出被设计成人类可读而非机器可读。如果想要从输出中提取数据，请使用 <code>terraform show -json</code>。</p>
<h3 id="1-7-18-7-1-1-2-展示单个资源"><a href="#%E5%B1%95%E7%A4%BA%E5%8D%95%E4%B8%AA%E8%B5%84%E6%BA%90"></a>1.7.18.7.1.1.2. 展示单个资源</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state show <span class="string">&#x27;packet_device.worker&#x27;</span></span><br><span class="line"><span class="comment"># packet_device.worker:</span></span><br><span class="line">resource <span class="string">&quot;packet_device&quot;</span> <span class="string">&quot;worker&quot;</span> &#123;</span><br><span class="line">    billing_cycle = <span class="string">&quot;hourly&quot;</span></span><br><span class="line">    created       = <span class="string">&quot;2015-12-17T00:06:56Z&quot;</span></span><br><span class="line">    facility      = <span class="string">&quot;ewr1&quot;</span></span><br><span class="line">    hostname      = <span class="string">&quot;prod-xyz01&quot;</span></span><br><span class="line">    <span class="built_in">id</span>            = <span class="string">&quot;6015bg2b-b8c4-4925-aad2-f0671d5d3b13&quot;</span></span><br><span class="line">    locked        = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-7-18-7-1-1-3-展示单个模块资源"><a href="#%E5%B1%95%E7%A4%BA%E5%8D%95%E4%B8%AA%E6%A8%A1%E5%9D%97%E8%B5%84%E6%BA%90"></a>1.7.18.7.1.1.3. 展示单个模块资源</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state show <span class="string">&#x27;module.foo.packet_device.worker&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="1-7-18-7-1-1-4-展示声明count资源中特定实例"><a href="#%E5%B1%95%E7%A4%BA%E5%A3%B0%E6%98%8Ecount%E8%B5%84%E6%BA%90%E4%B8%AD%E7%89%B9%E5%AE%9A%E5%AE%9E%E4%BE%8B"></a>1.7.18.7.1.1.4. 展示声明count资源中特定实例</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state show <span class="string">&#x27;packet_device.worker[0]&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="1-7-18-7-1-1-5-展示声明for-each资源中特定实例"><a href="#%E5%B1%95%E7%A4%BA%E5%A3%B0%E6%98%8Eforeach%E8%B5%84%E6%BA%90%E4%B8%AD%E7%89%B9%E5%AE%9A%E5%AE%9E%E4%BE%8B"></a>1.7.18.7.1.1.5. 展示声明for_each资源中特定实例</h3>
<p>Linux, MacOS, and Unix：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state show <span class="string">&#x27;packet_device.worker[&quot;example&quot;]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>PowerShell：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> terraform state show <span class="string">&#x27;packet_device.worker[\&quot;example\&quot;]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Windows命令行：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform state show packet_device.worker[\&quot;example\&quot;]</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#taint"><strong>1.7.19.1.</strong> taint</a></p>
</li>
<li>
<p><a href="#%E6%8E%A8%E8%8D%90%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%B3%95"><strong>1.7.19.1.1.</strong> 推荐的替代方法</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.19.1.2.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E6%A0%87%E8%AE%B0%E5%8D%95%E4%B8%AA%E8%B5%84%E6%BA%90"><strong>1.7.19.1.3.</strong> 标记单个资源</a></p>
</li>
<li>
<p><a href="#%E6%A0%87%E8%AE%B0%E4%BD%BF%E7%94%A8foreach%E5%88%9B%E5%BB%BA%E7%9A%84%E8%B5%84%E6%BA%90%E7%9A%84%E7%89%B9%E5%AE%9A%E5%AE%9E%E4%BE%8B"><strong>1.7.19.1.4.</strong> 标记使用for_each创建的资源的特定实例</a></p>
</li>
<li>
<p><a href="#%E6%A0%87%E8%AE%B0%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90"><strong>1.7.19.1.5.</strong> 标记模块中的资源</a></p>
</li>
</ul>
<p><a href="#taint"></a></p>
<h2 id="1-7-19-1-taint"><a href="#taint"></a>1.7.19.1. taint</h2>
<p><code>terrform taint</code> 命令可以手动标记某个Terraform管理的资源有&quot;污点&quot;，强迫在下一次执行apply时删除并重建之。</p>
<p>该命令并不会修改基础设施，而是在状态文件中的某个资源对象上标记污点。当一个资源对象被标记了污点，在下一次 <code>plan</code> 操作时会计划将之删除并且重建，<code>apply</code> 操作会执行这个变更。</p>
<p>强迫重建某个资源可以使你能够触发某种副作用。举例来说，你想重新执行某个预置器操作，或是某些人绕过 Terraform 修改了虚拟机状态，而你想将虚拟机重置。</p>
<p>注意为某个资源标记污点并重建之会影响到所有依赖该资源的对象。举例来说，一条 DNS 记录使用了服务器的 IP 地址，我们在服务器上标记污点会导致 IP 发生变化从而影响到 DNS 记录。这种情况下可以使用 <code>plan</code> 命令查看变更计划。</p>
<p>警告：此命令已被弃用。从 Terraform v0.15.2 开始，我们建议使用 <code>-replace</code> 选项和 <code>terraform apply</code> 代替（详细信息如下）。</p>
<h2 id="1-7-19-1-1-推荐的替代方法"><a href="#%E6%8E%A8%E8%8D%90%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%B3%95"></a>1.7.19.1.1. 推荐的替代方法</h2>
<p>从 Terraform v0.15.2 开始，我们建议使用 <code>terraform apply</code> 的 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan.html#plan-%E9%80%89%E9%A1%B9"><code>-replace</code> 选项</a>来强制 Terraform 替换对象，即使没有发生需要变更的配置更改。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply -replace=<span class="string">&quot;aws_instance.example[0]&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们推荐使用 <code>-replace</code> 参数，因为这可以在 Terraform 计划中显示将要发生的变更，让我们在采取任何会影响系统的操作之前了解计划将如何影响我们的基础设施。当我们使用 <code>terraform taint</code> 时，其他用户有可能可以在我们审查变更之前针对标记的对象创建新的变更计划。</p>
<h2 id="1-7-19-1-2-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.19.1.2. 用法</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform taint [options] &lt;address&gt;</span><br></pre></td></tr></table></figure>
<p><code>address</code> 参数是要标记污点的资源地址。该地址格式遵循<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/3.%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80.html">资源地址语法</a>，例如：</p>
<ul>
<li><code>aws_instance.foo</code></li>
<li><code>aws_instance.bar[1]</code></li>
<li><code>aws_instance.baz[\&quot;key\&quot;]</code> （资源地址中的引号必须在命令行中转义，这样它们就不会被 shell 解释）</li>
<li><code>module.foo.module.bar.aws_instance.qux</code></li>
</ul>
<p>该命令可以使用如下可选参数：</p>
<ul>
<li><code>-allow-missing</code>：如果声明该参数，那么即使资源不存在，命令也会返回成功(状态码0)。对于其他异常情况，该命令可能仍会返回错误，例如读取或写入状态时出现问题。</li>
<li><code>-lock=false</code>：执行时是否先锁定状态文件。如果其他人可能同时对同一工作区运行命令，则这是危险的。</li>
<li><code>-lock-timeout=DURATION</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则命令 Terraform 为上锁操作设置一个超时时长。持续时间语法是一个数字后跟一个时间单位字母，例如“3s”表示三秒。</li>
</ul>
<p>以下是使用 <code>local</code> Backend 时可用的遗留参数：</p>
<ul>
<li><code>-backup=FILENAME</code>：指定源状态文件的备份地址，默认为源状态文件加上&quot;.backup&quot;后缀</li>
<li><code>-bakcup-out=FILENAME</code>：指定目标状态文件的备份地址，默认为目标状态文件加上&quot;.backup&quot;后缀</li>
<li><code>-state=FILENAME</code>：源状态文件地址，默认为当前 Backend 或是&quot;terraform.tfstate&quot;</li>
<li><code>-state-out=FILENAME</code>：目标状态文件地址。如果不指定则使用源状态文件。可以是一个已经存在的文件或新建一个文件</li>
</ul>
<h2 id="1-7-19-1-3-标记单个资源"><a href="#%E6%A0%87%E8%AE%B0%E5%8D%95%E4%B8%AA%E8%B5%84%E6%BA%90"></a>1.7.19.1.3. 标记单个资源</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform taint aws_security_group.allow_all</span><br><span class="line">The resource aws_security_group.allow_all <span class="keyword">in</span> the module root has been marked as tainted.</span><br></pre></td></tr></table></figure>
<h2 id="1-7-19-1-4-标记使用for-each创建的资源的特定实例"><a href="#%E6%A0%87%E8%AE%B0%E4%BD%BF%E7%94%A8foreach%E5%88%9B%E5%BB%BA%E7%9A%84%E8%B5%84%E6%BA%90%E7%9A%84%E7%89%B9%E5%AE%9A%E5%AE%9E%E4%BE%8B"></a>1.7.19.1.4. 标记使用for_each创建的资源的特定实例</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform taint <span class="string">&quot;module.route_tables.azurerm_route_table.rt[\&quot;DefaultSubnet\&quot;]&quot;</span></span><br><span class="line">The resource module.route_tables.azurerm_route_table.rt[<span class="string">&quot;DefaultSubnet&quot;</span>] <span class="keyword">in</span> the module root has been marked as tainted.</span><br></pre></td></tr></table></figure>
<h2 id="1-7-19-1-5-标记模块中的资源"><a href="#%E6%A0%87%E8%AE%B0%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90"></a>1.7.19.1.5. 标记模块中的资源</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform taint <span class="string">&quot;module.couchbase.aws_instance.cb_node[9]&quot;</span></span><br><span class="line">Resource instance module.couchbase.aws_instance.cb_node[9] has been marked as tainted.</span><br></pre></td></tr></table></figure>
<p>虽然我们推荐模块深度不要超过1，但是我们仍然可以标记多层模块中的资源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform taint <span class="string">&quot;module.child.module.grandchild.aws_instance.example[2]&quot;</span></span><br><span class="line">Resource instance module.child.module.grandchild.aws_instance.example[2] has been marked as tainted.</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#validate"><strong>1.7.20.1.</strong> validate</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.20.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#json-%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F"><strong>1.7.20.1.2.</strong> JSON 输出格式</a></p>
</li>
<li>
<p><a href="#%E6%BA%90%E4%BD%8D%E7%BD%AE%EF%BC%88source-position%EF%BC%89"><strong>1.7.20.1.2.1.</strong> 源位置（Source Position）</a></p>
</li>
<li>
<p><a href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%80%BC"><strong>1.7.20.1.2.2.</strong> 表达式值</a></p>
</li>
</ul>
<p><a href="#validate"></a></p>
<h2 id="1-7-20-1-validate"><a href="#validate"></a>1.7.20.1. validate</h2>
<p><code>terraform validate</code> 命令可以检查目录下 Terraform 代码，只检查语法文件，不会访问诸如远程 Backend、Provider 的 API 等远程资源。</p>
<p><code>validate</code> 检查代码的语法是否合法以及一致，不管输入变量以及现存状态。</p>
<p>自动运行此命令是安全的，例如作为文本编辑器中的保存后检查或作为 CI 系统中可复用的测试步骤。</p>
<p><code>validate</code> 命令需要已初始化的工作目录，所有引用的插件与模块都被安装完毕。如果只想检查语法而不想与 Backend 交互，可以这样初始化工作目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform init -backend=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>要验证特定运行上下文中的配置（特定目标工作空间、输入变量值等），请改用 <code>terraform plan</code> 命令，其中包括隐式验证检查。</p>
<h2 id="1-7-20-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.20.1.1. 用法</h2>
<p><code>terraform validate [options]</code></p>
<p>默认情况下 <code>validate</code> 命令不需要任何参数就可以在当前工作目录下进行检查。</p>
<p>可以使用如下可选参数：</p>
<ul>
<li>-json：使用 JSON 格式输出机器可读的结果</li>
<li>-no-color：禁止使用彩色输出</li>
</ul>
<h2 id="1-7-20-1-2-JSON-输出格式"><a href="#json-%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F"></a>1.7.20.1.2. JSON 输出格式</h2>
<p>当您使用 <code>-json</code> 选项时，Terraform 将生成 JSON 格式的验证结果，使得我们可以将之与验证结果的工具进行集成，例如在文本编辑器中突出显示错误。</p>
<p>与所有 JSON 输出选项一样，Terraform 在开始验证任务之前就可能会遇到错误，因此输出的错误可能不会是 JSON 格式的。因此，使用 Terraform 输出的外部软件应该准备好在 stdout 上读取到非有效 JSON 的数据，然后将其视为一般错误情况。</p>
<p>输出包含一个 <code>format_version</code> 键，从 Terraform 1.1.0 开始，其值为“1.0”。该版本的语义是：</p>
<ul>
<li>对于向后兼容的变更或新增字段，我们将增加 minor 版本号，例如 <code>&quot;1.1&quot;</code>。这种变更会忽略所有不认识的对象属性，以保持与未来其他 minor 版本的前向兼容。</li>
<li>对于不向后兼容的变更，我们将增加 major 版本，例如 <code>&quot;2.0&quot;</code>。不同的 major 版本之间的数据无法直接传递。</li>
</ul>
<p>我们只会在 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/v1-compatibility-promises">Terraform 1.0 兼容性承诺</a>的范围内更新 major 版本。</p>
<p>在正常情况下，Terraform 会将 JSON 对象打印到标准输出流。顶级 JSON 对象将具有以下属性：</p>
<ul>
<li><code>valid</code>（bool）：总体验证结果结论，如果 Terraform 认为当前配置有效，则为 <code>true</code>；如果检测到任何错误，则为 <code>false</code>。</li>
<li><code>error_count</code>（number）：零或正整数，给出 Terraform 检测到的错误计数。如果 <code>valid</code> 为 <code>true</code>，则 <code>error_count</code> 将始终为零，因为错误的存在表明配置无效。</li>
<li><code>warning_count</code>（number）：零或正整数，给出 Terraform 检测到的警告计数。警告不会导致 Terraform 认为配置无效，但用户应考虑并尝试解决它们。</li>
<li><code>diagnostics</code>（对象数组）：嵌套对象的 JSON 数组，每个对象描述来自 Terraform 的错误或警告。</li>
</ul>
<p><code>diagnostics</code> 中的对象拥有如下属性：</p>
<ul>
<li><code>severity</code>（string）：字符串关键字，可以是 <code>&quot;error&quot;</code> 或 <code>&quot;warning&quot;</code>，指示诊断严重性。 <code>error</code> 的存在会导致 Terraform 认为配置无效，而 <code>warning</code> 只是对用户的建议或警告，不会阻止代码运行。Terraform 的后续版本可能会引入新的严重性等级，因此解析错误信息时应该准备好接受并忽略他们不了解的 <code>severity</code> 值。</li>
<li><code>summary</code>（string）：诊断报告的问题性质的简短描述。</li>
</ul>
<p>在 Terraform 易于阅读的的诊断消息中，<code>summary</code> 充当诊断的一种“标题”，打印在 “Error:” 或 “Warning:” 指示符之后。</p>
<p>摘要通常是简短的单个句子，但如果返回错误的子系统并没有设计成返回全面的诊断信息时，就只能把整个错误信息作为摘要返回，导致较长的摘要。这种情况下，摘要可能包含换行符，渲染摘要信息时需要注意。</p>
<ul>
<li><code>detail</code>（string）：可选的附加消息，提供有关问题的更多详细信息。</li>
</ul>
<p>在 Terraform 易于阅读的的诊断消息中，详细信息提供了标题和源位置引用之后出现的文本段落。</p>
<p>详细消息通常是多个段落，并且可能散布有非段落行，因此旨在向用户呈现详细消息的工具应该区分没有前导空格的行，将它们视为段落，以及有前导空格的行，将它们视为预格式化文本。然后，渲染器应该对段落进行软换行以适合渲染容器的宽度，但保留预格式化的行不换行。</p>
<p>一些 Terraform 详细消息包含使用 ASCII 字符来标记项目符号的近似项目符号列表。这不是官方承诺，因此渲染器应避免依赖它，而应将这些行视为段落或预格式化文本。此格式的未来版本可能会为其他文本约定定义附加规则，但将保持向后兼容性。</p>
<ul>
<li><code>range</code>（对象）：引用与诊断消息相关的配置源代码的一部分的可选对象。对于错误，这通常指示被检测为无效的特定块头、属性或表达式的边界。</li>
</ul>
<p>源范围是一个具有 <code>filename</code> 属性的对象，该 <code>filename</code> 为当前工作目录的相对路径，然后两个属性 <code>start</code> 和 <code>end</code> 本身都是描述源位置的对象，如下所述。</p>
<p>并非所有诊断消息都与配置的特定部分相关，因此对于不相关的诊断消息，<code>range</code> 将被省略或为 <code>null</code>。</p>
<p><code>snippet</code>（对象）：可选对象，包括与诊断消息相关的配置源代码的摘录。</p>
<p><code>snippet</code> 信息包括了：</p>
<ul>
<li><code>context</code>（string）：诊断的根上下文的可选摘要。例如，这可能是包含触发诊断的表达式的 <code>resource</code> 块。对于某些诊断，此信息不可用，并且此属性将为空。</li>
<li><code>code</code>（string）：Terraform 配置的片段，包括诊断源。可能包含多行，并且可能包括触发诊断的表达式周围的附加配置源代码。</li>
<li><code>start_line</code>（number）：从一开始的行计数，表示源文件中代码摘录开始的位置。该值不一定与 <code>range.start.line</code> 相同，因为 <code>code</code> 可能在诊断源之前包含一行或多行上下文。</li>
<li><code>highlight_start_offset</code>（number）：代码字符串中从零开始的字符偏移量，指向触发诊断的表达式的开头。</li>
<li><code>highlight_end_offset</code>（number）：代码字符串中从零开始的字符偏移量，指向触发诊断的表达式的末尾。</li>
<li><code>values</code>（对象数组）：包含零个或多个表达式值，帮助我们理解复杂表达式中的诊断来源。这些表达式值对象如下所述。</li>
</ul>
<h3 id="1-7-20-1-2-1-源位置（Source-Position）"><a href="#%E6%BA%90%E4%BD%8D%E7%BD%AE%EF%BC%88source-position%EF%BC%89"></a>1.7.20.1.2.1. 源位置（Source Position）</h3>
<p>在诊断对象的 <code>range</code> 属性中源位置对象具有以下属性：</p>
<ul>
<li><code>byte</code>（number）：指定文件中从零开始的字节偏移量。</li>
<li><code>line</code>（number）：从一开始的行计数，指向文件中相关位置的行。</li>
<li><code>column</code>（number）：从一开始的列计数，指向 <code>line</code> 对应的行开头开始的 Unicode 字符计数位置。 <code>start</code> 位置是包含的（数学的 <code>[]</code>），而 <code>end</code> 位置是不包含的（数学的 <code>()</code>）。用于特定错误消息的确切位置仅供人类解读。</li>
</ul>
<h3 id="1-7-20-1-2-2-表达式值"><a href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%80%BC"></a>1.7.20.1.2.2. 表达式值</h3>
<p>表达式值对象提供有关触发诊断的表达式一部分的值的附加信息。当使用 <code>for_each</code> 或类似结构时，这特别有用，以便准确识别哪些值导致错误。该对象有两个属性：</p>
<ul>
<li>
<p><code>traversal</code> (string)：类似 HCL 的可遍历表达式字符串，例如 <code>var.instance_count</code>。复杂的索引键值可能会被省略，因此该属性并非总是合法、可解析的 HCL。该字符串的内容旨在便于人类阅读。</p>
</li>
<li>
<p><code>statement</code>（string）：一个简短的英语片段，描述触发诊断时表达式的值。该字符串的内容旨在便于人类阅读，并且在 Terraform 的未来版本中可能会发生变化。</p>
</li>
<li>
<p><a href="#untaint"><strong>1.7.21.1.</strong> untaint</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.21.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#untaint"></a></p>
<h2 id="1-7-21-1-untaint"><a href="#untaint"></a>1.7.21.1. untaint</h2>
<p>Terraform 有一个名为“tainted”的标记，用于跟踪可能损坏的对象，该命令已被废弃，应使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/19.taint.html#%E6%8E%A8%E8%8D%90%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%B3%95"><code>terraform apply -replace</code> 代替</a>。</p>
<p>如果创建一个资源的操作由多个步骤组成，操作期间其中之一的操作发生错误，Terraform 会自动将对象标记为“受污染”，因为 Terraform 无法确定该对象是否处于完整功能状态。</p>
<p><code>terraform untaint</code> 命令可以手动清除一个 Terraform 管理的资源对象上的污点，恢复它在状态文件中的状态。它是 <code>terraform taint</code> 的逆向操作。</p>
<p>该命令不会修改实际的基础设施资源，只会在资源文件中清除资源对象上的污点标记。</p>
<p>如果我们从对象中删除污点标记，但后来发现它还是损坏了，则可以使用如下命令创建并应用一个计划来替换受损的资源对象，而无需首先重新在该对象上标记污点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply -replace=<span class="string">&quot;aws_instance.example[0]&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-7-21-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.21.1.1. 用法</h2>
<p><code>terraform untaint [options] address</code></p>
<p>name参数是要清除污点的资源的资源名称。<a target="_blank" rel="noopener" href="http://xn--TYPE-uh5f160avsuivle8ft43b9e3c.NAME">该参数的格式为TYPE.NAME</a>，比如aws_instance.foo。</p>
<p>可以使用如下可选参数：</p>
<ul>
<li><code>-allow-missing</code>：如果声明该参数，那么即使资源不存在，命令也会返回成功(状态码0)。对于其他异常情况，该命令可能仍会返回错误，例如读取或写入状态时出现问题。</li>
<li><code>-lock=false</code>：执行时是否先锁定状态文件。如果其他人可能同时对同一工作区运行命令，则这是危险的。</li>
<li><code>-lock-timeout=DURATION</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则命令 Terraform 为上锁操作设置一个超时时长。持续时间语法是一个数字后跟一个时间单位字母，例如“3s”表示三秒。</li>
<li><code>-no-color</code>：关闭彩色输出。在无法解释输出色彩的终端中运行 Terraform 时请使用此参数。</li>
</ul>
<p>以下是使用 <code>local</code> Backend 时可用的遗留参数：</p>
<ul>
<li>
<p><code>-backup=FILENAME</code>：指定源状态文件的备份地址，默认为源状态文件加上&quot;.backup&quot;后缀</p>
</li>
<li>
<p><code>-bakcup-out=FILENAME</code>：指定目标状态文件的备份地址，默认为目标状态文件加上&quot;.backup&quot;后缀</p>
</li>
<li>
<p><code>-state=FILENAME</code>：源状态文件地址，默认为当前 Backend 或是&quot;terraform.tfstate&quot;</p>
</li>
<li>
<p><code>-state-out=FILENAME</code>：目标状态文件地址。如果不指定则使用源状态文件。可以是一个已经存在的文件或新建一个文件</p>
</li>
<li>
<p><a href="#workspace"><strong>1.7.22.1.</strong> workspace</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.22.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#workspace"></a></p>
<h2 id="1-7-22-1-workspace"><a href="#workspace"></a>1.7.22.1. workspace</h2>
<p><code>terraform workspace</code> 命令可以用来管理当前使用的工作区。我们在状态管理章节中介绍过<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/2.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86.html#%E7%8A%B6%E6%80%81%E7%9A%84%E9%9A%94%E7%A6%BB%E5%AD%98%E5%82%A8">工作区</a>的概念。</p>
<p>该命令包含一系列子命令，我们将会一一介绍。</p>
<h2 id="1-7-22-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.22.1.1. 用法</h2>
<p><code>terraform workspace &lt;subcommand&gt; [options] [args]</code></p>
<ul>
<li>
<p><a href="#list"><strong>1.7.22.1.1.</strong> list</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.22.1.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#list"></a></p>
<h2 id="1-7-22-1-1-list"><a href="#list"></a>1.7.22.1.1. list</h2>
<p><code>terraform workspace list</code> 命令列出当前存在的工作区。</p>
<h2 id="1-7-22-1-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.22.1.1.1. 用法</h2>
<p><code>terraform workspace list [DIR]</code></p>
<p>该命令会打印出存在的工作区。当前工作会使用 <code>*</code> 号标记：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace list</span><br><span class="line">  default</span><br><span class="line">* development</span><br><span class="line">  jsmith-test</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#select"><strong>1.7.22.2.1.</strong> select</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.22.2.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#select"></a></p>
<h2 id="1-7-22-2-1-select"><a href="#select"></a>1.7.22.2.1. select</h2>
<p><code>terraform workspace select</code> 命令用来选择使用的工作区。</p>
<h2 id="1-7-22-2-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.22.2.1.1. 用法</h2>
<p><code>terraform workspace select NAME [DIR]</code></p>
<p>NAME 指定的工作区必须已经存在：</p>
<p>该命令支持以下参数</p>
<ul>
<li><code>-or-create</code>：如果指定的工作区不存在，则创建之。默认为 <code>false</code>。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace list</span><br><span class="line">  default</span><br><span class="line">* development</span><br><span class="line">  jsmith-test</span><br><span class="line"></span><br><span class="line">$ terraform workspace <span class="keyword">select</span> default</span><br><span class="line">Switched to workspace <span class="string">&quot;default&quot;</span>.</span><br></pre></td></tr></table></figure>
<h2 id="new"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">new</a></h2>
<ul>
<li>
<p><a href="#new"><strong>1.7.22.3.1.</strong> new</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.22.3.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#new"></a></p>
<h2 id="1-7-22-3-1-new"><a href="#new"></a>1.7.22.3.1. new</h2>
<p><code>terraform workspace new</code> 命令用来创建新的工作区。</p>
<h2 id="1-7-22-3-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.22.3.1.1. 用法</h2>
<p><code>terraform workspace new [OPTIONS] NAME [DIR]</code></p>
<p>该命令使用给定名字创建一个新的工作区。不可存在同名工作区。</p>
<p>如果使用了 <code>-state</code> 参数，那么给定路径的状态文件会被拷贝到新工作区。</p>
<p>该命令支持以下可选参数：</p>
<ul>
<li><code>-lock=false</code>：执行时是否先锁定状态文件。如果其他人可能同时对同一工作区运行命令，则这是危险的。</li>
<li><code>-lock-timeout=DURATION</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则命令 Terraform 为上锁操作设置一个超时时长。持续时间语法是一个数字后跟一个时间单位字母，例如“3s”表示三秒。默认为 <code>0s</code>。</li>
<li><code>-state=path</code>：用来初始化新环境所使用的状态文件路径</li>
</ul>
<p>创建新工作区：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace new example</span><br><span class="line">Created and switched to workspace <span class="string">&quot;example&quot;</span>!</span><br><span class="line"></span><br><span class="line">You<span class="string">&#x27;re now on a new, empty workspace. Workspaces isolate their state,</span></span><br><span class="line"><span class="string">so if you run &quot;terraform plan&quot; Terraform will not see any existing state</span></span><br><span class="line"><span class="string">for this configuration.</span></span><br></pre></td></tr></table></figure>
<p>使用状态文件创建新工作区：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace new -state=old.terraform.tfstate example</span><br><span class="line">Created and switched to workspace <span class="string">&quot;example&quot;</span>.</span><br><span class="line"></span><br><span class="line">You<span class="string">&#x27;re now on a new, empty workspace. Workspaces isolate their state,</span></span><br><span class="line"><span class="string">so if you run &quot;terraform plan&quot; Terraform will not see any existing state</span></span><br><span class="line"><span class="string">for this configuration.</span></span><br></pre></td></tr></table></figure>
<h2 id="delete"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">delete</a></h2>
<ul>
<li>
<p><a href="#delete"><strong>1.7.22.4.1.</strong> delete</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.22.4.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#delete"></a></p>
<h2 id="1-7-22-4-1-delete"><a href="#delete"></a>1.7.22.4.1. delete</h2>
<p><code>terraform workspace delete</code> 命令被用以删除已经存在的工作区。</p>
<h2 id="1-7-22-4-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.22.4.1.1. 用法</h2>
<p><code>terraform workspace delete [OPTIONS] NAME [DIR]</code></p>
<p>该命令被用以删除已经存在的工作区。</p>
<p>被删除的工作区必须已经存在，并且<strong>不可以删除当前正在使用的工作区</strong>。如果工作区状态不是空的（存在跟踪中的远程对象），Terraform 会禁止删除，除非声明 <code>-force</code> 参数。</p>
<p>另外，不同的 Backend 在没有 <code>-force</code> 参数时可能会有不同的限制，以实现对工作区的安全删除，例如检查工作区是否已上锁。</p>
<p>如果使用 <code>-force</code> 删除非空工作区，那么原本跟踪的资源的状态就将处于&quot;dangling&quot;，也就是实际基础设施资源仍然存在，但脱离了 Terraform的 管理。有时我们希望这样，只是希望当前 Terraform 项目不再管理这些资源，交由其他项目管理。但大多数情况下并非这样，所以 Terraform 默认会禁止删除非空工作区。</p>
<p>该命令可以使用如下可选参数：</p>
<ul>
<li><code>-force</code>：删除含有非空状态文件的工作区。默认为 <code>false</code>。</li>
<li><code>-lock=false</code>：执行时是否先锁定状态文件。如果其他人可能同时对同一工作区运行命令，则这是危险的。</li>
<li><code>-lock-timeout=DURATION</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则命令 Terraform 为上锁操作设置一个超时时长。持续时间语法是一个数字后跟一个时间单位字母，例如“3s”表示三秒。默认为 <code>0s</code>。</li>
</ul>
<p>例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace delete example</span><br><span class="line">Deleted workspace <span class="string">&quot;example&quot;</span>.</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#show"><strong>1.7.22.5.1.</strong> show</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.22.5.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#show"></a></p>
<h2 id="1-7-22-5-1-show"><a href="#show"></a>1.7.22.5.1. show</h2>
<p><code>terraform workspace show</code> 命令被用以输出当前使用的工作区。</p>
<h2 id="1-7-22-5-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.22.5.1.1. 用法</h2>
<p><code>terraform workspace show</code></p>
<p>例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace show</span><br><span class="line">development</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#test"><strong>1.7.23.1.</strong> test</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.23.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E4%B8%80%E8%88%AC%E5%8F%82%E6%95%B0"><strong>1.7.23.1.2.</strong> 一般参数</a></p>
</li>
<li>
<p><a href="#%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><strong>1.7.23.1.3.</strong> 状态管理</a></p>
</li>
<li>
<p><a href="#terraform-%E6%B5%8B%E8%AF%95%E6%B8%85%E7%90%86"><strong>1.7.23.1.3.1.</strong> Terraform 测试清理</a></p>
</li>
<li>
<p><a href="#%E5%9C%A8-hcp-terraform-%E4%B8%8A%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><strong>1.7.23.1.4.</strong> 在 HCP Terraform 上运行测试</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%B5%8B%E8%AF%95%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E4%B8%8E%E5%91%BD%E4%BB%A4"><strong>1.7.23.1.5.</strong> 例子：测试的目录结构与命令</a></p>
</li>
<li>
<p><a href="#%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%B5%8B%E8%AF%95%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><strong>1.7.23.1.5.1.</strong> 另一种测试目录结构</a></p>
</li>
</ul>
<p><a href="#test"></a></p>
<h2 id="1-7-23-1-test"><a href="#test"></a>1.7.23.1. test</h2>
<p><code>terraform test</code> 命令读取 Terraform 测试文件并执行其中的测试。</p>
<p><code>test</code> 命令和测试文件对于想要验证和测试其旨在被复用的模块的作者特别有用。我们也可以使用 <code>test</code> 命令来验证根模块。</p>
<h2 id="1-7-23-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.23.1.1. 用法</h2>
<p><code>terraform test [options]</code></p>
<p>该命令在当前目录和指定的测试目录（默认情况下是 <code>test</code> 目录）中搜索所有 Terraform 测试文件，并执行指定的测试。有关测试文件的更多详细信息，请参阅<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/">测试</a>。</p>
<p>Terraform 然后会根据测试文件的规范执行一系列 Terraform 的 <code>plan</code> 或 <code>apply</code> 命令，并根据测试文件的规范验证相关计划和状态文件。</p>
<p>警告：Terraform 测试命令可以创建真正的基础设施，但可能会产生成本。请参阅 <a href="#terraform-%E6%B5%8B%E8%AF%95%E6%B8%85%E7%90%86">Terraform 测试清理</a>部分，了解确保创建的基础设施被清理的最佳实践。</p>
<h2 id="1-7-23-1-2-一般参数"><a href="#%E4%B8%80%E8%88%AC%E5%8F%82%E6%95%B0"></a>1.7.23.1.2. 一般参数</h2>
<p>Terraform <code>test</code> 命令支持以下参数：</p>
<ul>
<li><code>-cloud-run=&lt;module source&gt;</code> - 通过 HCP Terraform 远程运行针对指定的 Terraform 私有注册表模块的测试。</li>
<li><code>-filter=testfile</code> - 将 <code>terraform test</code> 操作限制为指定的测试文件。</li>
<li><code>-json</code> - 显示测试结果的机器可读 JSON 输出。</li>
<li><code>-test-directory=&lt;relative directory&gt;</code> - 指定 Terraform 查找测试文件的目录。请注意，Terraform 始终在主代码目录中加载测试文件。默认的测试目录是 <code>tests</code>。</li>
<li><code>-verbose</code> - 根据每个运行块的 <code>command</code> 属性打印出测试文件中每个 <code>run</code> 块的计划或状态。</li>
</ul>
<h2 id="1-7-23-1-3-状态管理"><a href="#%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"></a>1.7.23.1.3. 状态管理</h2>
<p>每个 Terraform 测试文件在执行时都会在内存中从无到有地维护所需的所有 Terraform 状态。该状态完全独立于被测代码的任何现有状态，因此您可以安全地执行 Terraform 测试命令，而不会影响任何已存在的基础设施。</p>
<h3 id="1-7-23-1-3-1-Terraform-测试清理"><a href="#terraform-%E6%B5%8B%E8%AF%95%E6%B8%85%E7%90%86"></a>1.7.23.1.3.1. Terraform 测试清理</h3>
<p>Terraform <code>test</code> 命令可以创建真实的基础设施。一旦 Terraform 完全执行了所有测试文件，Terraform 就会尝试销毁所有遗留的基础设施。如果无法销毁，Terraform 会报告由它创建但无法销毁的资源列表。</p>
<p>我们应该密切监视测试命令的输出，以确保 Terraform 清理了它创建的基础设施，否则需要执行手动清理。我们建议为目标 Provider 创建专用的测试帐户，这样可以定期安全地清除该帐户内的资源，确保不会意外地留下昂贵的资源。</p>
<p>Terraform 还提供诊断，解释为什么它无法自动清理。我们应该检查这些诊断，以确保未来的清理操作成功。</p>
<h2 id="1-7-23-1-4-在-HCP-Terraform-上运行测试"><a href="#%E5%9C%A8-hcp-terraform-%E4%B8%8A%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"></a>1.7.23.1.4. 在 HCP Terraform 上运行测试</h2>
<p>我们可以使用 <code>-cloud-run</code> 参数在 HCP Terraform 上远程执行测试。</p>
<p><code>-cloud-run</code> 参数接受私有注册表模块地址。此参数针对 HCP Terraform 用户界面中指定的私有模块运行测试。</p>
<p>我们必须提供来自私有注册表的模块，而不是公共 Terraform 注册表。</p>
<p>在使用该参数之前，您必须执行 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/commands/login"><code>terraform login</code></a>，并确保您的 <code>host</code> 参数与目标模块的私有注册表主机名匹配。</p>
<h2 id="1-7-23-1-5-例子：测试的目录结构与命令"><a href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%B5%8B%E8%AF%95%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E4%B8%8E%E5%91%BD%E4%BB%A4"></a>1.7.23.1.5. 例子：测试的目录结构与命令</h2>
<p>以下目录结构表示包含测试和配置（setup）模块的 Terraform 模块的示例目录树：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">|-- main.tf</span><br><span class="line">|-- outputs.tf</span><br><span class="line">|-- terraform.tf</span><br><span class="line">|-- variables.tf</span><br><span class="line">|-- tests/</span><br><span class="line">|   |-- validations.tftest.hcl</span><br><span class="line">|   |-- outputs.tftest.hcl</span><br><span class="line">|-- testing/</span><br><span class="line">    |-- setup/</span><br><span class="line">        |-- main.tf</span><br><span class="line">        |-- outputs.tf</span><br><span class="line">        |-- terraform.tf</span><br><span class="line">        |-- variables.tf</span><br></pre></td></tr></table></figure>
<p>在项目的根目录下，有一些典型的 Terraform 配置文件：<code>main.tf</code>、<code>outputs.tf</code>、<code>terraform.tf</code> 和 <code>variables.tf</code>。测试文件 <code>validations.tftest.hcl</code> 和 <code>outputs.tftest.hcl</code> 位于默认测试目录 <code>tests</code> 中。</p>
<p>另外 <code>testing</code> 目录下有一个为测试而存在的<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/#module-%E5%9D%97">设置(setup)模块</a></p>
<p>要执行测试，我们应该从代码根目录运行 <code>terraform test</code>，如同运行 <code>terraform plan</code> 或 <code>terraform apply</code> 一样。尽管实际的测试文件位于内嵌的 <code>tests</code> 目录中，但 Terraform 仍从主代码目录执行。</p>
<p>可以使用 <code>-filter</code> 参数指定执行特定的测试文件。</p>
<p>Linux、Mac 操作系统和 UNIX 下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform <span class="built_in">test</span> -filter=tests/validations.tftest.hcl</span><br></pre></td></tr></table></figure>
<p>PowerShell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform <span class="built_in">test</span> -filter=<span class="string">&#x27;tests\validations.tftest.hcl&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Windows <code>cmd.exe</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform <span class="built_in">test</span> -filter=tests\validations.tftest.hcl</span><br></pre></td></tr></table></figure>
<h3 id="1-7-23-1-5-1-另一种测试目录结构"><a href="#%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%B5%8B%E8%AF%95%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"></a>1.7.23.1.5.1. 另一种测试目录结构</h3>
<p>在上面的示例中，测试文件位于默认的 <code>tests</code> 目录中。测试文件也可以直接包含在主代码目录中：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">|-- main.tf</span><br><span class="line">|-- outputs.tf</span><br><span class="line">|-- terraform.tf</span><br><span class="line">|-- variables.tf</span><br><span class="line">|-- validations.tftest.hcl</span><br><span class="line">|-- outputs.tftest.hcl</span><br><span class="line">|-- testing/</span><br><span class="line">    |-- setup/</span><br><span class="line">        |-- main.tf</span><br><span class="line">        |-- outputs.tf</span><br><span class="line">        |-- terraform.tf</span><br><span class="line">        |-- variables.tf</span><br></pre></td></tr></table></figure>
<p>测试文件的位置不会影响 <code>terraform test</code> 的运行。测试文件的所有引用以及其中的绝对文件路径都应相对于主代码目录。</p>
<p>我们还可以使用 <code>-test-directory</code> 参数来更改测试文件的位置。例如， <code>terraform test -test-directory=testing</code> 将命令 Terraform 从 <code>testing</code> 目录加载测试，而不是 <code>tests</code>。</p>
<p>测试目录必须位于主代码目录下，但可以多层嵌套。</p>
<blockquote>
<p>注意：无论 <code>-test-directory</code> 的值为何，根代码目录中的测试文件始终会被加载。</p>
</blockquote>
<p>我们不建议更改默认测试目录。这些自定义选项是为那些在 <code>terraform test</code> 功能发布之前可能已在其代码中包含了 <code>tests</code> 子模块的代码作者准备的。一般来说，应始终使用默认的 <code>tests</code> 目录。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2023/01/28/Teraform/Terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C2/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2023/01/26/Teraform/Terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C1/"
                            aria-label=": Terraform-命令行1"
                        >
                            Terraform-命令行1
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-01-26T17:43:45+08:00">
	
		    2023 年 1 月 26 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="Terraform/">Terraform</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <ul>
<li>
<p><a href="#terraform%E5%91%BD%E4%BB%A4%E8%A1%8C"><strong>1.7.1.</strong> Terraform命令行</a></p>
</li>
<li>
<p><a href="#%E9%80%9A%E8%BF%87--chdir-%E5%8F%82%E6%95%B0%E5%88%87%E6%8D%A2%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><strong>1.7.1.1.</strong> 通过 -chdir 参数切换工作目录</a></p>
</li>
<li>
<p><a href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><strong>1.7.1.2.</strong> 自动补全</a></p>
</li>
<li>
<p><a href="#%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><strong>1.7.1.3.</strong> 版本信息</a></p>
</li>
<li>
<p><a href="#checkpoint%E6%9C%8D%E5%8A%A1"><strong>1.7.1.4.</strong> Checkpoint服务</a></p>
</li>
</ul>
<p><a href="#terraform%E5%91%BD%E4%BB%A4%E8%A1%8C"></a></p>
<h2 id="1-7-1-Terraform命令行"><a href="#terraform%E5%91%BD%E4%BB%A4%E8%A1%8C"></a>1.7.1. Terraform命令行</h2>
<p>我们在前面的的章节中主要介绍了如何书写和组织Terraform代码，下面我们要介绍一下如何使用Terraform命令行工具来应用这些代码，并且管理和操作我们的云端基础设施。</p>
<p>Terraform是用Go语言编写的，所以它的交付物只有一个可执行命令行文件：terraform。在Terraform执行发生错误时，terraform进程会返回一个非零值，所以在脚本代码中我们可以轻松判断执行是否成功。</p>
<p>我们可以在命令行中输入terraform来查看所有可用的子命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ terraform</span><br><span class="line">Usage: terraform [-version] [-<span class="built_in">help</span>] &lt;<span class="built_in">command</span>&gt; [args]</span><br><span class="line"></span><br><span class="line">The available commands <span class="keyword">for</span> execution are listed below.</span><br><span class="line">The most common, useful commands are shown first, followed by</span><br><span class="line">less common or more advanced commands. If you<span class="string">&#x27;re just getting</span></span><br><span class="line"><span class="string">started with Terraform, stick with the common commands. For the</span></span><br><span class="line"><span class="string">other commands, please read the help and docs before usage.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Common commands:</span></span><br><span class="line"><span class="string">    apply              Builds or changes infrastructure</span></span><br><span class="line"><span class="string">    console            Interactive console for Terraform interpolations</span></span><br><span class="line"><span class="string">    destroy            Destroy Terraform-managed infrastructure</span></span><br><span class="line"><span class="string">    env                Workspace management</span></span><br><span class="line"><span class="string">    fmt                Rewrites config files to canonical format</span></span><br><span class="line"><span class="string">    get                Download and install modules for the configuration</span></span><br><span class="line"><span class="string">    graph              Create a visual graph of Terraform resources</span></span><br><span class="line"><span class="string">    import             Import existing infrastructure into Terraform</span></span><br><span class="line"><span class="string">    init               Initialize a Terraform working directory</span></span><br><span class="line"><span class="string">    login              Obtain and save credentials for a remote host</span></span><br><span class="line"><span class="string">    logout             Remove locally-stored credentials for a remote host</span></span><br><span class="line"><span class="string">    output             Read an output from a state file</span></span><br><span class="line"><span class="string">    plan               Generate and show an execution plan</span></span><br><span class="line"><span class="string">    providers          Prints a tree of the providers used in the configuration</span></span><br><span class="line"><span class="string">    refresh            Update local state file against real resources</span></span><br><span class="line"><span class="string">    show               Inspect Terraform state or plan</span></span><br><span class="line"><span class="string">    taint              Manually mark a resource for recreation</span></span><br><span class="line"><span class="string">    untaint            Manually unmark a resource as tainted</span></span><br><span class="line"><span class="string">    validate           Validates the Terraform files</span></span><br><span class="line"><span class="string">    version            Prints the Terraform version</span></span><br><span class="line"><span class="string">    workspace          Workspace management</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">All other commands:</span></span><br><span class="line"><span class="string">    0.12upgrade        Rewrites pre-0.12 module source code for v0.12</span></span><br><span class="line"><span class="string">    0.13upgrade        Rewrites pre-0.13 module source code for v0.13</span></span><br><span class="line"><span class="string">    debug              Debug output management (experimental)</span></span><br><span class="line"><span class="string">    force-unlock       Manually unlock the terraform state</span></span><br><span class="line"><span class="string">    push               Obsolete command for Terraform Enterprise legacy (v1)</span></span><br><span class="line"><span class="string">    state              Advanced state management</span></span><br></pre></td></tr></table></figure>
<h2 id="1-7-1-1-通过-chdir-参数切换工作目录"><a href="#%E9%80%9A%E8%BF%87--chdir-%E5%8F%82%E6%95%B0%E5%88%87%E6%8D%A2%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"></a>1.7.1.1. 通过 -chdir 参数切换工作目录</h2>
<p>运行Terraform时一般要首先切换当前工作目录到包含有想要执行的根模块<code>.tf</code>代码文件的目录下（比如使用<code>cd</code>命令），这样Terraform才能够自动发现要执行的代码文件以及参数文件。</p>
<p>在某些情况下——尤其是将Terraform封装进某些自动化脚本时，如果能够从其他路径直接执行特定路径下的根模块代码将会十分的方便。为了达到这一目的，Terraform目前支持一个全局参数<code>-chdir=...</code>，你可以在任意子命令的参数中使用该参数指定要执行的代码路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">terraform -<span class="built_in">chdir</span>=environments/production apply</span></span><br></pre></td></tr></table></figure>
<p><code>-chdir</code>参数指引Terraform在执行具体子命令之前切换工作目录，这意味着使用该参数后Terraform将会在指定路径下读写文件，而非当前工作目录下的文件。</p>
<p>在两种场景下Terraform会坚持使用<strong>当前工作目录而非指定的目录</strong>，即使是我们通过<code>-chdir</code>指定了一个目标路径：</p>
<ul>
<li>Terraform处理命令行配置文件中的设置而非执行某个具体的子命令时，该阶段发生在解析<code>-chdir</code>参数之前</li>
<li>如果你需要使用当前工作目录下的文件作为你配置的一部分时，你可以通过在代码中使用<code>path.cwd</code>变量获得对当前工作路径的引用，而不是<code>-chdir</code>所指定的路径。可以通过使用<code>path.root</code>来获取代表根模块所在的路径。</li>
</ul>
<h2 id="1-7-1-2-自动补全"><a href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"></a>1.7.1.2. 自动补全</h2>
<p>如果你使用的是bash或是zsh，那么可以轻松安装自动补全：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform -install-autocomplete</span><br></pre></td></tr></table></figure>
<p>卸载自动补全也很容易：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform -uninstall-autocomplete</span><br></pre></td></tr></table></figure>
<p>目前自动补全并没有覆盖到所有子命令。</p>
<h2 id="1-7-1-3-版本信息"><a href="#%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"></a>1.7.1.3. 版本信息</h2>
<p>Terraform命令行会与HashiCorp的<a target="_blank" rel="noopener" href="https://checkpoint.hashicorp.com/">Checkpoint</a>服务交互来检查当前版本是否有更新或是关键的安全公告。</p>
<p>可以通过执行terraform version命令来检查是否有新版本可用。</p>
<h2 id="1-7-1-4-Checkpoint服务"><a href="#checkpoint%E6%9C%8D%E5%8A%A1"></a>1.7.1.4. Checkpoint服务</h2>
<p>Terraform会收集一些不涉及用户身份信息或是主机信息的数据发送给Checkpoint服务。一个匿名ID会被发送到Checkpoint来消除重复的告警信息。我们可以关闭与Checkpoint的交互。</p>
<p>我们可以设置CHECKPOINT_DISABLE环境变量的值为任意非空值来完全关闭HashiCorp所有产品与Checkpoint的交互。另外，我们也可以通过设置命令行配置文件来关闭这些功能：</p>
<ul>
<li>
<p>disable_checkpoint：设置为true可以完全关闭与Checkpoint的交互</p>
</li>
<li>
<p>disable_checkpoint_signature：设置为true可以阻止向Checkpoint发送匿名ID</p>
</li>
<li>
<p><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6terraformrc-%E6%88%96-terraformrc"><strong>1.7.1.1.</strong> 命令行配置文件(.terraformrc 或 terraform.rc)</a></p>
</li>
<li>
<p><a href="#%E4%BD%8D%E7%BD%AE"><strong>1.7.1.1.1.</strong> 位置</a></p>
</li>
<li>
<p><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%AD%E6%B3%95"><strong>1.7.1.1.2.</strong> 配置文件语法</a></p>
</li>
<li>
<p><a href="#%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"><strong>1.7.1.1.3.</strong> 可用配置</a></p>
</li>
<li>
<p><a href="#provider-%E7%9A%84%E5%AE%89%E8%A3%85"><strong>1.7.1.1.4.</strong> Provider 的安装</a></p>
</li>
<li>
<p><a href="#%E6%98%BE%E5%BC%8F%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E9%85%8D%E7%BD%AE"><strong>1.7.1.1.4.1.</strong> 显式安装方法配置</a></p>
</li>
<li>
<p><a href="#%E9%9A%90%E5%BC%8F%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E7%9B%AE%E5%BD%95"><strong>1.7.1.1.5.</strong> 隐式的本地镜像目录</a></p>
</li>
<li>
<p><a href="#provider-%E6%8F%92%E4%BB%B6%E7%BC%93%E5%AD%98"><strong>1.7.1.1.6.</strong> Provider 插件缓存</a></p>
</li>
<li>
<p><a href="#%E5%85%81%E8%AE%B8-provider-%E7%BC%93%E5%AD%98%E8%B7%B3%E8%BF%87%E4%BE%9D%E8%B5%96%E9%94%81%E6%96%87%E4%BB%B6%E6%A3%80%E6%9F%A5"><strong>1.7.1.1.7.</strong> 允许 Provider 缓存跳过依赖锁文件检查</a></p>
</li>
</ul>
<p><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6terraformrc-%E6%88%96-terraformrc"></a></p>
<h2 id="1-7-1-1-命令行配置文件-terraformrc-或-terraform-rc"><a href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6terraformrc-%E6%88%96-terraformrc"></a>1.7.1.1. 命令行配置文件(.terraformrc 或 terraform.rc)</h2>
<p>命令行配置文件为每个用户配置了命令行的行为，适用于所有的 Terraform 工作目录，这与我们编写的 Terraform 代码是分开的。</p>
<h2 id="1-7-1-1-1-位置"><a href="#%E4%BD%8D%E7%BD%AE"></a>1.7.1.1.1. 位置</h2>
<p>配置文件的位置取决于用户使用的操作系统：</p>
<ul>
<li>Windows 平台上，文件名必须是 <code>terraform.rc</code>，位置必须在相关用户的 <code>%APPDATA%</code> 目录下。这个目录的物理路径取决于 Windows 的版本以及系统配置；在 PowerShell 中查看 <code>$env:APPDATA</code> 可以找到对应的路径</li>
<li>在其他操作系统上，文件名必须是 <code>.terraformrc</code>(注意第一个是 <code>.</code>)，位置必须是在相关用户的 <code>HOME</code> 目录</li>
</ul>
<p>在 Windows 上创建配置文件时，要注意 Windows Explorer 默认隐藏文件扩展名的行为。Terraform 不会把 <code>terraform.rc.txt</code> 文件识别为命令行配置文件，而默认情况下 Windows Explorer 会将它的文件名显示为 <code>terraform.rc</code> (隐藏了扩展名的缘故)。可以在 PowerShell 或命令行中使用 <code>dir</code> 命令来确认文件名。</p>
<p>可以通过设置 <code>TF_CLI_CONFIG_FILE</code> 环境变量的方式来修改配置文件的位置。</p>
<h2 id="1-7-1-1-2-配置文件语法"><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%AD%E6%B3%95"></a>1.7.1.1.2. 配置文件语法</h2>
<p>配置文件本身如同 <code>.tf</code> 文件那样也采用HCL语法，但使用不同的属性和块。以下是常见语法的演示，后续的部分会详细介绍这些配置项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plugin_cache_dir   = &quot;$HOME/.terraform.d/plugin-cache&quot;</span><br><span class="line">disable_checkpoint = true</span><br></pre></td></tr></table></figure>
<h2 id="1-7-1-1-3-可用配置"><a href="#%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"></a>1.7.1.1.3. 可用配置</h2>
<p>命令行配置文件中可以设置的配置项有：</p>
<ul>
<li><code>credentials</code>：使用 Terraform Cloud 服务或 Terraform 企业版时使用的凭据</li>
<li><code>credentials_helper</code>：配置一个外部的用于读写 Terraform Cloud 或 Terraform 企业版凭据的帮助程序</li>
<li><code>disable_checkpoint</code>：设置为 <code>true</code> 可以完全关闭与 Checkpoint 的交互</li>
<li><code>disable_checkpoint_signature</code>：设置为 <code>true</code> 可以阻止向 Checkpoint 发送匿名 ID</li>
<li><code>plugin_cache_dir</code>：开启插件缓存，我们在介绍 Provider 的章节中介绍过</li>
<li><code>provider_installation</code>：定制化执行 <code>terraform init</code> 时安装插件的行为</li>
</ul>
<p>鉴于本教程无意涉及与 Terraform Cloud 或企业版相关的部分，所以我们会略过对 credentials 和 credentials_helper 的介绍；插件缓存的相关知识我们在 Provider 章节中已做过介绍，在此先偷懒略过。感兴趣的读者可以自行查阅<a target="_blank" rel="noopener" href="https://www.terraform.io/docs/commands/cli-config.html#credentials-1">相关文档</a></p>
<h2 id="1-7-1-1-4-Provider-的安装"><a href="#provider-%E7%9A%84%E5%AE%89%E8%A3%85"></a>1.7.1.1.4. Provider 的安装</h2>
<p>默认情况下 Terraform 从官方 Provider Registry 下载安装 Provider 插件。Provider 在 Registry 中的原始地址采用类似 <code>registry.terraform.io/hashicorp/aws</code> 的编码规则。通常为了简便，Terraform 允许省略地址中的主机名部分 <code>registry.terraform.io</code>，所以我们可以直接使用地址 <code>hashicorp/aws</code>。</p>
<p>有时无法直接从官方 Registry 下载插件，例如我们要在一个与公网隔离的环境中运行 Terraform 时。为了允许 Terraform 工作在这样的环境下，有一些可选方法允许我们从其他地方获取 Provider 插件。</p>
<h3 id="1-7-1-1-4-1-显式安装方法配置"><a href="#%E6%98%BE%E5%BC%8F%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E9%85%8D%E7%BD%AE"></a>1.7.1.1.4.1. 显式安装方法配置</h3>
<p>可以在命令行配置文件中定义一个 <code>provider_installation</code> 块来修改 Terraform 默认的插件安装行为，命令 Terraform 使用本地的 Registry 镜像服务，或是使用一些用户修改过的插件。</p>
<p>通常 <code>provider_installation</code> 块的结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">provider_installation &#123;</span><br><span class="line">  filesystem_mirror &#123;</span><br><span class="line">    path    = &quot;/usr/share/terraform/providers&quot;</span><br><span class="line">    include = [&quot;example.com/*/*&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">  direct &#123;</span><br><span class="line">    exclude = [&quot;example.com/*/*&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>provider_installation</code> 块中每一个内嵌块都指定了一种安装方式。每一种安装方式都可以同时包含 <code>include</code> 与 <code>exclude</code> 模式来指定安装方式使用的 Provider 类型。在上面的例子里，我们把所有原先位于 <code>example.com</code> 这个 Registry 存储中的 Provider 设置成只能从本地文件系统的 <code>/usr/share/terraform/providers</code> 镜像存储中寻找并安装，而其他的 Provider 只能从它们原先的 Registry 存储下载安装。</p>
<p>如果你为一种安装方式同时设置了 <code>include</code> 与 <code>exclude</code>，那么 <code>exclude</code> 模式将拥有更高的优先级。举例：包含<code>registry.terraform.io/hashicorp/*</code>但排除<code>registry.terraform.io/hashicorp/dns</code>将对所有<code>hashicorp</code>空间下的插件有效，但是<code>hashicorp/dns</code>除外。</p>
<p>和Terraform代码文件中Provider的<code>source</code>属性一样的是，在<code>provider_installation</code>里你也可以省略<code>registry.terraform.io/</code>的前缀，甚至是使用通配符时亦是如此。比如，<code>registry.terraform.io/hashicorp/*</code>和<code>hashicorp/*</code>是等价的；<code>*/*</code>是<code>registry.terraform.io/*/*</code>的缩写，<strong>而不是</strong><code>*/*/*</code>的缩写。</p>
<p>目前支持的安装方式如下：</p>
<ul>
<li><code>direct</code>：要求直接从原始的Registry服务下载。该方法不需要额外参数。</li>
<li><code>filesystem_mirror</code>：一个本地存有 Provider 插件拷贝的目录。该方法需要一个额外的参数 <code>path</code> 来指定存有插件拷贝的目录路径。 Terraform 期待给定路径的目录内通过路径来描述插件的一些元信息。支持一下两种目录结构：
<ul>
<li>打包式布局： <code>HOSTNAME/NAMESPACE/TYPE/terraform-provider-TYPE_VERSION_TARGET.zip</code> 的格式指定了一个从原始 Registry 获取的包含插件的发行版 zip 文件</li>
<li>解压式布局：<code>HOSTNAME/NAMESPACE/TYPE/VERSION/TARGET</code> 式一个包含有 Provider 插件发行版 zip 文件解压缩后内容物的目录 这两种布局下，<code>VERSION</code> 都是代表着插件版本的字符串，比如 <code>2.0.0</code>；<code>TARGET</code> 则指定了插件发行版对应的目标平台，例如 <code>darwin_amd64</code>、<code>linux_arm</code>、<code>windows_amd64</code> 等等。</li>
</ul>
</li>
</ul>
<p>如果使用解压式布局，Terraform 在安装插件时会尝试创建一个到镜像目录的符号连接来避免拷贝文件夹。打包式布局则不会这样做，因为 Terraform 必须在安装插件时解压发行版文件。</p>
<p>你可以指定多个<code>filesystem_mirror</code>块来指定多个不同的目录。</p>
<ul>
<li><code>network_mirror</code>：指定一个 HTTPS 服务地址提供 Provider 插件的拷贝，不论这些插件原先属于哪些 Registry 服务。该方法需要一个额外参数 <code>url</code> 来指定镜像服务的地址，<code>url</code> 地址必须使用 <code>https:</code> 作为前缀，<strong>以斜杠结尾</strong>。 Terraform期待该地址指定的服务实现了 <a target="_blank" rel="noopener" href="https://www.terraform.io/docs/internals/provider-network-mirror-protocol.html">Provider网络镜像协议</a>，这是一种被设计用来托管插件拷贝的网站所需要实现的协议，在此我们不展开讨论。</li>
</ul>
<p><strong>需要特别注意的是，请不要使用不可信的 <code>network_mirror</code> 地址。Terraform 会验证镜像站点的 TLS 证书以确认身份，但一个拥有合法 TLS 证书的镜像站可能会提供包含恶意内容的插件文件。</strong></p>
<ul>
<li><code>dev_overrides</code>：指定使用本地的开发版本插件。有时我们想要对 Provider 代码做一些修改，为了调试本地代码编译后的插件，可以使用 <code>dev_overrides</code> 指定使用本地编译的版本。</li>
</ul>
<p>例如，我们想要调试本地修改过的 UCloud Provider 插件，我们可以从 github 上克隆该项目源代码，修改完代码后，编译一个可执行版本(以Mac OS为例)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ GOOS=darwin GOARCH=arm64 go build -o bin/terraform-provider-ucloud</span><br><span class="line">$ <span class="built_in">chmod</span> +x bin/terraform-provider-ucloud</span><br></pre></td></tr></table></figure>
<p>然后编写如下<code>provider_installation</code>配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">provider_installation&#123;</span><br><span class="line">  dev_overrides &#123;</span><br><span class="line">    &quot;ucloud/ucloud&quot; = &quot;PATH_TO_PROJECT/terraform-provider-ucloud/&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当 Terraform 代码中要求了 <code>source</code> 为 <code>ucloud/ucloud</code> 的 Provider 时，执行 <code>terraform init</code> 仍然会报错，抱怨找不到 <code>ucloud/ucloud</code> 这个 Provider，但执行 <code>terraform plan</code> 或是 <code>terraform apply</code> 等操作时可以顺利执行，此时 Terraform 会使用路径指定的本地 Provider 插件。这种方式比较适合于调试本地 Provider 插件代码。</p>
<p>对于上述的几种插件安装方式，Terraform 会尝试通过 <code>include</code> 和 <code>exclude</code> 模式匹配 Provider，遍历匹配的安装方式，选择一个符合 Terraform 代码中对插件版本约束的最新版本。如果你拥有一个插件的特定版本的本地镜像，并且你希望 Terraform 只使用这个本地镜像，那么你需要移除 <code>direct</code> 安装方式，或是在 <code>direct</code> 中通过<code>exclude</code> 参数排除特定的 Provider。</p>
<h2 id="1-7-1-1-5-隐式的本地镜像目录"><a href="#%E9%9A%90%E5%BC%8F%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E7%9B%AE%E5%BD%95"></a>1.7.1.1.5. 隐式的本地镜像目录</h2>
<p>如果命令行配置文件中没有包含 <code>provider_installation</code> 块，那么 Terraform 会生成一个隐式的配置。该隐式配置包含了一个 <code>filesystem_mirror</code> 方法以及一个 <code>direct</code> 方法。</p>
<p>在不同的操作系统上，Terraform 会选择不同的路径作为隐式 <code>filesystem_mirror</code> 路径：</p>
<ul>
<li>Windows：<code>%APPDATA%/terraform.d/plugins</code> 以及 <code>%APPDATA%/HashiCorp/Terraform/plugins</code></li>
<li>Mac OS X：<code>$HOME/.terraform.d/plugins/</code>，<code>~/Library/Application Support/io.terraform/plugins</code> 以及 <code>/Library/Application Support/io.terraform/plugins</code></li>
<li>Linux 以及其他 Unix 风格系统：<code>$HOME/.terraform.d/plugins/</code>，以及配置的 <a target="_blank" rel="noopener" href="https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html">XDG 基础目录</a>后接 <code>terraform/plugins</code>。如果没有设置 XDG 环境变量，Terraform 会使用 <code>~/.local/share/terraform/plugins</code>，<code>/usr/local/share/terraform/plugins</code>，以及 <code>/usr/share/terraform/plugins</code></li>
</ul>
<p>Terraform 会在启动时为上述路径的每一个目录创建一个隐式 <code>filesystem_mirror</code> 块。另外如果当前工作目录下包含有 <code>terraform.d/plugins</code> 目录，那么也会为它创建一个隐式 <code>filesystem_mirror</code> 块。</p>
<p>相对于任意多个隐式 <code>filesystem_mirror</code> 块，Terraform 同时也会创建一个隐式 <code>direct</code> 块。Terraform 会扫描所有文件系统镜像目录，对找到的 Provider 自动从 <code>direct</code> 块中排除出去（这种自动的 <code>exclude</code> 行为只对隐式 <code>direct</code> 块有效。如果你在 <code>provider_installation</code> 块中显式指定了 <code>direct</code> 块，那么你需要自己显式定义 <code>exclude</code> 规则）。</p>
<p>TODO:<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/config/config-file#provider-plugin-cache">https://developer.hashicorp.com/terraform/cli/config/config-file#provider-plugin-cache</a></p>
<h2 id="1-7-1-1-6-Provider-插件缓存"><a href="#provider-%E6%8F%92%E4%BB%B6%E7%BC%93%E5%AD%98"></a>1.7.1.1.6. Provider 插件缓存</h2>
<h2 id="1-7-1-1-7-允许-Provider-缓存跳过依赖锁文件检查"><a href="#%E5%85%81%E8%AE%B8-provider-%E7%BC%93%E5%AD%98%E8%B7%B3%E8%BF%87%E4%BE%9D%E8%B5%96%E9%94%81%E6%96%87%E4%BB%B6%E6%A3%80%E6%9F%A5"></a>1.7.1.1.7. 允许 Provider 缓存跳过依赖锁文件检查</h2>
<ul>
<li>
<p><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><strong>1.7.2.1.</strong> 环境变量</a></p>
</li>
<li>
<p><a href="#tflog"><strong>1.7.2.1.1.</strong> TF_LOG</a></p>
</li>
<li>
<p><a href="#tflogpath"><strong>1.7.2.1.2.</strong> TF_LOG_PATH</a></p>
</li>
<li>
<p><a href="#tfinput"><strong>1.7.2.1.3.</strong> TF_INPUT</a></p>
</li>
<li>
<p><a href="#tfvarname"><strong>1.7.2.1.4.</strong> TF_VAR_name</a></p>
</li>
<li>
<p><a href="#tfcliargs-%E4%BB%A5%E5%8F%8A-tfcliargsname"><strong>1.7.2.1.5.</strong> TF_CLI_ARGS 以及 TF_CLI_ARGS_name</a></p>
</li>
<li>
<p><a href="#tfdatadir"><strong>1.7.2.1.6.</strong> TF_DATA_DIR</a></p>
</li>
<li>
<p><a href="#tfworkspace"><strong>1.7.2.1.7.</strong> TF_WORKSPACE</a></p>
</li>
<li>
<p><a href="#tfinautomation"><strong>1.7.2.1.8.</strong> TF_IN_AUTOMATION</a></p>
</li>
<li>
<p><a href="#tfregistrydiscoveryretry"><strong>1.7.2.1.9.</strong> TF_REGISTRY_DISCOVERY_RETRY</a></p>
</li>
<li>
<p><a href="#tfregistryclienttimeout"><strong>1.7.2.1.10.</strong> TF_REGISTRY_CLIENT_TIMEOUT</a></p>
</li>
<li>
<p><a href="#tfcliconfigfile"><strong>1.7.2.1.11.</strong> TF_CLI_CONFIG_FILE</a></p>
</li>
<li>
<p><a href="#tfplugincachedir"><strong>1.7.2.1.12.</strong> TF_PLUGIN_CACHE_DIR</a></p>
</li>
<li>
<p><a href="#tfignore"><strong>1.7.2.1.13.</strong> TF_IGNORE</a></p>
</li>
</ul>
<p><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"></a></p>
<h2 id="1-7-2-1-环境变量"><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"></a>1.7.2.1. 环境变量</h2>
<p>Terraform使用一系列的环境变量来定制化各方面的行为。如果只是想简单使用Terraform，我们并不需要设置这些环境变量；但他们可以在一些不常见的场景下帮助我们改变Terraform的默认行为，或者是出于调试目的修改输出日志的级别。</p>
<h2 id="1-7-2-1-1-TF-LOG"><a href="#tflog"></a>1.7.2.1.1. TF_LOG</h2>
<p>该环境变量可以设定 Terraform 内部日志的输出级别，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> TF_LOG=TRACE</span><br></pre></td></tr></table></figure>
<p>Terraform 日志级别有 <code>TRACE</code>、<code>DEBUG</code>、<code>INFO</code>、<code>WARN</code> 和 <code>ERROR</code>。<code>TRACE</code> 包含的信息最多也最冗长，如果 <code>TF_LOG</code> 被设定为这五级以外的值时 Terraform 会默认使用 <code>TRACE</code>。</p>
<p>如果在使用 Terraform 的过程中遇到未知的错误并怀疑是 Terraform 或相关插件的 bug，请设置 <code>TF_LOG</code> 级别后收集输出的日志并提交给相关人员。</p>
<p>有志于获取 Terraform 认证的读者请注意，该知识点近乎属于必考。</p>
<h2 id="1-7-2-1-2-TF-LOG-PATH"><a href="#tflogpath"></a>1.7.2.1.2. TF_LOG_PATH</h2>
<p>该环境变量可以设定日志文件保存的位置。注意，如果TF_LOG_PATH被设置了，那么 <code>TF_LOG</code> 也必须被设置。举例来说，想要始终把日志输出到当前工作目录，我们可以这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> TF_LOG_PATH=./terraform.log</span><br></pre></td></tr></table></figure>
<h2 id="1-7-2-1-3-TF-INPUT"><a href="#tfinput"></a>1.7.2.1.3. TF_INPUT</h2>
<p>该环境变量设置为 <code>&quot;false&quot;</code> 或 <code>&quot;0&quot;</code> 时，等同于运行 Terraform 相关命令行命令时添加了参数 <code>-input=false</code>。如果你想在自动化环境下避免 Terraform 通过命令行的交互式提示要求给定输入变量的值而是直接报错时(无 <code>default</code> 值的输入变量，无法通过任何途径获得值)可以设置该环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> TF_INPUT=0</span><br></pre></td></tr></table></figure>
<h2 id="1-7-2-1-4-TF-VAR-name"><a href="#tfvarname"></a>1.7.2.1.4. TF_VAR_name</h2>
<p>我们在介绍输入变量赋值时介绍过，可以通过设置名为 <code>TF_VAR_name</code> 的环境变量来为名为 <code>&quot;name&quot;</code> 的输入变量赋值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> TF_VAR_region=us-west-1</span><br><span class="line">$ <span class="built_in">export</span> TF_VAR_ami=ami-049d8641</span><br><span class="line">$ <span class="built_in">export</span> TF_VAR_alist=<span class="string">&#x27;[1,2,3]&#x27;</span></span><br><span class="line">$ <span class="built_in">export</span> TF_VAR_amap=<span class="string">&#x27;&#123; foo = &quot;bar&quot;, baz = &quot;qux&quot; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-7-2-1-5-TF-CLI-ARGS-以及-TF-CLI-ARGS-name"><a href="#tfcliargs-%E4%BB%A5%E5%8F%8A-tfcliargsname"></a>1.7.2.1.5. TF_CLI_ARGS 以及 TF_CLI_ARGS_name</h2>
<p><code>TF_CLI_ARGS</code> 的值指定了附加给命令行的额外参数，这使得在自动化 CI 环境下可以轻松定制 Terraform 的默认行为。</p>
<p>该参数的值会被直接插入在子命令后(例如 plan)以及通过命令行指定的参数之前。这种做法确保了环境变量参数优先于通过命令行传递的参数。</p>
<p>例如，执行这样的命令：<code>TF_CLI_ARGS=&quot;-input=false&quot; terraform apply -force</code>，它等价于手工执行 <code>terraform apply -input=false -force</code>。</p>
<p><code>TF_CLI_ARGS</code> 变量影响所有的 Terraform 命令。如果你只想影响某个特定的子命令，可以使用 <code>TF_CLI_ARGS_name</code> 变量。例如：<code>TF_CLI_ARGS_plan=&quot;-refresh=false&quot;</code>，就只会针对 <code>plan</code> 子命令起作用。</p>
<p>该环境变量的值会与通过命令行传入的参数一样被解析，你可以在值里使用单引号和双引号来定义字符串，多个参数之间以空格分隔。</p>
<h2 id="1-7-2-1-6-TF-DATA-DIR"><a href="#tfdatadir"></a>1.7.2.1.6. TF_DATA_DIR</h2>
<p><code>TF_DATA_DIR</code> 可以修改 Terraform 保存在每个工作目录下的数据的位置。一般来说，Terraform 会把这些数据写入当前工作目录下的 <code>.terraform</code> 文件夹内，但这一位置可以通过设置 <code>TF_DATA_DIR</code> 来修改。</p>
<p>大部分情况下我们不应该设置该变量，但有时我们不得不这样做，比如默认路径下我们无权写入数据时。</p>
<p>该数据目录被用来保存下一次执行任意命令时需要读取的数据，所以必须被妥善保存，并确保所有的 Terraform 命令都可以一致地读写它，否则 Terraform 会找不到 Provider 插件、模块代码以及其他文件。</p>
<h2 id="1-7-2-1-7-TF-WORKSPACE"><a href="#tfworkspace"></a>1.7.2.1.7. TF_WORKSPACE</h2>
<p>多环境部署时，可以使用此环境变量而非 <code>terraform workspace select your_workspace</code> 来切换 workspace。使用 <code>TF_WORKSPACE</code> 允许设置使用的工作区。</p>
<p>比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export TF_WORKSPACE=your_workspace</span><br></pre></td></tr></table></figure>
<p>建议仅在非交互式使用中使用此环境变量，因为在本地 shell 环境中，很容易忘记设置了该变量并将变更执行到错误的环境中。</p>
<p>可以在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/22.workspace/index">这里</a>阅读工作区的更多信息。</p>
<h2 id="1-7-2-1-8-TF-IN-AUTOMATION"><a href="#tfinautomation"></a>1.7.2.1.8. TF_IN_AUTOMATION</h2>
<p>如果该变量被设置为非空值，Terraform 会意识到自己运行在一个自动化环境下，从而调整自己的输出以避免给出关于该执行什么子命令的建议。这可以使得输出更加一致且减少非必要的信息量。</p>
<h2 id="1-7-2-1-9-TF-REGISTRY-DISCOVERY-RETRY"><a href="#tfregistrydiscoveryretry"></a>1.7.2.1.9. TF_REGISTRY_DISCOVERY_RETRY</h2>
<p>该变量定义了尝试从 registry 拉取插件或模块代码遇到错误时的重试次数。</p>
<h2 id="1-7-2-1-10-TF-REGISTRY-CLIENT-TIMEOUT"><a href="#tfregistryclienttimeout"></a>1.7.2.1.10. TF_REGISTRY_CLIENT_TIMEOUT</h2>
<p>该变量定义了发送到 registry 连接请求的超时时间，默认值为 10 秒。可以这样设置超时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> TF_REGISTRY_CLIENT_TIMEOUT=15</span><br></pre></td></tr></table></figure>
<h2 id="1-7-2-1-11-TF-CLI-CONFIG-FILE"><a href="#tfcliconfigfile"></a>1.7.2.1.11. TF_CLI_CONFIG_FILE</h2>
<p>该变量设定了 Terraform 命令行配置文件的位置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> TF_CLI_CONFIG_FILE=<span class="string">&quot;<span class="variable">$HOME</span>/.terraformrc-custom&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-7-2-1-12-TF-PLUGIN-CACHE-DIR"><a href="#tfplugincachedir"></a>1.7.2.1.12. TF_PLUGIN_CACHE_DIR</h2>
<p><code>TF_PLUGIN_CACHE_DIR</code> 环境变量是<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/1.%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6#provider-%E6%8F%92%E4%BB%B6%E7%BC%93%E5%AD%98">配置插件缓存目录</a>的另一种方法。你也可以使用 <code>TF_PLUGIN_CACHE_MAY_BREAK_DEPENDENCY_LOCK_FILE</code> 环境变量设置 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/1.%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6#%E5%85%81%E8%AE%B8-provider-%E7%BC%93%E5%AD%98%E8%B7%B3%E8%BF%87%E4%BE%9D%E8%B5%96%E9%94%81%E6%96%87%E4%BB%B6%E6%A3%80%E6%9F%A5"><code>plugin_cache_may_break_dependency_lock_file</code> 配置项</a></p>
<h2 id="1-7-2-1-13-TF-IGNORE"><a href="#tfignore"></a>1.7.2.1.13. TF_IGNORE</h2>
<p>如果 <code>TF_IGNORE</code> 设置为 <code>&quot;trace&quot;</code>，Terraform 会在调试信息中输出被忽略的文件和目录。该配置与 <code>.terraformignore</code> 文件搭配时对调试大型代码仓库相当有用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export TF_IGNORE=trace</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80"><strong>1.7.3.1.</strong> 资源地址</a></p>
</li>
<li>
<p><a href="#%E6%A8%A1%E5%9D%97%E8%B7%AF%E5%BE%84"><strong>1.7.3.1.1.</strong> 模块路径</a></p>
</li>
<li>
<p><a href="#%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80%E5%BD%A2%E5%BC%8F"><strong>1.7.3.1.2.</strong> 资源地址形式</a></p>
</li>
<li>
<p><a href="#%E5%A4%9A%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%9D%97%E4%B8%8E%E8%B5%84%E6%BA%90%E7%9A%84%E8%AE%BF%E9%97%AE%E7%B4%A2%E5%BC%95"><strong>1.7.3.1.3.</strong> 多实例模块与资源的访问索引</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90"><strong>1.7.3.1.4.</strong> 例子</a></p>
</li>
<li>
<p><a href="#count-%E7%9A%84%E4%BE%8B%E5%AD%90"><strong>1.7.3.1.4.1.</strong> count 的例子</a></p>
</li>
<li>
<p><a href="#foreach-%E7%9A%84%E4%BE%8B%E5%AD%90"><strong>1.7.3.1.4.2.</strong> for_each 的例子</a></p>
</li>
</ul>
<p><a href="#%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80"></a></p>
<h2 id="1-7-3-1-资源地址"><a href="#%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80"></a>1.7.3.1. 资源地址</h2>
<p>在编码时我们有时会需要引用一些资源的输出属性或是一些模块的输出值，这都涉及到如何在代码中引用特定模块或是资源。另外在执行某些命令行操作时也需要我们显式指定一些目标资源，这时我们要掌握Terraform的资源路径规则。</p>
<p>一个资源地址是用以在一个庞大的基础设施中精确引用一个特定资源对象的字符串。一个地址由两部分组成：<code>[module path][resource spec]</code>。</p>
<h2 id="1-7-3-1-1-模块路径"><a href="#%E6%A8%A1%E5%9D%97%E8%B7%AF%E5%BE%84"></a>1.7.3.1.1. 模块路径</h2>
<p>一个模块路径在模块树上定位了一个特定模块。它的形式是这样的：<code>module.module_name[module index]</code></p>
<ul>
<li><code>module</code>：<code>module</code> 关键字标记了这时一个子模块而非根模块。在路径中可以包含多个 <code>module</code> 关键字</li>
<li><code>module_name</code>：用户定义的模块名</li>
<li><code>[module index]</code>：(可选)访问多个子模块中特定实例的索引，由方括号包围</li>
</ul>
<p>一个不包含具体资源的地址，例如 <code>module.foo</code> 代表了模块内所有的资源(如果只是单个模块而不是多实例模块)，或者是多实例模块的所有实例。要指代特定模块实例的所有资源，需要在地址中附带下标，例如 <code>module.foo[0]</code>。</p>
<p>如果地址中模块部分被省略，那么地址就指代根模块资源。</p>
<p>这里有一个包含多个 <code>module</code> 关键字应用于多实例模块的例子：<code>module.foo[0].module.bar[&quot;a&quot;]</code>。</p>
<p>要注意的是，由于模块的 <code>count</code> 和 <code>for_each</code> 元参数是 Terraform 0.13 开始引进的，所以多实例模块地址也只能在 0.13 及之后的版本使用。</p>
<h2 id="1-7-3-1-2-资源地址形式"><a href="#%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80%E5%BD%A2%E5%BC%8F"></a>1.7.3.1.2. 资源地址形式</h2>
<p>一个资源地址定位了代码中特定资源对象，它的形式是这样的：<code>resource_type.resource_name[resource index]</code></p>
<ul>
<li><code>resource_type</code>：资源类型</li>
<li><code>resource_name</code>：用户定义的资源名称</li>
<li><code>[resource index]</code>：(可选)访问多实例资源中特定资源实例的索引，由方括号包围</li>
</ul>
<h2 id="1-7-3-1-3-多实例模块与资源的访问索引"><a href="#%E5%A4%9A%E5%AE%9E%E4%BE%8B%E6%A8%A1%E5%9D%97%E4%B8%8E%E8%B5%84%E6%BA%90%E7%9A%84%E8%AE%BF%E9%97%AE%E7%B4%A2%E5%BC%95"></a>1.7.3.1.3. 多实例模块与资源的访问索引</h2>
<p>以下规约适用于访问多实例模块及资源时使用的索引值：</p>
<ul>
<li><code>[N]</code>：当使用 <code>count</code> 元参数时N是一个自然数。如果省略，并且 <code>count</code> &gt; 1，那么指代所有的实例</li>
<li><code>[&quot;INDEX&quot;]</code>：当使用 <code>for_each</code> 元参数时 <code>INDEX</code> 是一个字母数字混合的字符串</li>
</ul>
<h2 id="1-7-3-1-4-例子"><a href="#%E4%BE%8B%E5%AD%90"></a>1.7.3.1.4. 例子</h2>
<h3 id="1-7-3-1-4-1-count-的例子"><a href="#count-%E7%9A%84%E4%BE%8B%E5%AD%90"></a>1.7.3.1.4.1. count 的例子</h3>
<p>给定一个代码定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  # ...</span><br><span class="line">  count = 4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给定一个地址：<code>aws_instance.web[3]</code>，它指代的是最后一个名为 <code>web</code> 的 <code>aws_instance</code> 实例；给定地址 <code>aws_instance.web</code>，指代的是所有名为 <code>web</code> 的 <code>aws_instance</code> 实例。</p>
<h3 id="1-7-3-1-4-2-for-each-的例子"><a href="#foreach-%E7%9A%84%E4%BE%8B%E5%AD%90"></a>1.7.3.1.4.2. for_each 的例子</h3>
<p>给定如下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  # ...</span><br><span class="line">  for_each = &#123;</span><br><span class="line">    &quot;terraform&quot;: &quot;value1&quot;,</span><br><span class="line">    &quot;resource&quot;:  &quot;value2&quot;,</span><br><span class="line">    &quot;indexing&quot;:  &quot;value3&quot;,</span><br><span class="line">    &quot;example&quot;:   &quot;value4&quot;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>地址 <code>aws_instance.web[&quot;example&quot;]</code> 引用的是 <code>aws_instance.web</code> 中键为 <code>&quot;example&quot;</code> 的实例。</p>
<ul>
<li>
<p><a href="#apply"><strong>1.7.4.1.</strong> apply</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.4.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E8%87%AA%E5%8A%A8-plan-%E6%A8%A1%E5%BC%8F"><strong>1.7.4.1.2.</strong> 自动 Plan 模式</a></p>
</li>
<li>
<p><a href="#%E6%97%A2%E6%9C%89-plan-%E6%A8%A1%E5%BC%8F"><strong>1.7.4.1.3.</strong> 既有 Plan 模式</a></p>
</li>
<li>
<p><a href="#plan-%E5%8F%82%E6%95%B0"><strong>1.7.4.1.4.</strong> Plan 参数</a></p>
</li>
<li>
<p><a href="#apply-%E5%8F%82%E6%95%B0"><strong>1.7.4.1.5.</strong> Apply 参数</a></p>
</li>
<li>
<p><a href="#%E6%8C%87%E5%AE%9A%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"><strong>1.7.4.1.6.</strong> 指定其他配置文件目录</a></p>
</li>
</ul>
<p><a href="#apply"></a></p>
<h2 id="1-7-4-1-apply"><a href="#apply"></a>1.7.4.1. apply</h2>
<p>Terraform 最重要的命令就是 <code>apply</code>。<code>apply</code> 命令可以生成执行计划(可选)并执行之，使得基础设施资源状态符合代码的描述。</p>
<h2 id="1-7-4-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.4.1.1. 用法</h2>
<p><code>terraform apply [options] [plan file]</code></p>
<p>Terraform 的 Apply 有两种模式：自动 Plan 模式以及既有 Plan 模式。</p>
<h2 id="1-7-4-1-2-自动-Plan-模式"><a href="#%E8%87%AA%E5%8A%A8-plan-%E6%A8%A1%E5%BC%8F"></a>1.7.4.1.2. 自动 Plan 模式</h2>
<p>当我们运行 <code>terraform apply</code> 而不指定计划文件时，Terraform 会自动创建一个新的执行计划，就像我们已运行 <code>terraform plan</code> 一样，提示我们批准该计划，并采取指示的操作。我们可以使用所有 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan#plan-%E6%A8%A1%E5%BC%8F">plan 模式</a>和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan#plan-%E9%80%89%E9%A1%B9">plan 选项</a>来自定义 Terraform 创建计划的方式。</p>
<p>我们可以设置 <code>-auto-approve</code> 选项来要求 Terraform 跳过确认直接执行计划。</p>
<p><strong>警告</strong>：如果使用 <code>-auto-approve</code>，建议确保没有人可以在 Terraform 工作流程之外更改我们的基础设施。这可以最大限度地降低不可预测的变更和配置漂移的风险。</p>
<h2 id="1-7-4-1-3-既有-Plan-模式"><a href="#%E6%97%A2%E6%9C%89-plan-%E6%A8%A1%E5%BC%8F"></a>1.7.4.1.3. 既有 Plan 模式</h2>
<p>当您将<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan#outputfile">既有的计划文件</a>传递给 <code>terraform apply</code> 时，Terraform 会执行既有的计划中的操作，而不提示确认。在自动化运行 Terraform 时，可能需要使用由这样的两个步骤组成的工作流。</p>
<p>我们在应用计划之前可以使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/17.show"><code>terraform show</code></a> 检查既有的计划文件。</p>
<p>使用既有的计划时，我们无法指定任何其他计划模式或选项。这些选项只会影响 Terraform 关于采取哪些操作的决策，而这些决策的最终结果已经在计划文件中包含了。</p>
<h2 id="1-7-4-1-4-Plan-参数"><a href="#plan-%E5%8F%82%E6%95%B0"></a>1.7.4.1.4. Plan 参数</h2>
<p>在未提供既有计划文件时，<code>terraform apply</code> 命令支持 <code>terraform plan</code> 命令所支持的所有 Plan 模式参数以及 Plan 选项参数。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan#plan-%E6%A8%A1%E5%BC%8F">Plan 模式参数</a>：包括 <code>-destroy</code>（创建销毁所有远程对象的计划）和 <code>-refresh-only</code>（创建更新 Terraform 状态和根模块输出值的计划）。</li>
<li><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan#plan-%E9%80%89%E9%A1%B9">Plan 选项参数</a>：包括指定 Terraform 应替换哪些资源实例、设置 Terraform 输入变量等的参数。</li>
</ul>
<h2 id="1-7-4-1-5-Apply-参数"><a href="#apply-%E5%8F%82%E6%95%B0"></a>1.7.4.1.5. Apply 参数</h2>
<p>下面的参数可以更改 apply 命令的执行方式和 apply 操作生成的报告格式。</p>
<ul>
<li><code>-auto-approve</code>：跳过交互确认步骤，直接执行变更。此选项将被忽略，因为 Terraform 认为我们指定了计划文件即已批准执行，因此在这种情况下永远不会提示。</li>
<li><code>-compact-warnings</code>：以紧凑的形式显示所有警告消息，其中仅包含摘要消息，除非输出信息中存在至少一个错误，因此警告文本中可能包含有错误的上下文信息。</li>
<li><code>-input=true</code>：禁用 Terraform 的所有交互式提示。请注意，这也会阻止 Terraform 提示交互式批准计划，这时 Terraform 将保守地假设您不希望应用该计划，从而导致操作失败。如果您希望在非交互式上下文中运行 Terraform，请参阅 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/8.%E6%8A%80%E5%B7%A7/10.terraform%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96">Terraform 与自动化</a> 了解一些不同的方法。</li>
<li><code>-json</code>：启用机器可读的 JSON UI 输出。这意味着 <code>-input=false</code>，因此配置 <code>variable</code> 值都已赋值才能继续。要启用此参数，您还必须启用 <code>-auto-approve</code> 标志或指定既有的计划文件。</li>
<li><code>-lock=false</code>：执行时是否先锁定状态文件。如果其他人可能同时对同一工作区运行命令，则这是危险的。</li>
<li><code>-lock-timeout=DURATION</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则命令 Terraform 为上锁操作设置一个超时时长。持续时间语法是一个数字后跟一个时间单位字母，例如“3s”表示三秒。</li>
<li><code>-no-color</code>：关闭彩色输出。在无法解释输出色彩的终端中运行 Terraform 时请使用此参数。</li>
<li><code>-parallelism=n</code>：限制 Terraform <a target="_blank" rel="noopener" href="https://www.terraform.io/docs/internals/graph.html#walking-the-graph">遍历图</a>时的最大并行度，默认值为 <code>10</code>(考试高频考点)</li>
</ul>
<p>当配置中只使用了 <code>local</code> Backend 时，<code>terraform apply</code> 还支持以下三个遗留参数：</p>
<ul>
<li><code>-backup-path</code>：保存备份文件的路径。默认等于 <code>-state-out</code> 参数后加上 <code>&quot;.backup&quot;</code> 后缀。设置为 <code>&quot;-&quot;</code> 可关闭</li>
<li><code>-state=path</code>：保存状态文件的路径，默认值是 <code>&quot;terraform.tfstate&quot;</code>。如果使用了远程 Backend 该参数设置无效。该参数不影响其他命令，比如执行 <code>init</code> 时会找不到它设置的状态文件。如果要使得所有命令都可以使用同一个特定位置的状态文件，请使用 Local Backend</li>
<li><code>-state-out=path</code>：写入更新的状态文件的路径，默认情况使用 <code>-state</code> 的值。该参数在使用远程 Backend 时设置无效</li>
</ul>
<h2 id="1-7-4-1-6-指定其他配置文件目录"><a href="#%E6%8C%87%E5%AE%9A%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"></a>1.7.4.1.6. 指定其他配置文件目录</h2>
<p>Terraform v0.13 及更早版本接受提供目录路径的附加位置参数，在这种情况下，Terraform 将使用该目录作为根模块而不是当前工作目录。</p>
<p>该用法在 Terraform v0.14 中已弃用，并在 Terraform v0.15 中删除。如果您的工作流程需要修改根模块目录，请改用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/index#%E9%80%9A%E8%BF%87--chdir-%E5%8F%82%E6%95%B0%E5%88%87%E6%8D%A2%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><code>-chdir</code> 全局选项</a>，该选项适用于所有命令，并使 Terraform 始终在给定目录中查找它通常在当前工作目录中读取或写入的所有文件。</p>
<p>如果我们之前使用此遗留模式时同时需要 Terraform 将 <code>.terraform</code> 子目录写入当前工作目录，即使根模块目录已被覆盖，请使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/2.%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F#tf_data_dir"><code>TF_DATA_DIR</code> 环境变量</a>命令 Terraform 将 <code>.terraform</code> 目录写入其他位置，而不是当前工作目录。</p>
<ul>
<li>
<p><a href="#console"><strong>1.7.5.1.</strong> console</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.5.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E8%84%9A%E6%9C%AC%E5%8C%96"><strong>1.7.5.1.2.</strong> 脚本化</a></p>
</li>
<li>
<p><a href="#%E8%BF%9C%E7%A8%8B%E7%8A%B6%E6%80%81"><strong>1.7.5.1.3.</strong> 远程状态</a></p>
</li>
<li>
<p><a href="#%E6%90%AD%E9%85%8D%E6%97%A2%E6%9C%89%E8%AE%A1%E5%88%92%E6%96%87%E4%BB%B6%E8%BF%90%E8%A1%8C"><strong>1.7.5.1.4.</strong> 搭配既有计划文件运行</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90"><strong>1.7.5.1.5.</strong> 例子</a></p>
</li>
</ul>
<p><a href="#console"></a></p>
<h2 id="1-7-5-1-console"><a href="#console"></a>1.7.5.1. console</h2>
<p>有时我们想要一个安全的调试工具来帮助我们确认某个表达式是否合法，或者表达式的值是否符合预期，这时我们可以使用 <code>terraform console</code> 启动一个交互式控制台。</p>
<h2 id="1-7-5-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.5.1.1. 用法</h2>
<p><code>terraform console [options] [options]</code></p>
<p>console 命令提供了一个用以执行和测试各种<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/8.%E8%A1%A8%E8%BE%BE%E5%BC%8F.html">表达式</a>的命令行控制台。在编码时如果我们不确定某个表达式的最终结果时(例如使用字符串模版)，我们可以在这个控制台中搭配当前状态文件中的数据进行各种测试。</p>
<p>如果当前状态是空的或还没有创建状态文件，那么控制台可以用来测试各种表达式语法以及内建函数。假如当前根模块有状态，<code>console</code> 命令将会对状态加锁，这使得我们无法在运行其他可能会修改状态的操作时使用 <code>console</code> 命令。</p>
<p>在控制台中可以使用 <code>exit</code> 命令或是 Ctrl-C 或是 Ctrl-D 退出。</p>
<p>当使用的是 <code>local</code> Backend 时，<code>terraform console</code> 可以使用 <code>-state</code> 遗留参数：</p>
<ul>
<li><code>-state=path</code>：指向本机状态文件的路径。表达式计算会使用该状态文件中记录的值。如果没有指定，则会使用当前工作区(Workspace)关联的状态文件</li>
</ul>
<h2 id="1-7-5-1-2-脚本化"><a href="#%E8%84%9A%E6%9C%AC%E5%8C%96"></a>1.7.5.1.2. 脚本化</h2>
<p><code>terraform console</code> 命令可以搭配非交互式脚本使用，可以使用管道符将其他命令输出接入控制台执行。如果没有发生错误，只有最终结果会被打印。</p>
<p>样例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;split(&quot;,&quot;, &quot;foo,bar,baz&quot;)&#x27;</span> | terraform console</span><br><span class="line">tolist([</span><br><span class="line">  <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">  <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">  <span class="string">&quot;baz&quot;</span>,</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<h2 id="1-7-5-1-3-远程状态"><a href="#%E8%BF%9C%E7%A8%8B%E7%8A%B6%E6%80%81"></a>1.7.5.1.3. 远程状态</h2>
<p>如果使用了远程 Backend 存储状态，Terraform 会从远程 Backend 读取当前工作区的状态数据来计算表达式。</p>
<h2 id="1-7-5-1-4-搭配既有计划文件运行"><a href="#%E6%90%AD%E9%85%8D%E6%97%A2%E6%9C%89%E8%AE%A1%E5%88%92%E6%96%87%E4%BB%B6%E8%BF%90%E8%A1%8C"></a>1.7.5.1.4. 搭配既有计划文件运行</h2>
<p>默认情况下，<code>terraform console</code> 根据当前 Terraform 状态计算表达式，因此对于尚未通过 Apply 创建的资源实例，结果通常非常有限。</p>
<p>您可以使用 <code>-plan</code> 选项首先生成执行计划，就像运行 <code>terraform plan</code> 一样，然后根据<em>计划的</em>状态进行计算，以描述 Terraform 期望在应用计划后应得的值。这通常会在控制台提示出现之前引发更长的延迟，但作为回报，可知的表达式范围中将有一组更完整的可用值。</p>
<p>一个好的 Terraform 配置代码，在 Plan 阶段不应对实际远程对象进行任何修改，但我们可以编写一个在 Plan 时可以执行重要操作的配置。例如，使用 <code>hashcorp/external</code> Provider 程序的 <code>external</code> 数据源的配置可能会在 Plan 阶段运行设置的的外部命令，这意味着该外部命令也会被 <code>terraform console -plan</code> 运行。</p>
<p>我们不建议编写在 Plan 阶段进行更改的配置。如果您不顾该建议而编写了此类配置，则在 Plan 模式下针对该配置使用控制台时请务必小心。</p>
<h2 id="1-7-5-1-5-例子"><a href="#%E4%BE%8B%E5%AD%90"></a>1.7.5.1.5. 例子</h2>
<p><code>terraform console</code> 命令将从配置的 Backend 读取当前工作目录中的 Terraform 配置和 Terraform 状态文件，以便可以根据配置和状态文件中的值计算表达式。</p>
<p>假设我们有如下的 <code>main.tf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;apps&quot; &#123;</span><br><span class="line">  type = map(any)</span><br><span class="line">  default = &#123;</span><br><span class="line">    &quot;foo&quot; = &#123;</span><br><span class="line">      &quot;region&quot; = &quot;us-east-1&quot;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;bar&quot; = &#123;</span><br><span class="line">      &quot;region&quot; = &quot;eu-west-1&quot;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;baz&quot; = &#123;</span><br><span class="line">      &quot;region&quot; = &quot;ap-south-1&quot;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;random_pet&quot; &quot;example&quot; &#123;</span><br><span class="line">  for_each = var.apps</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 <code>terraform console</code> 会进入交互式 shell，我们可以在其中计算表达式：</p>
<p>打印一个 map：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; var.apps.foo</span><br><span class="line">&#123;</span><br><span class="line">  &quot;region&quot; = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据给定值过滤 map：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123; for key, value in var.apps : key =&gt; value if value.region == &quot;us-east-1&quot; &#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;foo&quot; = &#123;</span><br><span class="line">    &quot;region&quot; = &quot;us-east-1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>确认特定值是否为尚不知晓（Known after apply）值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; random_pet.example</span><br><span class="line">(known after apply)</span><br></pre></td></tr></table></figure>
<p>测试各种函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; cidrnetmask(&quot;172.16.0.0/12&quot;)</span><br><span class="line">&quot;255.240.0.0&quot;</span><br></pre></td></tr></table></figure>
<h2 id="destroy"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">destroy</a></h2>
<ul>
<li>
<p><a href="#destroy"><strong>1.7.6.1.</strong> destroy</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.6.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#destroy"></a></p>
<h2 id="1-7-6-1-destroy"><a href="#destroy"></a>1.7.6.1. destroy</h2>
<p><code>terraform destroy</code> 命令可以用来销毁并回收所有由 Terraform 配置所管理的基础设施资源。</p>
<p>虽然我们一般不会删除长期存在于生产环境中的对象，但有时我们会用 Terraform 管理用于开发目的的临时基础设施，在这种情况下，您可以在完成后使用 <code>terraform destroy</code> 来方便地清理所有这些临时资源。</p>
<h2 id="1-7-6-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.6.1.1. 用法</h2>
<p><code>terraform destroy [options]</code></p>
<p>该命令是以下命令的快捷方式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply -destroy</span><br></pre></td></tr></table></figure>
<p>因此，此命令接受 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/4.apply"><code>terraform apply</code></a> 所支持的大部分选项，但是它不支持 <code>-destroy</code> 模式搭配指定计划文件的用法。</p>
<p>我们还可以通过运行以下命令创建推测性销毁计划，以查看销毁的效果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform plan -destroy</span><br></pre></td></tr></table></figure>
<p>该命令会以 <code>destroy</code> 模式运行 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan"><code>terraform plan</code></a> 命令，显示准备要销毁的变更，但不予执行。</p>
<p><strong>注意</strong>：<code>terraform apply</code> 的 <code>-destroy</code> 选项仅存在于 Terraform v0.15.2 及更高版本中。对于早期版本，必须使用 <code>terraform destroy</code> 才能获得 <code>terraform apply -destroy</code> 的效果。</p>
<ul>
<li>
<p><a href="#fmt"><strong>1.7.7.1.</strong> fmt</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.7.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#fmt"></a></p>
<h2 id="1-7-7-1-fmt"><a href="#fmt"></a>1.7.7.1. fmt</h2>
<p><code>terraform fmt</code> 命令被用来格式化 Terraform 代码文件的格式和规范。该命令会对代码文件应用我们之前介绍过的<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/10.%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E8%A7%84%E8%8C%83.html">代码风格规范</a>中的一些规定，另外会针对可读性对代码做些微调整。</p>
<p>其他具有生成Terraform代码文件功能的命令会按照terraform fmt的标准来生成代码，所以请在项目中遵循fmt的代码风格以保持代码风格的统一。</p>
<p>其他那些会生成 Terraform 代码的 Terraform 命令，生成的代码都会符合 <code>terraform fmt</code> 所强制推行的格式，因此对我们自己编写的文件使用该命令可以保持所有代码风格的一致。</p>
<p>Terraform 不同版本的代码风格规范会有些微不同，所以在升级 Terraform 后我们建议要对代码执行一次 <code>terraform fmt</code>。</p>
<p>我们不会将修改 <code>terraform fmt</code> 执行的格式规则视作是 Terraform 新版本的破坏性变更（意为，不同版本的 <code>terraform fmt</code> 可能会对代码做不同的格式化），但我们的目标是最大限度地减少对那些已符合 Terraform 文档中显示的样式示例的代码的更改。添加新的格式规则时，他们通常会按照文档中代码示例中展示的新规则来制定，因此我们建议遵循文档中的样式，即使这些文档中的样式尚未被 <code>terraform fmt</code> 强制执行。</p>
<p>格式化决定始终是主观的，因此您可能不同意 <code>terraform fmt</code> 做出的决定。该命令是被设计成固执己见的，并且没有自定义选项，因为它的主要目标是鼓励不同 Terraform 代码库之间风格的一致性，即使所选的风格永远不可能是每个人都喜欢的。</p>
<p>我们建议代码作者在编写 Terraform 模块时遵循 <code>terraform fmt</code> 应用的样式约定，但如果您发现结果特别令人反感，那么您可以选择不使用此命令，并可能选择使用第三方格式化工具。如果您选择使用第三方工具，那么您还应该在 Terraform 自动生成的文件上运行它，以获得手写文件和生成文件之间的一致性。</p>
<h2 id="1-7-7-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.7.1.1. 用法</h2>
<p><code>terraform fmt [options] [target...]</code></p>
<p>默认情况下，<code>fmt</code> 会扫描当前文件夹以寻找代码文件。如果 <code>[target...]</code> 参数指向一个目录，那么 <code>fmt</code> 会扫描该目录。如果 <code>[target...]</code> 参数是一个文件，那么 <code>fmt</code> 只会处理那个文件。如果 <code>[target...]</code> 参数是一个减号(<code>-</code>)，那么 <code>fmt</code> 命令会从标准输入中读取(STDIN)。</p>
<p>该命令支持以下参数：</p>
<ul>
<li>
<p><code>-list=false</code>：不列出包含不一致风格的文件</p>
</li>
<li>
<p><code>-write=false</code>：不要重写输入文件(通过 <code>-check</code> 参数实现，或是使用标准输入流时)</p>
</li>
<li>
<p><code>-diff</code>：展示格式差异</p>
</li>
<li>
<p><code>-check</code>：检查输入是否合规。返回状态码 0 则代表所有输入的代码风格都是合规，反之则不是 0，并且会打印一份包含了文件内容不合规的文件名清单。</p>
</li>
<li>
<p><code>-recursive</code>：是否递归处理所有子文件夹。默认情况下为 <code>false</code>(只有当前文件夹会被处理，不涉及内嵌子模块)</p>
</li>
<li>
<p><a href="#force-unlock"><strong>1.7.8.1.</strong> force-unlock</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.8.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#force-unlock"></a></p>
<h2 id="1-7-8-1-force-unlock"><a href="#force-unlock"></a>1.7.8.1. force-unlock</h2>
<p>手动解除状态锁。</p>
<p>这个命令不会修改你的基础设施，它只会删除当前工作区对应的状态锁。具体操作步骤取决于使用的 Backend。本地状态文件无法被其他进程解锁。</p>
<h2 id="1-7-8-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.8.1.1. 用法</h2>
<p><code>terraform force-unlock [options] LOCK_ID</code></p>
<p>参数：</p>
<ul>
<li><code>-force=true</code>：解锁时不提示确认</li>
</ul>
<p>需要注意的是，就像我们在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/2.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86#lockid">状态管理篇</a>当中介绍过的那样，每一个状态锁都有一个锁 ID。Terraform 为了确保我们解除正确的状态锁，所以会要求我们显式输入锁 ID。</p>
<p>一般情况下我们不需要强制解锁，只有在 Terraform 异常终止，来不及解除锁时需要我们手动强制解除锁。错误地解除状态锁可能会导致状态混乱，所以请小心使用。</p>
<ul>
<li>
<p><a href="#get"><strong>1.7.9.1.</strong> get</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.9.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#get"></a></p>
<h2 id="1-7-9-1-get"><a href="#get"></a>1.7.9.1. get</h2>
<p><code>terraform get</code> 命令可以用来下载以及更新根模块中使用的<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/5.Terraform%E6%A8%A1%E5%9D%97/">模块</a>。</p>
<h2 id="1-7-9-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.9.1.1. 用法</h2>
<p><code>terraform get [options]</code></p>
<p>模块被下载并安装在当前工作目录下 <code>.terraform</code> 子目录中。这个子目录不应该被提交至版本控制系统。</p>
<p><code>get</code> 命令支持以下参数：</p>
<ul>
<li><code>-update</code>：如果指定，已经被下载的模块会被检查是否有新版本，如果存在新版本则会更新</li>
<li><code>-no-color</code>：禁用输出中的文字颜色</li>
</ul>
<h2 id="graph"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">graph</a></h2>
<ul>
<li>
<p><a href="#graph"><strong>1.7.10.1.</strong> graph</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.10.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E5%88%9B%E5%BB%BA%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6"><strong>1.7.10.1.2.</strong> 创建图片文件</a></p>
</li>
<li>
<p><a href="#%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85graphviz"><strong>1.7.10.1.3.</strong> 如何安装GraphViz</a></p>
</li>
</ul>
<p><a href="#graph"></a></p>
<h2 id="1-7-10-1-graph"><a href="#graph"></a>1.7.10.1. graph</h2>
<p><code>terraform graph</code> 命令可以用来生成代码描述的基础设施或是执行计划的可视化图形。它的输出是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/DOT_(graph_description_language">DOT 格式</a>)，可以使用 <a target="_blank" rel="noopener" href="http://www.graphviz.org/">GraphViz</a> 来生成图片，也有许多网络服务可以读取这种格式。</p>
<h2 id="1-7-10-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.10.1.1. 用法</h2>
<p><code>terraform graph [options]</code></p>
<p>默认情况下，该命令输出一个简化图，仅描述配置中资源（<code>resource</code> 和 <code>data</code> 块）的依赖顺序。</p>
<p><code>-type=...</code> 参数可以在一组具有更多细节的其他图类型中进行选择，但作为代价，它也暴露了 Terraform 语言运行时的一些实现细节。</p>
<p>参数：</p>
<ul>
<li><code>-plan=tfplan</code>：针对指定计划文件生成图。使用该参数暗示着 <code>-type=apply</code>。</li>
<li><code>-draw-cycles</code>：用彩色的边高亮图中的环，这可以帮助我们分析代码中的环错误(Terraform 禁止环状依赖)。该参数只有在通过 <code>-type=...</code> 参数指定了操作类型时有效。</li>
<li><code>-type=...</code>：生成图表的类型，默认生成只包含 <code>resource</code> 的简化图。可以是：<code>plan</code>、<code>plan-destroy</code> 或是 <code>apply</code>。</li>
</ul>
<h2 id="1-7-10-1-2-创建图片文件"><a href="#%E5%88%9B%E5%BB%BA%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6"></a>1.7.10.1.2. 创建图片文件</h2>
<p><code>terraform graph</code> 命令输出的是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/DOT_(graph_description_language">DOT 格式</a>)的数据，可以轻松地使用 <a target="_blank" rel="noopener" href="http://www.graphviz.org/">GraphViz</a> 转换为图形文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform graph -<span class="built_in">type</span>=plan | dot -Tpng &gt;graph.png</span><br></pre></td></tr></table></figure>
<p>输出的图片大概是这样的：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/2020-11-25/1606272727693-image.png" alt="生成的依赖图"></p>
<p>图 1.7.10/1 - 生成的依赖图</p>
<h2 id="1-7-10-1-3-如何安装GraphViz"><a href="#%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85graphviz"></a>1.7.10.1.3. 如何安装GraphViz</h2>
<p>安装GraphViz也很简单，对于Ubuntu：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt install graphviz</span><br></pre></td></tr></table></figure>
<p>对于CentOS：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> dnf install graphviz</span><br></pre></td></tr></table></figure>
<p>对于Windows，也可以使用choco：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; choco install graphviz</span><br></pre></td></tr></table></figure>
<p>对于Mac用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install graphviz</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#import"><strong>1.7.11.1.</strong> import</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.11.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#provider%E9%85%8D%E7%BD%AE"><strong>1.7.11.1.2.</strong> Provider配置</a></p>
</li>
<li>
<p><a href="#%E4%BE%8B%E5%AD%90"><strong>1.7.11.1.3.</strong> 例子</a></p>
</li>
</ul>
<p><a href="#import"></a></p>
<h2 id="1-7-11-1-import"><a href="#import"></a>1.7.11.1. import</h2>
<p><code>terraform import</code> 命令用来将已经存在的资源对象导入 Terraform。</p>
<p>我们并不总是那么幸运，能够在项目一开始就使用 Terraform 来构建和管理我们的基础设施；有时我们有一组已经运行着的基础设施资源，然后我们为它们编写了相应的 Terraform 代码，我们进行了测试，确认了这组代码描述的基础设施与当前正在使用的基础设施是等价的；但是我们仍然无法直接使用这套代码来管理现有的基础设施，因为我们缺乏了相应的状态文件。这时我们需要使用 <code>terraform import</code> 将资源对象“导入”到 Terraform 状态文件中去。</p>
<h2 id="1-7-11-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.11.1.1. 用法</h2>
<p><code>terraform import [options] ADDRESS ID</code></p>
<p><code>terraform import</code> 会根据资源 ID 找到相应资源，并将其信息导入到状态文件中 <code>ADDRESS</code> 对应的资源上。<code>ADDRESS</code> 必须符合我们在资源地址中描述的合法<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/3.%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80">资源地址</a>格式，这样 <code>terraform import</code> 不但可以把资源导入到根模块中，也可以导入到子模块中。</p>
<p>ID 取决于被导入的资源对象的类型。举例来说，AWS 主机的 ID 格式类似于 <code>i-abcd1234</code>，而 AWS Route53 Zone 的 ID 类似于 <code>Z12ABC4UGMOZ2N</code>，请参考相关 Provider 文档来获取有关 ID 的详细信息。如果不确信的话，可以随便尝试任意 ID。如果 ID 不合法，你会看到一个错误信息。</p>
<p><strong>警告</strong>，Terraform设想的是每一个资源对象都仅对应一个独一无二的实际基础设施对象，通常来说如果我们完全使用 Terraform 创建并管理基础设施时这一点不是问题；但如果你是通过导入的方式把基础设施对象导入到 Terraform 里，要绝对避免将同一个对象导入到两个以及更多不同的地址上，这会导致 Terraform 产生不可预测的行为。</p>
<p>该命令有以下参数可以使用：</p>
<ul>
<li><code>-config=path</code>：包含含有导入目标的Terraform代码的文件夹路径。默认为当前工作目录。如果当前目录不包含 Terraform 代码文件，则必须通过手动输入或环境变量来配置 Provider。</li>
<li><code>-input=true</code>：是否允许提示输入 Provider 配置信息</li>
<li><code>-lock=false</code>：如果 Backend 支持，是否锁定状态文件。在其他人可能会同时修改同一工作区的配置时关闭锁是危险的。</li>
<li><code>-lock-timeout=0s</code>：重试尝试获取状态锁的间隔</li>
<li><code>-no-color</code>：如果设定该参数，则不会输出彩色信息</li>
<li><code>-parallelism=n</code>：限制 Terraform 遍历图的最大并行度，默认值为 10(又是考点)</li>
<li><code>-var 'foo=bar'</code>：通过命令行设置输入变量值，类似 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan#var"><code>plan</code> 命令中的介绍</a></li>
<li><code>-var-file=foo</code>：类似 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan#var-file"><code>plan</code> 命令中的介绍</a></li>
</ul>
<p>当代码只使用了 <code>local</code> 类型的 Backend 时，<code>terraform import</code> 同时接受以下遗留参数：</p>
<ul>
<li><code>-state=FILENAME</code>：要读取的状态文件的地址</li>
<li><code>-state-out=FILENAME</code>：指定修改后的状态文件的保存路径，如果我们设置了 <code>-state</code> 而没同时设置 <code>-state-out</code>，则 Terraform <code>-state</code> 的值写给 <code>-state-out</code>，这意味着 Terraform 如果创建新的状态快照，将直接写入源状态文件。</li>
<li><code>-backup=FILENAME</code>：生成状态备份文件的地址，默认情况下是 <code>-state-out</code> 路径加上 <code>.backup</code> 后缀名。设置为 <code>-</code> 可以关闭备份(不推荐)</li>
</ul>
<h2 id="1-7-11-1-2-Provider配置"><a href="#provider%E9%85%8D%E7%BD%AE"></a>1.7.11.1.2. Provider配置</h2>
<p>Terraform 会尝试读取要导入的资源对应的 Provider 的配置信息。如果找不到相关 Provider 的配置，那么 Terraform 会提示你输入相关的访问凭据。你也可以通过环境变量来配置访问凭据。</p>
<p>Terraform 在读取 Provider 配置时唯一的限制是不能依赖于&quot;非输入变量&quot;的输入。举例来说，Provider 配置不能依赖于数据源的输出。</p>
<p>举一个例子，如果你想要导入 AWS 资源而你有这样的一份代码文件，那么 Terraform 会使用这两个输入变量来配置 AWS Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;access_key&quot; &#123;&#125;</span><br><span class="line">variable &quot;secret_key&quot; &#123;&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key = var.access_key</span><br><span class="line">  secret_key = var.secret_key</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-7-11-1-3-例子"><a href="#%E4%BE%8B%E5%AD%90"></a>1.7.11.1.3. 例子</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform import aws_instance.foo i-abcd1234</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform import module.foo.aws_instance.bar i-abcd1234</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform import <span class="string">&#x27;aws_instance.baz[0]&#x27;</span> i-abcd1234</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform import <span class="string">&#x27;aws_instance.baz[&quot;example&quot;]&#x27;</span> i-abcd1234</span><br></pre></td></tr></table></figure>
<p>上面这条命令如果是在PowerShell下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> terraform import <span class="string">&#x27;aws_instance.baz[\&quot;example\&quot;]&#x27;</span> i<span class="literal">-abcd1234</span></span><br></pre></td></tr></table></figure>
<p>如果是cmd：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform import aws_instance.baz[\&quot;example\&quot;] i-abcd1234</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="#init"><strong>1.7.12.1.</strong> init</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.12.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><strong>1.7.12.1.2.</strong> 常用参数</a></p>
</li>
<li>
<p><a href="#%E4%BB%8E%E6%A8%A1%E5%9D%97%E6%BA%90%E6%8B%B7%E8%B4%9D%E6%A8%A1%E5%9D%97"><strong>1.7.12.1.3.</strong> 从模块源拷贝模块</a></p>
</li>
<li>
<p><a href="#backend-%E5%88%9D%E5%A7%8B%E5%8C%96"><strong>1.7.12.1.4.</strong> Backend 初始化</a></p>
</li>
<li>
<p><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AD%90%E6%A8%A1%E5%9D%97"><strong>1.7.12.1.5.</strong> 初始化子模块</a></p>
</li>
<li>
<p><a href="#%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"><strong>1.7.12.1.6.</strong> 插件安装</a></p>
</li>
<li>
<p><a href="#%E5%9C%A8%E8%87%AA%E5%8A%A8%E5%8C%96%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%BF%90%E8%A1%8C-terraform-init-%E5%91%BD%E4%BB%A4"><strong>1.7.12.1.7.</strong> 在自动化环境下运行 terraform init 命令</a></p>
</li>
<li>
<p><a href="#%E8%AE%BE%E7%BD%AE%E5%85%B6%E4%BB%96%E4%BB%A3%E7%A0%81%E6%96%87%E4%BB%B6%E5%A4%B9"><strong>1.7.12.1.8.</strong> 设置其他代码文件夹</a></p>
</li>
</ul>
<p><a href="#init"></a></p>
<h2 id="1-7-12-1-init"><a href="#init"></a>1.7.12.1. init</h2>
<p><code>terraform init</code> 命令被用来初始化一个包含 Terraform 代码的工作目录。在编写了一些 Terraform 代码或是克隆了一个 Terraform 项目后应首先执行该命令。反复执行该命令是安全的(考点)。</p>
<h2 id="1-7-12-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.12.1.1. 用法</h2>
<p><code>terraform init [options]</code></p>
<p>该命令为初始化工作目录执行了多个不同的步骤。详细说明可以见下文，总体来说用户不需要担心这些步骤。即使某些步骤可能会遭遇错误，但是该命令绝对不会删除你的基础设施资源或是状态文件。</p>
<h2 id="1-7-12-1-2-常用参数"><a href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"></a>1.7.12.1.2. 常用参数</h2>
<ul>
<li><code>-input=true</code>：是否在取不到输入变量值时提示用户输入</li>
<li><code>-lock=false</code>：是否在运行时锁定状态文件</li>
<li><code>-lock-timeout=&lt;duration&gt;</code>：尝试获取状态文件锁时的超时时间，默认为 <code>0s</code>（0 秒），意为一旦发现锁已被其他进程获取立即报错</li>
<li><code>-no-color</code>：禁止输出中包含颜色</li>
<li><code>-upgrade</code>：是否升级模块代码以及插件</li>
</ul>
<h2 id="1-7-12-1-3-从模块源拷贝模块"><a href="#%E4%BB%8E%E6%A8%A1%E5%9D%97%E6%BA%90%E6%8B%B7%E8%B4%9D%E6%A8%A1%E5%9D%97"></a>1.7.12.1.3. 从模块源拷贝模块</h2>
<p>默认情况下，<code>terraform init</code> 会假设工作目录下已经包含了 Terraform 代码文件。</p>
<p>我们也可以在空文件夹内搭配 <code>-from-module=MODULE-SOURCE</code> 参数运行该命令，这样在运行任何其他初始化步骤之前，指定的模块将被复制到目标目录中。</p>
<p>这种特殊的使用方式有两种场景：</p>
<ul>
<li>我们可以用这种方法从模块源对应的版本控制系统当中签出指定版本代码并为它初始化工作目录</li>
<li>如果模块源指向的是一个样例项目，那么这种方式可以把样例代码拷贝到本地目录以便我们后续基于样例编写新的代码</li>
</ul>
<p>如果是常规使用时，建议使用版本控制系统自己的命令单独检查版本控制的配置。这样，可以在必要时将额外的标志传递给版本控制系统，并在运行 <code>terraform init</code> 之前执行其他准备步骤（例如代码生成或激活凭据）。</p>
<h2 id="1-7-12-1-4-Backend-初始化"><a href="#backend-%E5%88%9D%E5%A7%8B%E5%8C%96"></a>1.7.12.1.4. Backend 初始化</h2>
<p>在执行 <code>init</code> 时，会分析根模块代码以寻找 Backend 配置，然后使用给定的配置设定初始化 Backend 存储。</p>
<p>在已经初始化 Backend 后重复执行 <code>init</code> 命令会更新工作目录以使用新的 Backend 设置。这时我们必须设置 <code>-reconfigure</code> 或是 <code>-migrate-state</code> 来升级 Backend 配置。</p>
<p><code>-migrate-state</code> 选项会尝试将现有状态复制到新 Backend，并且根据更改的内容，可能会导致交互式提示以确认工作区状态的迁移。 设置 <code>-force-copy</code> 选项可以阻止这些提示并对迁移问题回答 <code>yes</code>。启用 <code>-force-copy</code> 还会自动启用 <code>-migrate-state</code> 选项。</p>
<p><code>-reconfigure</code> 选项会忽略任何现有配置，从而防止迁移任何现有状态。</p>
<p>要跳过后端配置，请使用 -backend=false。请注意，其他一些初始化步骤需要初始化后端，因此建议仅当先前已为特定后端初始化工作目录时才使用此标志。</p>
<p>要跳过 Backend 配置，可以设置 <code>-backend=false</code>。注意某些其他 <code>init</code> 步骤需要已经被初始化的 Backend，所以推荐只在已经初始化过 Backend 后使用该参数。</p>
<p><code>-backend-config=...</code> 参数可以用来动态指定 Backend 配置，我们在状态管理章节中介绍<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/2.%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86#backend-%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8A%A8%E6%80%81%E8%B5%8B%E5%80%BC">“部分配置”</a>时已经提过，在此不再赘述。</p>
<h2 id="1-7-12-1-5-初始化子模块"><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AD%90%E6%A8%A1%E5%9D%97"></a>1.7.12.1.5. 初始化子模块</h2>
<p><code>init</code> 会搜索代码中的 <code>module</code> 块，然后通过 <code>source</code> 参数取回引用的模块代码。</p>
<p>模块安装之后重新运行 <code>init</code> 命令会继续安装那些自从上次 <code>init</code> 之后新增的模块，但不会修改已被安装的模块。设置 <code>-upgrade</code> 可以改变这种行为，将所有模块升级到最新版本的代码。</p>
<p>要跳过子模块安装步骤，可以设置 <code>-get=false</code> 参数。要注意其他一些init步骤需要模块树完整，所以建议只在成功安装过模块以后使用该参数。</p>
<h2 id="1-7-12-1-6-插件安装"><a href="#%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"></a>1.7.12.1.6. 插件安装</h2>
<p>我们在 Provider 章节中介绍了插件安装，所以在此不再赘述，我们值介绍一下参数：</p>
<ul>
<li><code>-upgrade</code>：将之前所有已安装的插件升级到符合 <code>version</code> 约束的最新版本。</li>
<li><code>-plugin-dir=PATH</code>：跳过插件安装，<em>只</em>从<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/1.%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6#%E6%98%BE%E5%BC%8F%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E9%85%8D%E7%BD%AE">命令行配置文件的 <code>filesystem_mirror</code></a> 指定的目录加载插件。该参数会跳过用户插件目录以及所有当前工作目录下的插件。我们推荐使用命令行参数文件来全局设置 Terraform 安装方法，<code>-plugin-dir</code> 可以作为一次性的临时方法，例如测试当前本地正在开发的 Provider 插件。</li>
<li><code>-lockfile=MODE</code> 设置依赖锁文件的模式 该参数的可选值有：</li>
<li><code>readonly</code>：禁用锁定文件更改，但根据已记录的信息验证校验和。该参数与 <code>-upgrade</code> 参数冲突。如果我们使用第三方依赖项管理工具更新锁定文件，那么控制它何时显式更改将很有用。</li>
</ul>
<h2 id="1-7-12-1-7-在自动化环境下运行-terraform-init-命令"><a href="#%E5%9C%A8%E8%87%AA%E5%8A%A8%E5%8C%96%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%BF%90%E8%A1%8C-terraform-init-%E5%91%BD%E4%BB%A4"></a>1.7.12.1.7. 在自动化环境下运行 terraform init 命令</h2>
<p>如果在团队的变更管理和部署流水线中 Terraform 扮演了关键角色，那么我们可能需要以某种自动化方式编排 Terraform 运行，以确保运行之间的一致性，并提供其他有趣的功能，例如与版本控制系统的钩子进行集成。</p>
<p>在此类环境中运行 <code>init</code> 时需要注意一些特殊问题，包括可选择在本地提供插件以避免重复重新安装。有关更多信息，请参阅 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/8.%E6%8A%80%E5%B7%A7/10.terraform%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96">Terraform 与自动化</a>。</p>
<h2 id="1-7-12-1-8-设置其他代码文件夹"><a href="#%E8%AE%BE%E7%BD%AE%E5%85%B6%E4%BB%96%E4%BB%A3%E7%A0%81%E6%96%87%E4%BB%B6%E5%A4%B9"></a>1.7.12.1.8. 设置其他代码文件夹</h2>
<p>Terraform v0.13 及更早版本还可以设置目录路径来代替 <code>terraform apply</code> 的计划文件参数，在这种情况下，Terraform 将使用该目录作为根模块而不是当前工作目录。</p>
<p>Terraform v0.14 中仍支持该用法，但现已在 Terraform v0.15 中弃用并删除。如果我们的工作流程依赖于覆盖根模块目录，请改用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/index#%E9%80%9A%E8%BF%87--chdir-%E5%8F%82%E6%95%B0%E5%88%87%E6%8D%A2%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><code>-chdir</code> 全局选项</a>，该选项适用于所有命令，并使 Terraform 始终在给定目录中查找它通常在当前工作目录中读取或写入的所有文件。</p>
<p>如果您之前的工作流同时要求 Terraform 即使根模块目录已被修改也要将 <code>.terraform</code> 子目录写入当前工作目录，请使用 <code>TF_DATA_DIR</code> 环境变量命令 Terraform 将 <code>.terraform</code> 目录写入当前工作目录之外的其他位置。</p>
<ul>
<li>
<p><a href="#output"><strong>1.7.13.1.</strong> output</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.13.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E6%A0%B7%E4%BE%8B"><strong>1.7.13.1.2.</strong> 样例</a></p>
</li>
<li>
<p><a href="#%E5%9C%A8%E8%87%AA%E5%8A%A8%E5%8C%96%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%BF%90%E8%A1%8C-terraform-output-%E5%91%BD%E4%BB%A4"><strong>1.7.13.1.3.</strong> 在自动化环境下运行 terraform output 命令</a></p>
</li>
</ul>
<p><a href="#output"></a></p>
<h2 id="1-7-13-1-output"><a href="#output"></a>1.7.13.1. output</h2>
<p><code>terraform output</code> 命令被用来提取状态文件中输出值的值。</p>
<h2 id="1-7-13-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.13.1.1. 用法</h2>
<p><code>terraform output [options] [NAME]</code></p>
<p>如果不添加参数，<code>output</code> 命令会展示根模块内定义的所有输出值。如果指定了 <code>NAME</code>，只会输出相关输出值。</p>
<p>可以使用以下参数：</p>
<ul>
<li><code>-json</code>：设置该参数后 Terraform 会使用 JSON 格式输出。如果指定了 <code>NAME</code>，只会输出相关输出值。该参数搭配 <code>jq</code> 使用可以构建复杂的流水线</li>
<li><code>-raw</code>：设置该参数后 Terraform 会将指定的输出值转换为字符串，并将该字符串直接打印到输出中，不带任何特殊格式。这在使用 shell 脚本时很方便，但它仅支持字符串、数字和布尔值。处理复杂的数据类型时还请使用 <code>-json</code>。</li>
<li><code>-no-color</code>：不输出颜色</li>
<li><code>-state=path</code>：状态文件的路径，默认为 <code>terraform.tfstate</code>。启用远程 Backend 时该参数无效</li>
</ul>
<p><strong>注意</strong>：设置 <code>-json</code> 或 <code>-raw</code> 参数时，Terraform 状态中的任何敏感值都将以纯文本显示。有关详细信息，请参阅状态中的<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%BE%93%E5%87%BA%E4%B8%AD%E9%9A%90%E8%97%8F%E5%80%BC-sensitive">敏感数据</a>。</p>
<h2 id="1-7-13-1-2-样例"><a href="#%E6%A0%B7%E4%BE%8B"></a>1.7.13.1.2. 样例</h2>
<p>假设有如下输出值代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">output &quot;instance_ips&quot; &#123;</span><br><span class="line">  value = aws_instance.web.*.public_ip</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;lb_address&quot; &#123;</span><br><span class="line">  value = aws_alb.web.public_dns</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;password&quot; &#123;</span><br><span class="line">  sensitive = true</span><br><span class="line">  value = var.secret_password</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>列出所有输出值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ terraform output</span><br><span class="line">instance_ips = [</span><br><span class="line">  <span class="string">&quot;54.43.114.12&quot;</span>,</span><br><span class="line">  <span class="string">&quot;52.122.13.4&quot;</span>,</span><br><span class="line">  <span class="string">&quot;52.4.116.53&quot;</span></span><br><span class="line">]</span><br><span class="line">lb_address = <span class="string">&quot;my-app-alb-1657023003.us-east-1.elb.amazonaws.com&quot;</span></span><br><span class="line">password = &lt;sensitive&gt;</span><br></pre></td></tr></table></figure>
<p>注意password输出值定义了sensitive = true，所以它的值在输出时会被隐藏：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform output password</span><br><span class="line">password = &lt;sensitive&gt;</span><br></pre></td></tr></table></figure>
<p>要查询负载均衡的DNS地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform output lb_address</span><br><span class="line">my-app-alb-1657023003.us-east-1.elb.amazonaws.com</span><br></pre></td></tr></table></figure>
<p>查询所有主机的IP：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform output instance_ips</span><br><span class="line"><span class="built_in">test</span> = [</span><br><span class="line">    54.43.114.12,</span><br><span class="line">    52.122.13.4,</span><br><span class="line">    52.4.116.53</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>使用-json和jq查询指定主机的ip：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform output -json instance_ips | jq <span class="string">&#x27;.value[0]&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-7-13-1-3-在自动化环境下运行-terraform-output-命令"><a href="#%E5%9C%A8%E8%87%AA%E5%8A%A8%E5%8C%96%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%BF%90%E8%A1%8C-terraform-output-%E5%91%BD%E4%BB%A4"></a>1.7.13.1.3. 在自动化环境下运行 terraform output 命令</h2>
<p><code>terraform output</code> 命令默认以便于人类阅读的格式显示，该格式可以随着时间的推移而改变以提高易读性。</p>
<p>对于脚本编写和自动化，请使用 <code>-json</code> 生成稳定的 JSON 格式。您可以使用 JSON 命令行解析器（例如 <a target="_blank" rel="noopener" href="https://stedolan.github.io/jq/"><code>jq</code></a>）解析输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">terraform output -json instance_ips | jq -r <span class="string">&#x27;.[0]&#x27;</span></span></span><br><span class="line">54.43.114.12</span><br></pre></td></tr></table></figure>
<p>如果要在 shell 脚本中直接使用字符串值，可以转而使用 <code>-raw</code> 参数，它将直接打印字符串，没有额外的转义或空格。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">terraform output -raw lb_address</span></span><br><span class="line">my-app-alb-1657023003.us-east-1.elb.amazonaws.com</span><br></pre></td></tr></table></figure>
<p><code>-raw</code> 选项仅适用于 Terraform 可以自动转换为字符串的值。处理复杂类型的值（例如对象）时还请改用 <code>-json</code>（可以与 <code>jq</code> 结合使用）。</p>
<p>Terraform 字符串是 Unicode 字符序列而不是原始字节，因此 <code>-raw</code> 输出在包含非 ASCII 字符时将采用 UTF-8 编码。如果您需要不同的字符编码，请使用单独的命令（例如 <code>iconv</code>）对 Terraform 的输出进行转码。</p>
<ul>
<li>
<p><a href="#plan"><strong>1.7.14.1.</strong> plan</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.14.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#plan-%E6%A8%A1%E5%BC%8F"><strong>1.7.14.1.2.</strong> Plan 模式</a></p>
</li>
<li>
<p><a href="#plan-%E9%80%89%E9%A1%B9"><strong>1.7.14.1.3.</strong> Plan 选项</a></p>
</li>
<li>
<p><a href="#%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F"><strong>1.7.14.1.4.</strong> 在命令行中输入变量</a></p>
</li>
<li>
<p><a href="#%E8%B5%84%E6%BA%90%E5%AE%9A%E4%BD%8D"><strong>1.7.14.1.5.</strong> 资源定位</a></p>
</li>
<li>
<p><a href="#%E5%85%B6%E4%BB%96%E9%80%89%E9%A1%B9"><strong>1.7.14.1.6.</strong> 其他选项</a></p>
</li>
<li>
<p><a href="#%E6%8C%87%E5%AE%9A%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"><strong>1.7.14.1.7.</strong> 指定其他配置文件目录</a></p>
</li>
<li>
<p><a href="#%E5%AE%89%E5%85%A8%E8%AD%A6%E5%91%8A"><strong>1.7.14.1.8.</strong> 安全警告</a></p>
</li>
</ul>
<p><a href="#plan"></a></p>
<h2 id="1-7-14-1-plan"><a href="#plan"></a>1.7.14.1. plan</h2>
<p><code>terraform plan</code> 命令被用来创建变更计划。Terraform 会先运行一次 <code>refresh</code>(我们后面的章节会介绍，该行为也可以被显式关闭)，然后决定要执行哪些变更使得现有状态迁移到代码描述的期待状态。</p>
<p>该命令可以方便地审查状态迁移的所有细节而不会实际更改现有资源以及状态文件。例如，在将代码提交到版本控制系统前可以先执行 <code>terraform plan</code>，确认变更行为如同预期一般。</p>
<p>如果您直接在交互式终端中使用 Terraform 并且希望执行 Terraform 所提示的变更，您也可以直接运行 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/4.apply"><code>terraform apply</code></a>。默认情况下，<code>apply</code> 命令会自动生成新计划并提示您批准它。</p>
<p>可选参数 <code>-out</code> 可以将变更计划保存在一个文件中，以便日后使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/4.apply"><code>terraform apply</code></a> 命令来执行该计划。</p>
<p>在使用版本控制和代码审查工作流程对实际基础架构进行更改的团队中，开发人员可以使用保存下来的的计划文件来验证更改的效果，然后再对提交的变更进行代码审查。但是，要慎重考虑考虑对目标系统同时进行的其他更改可能会导致配置更改的最终效果与早期保存的计划所指示的不同，因此您应该始终重新检查最终的实际执行的计划，在执行之前确保它仍然符合您的意图。</p>
<p>如果 Terraform 检测不到任何变更，那么 <code>terraform plan</code> 会提示没有任何需要执行的变更。</p>
<h2 id="1-7-14-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.14.1.1. 用法</h2>
<p><code>terraform plan [options]</code></p>
<p><code>plan</code> 命令在当前工作目录中查找根模块配置。</p>
<p>由于 <code>plan</code> 命令是 Terraform 的主要命令之一，因此它有多种不同的选项，如下部分所述。但是，大多数时候我们不需要设置这些选项，因为 Terraform 配置通常应设计为无需特殊的附加选项即可进行日常工作。</p>
<p><code>plan</code> 命令的参数选项可以分为以下三大类</p>
<ul>
<li><a href="#plan-%E6%A8%A1%E5%BC%8F">Plan 模式</a>：当我们的目标不仅仅是更改远程系统以匹配代码配置时，我们可以在某些特殊情况下使用一些特殊的替代规划模式。</li>
<li><a href="#plan-%E9%80%89%E9%A1%B9">Plan 选项</a>：除了特殊的 Plan 模式之外，我们还可以设置一些选项，以便根据特殊的需求来定制计划流程。</li>
<li><a href="#%E5%85%B6%E4%BB%96%E9%80%89%E9%A1%B9">其他选项</a>：这些选项改变了规划命令本身的行为，而不是定制生成的计划的内容。</li>
</ul>
<h2 id="1-7-14-1-2-Plan-模式"><a href="#plan-%E6%A8%A1%E5%BC%8F"></a>1.7.14.1.2. Plan 模式</h2>
<p>上一节描述了 Terraform 的默认规划变更计划行为，该行为会变更远程系统以匹配我们对配置代码所做的更改。 Terraform 还有两种不同的规划模式，每种模式都会创建具有不同预期结果的计划。这些选项可用于 <code>terraform plan</code> 和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/4.apply"><code>terraform apply</code></a>。</p>
<ul>
<li>
<p><strong>Destroy 模式</strong>：创建一个计划，其目的是销毁当前存在的所有远程对象，留下空的 Terraform 状态。这与运行 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/6.destroy"><code>terraform destroy</code></a> 相同。销毁模式对于临时的开发环境等情况非常有用，在这种情况下，一旦开发任务完成，托管对象就不再需要保留。</p>
<p>通过 <code>-destroy</code> 命令行选项启用销毁模式。</p>
</li>
<li>
<p><strong>Refresh-Only 模式</strong>：创建一个计划，其目标仅是更新 Terraform 状态和所有根模块的输出值，以匹配对 Terraform 外部远程对象所做的更改。如果您使用 Terraform 之外的工具更改了一个或多个远程对象（例如，在响应事件时），并且您现在需要使 Terraform 的记录与这些更改保持一致，那么该命令会很有帮助。</p>
<p>使用 <code>-refresh-only</code> 命令行选项启用 Refresh-Only 模式。</p>
</li>
</ul>
<p>相对而言，我们把 Terraform 在未选择任何替代模式时使用的默认规划模式的情况下的行为称为“正常模式”。由于上述的替代模式仅适用于特殊情况，因此其他一些 Terraform 文档仅讨论正常规划模式。</p>
<p>Plan 模式都是互斥的，因此启用任何非默认 Plan 模式时都会禁用“正常”计划模式，并且我们不能同时使用多种替代模式。</p>
<p><strong>注意</strong>：在 Terraform v0.15 及更早版本中，只有 <code>terraform plan</code> 命令支持 <code>-destroy</code> 选项，<code>terraform apply</code> 命令是不支持的。要在早期版本中以 Destroy 模式创建并应用计划，我们必须运行 <code>terraform destroy</code>。另外，<code>-refresh-only</code> 选项仅在 Terraform v0.15.4 及之后的版本中可用。</p>
<h2 id="1-7-14-1-3-Plan-选项"><a href="#plan-%E9%80%89%E9%A1%B9"></a>1.7.14.1.3. Plan 选项</h2>
<p>相较于 <a href="#plan-%E6%A8%A1%E5%BC%8F">Plan 模式</a>，还有一些可以用来更改规划行为的参数选项。</p>
<ul>
<li><code>-refresh=false</code>：在检查配置更改之前跳过同步 Terraform 状态与远程对象的默认行为。这可以减少远程 API 请求的数量，加快规划操作的速度。但是，设置 <code>refresh=false</code> 会导致 Terraform 忽略外部更改，这可能会导致计划不完整或不正确。您不能在 Refresh Only 计划模式中使用 <code>refresh=false</code>，因为这将导致什么都不做。</li>
<li><code>-replace=ADDRESS</code> - 命令 Terraform 在计划中替换给定地址的资源实例。当一个或多个远程对象降级时，这非常有用，并且我们可以替换成具有相同配置的对象来与不可变的基础架构模式保持一致。如果指定的资源在计划中存在“更新”操作或没有变化，则 Terraform 将使用“替换”操作。多次包含此选项可一次替换多个对象。您不能将 <code>-replace</code> 与 <code>-destroy</code> 选项一起使用，并且该功能仅从 Terraform v0.15.2 开始可用。对于早期版本，使用 <code>terraform taint</code> 来实现类似的结果。</li>
<li><code>-target=ADDRESS</code> - 命令 Terraform 只计算给定地址匹配的资源实例以及这些实例所依赖的任何对象的变更。 <strong>注意</strong>：应该仅在特殊情况下使用 <code>-target=ADDRESS</code>，例如从错误中恢复或绕过 Terraform 限制。有关更多详细信息，请参阅<a href="#%E8%B5%84%E6%BA%90%E5%AE%9A%E4%BD%8D">资源定位</a>。</li>
<li><code>-var 'NAME=VALUE'</code> - 设置在配置的根模块中声明的单个<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/3.3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F.md">输入变量</a>的值。多次设置该选项可设置多个变量。有关详细信息，请参阅<a href="#%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F">在命令行中输入变量</a>。</li>
<li><code>-var-file=FILENAME</code> - 使用 <code>tfvars</code> 文件中的定义为配置的根模块中声明的潜在多个输入变量设置值。多次设置该选项可包含多个文件中的值。</li>
</ul>
<p>除了 <code>-var</code> 和 <code>-var-file</code> 选项之外，还有其他几种方法可以在根模块中设置输入变量的值。有关详细信息，请参阅为<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%AF%B9%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F%E8%B5%8B%E5%80%BC">根模块输入变量赋值</a>。</p>
<h2 id="1-7-14-1-4-在命令行中输入变量"><a href="#%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F"></a>1.7.14.1.4. 在命令行中输入变量</h2>
<p>我们可以使用 <code>-var</code> 命令行选项来指定根模块中声明的输入变量的值。</p>
<p>然而，要做到这一点，需要编写一个可由您选择的 shell 和 Terraform 解析的命令，对于涉及大量引号和转义序列的表达式来说这可能会很复杂。在大多数情况下，我们建议改用 <code>-var-file</code> 选项，并将实际值写入单独的文件中，以便 Terraform 可以直接解析它们，而不是解释 shell 解析后的结果。</p>
<p><strong>警告</strong>：如果在等号之前或之后包含空格（例如 -var “length = 2”），Terraform 将报错。</p>
<p>要在 Linux 或 macOS 等系统上的 Unix 风格 shell 上使用 <code>-var</code>，我们建议将选项参数写在单引号 <code>'</code> 中，以确保 shell 按字面解释该值：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform plan -var &#x27;name=value&#x27;</span><br></pre></td></tr></table></figure>
<p>如果我们的预期值还包含单引号，那么我们仍然需要对其进行转义，以便 shell 进行正确解释，这还需要暂时终止引号序列，以便反斜杠转义字符合法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform plan -var &#x27;name=va&#x27;\&#x27;&#x27;lue&#x27;</span><br></pre></td></tr></table></figure>
<p>在 Windows 上使用 Terraform 时，我们建议使用 Windows 命令提示符 (cmd.exe)。当您从 Windows 命令提示符将变量值传递给 Terraform 时，请在参数周围使用双引号 <code>&quot;</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform plan -var &quot;name=value&quot;</span><br></pre></td></tr></table></figure>
<p>如果我们的预期值还包含双引号，那么您需要用反斜杠转义它们：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform plan -var &quot;name=va\&quot;lue&quot;</span><br></pre></td></tr></table></figure>
<p>Windows 上的 PowerShell 无法正确地将文字引号传递给外部程序，因此我们不建议您在 Windows 上时将 Terraform 与 PowerShell 结合使用。请改用 Windows 命令提示符。</p>
<p>根据变量的<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/1.%E7%B1%BB%E5%9E%8B">类型约束</a>，声明变量值的语法有所不同。原始类型 <code>string</code>、<code>number</code> 和 <code>bool</code> 对应一个直接的字符串值，除非您的 shell 如上面的示例所示需要，否则不需要添加特殊的标点符号。对于所有其他类型约束，包括 <code>list</code>、<code>map</code> 和 <code>set</code> 类型以及特殊的 <code>any</code> 关键字，您必须编写一个表示该值的有效 Terraform 语言表达式，并附带必要的引用或转义字符以确保它将通过您的 shell 逐字传递到 Terraform。例如，对于 <code>list(string)</code> 类型约束：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Unix-style shell</span></span><br><span class="line">terraform plan -var &#x27;name=[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Windows Command Prompt (<span class="keyword">do</span> not use PowerShell on Windows)</span></span><br><span class="line">terraform plan -var &quot;name=[\&quot;a\&quot;, \&quot;b\&quot;, \&quot;c\&quot;]&quot;</span><br></pre></td></tr></table></figure>
<p>使用环境变量设置输入变量时也适用类似的约束。有关设置根模块输入变量的各种方法的更多信息，请参阅为<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%AF%B9%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F%E8%B5%8B%E5%80%BC">根模块变量赋值</a>。</p>
<h2 id="1-7-14-1-5-资源定位"><a href="#%E8%B5%84%E6%BA%90%E5%AE%9A%E4%BD%8D"></a>1.7.14.1.5. 资源定位</h2>
<p>我们可以使用 <code>-target</code> 选项将 Terraform 的计算范围仅集中在少数资源上。我们可以使用<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/3.%E8%B5%84%E6%BA%90%E5%9C%B0%E5%9D%80">资源地址</a>语法来指定约束。Terraform 对代码中的资源地址的解释行为如下：</p>
<ul>
<li>如果给定地址定位了一个特定资源实例，Terraform 将单独选择该实例。对于设置了 <code>count</code> 或 <code>for_each</code> 的资源，资源实例地址必须包含实例索引部分，例如 <code>azurerm_resource_group.example[0]</code>。</li>
<li>如果给定的地址对应到一个资源整体（即表达式中不含索引部分），Terraform 将选择该资源的所有实例。对于设置了 <code>count</code> 或 <code>for_each</code> 的资源，这意味着选择当前与该资源关联的所有实例索引。对于单实例资源（没有 <code>count</code> 或 <code>for_each</code>），资源地址和资源实例地址相同，因此这种可能性不适用。</li>
<li>如果给定的地址标识整个 Module 实例，Terraform 将选择属于该 Module 实例及其所有子 Module 实例的所有资源的所有实例。</li>
</ul>
<p>一旦 Terraform 选择了我们直接定位的一个或多个资源实例，它还会扩展选择范围以包括这些选择直接或间接依赖的所有其他对象。</p>
<p>这种资源定位功能是为某些特殊情况设计的，例如从故障中恢复或绕过 Terraform 的某些限制。不建议将 <code>-target</code> 用于常规操作，因为这可能会导致未检测到的配置漂移以及对资源真实状态与配置的关系的混淆。</p>
<p>与其使用 <code>-target</code> 作为对非常庞大的配置的一小部分子集进行操作的方法，不如将大型配置分解为多个较小的配置，每个配置都可以独立应用。<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/7.%E6%95%B0%E6%8D%AE%E6%BA%90">数据源</a>可用于访问有关在其他配置中创建的资源的信息，从而允许将复杂的系统架构分解为更易于管理且可以独立更新的部分。</p>
<h2 id="1-7-14-1-6-其他选项"><a href="#%E5%85%B6%E4%BB%96%E9%80%89%E9%A1%B9"></a>1.7.14.1.6. 其他选项</h2>
<p><code>terraform plan</code> 命令还有一些与规划命令的输入和输出相关的其他选项，这些配置不会影响 Terraform 将创建哪种类型的计划。这些命令不一定在 <code>terraform apply</code> 上也可用，除非该命令的文档中另有说明。</p>
<ul>
<li>
<p><code>-compact-warnings</code>：如果 Terraform 生成了一些告警信息而没有伴随的错误信息，那么以只显示消息总结的精简形式展示告警</p>
</li>
<li>
<p><code>-detailed-exitcode</code>：当命令退出时返回一个详细的返回码。如果有该参数，那么返回码将会包含更详细的含义：</p>
</li>
<li>
<p>0 = 成功的空计划(没有变更)</p>
</li>
<li>
<p>1 = 错误</p>
</li>
<li>
<p>2 = 成功的非空计划(有变更)</p>
</li>
<li>
<p><code>-generate-config-out=PATH</code> -（实验功能）如果配置中存在 <code>import</code> 块，则命令 Terraform 为尚未存在的任何导入资源生成 HCL。配置将写入 <code>PATH</code> 位置的新文件，该文件<strong>不可以</strong>存在，否则 Terraform 将报错。如果 <code>plan</code> 命令因为其他原因失败，Terraform 仍可能尝试写入配置。</p>
</li>
<li>
<p><code>-input=false</code>：在取不到值的情况下是否提示用户给定输入变量值。此参数在非交互式自动化系统中运行 Terraform 时特别有用。</p>
</li>
<li>
<p><code>-lock=false</code>：操作过程中不对状态文件上锁。如果其他人可能同一时间对同一工作区运行命令可能引发事故。</p>
</li>
<li>
<p><code>-lock-timeout=DURATION</code>：除非使用 <code>-lock=false</code> 禁用锁定，否则指示 Terraform 在返回错误之前重试获取锁定一段时间。持续时间语法是一个数字后跟一个时间单位字母，例如 <code>&quot;3s&quot;</code> 表示三秒。</p>
</li>
<li>
<p><code>-no-color</code>：关闭彩色输出。在无法解释输出色彩的终端中运行 Terraform 时请使用此参数。</p>
</li>
<li>
<p><code>-out=FILENAME</code>：将变更计划保存到指定路径下的文件中，随后我们可以使用terraform apply执行该计划</p>
<p>Terraform 将允许计划文件使用任何文件名，但典型的约定是将其命名为 <code>tfplan</code>。请<strong>不要</strong>使用 Terraform 支持的后缀名来命名文件；如果您使用 <code>.tf</code> 后缀，那么 Terraform 将尝试将该文件解释为配置源文件，这将导致后续命令出现语法错误。</p>
</li>
<li>
<p><code>-parallelism-n</code>：限制Terraform遍历图的最大并行度，默认值为 <code>10</code>。</p>
</li>
</ul>
<h2 id="1-7-14-1-7-指定其他配置文件目录"><a href="#%E6%8C%87%E5%AE%9A%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"></a>1.7.14.1.7. 指定其他配置文件目录</h2>
<p>Terraform v0.13 及更早版本接受提供目录路径的附加位置参数，在这种情况下，Terraform 将使用该目录作为根模块而不是当前工作目录。</p>
<p>该用法在 Terraform v0.14 中已弃用，并在 Terraform v0.15 中删除。如果您的工作流程需要修改根模块目录，请改用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/index#%E9%80%9A%E8%BF%87--chdir-%E5%8F%82%E6%95%B0%E5%88%87%E6%8D%A2%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><code>-chdir</code> 全局选项</a>，该选项适用于所有命令，并使 Terraform 始终在给定目录中查找它通常在当前工作目录中读取或写入的所有文件。</p>
<p>如果我们之前使用此遗留模式时同时需要 Terraform 将 <code>.terraform</code> 子目录写入当前工作目录，即使根模块目录已被覆盖，请使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/2.%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F#tf_data_dir"><code>TF_DATA_DIR</code> 环境变量</a>命令 Terraform 将 <code>.terraform</code> 目录写入其他位置，而不是当前工作目录。</p>
<h2 id="1-7-14-1-8-安全警告"><a href="#%E5%AE%89%E5%85%A8%E8%AD%A6%E5%91%8A"></a>1.7.14.1.8. 安全警告</h2>
<p>被保存的变更计划文件(使用 <code>-out</code> 参数)内部可能含有敏感信息，Terraform 本身并不会加密计划文件。如果你要移动或是保存该文件一段时间，强烈建议你自行加密该文件。</p>
<p>Terraform 未来打算增强计划文件的安全性。</p>
<ul>
<li>
<p><a href="#providers"><strong>1.7.15.1.</strong> providers</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.15.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#providers"></a></p>
<h2 id="1-7-15-1-providers"><a href="#providers"></a>1.7.15.1. providers</h2>
<p><code>terraform providers</code> 命令显示有关当前工作目录中代码的 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/2.Terraform%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/1.Provider#provider-%E7%9A%84%E5%A3%B0%E6%98%8E">Provider 声明</a>的信息，以帮助我们了解每个被需要的 Provider 是从何而来。</p>
<p>该命令是含有内嵌子命令，这些子命令我们会逐个解释。</p>
<h2 id="1-7-15-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.15.1.1. 用法</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform providers</span><br></pre></td></tr></table></figure>
<h2 id="mirror"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">mirror</a></h2>
<ul>
<li>
<p><a href="#terraform-providers-mirror"><strong>1.7.15.1.1.</strong> terraform providers mirror</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.15.1.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#terraform-providers-mirror"></a></p>
<h2 id="1-7-15-1-1-terraform-providers-mirror"><a href="#terraform-providers-mirror"></a>1.7.15.1.1. terraform providers mirror</h2>
<p>该子命令从 Terraform 0.13 开始引入。</p>
<p><code>terraform providers mirror</code> 命令下载当前代码所需要的 Provider 并且将其拷贝到本地文件系统的一个目录下。</p>
<p>一般情况下，<code>terraform init</code> 会在初始化当前工作目录时自动从 registry 下载所需的 Provider。有时 Terraform 工作在无法执行该操作的环境下，例如一个无法访问 registry 的局域网内。这时可以通过<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/1.%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6#%E6%98%BE%E5%BC%8F%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E9%85%8D%E7%BD%AE">显式配置 Provider 安装方式</a>来使得在这样的环境下 Terraform 可以从本地插件镜像存储中获取插件。</p>
<p><code>terraform providers mirror</code> 命令可以自动填充准备用以作为本地插件镜像存储的目录。</p>
<h2 id="1-7-15-1-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.15.1.1.1. 用法</h2>
<p><code>terraform providers mirror [options] &lt;target-dir&gt;</code></p>
<p><code>target-dir</code> 参数是必填的。Terraform 会自动在目标目录下建立起插件镜像存储所需的文件结构，填充包含插件文件的 <code>.zip</code> 文件。</p>
<p>Terraform同时会生成一些包含了合法的<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/internals/provider-network-mirror-protocol">网络镜像协议</a>响应的 <code>.json</code> 索引文件，如果我们把填充好的文件夹上传到一个静态站点，那就能够得到一个静态的网络插件镜像存储服务。Terraform 在使用本地文件镜像存储时会忽略这些镜像文件，因为使用本地文件镜像时文件夹本身的信息更加权威。</p>
<p>该命令支持如下可选参数：</p>
<ul>
<li>
<p><code>-platform=OS_ARCH</code>：选择构建镜像的目标平台。默认情况下，Terraform 会使用当前运行 Terraform 的平台。可以多次设置该参数以构建多目标平台插件镜像</p>
<p>目标平台必须包含操作系统以及 CPU 架构。例如：<code>linux_amd64</code> 代表运行在 AMD64 或是 X86_64 CPU 之上的 Linux 操作系统。</p>
</li>
</ul>
<p>我们可以针对已构建的镜像文件夹重新运行 <code>terraform providers mirror</code> 来添加新插件。例如，可以通过设置 <code>-platform</code> 参数来添加新目标平台的插件，Terraform 会下载新平台插件同时保留原先的插件，将二者合并存储，并更新索引文件。</p>
<h2 id="schema"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">schema</a></h2>
<ul>
<li>
<p><a href="#terraform-providers-schema"><strong>1.7.15.2.1.</strong> terraform providers schema</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.15.2.1.1.</strong> 用法</a></p>
</li>
</ul>
<p><a href="#terraform-providers-schema"></a></p>
<h2 id="1-7-15-2-1-terraform-providers-schema"><a href="#terraform-providers-schema"></a>1.7.15.2.1. terraform providers schema</h2>
<p><code>terraform providers schema</code> 命令被用来打印当前代码使用的 Provider 的架构。Provider 架构包含了使用的所有 Provider 本身的参数信息，以及所提供的 <code>resource</code>、<code>data</code> 的架构信息。</p>
<h2 id="1-7-15-2-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.15.2.1.1. 用法</h2>
<p><code>terraform providers schema [options]</code></p>
<p>可选参数为：</p>
<ul>
<li><code>-json</code>：用机器可读的 JSON 格式打印架构</li>
</ul>
<p>请注意，目前 <code>-json</code> 参数是必填的，未来该命令将允许使用其他参数。</p>
<p>输出包含一个 <code>format_version</code> 键，就拿 Terraform 1.1.0 来说，其值为 <code>&quot;1.0&quot;</code>。该版本的语义是：</p>
<ul>
<li>对于向后兼容的变更或新增字段，我们将增加 minor 版本号，例如 <code>&quot;1.1&quot;</code>。这种变更会忽略所有不认识的对象属性，以保持与未来其他 minor 版本的前向兼容。</li>
<li>对于不向后兼容的变更，我们将增加 major 版本，例如 <code>&quot;2.0&quot;</code>。不同的 major 版本之间的数据无法直接传递。</li>
</ul>
<p>我们只会在 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/v1-compatibility-promises">Terraform 1.0 兼容性承诺</a>的范围内更新 major 版本。</p>
<ul>
<li>
<p><a href="#terraform-providers-lock"><strong>1.7.15.3.1.</strong> terraform providers lock</a></p>
</li>
<li>
<p><a href="#%E7%94%A8%E6%B3%95"><strong>1.7.15.3.1.1.</strong> 用法</a></p>
</li>
<li>
<p><a href="#%E6%8C%87%E5%AE%9A%E7%9B%AE%E6%A0%87%E5%B9%B3%E5%8F%B0"><strong>1.7.15.3.1.2.</strong> 指定目标平台</a></p>
</li>
<li>
<p><a href="#%E5%86%85%E9%83%A8-providers-%E7%9A%84%E9%94%81%E6%9D%A1%E7%9B%AE"><strong>1.7.15.3.1.3.</strong> 内部 Providers 的锁条目</a></p>
</li>
</ul>
<p><a href="#terraform-providers-lock"></a></p>
<h2 id="1-7-15-3-1-terraform-providers-lock"><a href="#terraform-providers-lock"></a>1.7.15.3.1. terraform providers lock</h2>
<p><code>terraform providers lock</code> 会查询上游 registry（默认情况下），以便将 Provider 的依赖项信息写入<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/4.Terraform%E6%96%87%E4%BB%B6%E4%B8%8E%E7%9B%AE%E5%BD%95/2.%E4%BE%9D%E8%B5%96%E9%94%81%E6%96%87%E4%BB%B6.html">依赖项锁文件</a>。</p>
<p>更新依赖项锁定文件的常见方法是由 <code>terraform init</code> 命令安装 Provider 时生成，但在某些情况下，这种自动生成的方法可能不够：</p>
<ul>
<li>
<p>如果您在使用其他 Provider 程序安装方法（例如文件系统或网络镜像）的环境中运行 Terraform，则常规的 Provider 安装程序将不会访问 Provider 程序在 Registry 上的源，因此 Terraform 将无法填充所有可能的包校验和选定的 Provider 版本。</p>
<p>如果您使用 <code>terraform lock</code> 将 Provider 程序的官方版本校验和写入依赖项锁定文件中，则将来的 <code>terraform init</code> 运行将根据之前记录的官方校验和验证所选镜像中可用的软件包，从而进一步确保镜像返回的 Provider 程序的确是官方版本。</p>
</li>
<li>
<p>如果您的团队在多个不同平台上运行 Terraform（例如在 Windows 和 Linux 上），并且 Provider 的上游 Registry 无法使用最新的哈希方案提供签名的校验和，则后续在其他平台上运行 Terraform 可能会添加额外的校验和锁定文件。您可以通过使用 <code>terraform providers lock</code> 命令为您打算使用的所有平台预先填充哈希值来避免这种情况。</p>
</li>
</ul>
<p><code>terraform providers lock</code> 仅在 Terraform v0.14 或更高版本中可用。</p>
<h2 id="1-7-15-3-1-1-用法"><a href="#%E7%94%A8%E6%B3%95"></a>1.7.15.3.1.1. 用法</h2>
<p><code>terraform providers lock [options] [providers...]</code></p>
<p>在没有额外的命令行参数的情况下，<code>terraform providers lock</code> 将分析当前工作目录中的代码，以查找它所依赖的所有 Provider 程序，并且将从其源 Registry 中获取有关这些 Provider 程序的关键数据，然后更新<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/4.Terraform%E6%96%87%E4%BB%B6%E4%B8%8E%E7%9B%AE%E5%BD%95/2.%E4%BE%9D%E8%B5%96%E9%94%81%E6%96%87%E4%BB%B6.html">依赖项锁文件</a>，写入所有选定的 Provider 程序版本以及 Provider 程序开发人员的私钥签名的包校验和。</p>
<p><strong>警告</strong>：<code>terraform providers lock</code> 命令会打印有关其获取的内容以及每个包是否使用加密签名进行签名的信息，但它无法自动验证 Provider 提供者是否值得信赖以及它们是否符合您的本地系统策略或相关法规。在将更新的锁定文件提交到版本控制系统之前，请检查输出中的签名密钥信息，以确认您信任所有签名者。</p>
<p>如果您在命令行上列出一个或多个 Provider 程序源地址，则 <code>terraform providers lock</code> 将其工作仅限于这些提供程序，而其他提供程序（如果有的话）的锁定条目保持不变。</p>
<p>我们可以使用以下附加选项定制该命令的行为：</p>
<ul>
<li>
<p><code>-fs-mirror=PATH</code> - 命令 Terraform 在给定的本地文件系统镜像目录中查找提供程序包，而不是在上游注册表中。给定目录必须使用通常的文件系统镜像目录布局。</p>
</li>
<li>
<p><code>-net-mirror=URL</code> - 命令 Terraform 在给定的网络镜像服务中查找提供程序包，而不是在上游注册表中。给定的 URL 必须实现 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/internals/provider-network-mirror-protocol">Terraform Provider 网络镜像协议</a>。</p>
</li>
<li>
<p><code>-platform=OS_ARCH</code> - 设置打算用于处理此 Terraform 配置的平台。Terraform 将确保 Provider 程序均可用于指定的平台，并将在锁文件中保存足够的包校验和以至少支持指定的平台。</p>
<p>可以多次设置此选项以包含多个目标系统的校验和。</p>
<p>目标平台名称由操作系统和 CPU 架构组成。例如，linux_amd64 选择在 AMD64 或 x86_64 CPU 上运行的 Linux 操作系统。</p>
<p>我们将在后续节中讲述有关于此参数的更多详细信息。</p>
</li>
<li>
<p><code>-enable-plugin-cache</code> - 启用<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/1.%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.html#provider-%E6%8F%92%E4%BB%B6%E7%BC%93%E5%AD%98">全局配置的插件缓存</a>的使用。这将加快锁定过程。默认情况下不启用此功能，因为插件缓存不是权威来源。由于 <code>terraform providers lock</code> 命令用于确保使用受信任的 Provider 程序版本，因此从缓存安装插件被认为是有风险的。</p>
</li>
</ul>
<h2 id="1-7-15-3-1-2-指定目标平台"><a href="#%E6%8C%87%E5%AE%9A%E7%9B%AE%E6%A0%87%E5%B9%B3%E5%8F%B0"></a>1.7.15.3.1.2. 指定目标平台</h2>
<p>例如，在我们的团队中可能既有在 Windows 或 macOS 工作站上使用 Terraform 配置的开发人员，也有在 Linux 上运行 Terraform 配置的自动化系统。</p>
<p>在这种情况下，我们可以选择验证所有 Provider 程序是否支持所有这些平台，并通过运行 <code>terraform providers lock</code> 并指定这三个平台来预先填充锁文件所需的校验和：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">terraform providers lock \</span><br><span class="line">  -platform=windows_amd64 \ # 64-bit Windows</span><br><span class="line">  -platform=darwin_amd64 \  # 64-bit macOS</span><br><span class="line">  -platform=linux_amd64     # 64-bit Linux</span><br></pre></td></tr></table></figure>
<p>（上面的示例使用 Unix 风格的 shell 包装语法来提高可读性。如果您在 Windows 上运行该命令，则需要将所有参数放在一行上，并删除反斜杠和注释。）</p>
<h2 id="1-7-15-3-1-3-内部-Providers-的锁条目"><a href="#%E5%86%85%E9%83%A8-providers-%E7%9A%84%E9%94%81%E6%9D%A1%E7%9B%AE"></a>1.7.15.3.1.3. 内部 Providers 的锁条目</h2>
<p>所谓<em>内部 Provider 程序</em>是还没有在真正的 Terraform Provider 注册表上发布的 Provider 程序，因为它仅在特定组织内开发和使用，并通过文件系统镜像或网络镜像进行分发。</p>
<p>默认情况下，<code>terraform providers lock</code> 命令假定所有 Provider 程序都是在 Terraform Provider 程序注册表中可用，并尝试联系源注册表以访问有关提供程序包的所有细节信息。</p>
<p>要为仅在本地镜像中可用的特定 Provider 程序创建锁定条目，可以使用 <code>-fs-mirror</code> 或 <code>-net-mirror</code> 命令行选项来覆盖查询 Provider 程序的原始注册表的默认行为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">terraform providers lock \</span><br><span class="line">  -fs-mirror=/usr/local/terraform/providers</span><br><span class="line">  -platform=windows_amd64 \</span><br><span class="line">  -platform=darwin_amd64 \</span><br><span class="line">  -platform=linux_amd64 \</span><br><span class="line">  tf.example.com/ourcompany/ourplatform</span><br></pre></td></tr></table></figure>
<p>（上面的示例使用 Unix 风格的 shell 包装语法来提高可读性。如果您在 Windows 上运行该命令，则需要将所有参数放在一行上，并删除反斜杠和注释。）</p>
<p>由于上面的命令包含 Provider 程序源地址 <code>tf.example.com/ourcompany/ourplatform</code>，因此 <code>terraform providers lock</code> 将仅尝试访问该特定 Provider 程序，并将保留所有其他 Provider 程序的锁条目不变。如果我们有来自不同来源的各种不同的 Provider 程序，可以多次运行 <code>terraform providers lock</code> 并每次指定不同的 Provider 程序子集。</p>
<p><code>-fs-mirror</code> 和 <code>-net-mirror</code> 选项与 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/1.%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.html#%E6%98%BE%E5%BC%8F%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E9%85%8D%E7%BD%AE">Provider 程序安装方法配置</a>中的 <code>filesystem_mirror</code> 和 <code>network_mirror</code> 块具有相同的含义，但仅配置其中之一，以便明确您打算从何处派生包校验和信息。</p>
<p>请注意，只有原始注册表可以提供开发人员的原始加密签名所签署的官方校验和。因此，从文件系统或网络镜像创建的锁条目将仅覆盖您请求的确切平台，并且记录的校验和将是镜像报告的校验和，而不是原始注册表的官方校验和。如果要确保记录的校验和是由原始 Provider 发布者签名的校验和，请运行不带 <code>-fs-mirror</code> 或 <code>-net-mirror</code> 选项的此命令，以从原始注册表中获取所有信息。</p>
<p>如果您愿意，您可以通过内部 Provider 程序注册表发布您的内部 Provider 程序，然后该注册表将允许锁定和安装这些 Provider 程序，而无需任何特殊选项或额外的 CLI 配置。有关详细信息，请参阅 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/internals/provider-registry-protocol">Provider 注册协议</a>。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2023/01/26/Teraform/Terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C1/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a
                class="btn btn--default btn--small"
                href="page/2/"
                aria-label="下一頁"
            >
              <span>下一頁</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">第 1 頁 共 5 頁</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Kein Chan. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="../../assets/images/profile.jpg" alt="作者的圖片"/>
        
            <h4 id="about-card-name">Kein Chan</h4>
        
            <div id="about-card-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>全棧工程師</br>資深技術顧問</br>數據科學家</br>Hit廣島觀光大使</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Tokyo/Macau
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="../assets/images/logo-algolia-nebula-blue-full.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">沒有找到文章</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/04/27/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/"
                            aria-label=": R语言-环境安装"
                        >
                            <h3 class="media-heading">R语言-环境安装</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月27日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/04/28/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E5%9F%BA%E7%A1%80/"
                            aria-label=": R语言-基础"
                        >
                            <h3 class="media-heading">R语言-基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月28日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/01/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE/"
                            aria-label=": R语言-读取数据"
                        >
                            <h3 class="media-heading">R语言-读取数据</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月1日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/02/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BB%98%E5%9B%BE/"
                            aria-label=": R语言-绘图"
                        >
                            <h3 class="media-heading">R语言-绘图</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月2日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/03/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/"
                            aria-label=": R语言-线性回归"
                        >
                            <h3 class="media-heading">R语言-线性回归</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月3日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/22/Algorithms/1.%E7%AE%97%E6%B3%95%E5%9C%A8%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8/"
                            aria-label=": 1. 算法在计算中的作用"
                        >
                            <h3 class="media-heading">1. 算法在计算中的作用</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月22日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/23/Algorithms/2.%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/"
                            aria-label=": 2. 算法基础"
                        >
                            <h3 class="media-heading">2. 算法基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/24/Algorithms/3.%E5%87%BD%E6%95%B0%E7%9A%84%E5%A2%9E%E9%95%BF/"
                            aria-label=": 3. 函数的增长"
                        >
                            <h3 class="media-heading">3. 函数的增长</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月24日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/25/Algorithms/4.%E5%88%86%E6%B2%BB%E7%AD%96%E7%95%A5/"
                            aria-label=": 4. 分治策略"
                        >
                            <h3 class="media-heading">4. 分治策略</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月25日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/26/Algorithms/5.%E6%A6%82%E7%8E%87%E5%88%86%E6%9E%90%E5%92%8C%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/"
                            aria-label=": 5. 概率分析和随机算法"
                        >
                            <h3 class="media-heading">5. 概率分析和随机算法</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月26日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="沒有找到文章"
                data-message-one="找到 1 篇文章"
                data-message-other="找到 {n} 篇文章">
                找到 235 篇文章
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('../../assets/images/cover.jpeg');"></div>
        <!--SCRIPTS-->

<script src="../../assets/js/script-qtzvvb63gamuirvfphht7lytrxkfllzng1escnm2phjtlt4tvvxi5gl0wx4o.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
