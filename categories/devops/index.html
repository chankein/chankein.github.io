
<!DOCTYPE html>
<html lang="zh-tw">
    
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    
      <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/locale/zh-tw.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
    <script>
      window.algoliaConfig = {
        appId: 'AWFC86Q51O',
        apiKey: 'c9d952906eb1b154d75cf863e75c1ede',
        indexName: 'MyBlog'
      };
      var algoliaIndex = algoliasearch(
        algoliaConfig.appId,
        algoliaConfig.apiKey
      ).initIndex(algoliaConfig.indexName);
    </script>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Kein&#39;s blog">
    <title>分類: devops - Kein&#39;s blog</title>
    <meta name="author" content="Kein Chan">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Kein&#39;s blog">
<meta property="og:url" content="https://chankein.github.io/categories/devops/index.html">
<meta property="og:site_name" content="Kein&#39;s blog">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Kein Chan">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://chankein.github.io../../assets/images/profile.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="../../assets/css/style-l9zwheso7r7pnk98nvirovsz9dl7fhkrc9mlb5vmuxw7tk5movrk0eevsrpr.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="../../index.html"
            aria-label=""
        >
            Kein&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打開鏈接: ../../#about"
            >
        
        
            <img class="header-picture" src="../../assets/images/profile.jpg" alt="作者的圖片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="../../#about"
                    aria-label="閱讀有關作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="../../assets/images/profile.jpg" alt="作者的圖片"/>
                </a>
                <h4 class="sidebar-profile-name">Kein Chan</h4>
                
                    <h5 class="sidebar-profile-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../index.html"
                            
                            rel="noopener"
                            title="首頁"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首頁</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../all-categories"
                            
                            rel="noopener"
                            title="分類"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分類</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../all-tags"
                            
                            rel="noopener"
                            title="標籤"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">標籤</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../all-archives"
                            
                            rel="noopener"
                            title="所有文章"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">所有文章</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜尋"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜尋</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="關於"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">關於</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/chankein/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/profile/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../mailto:kein.chan85@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Email"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Email</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../atom.xml"
                            
                            rel="noopener"
                            title="Atom"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Atom</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/23/makefile%E6%95%99%E7%A8%8B/"
                            aria-label=": makefile教程"
                        >
                            makefile教程
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-23T12:48:01+08:00">
	
		    2025 年 5 月 23 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="make/">make</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="简介">简介</h2>
<p>Linux的<code>make</code>程序用来自动化编译大型源码，很多时候，我们在Linux下编译安装软件，只需要敲一个<code>make</code>就可以全自动完成，非常方便。</p>
<p><code>make</code>能自动化完成这些工作，是因为项目提供了一个<code>Makefile</code>文件，它负责告诉<code>make</code>，应该如何编译和链接程序。</p>
<p><code>Makefile</code>相当于Java项目的<code>pom.xml</code>，Node工程的<code>package.json</code>，Rust项目的<code>Cargo.toml</code>，不同之处在于，<code>make</code>虽然最初是针对C语言开发，但它实际上并不限定C语言，而是可以应用到任意项目，甚至不是编程语言。此外，<code>make</code>主要用于Unix/Linux环境的自动化开发，掌握<code>Makefile</code>的写法，可以更好地在Linux环境下做开发，也可以为后续开发Linux内核做好准备。</p>
<p>在本教程中，我们将由浅入深，一步一步学习如何编写<code>Makefile</code>，完全针对零基础小白，只需要提前掌握如何使用Linux命令。</p>
<hr>
<hr>
<p>在Linux环境下，当我们输入<code>make</code>命令时，它就在当前目录查找一个名为<code>Makefile</code>的文件，然后，根据这个文件定义的规则，自动化地执行任意命令，包括编译命令。</p>
<p><code>Makefile</code>这个单词，顾名思义，就是指如何生成文件。</p>
<p>我们举个例子：在当前目录下，有3个文本文件：<code>a.txt</code>，<code>b.txt</code>和<code>c.txt</code>。</p>
<p>现在，我们要合并<code>a.txt</code>与<code>b.txt</code>，生成中间文件<code>m.txt</code>，再用中间文件<code>m.txt</code>与<code>c.txt</code>合并，生成最终的目标文件<code>x.txt</code>，整个逻辑如下图所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────┐ ┌─────┐ ┌─────┐</span><br><span class="line">│a.txt│ │b.txt│ │c.txt│</span><br><span class="line">└─────┘ └─────┘ └─────┘</span><br><span class="line">   │       │       │</span><br><span class="line">   └───┬───┘       │</span><br><span class="line">       │           │</span><br><span class="line">       ▼           │</span><br><span class="line">    ┌─────┐        │</span><br><span class="line">    │m.txt│        │</span><br><span class="line">    └─────┘        │</span><br><span class="line">       │           │</span><br><span class="line">       └─────┬─────┘</span><br><span class="line">             │</span><br><span class="line">             ▼</span><br><span class="line">          ┌─────┐</span><br><span class="line">          │x.txt│</span><br><span class="line">          └─────┘</span><br></pre></td></tr></table></figure>
<p>根据上述逻辑，我们来编写<code>Makefile</code>。</p>
<h3 id="规则">规则</h3>
<p><code>Makefile</code>由若干条规则（Rule）构成，每一条规则指出一个目标文件（Target），若干依赖文件（prerequisites），以及生成目标文件的命令。</p>
<p>例如，要生成<code>m.txt</code>，依赖<code>a.txt</code>与<code>b.txt</code>，规则如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 目标文件: 依赖文件1 依赖文件2</span><br><span class="line">m.txt: a.txt b.txt</span><br><span class="line">	cat a.txt b.txt &gt; m.txt</span><br></pre></td></tr></table></figure>
<p>一条规则的格式为<code>目标文件: 依赖文件1 依赖文件2 ...</code>，紧接着，以Tab开头的是命令，用来生成目标文件。上述规则使用<code>cat</code>命令合并了<code>a.txt</code>与<code>b.txt</code>，并写入到<code>m.txt</code>。用什么方式生成目标文件<code>make</code>并不关心，因为命令完全是我们自己写的，可以是编译命令，也可以是<code>cp</code>、<code>mv</code>等任何命令。</p>
<p>以<code>#</code>开头的是注释，会被<code>make</code>命令忽略。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：Makefile的规则中，命令必须以Tab开头，不能是空格。</span><br></pre></td></tr></table></figure>
<p>类似的，我们写出生成<code>x.txt</code>的规则如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x.txt: m.txt c.txt</span><br><span class="line">	cat m.txt c.txt &gt; x.txt</span><br></pre></td></tr></table></figure>
<p>由于<code>make</code>执行时，默认执行第一条规则，所以，我们把规则<code>x.txt</code>放到前面。完整的<code>Makefile</code>如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x.txt: m.txt c.txt</span><br><span class="line">	cat m.txt c.txt &gt; x.txt</span><br><span class="line"></span><br><span class="line">m.txt: a.txt b.txt</span><br><span class="line">	cat a.txt b.txt &gt; m.txt</span><br></pre></td></tr></table></figure>
<p>在当前目录创建<code>a.txt</code>、<code>b.txt</code>和<code>c.txt</code>，输入一些内容，执行<code>make</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">cat a.txt b.txt &gt; m.txt</span><br><span class="line">cat m.txt c.txt &gt; x.txt</span><br></pre></td></tr></table></figure>
<p><code>make</code>默认执行第一条规则，也就是创建<code>x.txt</code>，但是由于<code>x.txt</code>依赖的文件<code>m.txt</code>不存在（另一个依赖<code>c.txt</code>已存在），故需要先执行规则<code>m.txt</code>创建出<code>m.txt</code>文件，再执行规则<code>x.txt</code>。执行完成后，当前目录下生成了两个文件<code>m.txt</code>和<code>x.txt</code>。</p>
<p>可见，<code>Makefile</code>定义了一系列规则，每个规则在满足依赖文件的前提下执行命令，就能创建出一个目标文件，这就是英文Make file的意思。</p>
<p>把默认执行的规则放第一条，其他规则的顺序是无关紧要的，因为<code>make</code>执行时自动判断依赖。</p>
<p>此外，<code>make</code>会打印出执行的每一条命令，便于我们观察执行顺序以便调试。</p>
<p>如果我们再次运行<code>make</code>，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">make: `x.txt&#x27; is up to date.</span><br></pre></td></tr></table></figure>
<p><code>make</code>检测到<code>x.txt</code>已经是最新版本，无需再次执行，因为<code>x.txt</code>的创建时间晚于它依赖的<code>m.txt</code>和<code>c.txt</code>的最后修改时间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make使用文件的创建和修改时间来判断是否应该更新一个目标文件。</span><br></pre></td></tr></table></figure>
<p>修改<code>c.txt</code>后，运行<code>make</code>，会触发<code>x.txt</code>的更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">cat m.txt c.txt &gt; x.txt</span><br></pre></td></tr></table></figure>
<p>但并不会触发<code>m.txt</code>的更新，原因是<code>m.txt</code>的依赖<code>a.txt</code>与<code>b.txt</code>并未更新，所以，<code>make</code>只会根据<code>Makefile</code>去执行那些必要的规则，并不会把所有规则都无脑执行一遍。</p>
<p>在编译大型程序时，全量编译往往需要几十分钟甚至几个小时。全量编译完成后，如果仅修改了几个文件，再全部重新编译完全没有必要，用<code>Makefile</code>实现增量编译就十分节省时间。</p>
<p>当然，是否能正确地实现增量更新，取决于我们的规则写得对不对，<code>make</code>本身并不会检查规则逻辑是否正确。</p>
<h3 id="伪目标">伪目标</h3>
<p>因为<code>m.txt</code>与<code>x.txt</code>都是自动生成的文件，所以，可以安全地删除。</p>
<p>删除时，我们也不希望手动删除，而是编写一个<code>clean</code>规则来删除它们：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clean:</span><br><span class="line">	rm -f m.txt</span><br><span class="line">	rm -f x.txt</span><br></pre></td></tr></table></figure>
<p><code>clean</code>规则与我们前面编写的规则有所不同，它没有依赖文件，因此，要执行<code>clean</code>，必须用命令<code>make clean</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make clean</span><br><span class="line">rm -f m.txt</span><br><span class="line">rm -f x.txt</span><br></pre></td></tr></table></figure>
<p>然而，在执行<code>clean</code>时，我们并没有创建一个名为<code>clean</code>的文件，所以，因为目标文件<code>clean</code>不存在，每次运行<code>make clean</code>，都会执行这个规则的命令。</p>
<p>如果我们手动创建一个<code>clean</code>的文件，这个<code>clean</code>规则就不会执行了！</p>
<p>如果我们希望<code>make</code>把<code>clean</code>不要视为文件，可以添加一个标识：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f m.txt</span><br><span class="line">	rm -f x.txt</span><br></pre></td></tr></table></figure>
<p>此时，<code>clean</code>就不被视为一个文件，而是伪目标（Phony Target）。</p>
<p>大型项目通常会提供<code>clean</code>、<code>install</code>这些约定俗成的伪目标名称，方便用户快速执行特定任务。</p>
<p>一般来说，并不需要用<code>.PHONY</code>标识<code>clean</code>等约定俗成的伪目标名称，除非有人故意搞破坏，手动创建名字叫<code>clean</code>的文件。</p>
<h3 id="执行多条命令">执行多条命令</h3>
<p>一个规则可以有多条命令，例如：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">cd:</span></span><br><span class="line">	pwd</span><br><span class="line">	cd ..</span><br><span class="line">	pwd</span><br></pre></td></tr></table></figure>
<p>执行<code>cd</code>规则：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ make cd</span><br><span class="line">pwd</span><br><span class="line">/home/ubuntu/makefile-tutorial/v1</span><br><span class="line">cd ..</span><br><span class="line">pwd</span><br><span class="line">/home/ubuntu/makefile-tutorial/v1</span><br></pre></td></tr></table></figure>
<p>观察输出，发现<code>cd ..</code>命令执行后，并未改变当前目录，两次输出的<code>pwd</code>是一样的，这是因为<code>make</code>针对每条命令，都会创建一个独立的Shell环境，类似<code>cd ..</code>这样的命令，并不会影响当前目录。</p>
<p>解决办法是把多条命令以<code>;</code>分隔，写到一行：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">cd_ok:</span></span><br><span class="line">	pwd; cd ..; pwd;</span><br></pre></td></tr></table></figure>
<p>再执行<code>cd_ok</code>目标就得到了预期结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make cd_ok</span><br><span class="line">pwd; cd ..; pwd</span><br><span class="line">/home/ubuntu/makefile-tutorial/v1</span><br><span class="line">/home/ubuntu/makefile-tutorial</span><br></pre></td></tr></table></figure>
<p>可以使用<code>\</code>把一行语句拆成多行，便于浏览：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">cd_ok:</span></span><br><span class="line">	pwd; \</span><br><span class="line">	cd ..; \</span><br><span class="line">	pwd</span><br></pre></td></tr></table></figure>
<p>另一种执行多条命令的语法是用<code>&amp;&amp;</code>，它的好处是当某条命令失败时，后续命令不会继续执行：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">cd_ok:</span></span><br><span class="line">	cd .. &amp;&amp; pwd</span><br></pre></td></tr></table></figure>
<h3 id="控制打印">控制打印</h3>
<p>默认情况下，<code>make</code>会打印出它执行的每一条命令。如果我们不想打印某一条命令，可以在命令前加上<code>@</code>，表示不打印命令（但是仍然会执行）：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">no_output:</span></span><br><span class="line">	@echo &#x27;not display&#x27;</span><br><span class="line">	echo &#x27;will display&#x27;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make no_output</span><br><span class="line">not display</span><br><span class="line">echo &#x27;will display&#x27;</span><br><span class="line">will display</span><br></pre></td></tr></table></figure>
<p>注意命令<code>echo 'not display'</code>本身没有打印，但命令仍然会执行，并且执行的结果仍然正常打印。</p>
<h3 id="控制错误">控制错误</h3>
<p><code>make</code>在执行命令时，会检查每一条命令的返回值，如果返回错误（非0值），就会中断执行。</p>
<p>例如，不使用<code>-f</code>删除一个不存在的文件会报错：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">has_error:</span></span><br><span class="line">	rm zzz.txt</span><br><span class="line">	echo &#x27;ok&#x27;</span><br></pre></td></tr></table></figure>
<p>执行上述目标，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make has_error</span><br><span class="line">rm zzz.txt</span><br><span class="line">rm: zzz.txt: No such file or directory</span><br><span class="line">make: *** [has_error] Error 1</span><br></pre></td></tr></table></figure>
<p>由于命令<code>rm zzz.txt</code>报错，导致后面的命令<code>echo 'ok'</code>并不会执行，<code>make</code>打印出错误，然后退出。</p>
<p>有些时候，我们想忽略错误，继续执行后续命令，可以在需要忽略错误的命令前加上<code>-</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">ignore_error:</span></span><br><span class="line">	-rm zzz.txt</span><br><span class="line">	echo &#x27;ok&#x27;</span><br></pre></td></tr></table></figure>
<p>执行上述目标，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ make ignore_error</span><br><span class="line">rm zzz.txt</span><br><span class="line">rm: zzz.txt: No such file or directory</span><br><span class="line">make: [ignore_error] Error 1 (ignored)</span><br><span class="line">echo &#x27;ok&#x27;</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>
<p><code>make</code>检测到<code>rm zzz.txt</code>报错，并打印错误，但显示<code>(ignored)</code>，然后继续执行后续命令。</p>
<p>对于执行可能出错，但不影响逻辑的命令，可以用<code>-</code>忽略。</p>
<h3 id="参考源码">参考源码</h3>
<p>可以从<a target="_blank" rel="noopener" href="https://github.com/michaelliao/makefile-tutorial/tree/main/v1">GitHub</a>下载源码。</p>
<h3 id="小结">小结</h3>
<p>编写<code>Makefile</code>就是编写一系列规则，用来告诉<code>make</code>如何执行这些规则，最终生成我们期望的目标文件。</p>
<p>查看官方手册：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/Rules.html">编写规则</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/Execution.html">执行命令</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/Phony-Targets.html">伪目标</a></li>
</ul>
<h2 id="编译C程序">编译C程序</h2>
<p>C程序的编译通常分两步：</p>
<ol>
<li>将每个<code>.c</code>文件编译为<code>.o</code>文件；</li>
<li>将所有<code>.o</code>文件链接为最终的可执行文件。</li>
</ol>
<p>我们假设如下的一个C项目，包含<code>hello.c</code>、<code>hello.h</code>和<code>main.c</code>。</p>
<p><code>hello.c</code>内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">hello</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>hello.h</code>内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">hello</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p><code>main.c</code>内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;start...\n&quot;</span>);</span><br><span class="line">    hello();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到<code>main.c</code>引用了头文件<code>hello.h</code>。我们很容易梳理出需要生成的文件，逻辑如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌───────┐ ┌───────┐ ┌───────┐</span><br><span class="line">│hello.c│ │main.c │ │hello.h│</span><br><span class="line">└───────┘ └───────┘ └───────┘</span><br><span class="line">    │         │         │</span><br><span class="line">    │         └────┬────┘</span><br><span class="line">    │              │</span><br><span class="line">    ▼              ▼</span><br><span class="line">┌───────┐      ┌───────┐</span><br><span class="line">│hello.o│      │main.o │</span><br><span class="line">└───────┘      └───────┘</span><br><span class="line">    │              │</span><br><span class="line">    └───────┬──────┘</span><br><span class="line">            │</span><br><span class="line">            ▼</span><br><span class="line">       ┌─────────┐</span><br><span class="line">       │world.out│</span><br><span class="line">       └─────────┘</span><br></pre></td></tr></table></figure>
<p>假定最终生成的可执行文件是<code>world.out</code>，中间步骤还需要生成<code>hello.o</code>和<code>main.o</code>两个文件。根据上述依赖关系，我们可以很容易地写出<code>Makefile</code>如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成可执行文件:</span></span><br><span class="line"><span class="section">world.out: hello.o main.o</span></span><br><span class="line">	cc -o world.out hello.o main.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 hello.c:</span></span><br><span class="line"><span class="section">hello.o: hello.c</span></span><br><span class="line">	cc -c hello.c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 main.c:</span></span><br><span class="line"><span class="section">main.o: main.c hello.h</span></span><br><span class="line">	cc -c main.c</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o world.out</span><br></pre></td></tr></table></figure>
<p>执行<code>make</code>，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">cc -c hello.c</span><br><span class="line">cc -c main.c</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<p>在当前目录下可以看到<code>hello.o</code>、<code>main.o</code>以及最终的可执行程序<code>world.out</code>。执行<code>world.out</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./world.out </span><br><span class="line">start...</span><br><span class="line">hello, world!</span><br><span class="line">exit.</span><br></pre></td></tr></table></figure>
<p>与我们预期相符。</p>
<p>修改<code>hello.c</code>，把输出改为<code>&quot;hello, bob!\n&quot;</code>，再执行<code>make</code>，观察输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">cc -c hello.c</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<p>仅重新编译了<code>hello.c</code>，并未编译<code>main.c</code>。由于<code>hello.o</code>已更新，所以，仍然要重新生成<code>world.out</code>。执行<code>world.out</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./world.out </span><br><span class="line">start...</span><br><span class="line">hello, bob!</span><br><span class="line">exit.</span><br></pre></td></tr></table></figure>
<p>与我们预期相符。</p>
<p>修改<code>hello.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// int 变为 void:</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hello</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>以及<code>hello.c</code>，再次执行<code>make</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">cc -c hello.c</span><br><span class="line">cc -c main.c</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<p>会触发<code>main.c</code>的编译，因为<code>main.c</code>依赖<code>hello.h</code>。</p>
<p>执行<code>make clean</code>会删除所有的<code>.o</code>文件，以及可执行文件<code>world.out</code>，再次执行<code>make</code>就会强制全量编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make clean &amp;&amp; make</span><br><span class="line">rm -f *.o world.out</span><br><span class="line">cc -c hello.c</span><br><span class="line">cc -c main.c</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<p>这个简单的<code>Makefile</code>使我们能自动化编译C程序，十分方便。</p>
<p>不过，随着越来越多的<code>.c</code>文件被添加进来，如何高效维护<code>Makefile</code>的规则？我们后面继续讲解。</p>
<h3 id="参考源码-2">参考源码</h3>
<p>可以从<a target="_blank" rel="noopener" href="https://github.com/michaelliao/makefile-tutorial/tree/main/v2">GitHub</a>下载源码。</p>
<h3 id="小结-2">小结</h3>
<p>在<code>Makefile</code>正确定义规则后，我们就能用<code>make</code>自动化编译C程序。</p>
<hr>
<hr>
<h2 id="使用隐式规则">使用隐式规则</h2>
<p>我们仍然以上一节的C项目为例，当我们添加越来越多的<code>.c</code>文件时，就需要编写越来越多的规则来生成<code>.o</code>文件。</p>
<p>实际上，有的同学可能发现了，即使我们把<code>.o</code>的规则删掉，也能正常编译：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只保留生成 world.out 的规则:</span></span><br><span class="line"><span class="section">world.out: hello.o main.o</span></span><br><span class="line">	cc -o world.out hello.o main.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o world.out</span><br></pre></td></tr></table></figure>
<p>执行<code>make</code>，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">cc    -c -o hello.o hello.c</span><br><span class="line">cc    -c -o main.o main.c</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<p>我们没有定义<code>hello.o</code>和<code>main.o</code>的规则，为什么<code>make</code>也能正常创建这两个文件？</p>
<p>因为<code>make</code>最初就是为了编译C程序而设计的，为了免去重复创建编译<code>.o</code>文件的规则，<code>make</code>内置了隐式规则（Implicit Rule），即遇到一个<code>xyz.o</code>时，如果没有找到对应的规则，就自动应用一个隐式规则：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">xyz.o: xyz.c</span></span><br><span class="line">	cc -c -o xyz.o xyz.c</span><br></pre></td></tr></table></figure>
<p><code>make</code>针对C、C++、ASM、Fortran等程序内置了一系列隐式规则，可以参考官方手册查看。</p>
<p>对于C程序来说，使用隐式规则有一个潜在问题，那就是无法跟踪<code>.h</code>文件的修改。如果我们修改了<code>hello.h</code>的定义，由于隐式规则<code>main.o: main.c</code>并不会跟踪<code>hello.h</code>的修改，导致<code>main.c</code>不会被重新编译，这个问题我们放到后面解决。</p>
<h3 id="参考源码-3">参考源码</h3>
<p>可以从<a target="_blank" rel="noopener" href="https://github.com/michaelliao/makefile-tutorial/tree/main/v3">GitHub</a>下载源码。</p>
<h3 id="小结-3">小结</h3>
<p>针对C、C++、ASM、Fortran等程序，<code>make</code>内置了一系列隐式规则，使用隐式规则可减少大量重复的通用编译规则。</p>
<p>查看官方手册：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/Using-Implicit.html">使用隐式规则</a></li>
</ul>
<hr>
<hr>
<p>当我们在<code>Makefile</code>中重复写很多文件名时，一来容易写错，二来如果要改名，要全部替换，费时费力。</p>
<p>编程语言使用变量（Variable）来解决反复引用的问题，类似的，在<code>Makefile</code>中，也可以使用变量来解决重复问题。</p>
<p>以上一节的<code>Makefile</code>为例：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">world.out: hello.o main.o</span></span><br><span class="line">	cc -o world.out hello.o main.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o world.out</span><br></pre></td></tr></table></figure>
<p>编译的最终文件<code>world.out</code>重复出现了3次，因此，完全可以定义一个变量来替换它：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TARGET = world.out</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: hello.o main.o</span><br><span class="line">	cc -o <span class="variable">$(TARGET)</span> hello.o main.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>
<p>变量定义用<code>变量名 = 值</code>或者<code>变量名 := 值</code>，通常变量名全大写。引用变量用<code>$(变量名)</code>，非常简单。</p>
<p>注意到<code>hello.o main.o</code>这个“列表”也重复了，我们也可以用变量来替换：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OBJS = hello.o main.o</span><br><span class="line">TARGET = world.out</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	cc -o <span class="variable">$(TARGET)</span> <span class="variable">$(OBJS)</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>
<p>如果有一种方式能让<code>make</code>自动生成<code>hello.o main.o</code>这个“列表”，就更好了。注意到每个<code>.o</code>文件是由对应的<code>.c</code>文件编译产生的，因此，可以让<code>make</code>先获取<code>.c</code>文件列表，再替换，得到<code>.o</code>文件列表：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $(wildcard *.c) 列出当前目录下的所有 .c 文件: hello.c main.c</span></span><br><span class="line"><span class="comment"># 用函数 patsubst 进行模式替换得到: hello.o main.o</span></span><br><span class="line">OBJS = <span class="variable">$(<span class="built_in">patsubst</span> %.c,%.o,$(<span class="built_in">wildcard</span> *.c)</span>)</span><br><span class="line">TARGET = world.out</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	cc -o <span class="variable">$(TARGET)</span> <span class="variable">$(OBJS)</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>
<p>这样，我们每添加一个<code>.c</code>文件，不需要修改<code>Makefile</code>，变量<code>OBJS</code>会自动更新。</p>
<p>思考：为什么我们不能直接定义<code>OBJS = $(wildcard *.o)</code>让<code>make</code>列出所有<code>.o</code>文件？</p>
<h3 id="内置变量">内置变量</h3>
<p>我们还可以用变量<code>$(CC)</code>替换命令<code>cc</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	<span class="variable">$(CC)</span> -o <span class="variable">$(TARGET)</span> <span class="variable">$(OBJS)</span></span><br></pre></td></tr></table></figure>
<p>没有定义变量<code>CC</code>也可以引用它，因为它是<code>make</code>的内置变量（Builtin Variables），表示C编译器的名字，默认值是<code>cc</code>，我们也可以修改它，例如使用交叉编译时，指定编译器：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CC = riscv64-linux-gnu-gcc</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="自动变量">自动变量</h3>
<p>在<code>Makefile</code>中，经常可以看到<code>$@</code>、<code>$&lt;</code>这样的变量，这种变量称为自动变量（Automatic Variable），它们在一个规则中自动指向某个值。</p>
<p>例如，<code>$@</code>表示目标文件，<code>$^</code>表示所有依赖文件，因此，我们可以这么写：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">world.out: hello.o main.o</span></span><br><span class="line">	cc -o <span class="variable">$@</span> <span class="variable">$^</span></span><br></pre></td></tr></table></figure>
<p>在没有歧义时可以写<code>$@</code>，也可以写<code>$(@)</code>，有歧义时必须用括号，例如<code>$(@D)</code>。</p>
<p>为了更好地调试，我们还可以把变量打印出来：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">world.out: hello.o main.o</span></span><br><span class="line">	@echo &#x27;$<span class="variable">$@</span> = <span class="variable">$@</span>&#x27; <span class="comment"># 变量 $@ 表示target</span></span><br><span class="line">	@echo &#x27;$<span class="variable">$&lt;</span> = <span class="variable">$&lt;</span>&#x27; <span class="comment"># 变量 $&lt; 表示第一个依赖项</span></span><br><span class="line">	@echo &#x27;$<span class="variable">$^</span> = <span class="variable">$^</span>&#x27; <span class="comment"># 变量 $^ 表示所有依赖项</span></span><br><span class="line">	cc -o <span class="variable">$@</span> <span class="variable">$^</span></span><br></pre></td></tr></table></figure>
<p>执行结果输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$@ = world.out</span><br><span class="line">$&lt; = hello.o</span><br><span class="line">$^ = hello.o main.o</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<h3 id="参考源码-4">参考源码</h3>
<p>可以从<a target="_blank" rel="noopener" href="https://github.com/michaelliao/makefile-tutorial/tree/main/v4">GitHub</a>下载源码。</p>
<h3 id="小结-4">小结</h3>
<p>使用变量可以让<code>Makefile</code>更加容易维护。</p>
<p>查看官方手册：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/Using-Variables.html">如何使用变量</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html">自动变量</a></li>
</ul>
<h2 id="使用模式规则">使用模式规则</h2>
<p>前面我们讲了使用隐式规则可以让<code>make</code>在必要时自动创建<code>.o</code>文件的规则，但<code>make</code>的隐式规则的命令是固定的，对于<code>xyz.o: xyz.c</code>，它实际上是：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br></pre></td></tr></table></figure>
<p>能修改的只有变量<code>$(CC)</code>和<code>$(CFLAGS)</code>。如果要执行多条命令，使用隐式规则就不行了。</p>
<p>这时，我们可以自定义模式规则（Pattern Rules），它允许<code>make</code>匹配模式规则，如果匹配上了，就自动创建一条模式规则。</p>
<p>我们修改上一节的<code>Makefile</code>如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">OBJS = <span class="variable">$(<span class="built_in">patsubst</span> %.c,%.o,$(<span class="built_in">wildcard</span> *.c)</span>)</span><br><span class="line">TARGET = world.out</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	cc -o <span class="variable">$(TARGET)</span> <span class="variable">$(OBJS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模式匹配规则：当make需要目标 xyz.o 时，自动生成一条 xyz.o: xyz.c 规则:</span></span><br><span class="line"><span class="section">%.o: %.c</span></span><br><span class="line">	@echo &#x27;compiling <span class="variable">$&lt;</span>...&#x27;</span><br><span class="line">	cc -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>
<p>当<code>make</code>执行<code>world.out: hello.o main.o</code>时，发现没有<code>hello.o</code>文件，于是需要查找以<code>hello.o</code>为目标的规则，结果匹配到模式规则<code>%.o: %.c</code>，于是<code>make</code>自动根据模式规则为我们动态创建了如下规则：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">hello.o: hello.c</span></span><br><span class="line">	@echo &#x27;compiling <span class="variable">$&lt;</span>...&#x27;</span><br><span class="line">	cc -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br></pre></td></tr></table></figure>
<p>查找<code>main.o</code>也是类似的匹配过程，于是我们执行<code>make</code>，就可以用模式规则完成编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">compiling hello.c...</span><br><span class="line">cc -c -o hello.o hello.c</span><br><span class="line">compiling main.c...</span><br><span class="line">cc -c -o main.o main.c</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<p>模式规则的命令完全由我们自己定义，因此，它比隐式规则更灵活。</p>
<p>但是，模式规则仍然没有解决修改<code>hello.h</code>头文件不会触发<code>main.c</code>重新编译的问题，这个依赖问题我们继续放到后面解决。</p>
<p>最后注意，模式规则是按需生成，如果我们在当前目录创建一个<code>zzz.o</code>文件，因为<code>make</code>并不会在执行过程中用到它，所以并不会自动生成<code>zzz.o: zzz.c</code>这个规则。</p>
<h3 id="参考源码-5">参考源码</h3>
<p>可以从<a target="_blank" rel="noopener" href="https://github.com/michaelliao/makefile-tutorial/tree/main/v5">GitHub</a>下载源码。</p>
<h3 id="小结-5">小结</h3>
<p>使用模式规则可以灵活地按需动态创建规则，它比隐式规则更灵活。</p>
<p>查看官方手册：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/Pattern-Intro.html">模式规则</a></li>
</ul>
<hr>
<hr>
<p>前面我们讲了隐式规则和模式规则，这两种规则都可以解决自动把<code>.c</code>文件编译成<code>.o</code>文件，但都无法解决<code>.c</code>文件依赖<code>.h</code>文件的问题。</p>
<p>因为一个<code>.c</code>文件依赖哪个<code>.h</code>文件必须要分析文件内容才能确定，没有一个简单的文件名映射规则。</p>
<p>但是，要识别出<code>.c</code>文件的头文件依赖，可以用GCC提供的<code>-MM</code>参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cc -MM main.c</span><br><span class="line">main.o: main.c hello.h</span><br></pre></td></tr></table></figure>
<p>上述输出告诉我们，编译<code>main.o</code>依赖<code>main.c</code>和<code>hello.h</code>两个文件。</p>
<p>因此，我们可以利用GCC的这个功能，对每个<code>.c</code>文件都生成一个依赖项，通常我们把它保存到<code>.d</code>文件中，再用<code>include</code>引入到<code>Makefile</code>，就相当于自动化完成了每个<code>.c</code>文件的精准依赖。</p>
<p>我们改写上一节的<code>Makefile</code>如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有 .c 文件:</span></span><br><span class="line">SRCS = <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据SRCS生成 .o 文件列表:</span></span><br><span class="line">OBJS = $(SRCS:.c=.o)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据SRCS生成 .d 文件列表:</span></span><br><span class="line">DEPS = $(SRCS:.c=.d)</span><br><span class="line"></span><br><span class="line">TARGET = world.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标:</span></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	<span class="variable">$(CC)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># xyz.d 的规则由 xyz.c 生成:</span></span><br><span class="line"><span class="section">%.d: %.c</span></span><br><span class="line">	rm -f <span class="variable">$@</span>; \</span><br><span class="line">	<span class="variable">$(CC)</span> -MM <span class="variable">$&lt;</span> &gt;<span class="variable">$@</span>.tmp; \</span><br><span class="line">	sed &#x27;s,\(<span class="variable">$*</span>\)\.o[ :]*,\1.o <span class="variable">$@</span> : ,g&#x27; &lt; <span class="variable">$@</span>.tmp &gt; <span class="variable">$@</span>; \</span><br><span class="line">	rm -f <span class="variable">$@</span>.tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模式规则:</span></span><br><span class="line"><span class="section">%.o: %.c</span></span><br><span class="line">	<span class="variable">$(CC)</span> -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o *.d <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入所有 .d 文件:</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(DEPS)</span></span><br></pre></td></tr></table></figure>
<p>变量<code>$(SRCS)</code>通过扫描目录可以确定为<code>hello.c main.c</code>，因此，变量<code>$(OBJS)</code>赋值为<code>hello.o main.o</code>，变量<code>$(DEPS)</code>赋值为<code>hello.d main.d</code>。</p>
<p>通过<code>include $(DEPS)</code>我们引入<code>hello.d</code>和<code>main.d</code>文件，但是这两个文件一开始并不存在，不过，<code>make</code>通过模式规则匹配到<code>%.d: %.c</code>，这就给了我们一个机会，在这个模式规则内部，用<code>cc -MM</code>命令外加<code>sed</code>把<code>.d</code>文件创建出来。</p>
<p>运行<code>make</code>，首次输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">Makefile:31: hello.d: No such file or directory</span><br><span class="line">Makefile:31: main.d: No such file or directory</span><br><span class="line">rm -f main.d; \</span><br><span class="line">        cc -MM main.c &gt;main.d.tmp; \</span><br><span class="line">        sed &#x27;s,\(main\)\.o[ :]*,\1.o main.d : ,g&#x27; &lt; main.d.tmp &gt; main.d; \</span><br><span class="line">        rm -f main.d.tmp</span><br><span class="line">rm -f hello.d; \</span><br><span class="line">        cc -MM hello.c &gt;hello.d.tmp; \</span><br><span class="line">        sed &#x27;s,\(hello\)\.o[ :]*,\1.o hello.d : ,g&#x27; &lt; hello.d.tmp &gt; hello.d; \</span><br><span class="line">        rm -f hello.d.tmp</span><br><span class="line">cc -c -o hello.o hello.c</span><br><span class="line">cc -c -o main.o main.c</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<p><code>make</code>会提示找不到<code>hello.d</code>和<code>main.d</code>，不过随后自动创建出<code>hello.d</code>和<code>main.d</code>。<code>hello.d</code>内容如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello.o hello.d : hello.c</span><br></pre></td></tr></table></figure>
<p>上述规则有两个目标文件，实际上相当于如下两条规则：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello.o : hello.c</span><br><span class="line">hello.d : hello.c</span><br></pre></td></tr></table></figure>
<p><code>main.d</code>内容如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main.o main.d : main.c hello.h</span><br></pre></td></tr></table></figure>
<p>因此，<code>main.o</code>依赖于<code>main.c</code>和<code>hello.h</code>，这个依赖关系就和我们手动指定的一致。</p>
<p>改动<code>hello.h</code>，再次运行<code>make</code>，可以触发<code>main.c</code>的编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">rm -f main.d; \</span><br><span class="line">        cc -MM main.c &gt;main.d.tmp; \</span><br><span class="line">        sed &#x27;s,\(main\)\.o[ :]*,\1.o main.d : ,g&#x27; &lt; main.d.tmp &gt; main.d; \</span><br><span class="line">        rm -f main.d.tmp</span><br><span class="line">cc -c -o main.o main.c</span><br><span class="line">cc -o world.out hello.o main.o</span><br></pre></td></tr></table></figure>
<p>在实际项目中，对每个<code>.c</code>文件都可以生成一个对应的<code>.d</code>文件表示依赖关系，再通过<code>include</code>引入到<code>Makefile</code>，同时又能让<code>make</code>自动更新<code>.d</code>文件，有点蛋生鸡和鸡生蛋的关系，不过，这种机制能正常工作，除了<code>.d</code>文件不存在时会打印错误，有强迫症的同学肯定感觉不满意，这个问题我们后面解决。</p>
<h3 id="参考源码-6">参考源码</h3>
<p>可以从<a target="_blank" rel="noopener" href="https://github.com/michaelliao/makefile-tutorial/tree/main/v6">GitHub</a>下载源码。</p>
<h3 id="小结-6">小结</h3>
<p>利用GCC生成<code>.d</code>文件，再用<code>include</code>引入<code>Makefile</code>，可解决一个<code>.c</code>文件应该如何正确触发编译的问题。</p>
<p>查看官方手册：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/Automatic-Prerequisites.html">自动生成依赖</a></li>
</ul>
<h2 id="完善Makefile">完善Makefile</h2>
<p>上一节我们解决了自动生成依赖的问题，这一节我们对项目目录进行整理，把所有源码放入<code>src</code>目录，所有编译生成的文件放入<code>build</code>目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;project&gt;</span><br><span class="line">├── Makefile</span><br><span class="line">├── build</span><br><span class="line">└── src</span><br><span class="line">    ├── hello.c</span><br><span class="line">    ├── hello.h</span><br><span class="line">    └── main.c</span><br></pre></td></tr></table></figure>
<p>整理<code>Makefile</code>，内容如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">SRC_DIR = ./src</span><br><span class="line">BUILD_DIR = ./build</span><br><span class="line">TARGET = <span class="variable">$(BUILD_DIR)</span>/world.out</span><br><span class="line"></span><br><span class="line">CC = cc</span><br><span class="line">CFLAGS = -Wall</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./src/*.c</span></span><br><span class="line">SRCS = <span class="variable">$(<span class="built_in">shell</span> find <span class="variable">$(SRC_DIR)</span> -name &#x27;*.c&#x27;)</span></span><br><span class="line"><span class="comment"># ./src/*.c =&gt; ./build/*.o</span></span><br><span class="line">OBJS = <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(SRC_DIR)</span>/%.c,<span class="variable">$(BUILD_DIR)</span>/%.o,<span class="variable">$(SRCS)</span>)</span></span><br><span class="line"><span class="comment"># ./src/*.c =&gt; ./build/*.d</span></span><br><span class="line">DEPS = <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(SRC_DIR)</span>/%.c,<span class="variable">$(BUILD_DIR)</span>/%.d,<span class="variable">$(SRCS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标:</span></span><br><span class="line"><span class="section">all: <span class="variable">$(TARGET)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build/xyz.d 的规则由 src/xyz.c 生成:</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.d: <span class="variable">$(SRC_DIR)</span>/%.c</span><br><span class="line">	@mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span>; \</span><br><span class="line">	rm -f <span class="variable">$@</span>; \</span><br><span class="line">	<span class="variable">$(CC)</span> -MM <span class="variable">$&lt;</span> &gt;<span class="variable">$@</span>.tmp; \</span><br><span class="line">	sed &#x27;s,\(<span class="variable">$*</span>\)\.o[ :]*,<span class="variable">$(BUILD_DIR)</span>/\1.o <span class="variable">$@</span> : ,g&#x27; &lt; <span class="variable">$@</span>.tmp &gt; <span class="variable">$@</span>; \</span><br><span class="line">	rm -f <span class="variable">$@</span>.tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># build/xyz.o 的规则由 src/xyz.c 生成:</span></span><br><span class="line"><span class="variable">$(BUILD_DIR)</span>/%.o: <span class="variable">$(SRC_DIR)</span>/%.c</span><br><span class="line">	@mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接:</span></span><br><span class="line"><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line">	@echo <span class="string">&quot;buiding <span class="variable">$@</span>...&quot;</span></span><br><span class="line">	@mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span></span><br><span class="line">	<span class="variable">$(CC)</span> -o <span class="variable">$(TARGET)</span> <span class="variable">$(OBJS)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理 build 目录:</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	@echo <span class="string">&quot;clean...&quot;</span></span><br><span class="line">	rm -rf <span class="variable">$(BUILD_DIR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入所有 .d 文件:</span></span><br><span class="line"><span class="keyword">-include</span> <span class="variable">$(DEPS)</span></span><br></pre></td></tr></table></figure>
<p>这个<code>Makefile</code>定义了源码目录<code>SRC_DIR</code>、生成目录<code>BUILD_DIR</code>，以及其他变量，同时用<code>-include</code>消除了<code>.d</code>文件不存在的错误。执行<code>make</code>，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">cc -Wall -c -o build/hello.o src/hello.c</span><br><span class="line">cc -Wall -c -o build/main.o src/main.c</span><br><span class="line">buiding build/world.out...</span><br><span class="line">cc -o ./build/world.out ./build/hello.o ./build/main.o</span><br></pre></td></tr></table></figure>
<p>可以说基本满足编译需求，收工！</p>
<h3 id="参考源码-7">参考源码</h3>
<p>可以从<a target="_blank" rel="noopener" href="https://github.com/michaelliao/makefile-tutorial/tree/main/v7">GitHub</a>下载源码。</p>
<h3 id="小结-7">小结</h3>
<p>除了基础的用法外，<code>Makefile</code>还支持条件判断，环境变量，嵌套执行，变量展开等各种功能，需要用到时可以查询<a target="_blank" rel="noopener" href="https://www.gnu.org/software/make/manual/html_node/index.html">官方手册</a>。</p>
<hr>
<hr>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/23/makefile%E6%95%99%E7%A8%8B/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/python-cheat-sheet/"
                            aria-label=": python cheat sheet"
                        >
                            python cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T23:48:40+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="python/">python</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="python">python:</h3>


	<div class="row">
    <embed src="/assets/pdf/python-cheat-sheet.pdf" width="100%" height="550" type="application/pdf">
	</div>



                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/python-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/vim-cheat-sheet/"
                            aria-label=": vim cheat sheet"
                        >
                            vim cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T23:41:16+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="vim/">vim</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="python">python:</h3>


	<div class="row">
    <embed src="/assets/pdf/vim-cheat-sheet.pdf" width="100%" height="550" type="application/pdf">
	</div>



                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/vim-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/ansible-cheat-sheet/"
                            aria-label=": ansible cheat sheet"
                        >
                            ansible cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T23:10:52+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="ansible/">ansible</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="ansible-command">ansible command:</h3>


	<div class="row">
    <embed src="/assets/pdf/ansible-cheat-sheet.pdf" width="100%" height="550" type="application/pdf">
	</div>



<h3 id="playbook">playbook:</h3>


	<div class="row">
    <embed src="/assets/pdf/ansible-playbook.pdf" width="100%" height="550" type="application/pdf">
	</div>



                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/ansible-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/curl-cheat-sheet/"
                            aria-label=": curl cheat sheet"
                        >
                            curl cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T19:47:54+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="curl/">curl</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="curl-command">curl command:</h3>


	<div class="row">
    <embed src="/assets/pdf/curl-cheat-sheet.pdf" width="100%" height="550" type="application/pdf">
	</div>




                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/curl-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/20/cheat-sheet/docker-cheat-sheet/"
                            aria-label=": docker cheat sheet"
                        >
                            docker cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-20T19:36:58+08:00">
	
		    2025 年 5 月 20 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="docker/">docker</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="docker">docker:</h3>
<p><img src="/assets/images/docker-cheat-sheet.webp" alt="image"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/20/cheat-sheet/docker-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/14/git/git-cheat-sheet/"
                            aria-label=": git cheat sheet"
                        >
                            git cheat sheet
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-14T08:57:44+08:00">
	
		    2025 年 5 月 14 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="git/">git</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p><img src="/assets/images/gitcheatsheet.png" alt="image"></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/14/git/git-cheat-sheet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2025/05/12/vim%E6%95%99%E7%A8%8B/"
                            aria-label=": vim教程"
                        >
                            vim教程
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-05-12T16:01:20+08:00">
	
		    2025 年 5 月 12 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="vim/">vim</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1>Vim 编辑器使用笔记整理</h1>
<h2 id="1-退出-Vim">1. 退出 Vim</h2>
<h3 id="命令行模式退出方式">命令行模式退出方式</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>:wq</code></td>
<td>保存并退出</td>
</tr>
<tr>
<td><code>:q!</code></td>
<td>强制退出，不保存</td>
</tr>
<tr>
<td><code>:q</code></td>
<td>退出(未修改时)</td>
</tr>
<tr>
<td><code>:wq!</code></td>
<td>强制保存并退出</td>
</tr>
<tr>
<td><code>:w &lt;文件路径&gt;</code></td>
<td>另存为指定文件</td>
</tr>
<tr>
<td><code>:saveas 文件路径</code></td>
<td>另存为指定文件</td>
</tr>
<tr>
<td><code>:x</code></td>
<td>保存并退出(类似:wq)</td>
</tr>
</tbody>
</table>
<h3 id="普通模式退出方式">普通模式退出方式</h3>
<ul>
<li>输入 <code>Shift+zz</code> 即可保存退出</li>
</ul>
<h2 id="2-删除文本">2. 删除文本</h2>
<h3 id="普通模式删除命令">普通模式删除命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x</code></td>
<td>删除游标所在字符</td>
</tr>
<tr>
<td><code>X</code></td>
<td>删除游标前一个字符</td>
</tr>
<tr>
<td><code>Delete</code></td>
<td>同 <code>x</code></td>
</tr>
<tr>
<td><code>dd</code></td>
<td>删除整行</td>
</tr>
<tr>
<td><code>dw</code></td>
<td>删除一个单词(不适用中文)</td>
</tr>
<tr>
<td><code>d$</code> 或 <code>D</code></td>
<td>删除至行尾</td>
</tr>
<tr>
<td><code>d^</code></td>
<td>删除至行首</td>
</tr>
<tr>
<td><code>dG</code></td>
<td>删除到文档结尾</td>
</tr>
<tr>
<td><code>d1G</code></td>
<td>删除至文档开头</td>
</tr>
<tr>
<td><code>:%d</code></td>
<td>清空整个文档内容（删除所有行）</td>
</tr>
<tr>
<td><code>:1,$d</code></td>
<td>同 <code>:%d</code>，删除从第一行到最后一行</td>
</tr>
<tr>
<td><code>ggdG</code></td>
<td>普通模式下清空文档的快捷方式（先跳转到首行，然后删除到末尾）</td>
</tr>
</tbody>
</table>
<p>注意：这些命令会立即生效且不可撤销，使用前请确保已保存重要内容</p>
<h3 id="数字前缀用法">数字前缀用法</h3>
<ul>
<li><code>2dd</code> 表示一次删除2行</li>
<li><code>3dw</code> 表示删除3个单词</li>
</ul>
<h2 id="3-重复执行命令">3. 重复执行命令</h2>
<ul>
<li>普通模式下 <code>.</code> (小数点)表示重复上一次命令</li>
<li>数字前缀：<code>10x</code> 删除10个连续字符</li>
</ul>
<h2 id="4-游标跳转">4. 游标跳转</h2>
<h3 id="行间跳转">行间跳转</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>nG</code></td>
<td>跳转到第n行(需先<code>:set nu</code>显示行号)</td>
</tr>
<tr>
<td><code>gg</code></td>
<td>跳转到第一行</td>
</tr>
<tr>
<td><code>G</code></td>
<td>跳转到最后一行</td>
</tr>
</tbody>
</table>
<h3 id="行内跳转">行内跳转</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>w</code></td>
<td>到下一个单词开头</td>
</tr>
<tr>
<td><code>e</code></td>
<td>到当前单词结尾</td>
</tr>
<tr>
<td><code>b</code></td>
<td>到前一个单词开头</td>
</tr>
<tr>
<td><code>ge</code></td>
<td>到前一个单词结尾</td>
</tr>
<tr>
<td><code>0</code> 或 <code>^</code></td>
<td>到行头</td>
</tr>
<tr>
<td><code>$</code></td>
<td>到行尾</td>
</tr>
<tr>
<td><code>f&lt;字母&gt;</code></td>
<td>向后搜索字母并跳转</td>
</tr>
<tr>
<td><code>F&lt;字母&gt;</code></td>
<td>向前搜索字母并跳转</td>
</tr>
<tr>
<td><code>t&lt;字母&gt;</code></td>
<td>向后搜索字母并跳转到匹配前</td>
</tr>
<tr>
<td><code>T&lt;字母&gt;</code></td>
<td>向前搜索字母并跳转到匹配后</td>
</tr>
</tbody>
</table>
<h2 id="5-复制粘贴和剪切">5. 复制粘贴和剪切</h2>
<h3 id="复制命令-yank">复制命令(yank)</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>yy</code></td>
<td>复制整行(3yy复制3行)</td>
</tr>
<tr>
<td><code>y^</code></td>
<td>复制至行首</td>
</tr>
<tr>
<td><code>y$</code></td>
<td>复制至行尾</td>
</tr>
<tr>
<td><code>yw</code></td>
<td>复制一个单词</td>
</tr>
<tr>
<td><code>yG</code></td>
<td>复制至文本末</td>
</tr>
<tr>
<td><code>y1G</code></td>
<td>复制至文本开头</td>
</tr>
</tbody>
</table>
<h3 id="粘贴命令">粘贴命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>p</code></td>
<td>粘贴至光标后</td>
</tr>
<tr>
<td><code>P</code></td>
<td>粘贴至光标前</td>
</tr>
</tbody>
</table>
<h2 id="6-替换和撤销">6. 替换和撤销</h2>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>r+&lt;字母&gt;</code></td>
<td>替换游标所在字母</td>
</tr>
<tr>
<td><code>R</code></td>
<td>连续替换(按Esc结束)</td>
</tr>
<tr>
<td><code>cc</code></td>
<td>替换整行</td>
</tr>
<tr>
<td><code>cw</code></td>
<td>替换一个单词</td>
</tr>
<tr>
<td><code>C</code></td>
<td>替换至行末</td>
</tr>
<tr>
<td><code>~</code></td>
<td>反转字母大小写</td>
</tr>
<tr>
<td><code>u</code></td>
<td>撤销操作</td>
</tr>
<tr>
<td><code>U</code></td>
<td>撤销当前行所有修改</td>
</tr>
<tr>
<td><code>Ctrl+r</code></td>
<td>重做(redo)</td>
</tr>
</tbody>
</table>
<h2 id="7-缩进调整">7. 缩进调整</h2>
<h3 id="缩进命令">缩进命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&gt;&gt;</code></td>
<td>整行向右缩进</td>
</tr>
<tr>
<td><code>&lt;&lt;</code></td>
<td>整行向左回退</td>
</tr>
<tr>
<td><code>:set shiftwidth=n</code></td>
<td>设置缩进字符数</td>
</tr>
</tbody>
</table>
<h3 id="文本位置调整">文本位置调整</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>:ce</code></td>
<td>本行内容居中</td>
</tr>
<tr>
<td><code>:ri</code></td>
<td>本行文本靠右</td>
</tr>
<tr>
<td><code>:le</code></td>
<td>本行内容靠左</td>
</tr>
</tbody>
</table>
<h2 id="8-查找功能">8. 查找功能</h2>
<h3 id="基本查找">基本查找</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/字符串</code></td>
<td>向下查找</td>
</tr>
<tr>
<td><code>?字符串</code></td>
<td>向上查找</td>
</tr>
<tr>
<td><code>n</code></td>
<td>继续查找</td>
</tr>
<tr>
<td><code>N</code></td>
<td>反向查找</td>
</tr>
</tbody>
</table>
<h3 id="高级查找">高级查找</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*</code></td>
<td>向后查找当前单词</td>
</tr>
<tr>
<td><code>#</code></td>
<td>向前查找当前单词</td>
</tr>
<tr>
<td><code>g*</code></td>
<td>向后查找部分匹配单词</td>
</tr>
<tr>
<td><code>g#</code></td>
<td>向前查找部分匹配单词</td>
</tr>
</tbody>
</table>
<h2 id="9-多文件编辑">9. 多文件编辑</h2>
<h3 id="多文件操作">多文件操作</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>:n</code></td>
<td>编辑下一个文件</td>
</tr>
<tr>
<td><code>:N</code></td>
<td>编辑上一个文件</td>
</tr>
<tr>
<td><code>:e 文件名</code></td>
<td>打开新文件</td>
</tr>
<tr>
<td><code>:e#</code></td>
<td>回到前一个文件</td>
</tr>
<tr>
<td><code>:ls</code></td>
<td>列出编辑过的文档</td>
</tr>
<tr>
<td><code>:b 文件名/编号</code></td>
<td>切换到指定文件</td>
</tr>
<tr>
<td><code>:bd 文件名/编号</code></td>
<td>从列表删除文件</td>
</tr>
<tr>
<td><code>:f</code></td>
<td>显示当前文件名</td>
</tr>
</tbody>
</table>
<h3 id="文件恢复">文件恢复</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim -r 文件名</span><br><span class="line">:ewcover 文件名</span><br></pre></td></tr></table></figure>
<h2 id="10-可视模式">10. 可视模式</h2>
<h3 id="进入可视模式">进入可视模式</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>v</code></td>
<td>字符选择模式</td>
</tr>
<tr>
<td><code>V</code></td>
<td>行选择模式</td>
</tr>
<tr>
<td><code>Ctrl+v</code></td>
<td>区域选择模式</td>
</tr>
</tbody>
</table>
<h3 id="可视模式操作">可视模式操作</h3>
<ul>
<li><code>d</code> 删除选中区域</li>
<li><code>y</code> 复制选中区域</li>
</ul>
<h2 id="11-视窗操作">11. 视窗操作</h2>
<h3 id="窗口分割">窗口分割</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>:new</code></td>
<td>新建窗口</td>
</tr>
<tr>
<td><code>:sp 文件名</code></td>
<td>水平分割窗口</td>
</tr>
<tr>
<td><code>:vsp 文件名</code></td>
<td>垂直分割窗口</td>
</tr>
<tr>
<td><code>Ctrl+w s</code></td>
<td>水平分割当前窗口</td>
</tr>
<tr>
<td><code>Ctrl+w v</code></td>
<td>垂直分割当前窗口</td>
</tr>
</tbody>
</table>
<h3 id="窗口切换">窗口切换</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ctrl+w j/k/h/l</code></td>
<td>向下/上/左/右切换窗口</td>
</tr>
<tr>
<td><code>Ctrl+w q</code></td>
<td>关闭当前窗口</td>
</tr>
<tr>
<td><code>Ctrl+w o</code></td>
<td>只保留当前窗口</td>
</tr>
</tbody>
</table>
<h2 id="12-其他功能">12. 其他功能</h2>
<h3 id="文档加密">文档加密</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim -x 文件名</span><br></pre></td></tr></table></figure>
<h3 id="执行外部命令">执行外部命令</h3>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:!命令</span><br><span class="line">:<span class="keyword">w</span> 文件名  # 另存为</span><br></pre></td></tr></table></figure>
<h3 id="帮助系统">帮助系统</h3>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:F1        # 打开帮助</span><br><span class="line">:h 主题    # 查看特定帮助</span><br><span class="line">:ver       # 显示版本</span><br></pre></td></tr></table></figure>
<h3 id="功能设定">功能设定</h3>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">set</span> <span class="keyword">nu</span>    # 显示行号</span><br><span class="line">:<span class="keyword">set</span> ai    # 自动缩进</span><br><span class="line">:<span class="keyword">set</span> aw    # 自动保存</span><br><span class="line">:<span class="keyword">set</span> cin   # C语言风格缩进</span><br></pre></td></tr></table></figure>
<blockquote>
<p>提示：所有设置可通过修改 <code>~/.vimrc</code> 文件永久保存</p>
</blockquote>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2025/05/12/vim%E6%95%99%E7%A8%8B/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                            aria-label=": Terraform-小技巧"
                        >
                            Terraform-小技巧
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-01-30T17:43:45+08:00">
	
		    2023 年 1 月 30 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="Terraform/">Terraform</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <ul>
<li><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"><strong>1.9.1.1.</strong> 有条件创建</a></li>
</ul>
<p><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"></a></p>
<h2 id="1-9-1-1-有条件创建"><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"></a>1.9.1.1. 有条件创建</h2>
<p>Terraform被设计成声明式而非命令式，例如没有常见的 <code>if</code> 条件语句，后来才加上了 <code>count</code> 和 <code>for_each</code> 实现的循环语句(但循环的次数必须是在 <code>plan</code> 阶段就能够确认的，无法根据其他 <code>resource</code> 的输出动态决定)</p>
<p>有时候我们需要根据某种条件来判断是否创建一个资源。虽然我们无法使用if来完成条件判断，但我们还有 <code>count</code> 和 <code>for_each</code> 可以帮助我们完成这个目标。</p>
<p>我们以 UCloud 为例，假如我们正在编写一个旨在被复用的模块，模块的逻辑要创建一台虚拟机，我们的代码可以是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">data ucloud_vpcs &quot;default&quot; &#123;</span><br><span class="line">  name_regex = &quot;^Default&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-02&quot;</span><br><span class="line">  image_id = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type = &quot;n-basic-2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;uhost_id&quot; &#123;</span><br><span class="line">  value = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常简单。但是如果我们想进一步，让模块的调用者决定创建的主机是否要搭配一个弹性公网 IP 该怎么办？</p>
<p>我们可以在上面的代码后面接上这样的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;allocate_public_ip&quot; &#123;</span><br><span class="line">  description = &quot;Decide whether to allocate a public ip and bind it to the host&quot;</span><br><span class="line">  type = bool</span><br><span class="line">  default = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip&quot; &quot;public_ip&quot; &#123;</span><br><span class="line">  count = var.allocate_public_ip ? 1 : 0</span><br><span class="line">  name = &quot;public_ip_for_$&#123;ucloud_instance.web.name&#125;&quot;</span><br><span class="line">  internet_type = &quot;bgp&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip_association&quot; &quot;public_ip_binding&quot; &#123;</span><br><span class="line">  count = var.allocate_public_ip ? 1 : 0</span><br><span class="line">  eip_id = ucloud_eip.public_ip[0].id</span><br><span class="line">  resource_id = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们首先创建了名为 <code>allocate_public_ip</code> 的输入变量，然后在编写弹性 IP 相关资源代码的时候都声明了 <code>count</code> 参数，值使用了条件表达式，根据 <code>allocate_public_ip</code> 这个输入变量的值决定是 <code>1</code> 还是 <code>0</code>。这实际上实现了按条件创建资源。</p>
<p>需要注意的是，由于我们使用了 <code>count</code>，所以现在弹性 IP 相关的资源实际上是多实例资源类型的。我们在 <code>ucloud_eip_association.public_ip_binding</code> 中引用 <code>ucloud_eip.public</code> 时，还是要加上访问下标。由于 <code>ucloud_eip_association.public_ip_binding</code> 与 <code>ucloud_eip.public</code> 实际上是同生同死，所以在这里他们之间的引用还比较简单；如果是其他没有声明 <code>count</code> 的资源引用它们的话，还要针对 <code>allocate_public_ip</code> 为 <code>false</code> 时 <code>ucloud_eip.public</code> 实际为空做相应处理，比如在 <code>output</code> 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output &quot;public_ip&quot; &#123;</span><br><span class="line">  value = join(&quot;&quot;, ucloud_eip.public_ip[*].public_ip)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>join</code> 函数就可以在即使没有创建弹性 IP 时也能返回空字符串。或者我们也可以用条件表达式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output &quot;public_ip&quot; &#123;</span><br><span class="line">  value = length(ucloud_eip.public_ip[*].public_ip) &gt; 0 ? ucloud_eip.public_ip[0].public_ip : &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"><strong>1.9.2.1.</strong> 依赖反转</a></li>
</ul>
<p><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"></a></p>
<h2 id="1-9-2-1-依赖反转"><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"></a>1.9.2.1. 依赖反转</h2>
<p>Terraform 编排的基础设施对象彼此之间可能互相存在依赖关系，有时我们在编写一些旨在重用的模块时，模块内定义的资源可能本身需要依赖其他一些资源，这些资源可能已经存在，也可能有待创建。</p>
<p>举一个例子，假设我们编写了一个模块，定义了在 UCloud 上同一个 VPC 中的两台服务器；第一台服务器部署了一个 Web 应用，它被分配在一个 DMZ 子网里；第二台服务器部署了一个数据库，它被分配在一个内网子网里。现在的问题是，在我们编写模块时，我们并没有关于 VPC 和子网的任何信息，我们甚至连服务器应该部署在哪个可用区都不知道。VPC 和子网可能已经存在，也可以有待创建。</p>
<p>我们可以定义这样的一个模块代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    ucloud = &#123;</span><br><span class="line">      source  = &quot;ucloud/ucloud&quot;</span><br><span class="line">      version = &quot;~&gt;1.22.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;network_config&quot; &#123;</span><br><span class="line">  type = object(&#123;</span><br><span class="line">    vpc_id         = string</span><br><span class="line">    web_app_config = object(&#123;</span><br><span class="line">      az        = string</span><br><span class="line">      subnet_id = string</span><br><span class="line">    &#125;)</span><br><span class="line">    db_config      = object(&#123;</span><br><span class="line">      az        = string</span><br><span class="line">      subnet_id = string</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;web_app&quot; &#123;</span><br><span class="line">  name_regex = &quot;^WebApp&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;mysql&quot; &#123;</span><br><span class="line">  name_regex = &quot;^MySql 5.7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web_app&quot; &#123;</span><br><span class="line">  availability_zone = var.network_config.web_app_config.az</span><br><span class="line">  image_id          = data.ucloud_images.web_app.images[0].id</span><br><span class="line">  instance_type     = &quot;n-basic-2&quot;</span><br><span class="line">  vpc_id            = var.network_config.vpc_id</span><br><span class="line">  subnet_id         = var.network_config.web_app_config.subnet_id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;mysql&quot; &#123;</span><br><span class="line">  availability_zone = var.network_config.db_config.az</span><br><span class="line">  image_id          = data.ucloud_images.mysql.images[0].id</span><br><span class="line">  instance_type     = &quot;n-basic-2&quot;</span><br><span class="line">  vpc_id            = var.network_config.vpc_id</span><br><span class="line">  subnet_id         = var.network_config.db_config.subnet_id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在代码中我们把依赖的网络参数定义为一个复杂类型，一个强类型对象结构。这样的话模块代码就不用再关注网络层究竟是查询而来的还是创建的，模块中只定义了抽象的网络层定义，其具体实现由调用者从外部注入，从而实现了依赖反转。</p>
<p>如果调用者需要创建网络层，那么代码可以是这样的(假设我们把前面编写的模块保存在 <code>./machine</code> 目录下而成为一个内嵌模块)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  cidr_blocks = [</span><br><span class="line">    &quot;192.168.0.0/16&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;dmz&quot; &#123;</span><br><span class="line">  cidr_block = &quot;192.168.0.0/24&quot;</span><br><span class="line">  vpc_id     = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;db&quot; &#123;</span><br><span class="line">  cidr_block = &quot;192.168.1.0/24&quot;</span><br><span class="line">  vpc_id     = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module &quot;machine&quot; &#123;</span><br><span class="line">  source         = &quot;./machine&quot;</span><br><span class="line">  network_config = &#123;</span><br><span class="line">    vpc_id         = ucloud_vpc.vpc.id</span><br><span class="line">    web_app_config = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = ucloud_subnet.dmz.id</span><br><span class="line">    &#125;</span><br><span class="line">    db_config      = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = ucloud_subnet.db.id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者我们想使用现存的网络来托管服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">data &quot;ucloud_vpcs&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  name_regex = &quot;^AVeryImportantVpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_subnets&quot; dmz_subnet &#123;</span><br><span class="line">  vpc_id     = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">  name_regex = &quot;^DMZ&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_subnets&quot; &quot;db_subnet&quot; &#123;</span><br><span class="line">  vpc_id     = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">  name_regex = &quot;^DataBase&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module &quot;machine&quot; &#123;</span><br><span class="line">  source         = &quot;./machine&quot;</span><br><span class="line">  network_config = &#123;</span><br><span class="line">    vpc_id         = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">    web_app_config = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = data.ucloud_subnets.dmz_subnet.subnets[0].id</span><br><span class="line">    &#125;</span><br><span class="line">    db_config      = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = data.ucloud_subnets.db_subnet.subnets[0].id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于模块代码中对网络层的定义是抽象的，并没有指定必须是 <code>resource</code> 或是 <code>data</code>，所以使得模块的调用者可以自己决定如何构造模块的依赖层，作为参数注入模块。</p>
<ul>
<li><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"><strong>1.9.3.1.</strong> 多可用区分布</a></li>
</ul>
<p><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"></a></p>
<h2 id="1-9-3-1-多可用区分布"><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"></a>1.9.3.1. 多可用区分布</h2>
<p>这是一个相当常见的小技巧。多数公有云为了高可用性，都在单一区域内提供了多可用区的设计。一个可区是一个逻辑上的数据中心，单个可用区可能由于各种自然灾害、网络故障而导致不可用，所以公有云应用部署高可用应用应时刻考虑跨可用区设计。</p>
<p>假如我们想要创建 N 台不同的云主机实例，在 Terraform 0.12 之前的版本中，我们只能用 <code>count</code> 配合模运算来达成这个目的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type    = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;instance_count&quot; &#123;</span><br><span class="line">  type    = number</span><br><span class="line">  default = 4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  count             = var.instance_count</span><br><span class="line">  availability_zone = var.az[count.index % length(var.az)]</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  name              = &quot;$&#123;var.az[count.index % length(var.az)]&#125;-$&#123;floor(count.index/length(var.az))&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说就是使用 <code>count</code> 创建多实例资源时，用 <code>var.az[count.index % length(var.az)]</code> 可以循环使用每个可用区，使得机器尽可能均匀分布在各个可用区。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web[2]: Creating...</span><br><span class="line">ucloud_instance.web[0]: Creating...</span><br><span class="line">ucloud_instance.web[1]: Creating...</span><br><span class="line">ucloud_instance.web[3]: Creating...</span><br><span class="line">ucloud_instance.web[2]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[1]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[3]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[2]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[1]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[3]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[2]: Creation complete after 22s [<span class="built_in">id</span>=uhost-txa2owrp]</span><br><span class="line">ucloud_instance.web[3]: Creation complete after 24s [<span class="built_in">id</span>=uhost-v3qxdbju]</span><br><span class="line">ucloud_instance.web[1]: Creation complete after 26s [<span class="built_in">id</span>=uhost-td3x545p]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Creation complete after 43s [<span class="built_in">id</span>=uhost-scq1prqj]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 4 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure>
<p>我们可以看一下创建的主机信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line">$ terraform show</span><br><span class="line"><span class="comment"># data.ucloud_images.centos:</span></span><br><span class="line">data <span class="string">&quot;ucloud_images&quot;</span> <span class="string">&quot;centos&quot;</span> &#123;</span><br><span class="line">    <span class="built_in">id</span>          = <span class="string">&quot;475496684&quot;</span></span><br><span class="line">    ids         = [</span><br><span class="line">        <span class="string">&quot;uimage-22noyd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-3p0wg0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-4keil1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-aqvo5l&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-f1chxn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-hq5elw&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-rkn1v2&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    images      = [</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-23T17:39:46+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.0 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.0 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:03+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-f1chxn&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.2 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.2 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-09-09T11:40:31+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot; &quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-aqvo5l&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.4 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.4 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2020-05-07T17:40:42+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CloudInit&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-hq5elw&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.6 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.6 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:05+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-3p0wg0&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.3 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.3 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:02+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-4keil1&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.1 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.1 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:04:53+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-22noyd&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.5 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.5 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    most_recent = <span class="literal">false</span></span><br><span class="line">    name_regex  = <span class="string">&quot;^CentOS 7&quot;</span></span><br><span class="line">    total_count = 7</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[1]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-04-0&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[2]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[3]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;31e2cad6-79a1-4475-a9f5-2c5c95605b18&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-v3qxdbju&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-04-1&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[0]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;da27595d-9645-4883-bf95-87b9076ab7e4&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-scq1prqj&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.107.152&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-03-0&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.107.152&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，主机的确是均匀地分散在两个可用区了。</p>
<p>但是这样做在调整可用区时会发生大问题，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">#    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们禁用了 <code>cn-bj2-04</code> 可用区，按道理我们期待的变更计划应该是将两台原本属于 <code>cn-bj2-04</code> 的主机删除，在 <code>cn-bj2-03</code> 可用区新增两台主机。让我们看看会发生什么：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to <span class="built_in">local</span> or remote state storage.</span><br><span class="line"></span><br><span class="line">data.ucloud_images.centos: Refreshing state... [<span class="built_in">id</span>=475496684]</span><br><span class="line">ucloud_instance.web[0]: Refreshing state... [<span class="built_in">id</span>=uhost-scq1prqj]</span><br><span class="line">ucloud_instance.web[3]: Refreshing state... [<span class="built_in">id</span>=uhost-v3qxdbju]</span><br><span class="line">ucloud_instance.web[2]: Refreshing state... [<span class="built_in">id</span>=uhost-txa2owrp]</span><br><span class="line">ucloud_instance.web[1]: Refreshing state... [<span class="built_in">id</span>=uhost-td3x545p]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">An execution plan has been generated and is shown below.</span><br><span class="line">Resource actions are indicated with the following symbols:</span><br><span class="line">  ~ update in-place</span><br><span class="line">-/+ destroy and <span class="keyword">then</span> create replacement</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[1] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.44.37&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[2] will be updated in-place</span></span><br><span class="line">  ~ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">        auto_renew        = <span class="literal">true</span></span><br><span class="line">        availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">        boot_disk_size    = 20</span><br><span class="line">        boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">        cpu               = 1</span><br><span class="line">        cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">        create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">        disk_set          = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">                is_boot = <span class="literal">true</span></span><br><span class="line">                size    = 20</span><br><span class="line">                <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">        expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">        <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">        image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">        ip_set            = [</span><br><span class="line">            &#123;</span><br><span class="line">                internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">                ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">        memory            = 4</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-03-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">        private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">        root_password     = (sensitive value)</span><br><span class="line">        security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">        status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">        subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">        vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[3] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;31e2cad6-79a1-4475-a9f5-2c5c95605b18&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-v3qxdbju&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-3&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.85.40&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 1 to change, 2 to destroy.</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Note: You didn<span class="string">&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraform</span></span><br><span class="line"><span class="string">can&#x27;</span>t guarantee that exactly these actions will be performed <span class="keyword">if</span></span><br><span class="line"><span class="string">&quot;terraform apply&quot;</span> is subsequently run.</span><br></pre></td></tr></table></figure>
<p>变更计划与期望略有不同。我们仔细看细节：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ucloud_instance.web[2] will be updated in-place</span></span><br><span class="line">~ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      auto_renew        = <span class="literal">true</span></span><br><span class="line">      availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      boot_disk_size    = 20</span><br><span class="line">      boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">      charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      cpu               = 1</span><br><span class="line">      cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">      create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">      disk_set          = [</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">              is_boot = <span class="literal">true</span></span><br><span class="line">              size    = 20</span><br><span class="line">              <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">      ]</span><br><span class="line">      expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">      <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">      image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">      instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ip_set            = [</span><br><span class="line">          &#123;</span><br><span class="line">              internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">      ]</span><br><span class="line">      memory            = 4</span><br><span class="line">    ~ name              = <span class="string">&quot;cn-bj2-03-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">      private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">      root_password     = (sensitive value)</span><br><span class="line">      security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">      status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">      subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">      tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>原本名为 <code>cn-bj2-03-1</code> 的主机被更名为 <code>cn-bj2-03-2</code> 了，原本属于 <code>cn-bj2-04</code> 的第一台主机的变更计划是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># ucloud_instance.web[1] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.44.37&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>它的名字从 <code>cn-bj2-04-0</code> 变成了 <code>cn-bj2-03-1</code>。</p>
<p>仔细想想，实际上这是一个比较低效的变更计划。原本属于 <code>cn-bj2-03</code> 的两台主机应该不做任何变更，只需要删除 <code>cn-bj2-04</code> 的主机，再补充两台 <code>cn-bj2-03</code> 的主机即可。这是因为我们使用的是 <code>count</code>，而 <code>count</code> 只看元素在列表中的序号。当我们删除一个可用区时，实际上会引起主机序号的重大变化，导致出现大量低效的变更，这就是我们在讲 <code>count</code> 与 <code>for_each</code> 时强调过的，如果创建的资源实例彼此之间几乎完全一致，那么 <code>count</code> 比较合适。否则，那么使用 <code>for_each</code> 会更加安全。</p>
<p>让我们尝试使用 <code>for_each</code> 改写这段逻辑：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type    = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;instance_count&quot; &#123;</span><br><span class="line">  type    = number</span><br><span class="line">  default = 4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">locals &#123;</span><br><span class="line">  instance_names = [for i in range(var.instance_count):&quot;$&#123;var.az[i%length(var.az)]&#125;-$&#123;floor(i/length(var.az))&#125;&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  for_each          = toset(local.instance_names)</span><br><span class="line">  name              = each.value</span><br><span class="line">  availability_zone = var.az[index(local.instance_names, each.value) % length(var.az)]</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了生成主机独一无二的名字，我们首先用 <code>range</code> 函数生成了一个序号集合，比如目标主机数是 <code>4</code>，那么 <code>range(4)</code> 的结果就是 <code>[0, 1, 2, 3]</code>；然后我们通过取模运算使得名字前缀在可用区列表之间循环递增，最后用 <code>floor(i/length(var.az))</code> 计算出当前序号对应在当前可用区是第几台。例如 4 号主机在第二个可用区就是第二台，生成的名字应该就是 <code>cn-bj-04-1</code>。</p>
<p>执行结果是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Creation complete after 21s [<span class="built_in">id</span>=uhost-fjci1i4o]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Creation complete after 23s [<span class="built_in">id</span>=uhost-bkkhmref]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Creation complete after 26s [<span class="built_in">id</span>=uhost-amosgdaa]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Creation complete after 45s [<span class="built_in">id</span>=uhost-kltudgnf]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 4 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure>
<p>如果我们去掉一个可用区：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">#    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以检查一下执行计划：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to <span class="built_in">local</span> or remote state storage.</span><br><span class="line"></span><br><span class="line">data.ucloud_images.centos: Refreshing state... [<span class="built_in">id</span>=475496684]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-amosgdaa]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-bkkhmref]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-kltudgnf]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-fjci1i4o]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">An execution plan has been generated and is shown below.</span><br><span class="line">Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line">  - destroy</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-03-2&quot;] will be created</span></span><br><span class="line">  + resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      + auto_renew        = (known after apply)</span><br><span class="line">      + availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      + boot_disk_size    = (known after apply)</span><br><span class="line">      + boot_disk_type    = (known after apply)</span><br><span class="line">      + charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      + cpu               = (known after apply)</span><br><span class="line">      + cpu_platform      = (known after apply)</span><br><span class="line">      + create_time       = (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      + disk_set          = (known after apply)</span><br><span class="line">      + expire_time       = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                = (known after apply)</span><br><span class="line">      + image_id          = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">      + instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      + ip_set            = (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      + memory            = (known after apply)</span><br><span class="line">      + name              = <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">      + private_ip        = (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      + root_password     = (sensitive value)</span><br><span class="line">      + security_group    = (known after apply)</span><br><span class="line">      + status            = (known after apply)</span><br><span class="line">      + subnet_id         = (known after apply)</span><br><span class="line">      + tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      + vpc_id            = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-03-3&quot;] will be created</span></span><br><span class="line">  + resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      + auto_renew        = (known after apply)</span><br><span class="line">      + availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      + boot_disk_size    = (known after apply)</span><br><span class="line">      + boot_disk_type    = (known after apply)</span><br><span class="line">      + charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      + cpu               = (known after apply)</span><br><span class="line">      + cpu_platform      = (known after apply)</span><br><span class="line">      + create_time       = (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      + disk_set          = (known after apply)</span><br><span class="line">      + expire_time       = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                = (known after apply)</span><br><span class="line">      + image_id          = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">      + instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      + ip_set            = (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      + memory            = (known after apply)</span><br><span class="line">      + name              = <span class="string">&quot;cn-bj2-03-3&quot;</span></span><br><span class="line">      + private_ip        = (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      + root_password     = (sensitive value)</span><br><span class="line">      + security_group    = (known after apply)</span><br><span class="line">      + status            = (known after apply)</span><br><span class="line">      + subnet_id         = (known after apply)</span><br><span class="line">      + tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      + vpc_id            = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-04-0&quot;] will be destroyed</span></span><br><span class="line">  - resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      - auto_renew        = <span class="literal">true</span> -&gt; null</span><br><span class="line">      - availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; null</span><br><span class="line">      - boot_disk_size    = 20 -&gt; null</span><br><span class="line">      - boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; null</span><br><span class="line">      - charge_type       = <span class="string">&quot;dynamic&quot;</span> -&gt; null</span><br><span class="line">      - cpu               = 1 -&gt; null</span><br><span class="line">      - cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; null</span><br><span class="line">      - create_time       = <span class="string">&quot;2020-11-28T22:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;b214d840-ffec-4958-a3da-3580846fd2a3&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - expire_time       = <span class="string">&quot;2020-11-28T23:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - <span class="built_in">id</span>                = <span class="string">&quot;uhost-bkkhmref&quot;</span> -&gt; null</span><br><span class="line">      - image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; null</span><br><span class="line">      - instance_type     = <span class="string">&quot;n-standard-1&quot;</span> -&gt; null</span><br><span class="line">      - ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.48.82&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - memory            = 4 -&gt; null</span><br><span class="line">      - name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; null</span><br><span class="line">      - private_ip        = <span class="string">&quot;10.9.48.82&quot;</span> -&gt; null</span><br><span class="line">      - root_password     = (sensitive value)</span><br><span class="line">      - security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; null</span><br><span class="line">      - status            = <span class="string">&quot;Running&quot;</span> -&gt; null</span><br><span class="line">      - subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; null</span><br><span class="line">      - tag               = <span class="string">&quot;Default&quot;</span> -&gt; null</span><br><span class="line">      - vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-04-1&quot;] will be destroyed</span></span><br><span class="line">  - resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      - auto_renew        = <span class="literal">true</span> -&gt; null</span><br><span class="line">      - availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; null</span><br><span class="line">      - boot_disk_size    = 20 -&gt; null</span><br><span class="line">      - boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; null</span><br><span class="line">      - charge_type       = <span class="string">&quot;dynamic&quot;</span> -&gt; null</span><br><span class="line">      - cpu               = 1 -&gt; null</span><br><span class="line">      - cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; null</span><br><span class="line">      - create_time       = <span class="string">&quot;2020-11-28T22:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;6a3f274f-e072-4a46-90f8-edc7dbaa27f7&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - expire_time       = <span class="string">&quot;2020-11-28T23:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - <span class="built_in">id</span>                = <span class="string">&quot;uhost-fjci1i4o&quot;</span> -&gt; null</span><br><span class="line">      - image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; null</span><br><span class="line">      - instance_type     = <span class="string">&quot;n-standard-1&quot;</span> -&gt; null</span><br><span class="line">      - ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.176.28&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - memory            = 4 -&gt; null</span><br><span class="line">      - name              = <span class="string">&quot;cn-bj2-04-1&quot;</span> -&gt; null</span><br><span class="line">      - private_ip        = <span class="string">&quot;10.9.176.28&quot;</span> -&gt; null</span><br><span class="line">      - root_password     = (sensitive value)</span><br><span class="line">      - security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; null</span><br><span class="line">      - status            = <span class="string">&quot;Running&quot;</span> -&gt; null</span><br><span class="line">      - subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; null</span><br><span class="line">      - tag               = <span class="string">&quot;Default&quot;</span> -&gt; null</span><br><span class="line">      - vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 2 to destroy.</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Note: You didn<span class="string">&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraform</span></span><br><span class="line"><span class="string">can&#x27;</span>t guarantee that exactly these actions will be performed <span class="keyword">if</span></span><br><span class="line"><span class="string">&quot;terraform apply&quot;</span> is subsequently run.</span><br></pre></td></tr></table></figure>
<p>可以看到，原来属于 <code>cn-bj2-03</code> 的两台主机原封不动，删除了属于 <code>cn-bj2-04</code> 的两台主机，并且在 <code>cn-bj2-03</code> 可用区新增两台主机。</p>
<ul>
<li><a href="#provisioner-%E4%B8%8E-userdata"><strong>1.9.4.1.</strong> provisioner 与 user_data</a></li>
</ul>
<p><a href="#provisioner-%E4%B8%8E-userdata"></a></p>
<h2 id="1-9-4-1-provisioner-与-user-data"><a href="#provisioner-%E4%B8%8E-userdata"></a>1.9.4.1. provisioner 与 user_data</h2>
<p>我们在介绍资源时介绍了<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/6.%E8%B5%84%E6%BA%90.html#provisioner-%E5%92%8C-connection">预置器 <code>provisioner</code></a>。同时不少公有云厂商的虚拟机都提供了 cloud-init 功能，可以让我们在虚拟机实例第一次启动时执行一段自定义的脚本来执行一些初始化操作。例如我们在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/1.Terraform%E5%88%9D%E6%AD%A5%E4%BD%93%E9%AA%8C/">Terraform 初步体验</a>一章里举的例子，在 UCloud 主机第一次启动时我们通过 <code>user_data</code> 来调用 yum 安装并配置了 ngnix 服务。预置器与 cloud-init 都可以用于初始化虚拟机，那么我们应该用哪一种呢？</p>
<p>首先要指出的是，<code>provisioner</code> 的官方文档里明确指出，由于预置器内部的行为 Terraform 无法感知，无法将它执行的变更纳入到声明式的代码管理中，所以预置器应被作为最后的手段使用，那么也就是说，如果 cloud-init 能够满足我们的要求，那么我们应该优先使用 cloud-init。</p>
<p>但是仍然存在一些 cloud-init 无法满足的场景。例如一个最常见的情况是，比如我们要在 cloud-init 当中格式化卷，后续的所有操作都必须在主机成功格式化并挂载卷之后才能顺利进行下去。但是比如 <code>aws_instance</code>，它的创建是不会等待 <code>user_data</code> 代码执行完成的，只要虚拟机创建成功开始启动，Terraform 就会认为资源创建完成从而继续后续的创建了。</p>
<p>解决这个问题目前来看还是只能依靠预置器。我们以一段 UCloud 云主机代码为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone         = &quot;cn-bj2-03&quot;</span><br><span class="line">  image_id                  = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type             = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type               = &quot;dynamic&quot;</span><br><span class="line">  network_interface &#123;</span><br><span class="line">    eip_internet_type = &quot;bgp&quot;</span><br><span class="line">    eip_charge_mode   = &quot;traffic&quot;</span><br><span class="line">    eip_bandwidth     = 1</span><br><span class="line">  &#125;</span><br><span class="line">  delete_eips_with_instance = true</span><br><span class="line">  root_password             = var.root_password</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = [for ipset in self.ip_set: ipset.ip if ipset.internet_type==&quot;BGP&quot;][0]</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">      timeout  = &quot;1h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;sleep 1h&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在资源声明中附加了一个 <code>remote-exec</code> 类型的预置器，它的 <code>host</code> 取值使用了 <code>self.ip_set</code>，<code>self</code> 在当前上下文中指代 <code>provisioner</code> 所属的 <code>ucloud_instance.web</code>，<code>ip_set</code> 是 <code>ucloud_instance</code> 的一个输出属性，内含云主机的内网 IP 以及绑定的弹性公网 IP 信息。我们用一个 <code>for</code> 表达式过滤出弹性公网 IP 地址，然后使用 ssh 连接。预置器执行的脚本代码很简单，休眠一小时。如果我们执行这段代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web: Creating...</span><br><span class="line">ucloud_instance.web: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web: Provisioning with <span class="string">&#x27;remote-exec&#x27;</span>...</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec): Connected!</span><br><span class="line">ucloud_instance.web: Still creating... [50s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m0s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m10s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m20s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m30s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m40s elapsed]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>不出所料的话，该过程会持续一小时，也就是说，无论预置器脚本中执行的操作耗时多长，<code>ucloud_instance</code> 的创建都会等待它完成，或是触发超时。</p>
<p>在这里我们可以使用这种方法的前提是我们使用的 UCloud 云主机的资源定义允许我们定义资源时声明 <code>network_interface</code> 属性，直接绑定一个公网 IP。如果我们使用的云厂商 Provider 无法让我们在创建主机时绑定公网 IP，而是必须事后绑定弹性 IP 呢？又或者，初始化脚本必须在云主机成功绑定了云盘之后才能成功运行？这种情况下我们还有最后的武器，就是 <code>null_resource</code>。</p>
<p><code>null_resource</code> 可能是 Terraform 体系中最“不 Terraform”的存在，它就是我们用来在 Terraform 这样一个声明式世界里干各种命令式脏活的工具。<code>null_resouce</code> 本身是一个空的 <code>resource</code>，只有一个名为 <code>triggers</code> 的参数以及 <code>id</code> 作为输出属性。</p>
<p>我们看下这个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip&quot; &quot;eip&quot; &#123;</span><br><span class="line">  internet_type = &quot;bgp&quot;</span><br><span class="line">  bandwidth     = 1</span><br><span class="line">  charge_mode   = &quot;traffic&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_disk&quot; &quot;data_disk&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  disk_size         = 10</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  disk_type         = &quot;data_disk&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  root_password     = var.root_password</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip_association&quot; &quot;eip_association&quot; &#123;</span><br><span class="line">  eip_id      = ucloud_eip.eip.id</span><br><span class="line">  resource_id = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_disk_attachment&quot; &quot;data_disk&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  disk_id           = ucloud_disk.data_disk.id</span><br><span class="line">  instance_id       = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;web_init&quot; &#123;</span><br><span class="line">  depends_on = [</span><br><span class="line">    ucloud_eip_association.eip_association,</span><br><span class="line">    ucloud_disk_attachment.data_disk</span><br><span class="line">  ]</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = ucloud_eip.eip.public_ip</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">    &#125;</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;echo hello&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们假设需要远程执行的操纵是必须在云盘挂载成功以后才可以运行的，那么我们可以声明一个 <code>null_resource</code>，把 <code>provisioner</code> 声明放在那里，通过显式声明 <code>depends_on</code> 确保它的执行一定是在云盘挂载结束以后。</p>
<p>另外这个例子里我们运行的脚本非常简单，考虑一种更加复杂一些的场景，我们运行的脚本是通过文件读取的，我们希望在文件内容发生变化时能够重新在服务器上运行该脚本，这时我们可以使用 <code>null_resource</code> 的 <code>triggers</code> 参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;null_resource&quot; &quot;web_init&quot; &#123;</span><br><span class="line">  depends_on = [</span><br><span class="line">    ucloud_eip_association.eip_association,</span><br><span class="line">    ucloud_disk_attachment.data_disk</span><br><span class="line">  ]</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    script_hash = filemd5(&quot;$&#123;path.module&#125;/init.sh&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = ucloud_eip.eip.public_ip</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">    &#125;</span><br><span class="line">    script = &quot;$&#123;path.module&#125;/init.sh&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在 <code>provisioner</code> 运行的脚本是通过 <code>script</code> 参数传入的脚本文件路径，而我们通过 <code>filemd5</code> 函数把文件内容的哈希值传入了 <code>triggers</code>。<code>triggers</code> 会在值发生改变时触发 <code>null_resource</code> 的重建，这样脚本发生些许变化都会导致重新执行。</p>
<p>官方文档上还给出了对于 <code>triggers</code> 的另一个妙用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_instance&quot; &quot;cluster&quot; &#123;</span><br><span class="line">  count = 3</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;cluster&quot; &#123;</span><br><span class="line">  # Changes to any instance of the cluster requires re-provisioning</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    cluster_instance_ids = &quot;$&#123;join(&quot;,&quot;, aws_instance.cluster.*.id)&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # Bootstrap script can run on any instance of the cluster</span><br><span class="line">  # So we just choose the first in this case</span><br><span class="line">  connection &#123;</span><br><span class="line">    host = &quot;$&#123;element(aws_instance.cluster.*.public_ip, 0)&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    # Bootstrap script called with private_ip of each node in the clutser</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;bootstrap-cluster.sh $&#123;join(&quot; &quot;, aws_instance.cluster.*.private_ip)&#125;&quot;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子里，我们需要所有 AWS 主机的内网 IP 参与才能够成功初始化集群，可能是类似 Kafka 或是 RabbitMQ 这样的应用，我们需要把集群节点的IP写入配置文件。如何确保未来机器数量发生调整以后，机器上的配置文件始终能够获得完整的集群内网 IP 信息，这里使用 <code>triggers</code> 就可以轻松完成目标。</p>
<p>另外在绝大多数生产环境中，服务器都不允许拥有独立的公网 IP，或是禁止从服务器对外服务的公网 IP 直接连接 ssh。这时一般我们会在集群中配置一台堡垒机，通过堡垒机进行跳转连接。可以访问<a target="_blank" rel="noopener" href="https://www.terraform.io/docs/provisioners/connection.html#connecting-through-a-bastion-host-with-ssh">通过堡垒机使用SSH的官方文档</a>获取详细信息，在此不再赘述。</p>
<h2 id="destroy-provisioner中使用变量"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">destroy-provisioner中使用变量</a></h2>
<ul>
<li>
<p><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"><strong>1.9.5.1.</strong> destroy-provisioner 中使用变量</a></p>
</li>
<li>
<p><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><strong>1.9.5.1.1.</strong> 解决方法</a></p>
</li>
</ul>
<p><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"></a></p>
<h2 id="1-9-5-1-destroy-provisioner-中使用变量"><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"></a>1.9.5.1. destroy-provisioner 中使用变量</h2>
<p>我们可以在定义一个 <code>provisioner</code> 块时设置 <code>when</code> 为 <code>destroy</code>，资源在销毁<strong>之前</strong>会首先执行 <code>provisioner</code>，可以帮助我们执行一些析构逻辑。但是如果我们在 Destroy-Provisioner 中引用了变量的话，比如这样的代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_volume_attachment&quot;</span> <span class="string">&quot;attachement_myservice&quot;</span> &#123;</span><br><span class="line">  count         = <span class="string">&quot;$&#123;length(var.network_myservice_subnet_ids)&#125;&quot;</span></span><br><span class="line">  device_name   = <span class="string">&quot;/dev/xvdg&quot;</span></span><br><span class="line">  volume_id     =   <span class="string">&quot;$&#123;element(aws_ebs_volume.ebs_myservice.*.id, count.index)&#125;&quot;</span></span><br><span class="line">  instance_id   =   <span class="string">&quot;$&#123;element(aws_instance.myservice.*.id, count.index)&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">  provisioner <span class="string">&quot;local-exec&quot;</span> &#123;</span><br><span class="line">    command = <span class="string">&quot;aws ec2 stop-instances --instance-ids $&#123;element(aws_instance.myservice.*.id, count.index)&#125; --region $&#123;var.region&#125; &amp;&amp; sleep 30&quot;</span></span><br><span class="line">    when = <span class="string">&quot;destroy&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们会看见这样的报错信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|  Error: Invalid reference from destroy provisioner</span><br><span class="line">│ </span><br><span class="line">│ Destroy-time provisioners and their connection configurations may only reference attributes of the related resource, via &#x27;self&#x27;, &#x27;count.index&#x27;, or &#x27;each.key&#x27;.</span><br><span class="line">│ </span><br><span class="line">│ References to other resources during the destroy phase can cause dependency cycles and interact poorly with create_before_destroy.</span><br></pre></td></tr></table></figure>
<p>从 <code>0.12</code> 开始 Terraform 会对在 Destroy-Time Provisioner 中引用除 <code>self</code>、<code>count.index</code>、<code>each.key</code> 以外的变量做警告，从 <code>0.13</code> 开始则会直接报错。</p>
<h2 id="1-9-5-1-1-解决方法"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"></a>1.9.5.1.1. 解决方法</h2>
<p>目前官方推荐的做法是把需要引用的变量值通过 <code>triggers</code> “捕获”一下再引用，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">&quot;null_resource&quot;</span> <span class="string">&quot;foo&quot;</span> &#123;</span><br><span class="line">  triggers &#123;</span><br><span class="line">    interpreter = <span class="keyword">var</span>.local_exec_interpreter</span><br><span class="line">  &#125;</span><br><span class="line">  provisioner &#123;</span><br><span class="line">    when = destroy</span><br><span class="line"></span><br><span class="line">    interpreter = self.triggers.interpreter</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这种方法就可以避免这个问题。</p>
<ul>
<li>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"><strong>1.9.6.1.</strong> 利用 null_resource 的 triggers 触发其他资源更新</a></p>
</li>
<li>
<p><a href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><strong>1.9.6.1.1.</strong> 问题描述</a></p>
</li>
<li>
<p><a href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><strong>1.9.6.1.2.</strong> 问题原因</a></p>
</li>
<li>
<p><a href="#%E5%B7%A7%E7%94%A8-nullresource-%E7%9A%84-triggers"><strong>1.9.6.1.3.</strong> 巧用 null_resource 的 triggers</a></p>
</li>
<li>
<p><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%AE%9E%E9%AA%8C"><strong>1.9.6.1.4.</strong> 一个小实验</a></p>
</li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"></a></p>
<h2 id="1-9-6-1-利用-null-resource-的-triggers-触发其他资源更新"><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"></a>1.9.6.1. 利用 null_resource 的 triggers 触发其他资源更新</h2>
<p>社区有人提了一个 Terraform 问题，他写了这样一段 Terraform 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;service_bus_connection_string&quot; &#123;</span><br><span class="line">  name = &quot;service-bus-connection-string&quot;</span><br><span class="line"></span><br><span class="line">  value        = azurerm_servicebus_topic_authorization_rule.mysb.primary_connection_string</span><br><span class="line">  key_vault_id = azurerm_key_vault.main.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_function_app&quot; &quot;main&quot; &#123;</span><br><span class="line">  name                = &quot;myfn&quot;</span><br><span class="line">  location            = azurerm_resource_group.main.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.main.name</span><br><span class="line"></span><br><span class="line">  app_service_plan_id = azurerm_app_service_plan.main.id</span><br><span class="line"></span><br><span class="line">  enable_builtin_logging = true</span><br><span class="line">  https_only             = true</span><br><span class="line">  os_type                = &quot;linux&quot;</span><br><span class="line"></span><br><span class="line">  storage_account_name       = azurerm_storage_account.main.name</span><br><span class="line">  storage_account_access_key = azurerm_storage_account.main.primary_access_key</span><br><span class="line"></span><br><span class="line">  version = &quot;~3&quot;</span><br><span class="line"></span><br><span class="line">  app_settings = &#123;</span><br><span class="line">    AzureWebJobsServiceBus      = &quot;@Microsoft.KeyVault(SecretUri=$&#123;azurerm_key_vault_secret.service_bus_connection_string.id&#125;)&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>意思大概是他把一段含有机密信息的连接字符串保存在 Azure KeyVault 服务中，然后创建了一个 Azure Faas 函数，通过 KeyVault 机密引用地址传递该机密。</p>
<h2 id="1-9-6-1-1-问题描述"><a href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"></a>1.9.6.1.1. 问题描述</h2>
<p>这位老兄发现，如果他修改了机密的内容，也就是 <code>azurerm_key_vault_secret</code> 声明里的 <code>value = azurerm_servicebus_topic_authorization_rule.mysb.primary_connection_string</code> 这一段的值的时候，KeyVault 保存的机密内容的确会正确更新，但 Azure Function 读取到的还是旧的机密引用地址，也就是这段代码中得到的 KeyVault 机密引用地址没有更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app_settings = &#123;</span><br><span class="line">  AzureWebJobsServiceBus      = &quot;@Microsoft.KeyVault(SecretUri=$&#123;azurerm_key_vault_secret.service_bus_connection_string.id&#125;)&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更加奇怪的是，这之后他什么都没有做，只是重新再执行一次 <code>terraform apply</code>，该引用地址又被正确更新了？！</p>
<h2 id="1-9-6-1-2-问题原因"><a href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"></a>1.9.6.1.2. 问题原因</h2>
<p>因为 KeyVault Secret 被设计成是不可变的，所以更新 <code>azurerm_key_vault_secret</code> 的 <code>value</code> 会导致资源被重新创建。Terraform 官网上的相关文档中对该参数的定义如下：</p>
<blockquote>
<p><code>value</code> - (Required) Specifies the value of the Key Vault Secret.</p>
</blockquote>
<p>在 Terraform 中 ，一个参数如果被标记为 <code>Required</code>，那么它不但是必填项，同时类似数据库记录的主键的概念，主键不同的记录被认定是两条不同的记录，修改记录的主键值可以看作是删除重建之。Terraform 资源的 <code>Required</code> 参数如果发生变化会触发重新创建资源，这就导致了修改 <code>value</code> 后，该 <code>azurerm_key_vault_secret</code> 的 <code>id</code> 也会发生变化。</p>
<p>那么为什么在 <code>azurerm_key_vault_secret</code> 被重新创建之后，我们会发现 <code>azurerm_function_app</code> 中引用的 <code>id</code> 没有变化呢？</p>
<p>Terraform 的工作流含有 Plan 和 Apply 两个主要阶段，首先会分析 Terraform 代码，调用 <code>terraform refresh</code>（可以用参数跳过该步骤）读取资源在云端目前的最新状态，再加上 State 文件中记录的状态，三个状态对比出一个执行计划，使得最终产生的云端状态能够符合当前代码描述的状态。</p>
<p>就这个场景而言，Terraform 能够意识到 <code>azurerm_key_vault_secret</code> 的参数发生了变化，这会导致某种程度的更新，但它无法意识到这个更新会导致 <code>azurerm_key_vault_secret</code> 的 <code>id</code> 发生变化，进而导致 <code>azurerm_function_app</code> 也必须进行更新，所以就发生了他第一次执行 <code>terraform apply</code> 后看到的情况。</p>
<p>当他第二次执行 <code>terraform apply</code> 时，Terraform 记录的 State 文件里，<code>azurerm_key_vault_secret</code> 的 <code>id</code>和<code>azurerm_function_app</code> 里使用的 <code>id</code> 已经对不上了，这时 Terraform 会再生成一个更新 <code>azurerm_function_app</code> 的 Plan，执行后一切恢复正常。</p>
<p>有没有办法让 <code>azurerm_function_app</code> 能在第一次生成 Plan 时就感知到这个变更？</p>
<h2 id="1-9-6-1-3-巧用-null-resource-的-triggers"><a href="#%E5%B7%A7%E7%94%A8-nullresource-%E7%9A%84-triggers"></a>1.9.6.1.3. 巧用 null_resource 的 triggers</h2>
<p>HashiCorp 提供了一个非常常用的内建 Provider —— <code>null</code>。其中最知名的资源就是 <code>null_resource</code> 了，一般它都是和 <code>provisioner</code> 搭配出现，可以用来在某些资源创建完成后执行一些自定义脚本等等。但是它还有一个很有用的参数：</p>
<blockquote>
<p>The <code>triggers</code> argument allows specifying an arbitrary set of values that, when changed, will cause the resource to be replaced.</p>
</blockquote>
<p><code>triggers</code> 参数可以用来指向一些值，只要这些值的内容发生了变动，会导致 <code>null_resource</code> 资源被重新创建，从而生成一个新的 <code>id</code>。</p>
<h2 id="1-9-6-1-4-一个小实验"><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%AE%9E%E9%AA%8C"></a>1.9.6.1.4. 一个小实验</h2>
<p>我们尝试构建一个简单的实验环境来验证一下，首先是这样一段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;example&quot; &#123;</span><br><span class="line">  name         = &quot;secret-sauce&quot;</span><br><span class="line">  value        = &quot;szechuan&quot;</span><br><span class="line">  key_vault_id = azurerm_key_vault.example.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;local_file&quot; &quot;output&quot; &#123;</span><br><span class="line">  filename = &quot;$&#123;path.module&#125;/output.txt&quot;</span><br><span class="line">  content = azurerm_key_vault_secret.example.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们创建一个 <code>azurerm_key_vault_secret</code>，然后把它的 <code>id</code> 输出到一个文件里。随后我们复制一下该文件，比如叫 <code>output.bak</code> 好了。随后我们修改 <code>azurerm_key_vault_secret</code> 的 <code>value</code> 到一个新的值，执行 <code>terraform apply</code> 以后，我们会发现 <code>output.txt</code> 与 <code>output.bak</code> 的内容完全一样，说明 <code>value</code> 的更新并没有触发 <code>local_file</code> 的更新。</p>
<p>随后我们把代码改成这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;example&quot; &#123;</span><br><span class="line">  name         = &quot;secret-sauce&quot;</span><br><span class="line">  value        = &quot;szechuan2&quot;</span><br><span class="line">  key_vault_id = azurerm_key_vault.example.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;example&quot; &#123;</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    trigger = azurerm_key_vault_secret.example.value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;local_file&quot; &quot;output&quot; &#123;</span><br><span class="line">  filename = &quot;$&#123;path.module&#125;/output.txt&quot;</span><br><span class="line">  content = null_resource.example.id == null_resource.example.id ? azurerm_key_vault_secret.example.id : &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在代码中插入了一个 <code>null_resource</code>，并设置 <code>triggers</code> 的内容，盯住 <code>azurerm_key_vault_secret.example.value</code>。在 <code>value</code> 发生变化时，<code>null_resource</code> 的 <code>id</code> 也会发生变化。</p>
<p>然后我们在 <code>local_file</code> 的代码中，<code>content</code> 的赋值改成了这样一个三目表达式：<code>null_resource.example.id == null_resource.example.id ? azurerm_key_vault_secret.example.id : &quot;&quot;</code>。这个表达式里实际上 <code>null_resource.example.id</code> 是不起作用的，自己等于自己的永真条件会导致仍然使用 <code>azurerm_key_vault_secret.example.id</code> 作为值，但是由于掺入了 <code>null_resource.example.id</code>，使得 Terraform 在第一次计算 Plan 时就感知到 <code>local_file</code> 的内容发生了变化，从而使得我们可以一次 <code>terraform apply</code> 搞定。</p>
<ul>
<li><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"><strong>1.9.7.1.</strong> 利用 null_resource 搭配 replace_triggered_by 更新无法从服务端读取内容的属性</a></li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"></a></p>
<h2 id="1-9-7-1-利用-null-resource-搭配-replace-triggered-by-更新无法从服务端读取内容的属性"><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"></a>1.9.7.1. 利用 null_resource 搭配 replace_triggered_by 更新无法从服务端读取内容的属性</h2>
<p>曾经处理的一个提问，有人写了这样一段 Terraform 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_container_group&quot; &quot;this&quot; &#123;</span><br><span class="line">  name                = var.name</span><br><span class="line">  location            = var.location</span><br><span class="line">  resource_group_name = var.resource_group_name</span><br><span class="line">  ip_address_type     = &quot;Private&quot;</span><br><span class="line">  network_profile_id  = azurerm_network_profile.this.id</span><br><span class="line">  os_type             = &quot;Linux&quot;</span><br><span class="line"></span><br><span class="line">  container &#123;</span><br><span class="line">    name   = &quot;someName&quot;</span><br><span class="line">    image  = &quot;someImage&quot;</span><br><span class="line">    cpu    = &quot;0.5&quot;</span><br><span class="line">    memory = &quot;0.5&quot;</span><br><span class="line"></span><br><span class="line">    commands = [&quot;some&quot;, &quot;commands&quot;]</span><br><span class="line"></span><br><span class="line">    ports &#123;</span><br><span class="line">      port     = 53</span><br><span class="line">      protocol = &quot;UDP&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    volume &#123;</span><br><span class="line">      mount_path = &quot;/app/conf&quot;</span><br><span class="line">      name       = &quot;someName&quot;</span><br><span class="line">      read_only  = true</span><br><span class="line">      secret = &#123;</span><br><span class="line">        Corefile = base64encode(someContent)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tags = var.tags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果每次执行 <code>apply</code> 操作时，都会发现 Terraform 试图重建这个容器：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># module.dns_forwarder.azurerm_container_group.this must be replaced</span><br><span class="line">-/+ resource &quot;azurerm_container_group&quot; &quot;this&quot; &#123;</span><br><span class="line">      ~ exposed_port        = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - port     = 53</span><br><span class="line">              - protocol = &quot;UDP&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + fqdn                = (known after apply)</span><br><span class="line">      ~ id                  = &quot;/subscriptions/&lt;mySubId&gt;/resourceGroups/&lt;myRgName&gt;/providers/Microsoft.ContainerInstance/containerGroups/&lt;myContainerGroupName&gt;&quot; -&gt; (known after apply)</span><br><span class="line">      ~ ip_address          = &quot;someIp&quot; -&gt; (known after apply)</span><br><span class="line">        name                = &quot;someName&quot;</span><br><span class="line">      - tags                = &#123;&#125; -&gt; null</span><br><span class="line">        # (6 unchanged attributes hidden)</span><br><span class="line"></span><br><span class="line">      ~ container &#123;</span><br><span class="line">          - environment_variables        = &#123;&#125; -&gt; null</span><br><span class="line">            name                         = &quot;someName&quot;</span><br><span class="line">          - secure_environment_variables = (sensitive value)</span><br><span class="line">            # (4 unchanged attributes hidden)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          ~ volume &#123;</span><br><span class="line">                name       = &quot;someName&quot;</span><br><span class="line">              ~ secret     = (sensitive value) # forces replacement</span><br><span class="line">                # (3 unchanged attributes hidden)</span><br><span class="line">            &#125;</span><br><span class="line">            # (1 unchanged block hidden)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个问题的原因是 API 在读取容器信息时不会返回 <code>volume</code> 的 <code>secret</code> 数据，这其实是一个还挺合理的设定，机密数据的确不应该可以直接从 API 返回，但这就导致 Terraform 每次制定变更计划时都会试图重新设置这个值(因为会理解成服务端这个值被修改成了空)，而容器是不可变的，要修改容器的任何配置都会导致容器被重建。</p>
<p>有没有办法能够避免这种问题？经验告诉我们，可以使用 <code>ignore_changes</code> 让 Terraform 忽略这个属性的变更来避免重建，但如果 <code>secret</code> 真的变了怎么办？</p>
<p>我们可以这样干，第一，在 <code>azurerm_container_group</code> 添加这样一段 <code>lifecycle</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lifecycle &#123;</span><br><span class="line">    ignore_changes       = [container[0].volume[0].secret]</span><br><span class="line">    replace_triggered_by = [null_resource.secret_trigger.id]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这会忽略 <code>secret</code> 的变化，但我们同时声明了一个 <code>replace_triggered_by</code>，在 <code>null_resource.secret_trigger.id</code> 的值发生变化时可以删除重建 <code>azurerm_container_group</code> 实例。</p>
<p>其次，我们把 <code>secret</code> 的内容提取到一个 <code>local</code> 里，这时 <code>azurerm_container_group</code> 的 <code>volume</code> 看起来大概是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">volume &#123;</span><br><span class="line">    mount_path = &quot;/app/conf&quot;</span><br><span class="line">    name       = &quot;somename&quot;</span><br><span class="line">    read_only  = true</span><br><span class="line">    secret     = &#123;</span><br><span class="line">      Corefile = local.secret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>local.secret</code> 存放着使用的机密数据。这时我们再定义一个 <code>null_resource</code> 充当触发器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  secret = base64encode(&quot;abcdefg&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;secret_trigger&quot; &#123;</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    trigger = local.secret</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在机密数据真的发生变化的时候，<code>triggers</code> 会触发 <code>null_resource</code> 的重建，导致 <code>null_resource.secret_trigger.id</code> 发生变化，进而触发 <code>azurerm_container_group</code> 的重建。</p>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"><strong>1.9.8.1.</strong> 创建资源的条件依赖另一个资源的输出时怎么办</a></li>
</ul>
<p><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"></a></p>
<h2 id="1-9-8-1-创建资源的条件依赖另一个资源的输出时怎么办"><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"></a>1.9.8.1. 创建资源的条件依赖另一个资源的输出时怎么办</h2>
<p>我们在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/8.%E6%8A%80%E5%B7%A7/1.%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA">有条件创建</a>当中介绍了如何可以通过判断用户的输入参数来决定是否要创建某个资源，让我们来看一下这样一个 Module 的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;vpc_id&quot; &#123;</span><br><span class="line">  type    = string</span><br><span class="line">  default = null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  count       = var.vpc_id == null ? 1 : 0</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">  cidr_block = &quot;10.0.0.0/24&quot;</span><br><span class="line">  vpc_id     = var.vpc_id == null ? ucloud_vpc.vpc[0].id : var.vpc_id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们想在 Module 中创建一个 <code>ucloud_subnet</code>，用户可以输入一个 <code>vpc_id</code> 配置给它，也可以不输入，这时 Module 会创建一个 <code>ucloud_vpc</code> 来用。</p>
<p>假如我们使用这个模块，不传入 <code>vpc_id</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module vpc &#123;</span><br><span class="line">  source = &quot;./vpc&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码生成的 Plan 内容如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_subnet.subnet will be created</span><br><span class="line">  + resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">      + cidr_block  = &quot;10.0.0.0/24&quot;</span><br><span class="line">      + create_time = (known after apply)</span><br><span class="line">      + id          = (known after apply)</span><br><span class="line">      + name        = (known after apply)</span><br><span class="line">      + remark      = (known after apply)</span><br><span class="line">      + tag         = &quot;Default&quot;</span><br><span class="line">      + vpc_id      = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_vpc.vpc[0] will be created</span><br><span class="line">  + resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">      + cidr_blocks  = [</span><br><span class="line">          + &quot;10.0.0.0/16&quot;,</span><br><span class="line">        ]</span><br><span class="line">      + create_time  = (known after apply)</span><br><span class="line">      + id           = (known after apply)</span><br><span class="line">      + name         = &quot;vpc&quot;</span><br><span class="line">      + network_info = (known after apply)</span><br><span class="line">      + remark       = (known after apply)</span><br><span class="line">      + tag          = &quot;Default&quot;</span><br><span class="line">      + update_time  = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>
<p>完全符合预期。假如我们希望由模块的调用者来创建 Vpc 的话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module vpc &#123;</span><br><span class="line">  source = &quot;./vpc&quot;</span><br><span class="line"></span><br><span class="line">  vpc_id = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们执行 <code>terraform plan</code> 的话，会得到这样的结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Invalid count argument</span><br><span class="line">│ </span><br><span class="line">│   on vpc/main.tf line 16, in resource &quot;ucloud_vpc&quot; &quot;vpc&quot;:</span><br><span class="line">│   16:   count       = var.vpc_id == null ? 1 : 0</span><br><span class="line">│ </span><br><span class="line">│ The &quot;count&quot; value depends on resource attributes that cannot be determined until apply, so Terraform cannot predict how many instances will be created. To work around this,</span><br><span class="line">│ use the -target argument to first apply only the resources that the count depends on.</span><br><span class="line">╵</span><br></pre></td></tr></table></figure>
<p>Terraform 试图向我们抱怨，我们在 <code>count</code> 参数的表达式里使用了一个必须在 <code>apply</code> 阶段才能知道的值，所以它无法在 <code>plan</code> 阶段就计算出 <code>count</code> 的值。它建议我们先用 <code>terraform apply</code> 命令搭配 <code>-target</code> 参数把 Vpc 先创建出来，消除后续计算 Plan 时尚不知晓的值来解决这个问题。</p>
<p>这当然是一种很麻烦的方法，所以我们在设计 Module 时就要考虑到这种问题。有一种很简单的方法可以解决这个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;vpc&quot; &#123;</span><br><span class="line">  type    = object(</span><br><span class="line">    &#123;</span><br><span class="line">      id = string</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  default = null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  count       = var.vpc == null ? 1 : 0</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">  cidr_block = &quot;10.0.0.0/24&quot;</span><br><span class="line">  vpc_id     = var.vpc == null ? ucloud_vpc.vpc[0].id : var.vpc.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把用来判断创建条件的输入参数类型改成 <code>object</code>，调用 Module 的代码就变成了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  # ucloud_vpc.vpc will be created</span><br><span class="line">  + resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">      + cidr_blocks  = [</span><br><span class="line">          + &quot;10.0.0.0/16&quot;,</span><br><span class="line">        ]</span><br><span class="line">      + create_time  = (known after apply)</span><br><span class="line">      + id           = (known after apply)</span><br><span class="line">      + name         = &quot;vpc&quot;</span><br><span class="line">      + network_info = (known after apply)</span><br><span class="line">      + remark       = (known after apply)</span><br><span class="line">      + tag          = &quot;Default&quot;</span><br><span class="line">      + update_time  = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_subnet.subnet will be created</span><br><span class="line">  + resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">      + cidr_block  = &quot;10.0.0.0/24&quot;</span><br><span class="line">      + create_time = (known after apply)</span><br><span class="line">      + id          = (known after apply)</span><br><span class="line">      + name        = (known after apply)</span><br><span class="line">      + remark      = (known after apply)</span><br><span class="line">      + tag         = &quot;Default&quot;</span><br><span class="line">      + vpc_id      = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>
<p>成功计算出 Plan。请注意虽然这个 Plan 仍然是创建两个资源，但 <code>ucloud_vpc</code> 资源并不是 Module 创建的。</p>
<p>这个方法的原理就是虽然 <code>var.vpc.id</code> 仍然是一个只有在 <code>apply</code> 阶段才能知道的值，但 <code>var.vpc</code> 本身是一个在 <code>plan</code> 阶段就可以知道的值，直接可以判读它是否为 <code>null</code>，所以该方法可以绕过这个限制。</p>
<ul>
<li><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><strong>1.9.9.1.</strong> 利用 create_before_destroy 调整资源 Update 的执行顺序</a></li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"></a></p>
<h2 id="1-9-9-1-利用-create-before-destroy-调整资源-Update-的执行顺序"><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"></a>1.9.9.1. 利用 create_before_destroy 调整资源 Update 的执行顺序</h2>
<p>最近处理了一个问题，有人写了这样一段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;azurerm&quot; &#123;</span><br><span class="line">  features &#123;</span><br><span class="line">    resource_group &#123;</span><br><span class="line">      prevent_deletion_if_contains_resources = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_resource_group&quot; &quot;rg&quot; &#123;</span><br><span class="line">  location = &quot;eastus&quot;</span><br><span class="line">  name     = &quot;example&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">locals &#123;</span><br><span class="line">  environments = toset([&quot;one&quot;, &quot;two&quot;, &quot;three&quot;])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_public_ip&quot; &quot;lb&quot; &#123;</span><br><span class="line">  for_each = local.environments</span><br><span class="line"></span><br><span class="line">  name                = &quot;frontend-lb-$&#123;each.key&#125;&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  allocation_method   = &quot;Static&quot;</span><br><span class="line">  ip_version          = &quot;IPv4&quot;</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line">  zones               = [1, 2, 3]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_lb&quot; &quot;this&quot; &#123;</span><br><span class="line">  name                = &quot;azurelb&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line"></span><br><span class="line">  dynamic &quot;frontend_ip_configuration&quot; &#123;</span><br><span class="line">    for_each = local.environments</span><br><span class="line">    content &#123;</span><br><span class="line">      name                 = frontend_ip_configuration.key</span><br><span class="line">      public_ip_address_id = azurerm_public_ip.lb[frontend_ip_configuration.key].id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当他从 <code>local.environments</code> 中删除一个元素，然后执行 <code>terraform apply</code> 时，他遇到了下面的问题：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">│ Error: deleting Public Ip Address: (Name &quot;azurelb&quot; / Resource Group &quot;example&quot;): network.PublicIPAddressesClient#Delete: Failure sending request: StatusCode=400 -- Original Error: Code=&quot;PublicIPAddressCannotBeDeleted&quot; Message=&quot;Public IP address /subscriptions/subscription-id/resourceGroups/resource-group/providers/Microsoft.Network/publicIPAddresses/one can not be deleted since it is still allocated to resource /subscriptions/subscription-id/resourceGroups/resource-group/providers/Microsoft.Network/loadBalancers/azurelb/frontendIPConfigurations/one. In order to delete the public IP, disassociate/detach the Public IP address from the resource.  To learn how to do this, see aka.ms/deletepublicip.&quot; Details=[]</span><br></pre></td></tr></table></figure>
<p>这其实是一个还挺常见的问题，<code>azurerm_lb.this</code> 依赖于 <code>azurerm_public_ip.lb[index]</code>，正确的变更顺序应该是先更新 <code>azurerm_lb.this</code>，再删除 <code>azurerm_public_ip.lb</code> 的成员，但是 Terraform 默认的执行顺序会首先尝试执行删除操作，这时因为 ip 仍然被 LoadBalancer 使用着，所以会引发一个错误。</p>
<p>解决方法是给 <code>azurerm_public.lb</code> 添加一个 <code>create_before_destroy</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_public_ip&quot; &quot;lb&quot; &#123;</span><br><span class="line">  for_each = local.environments</span><br><span class="line"></span><br><span class="line">  name                = &quot;frontend-lb-$&#123;each.key&#125;&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  allocation_method   = &quot;Static&quot;</span><br><span class="line">  ip_version          = &quot;IPv4&quot;</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line">  zones               = [1, 2, 3]</span><br><span class="line"></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    create_before_destroy = true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>create_before_destroy</code> 名字里虽然看起来是与 Create 有关，实际上它也会将 Update 与 Create 放在一起调整，声明该参数后实际上是将 <code>azurerm_public_ip.lb</code> 的 Delete 推迟到执行 Update 之后再执行了，该问题得解。</p>
<ul>
<li>
<p><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"><strong>1.9.10.1.</strong> Terraform 与自动化</a></p>
</li>
<li>
<p><a href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84-terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E4%BD%9C%E6%B5%81"><strong>1.9.10.1.1.</strong> 自动化的 Terraform 命令行工作流</a></p>
</li>
<li>
<p><a href="#%E6%8E%A7%E5%88%B6%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%AD%E7%9A%84-terraform-%E8%BE%93%E5%87%BA"><strong>1.9.10.1.2.</strong> 控制自动化中的 Terraform 输出</a></p>
</li>
<li>
<p><a href="#%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%9C%BA%E5%99%A8%E4%B8%8A%E8%BF%90%E8%A1%8C-plan-%E5%92%8C-apply"><strong>1.9.10.1.3.</strong> 在不同的机器上运行 plan 和 apply</a></p>
</li>
<li>
<p><a href="#%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%AE%A1%E6%89%B9%E8%AE%A1%E5%88%92"><strong>1.9.10.1.4.</strong> 交互式审批计划</a></p>
</li>
<li>
<p><a href="#%E8%87%AA%E5%8A%A8%E6%89%B9%E5%87%86%E8%AE%A1%E5%88%92"><strong>1.9.10.1.5.</strong> 自动批准计划</a></p>
</li>
<li>
<p><a href="#%E7%94%A8-terraform-plan-%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95-pull-requests"><strong>1.9.10.1.6.</strong> 用 terraform plan 命令测试 Pull Requests</a></p>
</li>
<li>
<p><a href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><strong>1.9.10.1.7.</strong> 多环境部署</a></p>
</li>
<li>
<p><a href="#%E9%A2%84%E5%85%88%E5%AE%89%E8%A3%85%E7%9A%84%E6%8F%92%E4%BB%B6"><strong>1.9.10.1.8.</strong> 预先安装的插件</a></p>
</li>
</ul>
<p><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"></a></p>
<h2 id="1-9-10-1-Terraform-与自动化"><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"></a>1.9.10.1. Terraform 与自动化</h2>
<p>如果团队使用 Terraform 作为变更管理和部署管道的核心工具，可能需要以某种自动化方式编排 Terraform 的运行，以确保运行之间的一致性，并提供其他有趣的功能，例如与版本控制系统钩子的集成。</p>
<p>Terraform 的自动化可以有多种形式，并且程度不同。一些团队继续在本地运行 Terraform，但使用脚本代码来准备一致的工作目录来运行 Terraform，而另一些团队则完全在 Jenkins 等 CI 工具中运行 Terraform。</p>
<p>本篇涵盖了实现此类自动化时应考虑的一些事项，既确保 Terraform 的安全运行，又适应 Terraform 工作流程中当前需要仔细注意的一些限制。它假设 Terraform 将在非交互式环境中运行，无法在终端提示输入。对于脚本代码来说不一定如此，但在 CI 工具中运行时通常如此。</p>
<h2 id="1-9-10-1-1-自动化的-Terraform-命令行工作流"><a href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84-terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E4%BD%9C%E6%B5%81"></a>1.9.10.1.1. 自动化的 Terraform 命令行工作流</h2>
<p>在自动化流程中运行 Terraform 时，重点通常是核心的 <code>plan</code>/<code>apply</code> 循环。那么，使用 Terraform 命令行的流程大体如下：</p>
<ol>
<li>初始化 Terraform 工作目录。</li>
<li>针对当前代码，为产生变化的资源计算变更计划</li>
<li>让操作员审查计划，以确保其可接受</li>
<li>应用计划描述的更改。</li>
</ol>
<p>步骤 1、2 和 4 可以使用熟悉的 Terraform 命令以及一些附加选项来执行：</p>
<ul>
<li><code>terraform init -input=false</code> 初始化工作目录。</li>
<li><code>terraform plan -out=tfplan -input=false</code> 创建计划文件并将其保存到名为 <code>tfplan</code> 的本地文件。</li>
<li><code>terraform apply -input=false tfplan</code> 执行存储在文件 <code>tfplan</code> 中的计划。</li>
</ul>
<p><code>-input=false</code> 参数命令 Terraform 不应尝试提示输入，而是要求配置文件或命令行提供所有必要的值。因此，可能需要在 <code>terraform plan</code> 上使用 <code>-var</code> 和 <code>-var-file</code> 参数来指定所有传统上在交互式使用下手动输入的变量值。</p>
<p>强烈建议使用支持远程状态的 Backend，因为 Terraform 可以自动将持久保存状态，后续运行可以在找回并更新状态。选择支持状态锁定的 Backend 还将提供针对 Terraform 并发运行的竞争安全保障。</p>
<h2 id="1-9-10-1-2-控制自动化中的-Terraform-输出"><a href="#%E6%8E%A7%E5%88%B6%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%AD%E7%9A%84-terraform-%E8%BE%93%E5%87%BA"></a>1.9.10.1.2. 控制自动化中的 Terraform 输出</h2>
<p>默认情况下，一些 Terraform 命令会提示用户下一步可能执行的步骤，通常包括具体的下一步要运行的命令。</p>
<p>自动化工具通常会封装正在运行的命令的具体细节，只提供抽象的步骤，这时 Terraform 输出的此类消息反而令人困惑，且无法操作，如果它们无意中鼓励用户完全绕过自动化工具，则可能还是有害的。</p>
<p>当环境变量 <code>TF_IN_AUTOMATION</code> 设置为任何非空值时，Terraform 会对其输出进行一些细微调整，不再强调要运行的特定命令。所做的具体更改会随着时间的推移而变化，但一般来说，Terraform 发现该变量时，会认为存在某种包装了 Terraform 的应用程序，它们会帮助用户进行下一步。</p>
<p>为了降低复杂性，该功能主要针对 Terraform 主要的工作流程命令实现。无论该变量为何值如何，其他辅助命令仍可能会产生命令行建议。</p>
<h2 id="1-9-10-1-3-在不同的机器上运行-plan-和-apply"><a href="#%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%9C%BA%E5%99%A8%E4%B8%8A%E8%BF%90%E8%A1%8C-plan-%E5%92%8C-apply"></a>1.9.10.1.3. 在不同的机器上运行 plan 和 apply</h2>
<p>在 CI 工具中运行时，可能很难或无法确保 <code>plan</code> 和 <code>apply</code> 命令在同一台计算机上的同一目录中运行，并且所有的文件都保持相同。</p>
<p>在不同的机器上运行 <code>plan</code> 和 <code>apply</code> 需要一些额外的步骤来确保正确的行为。稳健的策略如下：</p>
<ul>
<li><code>plan</code> 完成后，保存整个工作目录，包括 <code>init</code> 期间创建的 <code>.terraform</code> 子目录，并将其保存在 <code>apply</code> 阶段可以访问得到的位置。常见的选择是作为所选 CI 工具中的“Build Artifact”。</li>
<li>在运行 <code>apply</code> 之前，获取上一步中创建的存档并将其解压到相同的绝对路径。这会重新创建 <code>plan</code> 后出现的所有内容，避免在 <code>plan</code> 步骤期间创建本地文件的奇怪问题。</li>
</ul>
<p>Terraform 目前为此类自动化系统设置了一些必须满足的前提条件：</p>
<ul>
<li>保存的计划文件可以包含子模块的绝对路径以及代码中引用的其他数据文件。因此，必须确保在相同的绝对路径中还原保存的工作目录。这通常是通过在某种隔离中运行 Terraform 来实现的，例如可以控制文件系统布局的 Docker 容器。</li>
<li>Terraform 假设该计划将在与其创建时相同的操作系统和 CPU 架构上 Apply。例如，这意味着无法在 Windows 计算机上创建计划，然后将其应用到 Linux 服务器上。</li>
<li>Terraform 期望用于生成计划的 Provider 程序插件在应用计划时可用且相同，以确保正确执行计划。如果在创建和应用计划之间升级 Terraform 或任何插件，将会产生错误。</li>
<li>Terraform 无法自动检测用于创建计划的凭据是否授予对用于应用该计划的相同资源的访问权限。如果对每个凭据使用不同的凭据（例如，使用只读凭据生成计划），那么确保两套凭据在它们所属的相应服务的帐户中保持一致非常重要。</li>
</ul>
<p><strong>警告</strong>：计划文件包含代码的完整副本、计划所要应用的状态数据以及传递给 <code>terraform plan</code> 的所有变量。如果其中包含任意敏感数据，则包含计划文件的存档工作目录应受到相应保护。对于 Provider 使用的身份验证凭据，建议尽可能使用环境变量，因为这些变量不会被包含在计划中或由 Terraform 以任何其他方式保存到磁盘。</p>
<h2 id="1-9-10-1-4-交互式审批计划"><a href="#%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%AE%A1%E6%89%B9%E8%AE%A1%E5%88%92"></a>1.9.10.1.4. 交互式审批计划</h2>
<p>自动化 Terraform 工作流程的另一个挑战是需要在计划和应用之间进行交互式审批步骤。为了稳健地实现这一点，重要的是要确保一次只能有一个计划未完成，或者两个步骤相互连接，以便批准计划将足够的信息传递到应用步骤，以确保应用正确的计划，与后来也存在的一些计划相反。</p>
<p>不同的 CI 工具以不同的方式解决这个问题，但通常这是通过构建管道功能实现的，其中可以按顺序应用不同的步骤，后面的步骤可以访问前面步骤生成的数据。</p>
<p>推荐的方法是一次只允许一个计划处于未应用状态。应用计划时，针对同一状态生成的任何其他现有计划都会失效，因为现在必须相对于新状态重新计算它们。通过强制计划按顺序获得批准（或驳回），可以避免这种情况。</p>
<h2 id="1-9-10-1-5-自动批准计划"><a href="#%E8%87%AA%E5%8A%A8%E6%89%B9%E5%87%86%E8%AE%A1%E5%88%92"></a>1.9.10.1.5. 自动批准计划</h2>
<p>虽然强烈建议对生产环境应用计划前要进行人工审查，但有时在预生产或开发环境中部署时需要采取更自动化的方法。</p>
<p>如果不需要手动批准，可以使用更简单的命令序列：</p>
<ul>
<li><code>terraform init -input=false</code></li>
<li><code>terraform apply -input=false -auto-approve</code></li>
</ul>
<p><code>apply</code> 命令的这个变体隐式地创建一个新计划，然后立即应用它。 <code>-auto-approve</code> 选项告诉 Terraform 在应用计划之前不需要对计划进行交互式批准。</p>
<p><strong>警告</strong>：当 Terraform 有权对基础设施进行破坏性更改时，始终建议对计划进行人工审查，除非在发生意外更改时可以容忍停机。仅对非关键基础设施使用自动批准。</p>
<h2 id="1-9-10-1-6-用-terraform-plan-命令测试-Pull-Requests"><a href="#%E7%94%A8-terraform-plan-%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95-pull-requests"></a>1.9.10.1.6. 用 terraform plan 命令测试 Pull Requests</h2>
<p><code>terraform plan</code> 可以用来对 Terraform 配置的有效性进行某些有限的验证，而不影响实际的基础设施。尽管 <code>plan</code> 命令会更新状态以匹配实际资源，从而确保准确的计划，但更新后的状态文件并不会持久保存，因此可以安全地使用该命令来生成仅为了帮助代码审查而创建的“一次性”计划。</p>
<p>实现此类工作流程时，可以在相关代码审查工具（例如，Github Pull Request）中使用钩子，为每个正在审查的新提交触发 CI 工具。在这种情况下，Terraform 可以按如下方式运行：</p>
<ul>
<li><code>terraform plan -input=false</code></li>
</ul>
<p>与在“主”工作流程中一样，可能需要根据需要设置 <code>-var</code> 或 <code>-var-file</code>。在这种情况下不使用 <code>-out</code> 选项，因为为代码审查目的而生成的计划永远不会被应用。相反，一旦合并更改，就可以从主版本控制分支创建并应用新计划。</p>
<p><strong>警告</strong>：请注意，通过输入变量或环境变量将敏感秘密数据传递给 Terraform 将使任何可以提交 PR 的人都可以看到，因此在开源项目或任何私人项目上必须谨慎使用此流程部分，或所有贡献者不应能够直接访问凭据等。</p>
<h2 id="1-9-10-1-7-多环境部署"><a href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"></a>1.9.10.1.7. 多环境部署</h2>
<p>Terraform 的自动化通常会被用来创建数个相同的配置，比如为预发布、测试或多租户基础设施等场景生成平行的环境。这种情况下的自动化可以帮助确保为每个环境使用正确的设置，并且在每次操作之前正确配置工作目录。</p>
<p>多环境编排最有趣的两个命令是 <code>terraform init</code> 和 <code>terraform workspace</code>。前者可以与其他参数一起使用，以针对环境之间的差异定制 Backend 配置，而后者可用于在单个 Backend 中存储的相同配置的多个状态之间安全切换。</p>
<p>如果可能，建议对所有环境使用单一后端配置，并使用 <code>terraform workspace</code> 命令在工作空间之间切换：</p>
<ul>
<li><code>terraform init -input=false</code></li>
<li><code>terraform workspace select QA</code></li>
</ul>
<p>在此使用模型中，Backend 存储中使用固定的命名方案，以允许多个状态共存，而无需任何进一步的配置。</p>
<p>或者，自动化工具可以将环境变量 <code>TF_WORKSPACE</code> 设置为现有工作空间名称，这将覆盖使用 <code>terraform workspace select</code> 命令所做的任何选择。建议仅在非交互式使用中使用此环境变量，因为在本地 shell 环境中，很容易忘记设置该变量并将变更应用到错误的状态。</p>
<p>在一些更复杂的情况下，不可能跨环境共享相同的 Backend 配置。例如，环境可能运行在完全独立的不同帐户的服务里，因此需要对 Backend 本身使用不同的凭据或端点。在这种情况下，可以通过 <code>terraform init</code> 的 <code>-backend-config</code> 选项覆盖后端配置设置。</p>
<h2 id="1-9-10-1-8-预先安装的插件"><a href="#%E9%A2%84%E5%85%88%E5%AE%89%E8%A3%85%E7%9A%84%E6%8F%92%E4%BB%B6"></a>1.9.10.1.8. 预先安装的插件</h2>
<p>在默认使用情况下，<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/12.init.html"><code>terraform init</code></a> 会自动下载并安装代码中使用的所有 Provider 程序的插件，并将它们放置在 <code>.terraform</code> 目录的子目录中。这为简单的情况提供了更简单的工作流程，并允许每段代码可以使用不同版本的插件。</p>
<p>在自动化环境中，可能需要禁用此行为，而是提供一组已安装在运行 Terraform 的系统上的固定插件。这样就避免了每次执行时重新下载插件的开销，并允许系统管理员控制可以使用哪些插件。</p>
<p>要使用此机制，请在系统上的某个位置创建一个 Terraform 运行时会将插件可执行文件放入其中的目录。已发布的插件文件可在 <a target="_blank" rel="noopener" href="https://releases.hashicorp.com/">releases.hashicorp.com</a> 上下载。请务必下载适合目标操作系统和体系结构的文件。</p>
<p>提取必要的插件后，新插件目录的内容将如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -lah /usr/lib/custom-terraform-plugins</span></span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:13 terraform-provider-aws-v1.0.0-x3</span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:15 terraform-provider-rundeck-v2.3.0-x3</span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:15 terraform-provider-mysql-v1.2.0-x3</span><br></pre></td></tr></table></figure>
<p>文件名末尾的版本信息很重要，它使得 Terraform 可以推断每个插件的版本号。可以安装同一 Provider 程序插件的多个版本，Terraform 将使用与 Terraform 代码中的 Provider 程序版本约束相匹配的最新版本。</p>
<p>填充此目录后，可以使用 <code>terraform init</code> 的 <code>-plugin-dir</code> 选项跳过常规的自动下载和插件发现行为：</p>
<ul>
<li><code>terraform init -input=false -plugin-dir=/usr/lib/custom-terraform-plugins</code></li>
</ul>
<p>使用该组参数时，只有给定目录中的插件可以被使用。这使系统管理员可以对执行环境进行强力控制，但另一方面，它会阻止使用尚未安装到本地插件目录中的较新插件版本。哪种方法更合适将取决于每个组织内的特定情况。</p>
<p>还可以通过创建 <code>terraform.d/plugins/OS_ARCH</code> 目录与配置一起提前安装插件，在自动下载其他插件之前将搜索该目录。 <code>-get-plugins=false</code> 参数可禁止 Terraform 自动下载其他插件。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="../../2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                            aria-label=": Terraform-测试"
                        >
                            Terraform-测试
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-01-29T17:43:45+08:00">
	
		    2023 年 1 月 29 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="">devops</a>, <a class="category-link" href="Terraform/">Terraform</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <ul>
<li>
<p><a href="#%E6%B5%8B%E8%AF%95"><strong>1.8.1.</strong> 测试</a></p>
</li>
<li>
<p><a href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%88%96%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><strong>1.8.1.1.</strong> 集成测试或单元测试</a></p>
</li>
<li>
<p><a href="#%E8%AF%AD%E6%B3%95"><strong>1.8.1.2.</strong> 语法</a></p>
</li>
<li>
<p><a href="#%E7%A4%BA%E4%BE%8B"><strong>1.8.1.2.1.</strong> 示例</a></p>
</li>
<li>
<p><a href="#run-%E5%9D%97"><strong>1.8.1.3.</strong> run 块</a></p>
</li>
<li>
<p><a href="#%E6%96%AD%E8%A8%80"><strong>1.8.1.3.1.</strong> 断言</a></p>
</li>
<li>
<p><a href="#variable-%E5%9D%97"><strong>1.8.1.4.</strong> variable 块</a></p>
</li>
<li>
<p><a href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%88%96%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9A%E5%8F%98%E9%87%8F"><strong>1.8.1.4.1.</strong> 通过命令行或定义文件指定变量</a></p>
</li>
<li>
<p><a href="#%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E4%BC%98%E5%85%88%E7%BA%A7"><strong>1.8.1.4.2.</strong> 变量定义优先级</a></p>
</li>
<li>
<p><a href="#%E5%8F%98%E9%87%8F%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"><strong>1.8.1.4.3.</strong> 变量中的引用</a></p>
</li>
<li>
<p><a href="#provider-%E5%9D%97"><strong>1.8.1.5.</strong> provider 块</a></p>
</li>
<li>
<p><a href="#module-%E5%9D%97"><strong>1.8.1.6.</strong> module 块</a></p>
</li>
<li>
<p><a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81"><strong>1.8.1.6.1.</strong> 模块状态</a></p>
</li>
<li>
<p><a href="#%E9%A2%84%E6%9C%9F%E5%A4%B1%E8%B4%A5"><strong>1.8.1.7.</strong> 预期失败</a></p>
</li>
</ul>
<p><a href="#%E6%B5%8B%E8%AF%95"></a></p>
<h2 id="1-8-1-测试"><a href="#%E6%B5%8B%E8%AF%95"></a>1.8.1. 测试</h2>
<p>-&gt; <strong>注意：</strong> 该测试框架在 Terraform v1.6.0 及以后版本中可用。</p>
<p>Terraform 测试功能允许模块作者验证配置变更不会引入破坏性更改。测试针对特定的、临时的资源进行，防止对现有的基础设施或状态产生任何风险。</p>
<h2 id="1-8-1-1-集成测试或单元测试"><a href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%88%96%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"></a>1.8.1.1. 集成测试或单元测试</h2>
<p>默认情况下，Terraform 测试会创建真实的基础设施，并可以对这些基础设施进行断言和验证。这相当于集成测试，它通过调用 Terraform 创建基础设施并对其进行验证来测试 Terraform 的核心功能。</p>
<p>你可以通过更新 <a href="#run-%E5%9D%97"><code>run</code></a> 块中的 <code>command</code> 属性（下面有示例）来覆盖默认的测试行为。默认情况下，每个 <code>run</code> 块都会执行 <code>command = apply</code>，命令 Terraform 对你的配置执行完整的 <code>apply</code> 操作。将 <code>command</code> 值替换为 <code>command = plan</code> 会告诉 Terraform 不为这个 <code>run</code> 块创建新的基础设施。这将允许测试作者验证他们的基础设施中的逻辑操作和自定义条件，相当于编写了单元测试。</p>
<p>Terraform v1.7.0 引入了在 <code>terraform test</code> 执行期间模拟 Provider 返回数据的能力。这可以用于编写更详细和完整的单元测试。</p>
<h2 id="1-8-1-2-语法"><a href="#%E8%AF%AD%E6%B3%95"></a>1.8.1.2. 语法</h2>
<p>每个 Terraform 测试都保存在一个测试文件中。Terraform 根据文件扩展名发现测试文件：<code>.tftest.hcl</code> 或 <code>.tftest.json</code>。</p>
<p>每个测试文件包含以下根级别的属性和块：</p>
<ul>
<li>一个到多个 <a href="#run-%E5%9D%97"><code>run</code></a> 块。</li>
<li>零个到一个 <a href="#variable-%E5%9D%97"><code>variables</code></a> 块。</li>
<li>零个到多个 <a href="#provider-%E5%9D%97"><code>provider</code></a> 块。</li>
</ul>
<p>Terraform 按顺序执行 <code>run</code> 块，模拟一系列直接在配置目录中执行的 Terraform 命令。 <code>variables</code> 和 <code>provider</code> 块的顺序并不重要，Terraform 在测试操作开始时处理这些块中的所有值。我们建议首先在测试文件的开头定义你的 <code>variables</code> 和 <code>provider</code> 块。</p>
<h3 id="1-8-1-2-1-示例"><a href="#%E7%A4%BA%E4%BE%8B"></a>1.8.1.2.1. 示例</h3>
<p>以下示例演示了一个简单的 Terraform 配置，该配置创建了一个 AWS S3 存储桶，并使用输入变量来修改其名称。我们将创建一个示例测试文件（如下）来验证存储桶的名称是否如预期那样被创建。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-bucket&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;bucket_name&quot; &#123;</span><br><span class="line">  value = aws_s3_bucket.bucket.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下测试文件运行了一个单独的Terraform <code>plan</code> 命令，该命令创建了S3存储桶，然后通过检查实际名称是否与预期名称匹配，来验证计算名称的逻辑是否正确。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># valid_string_concat.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;valid_string_concat&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-8-1-3-run-块"><a href="#run-%E5%9D%97"></a>1.8.1.3. run 块</h2>
<p>每个 <code>run</code> 块都有以下字段和块：</p>
<table>
<thead>
<tr>
<th>字段或块名称</th>
<th>描述</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>一个可选属性，可以是 <code>apply</code> 或 <code>plan</code>。</td>
<td><code>apply</code></td>
</tr>
<tr>
<td><code>plan_options.mode</code></td>
<td>一个可选属性，可以是 <code>normal</code> 或 <code>refresh-only</code>。</td>
<td><code>normal</code></td>
</tr>
<tr>
<td><code>plan_options.refresh</code></td>
<td>一个可选的 <code>bool</code> 属性。</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>plan_options.replace</code></td>
<td>一个可选属性，包含一个资源地址列表，引用测试配置中的资源。</td>
<td></td>
</tr>
<tr>
<td><code>plan_options.target</code></td>
<td>一个可选属性，包含一个资源地址列表，引用测试配置中的资源。</td>
<td></td>
</tr>
<tr>
<td><a href="#variable-%E5%9D%97"><code>variables</code></a></td>
<td>一个可选的 <code>variables</code> 块。</td>
<td></td>
</tr>
<tr>
<td><a href="#module-%E5%9D%97"><code>module</code></a></td>
<td>一个可选的 <code>module</code> 块。</td>
<td></td>
</tr>
<tr>
<td><a href="#provider-%E5%9D%97"><code>providers</code></a></td>
<td>一个可选的 <code>providers</code> 属性。</td>
<td></td>
</tr>
<tr>
<td><a href="#%E6%96%AD%E8%A8%80"><code>assert</code></a></td>
<td>可选的 <code>assert</code> 块。</td>
<td></td>
</tr>
<tr>
<td><code>expect_failures</code></td>
<td>一个可选属性。</td>
<td></td>
</tr>
</tbody>
</table>
<p><code>command</code> 属性和 <code>plan_options</code> 块告诉 Terraform 对于每个 <code>run</code> 块执行哪个命令和选项。如果您没有指定 <code>command</code> 属性或 <code>plan_options</code> 块，那么默认操作是普通的 <code>terraform apply</code> 操作。</p>
<p><code>command</code> 属性指明操作应该是一个 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan"><code>plan</code></a> 操作还是一个 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/4.apply"><code>apply</code></a> 操作。</p>
<p><code>plan_options</code> 块允许测试的作者定义他们通常需要通过命令行标志和选项定义的 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/commands/plan#planning-modes">plan mode</a> 和 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/commands/plan#planning-options">选项</a>。我们将在 <a href="#variable-%E5%9D%97">变量</a> 部分介绍 <code>-var</code> 和 <code>-var-file</code> 选项。</p>
<h3 id="1-8-1-3-1-断言"><a href="#%E6%96%AD%E8%A8%80"></a>1.8.1.3.1. 断言</h3>
<p>Terraform 测试的 <code>run</code> 块断言是<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">自定义条件</a>，由<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">条件</a>和<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions#error-messages">错误消息</a>组成。</p>
<p>在 Terraform 测试命令执行结束时，Terraform 会将所有失败的断言作为测试通过或失败状态的一部分展示出来。</p>
<h4 id="断言中的引用"><a href="#%E6%96%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"></a>断言中的引用</h4>
<p>测试中的断言可以引用主 Terraform 配置中的其他自定义条件可用的任何现有<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/8.%E8%A1%A8%E8%BE%BE%E5%BC%8F#%E5%BC%95%E7%94%A8%E5%91%BD%E5%90%8D%E5%80%BC">命名值</a>。</p>
<p>此外，测试断言可以直接引用当前和先前 <code>run</code> 块的输出。比如引用了<a href="#%E7%A4%BA%E4%BE%8B">上一个示例</a>中的输出的一个合法的表达式条件：<code>condition = output.bucket_name == &quot;test_bucket&quot;</code>。</p>
<h2 id="1-8-1-4-variable-块"><a href="#variable-%E5%9D%97"></a>1.8.1.4. variable 块</h2>
<p>你可以直接在你的测试文件中为 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F">输入变量</a> 设置值。</p>
<p>你可以在测试文件的根级别或者 <code>run</code> 块内部定义 <code>variables</code> 块。Terraform 将测试文件中的所有变量值传递到文件中的所有 <code>run</code> 块。你可以通过在某个 <code>run</code> 块中直接设置变量值来覆盖从根部继承的值。</p>
<p>在上述 <a href="#%E7%A4%BA%E4%BE%8B">示例</a> 的测试文件中添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># variable_precedence.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;uses_root_level_value&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;overrides_root_level_value&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    bucket_prefix = &quot;other&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;other-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们添加了第二个 <code>run</code> 块，该块指定 <code>bucket_prefix</code> 变量值为 <code>other</code>，覆盖了测试文件提供的，并在第一个 <code>run</code> 块中使用的值 —— <code>test</code>。</p>
<h3 id="1-8-1-4-1-通过命令行或定义文件指定变量"><a href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%88%96%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9A%E5%8F%98%E9%87%8F"></a>1.8.1.4.1. 通过命令行或定义文件指定变量</h3>
<p>除了通过测试文件指定变量值外，Terraform <code>test</code> 命令还支持指定变量值的其他方法。</p>
<p>您可以通过 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0">命令行</a> 和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%8F%82%E6%95%B0%E6%96%87%E4%BB%B6">变量定义文件</a> 为所有测试指定变量值。</p>
<p>像普通的 Terraform 命令一样，Terraform 会自动加载测试目录中定义的任何变量文件。自动变量文件包括 <code>terraform.tfvars</code>、<code>terraform.tfvars.json</code>，以及所有以 <code>.auto.tfvars</code> 或 <code>.auto.tfvars.json</code> 结尾的文件。</p>
<p><strong>注意：</strong> 从测试目录中的自动变量文件加载的变量值只适用于在同一测试目录中定义的测试。以所有其他方式定义的变量将适用于给定测试运行中的所有测试。</p>
<p>这在使用敏感变量值和设置 Provider 配置时特别有用。否则，测试文件可能会直接暴露这些敏感值。</p>
<h3 id="1-8-1-4-2-变量定义优先级"><a href="#%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E4%BC%98%E5%85%88%E7%BA%A7"></a>1.8.1.4.2. 变量定义优先级</h3>
<p>除了测试文件中设置的变量值，<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F%E8%B5%8B%E5%80%BC%E4%BC%98%E5%85%88%E7%BA%A7">变量定义优先级</a> 在测试中保持不变。在测试文件中定义的变量具有最高优先级，可以覆盖环境变量、变量文件或命令行输入。</p>
<p>对于在测试目录中定义的测试，任何在测试目录的自动变量文件中定义的变量值都将覆盖主配置目录的自动变量文件中定义的值。</p>
<h3 id="1-8-1-4-3-变量中的引用"><a href="#%E5%8F%98%E9%87%8F%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"></a>1.8.1.4.3. 变量中的引用</h3>
<p>在 <code>run</code> 块中定义的 <code>variable</code> 中可以引用在先前 <code>run</code> 块中执行的模块的输出和在更高优先级定义的变量。</p>
<p>例如，以下代码块显示了变量如何引用更高优先级的变量和先前的 <code>run</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">variables &#123;</span><br><span class="line">  global_value = &quot;some value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;run_block_one&quot; &#123;</span><br><span class="line">  variables &#123;</span><br><span class="line">    local_value = var.global_value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">  # 这里应该有一些测试断言</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;run_block_two&quot; &#123;</span><br><span class="line">  variables &#123;</span><br><span class="line">    local_value = run.run_block_one.output_one</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">  # 这里应该有一些测试断言</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面，<code>run_block_one</code> 中的 <code>local_value</code> 从 <code>global_value</code> 变量获取值。如果你想给多个变量分配相同的值，这种模式很有用。你可以在文件级别一次指定一个变量的值，然后与不同的变量共享它。</p>
<p>相比之下，<code>run_block_two</code> 中的 <code>local_value</code> 引用了 <code>run_block_one</code> 的 <code>output_one</code> 的输出值。这种模式对于在 <code>run</code> 块之间传递值特别有用，特别是如果 <code>run</code> 块正在执行<a href="#module-%E5%9D%97">模块</a>部分中详细描述的不同模块。</p>
<h2 id="1-8-1-5-provider-块"><a href="#provider-%E5%9D%97"></a>1.8.1.5. provider 块</h2>
<p>您可以通过使用 <code>provider</code> 和 <code>providers</code> 块和属性，在测试文件中设置或覆盖 Terraform 代码所需的 Provider。</p>
<p>您可以在 Terraform 测试文件的根级别，定义 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/providers/configuration"><code>provider</code> 块</a>，就像在 Terraform <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/providers">配置代码中</a>创建它们一样。然后，Terraform 会将这些 <code>provider</code> 块传递到其配置中，每个 <code>run</code> 块执行时都是如此。</p>
<p>默认情况下，您指定的每个 Provider 都直接在每个 <code>run</code> 块中可用。您可以通过使用 <code>providers</code> 属性在特定 <code>run</code> 块中设置 Provider 的可用性。这个块的行为和语法与 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/meta-arguments/module-providers">providers meta-argument</a> 的行为相匹配。</p>
<p>如果您在测试文件中不提供 Provider 配置，Terraform 会尝试使用 Provider 的默认设置初始化其配置中的所有 Provider。例如，任何旨在配置 Provider 的环境变量仍然可用，并且 Terraform 可以使用它们来创建默认 Provider。</p>
<p>下面，我们将扩展我们之前的 <a href="#%E7%A4%BA%E4%BE%8B">示例</a>，用测试代码而不是 Terraform 配置代码来指定 <code>region</code>。在这个示例中，我们将测试以下配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source = &quot;hashicorp/aws&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-bucket&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;bucket_name&quot; &#123;</span><br><span class="line">  value = aws_s3_bucket.bucket.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们现在可以在以下测试文件中定义如下的 <code>provider</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># customised_provider.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;valid_string_concat&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们也可以创建一个更复杂的示例配置，使用多个 Provider 以及别名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source                = &quot;hashicorp/aws&quot;</span><br><span class="line">      configuration_aliases = [aws.secondary]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  default = &quot;test&quot;</span><br><span class="line">  type    = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;primary_bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-primary&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;secondary_bucket&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">  bucket   = &quot;$&#123;var.bucket_prefix&#125;-secondary&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们的测试文件中，我们可以设定多个 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># customised_providers.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;secondary&quot;</span><br><span class="line">  region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们也可以在特定 <code>run</code> 块中声明特定的 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source                = &quot;hashicorp/aws&quot;</span><br><span class="line">      configuration_aliases = [aws.secondary]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_region&quot; &quot;primary&quot; &#123;&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_region&quot; &quot;secondary&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  default = &quot;test&quot;</span><br><span class="line">  type    = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;primary_bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-$&#123;data.aws_region.primary.name&#125;-primary&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;secondary_bucket&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">  bucket   = &quot;$&#123;var.bucket_prefix&#125;-$&#123;data.aws_region.secondary.name&#125;-secondary&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的测试文件可以为不同的 <code>run</code> 块配置的 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># customised_providers.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;secondary&quot;</span><br><span class="line">  region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;tertiary&quot;</span><br><span class="line">  region = &quot;eu-west-2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;default_providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-us-east-1-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-eu-central-1-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;customised_providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws           = aws</span><br><span class="line">    aws.secondary = aws.tertiary</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-us-east-1-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-eu-west-2-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> 在使用 <code>command = apply</code> 运行测试时，<code>run</code> 块之间切换 Provider 可能会导致运行和测试失败，因为由一个 Provider 定义创建的资源在被另一个修改时将无法使用。</p>
<p>从 Terraform v1.7.0 开始，<code>provider</code> 块也可以引用测试文件变量和 <code>run</code> 块输出。这意味着测试框架可以从一个 Provider 获取凭证和其他设置信息，并在初始化第二个 Provider 时使用这些信息。</p>
<p>在下面的示例中，首先初始化 <code>vault</code> Provider，然后在一个设置模块中使用它来提取 <code>aws</code> Provider 的凭证。有关 setup 模块的更多信息，请参阅 <a href="#module-%E5%9D%97">模块</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">provider &quot;vault&quot; &#123;</span><br><span class="line">  # ... vault configuration ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region     = &quot;us-east-1&quot;</span><br><span class="line"></span><br><span class="line">  # The `aws` provider can reference the outputs of the &quot;vault_setup&quot; run block.</span><br><span class="line">  access_key = run.vault_setup.aws_access_key</span><br><span class="line">  secret_key = run.vault_setup.aws_secret_key</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;vault_setup&quot; &#123;</span><br><span class="line">  module &#123;</span><br><span class="line">    # This module should only include reference to the Vault provider. Terraform</span><br><span class="line">    # will automatically work out which providers to supply based on the module</span><br><span class="line">    # configuration. The tests will error if a run block requires access to a</span><br><span class="line">    # provider that references outputs from a run block that has not executed.</span><br><span class="line">    source = &quot;./testing/vault-setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;use_aws_provider&quot; &#123;</span><br><span class="line">  # This run block can then use both the `aws` and `vault` providers, as the</span><br><span class="line">  # previous run block provided all the data required for the `aws` provider.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-8-1-6-module-块"><a href="#module-%E5%9D%97"></a>1.8.1.6. module 块</h2>
<p>您可以修改特定的 <code>run</code> 块执行的模块。</p>
<p>默认情况下，Terraform 针对正在测试的配置代码，依次执行所有 <code>run</code> 块中设定的命令。Terraform 在您执行 <code>terraform test</code> 命令的目录（或者您用 <code>-chdir</code> 参数指向的目录）内测试配置。每个 <code>run</code> 块也允许用户使用 <code>module</code> 块更改目标配置。</p>
<p>与传统的 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97"><code>module</code> 块</a>不同，测试文件中的 <code>module</code> 块 <em>仅</em> 支持 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%A8%A1%E5%9D%97%E6%BA%90"><code>source</code></a> 属性和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%A8%A1%E5%9D%97%E7%89%88%E6%9C%AC%E7%BA%A6%E6%9D%9F"><code>version</code></a> 属性。通常通过传统的 <code>module</code> 块提供的其余属性应由 <code>run</code> 块内的替代属性和块提供。</p>
<p><strong>注意：</strong> Terraform 测试文件只支持 <code>source</code> 属性中的 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%9C%AC%E5%9C%B0%E8%B7%AF%E5%BE%84">本地</a> 和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#terraform-registry">注册表</a> 模块。</p>
<p>在执行其他模块时，<code>run</code> 块内的所有其他块和属性都受支持，<code>assert</code> 块执行时使用来自其他模块的值。这在 <a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81">模块状态</a> 中有更详细的说明。</p>
<p>测试文件中 <code>modules</code> 块的两个示例用例是：</p>
<ol>
<li>一个设置模块，为待测 Terraform 配置代码创建测试所需的基础设施。</li>
<li>一个加载模块，用于加载和验证 Terraform 配置代码未直接创建的次要基础设施（如数据源）。</li>
</ol>
<p>以下示例演示了这两种用例。</p>
<p>首先，我们有一个模块，它将创建并将多个文件加载到已创建的 S3 存储桶中。这是我们要测试的配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;files&quot; &#123;</span><br><span class="line">  type = map(string)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_object&quot; &quot;object&quot; &#123;</span><br><span class="line">  for_each = var.files</span><br><span class="line"></span><br><span class="line">  bucket = data.aws_s3_bucket.bucket.id</span><br><span class="line">  key = each.key</span><br><span class="line">  source = each.value</span><br><span class="line"></span><br><span class="line">  etag = filemd5(each.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们使用配置模块创建这个 S3 存储桶，这样在测试时就可以使用它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># testing/setup/main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三步，我们使用一个加载模块，读取 S3 存储桶中的文件。这是一个比较牵强的例子，因为我们完全可以直接在创建这些文件的模块中创建这些数据源，但它在这里可以很好地演示如何编写测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># testing/loader/main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_s3_objects&quot; &quot;objects&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们使用测试文件把刚才创建的多个助手模块以及待测模块编织在一起形成一个有效的测试配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># file_count.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket = &quot;my_test_bucket&quot;</span><br><span class="line">  files = &#123;</span><br><span class="line">    &quot;file-one.txt&quot;: &quot;data/files/file_one.txt&quot;</span><br><span class="line">    &quot;file-two.txt&quot;: &quot;data/files/file_two.txt&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;setup&quot; &#123;</span><br><span class="line">  # Create the S3 bucket we will use later.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;execute&quot; &#123;</span><br><span class="line">  # This is empty, we just run the configuration under test using all the default settings.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;verify&quot; &#123;</span><br><span class="line">  # Load and count the objects created in the &quot;execute&quot; run block.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/loader&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition = length(data.aws_s3_objects.objects.keys) == 2</span><br><span class="line">    error_message = &quot;created the wrong number of s3 objects&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-8-1-6-1-模块状态"><a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81"></a>1.8.1.6.1. 模块状态</h3>
<p>当 Terraform 执行 <code>terraform test</code> 命令时，Terraform 会为每个测试文件在内存中维护一个或多个状态文件。</p>
<p>总是至少有一个状态文件维护在测试下的 Terraform 配置代码的状态。这个状态文件由所有没有 <code>module</code> 块指定要加载的替代模块的 <code>run</code> 块共享。</p>
<p>此外，Terraform 加载的每个替代模块都有一个状态文件。一个替代模块的状态文件被执行给定模块的所有 <code>run</code> 块共享。</p>
<p>Terraform 团队对任何需要手动状态管理或在 <code>test</code> 命令中对同一状态执行不同配置的用例感兴趣。如果你有一个用例，请提交一个 <a target="_blank" rel="noopener" href="https://github.com/hashicorp/terraform/issues/new/choose">issue</a>并与我们分享。</p>
<p>以下示例使用注释来解释每个 <code>run</code> 块的状态文件的来源。在下面的示例中，Terraform 创建并管理了总共三个状态文件。第一个状态文件是针对测试下的主模块，第二个是针对设置模块，第三个是针对加载模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">run &quot;setup&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block references an alternate module and is the first run block</span><br><span class="line">  # to reference this particular alternate module. Therefore, Terraform creates</span><br><span class="line">  # and populates a new empty state file for this run block.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;init&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block does not reference an alternate module, so it uses the main</span><br><span class="line">  # state file for the configuration under test. As this is the first run block</span><br><span class="line">  # to reference the main configuration, the previously empty state file now</span><br><span class="line">  # contains the resources created by this run block.</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    # In practice we&#x27;d do some interesting checks and tests here but the</span><br><span class="line">    # assertions aren&#x27;t important for this example.</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ... more assertions ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;update_setup&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # We&#x27;ve now re-referenced the setup module, so the state file that was created</span><br><span class="line">  # for the first &quot;setup&quot; run block will be reused. It will contain any</span><br><span class="line">  # resources that were created as part of the other run block before this run</span><br><span class="line">  # block executes and will be updated with any changes made by this run block</span><br><span class="line">  # after.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    # In practice, we&#x27;d likely make some changes to the module compared to the</span><br><span class="line">    # first run block here. Otherwise, there would be no point recalling the</span><br><span class="line">    # module.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;update&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # As with the &quot;init&quot; run block, we are executing against the main configuration</span><br><span class="line">  # again. This means we&#x27;d load the main state file that was initially populated</span><br><span class="line">  # by the &quot;init&quot; run block, and any changes made by this &quot;run&quot; block will be</span><br><span class="line">  # carried forward to any future run blocks that execute against the main</span><br><span class="line">  # configuration.</span><br><span class="line"></span><br><span class="line">  # ... updated variables ...</span><br><span class="line"></span><br><span class="line">  # ... assertions ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;loader&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block is now referencing our second alternate module so will create</span><br><span class="line">  # our third and final state file. The other two state files are managing</span><br><span class="line">  # resources from the main configuration and resources from the setup module.</span><br><span class="line">  # We are getting a new state file for this run block as the loader module has</span><br><span class="line">  # not previously been referenced by any run blocks.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/loader&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="模块的清理"><a href="#%E6%A8%A1%E5%9D%97%E7%9A%84%E6%B8%85%E7%90%86"></a>模块的清理</h4>
<p>在测试文件执行结束时，Terraform 会试图销毁在该测试文件执行过程中创建的每个资源。当 Terraform 加载替代模块时，Terraform 销毁这些对象的顺序很重要。例如，在第一个 <a href="#module-%E5%9D%97">模块</a> 示例中，Terraform 不能在 “execute” <code>run</code> 块中创建的对象之前销毁在 “setup” <code>run</code> 块中创建的资源，因为我们在 “setup” 步骤中创建的 S3 桶在包含对象的情况下无法被销毁。</p>
<p>Terraform 按照 <code>run</code> 块的反向顺序销毁资源。在最近的 <a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81">例子</a> 中，有三个状态文件。一个用于主状态，一个用于 <code>./testing/loader</code> 模块，还有一个用于 <code>./testing/setup</code> 模块。由于 <code>./testing/loader</code> 状态文件最近被最后一个运行块引用，因此首先被销毁。主状态文件将被第二个销毁，因为它被 “update” <code>run</code> 块引用。然后 <code>./testing/setup</code> 状态文件将被最后销毁。</p>
<p>请注意，前两个 <code>run</code> 块 “setup” 和 “init” 在销毁操作中不做任何事情，因为它们的状态文件被后续的 run 块使用，并且已经被销毁。</p>
<p>如果你使用单个设置模块作为替代模块，并且它首先执行，或者你不使用任何替代模块，那么销毁顺序不会影响你。更复杂的情况可能需要仔细考虑，以确保资源的销毁可以自动完成。</p>
<h2 id="1-8-1-7-预期失败"><a href="#%E9%A2%84%E6%9C%9F%E5%A4%B1%E8%B4%A5"></a>1.8.1.7. 预期失败</h2>
<p>默认情况下，如果在执行 Terraform 测试文件期间，任何<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">自定义条件</a>，包括 <code>check</code> 块断言失败，则整体命令会将测试报告为失败。</p>
<p>然而，我们经常想要测试代码运行失败时的行为。Terraform 为此用例提供了 <code>expect_failures</code> 属性。</p>
<p>在每个 <code>run</code> 块中，<code>expect_failures</code> 属性可以设置应该导致自定义条件检查失败的可检查对象（资源，数据源，检查块，输入变量和输出）的列表。如果您指定的可检查对象报告问题，测则试通过，如果没有报告错误，那么测试总体上失败。</p>
<p>您仍然可以在 <code>expect_failures</code> 块附近编写断言，但您应该注意，除了 <code>check</code> 块断言外，所有自定义条件都会停止 Terraform 的执行。这在测试执行期间仍然适用，所以这些断言应该只考虑你确定会在可检查对象应该失败之前可知的值。您可以使用引用或在主配置中的 <code>depends_on</code> 元参数来管理这一点。</p>
<p>这也意味着，除了 <code>check</code> 块，你只能可靠地包含一个可检查的对象。我们支持在 <code>expect_failures</code> 属性中列出可检查对象的列表，仅用于 <code>check</code> 块。</p>
<p>下面的一个快速示例演示了测试输入变量的 <code>validation</code> 块。配置文件接受一个必须是偶数的单一输入变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;input&quot; &#123;</span><br><span class="line">  type = number</span><br><span class="line"></span><br><span class="line">  validation &#123;</span><br><span class="line">    condition = var.input % 2 == 0</span><br><span class="line">    error_message = &quot;must be even number&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试文件包含了两个 <code>run</code> 块。一个验证了我们的自定义条件在偶数条件下是通过的，另一个验证输入奇数时会失败。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># input_validation.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  input = 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;zero&quot; &#123;</span><br><span class="line">  # The variable defined above is even, so we expect the validation to pass.</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;one&quot; &#123;</span><br><span class="line">  # This time we set the variable is odd, so we expect the validation to fail.</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    input = 1</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  expect_failures = [</span><br><span class="line">    var.input,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：Terraform 只期望在 <code>run</code> 块的 <code>command</code> 属性指定的操作中出现失败。</p>
<p>在使用 <code>command = apply</code> 的 <code>run</code> 块中使用 <code>expect_failures</code> 时要小心。一个 <code>run</code> 块中的 <code>command = apply</code> 如果期望自定义条件失败，那么如果该自定义条件在 <code>plan</code> 期间失败，整体将会失败。</p>
<p>这在逻辑上是正确的，因为 <code>run</code> 块期望能够运行应用操作，但由于 <code>plan</code> 失败而不能运行，但这也可能会引起混淆，因为即使那个失败被标记为预期的，你还是会在诊断中看到失败。</p>
<p>有时，Terraform 在计划阶段不执行自定义条件，因为该条件依赖于只有在 Terraform 创建引用资源后才可用的计算属性。在这些情况下，你可以在设置 <code>command = apply</code> 时使用 <code>expect_failures</code> 块。然而，大多数情况下，我们建议只在 <code>command = plan</code> 时使用 <code>expect_failures</code>。</p>
<p><strong>注意</strong>：预期的失败只适用于用户定义的自定义条件。</p>
<p>除了在可检查对象中指定的预期失败之外的其他种类的失败仍会导致整体测试失败。例如，一个期望布尔值作为输入的变量，如果 Terraform 收到的是错误的值类型，即使该变量包含在 <code>expect_failures</code> 属性中，也会导致周围的测试失败。</p>
<p><code>expect_failures</code> 属性包含在其中是为了允许作者测试他们的配置和任何定义的逻辑。像前面的例子中的类型不匹配错误，不是 Terraform 作者应该担心和测试的事情，因为 Terraform 本身会处理强制类型约束。因此，你只能在自定义条件中 <code>expect_failures</code>。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="../../2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                留言與分享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a
                class="btn btn--default btn--small"
                href="page/2/"
                aria-label="下一頁"
            >
              <span>下一頁</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">第 1 頁 共 5 頁</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Kein Chan. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="../../assets/images/profile.jpg" alt="作者的圖片"/>
        
            <h4 id="about-card-name">Kein Chan</h4>
        
            <div id="about-card-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>全棧工程師</br>資深技術顧問</br>數據科學家</br>Hit廣島觀光大使</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Tokyo/Macau
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="../assets/images/logo-algolia-nebula-blue-full.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">沒有找到文章</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/04/27/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/"
                            aria-label=": R语言-环境安装"
                        >
                            <h3 class="media-heading">R语言-环境安装</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月27日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/04/28/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E5%9F%BA%E7%A1%80/"
                            aria-label=": R语言-基础"
                        >
                            <h3 class="media-heading">R语言-基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月28日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/05/01/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE/"
                            aria-label=": R语言-读取数据"
                        >
                            <h3 class="media-heading">R语言-读取数据</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月1日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/05/02/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BB%98%E5%9B%BE/"
                            aria-label=": R语言-绘图"
                        >
                            <h3 class="media-heading">R语言-绘图</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月2日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/05/03/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/"
                            aria-label=": R语言-线性回归"
                        >
                            <h3 class="media-heading">R语言-线性回归</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月3日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/22/Algorithms/1.%E7%AE%97%E6%B3%95%E5%9C%A8%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8/"
                            aria-label=": 1. 算法在计算中的作用"
                        >
                            <h3 class="media-heading">1. 算法在计算中的作用</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月22日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/23/Algorithms/2.%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/"
                            aria-label=": 2. 算法基础"
                        >
                            <h3 class="media-heading">2. 算法基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/24/Algorithms/3.%E5%87%BD%E6%95%B0%E7%9A%84%E5%A2%9E%E9%95%BF/"
                            aria-label=": 3. 函数的增长"
                        >
                            <h3 class="media-heading">3. 函数的增长</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月24日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/25/Algorithms/4.%E5%88%86%E6%B2%BB%E7%AD%96%E7%95%A5/"
                            aria-label=": 4. 分治策略"
                        >
                            <h3 class="media-heading">4. 分治策略</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月25日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/26/Algorithms/5.%E6%A6%82%E7%8E%87%E5%88%86%E6%9E%90%E5%92%8C%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/"
                            aria-label=": 5. 概率分析和随机算法"
                        >
                            <h3 class="media-heading">5. 概率分析和随机算法</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月26日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="沒有找到文章"
                data-message-one="找到 1 篇文章"
                data-message-other="找到 {n} 篇文章">
                找到 210 篇文章
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('../../assets/images/cover.jpeg');"></div>
        <!--SCRIPTS-->

<script src="../../assets/js/script-qtzvvb63gamuirvfphht7lytrxkfllzng1escnm2phjtlt4tvvxi5gl0wx4o.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
