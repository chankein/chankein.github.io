
<!DOCTYPE html>
<html lang="zh-tw">
    
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    
      <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/locale/zh-tw.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
    <script>
      window.algoliaConfig = {
        appId: 'AWFC86Q51O',
        apiKey: 'c9d952906eb1b154d75cf863e75c1ede',
        indexName: 'MyBlog'
      };
      var algoliaIndex = algoliasearch(
        algoliaConfig.appId,
        algoliaConfig.apiKey
      ).initIndex(algoliaConfig.indexName);
    </script>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Kein&#39;s blog">
    <title>Terraform-基础概念-状态管理 - Kein&#39;s blog</title>
    <meta name="author" content="Kein Chan">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kein Chan","sameAs":["https://github.com/chankein/","https://www.linkedin.com/profile/","mailto:kein.chan85@gmail.com"],"image":"profile.jpg"},"articleBody":"\n\n1.3.2.1. Terraform 基础概念——状态管理\n\n\n1.3.2.1.1. 初探状态文件\n\n\n1.3.2.1.2. 极其重要的安全警示—— tfstate 是明文的\n\n\n1.3.2.1.3. 生产环境的 tfstate 管理方案—— Backend\n\n\n1.3.2.1.4. Consul简介以及安装\n\n\n1.3.2.1.5. 使用 Backend\n\n\n1.3.2.1.6. 观察锁文件\n\n\n1.3.2.1.7. Backend 配置的动态赋值\n\n\n1.3.2.1.8. Backend 的权限控制以及版本控制\n\n\n1.3.2.1.9. 状态的隔离存储\n\n\n1.3.2.1.10. 该使用哪种隔离\n\n\n\n1.3.2.1. Terraform 基础概念——状态管理\n我们在第一章的末尾提过，当我们成功地执行了一次 terraform apply，创建了期望的基础设施以后，我们如果再次执行 terraform apply，生成的新的执行计划将不会包含任何变更，Terraform 会记住当前基础设施的状态，并将之与代码所描述的期望状态进行比对。第二次 apply 时，因为当前状态已经与代码描述的状态一致了，所以会生成一个空的执行计划。\n1.3.2.1.1. 初探状态文件\n在这里，Terraform 引入了一个独特的概念——状态管理，这是 Ansible 等配置管理工具或是自研工具调用 SDK 操作基础设施的方案所没有的。简单来说，Terraform 将每次执行基础设施变更操作时的状态信息保存在一个状态文件中，默认情况下会保存在当前工作目录下的 terraform.tfstate 文件里。例如我们之前在使用 LocalStack 模拟环境的代码中声明一个 data 和一个 resource：\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869terraform &#123;  required_providers &#123;    aws = &#123;      source = &quot;hashicorp/aws&quot;      version = &quot;~&gt;5.0&quot;    &#125;  &#125;&#125;provider &quot;aws&quot; &#123;  access_key                  = &quot;test&quot;  secret_key                  = &quot;test&quot;  region                      = &quot;us-east-1&quot;  s3_use_path_style           = false  skip_credentials_validation = true  skip_metadata_api_check     = true  skip_requesting_account_id  = true  endpoints &#123;    apigateway     = &quot;http://localhost:4566&quot;    apigatewayv2   = &quot;http://localhost:4566&quot;    cloudformation = &quot;http://localhost:4566&quot;    cloudwatch     = &quot;http://localhost:4566&quot;    dynamodb       = &quot;http://localhost:4566&quot;    ec2            = &quot;http://localhost:4566&quot;    es             = &quot;http://localhost:4566&quot;    elasticache    = &quot;http://localhost:4566&quot;    firehose       = &quot;http://localhost:4566&quot;    iam            = &quot;http://localhost:4566&quot;    kinesis        = &quot;http://localhost:4566&quot;    lambda         = &quot;http://localhost:4566&quot;    rds            = &quot;http://localhost:4566&quot;    redshift       = &quot;http://localhost:4566&quot;    route53        = &quot;http://localhost:4566&quot;    s3             = &quot;http://s3.localhost.localstack.cloud:4566&quot;    secretsmanager = &quot;http://localhost:4566&quot;    ses            = &quot;http://localhost:4566&quot;    sns            = &quot;http://localhost:4566&quot;    sqs            = &quot;http://localhost:4566&quot;    ssm            = &quot;http://localhost:4566&quot;    stepfunctions  = &quot;http://localhost:4566&quot;    sts            = &quot;http://localhost:4566&quot;  &#125;&#125;data &quot;aws_ami&quot; &quot;ubuntu&quot; &#123;  most_recent = true  filter &#123;    name   = &quot;name&quot;    values = [&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;]  &#125;  filter &#123;    name   = &quot;virtualization-type&quot;    values = [&quot;hvm&quot;]  &#125;  owners = [&quot;099720109477&quot;] # Canonical&#125;resource &quot;aws_instance&quot; &quot;web&quot; &#123;  ami           = data.aws_ami.ubuntu.id  instance_type = &quot;t3.micro&quot;  tags = &#123;    Name = &quot;HelloWorld&quot;  &#125;&#125;\n使用 terraform apply 后，我们可以看到 terraform.tfstate 的内容：\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191&#123;  &quot;version&quot;: 4,  &quot;terraform_version&quot;: &quot;1.7.3&quot;,  &quot;serial&quot;: 1,  &quot;lineage&quot;: &quot;159018e2-63f4-2dfa-ce0d-873a37a1e0a7&quot;,  &quot;outputs&quot;: &#123;&#125;,  &quot;resources&quot;: [    &#123;      &quot;mode&quot;: &quot;data&quot;,      &quot;type&quot;: &quot;aws_ami&quot;,      &quot;name&quot;: &quot;ubuntu&quot;,      &quot;provider&quot;: &quot;provider[\\&quot;registry.terraform.io/hashicorp/aws\\&quot;]&quot;,      &quot;instances&quot;: [        &#123;          &quot;schema_version&quot;: 0,          &quot;attributes&quot;: &#123;            &quot;architecture&quot;: &quot;x86_64&quot;,            &quot;arn&quot;: &quot;arn:aws:ec2:us-east-1::image/ami-1e749f67&quot;,            &quot;block_device_mappings&quot;: [              &#123;                &quot;device_name&quot;: &quot;/dev/sda1&quot;,                &quot;ebs&quot;: &#123;                  &quot;delete_on_termination&quot;: &quot;false&quot;,                  &quot;encrypted&quot;: &quot;false&quot;,                  &quot;iops&quot;: &quot;0&quot;,                  &quot;snapshot_id&quot;: &quot;snap-15bd5527&quot;,                  &quot;throughput&quot;: &quot;0&quot;,                  &quot;volume_size&quot;: &quot;15&quot;,                  &quot;volume_type&quot;: &quot;standard&quot;                &#125;,                &quot;no_device&quot;: &quot;&quot;,                &quot;virtual_name&quot;: &quot;&quot;              &#125;            ],            &quot;boot_mode&quot;: &quot;&quot;,            &quot;creation_date&quot;: &quot;2024-02-20T13:52:42.000Z&quot;,            &quot;deprecation_time&quot;: &quot;&quot;,            &quot;description&quot;: &quot;Canonical, Ubuntu, 14.04 LTS, amd64 trusty image build on 2017-07-27&quot;,            &quot;ena_support&quot;: false,            &quot;executable_users&quot;: null,            &quot;filter&quot;: [              &#123;                &quot;name&quot;: &quot;name&quot;,                &quot;values&quot;: [                  &quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;                ]              &#125;,              &#123;                &quot;name&quot;: &quot;virtualization-type&quot;,                &quot;values&quot;: [                  &quot;hvm&quot;                ]              &#125;            ],            &quot;hypervisor&quot;: &quot;xen&quot;,            &quot;id&quot;: &quot;ami-1e749f67&quot;,            &quot;image_id&quot;: &quot;ami-1e749f67&quot;,            &quot;image_location&quot;: &quot;amazon/getting-started&quot;,            &quot;image_owner_alias&quot;: &quot;amazon&quot;,            &quot;image_type&quot;: &quot;machine&quot;,            &quot;imds_support&quot;: &quot;&quot;,            &quot;include_deprecated&quot;: false,            &quot;kernel_id&quot;: &quot;None&quot;,            &quot;most_recent&quot;: true,            &quot;name&quot;: &quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;,            &quot;name_regex&quot;: null,            &quot;owner_id&quot;: &quot;099720109477&quot;,            &quot;owners&quot;: [              &quot;099720109477&quot;            ],            &quot;platform&quot;: &quot;&quot;,            &quot;platform_details&quot;: &quot;&quot;,            &quot;product_codes&quot;: [],            &quot;public&quot;: true,            &quot;ramdisk_id&quot;: &quot;ari-1a2b3c4d&quot;,            &quot;root_device_name&quot;: &quot;/dev/sda1&quot;,            &quot;root_device_type&quot;: &quot;ebs&quot;,            &quot;root_snapshot_id&quot;: &quot;snap-15bd5527&quot;,            &quot;sriov_net_support&quot;: &quot;&quot;,            &quot;state&quot;: &quot;available&quot;,            &quot;state_reason&quot;: &#123;              &quot;code&quot;: &quot;UNSET&quot;,              &quot;message&quot;: &quot;UNSET&quot;            &#125;,            &quot;tags&quot;: &#123;&#125;,            &quot;timeouts&quot;: null,            &quot;tpm_support&quot;: &quot;&quot;,            &quot;usage_operation&quot;: &quot;&quot;,            &quot;virtualization_type&quot;: &quot;hvm&quot;          &#125;,          &quot;sensitive_attributes&quot;: []        &#125;      ]    &#125;,    &#123;      &quot;mode&quot;: &quot;managed&quot;,      &quot;type&quot;: &quot;aws_instance&quot;,      &quot;name&quot;: &quot;web&quot;,      &quot;provider&quot;: &quot;provider[\\&quot;registry.terraform.io/hashicorp/aws\\&quot;]&quot;,      &quot;instances&quot;: [        &#123;          &quot;schema_version&quot;: 1,          &quot;attributes&quot;: &#123;            &quot;ami&quot;: &quot;ami-1e749f67&quot;,            &quot;arn&quot;: &quot;arn:aws:ec2:us-east-1::instance/i-288a34165ed2ad2f7&quot;,            &quot;associate_public_ip_address&quot;: true,            &quot;availability_zone&quot;: &quot;us-east-1a&quot;,            &quot;capacity_reservation_specification&quot;: [],            &quot;cpu_core_count&quot;: null,            &quot;cpu_options&quot;: [],            &quot;cpu_threads_per_core&quot;: null,            &quot;credit_specification&quot;: [],            &quot;disable_api_stop&quot;: false,            &quot;disable_api_termination&quot;: false,            &quot;ebs_block_device&quot;: [],            &quot;ebs_optimized&quot;: false,            &quot;enclave_options&quot;: [],            &quot;ephemeral_block_device&quot;: [],            &quot;get_password_data&quot;: false,            &quot;hibernation&quot;: false,            &quot;host_id&quot;: &quot;&quot;,            &quot;host_resource_group_arn&quot;: null,            &quot;iam_instance_profile&quot;: &quot;&quot;,            &quot;id&quot;: &quot;i-288a34165ed2ad2f7&quot;,            &quot;instance_initiated_shutdown_behavior&quot;: &quot;stop&quot;,            &quot;instance_lifecycle&quot;: &quot;&quot;,            &quot;instance_market_options&quot;: [],            &quot;instance_state&quot;: &quot;running&quot;,            &quot;instance_type&quot;: &quot;t3.micro&quot;,            &quot;ipv6_address_count&quot;: 0,            &quot;ipv6_addresses&quot;: [],            &quot;key_name&quot;: &quot;&quot;,            &quot;launch_template&quot;: [],            &quot;maintenance_options&quot;: [],            &quot;metadata_options&quot;: [],            &quot;monitoring&quot;: false,            &quot;network_interface&quot;: [],            &quot;outpost_arn&quot;: &quot;&quot;,            &quot;password_data&quot;: &quot;&quot;,            &quot;placement_group&quot;: &quot;&quot;,            &quot;placement_partition_number&quot;: 0,            &quot;primary_network_interface_id&quot;: &quot;eni-68899bf6&quot;,            &quot;private_dns&quot;: &quot;ip-10-13-239-41.ec2.internal&quot;,            &quot;private_dns_name_options&quot;: [],            &quot;private_ip&quot;: &quot;10.13.239.41&quot;,            &quot;public_dns&quot;: &quot;ec2-54-214-132-221.compute-1.amazonaws.com&quot;,            &quot;public_ip&quot;: &quot;54.214.132.221&quot;,            &quot;root_block_device&quot;: [              &#123;                &quot;delete_on_termination&quot;: true,                &quot;device_name&quot;: &quot;/dev/sda1&quot;,                &quot;encrypted&quot;: false,                &quot;iops&quot;: 0,                &quot;kms_key_id&quot;: &quot;&quot;,                &quot;tags&quot;: &#123;&#125;,                &quot;throughput&quot;: 0,                &quot;volume_id&quot;: &quot;vol-6dde834f&quot;,                &quot;volume_size&quot;: 8,                &quot;volume_type&quot;: &quot;gp2&quot;              &#125;            ],            &quot;secondary_private_ips&quot;: [],            &quot;security_groups&quot;: [],            &quot;source_dest_check&quot;: true,            &quot;spot_instance_request_id&quot;: &quot;&quot;,            &quot;subnet_id&quot;: &quot;subnet-dbb4c2f9&quot;,            &quot;tags&quot;: &#123;              &quot;Name&quot;: &quot;HelloWorld&quot;            &#125;,            &quot;tags_all&quot;: &#123;              &quot;Name&quot;: &quot;HelloWorld&quot;            &#125;,            &quot;tenancy&quot;: &quot;default&quot;,            &quot;timeouts&quot;: null,            &quot;user_data&quot;: null,            &quot;user_data_base64&quot;: null,            &quot;user_data_replace_on_change&quot;: false,            &quot;volume_tags&quot;: null,            &quot;vpc_security_group_ids&quot;: []          &#125;,          &quot;sensitive_attributes&quot;: [],          &quot;private&quot;: &quot;eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==&quot;,          &quot;dependencies&quot;: [            &quot;data.aws_ami.ubuntu&quot;          ]        &#125;      ]    &#125;  ],  &quot;check_results&quot;: null&#125;\n我们可以看到，查询到的 data 以及创建的 resource 信息都被以 json 格式保存在 tfstate 文件里。\n我们前面已经说过，由于 tfstate 文件的存在，我们在 terraform apply 之后立即再次 apply 是不会执行任何变更的，那么如果我们删除了这个 tfstate 文件，然后再执行 apply 会发生什么呢？Terraform 读取不到 tfstate 文件，会认为这是我们第一次创建这组资源，所以它会再一次创建代码中描述的所有资源。更加麻烦的是，由于我们前一次创建的资源所对应的状态信息被我们删除了，所以我们再也无法通过执行 terraform destroy 来销毁和回收这些资源，实际上产生了资源泄漏。所以妥善保存这个状态文件是非常重要的。\n另外，如果我们对 Terraform 的代码进行了一些修改，导致生成的执行计划将会改变状态，那么在实际执行变更之前，Terraform 会复制一份当前的 tfstate 文件到同路径下的 terraform.tfstate.backup 中，以防止由于各种意外导致的 tfstate 损毁。\n在 Terraform 发展的极早期，HashiCorp 曾经尝试过无状态文件的方案，也就是在执行 Terraform 变更计划时，给所有涉及到的资源都打上特定的 tag，在下次执行变更时，先通过 tag 读取相关资源来重建状态信息。但因为并不是所有资源都支持打 tag，也不是所有公有云都支持多 tag，所以 Terraform 最终决定用状态文件方案。\n还有一点，HashiCorp 官方从未公开过 tfstate 的格式，也就是说，HashiCorp 保留随时修改 tfstate 格式的权力。所以不要试图手动或是用自研代码去修改 tfstate，Terraform 命令行工具提供了相关的指令(我们后续会介绍到)，请确保只通过命令行的指令操作状态文件。\n1.3.2.1.2. 极其重要的安全警示—— tfstate 是明文的\n关于 Terraform 状态，还有极其重要的事，所有考虑在生产环境使用 Terraform 的人都必须格外小心并再三警惕：Terraform 的状态文件是明文的，这就意味着代码中所使用的一切机密信息都将以明文的形式保存在状态文件里。例如我们创建一个私钥文件：\n123resource &quot;tls_private_key&quot; &quot;example&quot; &#123;  algorithm = &quot;RSA&quot;&#125;\n执行了terraform apply后我们观察 tfstate 文件中相关段落：\n1234567891011121314151617181920212223242526272829303132333435&#123;  &quot;version&quot;: 4,  &quot;terraform_version&quot;: &quot;1.7.3&quot;,  &quot;serial&quot;: 1,  &quot;lineage&quot;: &quot;dec42d6b-d61f-30b3-0b83-d5d8881c29ea&quot;,  &quot;outputs&quot;: &#123;&#125;,  &quot;resources&quot;: [    &#123;      &quot;mode&quot;: &quot;managed&quot;,      &quot;type&quot;: &quot;tls_private_key&quot;,      &quot;name&quot;: &quot;example&quot;,      &quot;provider&quot;: &quot;provider[\\&quot;registry.terraform.io/hashicorp/tls\\&quot;]&quot;,      &quot;instances&quot;: [        &#123;          &quot;schema_version&quot;: 1,          &quot;attributes&quot;: &#123;            &quot;algorithm&quot;: &quot;RSA&quot;,            &quot;ecdsa_curve&quot;: &quot;P224&quot;,            &quot;id&quot;: &quot;d47d1465586d25322bb8ca16029fe4fb2ec001e0&quot;,            &quot;private_key_openssh&quot;: &quot;-----BEGIN OPENSSH PRIVATE KEY-----\\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdz\\nc2gtcnNhAAAAAwEAAQAAAQEAsdD9sJ/L5m8cRB19V20HA9BIqZwnT3id5JoMNUuW\\nYn4sJTWHa/JHkQ5akrWH50aIdzQrQneIZXJyx1OMlqKbVxAc2+u/8qd2m2GrsWKZ\\neqQcpNT7v76QowDcvdggad3Tezn3XU/eBukVj9i+lnN1ofyQzVEQAdvW8TpRdUL5\\nb/bIsz1RzGWzUrWD8XTFLf2RuvvzhgBViuuWI0ns3WQMpa6Dcu+nWfGLCl26Wlph\\nNmoUAv8wCay7KoynG58pJW+uqYA7lTx4tNMLhIW7rM4roYbXctkCi03PcW3x25O8\\nyKSzYIi5xH7CQ7ggwXzcx4r06NXkaE9/LHuBSFJcIMvH8QAAA7jnMVXy5zFV8gAA\\nAAdzc2gtcnNhAAABAQCx0P2wn8vmbxxEHX1XbQcD0EipnCdPeJ3kmgw1S5Zifiwl\\nNYdr8keRDlqStYfnRoh3NCtCd4hlcnLHU4yWoptXEBzb67/yp3abYauxYpl6pByk\\n1Pu/vpCjANy92CBp3dN7OfddT94G6RWP2L6Wc3Wh/JDNURAB29bxOlF1Qvlv9siz\\nPVHMZbNStYPxdMUt/ZG6+/OGAFWK65YjSezdZAylroNy76dZ8YsKXbpaWmE2ahQC\\n/zAJrLsqjKcbnyklb66pgDuVPHi00wuEhbusziuhhtdy2QKLTc9xbfHbk7zIpLNg\\niLnEfsJDuCDBfNzHivTo1eRoT38se4FIUlwgy8fxAAAAAwEAAQAAAQEAleLv5ZFd\\nY9mm/vfIrwg1UI6ioW4CaOfoWElOHyKfGlj2x0qu41wv3WM3D9G7REVdRPYRvQ5b\\nSABIJiMUL+nTfXkUioDXpShqPyH+gyD09L8fcgYiS4fMDcrtR43GDNcyq/25uMtZ\\nAYQ6a62tQc8Dik8GlDtPffGc5mxdO7X/4tLAObBPqO+lvGX2K/2hV2ql/a4fBVXR\\nOMPc9A0eva2exifZyFo9vT9CCcW4iNY2BHY2hXAPI1gFpBnmnY2twFof4EvX6tfZ\\nGjt20QCqTi41P8Obrfqi108zRAKtjJFeezNY+diVvxZaCDb/7ceFbFUrXq9u2UVD\\nExn9joOLTJTEwQAAAIEAgOQ/mjRousgSenXW2nE2aq0m7oKQzhsF/8k5UPj6mym1\\nvwUyC2gglTIOGVkUpj91L/Fh2nCuX5BLyzzIee0twRvT1Kj11BU6UoElStpR/JEC\\n7trKWJrBddphBWHAuVcU5AQQPwI/9sg27q/9y16WTIQAJzx8GwGcDbgZj8/LbB4A\\nAACBAMpVcX+2smqt8T9mbwU7e7ZaCQM0c3/7F2S2Z26Zl16k+8WPr6+CyJd3d2s2\\nQkrmqVKJzDqPYidU0EmaNOrqytvUTUDK9KJgKsJuNC9ZbODqTCMA03ntr+hVcfdt\\nd9F5fxyBJSrzpAhUQKadHs8jtAa1ENAhPmwKzvcJ51Gp4R3ZAAAAgQDg+s4nk926\\njuLQGlweOi2HY6eeMQF8MOnXEhM8P7ErdRR73ql7GlhBNoGzuI6YTaqjLXBGNetj\\nm4iziPLapbqBXSeia3y1JU71e1M+J342CxQwZRKTI9G/AB2AzspB4VfjAT9ZYJM1\\nSFH7cDTejcrkfWko8TqyRLwtTPDa7Xlz2QAAAAAB\\n-----END OPENSSH PRIVATE KEY-----\\n&quot;,            &quot;private_key_pem&quot;: &quot;-----BEGIN RSA PRIVATE KEY-----\\nMIIEpAIBAAKCAQEAsdD9sJ/L5m8cRB19V20HA9BIqZwnT3id5JoMNUuWYn4sJTWH\\na/JHkQ5akrWH50aIdzQrQneIZXJyx1OMlqKbVxAc2+u/8qd2m2GrsWKZeqQcpNT7\\nv76QowDcvdggad3Tezn3XU/eBukVj9i+lnN1ofyQzVEQAdvW8TpRdUL5b/bIsz1R\\nzGWzUrWD8XTFLf2RuvvzhgBViuuWI0ns3WQMpa6Dcu+nWfGLCl26WlphNmoUAv8w\\nCay7KoynG58pJW+uqYA7lTx4tNMLhIW7rM4roYbXctkCi03PcW3x25O8yKSzYIi5\\nxH7CQ7ggwXzcx4r06NXkaE9/LHuBSFJcIMvH8QIDAQABAoIBAQCV4u/lkV1j2ab+\\n98ivCDVQjqKhbgJo5+hYSU4fIp8aWPbHSq7jXC/dYzcP0btERV1E9hG9DltIAEgm\\nIxQv6dN9eRSKgNelKGo/If6DIPT0vx9yBiJLh8wNyu1HjcYM1zKr/bm4y1kBhDpr\\nra1BzwOKTwaUO0998ZzmbF07tf/i0sA5sE+o76W8ZfYr/aFXaqX9rh8FVdE4w9z0\\nDR69rZ7GJ9nIWj29P0IJxbiI1jYEdjaFcA8jWAWkGeadja3AWh/gS9fq19kaO3bR\\nAKpOLjU/w5ut+qLXTzNEAq2MkV57M1j52JW/FloINv/tx4VsVSter27ZRUMTGf2O\\ng4tMlMTBAoGBAMpVcX+2smqt8T9mbwU7e7ZaCQM0c3/7F2S2Z26Zl16k+8WPr6+C\\nyJd3d2s2QkrmqVKJzDqPYidU0EmaNOrqytvUTUDK9KJgKsJuNC9ZbODqTCMA03nt\\nr+hVcfdtd9F5fxyBJSrzpAhUQKadHs8jtAa1ENAhPmwKzvcJ51Gp4R3ZAoGBAOD6\\nzieT3bqO4tAaXB46LYdjp54xAXww6dcSEzw/sSt1FHveqXsaWEE2gbO4jphNqqMt\\ncEY162ObiLOI8tqluoFdJ6JrfLUlTvV7Uz4nfjYLFDBlEpMj0b8AHYDOykHhV+MB\\nP1lgkzVIUftwNN6NyuR9aSjxOrJEvC1M8NrteXPZAoGAIQf/5nSh/e51ov8LAtSq\\nJqPeMsq+TFdmg0eP7Stf3dCbVa5WZRW5v5h+Q19xRR8Q52udjrXXtUoQUuO83dkE\\n0wx+rCQ1+cgvUtyA4nX741/8m/5Hh/E4tXo1h8o0NFtcV//xXGi4D7AJeenOnMxc\\nWHf4zbGPqj29efEA9YEBQkkCgYABhG+DgNHMAk6xTJw2b/oCob9tp7L03XeWRb7v\\ndxaAzodW1oeaFvFlbzKsvZ/okw2FkDbjolV2FIR1gYTxyJBbcv9jbwomRpwjt7M2\\nBhopzyVRtjzL1UAC48NPLRXcH+Lx2v5MYgRcJaK36WfR4G7v35CoAAh/T0tdmtk9\\nAMEC8QKBgQCA5D+aNGi6yBJ6ddbacTZqrSbugpDOGwX/yTlQ+PqbKbW/BTILaCCV\\nMg4ZWRSmP3Uv8WHacK5fkEvLPMh57S3BG9PUqPXUFTpSgSVK2lH8kQLu2spYmsF1\\n2mEFYcC5VxTkBBA/Aj/2yDbur/3LXpZMhAAnPHwbAZwNuBmPz8tsHg==\\n-----END RSA PRIVATE KEY-----\\n&quot;,            &quot;private_key_pem_pkcs8&quot;: &quot;-----BEGIN PRIVATE KEY-----\\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCx0P2wn8vmbxxE\\nHX1XbQcD0EipnCdPeJ3kmgw1S5ZifiwlNYdr8keRDlqStYfnRoh3NCtCd4hlcnLH\\nU4yWoptXEBzb67/yp3abYauxYpl6pByk1Pu/vpCjANy92CBp3dN7OfddT94G6RWP\\n2L6Wc3Wh/JDNURAB29bxOlF1Qvlv9sizPVHMZbNStYPxdMUt/ZG6+/OGAFWK65Yj\\nSezdZAylroNy76dZ8YsKXbpaWmE2ahQC/zAJrLsqjKcbnyklb66pgDuVPHi00wuE\\nhbusziuhhtdy2QKLTc9xbfHbk7zIpLNgiLnEfsJDuCDBfNzHivTo1eRoT38se4FI\\nUlwgy8fxAgMBAAECggEBAJXi7+WRXWPZpv73yK8INVCOoqFuAmjn6FhJTh8inxpY\\n9sdKruNcL91jNw/Ru0RFXUT2Eb0OW0gASCYjFC/p0315FIqA16Uoaj8h/oMg9PS/\\nH3IGIkuHzA3K7UeNxgzXMqv9ubjLWQGEOmutrUHPA4pPBpQ7T33xnOZsXTu1/+LS\\nwDmwT6jvpbxl9iv9oVdqpf2uHwVV0TjD3PQNHr2tnsYn2chaPb0/QgnFuIjWNgR2\\nNoVwDyNYBaQZ5p2NrcBaH+BL1+rX2Ro7dtEAqk4uNT/Dm636otdPM0QCrYyRXnsz\\nWPnYlb8WWgg2/+3HhWxVK16vbtlFQxMZ/Y6Di0yUxMECgYEAylVxf7ayaq3xP2Zv\\nBTt7tloJAzRzf/sXZLZnbpmXXqT7xY+vr4LIl3d3azZCSuapUonMOo9iJ1TQSZo0\\n6urK29RNQMr0omAqwm40L1ls4OpMIwDTee2v6FVx92130Xl/HIElKvOkCFRApp0e\\nzyO0BrUQ0CE+bArO9wnnUanhHdkCgYEA4PrOJ5Pduo7i0BpcHjoth2OnnjEBfDDp\\n1xITPD+xK3UUe96pexpYQTaBs7iOmE2qoy1wRjXrY5uIs4jy2qW6gV0nomt8tSVO\\n9XtTPid+NgsUMGUSkyPRvwAdgM7KQeFX4wE/WWCTNUhR+3A03o3K5H1pKPE6skS8\\nLUzw2u15c9kCgYAhB//mdKH97nWi/wsC1Komo94yyr5MV2aDR4/tK1/d0JtVrlZl\\nFbm/mH5DX3FFHxDna52Otde1ShBS47zd2QTTDH6sJDX5yC9S3IDidfvjX/yb/keH\\n8Ti1ejWHyjQ0W1xX//FcaLgPsAl56c6czFxYd/jNsY+qPb158QD1gQFCSQKBgAGE\\nb4OA0cwCTrFMnDZv+gKhv22nsvTdd5ZFvu93FoDOh1bWh5oW8WVvMqy9n+iTDYWQ\\nNuOiVXYUhHWBhPHIkFty/2NvCiZGnCO3szYGGinPJVG2PMvVQALjw08tFdwf4vHa\\n/kxiBFwlorfpZ9Hgbu/fkKgACH9PS12a2T0AwQLxAoGBAIDkP5o0aLrIEnp11tpx\\nNmqtJu6CkM4bBf/JOVD4+psptb8FMgtoIJUyDhlZFKY/dS/xYdpwrl+QS8s8yHnt\\nLcEb09So9dQVOlKBJUraUfyRAu7ayliawXXaYQVhwLlXFOQEED8CP/bINu6v/cte\\nlkyEACc8fBsBnA24GY/Py2we\\n-----END PRIVATE KEY-----\\n&quot;,            &quot;public_key_fingerprint_md5&quot;: &quot;a9:cc:2d:0f:66:b9:a9:89:94:f1:da:8f:93:df:63:d5&quot;,            &quot;public_key_fingerprint_sha256&quot;: &quot;SHA256:ias4wauIC4J/zd/cVoXT6UUSUZLQXaxdpJfkGAfRDz0&quot;,            &quot;public_key_openssh&quot;: &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCx0P2wn8vmbxxEHX1XbQcD0EipnCdPeJ3kmgw1S5ZifiwlNYdr8keRDlqStYfnRoh3NCtCd4hlcnLHU4yWoptXEBzb67/yp3abYauxYpl6pByk1Pu/vpCjANy92CBp3dN7OfddT94G6RWP2L6Wc3Wh/JDNURAB29bxOlF1Qvlv9sizPVHMZbNStYPxdMUt/ZG6+/OGAFWK65YjSezdZAylroNy76dZ8YsKXbpaWmE2ahQC/zAJrLsqjKcbnyklb66pgDuVPHi00wuEhbusziuhhtdy2QKLTc9xbfHbk7zIpLNgiLnEfsJDuCDBfNzHivTo1eRoT38se4FIUlwgy8fx\\n&quot;,            &quot;public_key_pem&quot;: &quot;-----BEGIN PUBLIC KEY-----\\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsdD9sJ/L5m8cRB19V20H\\nA9BIqZwnT3id5JoMNUuWYn4sJTWHa/JHkQ5akrWH50aIdzQrQneIZXJyx1OMlqKb\\nVxAc2+u/8qd2m2GrsWKZeqQcpNT7v76QowDcvdggad3Tezn3XU/eBukVj9i+lnN1\\nofyQzVEQAdvW8TpRdUL5b/bIsz1RzGWzUrWD8XTFLf2RuvvzhgBViuuWI0ns3WQM\\npa6Dcu+nWfGLCl26WlphNmoUAv8wCay7KoynG58pJW+uqYA7lTx4tNMLhIW7rM4r\\noYbXctkCi03PcW3x25O8yKSzYIi5xH7CQ7ggwXzcx4r06NXkaE9/LHuBSFJcIMvH\\n8QIDAQAB\\n-----END PUBLIC KEY-----\\n&quot;,            &quot;rsa_bits&quot;: 2048          &#125;,          &quot;sensitive_attributes&quot;: []        &#125;      ]    &#125;  ],  &quot;check_results&quot;: null&#125;\n可以看到不应该被第三方知晓的 private_key_openssh、private_key_pem 和 private_key_pem_pkcs8 是以明文形式被写在 tfstate 文件里的。这是 Terraform 从设计之初就确定的，并且在可见的未来不会有改善。不论你是在代码中明文硬编码，还是使用参数(variable，我们之后的章节会介绍)，亦或是妙想天开地使用函数在运行时从外界读取，都无法改变这个结果。\n解决之道有两种，一种是使用 Vault 或是 AWS Secret Manager 这样的动态机密管理工具生成临时有效的动态机密(比如有效期只有 5 分钟，即使被他人读取到，机密也早已失效)；另一种就是我们下面将要介绍的 —— Terraform Backend。\n1.3.2.1.3. 生产环境的 tfstate 管理方案—— Backend\n到目前为止我们的 tfstate 文件是保存在当前工作目录下的本地文件，假设我们的计算机损坏了，导致文件丢失，那么 tfstate 文件所对应的资源都将无法管理，而产生资源泄漏。\n另外如果我们是一个团队在使用 Terraform 管理一组资源，团队成员之间要如何共享这个状态文件？能不能把 tfstate 文件签入源代码管理工具进行保存？\n把 tfstate 文件签入管代码管理工具是非常错误的，这就好比把数据库签入了源代码管理工具，如果两个人同时签出了同一份 tfstate，并且对代码做了不同的修改，又同时 apply 了，这时想要把 tfstate 签入源码管理系统可能会遭遇到无法解决的冲突。况且如果代码仓库是公开的，那么保存在 State 中的明文机密就会泄露。\n为了解决状态文件的存储和共享问题，Terraform 引入了远程状态存储机制，也就是 Backend。Backend 是一种抽象的远程存储接口，如同 Provider 一样，Backend 也支持多种不同的远程存储服务：\n\nlocal\nremote\nazurerm\nconsul\ncos\ngcs\nhttp\nkubernetes\noss\npg\ns3\n\n注意：在 Terraform 1.1.0 之前的版本中，Backend 分为标准和增强两种。增强是一种特殊的 remote Backend，它既可以存储状态，也可以执行 Terraform 操作。但是这种分类已被移除。请参考使用 Terraform Cloud 了解关于存储状态、执行远程操作以及直接从 Terraform 调用 Terraform Cloud 的详细信息。\n状态锁是指，当针对一个 tfstate 进行变更操作时，可以针对该状态文件添加一把全局锁，确保同一时间只能有一个变更被执行。不同的 Backend 对状态锁的支持不尽相同，实现状态锁的机制也不尽相同，例如 consul Backend就通过一个 .lock 节点来充当锁，一个 .lockinfo 节点来描述锁对应的会话信息，tfstate 文件被保存在 Backend 定义的路径节点内；s3 Backend 则需要用户传入一个 Dynamodb 表来存放锁信息，而 tfstate 文件被存储在 S3 存储桶里，等等等等。读者可以根据实际情况，挑选自己合适的 Backend。接下来我将以 consul 为范例为读者演示 Backend 机制。\n1.3.2.1.4. Consul简介以及安装\nConsul 是 HashiCorp 推出的一个开源工具，主要用来解决服务发现、配置中心以及 Service Mesh 等问题；Consul 本身也提供了类似 ZooKeeper、Etcd 这样的分布式键值存储服务，具有基于 Gossip 协议的最终一致性，所以可以被用来充当 Terraform Backend 存储。\n安装 Consul 十分简单，如果你是 Ubuntu 用户：\n123wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpgecho &quot;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main&quot; | sudo tee /etc/apt/sources.list.d/hashicorp.listsudo apt update &amp;&amp; sudo apt install consul\n对于CentOS用户：\n123sudo yum install -y yum-utilssudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.reposudo yum -y install consul\n对于Macos用户：\n12brew tap hashicorp/tapbrew install hashicorp/tap/consul\n对于 Windows 用户，如果按照前文安装 Terraform 教程已经配置了 Chocolatey 的话：\n1choco install consul\n安装完成后的验证：\n1234567891011121314151617181920212223242526272829303132333435363738$ consulUsage: consul [--version] [--help] &lt;command&gt; [&lt;args&gt;]Available commands are:    acl             Interact with Consul&#x27;s ACLs    agent           Runs a Consul agent    catalog         Interact with the catalog    config          Interact with Consul&#x27;s Centralized Configurations    connect         Interact with Consul Connect    debug           Records a debugging archive for operators    event           Fire a new event    exec            Executes a command on Consul nodes    force-leave     Forces a member of the cluster to enter the &quot;left&quot; state    info            Provides debugging information for operators.    intention       Interact with Connect service intentions    join            Tell Consul agent to join cluster    keygen          Generates a new encryption key    keyring         Manages gossip layer encryption keys    kv              Interact with the key-value store    leave           Gracefully leaves the Consul cluster and shuts down    lock            Execute a command holding a lock    login           Login to Consul using an auth method    logout          Destroy a Consul token created with login    maint           Controls node or service maintenance mode    members         Lists the members of a Consul cluster    monitor         Stream logs from a Consul agent    operator        Provides cluster-level tools for Consul operators    peering         Create and manage peering connections between Consul clusters    reload          Triggers the agent to reload configuration files    resource        Interact with Consul&#x27;s resources    rtt             Estimates network round trip time between nodes    services        Interact with services    snapshot        Saves, restores and inspects snapshots of Consul server state    tls             Builtin helpers for creating CAs and certificates    troubleshoot    CLI tools for troubleshooting Consul service mesh    validate        Validate config files/directories    version         Prints the Consul version    watch           Watch for changes in Consul\n安装完 Consul 后，我们可以启动一个测试版 Consul 服务：\n1$ consul agent -dev\nConsul 会在本机 8500 端口开放 Http 终结点，我们可以通过浏览器访问 http://localhost:8500 ：\n\n图 1.3.2/1 - Consul的GUI界面\n1.3.2.1.5. 使用 Backend\n我们还是利用 LocalStack 来执行一段简单的 Terraform 代码：\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475terraform &#123;  required_providers &#123;    aws = &#123;      source = &quot;hashicorp/aws&quot;      version = &quot;~&gt;5.0&quot;    &#125;  &#125;  backend &quot;consul&quot; &#123;    address = &quot;localhost:8500&quot;    scheme  = &quot;http&quot;    path    = &quot;localstack-aws&quot;  &#125;&#125;provider &quot;aws&quot; &#123;  access_key                  = &quot;test&quot;  secret_key                  = &quot;test&quot;  region                      = &quot;us-east-1&quot;  s3_use_path_style           = false  skip_credentials_validation = true  skip_metadata_api_check     = true  skip_requesting_account_id  = true  endpoints &#123;    apigateway     = &quot;http://localhost:4566&quot;    apigatewayv2   = &quot;http://localhost:4566&quot;    cloudformation = &quot;http://localhost:4566&quot;    cloudwatch     = &quot;http://localhost:4566&quot;    docdb          = &quot;http://localhost:4566&quot;    dynamodb       = &quot;http://localhost:4566&quot;    ec2            = &quot;http://localhost:4566&quot;    es             = &quot;http://localhost:4566&quot;    elasticache    = &quot;http://localhost:4566&quot;    firehose       = &quot;http://localhost:4566&quot;    iam            = &quot;http://localhost:4566&quot;    kinesis        = &quot;http://localhost:4566&quot;    lambda         = &quot;http://localhost:4566&quot;    rds            = &quot;http://localhost:4566&quot;    redshift       = &quot;http://localhost:4566&quot;    route53        = &quot;http://localhost:4566&quot;    s3             = &quot;http://s3.localhost.localstack.cloud:4566&quot;    secretsmanager = &quot;http://localhost:4566&quot;    ses            = &quot;http://localhost:4566&quot;    sns            = &quot;http://localhost:4566&quot;    sqs            = &quot;http://localhost:4566&quot;    ssm            = &quot;http://localhost:4566&quot;    stepfunctions  = &quot;http://localhost:4566&quot;    sts            = &quot;http://localhost:4566&quot;  &#125;&#125;data &quot;aws_ami&quot; &quot;ubuntu&quot; &#123;  most_recent = true  filter &#123;    name   = &quot;name&quot;    values = [&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;]  &#125;  filter &#123;    name   = &quot;virtualization-type&quot;    values = [&quot;hvm&quot;]  &#125;  owners = [&quot;099720109477&quot;] # Canonical&#125;resource &quot;aws_instance&quot; &quot;web&quot; &#123;  ami           = data.aws_ami.ubuntu.id  instance_type = &quot;t3.micro&quot;  tags = &#123;    Name = &quot;HelloWorld&quot;  &#125;&#125;\n在 terraform 节中，我们添加了 backend 配置节，指定使用 localhost:8500 为地址(也就是我们刚才启动的测试版 Consul 服务)，指定使用 http 协议访问该地址，指定 tfstate 文件存放在 Consul 键值存储服务的 localstack-aws 路径下。\n当我们执行完 terraform apply 后，我们访问 http://localhost:8500/ui/dc1/kv ：\n\n图 1.3.2/2 - Consul 中可以看到名为 `localstack-aws` 的键\n可以看到 localstack-aws，点击进入：\n\n图 1.3.2/3 - 键的内容\n可以看到，原本保存在工作目录下的 tfstate 文件的内容，被保存在了 Consul 的名为 localstack-aws 的键下。\n让我们执行 terraform destroy 后，重新访问 http://localhost:8500/ui/dc1/kv ：\n\n图 1.3.2/4 - 键依然存在\n可以看到，localstack-aws 这个键仍然存在。让我们点击进去：\n\n图 1.3.2/5 - 内容已被清空\n可以看到，它的内容为空，代表基础设施已经被成功销毁。\n1.3.2.1.6. 观察锁文件\n那么在这个过程里，锁究竟在哪里？我们如何能够体验到锁的存在？让我们对代码进行一点修改：\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778terraform &#123;  required_providers &#123;    aws = &#123;      source = &quot;hashicorp/aws&quot;      version = &quot;~&gt;5.0&quot;    &#125;  &#125;  backend &quot;consul&quot; &#123;    address = &quot;localhost:8500&quot;    scheme  = &quot;http&quot;    path    = &quot;localstack-aws&quot;  &#125;&#125;provider &quot;aws&quot; &#123;  access_key                  = &quot;test&quot;  secret_key                  = &quot;test&quot;  region                      = &quot;us-east-1&quot;  s3_use_path_style           = false  skip_credentials_validation = true  skip_metadata_api_check     = true  skip_requesting_account_id  = true  endpoints &#123;    apigateway     = &quot;http://localhost:4566&quot;    apigatewayv2   = &quot;http://localhost:4566&quot;    cloudformation = &quot;http://localhost:4566&quot;    cloudwatch     = &quot;http://localhost:4566&quot;    docdb          = &quot;http://localhost:4566&quot;    dynamodb       = &quot;http://localhost:4566&quot;    ec2            = &quot;http://localhost:4566&quot;    es             = &quot;http://localhost:4566&quot;    elasticache    = &quot;http://localhost:4566&quot;    firehose       = &quot;http://localhost:4566&quot;    iam            = &quot;http://localhost:4566&quot;    kinesis        = &quot;http://localhost:4566&quot;    lambda         = &quot;http://localhost:4566&quot;    rds            = &quot;http://localhost:4566&quot;    redshift       = &quot;http://localhost:4566&quot;    route53        = &quot;http://localhost:4566&quot;    s3             = &quot;http://s3.localhost.localstack.cloud:4566&quot;    secretsmanager = &quot;http://localhost:4566&quot;    ses            = &quot;http://localhost:4566&quot;    sns            = &quot;http://localhost:4566&quot;    sqs            = &quot;http://localhost:4566&quot;    ssm            = &quot;http://localhost:4566&quot;    stepfunctions  = &quot;http://localhost:4566&quot;    sts            = &quot;http://localhost:4566&quot;  &#125;&#125;data &quot;aws_ami&quot; &quot;ubuntu&quot; &#123;  most_recent = true  filter &#123;    name   = &quot;name&quot;    values = [&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;]  &#125;  filter &#123;    name   = &quot;virtualization-type&quot;    values = [&quot;hvm&quot;]  &#125;  owners = [&quot;099720109477&quot;] # Canonical&#125;resource &quot;aws_instance&quot; &quot;web&quot; &#123;  ami           = data.aws_ami.ubuntu.id  instance_type = &quot;t3.micro&quot;  tags = &#123;    Name = &quot;HelloWorld&quot;  &#125;  provisioner &quot;local-exec&quot; &#123;    command = &quot;sleep 1000&quot;  &#125;&#125;\n这次的变化是我们在 aws_instance 的定义上添加了一个 local-exec 类型的 Provisioner。Provisioner 我们在后续的章节中会专门叙述，在这里读者只需要理解，Terraform 进程在成功创建了该资源后，会在执行 Terraform 命令行的机器上执行一条命令：sleep 1000，这个时间足以将 Terraform 进程阻塞足够长的时间，以便让我们观察锁信息了。如果读者正在使用 Windows，可以把 provisioner 改成这样：\n1234provisioner &quot;local-exec&quot; &#123;  command = &quot;Start-Sleep -s 1000&quot;  interpreter = [&quot;PowerShell&quot;, &quot;-Command&quot;]&#125;\n让我们执行terraform apply，这一次 apply 将会被 sleep 阻塞，而不会成功完成：\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667data.aws_ami.ubuntu: Reading...data.aws_ami.ubuntu: Read complete after 1s [id=ami-1e749f67]Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following  symbols:  + createTerraform will perform the following actions:  # aws_instance.web will be created  + resource &quot;aws_instance&quot; &quot;web&quot; &#123;      + ami                                  = &quot;ami-1e749f67&quot;      + arn                                  = (known after apply)      + associate_public_ip_address          = (known after apply)      + availability_zone                    = (known after apply)      + cpu_core_count                       = (known after apply)      + cpu_threads_per_core                 = (known after apply)      + disable_api_stop                     = (known after apply)      + disable_api_termination              = (known after apply)      + ebs_optimized                        = (known after apply)      + get_password_data                    = false      + host_id                              = (known after apply)      + host_resource_group_arn              = (known after apply)      + iam_instance_profile                 = (known after apply)      + id                                   = (known after apply)      + instance_initiated_shutdown_behavior = (known after apply)      + instance_lifecycle                   = (known after apply)      + instance_state                       = (known after apply)      + instance_type                        = &quot;t3.micro&quot;      + ipv6_address_count                   = (known after apply)      + ipv6_addresses                       = (known after apply)      + key_name                             = (known after apply)      + monitoring                           = (known after apply)      + outpost_arn                          = (known after apply)      + password_data                        = (known after apply)      + placement_group                      = (known after apply)      + placement_partition_number           = (known after apply)      + primary_network_interface_id         = (known after apply)      + private_dns                          = (known after apply)      + private_ip                           = (known after apply)      + public_dns                           = (known after apply)      + public_ip                            = (known after apply)      + secondary_private_ips                = (known after apply)      + security_groups                      = (known after apply)      + source_dest_check                    = true      + spot_instance_request_id             = (known after apply)      + subnet_id                            = (known after apply)      + tags                                 = &#123;          + &quot;Name&quot; = &quot;HelloWorld&quot;        &#125;      + tags_all                             = &#123;          + &quot;Name&quot; = &quot;HelloWorld&quot;        &#125;      + tenancy                              = (known after apply)      + user_data                            = (known after apply)      + user_data_base64                     = (known after apply)      + user_data_replace_on_change          = false      + vpc_security_group_ids               = (known after apply)    &#125;Plan: 1 to add, 0 to change, 0 to destroy.aws_instance.web: Creating...aws_instance.web: Still creating... [10s elapsed]aws_instance.web: Provisioning with &#x27;local-exec&#x27;...aws_instance.web (local-exec): Executing: [&quot;PowerShell&quot; &quot;-Command&quot; &quot;Start-Sleep -s 1000&quot;]aws_instance.web: Still creating... [20s elapsed]...\n让我们重新访问 http://localhost:8500/ui/dc1/kv ：\n\n图 1.3.2/6 - 多了一个同名的文件夹\n这一次情况发生了变化，我们看到除了localstack-aws这个键之外，还多了一个同名的文件夹。让我们点击进入文件夹：\n\n图 1.3.2/7 - localstack-aws 文件夹内部\n在这里我们成功观测到了 .lock 和 .lockinfo 文件。让我们点击 .lock 看看：\n\n图 1.3.2/8 - `.lock` 内容\nConsul UI提醒我们，该键值对目前正被锁定，而它的内容是空的。让我们查看 .lockinfo 的内容：\n\n图 1.3.2/9 - `.lockinfo` 内容\n.lockinfo 里记录了锁 ID、我们执行的操作，以及其他的一些信息。\n让我们另起一个新的命令行窗口，在同一个工作目录下尝试另一次执行 terraform apply：\n1234567891011121314151617181920$ terraform applyAcquiring state lock. This may take a few moments...╷│ Error: Error acquiring the state lock│ │ Error message: Lock Info:│   ID:        11c859fd-d3e5-4eab-46d6-586b73133430│   Path:      localstack-aws│   Operation: OperationTypeApply│   Who:       ***│   Version:   1.7.3│   Created:   2024-02-25 02:00:21.3700184 +0000 UTC│   Info:      consul session: 11c859fd-d3e5-4eab-46d6-586b73133430│││ Terraform acquires a state lock to protect the state from being written│ by multiple users at the same time. Please resolve the issue above and try│ again. For most commands, you can disable locking with the &quot;-lock=false&quot;│ flag, but this is not recommended.╵\n可以看到，同时另一个人试图对同一个 tfstate 执行变更的尝试失败了，因为它无法顺利获取到锁。\n让我们用 ctrl-c 终止原先被阻塞的 terraform apply 的执行，然后用 terraform force-unlock 11c859fd-d3e5-4eab-46d6-586b73133430 解锁：\n123456789101112$ terraform force-unlock 11c859fd-d3e5-4eab-46d6-586b73133430Do you really want to force-unlock?  Terraform will remove the lock on the remote state.  This will allow local Terraform commands to modify this state, even though it  may still be in use. Only &#x27;yes&#x27; will be accepted to confirm.  Enter a value: yesTerraform state has been successfully unlocked!The state has been unlocked, and Terraform commands should now be able toobtain a new lock on the remote state.\n然后重新访问 http://localhost:8500/ui/dc1/kv ：\n\n图 1.3.2/10 - 重新访问Consul\n可以看到，包含锁的文件夹消失了。\n1.3.2.1.7. Backend 配置的动态赋值\n有些读者会注意到，到目前为止我所写的代码里的配置项基本都是硬编码的，Terraform 是否支持运行时用变量动态赋值？答案是支持的，Terraform 可以通过 variable 变量来传值给 provider、data 和 resource。\n但有一些例外，其中就有 backend 配置。backend 配置只允许硬编码，或者不传值。\n这个问题是因为 Terraform 运行时本身设计的运行顺序导致的，一直到 2019 年 05 月官方才给出了解决方案，那就是“部分配置“(partial configuration)。\n简单来说就是我们可以在 Terraform 代码的 backend 声明中不给出具体的配置：\n12345678910terraform &#123;  required_providers &#123;    aws = &#123;      source = &quot;hashicorp/aws&quot;      version = &quot;~&gt;5.0&quot;    &#125;  &#125;  backend &quot;consul&quot; &#123;  &#125;&#125;\n而在另一个独立的文件中给出相关配置，例如我们在工作目录下创建一个名为 backend.hcl 的文件：\n123address = &quot;localhost:8500&quot;scheme  = &quot;http&quot;path    = &quot;localstack-aws&quot;\n本质上我们就是把原本属于 backend consul 块的属性赋值代码搬迁到一个独立的 hcl 文件内，然后我们执行 terraform init 时附加 backend-config 参数：\n1$ terraform init -backend-config=backend.hcl\n这样也可以初始化成功。通过这种打补丁的方式，我们可以复用他人预先写好的 Terraform 代码，在执行时把属于我们自己的 Backend 配置信息以独立的 backend-config 文件的形式传入来进行初始化。\n1.3.2.1.8. Backend 的权限控制以及版本控制\nBackend 本身并没有设计任何的权限以及版本控制，这方面完全依赖于具体的 Backend 实现。以 AWS S3 为例，我们可以针对不同的 Bucket 设置不同的 IAM，用以防止开发测试人员直接操作生产环境，或是给予部分人员对状态信息的只读权限；另外我们也可以开启 S3 的版本控制功能，以防我们错误修改了状态文件(Terraform 命令行有修改状态的相关指令)。\n1.3.2.1.9. 状态的隔离存储\n我们讲完 Backend，现在要讨论另一个问题。假设我们的 Terraform 代码可以创建一个通用的基础设施，比如说是云端的一个 EKS、AKS 集群，或者是一个基于 S3 的静态网站，那么我们可能要为很多团队创建并维护这些相似但要彼此隔离的 Stack，又或者我们要为部署的应用维护开发、测试、预发布、生产四套不同的部署。那么该如何做到不同的部署，彼此状态文件隔离存储和管理呢？\n一种简单的方法就是分成不同的文件夹存储。\n\n图 1.3.2/11 - 将代码复制到不同的文件夹中保存\n我们可以把不同产品不同部门使用的基础设施分成不同的文件夹，在文件夹内维护相同的代码文件，配置不同的 backend-config，把状态文件保存到不同的 Backend 上。这种方法可以给予最大程度的隔离，缺点是我们需要拷贝许多份相同的代码。\n第二种更加轻量级的方法就是 Workspace。注意，Terraform 开源版的 Workspace 与 Terraform Cloud 云服务的 Workspace 实际上是两个不同的概念，我们这里介绍的是开源版的 Workspace。\nWorkspace 允许我们在同一个文件夹内，使用同样的 Backend 配置，但可以维护任意多个彼此隔离的状态文件。还是我们刚才那个使用测试 Consul 服务作为 Backend 的例子：\n\n图 1.3.2/12 - 重新访问 Consul，目前有一个键\n当前我们有一个状态文件，名字是 localstack-aws。然后我们在工作目录下执行这样的命令：\n123456$ terraform workspace new feature1Created and switched to workspace &quot;feature1&quot;!You&#x27;re now on a new, empty workspace. Workspaces isolate their state,so if you run &quot;terraform plan&quot; Terraform will not see any existing statefor this configuration.\n通过调用 workspace 命令，我们成功创建了名为 feature1 的 Workspace。这时我们观察 .terraform 文件夹：\n12345678..├── environment├── providers│        └── registry.terraform.io│             └── hashicorp│                 └── aws│                     └── 5.38.0......\n我们会发现多了一个 environment 文件，它的内容是 feature1。这实际上就是 Terraform 用来保存当前上下文环境使用的是哪个 Workspace 的文件。\n\n图 1.3.2/13 - Consul 中多了一个 `localstack-aws-env:feature1`\n重新观察 Consul 存储会发现多了一个文件：localstack-aws-env:feature1。这就是 Terraform 为 feature1 这个 Workspace 创建的独立的状态文件。让我们执行一下 apply，然后再看这个文件的内容：\n\n图 1.3.2/14 - 此时 `localstack-aws-env:feature1` 的内容\n可以看到，状态被成功写入了 feature1 的状态文件。\n我们可以通过以下命令来查询当前 Backend 下所有的 Workspace：\n123$ terraform workspace list  default* feature1\n我们有 default 和 feature1 两个 Workspace，当前我们工作在 feature1 上。我们可以用以下命令切换回 default：\n12$ terraform workspace select defaultSwitched to workspace &quot;default&quot;.\n我们可以用以下命令确认我们成功切换回了 default：\n12$ terraform workspace showdefault\n我们可以用以下命令删除 feature1：\n12345678910111213$ terraform workspace delete feature1╷│ Error: Workspace is not empty││ Workspace &quot;feature1&quot; is currently tracking the following resource instances:│   - aws_instance.web││ Deleting this workspace would cause Terraform to lose track of any associated remote objects, which would then require you to    │ delete them manually outside of Terraform. You should destroy these objects with Terraform before deleting the workspace.        ││ If you want to delete this workspace anyway, and have Terraform forget about these managed objects, use the -force option to     │ disable this safety check.╵\nTerraform 发现 feature1 还有资源没有被销毁，所以它拒绝了我们的删除请求。因为我们目前是使用 LocalStack 模拟的例子，所以不会有资源泄漏的问题，我们可以用以下命令强制删除 feature1：\n123456$ terraform workspace delete -force feature1Deleted workspace &quot;feature1&quot;!WARNING: &quot;feature1&quot; was non-empty.The resources managed by the deleted workspace may still exist,but are no longer manageable by Terraform since the state hasbeen deleted.\n再观察 Consul 存储，就会发现 feature1 的状态文件被删除了：\n\n图 1.3.2/15 - `localstack-aws-env:feature1` 被删除了\n目前支持多工作区的 Backend 有：\n\nAzureRM\nConsulf\nCOS\nGCS\nKubernetes\nLocal\nOSS\nPostgres\nRemote\nS3\n\n1.3.2.1.10. 该使用哪种隔离\n相比起多文件夹隔离的方式来说，基于 Workspace 的隔离更加简单，只需要保存一份代码，在代码中不需要为 Workspace 编写额外代码，用命令行就可以在不同工作区之间来回切换。\n但是 Workspace 的缺点也同样明显，由于所有工作区的 Backend 配置是一样的，所以有权读写某一个 Workspace 的人可以读取同一个 Backend 路径下所有其他 Workspace；另外 Workspace 是隐式配置的(调用命令行)，所以有时人们会忘记自己工作在哪个 Workspace 下。\nTerraform 官方为 Workspace 设计的场景是：有时开发人员想要对既有的基础设施做一些变更，并进行一些测试，但又不想直接冒险修改既有的环境。这时他可以利用 Workspace 复制出一个与既有环境完全一致的平行环境，在这个平行环境里做一些变更，并进行测试和实验工作。\nWorkspace 对应的源代码管理模型里的主干——分支模型，如果团队希望维护的是不同产品之间不同的基础设施，或是开发、测试、预发布、生产环境，那么最好还是使用不同的文件夹以及不同的 backend-config 进行管理。\n","dateCreated":"2023-01-18T17:43:45+08:00","dateModified":"2025-06-17T18:22:57+08:00","datePublished":"2023-01-18T17:43:45+08:00","description":"","headline":"Terraform-基础概念-状态管理","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"},"publisher":{"@type":"Organization","name":"Kein Chan","sameAs":["https://github.com/chankein/","https://www.linkedin.com/profile/","mailto:kein.chan85@gmail.com"],"image":"profile.jpg","logo":{"@type":"ImageObject","url":"profile.jpg"}},"url":"https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/","keywords":"Terraform"}</script>
    <meta name="description" content="1.3.2.1. Terraform 基础概念——状态管理   1.3.2.1.1. 初探状态文件   1.3.2.1.2. 极其重要的安全警示—— tfstate 是明文的   1.3.2.1.3. 生产环境的 tfstate 管理方案—— Backend   1.3.2.1.4. Consul简介以及安装   1.3.2.1.5. 使用 Backend   1.3.2.1.6. 观察锁文件">
<meta property="og:type" content="blog">
<meta property="og:title" content="Terraform-基础概念-状态管理">
<meta property="og:url" content="https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/index.html">
<meta property="og:site_name" content="Kein&#39;s blog">
<meta property="og:description" content="1.3.2.1. Terraform 基础概念——状态管理   1.3.2.1.1. 初探状态文件   1.3.2.1.2. 极其重要的安全警示—— tfstate 是明文的   1.3.2.1.3. 生产环境的 tfstate 管理方案—— Backend   1.3.2.1.4. Consul简介以及安装   1.3.2.1.5. 使用 Backend   1.3.2.1.6. 观察锁文件">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220224455.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220230042.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220230136.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220230312.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220230350.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225100309.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225100354.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225180803.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225180852.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225101100.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/2020-11-17/1605571444613-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225174932.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225175538.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225175806.png">
<meta property="og:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225180126.png">
<meta property="article:published_time" content="2023-01-18T09:43:45.000Z">
<meta property="article:modified_time" content="2025-06-17T10:22:57.374Z">
<meta property="article:author" content="Kein Chan">
<meta property="article:tag" content="Terraform">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220224455.png">
    
    
        
    
    
        <meta property="og:image" content="https://chankein.github.io../../../../../assets/images/profile.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="../../../../../assets/css/style-l9zwheso7r7pnk98nvirovsz9dl7fhkrc9mlb5vmuxw7tk5movrk0eevsrpr.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="../../../../../index.html"
            aria-label=""
        >
            Kein&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打開鏈接: ../../../../../#about"
            >
        
        
            <img class="header-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="../../../../../#about"
                    aria-label="閱讀有關作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
                </a>
                <h4 class="sidebar-profile-name">Kein Chan</h4>
                
                    <h5 class="sidebar-profile-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../index.html"
                            
                            rel="noopener"
                            title="首頁"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首頁</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-categories"
                            
                            rel="noopener"
                            title="分類"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分類</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-tags"
                            
                            rel="noopener"
                            title="標籤"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">標籤</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-archives"
                            
                            rel="noopener"
                            title="所有文章"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">所有文章</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜尋"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜尋</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="關於"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">關於</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/chankein/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/profile/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../mailto:kein.chan85@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Email"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Email</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../atom.xml"
                            
                            rel="noopener"
                            title="Atom"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Atom</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Terraform-基础概念-状态管理
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2023-01-18T17:43:45+08:00">
	
		    2023 年 1 月 18 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="../../../../../categories/devops/">devops</a>, <a class="category-link" href="../../../../../categories/devops/Terraform/">Terraform</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <ul>
<li>
<p><a href="#terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><strong>1.3.2.1.</strong> Terraform 基础概念——状态管理</a></p>
</li>
<li>
<p><a href="#%E5%88%9D%E6%8E%A2%E7%8A%B6%E6%80%81%E6%96%87%E4%BB%B6"><strong>1.3.2.1.1.</strong> 初探状态文件</a></p>
</li>
<li>
<p><a href="#%E6%9E%81%E5%85%B6%E9%87%8D%E8%A6%81%E7%9A%84%E5%AE%89%E5%85%A8%E8%AD%A6%E7%A4%BA%E2%80%94%E2%80%94-tfstate-%E6%98%AF%E6%98%8E%E6%96%87%E7%9A%84"><strong>1.3.2.1.2.</strong> 极其重要的安全警示—— tfstate 是明文的</a></p>
</li>
<li>
<p><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84-tfstate-%E7%AE%A1%E7%90%86%E6%96%B9%E6%A1%88%E2%80%94%E2%80%94-backend"><strong>1.3.2.1.3.</strong> 生产环境的 tfstate 管理方案—— Backend</a></p>
</li>
<li>
<p><a href="#consul%E7%AE%80%E4%BB%8B%E4%BB%A5%E5%8F%8A%E5%AE%89%E8%A3%85"><strong>1.3.2.1.4.</strong> Consul简介以及安装</a></p>
</li>
<li>
<p><a href="#%E4%BD%BF%E7%94%A8-backend"><strong>1.3.2.1.5.</strong> 使用 Backend</a></p>
</li>
<li>
<p><a href="#%E8%A7%82%E5%AF%9F%E9%94%81%E6%96%87%E4%BB%B6"><strong>1.3.2.1.6.</strong> 观察锁文件</a></p>
</li>
<li>
<p><a href="#backend-%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8A%A8%E6%80%81%E8%B5%8B%E5%80%BC"><strong>1.3.2.1.7.</strong> Backend 配置的动态赋值</a></p>
</li>
<li>
<p><a href="#backend-%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E4%BB%A5%E5%8F%8A%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><strong>1.3.2.1.8.</strong> Backend 的权限控制以及版本控制</a></p>
</li>
<li>
<p><a href="#%E7%8A%B6%E6%80%81%E7%9A%84%E9%9A%94%E7%A6%BB%E5%AD%98%E5%82%A8"><strong>1.3.2.1.9.</strong> 状态的隔离存储</a></p>
</li>
<li>
<p><a href="#%E8%AF%A5%E4%BD%BF%E7%94%A8%E5%93%AA%E7%A7%8D%E9%9A%94%E7%A6%BB"><strong>1.3.2.1.10.</strong> 该使用哪种隔离</a></p>
</li>
</ul>
<p><a href="#terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"></a></p>
<h2 id="1-3-2-1-Terraform-基础概念——状态管理"><a href="#terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"></a>1.3.2.1. Terraform 基础概念——状态管理</h2>
<p>我们在第一章的末尾提过，当我们成功地执行了一次 <code>terraform apply</code>，创建了期望的基础设施以后，我们如果再次执行 <code>terraform apply</code>，生成的新的执行计划将不会包含任何变更，Terraform 会记住当前基础设施的状态，并将之与代码所描述的期望状态进行比对。第二次 apply 时，因为当前状态已经与代码描述的状态一致了，所以会生成一个空的执行计划。</p>
<h2 id="1-3-2-1-1-初探状态文件"><a href="#%E5%88%9D%E6%8E%A2%E7%8A%B6%E6%80%81%E6%96%87%E4%BB%B6"></a>1.3.2.1.1. 初探状态文件</h2>
<p>在这里，Terraform 引入了一个独特的概念——状态管理，这是 Ansible 等配置管理工具或是自研工具调用 SDK 操作基础设施的方案所没有的。简单来说，Terraform 将每次执行基础设施变更操作时的状态信息保存在一个状态文件中，默认情况下会保存在当前工作目录下的 <code>terraform.tfstate</code> 文件里。例如我们之前在使用 LocalStack 模拟环境的代码中声明一个 <code>data</code> 和一个 <code>resource</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source = &quot;hashicorp/aws&quot;</span><br><span class="line">      version = &quot;~&gt;5.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key                  = &quot;test&quot;</span><br><span class="line">  secret_key                  = &quot;test&quot;</span><br><span class="line">  region                      = &quot;us-east-1&quot;</span><br><span class="line">  s3_use_path_style           = false</span><br><span class="line">  skip_credentials_validation = true</span><br><span class="line">  skip_metadata_api_check     = true</span><br><span class="line">  skip_requesting_account_id  = true</span><br><span class="line"></span><br><span class="line">  endpoints &#123;</span><br><span class="line">    apigateway     = &quot;http://localhost:4566&quot;</span><br><span class="line">    apigatewayv2   = &quot;http://localhost:4566&quot;</span><br><span class="line">    cloudformation = &quot;http://localhost:4566&quot;</span><br><span class="line">    cloudwatch     = &quot;http://localhost:4566&quot;</span><br><span class="line">    dynamodb       = &quot;http://localhost:4566&quot;</span><br><span class="line">    ec2            = &quot;http://localhost:4566&quot;</span><br><span class="line">    es             = &quot;http://localhost:4566&quot;</span><br><span class="line">    elasticache    = &quot;http://localhost:4566&quot;</span><br><span class="line">    firehose       = &quot;http://localhost:4566&quot;</span><br><span class="line">    iam            = &quot;http://localhost:4566&quot;</span><br><span class="line">    kinesis        = &quot;http://localhost:4566&quot;</span><br><span class="line">    lambda         = &quot;http://localhost:4566&quot;</span><br><span class="line">    rds            = &quot;http://localhost:4566&quot;</span><br><span class="line">    redshift       = &quot;http://localhost:4566&quot;</span><br><span class="line">    route53        = &quot;http://localhost:4566&quot;</span><br><span class="line">    s3             = &quot;http://s3.localhost.localstack.cloud:4566&quot;</span><br><span class="line">    secretsmanager = &quot;http://localhost:4566&quot;</span><br><span class="line">    ses            = &quot;http://localhost:4566&quot;</span><br><span class="line">    sns            = &quot;http://localhost:4566&quot;</span><br><span class="line">    sqs            = &quot;http://localhost:4566&quot;</span><br><span class="line">    ssm            = &quot;http://localhost:4566&quot;</span><br><span class="line">    stepfunctions  = &quot;http://localhost:4566&quot;</span><br><span class="line">    sts            = &quot;http://localhost:4566&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_ami&quot; &quot;ubuntu&quot; &#123;</span><br><span class="line">  most_recent = true</span><br><span class="line"></span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;name&quot;</span><br><span class="line">    values = [&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;virtualization-type&quot;</span><br><span class="line">    values = [&quot;hvm&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  owners = [&quot;099720109477&quot;] # Canonical</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  ami           = data.aws_ami.ubuntu.id</span><br><span class="line">  instance_type = &quot;t3.micro&quot;</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;HelloWorld&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>terraform apply</code> 后，我们可以看到 <code>terraform.tfstate</code> 的内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;terraform_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.7.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;serial&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lineage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;159018e2-63f4-2dfa-ce0d-873a37a1e0a7&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;data&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;aws_ami&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ubuntu&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;provider[\&quot;registry.terraform.io/hashicorp/aws\&quot;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;schema_version&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x86_64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:ec2:us-east-1::image/ami-1e749f67&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;block_device_mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;device_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/dev/sda1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ebs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;delete_on_termination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;encrypted&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;iops&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;snapshot_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;snap-15bd5527&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;throughput&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;volume_size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;volume_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;no_device&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;virtual_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;boot_mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;creation_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-02-20T13:52:42.000Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;deprecation_time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Canonical, Ubuntu, 14.04 LTS, amd64 trusty image build on 2017-07-27&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ena_support&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;executable_users&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="string">&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;virtualization-type&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="string">&quot;hvm&quot;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hypervisor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xen&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ami-1e749f67&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;image_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ami-1e749f67&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;image_location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amazon/getting-started&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;image_owner_alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amazon&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;image_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;machine&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;imds_support&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;include_deprecated&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;kernel_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;None&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;most_recent&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name_regex&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;owner_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;099720109477&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;owners&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;099720109477&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;platform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;platform_details&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;product_codes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ramdisk_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ari-1a2b3c4d&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;root_device_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/dev/sda1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;root_device_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ebs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;root_snapshot_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;snap-15bd5527&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sriov_net_support&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;available&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;state_reason&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNSET&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNSET&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;timeouts&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tpm_support&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;usage_operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;virtualization_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hvm&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sensitive_attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;managed&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;aws_instance&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;provider[\&quot;registry.terraform.io/hashicorp/aws\&quot;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;schema_version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;ami&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ami-1e749f67&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:ec2:us-east-1::instance/i-288a34165ed2ad2f7&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;associate_public_ip_address&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;availability_zone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;us-east-1a&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;capacity_reservation_specification&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cpu_core_count&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cpu_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cpu_threads_per_core&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;credit_specification&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;disable_api_stop&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;disable_api_termination&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ebs_block_device&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ebs_optimized&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;enclave_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ephemeral_block_device&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;get_password_data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hibernation&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;host_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;host_resource_group_arn&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;iam_instance_profile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;i-288a34165ed2ad2f7&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;instance_initiated_shutdown_behavior&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stop&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;instance_lifecycle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;instance_market_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;instance_state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;running&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;instance_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;t3.micro&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ipv6_address_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ipv6_addresses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;key_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;launch_template&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;maintenance_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;metadata_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;monitoring&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;network_interface&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;outpost_arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password_data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;placement_group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;placement_partition_number&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;primary_network_interface_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eni-68899bf6&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;private_dns&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ip-10-13-239-41.ec2.internal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;private_dns_name_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;private_ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.13.239.41&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;public_dns&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ec2-54-214-132-221.compute-1.amazonaws.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;public_ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;54.214.132.221&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;root_block_device&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;delete_on_termination&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;device_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/dev/sda1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;encrypted&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;iops&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;kms_key_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;throughput&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;volume_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vol-6dde834f&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;volume_size&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;volume_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gp2&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;secondary_private_ips&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;security_groups&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source_dest_check&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;spot_instance_request_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;subnet_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;subnet-dbb4c2f9&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tags_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tenancy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;timeouts&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;user_data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;user_data_base64&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;user_data_replace_on_change&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;volume_tags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;vpc_security_group_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sensitive_attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;private&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJlMmJmYjczMC1lY2FhLTExZTYtOGY4OC0zNDM2M2JjN2M0YzAiOnsiY3JlYXRlIjo2MDAwMDAwMDAwMDAsImRlbGV0ZSI6MTIwMDAwMDAwMDAwMCwidXBkYXRlIjo2MDAwMDAwMDAwMDB9LCJzY2hlbWFfdmVyc2lvbiI6IjEifQ==&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;data.aws_ami.ubuntu&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;check_results&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到，查询到的 <code>data</code> 以及创建的 <code>resource</code> 信息都被以 json 格式保存在 <code>tfstate</code> 文件里。</p>
<p>我们前面已经说过，由于 <code>tfstate</code> 文件的存在，我们在 <code>terraform apply</code> 之后立即再次 apply 是不会执行任何变更的，那么如果我们删除了这个 <code>tfstate</code> 文件，然后再执行 apply 会发生什么呢？Terraform 读取不到 <code>tfstate</code> 文件，会认为这是我们第一次创建这组资源，所以它会再一次创建代码中描述的所有资源。更加麻烦的是，由于我们前一次创建的资源所对应的状态信息被我们删除了，所以我们再也无法通过执行 <code>terraform destroy</code> 来销毁和回收这些资源，实际上产生了资源泄漏。所以妥善保存这个状态文件是非常重要的。</p>
<p>另外，如果我们对 Terraform 的代码进行了一些修改，导致生成的执行计划将会改变状态，那么在实际执行变更之前，Terraform 会复制一份当前的 <code>tfstate</code> 文件到同路径下的 <code>terraform.tfstate.backup</code> 中，以防止由于各种意外导致的 <code>tfstate</code> 损毁。</p>
<p>在 Terraform 发展的极早期，HashiCorp 曾经尝试过无状态文件的方案，也就是在执行 Terraform 变更计划时，给所有涉及到的资源都打上特定的 tag，在下次执行变更时，先通过 tag 读取相关资源来重建状态信息。但因为并不是所有资源都支持打 tag，也不是所有公有云都支持多 tag，所以 Terraform 最终决定用状态文件方案。</p>
<p>还有一点，HashiCorp 官方从未公开过 <code>tfstate</code> 的格式，也就是说，HashiCorp 保留随时修改 <code>tfstate</code> 格式的权力。所以不要试图手动或是用自研代码去修改 <code>tfstate</code>，Terraform 命令行工具提供了相关的指令(我们后续会介绍到)，请确保只通过命令行的指令操作状态文件。</p>
<h2 id="1-3-2-1-2-极其重要的安全警示——-tfstate-是明文的"><a href="#%E6%9E%81%E5%85%B6%E9%87%8D%E8%A6%81%E7%9A%84%E5%AE%89%E5%85%A8%E8%AD%A6%E7%A4%BA%E2%80%94%E2%80%94-tfstate-%E6%98%AF%E6%98%8E%E6%96%87%E7%9A%84"></a>1.3.2.1.2. 极其重要的安全警示—— tfstate 是明文的</h2>
<p>关于 Terraform 状态，还有极其重要的事，所有考虑在生产环境使用 Terraform 的人都必须格外小心并再三警惕：Terraform 的状态文件是明文的，这就意味着代码中所使用的一切机密信息都将以明文的形式保存在状态文件里。例如我们创建一个私钥文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;tls_private_key&quot; &quot;example&quot; &#123;</span><br><span class="line">  algorithm = &quot;RSA&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行了<code>terraform apply</code>后我们观察 <code>tfstate</code> 文件中相关段落：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;terraform_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.7.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;serial&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lineage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dec42d6b-d61f-30b3-0b83-d5d8881c29ea&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;managed&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls_private_key&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;provider[\&quot;registry.terraform.io/hashicorp/tls\&quot;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;schema_version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;algorithm&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RSA&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ecdsa_curve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;P224&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;d47d1465586d25322bb8ca16029fe4fb2ec001e0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;private_key_openssh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdz\nc2gtcnNhAAAAAwEAAQAAAQEAsdD9sJ/L5m8cRB19V20HA9BIqZwnT3id5JoMNUuW\nYn4sJTWHa/JHkQ5akrWH50aIdzQrQneIZXJyx1OMlqKbVxAc2+u/8qd2m2GrsWKZ\neqQcpNT7v76QowDcvdggad3Tezn3XU/eBukVj9i+lnN1ofyQzVEQAdvW8TpRdUL5\nb/bIsz1RzGWzUrWD8XTFLf2RuvvzhgBViuuWI0ns3WQMpa6Dcu+nWfGLCl26Wlph\nNmoUAv8wCay7KoynG58pJW+uqYA7lTx4tNMLhIW7rM4roYbXctkCi03PcW3x25O8\nyKSzYIi5xH7CQ7ggwXzcx4r06NXkaE9/LHuBSFJcIMvH8QAAA7jnMVXy5zFV8gAA\nAAdzc2gtcnNhAAABAQCx0P2wn8vmbxxEHX1XbQcD0EipnCdPeJ3kmgw1S5Zifiwl\nNYdr8keRDlqStYfnRoh3NCtCd4hlcnLHU4yWoptXEBzb67/yp3abYauxYpl6pByk\n1Pu/vpCjANy92CBp3dN7OfddT94G6RWP2L6Wc3Wh/JDNURAB29bxOlF1Qvlv9siz\nPVHMZbNStYPxdMUt/ZG6+/OGAFWK65YjSezdZAylroNy76dZ8YsKXbpaWmE2ahQC\n/zAJrLsqjKcbnyklb66pgDuVPHi00wuEhbusziuhhtdy2QKLTc9xbfHbk7zIpLNg\niLnEfsJDuCDBfNzHivTo1eRoT38se4FIUlwgy8fxAAAAAwEAAQAAAQEAleLv5ZFd\nY9mm/vfIrwg1UI6ioW4CaOfoWElOHyKfGlj2x0qu41wv3WM3D9G7REVdRPYRvQ5b\nSABIJiMUL+nTfXkUioDXpShqPyH+gyD09L8fcgYiS4fMDcrtR43GDNcyq/25uMtZ\nAYQ6a62tQc8Dik8GlDtPffGc5mxdO7X/4tLAObBPqO+lvGX2K/2hV2ql/a4fBVXR\nOMPc9A0eva2exifZyFo9vT9CCcW4iNY2BHY2hXAPI1gFpBnmnY2twFof4EvX6tfZ\nGjt20QCqTi41P8Obrfqi108zRAKtjJFeezNY+diVvxZaCDb/7ceFbFUrXq9u2UVD\nExn9joOLTJTEwQAAAIEAgOQ/mjRousgSenXW2nE2aq0m7oKQzhsF/8k5UPj6mym1\nvwUyC2gglTIOGVkUpj91L/Fh2nCuX5BLyzzIee0twRvT1Kj11BU6UoElStpR/JEC\n7trKWJrBddphBWHAuVcU5AQQPwI/9sg27q/9y16WTIQAJzx8GwGcDbgZj8/LbB4A\nAACBAMpVcX+2smqt8T9mbwU7e7ZaCQM0c3/7F2S2Z26Zl16k+8WPr6+CyJd3d2s2\nQkrmqVKJzDqPYidU0EmaNOrqytvUTUDK9KJgKsJuNC9ZbODqTCMA03ntr+hVcfdt\nd9F5fxyBJSrzpAhUQKadHs8jtAa1ENAhPmwKzvcJ51Gp4R3ZAAAAgQDg+s4nk926\njuLQGlweOi2HY6eeMQF8MOnXEhM8P7ErdRR73ql7GlhBNoGzuI6YTaqjLXBGNetj\nm4iziPLapbqBXSeia3y1JU71e1M+J342CxQwZRKTI9G/AB2AzspB4VfjAT9ZYJM1\nSFH7cDTejcrkfWko8TqyRLwtTPDa7Xlz2QAAAAAB\n-----END OPENSSH PRIVATE KEY-----\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;private_key_pem&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEAsdD9sJ/L5m8cRB19V20HA9BIqZwnT3id5JoMNUuWYn4sJTWH\na/JHkQ5akrWH50aIdzQrQneIZXJyx1OMlqKbVxAc2+u/8qd2m2GrsWKZeqQcpNT7\nv76QowDcvdggad3Tezn3XU/eBukVj9i+lnN1ofyQzVEQAdvW8TpRdUL5b/bIsz1R\nzGWzUrWD8XTFLf2RuvvzhgBViuuWI0ns3WQMpa6Dcu+nWfGLCl26WlphNmoUAv8w\nCay7KoynG58pJW+uqYA7lTx4tNMLhIW7rM4roYbXctkCi03PcW3x25O8yKSzYIi5\nxH7CQ7ggwXzcx4r06NXkaE9/LHuBSFJcIMvH8QIDAQABAoIBAQCV4u/lkV1j2ab+\n98ivCDVQjqKhbgJo5+hYSU4fIp8aWPbHSq7jXC/dYzcP0btERV1E9hG9DltIAEgm\nIxQv6dN9eRSKgNelKGo/If6DIPT0vx9yBiJLh8wNyu1HjcYM1zKr/bm4y1kBhDpr\nra1BzwOKTwaUO0998ZzmbF07tf/i0sA5sE+o76W8ZfYr/aFXaqX9rh8FVdE4w9z0\nDR69rZ7GJ9nIWj29P0IJxbiI1jYEdjaFcA8jWAWkGeadja3AWh/gS9fq19kaO3bR\nAKpOLjU/w5ut+qLXTzNEAq2MkV57M1j52JW/FloINv/tx4VsVSter27ZRUMTGf2O\ng4tMlMTBAoGBAMpVcX+2smqt8T9mbwU7e7ZaCQM0c3/7F2S2Z26Zl16k+8WPr6+C\nyJd3d2s2QkrmqVKJzDqPYidU0EmaNOrqytvUTUDK9KJgKsJuNC9ZbODqTCMA03nt\nr+hVcfdtd9F5fxyBJSrzpAhUQKadHs8jtAa1ENAhPmwKzvcJ51Gp4R3ZAoGBAOD6\nzieT3bqO4tAaXB46LYdjp54xAXww6dcSEzw/sSt1FHveqXsaWEE2gbO4jphNqqMt\ncEY162ObiLOI8tqluoFdJ6JrfLUlTvV7Uz4nfjYLFDBlEpMj0b8AHYDOykHhV+MB\nP1lgkzVIUftwNN6NyuR9aSjxOrJEvC1M8NrteXPZAoGAIQf/5nSh/e51ov8LAtSq\nJqPeMsq+TFdmg0eP7Stf3dCbVa5WZRW5v5h+Q19xRR8Q52udjrXXtUoQUuO83dkE\n0wx+rCQ1+cgvUtyA4nX741/8m/5Hh/E4tXo1h8o0NFtcV//xXGi4D7AJeenOnMxc\nWHf4zbGPqj29efEA9YEBQkkCgYABhG+DgNHMAk6xTJw2b/oCob9tp7L03XeWRb7v\ndxaAzodW1oeaFvFlbzKsvZ/okw2FkDbjolV2FIR1gYTxyJBbcv9jbwomRpwjt7M2\nBhopzyVRtjzL1UAC48NPLRXcH+Lx2v5MYgRcJaK36WfR4G7v35CoAAh/T0tdmtk9\nAMEC8QKBgQCA5D+aNGi6yBJ6ddbacTZqrSbugpDOGwX/yTlQ+PqbKbW/BTILaCCV\nMg4ZWRSmP3Uv8WHacK5fkEvLPMh57S3BG9PUqPXUFTpSgSVK2lH8kQLu2spYmsF1\n2mEFYcC5VxTkBBA/Aj/2yDbur/3LXpZMhAAnPHwbAZwNuBmPz8tsHg==\n-----END RSA PRIVATE KEY-----\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;private_key_pem_pkcs8&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCx0P2wn8vmbxxE\nHX1XbQcD0EipnCdPeJ3kmgw1S5ZifiwlNYdr8keRDlqStYfnRoh3NCtCd4hlcnLH\nU4yWoptXEBzb67/yp3abYauxYpl6pByk1Pu/vpCjANy92CBp3dN7OfddT94G6RWP\n2L6Wc3Wh/JDNURAB29bxOlF1Qvlv9sizPVHMZbNStYPxdMUt/ZG6+/OGAFWK65Yj\nSezdZAylroNy76dZ8YsKXbpaWmE2ahQC/zAJrLsqjKcbnyklb66pgDuVPHi00wuE\nhbusziuhhtdy2QKLTc9xbfHbk7zIpLNgiLnEfsJDuCDBfNzHivTo1eRoT38se4FI\nUlwgy8fxAgMBAAECggEBAJXi7+WRXWPZpv73yK8INVCOoqFuAmjn6FhJTh8inxpY\n9sdKruNcL91jNw/Ru0RFXUT2Eb0OW0gASCYjFC/p0315FIqA16Uoaj8h/oMg9PS/\nH3IGIkuHzA3K7UeNxgzXMqv9ubjLWQGEOmutrUHPA4pPBpQ7T33xnOZsXTu1/+LS\nwDmwT6jvpbxl9iv9oVdqpf2uHwVV0TjD3PQNHr2tnsYn2chaPb0/QgnFuIjWNgR2\nNoVwDyNYBaQZ5p2NrcBaH+BL1+rX2Ro7dtEAqk4uNT/Dm636otdPM0QCrYyRXnsz\nWPnYlb8WWgg2/+3HhWxVK16vbtlFQxMZ/Y6Di0yUxMECgYEAylVxf7ayaq3xP2Zv\nBTt7tloJAzRzf/sXZLZnbpmXXqT7xY+vr4LIl3d3azZCSuapUonMOo9iJ1TQSZo0\n6urK29RNQMr0omAqwm40L1ls4OpMIwDTee2v6FVx92130Xl/HIElKvOkCFRApp0e\nzyO0BrUQ0CE+bArO9wnnUanhHdkCgYEA4PrOJ5Pduo7i0BpcHjoth2OnnjEBfDDp\n1xITPD+xK3UUe96pexpYQTaBs7iOmE2qoy1wRjXrY5uIs4jy2qW6gV0nomt8tSVO\n9XtTPid+NgsUMGUSkyPRvwAdgM7KQeFX4wE/WWCTNUhR+3A03o3K5H1pKPE6skS8\nLUzw2u15c9kCgYAhB//mdKH97nWi/wsC1Komo94yyr5MV2aDR4/tK1/d0JtVrlZl\nFbm/mH5DX3FFHxDna52Otde1ShBS47zd2QTTDH6sJDX5yC9S3IDidfvjX/yb/keH\n8Ti1ejWHyjQ0W1xX//FcaLgPsAl56c6czFxYd/jNsY+qPb158QD1gQFCSQKBgAGE\nb4OA0cwCTrFMnDZv+gKhv22nsvTdd5ZFvu93FoDOh1bWh5oW8WVvMqy9n+iTDYWQ\nNuOiVXYUhHWBhPHIkFty/2NvCiZGnCO3szYGGinPJVG2PMvVQALjw08tFdwf4vHa\n/kxiBFwlorfpZ9Hgbu/fkKgACH9PS12a2T0AwQLxAoGBAIDkP5o0aLrIEnp11tpx\nNmqtJu6CkM4bBf/JOVD4+psptb8FMgtoIJUyDhlZFKY/dS/xYdpwrl+QS8s8yHnt\nLcEb09So9dQVOlKBJUraUfyRAu7ayliawXXaYQVhwLlXFOQEED8CP/bINu6v/cte\nlkyEACc8fBsBnA24GY/Py2we\n-----END PRIVATE KEY-----\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;public_key_fingerprint_md5&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a9:cc:2d:0f:66:b9:a9:89:94:f1:da:8f:93:df:63:d5&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;public_key_fingerprint_sha256&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SHA256:ias4wauIC4J/zd/cVoXT6UUSUZLQXaxdpJfkGAfRDz0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;public_key_openssh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCx0P2wn8vmbxxEHX1XbQcD0EipnCdPeJ3kmgw1S5ZifiwlNYdr8keRDlqStYfnRoh3NCtCd4hlcnLHU4yWoptXEBzb67/yp3abYauxYpl6pByk1Pu/vpCjANy92CBp3dN7OfddT94G6RWP2L6Wc3Wh/JDNURAB29bxOlF1Qvlv9sizPVHMZbNStYPxdMUt/ZG6+/OGAFWK65YjSezdZAylroNy76dZ8YsKXbpaWmE2ahQC/zAJrLsqjKcbnyklb66pgDuVPHi00wuEhbusziuhhtdy2QKLTc9xbfHbk7zIpLNgiLnEfsJDuCDBfNzHivTo1eRoT38se4FIUlwgy8fx\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;public_key_pem&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsdD9sJ/L5m8cRB19V20H\nA9BIqZwnT3id5JoMNUuWYn4sJTWHa/JHkQ5akrWH50aIdzQrQneIZXJyx1OMlqKb\nVxAc2+u/8qd2m2GrsWKZeqQcpNT7v76QowDcvdggad3Tezn3XU/eBukVj9i+lnN1\nofyQzVEQAdvW8TpRdUL5b/bIsz1RzGWzUrWD8XTFLf2RuvvzhgBViuuWI0ns3WQM\npa6Dcu+nWfGLCl26WlphNmoUAv8wCay7KoynG58pJW+uqYA7lTx4tNMLhIW7rM4r\noYbXctkCi03PcW3x25O8yKSzYIi5xH7CQ7ggwXzcx4r06NXkaE9/LHuBSFJcIMvH\n8QIDAQAB\n-----END PUBLIC KEY-----\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rsa_bits&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sensitive_attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;check_results&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看到不应该被第三方知晓的 <code>private_key_openssh</code>、<code>private_key_pem</code> 和 <code>private_key_pem_pkcs8</code> 是以明文形式被写在 <code>tfstate</code> 文件里的。这是 Terraform 从设计之初就确定的，并且在可见的未来不会有改善。不论你是在代码中明文硬编码，还是使用参数(variable，我们之后的章节会介绍)，亦或是妙想天开地使用函数在运行时从外界读取，都无法改变这个结果。</p>
<p>解决之道有两种，一种是使用 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/essential-vault/">Vault</a> 或是 <a target="_blank" rel="noopener" href="https://aws.amazon.com/secrets-manager/">AWS Secret Manager</a> 这样的动态机密管理工具生成临时有效的动态机密(比如有效期只有 5 分钟，即使被他人读取到，机密也早已失效)；另一种就是我们下面将要介绍的 —— Terraform Backend。</p>
<h2 id="1-3-2-1-3-生产环境的-tfstate-管理方案——-Backend"><a href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84-tfstate-%E7%AE%A1%E7%90%86%E6%96%B9%E6%A1%88%E2%80%94%E2%80%94-backend"></a>1.3.2.1.3. 生产环境的 tfstate 管理方案—— Backend</h2>
<p>到目前为止我们的 <code>tfstate</code> 文件是保存在当前工作目录下的本地文件，假设我们的计算机损坏了，导致文件丢失，那么 <code>tfstate</code> 文件所对应的资源都将无法管理，而产生资源泄漏。</p>
<p>另外如果我们是一个团队在使用 Terraform 管理一组资源，团队成员之间要如何共享这个状态文件？能不能把 <code>tfstate</code> 文件签入源代码管理工具进行保存？</p>
<p>把 <code>tfstate</code> 文件签入管代码管理工具是非常错误的，这就好比把数据库签入了源代码管理工具，如果两个人同时签出了同一份 <code>tfstate</code>，并且对代码做了不同的修改，又同时 apply 了，这时想要把 <code>tfstate</code> 签入源码管理系统可能会遭遇到无法解决的冲突。况且如果代码仓库是公开的，那么保存在 State 中的明文机密就会泄露。</p>
<p>为了解决状态文件的存储和共享问题，Terraform 引入了远程状态存储机制，也就是 Backend。Backend 是一种抽象的远程存储接口，如同 Provider 一样，Backend 也支持多种不同的远程存储服务：</p>
<ul>
<li><code>local</code></li>
<li><code>remote</code></li>
<li><code>azurerm</code></li>
<li><code>consul</code></li>
<li><code>cos</code></li>
<li><code>gcs</code></li>
<li><code>http</code></li>
<li><code>kubernetes</code></li>
<li><code>oss</code></li>
<li><code>pg</code></li>
<li><code>s3</code></li>
</ul>
<p><strong>注意</strong>：在 Terraform 1.1.0 之前的版本中，Backend 分为<em>标准</em>和<em>增强</em>两种。<em>增强</em>是一种特殊的 <code>remote</code> Backend，它既可以存储状态，也可以执行 Terraform 操作。但是这种分类已被移除。请参考<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/cloud">使用 Terraform Cloud</a> 了解关于存储状态、执行远程操作以及直接从 Terraform 调用 Terraform Cloud 的详细信息。</p>
<p>状态锁是指，当针对一个 <code>tfstate</code> 进行变更操作时，可以针对该状态文件添加一把全局锁，确保同一时间只能有一个变更被执行。不同的 Backend 对状态锁的支持不尽相同，实现状态锁的机制也不尽相同，例如 <code>consul</code> Backend就通过一个 <code>.lock</code> 节点来充当锁，一个 <code>.lockinfo</code> 节点来描述锁对应的会话信息，<code>tfstate</code> 文件被保存在 Backend 定义的路径节点内；<code>s3</code> Backend 则需要用户传入一个 Dynamodb 表来存放锁信息，而 <code>tfstate</code> 文件被存储在 S3 存储桶里，等等等等。读者可以根据实际情况，挑选自己合适的 Backend。接下来我将以 <code>consul</code> 为范例为读者演示 Backend 机制。</p>
<h2 id="1-3-2-1-4-Consul简介以及安装"><a href="#consul%E7%AE%80%E4%BB%8B%E4%BB%A5%E5%8F%8A%E5%AE%89%E8%A3%85"></a>1.3.2.1.4. Consul简介以及安装</h2>
<p><a target="_blank" rel="noopener" href="https://www.consul.io/">Consul</a> 是 HashiCorp 推出的一个开源工具，主要用来解决服务发现、配置中心以及 Service Mesh 等问题；Consul 本身也提供了类似 ZooKeeper、Etcd 这样的分布式键值存储服务，具有基于 Gossip 协议的最终一致性，所以可以被用来充当 Terraform Backend 存储。</p>
<p>安装 Consul 十分简单，如果你是 Ubuntu 用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O- https://apt.releases.hashicorp.com/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com <span class="subst">$(lsb_release -cs)</span> main&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/hashicorp.list</span><br><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt install consul</span><br></pre></td></tr></table></figure>
<p>对于CentOS用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils</span><br><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo</span><br><span class="line"><span class="built_in">sudo</span> yum -y install consul</span><br></pre></td></tr></table></figure>
<p>对于Macos用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap hashicorp/tap</span><br><span class="line">brew install hashicorp/tap/consul</span><br></pre></td></tr></table></figure>
<p>对于 Windows 用户，如果按照前文安装 Terraform 教程已经配置了 Chocolatey 的话：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">choco install consul</span><br></pre></td></tr></table></figure>
<p>安装完成后的验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ consul</span><br><span class="line">Usage: consul [--version] [--<span class="built_in">help</span>] &lt;<span class="built_in">command</span>&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line">Available commands are:</span><br><span class="line">    acl             Interact with Consul<span class="string">&#x27;s ACLs</span></span><br><span class="line"><span class="string">    agent           Runs a Consul agent</span></span><br><span class="line"><span class="string">    catalog         Interact with the catalog</span></span><br><span class="line"><span class="string">    config          Interact with Consul&#x27;</span>s Centralized Configurations</span><br><span class="line">    connect         Interact with Consul Connect</span><br><span class="line">    debug           Records a debugging archive <span class="keyword">for</span> operators</span><br><span class="line">    event           Fire a new event</span><br><span class="line">    <span class="built_in">exec</span>            Executes a <span class="built_in">command</span> on Consul nodes</span><br><span class="line">    force-leave     Forces a member of the cluster to enter the <span class="string">&quot;left&quot;</span> state</span><br><span class="line">    info            Provides debugging information <span class="keyword">for</span> operators.</span><br><span class="line">    intention       Interact with Connect service intentions</span><br><span class="line">    <span class="built_in">join</span>            Tell Consul agent to <span class="built_in">join</span> cluster</span><br><span class="line">    keygen          Generates a new encryption key</span><br><span class="line">    keyring         Manages gossip layer encryption keys</span><br><span class="line">    kv              Interact with the key-value store</span><br><span class="line">    leave           Gracefully leaves the Consul cluster and shuts down</span><br><span class="line">    lock            Execute a <span class="built_in">command</span> holding a lock</span><br><span class="line">    login           Login to Consul using an auth method</span><br><span class="line">    <span class="built_in">logout</span>          Destroy a Consul token created with login</span><br><span class="line">    maint           Controls node or service maintenance mode</span><br><span class="line">    members         Lists the members of a Consul cluster</span><br><span class="line">    monitor         Stream logs from a Consul agent</span><br><span class="line">    operator        Provides cluster-level tools <span class="keyword">for</span> Consul operators</span><br><span class="line">    peering         Create and manage peering connections between Consul clusters</span><br><span class="line">    reload          Triggers the agent to reload configuration files</span><br><span class="line">    resource        Interact with Consul<span class="string">&#x27;s resources</span></span><br><span class="line"><span class="string">    rtt             Estimates network round trip time between nodes</span></span><br><span class="line"><span class="string">    services        Interact with services</span></span><br><span class="line"><span class="string">    snapshot        Saves, restores and inspects snapshots of Consul server state</span></span><br><span class="line"><span class="string">    tls             Builtin helpers for creating CAs and certificates</span></span><br><span class="line"><span class="string">    troubleshoot    CLI tools for troubleshooting Consul service mesh</span></span><br><span class="line"><span class="string">    validate        Validate config files/directories</span></span><br><span class="line"><span class="string">    version         Prints the Consul version</span></span><br><span class="line"><span class="string">    watch           Watch for changes in Consul</span></span><br></pre></td></tr></table></figure>
<p>安装完 Consul 后，我们可以启动一个测试版 Consul 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ consul agent -dev</span><br></pre></td></tr></table></figure>
<p>Consul 会在本机 <code>8500</code> 端口开放 Http 终结点，我们可以通过浏览器访问 <a target="_blank" rel="noopener" href="http://localhost:8500/">http://localhost:8500</a> ：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220224455.png" alt="Consul的GUI界面"></p>
<p>图 1.3.2/1 - Consul的GUI界面</p>
<h2 id="1-3-2-1-5-使用-Backend"><a href="#%E4%BD%BF%E7%94%A8-backend"></a>1.3.2.1.5. 使用 Backend</h2>
<p>我们还是利用 LocalStack 来执行一段简单的 Terraform 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source = &quot;hashicorp/aws&quot;</span><br><span class="line">      version = &quot;~&gt;5.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  backend &quot;consul&quot; &#123;</span><br><span class="line">    address = &quot;localhost:8500&quot;</span><br><span class="line">    scheme  = &quot;http&quot;</span><br><span class="line">    path    = &quot;localstack-aws&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key                  = &quot;test&quot;</span><br><span class="line">  secret_key                  = &quot;test&quot;</span><br><span class="line">  region                      = &quot;us-east-1&quot;</span><br><span class="line">  s3_use_path_style           = false</span><br><span class="line">  skip_credentials_validation = true</span><br><span class="line">  skip_metadata_api_check     = true</span><br><span class="line">  skip_requesting_account_id  = true</span><br><span class="line"></span><br><span class="line">  endpoints &#123;</span><br><span class="line">    apigateway     = &quot;http://localhost:4566&quot;</span><br><span class="line">    apigatewayv2   = &quot;http://localhost:4566&quot;</span><br><span class="line">    cloudformation = &quot;http://localhost:4566&quot;</span><br><span class="line">    cloudwatch     = &quot;http://localhost:4566&quot;</span><br><span class="line">    docdb          = &quot;http://localhost:4566&quot;</span><br><span class="line">    dynamodb       = &quot;http://localhost:4566&quot;</span><br><span class="line">    ec2            = &quot;http://localhost:4566&quot;</span><br><span class="line">    es             = &quot;http://localhost:4566&quot;</span><br><span class="line">    elasticache    = &quot;http://localhost:4566&quot;</span><br><span class="line">    firehose       = &quot;http://localhost:4566&quot;</span><br><span class="line">    iam            = &quot;http://localhost:4566&quot;</span><br><span class="line">    kinesis        = &quot;http://localhost:4566&quot;</span><br><span class="line">    lambda         = &quot;http://localhost:4566&quot;</span><br><span class="line">    rds            = &quot;http://localhost:4566&quot;</span><br><span class="line">    redshift       = &quot;http://localhost:4566&quot;</span><br><span class="line">    route53        = &quot;http://localhost:4566&quot;</span><br><span class="line">    s3             = &quot;http://s3.localhost.localstack.cloud:4566&quot;</span><br><span class="line">    secretsmanager = &quot;http://localhost:4566&quot;</span><br><span class="line">    ses            = &quot;http://localhost:4566&quot;</span><br><span class="line">    sns            = &quot;http://localhost:4566&quot;</span><br><span class="line">    sqs            = &quot;http://localhost:4566&quot;</span><br><span class="line">    ssm            = &quot;http://localhost:4566&quot;</span><br><span class="line">    stepfunctions  = &quot;http://localhost:4566&quot;</span><br><span class="line">    sts            = &quot;http://localhost:4566&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_ami&quot; &quot;ubuntu&quot; &#123;</span><br><span class="line">  most_recent = true</span><br><span class="line"></span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;name&quot;</span><br><span class="line">    values = [&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;virtualization-type&quot;</span><br><span class="line">    values = [&quot;hvm&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  owners = [&quot;099720109477&quot;] # Canonical</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  ami           = data.aws_ami.ubuntu.id</span><br><span class="line">  instance_type = &quot;t3.micro&quot;</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;HelloWorld&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>terraform</code> 节中，我们添加了 <code>backend</code> 配置节，指定使用 <code>localhost:8500</code> 为地址(也就是我们刚才启动的测试版 Consul 服务)，指定使用 http 协议访问该地址，指定 <code>tfstate</code> 文件存放在 Consul 键值存储服务的 <code>localstack-aws</code> 路径下。</p>
<p>当我们执行完 <code>terraform apply</code> 后，我们访问 <a target="_blank" rel="noopener" href="http://localhost:8500/ui/dc1/kv">http://localhost:8500/ui/dc1/kv</a> ：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220230042.png" alt="Consul 中可以看到名为  的键"></p>
<p>图 1.3.2/2 - Consul 中可以看到名为 `localstack-aws` 的键</p>
<p>可以看到 <code>localstack-aws</code>，点击进入：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220230136.png" alt="键的内容"></p>
<p>图 1.3.2/3 - 键的内容</p>
<p>可以看到，原本保存在工作目录下的 <code>tfstate</code> 文件的内容，被保存在了 Consul 的名为 <code>localstack-aws</code> 的键下。</p>
<p>让我们执行 <code>terraform destroy</code> 后，重新访问 <a target="_blank" rel="noopener" href="http://localhost:8500/ui/dc1/kv">http://localhost:8500/ui/dc1/kv</a> ：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220230312.png" alt="键依然存在"></p>
<p>图 1.3.2/4 - 键依然存在</p>
<p>可以看到，<code>localstack-aws</code> 这个键仍然存在。让我们点击进去：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240220230350.png" alt="内容已被清空"></p>
<p>图 1.3.2/5 - 内容已被清空</p>
<p>可以看到，它的内容为空，代表基础设施已经被成功销毁。</p>
<h2 id="1-3-2-1-6-观察锁文件"><a href="#%E8%A7%82%E5%AF%9F%E9%94%81%E6%96%87%E4%BB%B6"></a>1.3.2.1.6. 观察锁文件</h2>
<p>那么在这个过程里，锁究竟在哪里？我们如何能够体验到锁的存在？让我们对代码进行一点修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source = &quot;hashicorp/aws&quot;</span><br><span class="line">      version = &quot;~&gt;5.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  backend &quot;consul&quot; &#123;</span><br><span class="line">    address = &quot;localhost:8500&quot;</span><br><span class="line">    scheme  = &quot;http&quot;</span><br><span class="line">    path    = &quot;localstack-aws&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  access_key                  = &quot;test&quot;</span><br><span class="line">  secret_key                  = &quot;test&quot;</span><br><span class="line">  region                      = &quot;us-east-1&quot;</span><br><span class="line">  s3_use_path_style           = false</span><br><span class="line">  skip_credentials_validation = true</span><br><span class="line">  skip_metadata_api_check     = true</span><br><span class="line">  skip_requesting_account_id  = true</span><br><span class="line"></span><br><span class="line">  endpoints &#123;</span><br><span class="line">    apigateway     = &quot;http://localhost:4566&quot;</span><br><span class="line">    apigatewayv2   = &quot;http://localhost:4566&quot;</span><br><span class="line">    cloudformation = &quot;http://localhost:4566&quot;</span><br><span class="line">    cloudwatch     = &quot;http://localhost:4566&quot;</span><br><span class="line">    docdb          = &quot;http://localhost:4566&quot;</span><br><span class="line">    dynamodb       = &quot;http://localhost:4566&quot;</span><br><span class="line">    ec2            = &quot;http://localhost:4566&quot;</span><br><span class="line">    es             = &quot;http://localhost:4566&quot;</span><br><span class="line">    elasticache    = &quot;http://localhost:4566&quot;</span><br><span class="line">    firehose       = &quot;http://localhost:4566&quot;</span><br><span class="line">    iam            = &quot;http://localhost:4566&quot;</span><br><span class="line">    kinesis        = &quot;http://localhost:4566&quot;</span><br><span class="line">    lambda         = &quot;http://localhost:4566&quot;</span><br><span class="line">    rds            = &quot;http://localhost:4566&quot;</span><br><span class="line">    redshift       = &quot;http://localhost:4566&quot;</span><br><span class="line">    route53        = &quot;http://localhost:4566&quot;</span><br><span class="line">    s3             = &quot;http://s3.localhost.localstack.cloud:4566&quot;</span><br><span class="line">    secretsmanager = &quot;http://localhost:4566&quot;</span><br><span class="line">    ses            = &quot;http://localhost:4566&quot;</span><br><span class="line">    sns            = &quot;http://localhost:4566&quot;</span><br><span class="line">    sqs            = &quot;http://localhost:4566&quot;</span><br><span class="line">    ssm            = &quot;http://localhost:4566&quot;</span><br><span class="line">    stepfunctions  = &quot;http://localhost:4566&quot;</span><br><span class="line">    sts            = &quot;http://localhost:4566&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_ami&quot; &quot;ubuntu&quot; &#123;</span><br><span class="line">  most_recent = true</span><br><span class="line"></span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;name&quot;</span><br><span class="line">    values = [&quot;ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20170727&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;virtualization-type&quot;</span><br><span class="line">    values = [&quot;hvm&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  owners = [&quot;099720109477&quot;] # Canonical</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  ami           = data.aws_ami.ubuntu.id</span><br><span class="line">  instance_type = &quot;t3.micro&quot;</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;HelloWorld&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  provisioner &quot;local-exec&quot; &#123;</span><br><span class="line">    command = &quot;sleep 1000&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次的变化是我们在 <code>aws_instance</code> 的定义上添加了一个 <code>local-exec</code> 类型的 Provisioner。Provisioner 我们在后续的章节中会专门叙述，在这里读者只需要理解，Terraform 进程在成功创建了该资源后，会在执行 Terraform 命令行的机器上执行一条命令：<code>sleep 1000</code>，这个时间足以将 Terraform 进程阻塞足够长的时间，以便让我们观察锁信息了。如果读者正在使用 Windows，可以把 <code>provisioner</code> 改成这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">provisioner &quot;local-exec&quot; &#123;</span><br><span class="line">  command = &quot;Start-Sleep -s 1000&quot;</span><br><span class="line">  interpreter = [&quot;PowerShell&quot;, &quot;-Command&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们执行<code>terraform apply</code>，这一次 apply 将会被 sleep 阻塞，而不会成功完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">data.aws_ami.ubuntu: Reading...</span><br><span class="line">data.aws_ami.ubuntu: Read complete after 1s [<span class="built_in">id</span>=ami-1e749f67]</span><br><span class="line"></span><br><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following  </span><br><span class="line">symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># aws_instance.web will be created</span></span><br><span class="line">  + resource <span class="string">&quot;aws_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      + ami                                  = <span class="string">&quot;ami-1e749f67&quot;</span></span><br><span class="line">      + arn                                  = (known after apply)</span><br><span class="line">      + associate_public_ip_address          = (known after apply)</span><br><span class="line">      + availability_zone                    = (known after apply)</span><br><span class="line">      + cpu_core_count                       = (known after apply)</span><br><span class="line">      + cpu_threads_per_core                 = (known after apply)</span><br><span class="line">      + disable_api_stop                     = (known after apply)</span><br><span class="line">      + disable_api_termination              = (known after apply)</span><br><span class="line">      + ebs_optimized                        = (known after apply)</span><br><span class="line">      + get_password_data                    = <span class="literal">false</span></span><br><span class="line">      + host_id                              = (known after apply)</span><br><span class="line">      + host_resource_group_arn              = (known after apply)</span><br><span class="line">      + iam_instance_profile                 = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                                   = (known after apply)</span><br><span class="line">      + instance_initiated_shutdown_behavior = (known after apply)</span><br><span class="line">      + instance_lifecycle                   = (known after apply)</span><br><span class="line">      + instance_state                       = (known after apply)</span><br><span class="line">      + instance_type                        = <span class="string">&quot;t3.micro&quot;</span></span><br><span class="line">      + ipv6_address_count                   = (known after apply)</span><br><span class="line">      + ipv6_addresses                       = (known after apply)</span><br><span class="line">      + key_name                             = (known after apply)</span><br><span class="line">      + monitoring                           = (known after apply)</span><br><span class="line">      + outpost_arn                          = (known after apply)</span><br><span class="line">      + password_data                        = (known after apply)</span><br><span class="line">      + placement_group                      = (known after apply)</span><br><span class="line">      + placement_partition_number           = (known after apply)</span><br><span class="line">      + primary_network_interface_id         = (known after apply)</span><br><span class="line">      + private_dns                          = (known after apply)</span><br><span class="line">      + private_ip                           = (known after apply)</span><br><span class="line">      + public_dns                           = (known after apply)</span><br><span class="line">      + public_ip                            = (known after apply)</span><br><span class="line">      + secondary_private_ips                = (known after apply)</span><br><span class="line">      + security_groups                      = (known after apply)</span><br><span class="line">      + source_dest_check                    = <span class="literal">true</span></span><br><span class="line">      + spot_instance_request_id             = (known after apply)</span><br><span class="line">      + subnet_id                            = (known after apply)</span><br><span class="line">      + tags                                 = &#123;</span><br><span class="line">          + <span class="string">&quot;Name&quot;</span> = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      + tags_all                             = &#123;</span><br><span class="line">          + <span class="string">&quot;Name&quot;</span> = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      + tenancy                              = (known after apply)</span><br><span class="line">      + user_data                            = (known after apply)</span><br><span class="line">      + user_data_base64                     = (known after apply)</span><br><span class="line">      + user_data_replace_on_change          = <span class="literal">false</span></span><br><span class="line">      + vpc_security_group_ids               = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 1 to add, 0 to change, 0 to destroy.</span><br><span class="line">aws_instance.web: Creating...</span><br><span class="line">aws_instance.web: Still creating... [10s elapsed]</span><br><span class="line">aws_instance.web: Provisioning with <span class="string">&#x27;local-exec&#x27;</span>...</span><br><span class="line">aws_instance.web (local-exec): Executing: [<span class="string">&quot;PowerShell&quot;</span> <span class="string">&quot;-Command&quot;</span> <span class="string">&quot;Start-Sleep -s 1000&quot;</span>]</span><br><span class="line">aws_instance.web: Still creating... [20s elapsed]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>让我们重新访问 <a target="_blank" rel="noopener" href="http://localhost:8500/ui/dc1/kv">http://localhost:8500/ui/dc1/kv</a> ：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225100309.png" alt="多了一个同名的文件夹"></p>
<p>图 1.3.2/6 - 多了一个同名的文件夹</p>
<p>这一次情况发生了变化，我们看到除了<code>localstack-aws</code>这个键之外，还多了一个同名的文件夹。让我们点击进入文件夹：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225100354.png" alt="localstack-aws 文件夹内部"></p>
<p>图 1.3.2/7 - localstack-aws 文件夹内部</p>
<p>在这里我们成功观测到了 <code>.lock</code> 和 <code>.lockinfo</code> 文件。让我们点击 <code>.lock</code> 看看：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225180803.png" alt=" 内容"></p>
<p>图 1.3.2/8 - `.lock` 内容</p>
<p>Consul UI提醒我们，该键值对目前正被锁定，而它的内容是空的。让我们查看 <code>.lockinfo</code> 的内容：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225180852.png" alt=" 内容"></p>
<p>图 1.3.2/9 - `.lockinfo` 内容</p>
<p><code>.lockinfo</code> 里记录了锁 <code>ID</code>、我们执行的操作，以及其他的一些信息。</p>
<p>让我们另起一个新的命令行窗口，在同一个工作目录下尝试另一次执行 <code>terraform apply</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply</span><br><span class="line">Acquiring state lock. This may take a few moments...</span><br><span class="line">╷</span><br><span class="line">│ Error: Error acquiring the state lock</span><br><span class="line">│ </span><br><span class="line">│ Error message: Lock Info:</span><br><span class="line">│   ID:        11c859fd-d3e5-4eab-46d6-586b73133430</span><br><span class="line">│   Path:      localstack-aws</span><br><span class="line">│   Operation: OperationTypeApply</span><br><span class="line">│   Who:       ***</span><br><span class="line">│   Version:   1.7.3</span><br><span class="line">│   Created:   2024-02-25 02:00:21.3700184 +0000 UTC</span><br><span class="line">│   Info:      consul session: 11c859fd-d3e5-4eab-46d6-586b73133430</span><br><span class="line">│</span><br><span class="line">│</span><br><span class="line">│ Terraform acquires a state lock to protect the state from being written</span><br><span class="line">│ by multiple <span class="built_in">users</span> at the same <span class="keyword">time</span>. Please resolve the issue above and try</span><br><span class="line">│ again. For most commands, you can <span class="built_in">disable</span> locking with the <span class="string">&quot;-lock=false&quot;</span></span><br><span class="line">│ flag, but this is not recommended.</span><br><span class="line">╵</span><br></pre></td></tr></table></figure>
<p>可以看到，同时另一个人试图对同一个 <code>tfstate</code> 执行变更的尝试失败了，因为它无法顺利获取到锁。</p>
<p>让我们用 <code>ctrl-c</code> 终止原先被阻塞的 <code>terraform apply</code> 的执行，然后用 <code>terraform force-unlock 11c859fd-d3e5-4eab-46d6-586b73133430</code> 解锁：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ terraform force-unlock 11c859fd-d3e5-4eab-46d6-586b73133430</span><br><span class="line">Do you really want to force-unlock?</span><br><span class="line">  Terraform will remove the lock on the remote state.</span><br><span class="line">  This will allow <span class="built_in">local</span> Terraform commands to modify this state, even though it</span><br><span class="line">  may still be <span class="keyword">in</span> use. Only <span class="string">&#x27;yes&#x27;</span> will be accepted to confirm.</span><br><span class="line"></span><br><span class="line">  Enter a value: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">Terraform state has been successfully unlocked!</span><br><span class="line"></span><br><span class="line">The state has been unlocked, and Terraform commands should now be able to</span><br><span class="line">obtain a new lock on the remote state.</span><br></pre></td></tr></table></figure>
<p>然后重新访问 <a target="_blank" rel="noopener" href="http://localhost:8500/ui/dc1/kv">http://localhost:8500/ui/dc1/kv</a> ：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225101100.png" alt="重新访问Consul"></p>
<p>图 1.3.2/10 - 重新访问Consul</p>
<p>可以看到，包含锁的文件夹消失了。</p>
<h2 id="1-3-2-1-7-Backend-配置的动态赋值"><a href="#backend-%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8A%A8%E6%80%81%E8%B5%8B%E5%80%BC"></a>1.3.2.1.7. Backend 配置的动态赋值</h2>
<p>有些读者会注意到，到目前为止我所写的代码里的配置项基本都是硬编码的，Terraform 是否支持运行时用变量动态赋值？答案是支持的，Terraform 可以通过 <code>variable</code> 变量来传值给 <code>provider</code>、<code>data</code> 和 <code>resource</code>。</p>
<p>但有一些例外，其中就有 <code>backend</code> 配置。<code>backend</code> 配置只允许硬编码，或者不传值。</p>
<p>这个问题是因为 Terraform 运行时本身设计的运行顺序导致的，一直到 2019 年 05 月官方才给出了解决方案，那就是“部分配置“(partial configuration)。</p>
<p>简单来说就是我们可以在 Terraform 代码的 <code>backend</code> 声明中不给出具体的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source = &quot;hashicorp/aws&quot;</span><br><span class="line">      version = &quot;~&gt;5.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  backend &quot;consul&quot; &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而在另一个独立的文件中给出相关配置，例如我们在工作目录下创建一个名为 <code>backend.hcl</code> 的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">address = &quot;localhost:8500&quot;</span><br><span class="line">scheme  = &quot;http&quot;</span><br><span class="line">path    = &quot;localstack-aws&quot;</span><br></pre></td></tr></table></figure>
<p>本质上我们就是把原本属于 <code>backend consul</code> 块的属性赋值代码搬迁到一个独立的 hcl 文件内，然后我们执行 <code>terraform init</code> 时附加 <code>backend-config</code> 参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ terraform init -backend-config=backend.hcl</span><br></pre></td></tr></table></figure>
<p>这样也可以初始化成功。通过这种打补丁的方式，我们可以复用他人预先写好的 Terraform 代码，在执行时把属于我们自己的 Backend 配置信息以独立的 <code>backend-config</code> 文件的形式传入来进行初始化。</p>
<h2 id="1-3-2-1-8-Backend-的权限控制以及版本控制"><a href="#backend-%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E4%BB%A5%E5%8F%8A%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"></a>1.3.2.1.8. Backend 的权限控制以及版本控制</h2>
<p>Backend 本身并没有设计任何的权限以及版本控制，这方面完全依赖于具体的 Backend 实现。以 AWS S3 为例，我们可以针对不同的 Bucket 设置不同的 IAM，用以防止开发测试人员直接操作生产环境，或是给予部分人员对状态信息的只读权限；另外我们也可以开启 S3 的版本控制功能，以防我们错误修改了状态文件(Terraform 命令行有修改状态的相关指令)。</p>
<h2 id="1-3-2-1-9-状态的隔离存储"><a href="#%E7%8A%B6%E6%80%81%E7%9A%84%E9%9A%94%E7%A6%BB%E5%AD%98%E5%82%A8"></a>1.3.2.1.9. 状态的隔离存储</h2>
<p>我们讲完 Backend，现在要讨论另一个问题。假设我们的 Terraform 代码可以创建一个通用的基础设施，比如说是云端的一个 EKS、AKS 集群，或者是一个基于 S3 的静态网站，那么我们可能要为很多团队创建并维护这些相似但要彼此隔离的 Stack，又或者我们要为部署的应用维护开发、测试、预发布、生产四套不同的部署。那么该如何做到不同的部署，彼此状态文件隔离存储和管理呢？</p>
<p>一种简单的方法就是分成不同的文件夹存储。</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/2020-11-17/1605571444613-image.png" alt="将代码复制到不同的文件夹中保存"></p>
<p>图 1.3.2/11 - 将代码复制到不同的文件夹中保存</p>
<p>我们可以把不同产品不同部门使用的基础设施分成不同的文件夹，在文件夹内维护相同的代码文件，配置不同的 <code>backend-config</code>，把状态文件保存到不同的 Backend 上。这种方法可以给予最大程度的隔离，缺点是我们需要拷贝许多份相同的代码。</p>
<p>第二种更加轻量级的方法就是 Workspace。注意，Terraform 开源版的 Workspace 与 Terraform Cloud 云服务的 Workspace 实际上是两个不同的概念，我们这里介绍的是开源版的 Workspace。</p>
<p>Workspace 允许我们在同一个文件夹内，使用同样的 Backend 配置，但可以维护任意多个彼此隔离的状态文件。还是我们刚才那个使用测试 Consul 服务作为 Backend 的例子：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225174932.png" alt="重新访问 Consul，目前有一个键"></p>
<p>图 1.3.2/12 - 重新访问 Consul，目前有一个键</p>
<p>当前我们有一个状态文件，名字是 <code>localstack-aws</code>。然后我们在工作目录下执行这样的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace new feature1</span><br><span class="line">Created and switched to workspace <span class="string">&quot;feature1&quot;</span>!</span><br><span class="line"></span><br><span class="line">You<span class="string">&#x27;re now on a new, empty workspace. Workspaces isolate their state,</span></span><br><span class="line"><span class="string">so if you run &quot;terraform plan&quot; Terraform will not see any existing state</span></span><br><span class="line"><span class="string">for this configuration.</span></span><br></pre></td></tr></table></figure>
<p>通过调用 <code>workspace</code> 命令，我们成功创建了名为 <code>feature1</code> 的 Workspace。这时我们观察 <code>.terraform</code> 文件夹：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">..</span><br><span class="line">├── environment</span><br><span class="line">├── providers</span><br><span class="line">│        └── registry.terraform.io</span><br><span class="line">│             └── hashicorp</span><br><span class="line">│                 └── aws</span><br><span class="line">│                     └── 5.38.0</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>我们会发现多了一个 <code>environment</code> 文件，它的内容是 <code>feature1</code>。这实际上就是 Terraform 用来保存当前上下文环境使用的是哪个 Workspace 的文件。</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225175538.png" alt="Consul 中多了一个 "></p>
<p>图 1.3.2/13 - Consul 中多了一个 `localstack-aws-env:feature1`</p>
<p>重新观察 Consul 存储会发现多了一个文件：<code>localstack-aws-env:feature1</code>。这就是 Terraform 为 <code>feature1</code> 这个 Workspace 创建的独立的状态文件。让我们执行一下 apply，然后再看这个文件的内容：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225175806.png" alt="此时  的内容"></p>
<p>图 1.3.2/14 - 此时 `localstack-aws-env:feature1` 的内容</p>
<p>可以看到，状态被成功写入了 <code>feature1</code> 的状态文件。</p>
<p>我们可以通过以下命令来查询当前 Backend 下所有的 Workspace：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace list</span><br><span class="line">  default</span><br><span class="line">* feature1</span><br></pre></td></tr></table></figure>
<p>我们有 <code>default</code> 和 <code>feature1</code> 两个 Workspace，当前我们工作在 <code>feature1</code> 上。我们可以用以下命令切换回 <code>default</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace <span class="keyword">select</span> default</span><br><span class="line">Switched to workspace <span class="string">&quot;default&quot;</span>.</span><br></pre></td></tr></table></figure>
<p>我们可以用以下命令确认我们成功切换回了 <code>default</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace show</span><br><span class="line">default</span><br></pre></td></tr></table></figure>
<p>我们可以用以下命令删除 <code>feature1</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace delete feature1</span><br><span class="line">╷</span><br><span class="line">│ Error: Workspace is not empty</span><br><span class="line">│</span><br><span class="line">│ Workspace <span class="string">&quot;feature1&quot;</span> is currently tracking the following resource instances:</span><br><span class="line">│   - aws_instance.web</span><br><span class="line">│</span><br><span class="line">│ Deleting this workspace would cause Terraform to lose track of any associated remote objects, <span class="built_in">which</span> would <span class="keyword">then</span> require you to    </span><br><span class="line">│ delete them manually outside of Terraform. You should destroy these objects with Terraform before deleting the workspace.        </span><br><span class="line">│</span><br><span class="line">│ If you want to delete this workspace anyway, and have Terraform forget about these managed objects, use the -force option to     </span><br><span class="line">│ <span class="built_in">disable</span> this safety check.</span><br><span class="line">╵</span><br></pre></td></tr></table></figure>
<p>Terraform 发现 <code>feature1</code> 还有资源没有被销毁，所以它拒绝了我们的删除请求。因为我们目前是使用 LocalStack 模拟的例子，所以不会有资源泄漏的问题，我们可以用以下命令强制删除 <code>feature1</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ terraform workspace delete -force feature1</span><br><span class="line">Deleted workspace <span class="string">&quot;feature1&quot;</span>!</span><br><span class="line">WARNING: <span class="string">&quot;feature1&quot;</span> was non-empty.</span><br><span class="line">The resources managed by the deleted workspace may still exist,</span><br><span class="line">but are no longer manageable by Terraform since the state has</span><br><span class="line">been deleted.</span><br></pre></td></tr></table></figure>
<p>再观察 Consul 存储，就会发现 <code>feature1</code> 的状态文件被删除了：</p>
<p><img src="https://raw.githubusercontent.com/lonegunmanb/introduction-to-terraform-pic/master/20240225180126.png" alt=" 被删除了"></p>
<p>图 1.3.2/15 - `localstack-aws-env:feature1` 被删除了</p>
<p>目前支持多工作区的 Backend 有：</p>
<ul>
<li>AzureRM</li>
<li>Consulf</li>
<li>COS</li>
<li>GCS</li>
<li>Kubernetes</li>
<li>Local</li>
<li>OSS</li>
<li>Postgres</li>
<li>Remote</li>
<li>S3</li>
</ul>
<h2 id="1-3-2-1-10-该使用哪种隔离"><a href="#%E8%AF%A5%E4%BD%BF%E7%94%A8%E5%93%AA%E7%A7%8D%E9%9A%94%E7%A6%BB"></a>1.3.2.1.10. 该使用哪种隔离</h2>
<p>相比起多文件夹隔离的方式来说，基于 Workspace 的隔离更加简单，只需要保存一份代码，在代码中不需要为 Workspace 编写额外代码，用命令行就可以在不同工作区之间来回切换。</p>
<p>但是 Workspace 的缺点也同样明显，由于所有工作区的 Backend 配置是一样的，所以有权读写某一个 Workspace 的人可以读取同一个 Backend 路径下所有其他 Workspace；另外 Workspace 是隐式配置的(调用命令行)，所以有时人们会忘记自己工作在哪个 Workspace 下。</p>
<p>Terraform 官方为 Workspace 设计的场景是：有时开发人员想要对既有的基础设施做一些变更，并进行一些测试，但又不想直接冒险修改既有的环境。这时他可以利用 Workspace 复制出一个与既有环境完全一致的平行环境，在这个平行环境里做一些变更，并进行测试和实验工作。</p>
<p>Workspace 对应的源代码管理模型里的主干——分支模型，如果团队希望维护的是不同产品之间不同的基础设施，或是开发、测试、预发布、生产环境，那么最好还是使用不同的文件夹以及不同的 <code>backend-config</code> 进行管理。</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">標籤</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="../../../../../tags/Terraform/" rel="tag">Terraform</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../19/Teraform/Terraform-%E4%BB%A3%E7%A0%81/"
                    data-tooltip="Terraform-代码-类型"
                    aria-label="上一篇: Terraform-代码-类型"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../17/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-Provider%20copy/"
                    data-tooltip="Terraform 基础概念-Provider"
                    aria-label="下一篇: Terraform 基础概念-Provider"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Kein Chan. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../19/Teraform/Terraform-%E4%BB%A3%E7%A0%81/"
                    data-tooltip="Terraform-代码-类型"
                    aria-label="上一篇: Terraform-代码-类型"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../17/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-Provider%20copy/"
                    data-tooltip="Terraform 基础概念-Provider"
                    aria-label="下一篇: Terraform 基础概念-Provider"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                        aria-label="global.share_on_linkedin"
                    >
                        <i class="fab fa-linkedin" aria-hidden="true"></i><span>global.share_on_linkedin</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://chankein.github.io/2023/01/18/Teraform/Terraform-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"
                        aria-label="分享到 Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
        
            <h4 id="about-card-name">Kein Chan</h4>
        
            <div id="about-card-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>全棧工程師</br>資深技術顧問</br>數據科學家</br>Hit廣島觀光大使</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Tokyo/Macau
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="../assets/images/logo-algolia-nebula-blue-full.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">沒有找到文章</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/04/27/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/"
                            aria-label=": R语言-环境安装"
                        >
                            <h3 class="media-heading">R语言-环境安装</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月27日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/04/28/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E5%9F%BA%E7%A1%80/"
                            aria-label=": R语言-基础"
                        >
                            <h3 class="media-heading">R语言-基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月28日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/05/01/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE/"
                            aria-label=": R语言-读取数据"
                        >
                            <h3 class="media-heading">R语言-读取数据</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月1日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/05/02/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BB%98%E5%9B%BE/"
                            aria-label=": R语言-绘图"
                        >
                            <h3 class="media-heading">R语言-绘图</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月2日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2013/05/03/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/"
                            aria-label=": R语言-线性回归"
                        >
                            <h3 class="media-heading">R语言-线性回归</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月3日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/22/Algorithms/1.%E7%AE%97%E6%B3%95%E5%9C%A8%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8/"
                            aria-label=": 1. 算法在计算中的作用"
                        >
                            <h3 class="media-heading">1. 算法在计算中的作用</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月22日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/23/Algorithms/2.%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/"
                            aria-label=": 2. 算法基础"
                        >
                            <h3 class="media-heading">2. 算法基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/24/Algorithms/3.%E5%87%BD%E6%95%B0%E7%9A%84%E5%A2%9E%E9%95%BF/"
                            aria-label=": 3. 函数的增长"
                        >
                            <h3 class="media-heading">3. 函数的增长</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月24日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/25/Algorithms/4.%E5%88%86%E6%B2%BB%E7%AD%96%E7%95%A5/"
                            aria-label=": 4. 分治策略"
                        >
                            <h3 class="media-heading">4. 分治策略</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月25日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://chankein.github.io/2015/02/26/Algorithms/5.%E6%A6%82%E7%8E%87%E5%88%86%E6%9E%90%E5%92%8C%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/"
                            aria-label=": 5. 概率分析和随机算法"
                        >
                            <h3 class="media-heading">5. 概率分析和随机算法</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月26日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="沒有找到文章"
                data-message-one="找到 1 篇文章"
                data-message-other="找到 {n} 篇文章">
                找到 211 篇文章
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('../../../../../assets/images/cover.jpeg');"></div>
        <!--SCRIPTS-->

<script src="../../../../../assets/js/script-qtzvvb63gamuirvfphht7lytrxkfllzng1escnm2phjtlt4tvvxi5gl0wx4o.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
