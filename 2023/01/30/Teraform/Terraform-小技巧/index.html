
<!DOCTYPE html>
<html lang="zh-tw">
    
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    
      <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/locale/zh-tw.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
    <script>
      window.algoliaConfig = {
        appId: 'AWFC86Q51O',
        apiKey: 'c9d952906eb1b154d75cf863e75c1ede',
        indexName: 'MyBlog'
      };
      var algoliaIndex = algoliasearch(
        algoliaConfig.appId,
        algoliaConfig.apiKey
      ).initIndex(algoliaConfig.indexName);
    </script>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Kein&#39;s blog">
    <title>Terraform-小技巧 - Kein&#39;s blog</title>
    <meta name="author" content="Kein Chan">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kein Chan","sameAs":["https://github.com/chankein/","https://www.linkedin.com/profile/","mailto:kein.chan85@gmail.com"],"image":"profile.jpg"},"articleBody":"\n1.9.1.1. 有条件创建\n\n\n1.9.1.1. 有条件创建\nTerraform被设计成声明式而非命令式，例如没有常见的 if 条件语句，后来才加上了 count 和 for_each 实现的循环语句(但循环的次数必须是在 plan 阶段就能够确认的，无法根据其他 resource 的输出动态决定)\n有时候我们需要根据某种条件来判断是否创建一个资源。虽然我们无法使用if来完成条件判断，但我们还有 count 和 for_each 可以帮助我们完成这个目标。\n我们以 UCloud 为例，假如我们正在编写一个旨在被复用的模块，模块的逻辑要创建一台虚拟机，我们的代码可以是这样的：\n1234567891011121314151617data ucloud_vpcs &quot;default&quot; &#123;  name_regex = &quot;^Default&quot;&#125;data &quot;ucloud_images&quot; &quot;centos&quot; &#123;  name_regex = &quot;^CentOS 7&quot;&#125;resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;  availability_zone = &quot;cn-bj2-02&quot;  image_id = data.ucloud_images.centos.images[0].id  instance_type = &quot;n-basic-2&quot;&#125;output &quot;uhost_id&quot; &#123;  value = ucloud_instance.web.id&#125;\n非常简单。但是如果我们想进一步，让模块的调用者决定创建的主机是否要搭配一个弹性公网 IP 该怎么办？\n我们可以在上面的代码后面接上这样的代码：\n1234567891011121314151617variable &quot;allocate_public_ip&quot; &#123;  description = &quot;Decide whether to allocate a public ip and bind it to the host&quot;  type = bool  default = false&#125;resource &quot;ucloud_eip&quot; &quot;public_ip&quot; &#123;  count = var.allocate_public_ip ? 1 : 0  name = &quot;public_ip_for_$&#123;ucloud_instance.web.name&#125;&quot;  internet_type = &quot;bgp&quot;&#125;resource &quot;ucloud_eip_association&quot; &quot;public_ip_binding&quot; &#123;  count = var.allocate_public_ip ? 1 : 0  eip_id = ucloud_eip.public_ip[0].id  resource_id = ucloud_instance.web.id&#125;\n我们首先创建了名为 allocate_public_ip 的输入变量，然后在编写弹性 IP 相关资源代码的时候都声明了 count 参数，值使用了条件表达式，根据 allocate_public_ip 这个输入变量的值决定是 1 还是 0。这实际上实现了按条件创建资源。\n需要注意的是，由于我们使用了 count，所以现在弹性 IP 相关的资源实际上是多实例资源类型的。我们在 ucloud_eip_association.public_ip_binding 中引用 ucloud_eip.public 时，还是要加上访问下标。由于 ucloud_eip_association.public_ip_binding 与 ucloud_eip.public 实际上是同生同死，所以在这里他们之间的引用还比较简单；如果是其他没有声明 count 的资源引用它们的话，还要针对 allocate_public_ip 为 false 时 ucloud_eip.public 实际为空做相应处理，比如在 output 中：\n123output &quot;public_ip&quot; &#123;  value = join(&quot;&quot;, ucloud_eip.public_ip[*].public_ip)&#125;\n使用 join 函数就可以在即使没有创建弹性 IP 时也能返回空字符串。或者我们也可以用条件表达式：\n123output &quot;public_ip&quot; &#123;  value = length(ucloud_eip.public_ip[*].public_ip) &gt; 0 ? ucloud_eip.public_ip[0].public_ip : &quot;&quot;&#125;\n\n1.9.2.1. 依赖反转\n\n\n1.9.2.1. 依赖反转\nTerraform 编排的基础设施对象彼此之间可能互相存在依赖关系，有时我们在编写一些旨在重用的模块时，模块内定义的资源可能本身需要依赖其他一些资源，这些资源可能已经存在，也可能有待创建。\n举一个例子，假设我们编写了一个模块，定义了在 UCloud 上同一个 VPC 中的两台服务器；第一台服务器部署了一个 Web 应用，它被分配在一个 DMZ 子网里；第二台服务器部署了一个数据库，它被分配在一个内网子网里。现在的问题是，在我们编写模块时，我们并没有关于 VPC 和子网的任何信息，我们甚至连服务器应该部署在哪个可用区都不知道。VPC 和子网可能已经存在，也可以有待创建。\n我们可以定义这样的一个模块代码：\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647terraform &#123;  required_providers &#123;    ucloud = &#123;      source  = &quot;ucloud/ucloud&quot;      version = &quot;~&gt;1.22.0&quot;    &#125;  &#125;&#125;variable &quot;network_config&quot; &#123;  type = object(&#123;    vpc_id         = string    web_app_config = object(&#123;      az        = string      subnet_id = string    &#125;)    db_config      = object(&#123;      az        = string      subnet_id = string    &#125;)  &#125;)&#125;data &quot;ucloud_images&quot; &quot;web_app&quot; &#123;  name_regex = &quot;^WebApp&quot;&#125;data &quot;ucloud_images&quot; &quot;mysql&quot; &#123;  name_regex = &quot;^MySql 5.7&quot;&#125;resource &quot;ucloud_instance&quot; &quot;web_app&quot; &#123;  availability_zone = var.network_config.web_app_config.az  image_id          = data.ucloud_images.web_app.images[0].id  instance_type     = &quot;n-basic-2&quot;  vpc_id            = var.network_config.vpc_id  subnet_id         = var.network_config.web_app_config.subnet_id&#125;resource &quot;ucloud_instance&quot; &quot;mysql&quot; &#123;  availability_zone = var.network_config.db_config.az  image_id          = data.ucloud_images.mysql.images[0].id  instance_type     = &quot;n-basic-2&quot;  vpc_id            = var.network_config.vpc_id  subnet_id         = var.network_config.db_config.subnet_id&#125;\n在代码中我们把依赖的网络参数定义为一个复杂类型，一个强类型对象结构。这样的话模块代码就不用再关注网络层究竟是查询而来的还是创建的，模块中只定义了抽象的网络层定义，其具体实现由调用者从外部注入，从而实现了依赖反转。\n如果调用者需要创建网络层，那么代码可以是这样的(假设我们把前面编写的模块保存在 ./machine 目录下而成为一个内嵌模块)：\n1234567891011121314151617181920212223242526272829resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;  cidr_blocks = [    &quot;192.168.0.0/16&quot;]&#125;resource &quot;ucloud_subnet&quot; &quot;dmz&quot; &#123;  cidr_block = &quot;192.168.0.0/24&quot;  vpc_id     = ucloud_vpc.vpc.id&#125;resource &quot;ucloud_subnet&quot; &quot;db&quot; &#123;  cidr_block = &quot;192.168.1.0/24&quot;  vpc_id     = ucloud_vpc.vpc.id&#125;module &quot;machine&quot; &#123;  source         = &quot;./machine&quot;  network_config = &#123;    vpc_id         = ucloud_vpc.vpc.id    web_app_config = &#123;      az        = &quot;cn-bj2-02&quot;      subnet_id = ucloud_subnet.dmz.id    &#125;    db_config      = &#123;      az        = &quot;cn-bj2-02&quot;      subnet_id = ucloud_subnet.db.id    &#125;  &#125;&#125;\n或者我们想使用现存的网络来托管服务器：\n12345678910111213141516171819202122232425262728data &quot;ucloud_vpcs&quot; &quot;vpc&quot; &#123;  name_regex = &quot;^AVeryImportantVpc&quot;&#125;data &quot;ucloud_subnets&quot; dmz_subnet &#123;  vpc_id     = data.ucloud_vpcs.vpc.vpcs[0].id  name_regex = &quot;^DMZ&quot;&#125;data &quot;ucloud_subnets&quot; &quot;db_subnet&quot; &#123;  vpc_id     = data.ucloud_vpcs.vpc.vpcs[0].id  name_regex = &quot;^DataBase&quot;&#125;module &quot;machine&quot; &#123;  source         = &quot;./machine&quot;  network_config = &#123;    vpc_id         = data.ucloud_vpcs.vpc.vpcs[0].id    web_app_config = &#123;      az        = &quot;cn-bj2-02&quot;      subnet_id = data.ucloud_subnets.dmz_subnet.subnets[0].id    &#125;    db_config      = &#123;      az        = &quot;cn-bj2-02&quot;      subnet_id = data.ucloud_subnets.db_subnet.subnets[0].id    &#125;  &#125;&#125;\n由于模块代码中对网络层的定义是抽象的，并没有指定必须是 resource 或是 data，所以使得模块的调用者可以自己决定如何构造模块的依赖层，作为参数注入模块。\n\n1.9.3.1. 多可用区分布\n\n\n1.9.3.1. 多可用区分布\n这是一个相当常见的小技巧。多数公有云为了高可用性，都在单一区域内提供了多可用区的设计。一个可区是一个逻辑上的数据中心，单个可用区可能由于各种自然灾害、网络故障而导致不可用，所以公有云应用部署高可用应用应时刻考虑跨可用区设计。\n假如我们想要创建 N 台不同的云主机实例，在 Terraform 0.12 之前的版本中，我们只能用 count 配合模运算来达成这个目的\n12345678910111213141516171819202122232425variable &quot;az&quot; &#123;  type    = list(string)  default = [    &quot;cn-bj2-03&quot;,    &quot;cn-bj2-04&quot;,  ]&#125;variable &quot;instance_count&quot; &#123;  type    = number  default = 4&#125;data &quot;ucloud_images&quot; &quot;centos&quot; &#123;  name_regex = &quot;^CentOS 7&quot;&#125;resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;  count             = var.instance_count  availability_zone = var.az[count.index % length(var.az)]  image_id          = data.ucloud_images.centos.images[0].id  instance_type     = &quot;n-standard-1&quot;  charge_type       = &quot;dynamic&quot;  name              = &quot;$&#123;var.az[count.index % length(var.az)]&#125;-$&#123;floor(count.index/length(var.az))&#125;&quot;&#125;\n简单来说就是使用 count 创建多实例资源时，用 var.az[count.index % length(var.az)] 可以循环使用每个可用区，使得机器尽可能均匀分布在各个可用区。\n12345678910111213141516171819202122$ terraform apply -auto-approvedata.ucloud_images.centos: Refreshing state...ucloud_instance.web[2]: Creating...ucloud_instance.web[0]: Creating...ucloud_instance.web[1]: Creating...ucloud_instance.web[3]: Creating...ucloud_instance.web[2]: Still creating... [10s elapsed]ucloud_instance.web[0]: Still creating... [10s elapsed]ucloud_instance.web[1]: Still creating... [10s elapsed]ucloud_instance.web[3]: Still creating... [10s elapsed]ucloud_instance.web[2]: Still creating... [20s elapsed]ucloud_instance.web[0]: Still creating... [20s elapsed]ucloud_instance.web[1]: Still creating... [20s elapsed]ucloud_instance.web[3]: Still creating... [20s elapsed]ucloud_instance.web[2]: Creation complete after 22s [id=uhost-txa2owrp]ucloud_instance.web[3]: Creation complete after 24s [id=uhost-v3qxdbju]ucloud_instance.web[1]: Creation complete after 26s [id=uhost-td3x545p]ucloud_instance.web[0]: Still creating... [30s elapsed]ucloud_instance.web[0]: Still creating... [40s elapsed]ucloud_instance.web[0]: Creation complete after 43s [id=uhost-scq1prqj]Apply complete! Resources: 4 added, 0 changed, 0 destroyed.\n我们可以看一下创建的主机信息：\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288$ terraform show# data.ucloud_images.centos:data &quot;ucloud_images&quot; &quot;centos&quot; &#123;    id          = &quot;475496684&quot;    ids         = [        &quot;uimage-22noyd&quot;,        &quot;uimage-3p0wg0&quot;,        &quot;uimage-4keil1&quot;,        &quot;uimage-aqvo5l&quot;,        &quot;uimage-f1chxn&quot;,        &quot;uimage-hq5elw&quot;,        &quot;uimage-rkn1v2&quot;,    ]    images      = [        &#123;            availability_zone = &quot;cn-bj2-02&quot;            create_time       = &quot;2019-04-23T17:39:46+08:00&quot;            description       = &quot;&quot;            features          = [                &quot;NetEnhanced&quot;,                &quot;HotPlug&quot;,            ]            id                = &quot;uimage-rkn1v2&quot;            name              = &quot;CentOS 7.0 64位&quot;            os_name           = &quot;CentOS 7.0 64位&quot;            os_type           = &quot;linux&quot;            size              = 20            status            = &quot;Available&quot;            type              = &quot;base&quot;        &#125;,        &#123;            availability_zone = &quot;cn-bj2-02&quot;            create_time       = &quot;2019-04-16T21:05:03+08:00&quot;            description       = &quot;&quot;            features          = [                &quot;NetEnhanced&quot;,                &quot;HotPlug&quot;,            ]            id                = &quot;uimage-f1chxn&quot;            name              = &quot;CentOS 7.2 64位&quot;            os_name           = &quot;CentOS 7.2 64位&quot;            os_type           = &quot;linux&quot;            size              = 20            status            = &quot;Available&quot;            type              = &quot;base&quot;        &#125;,        &#123;            availability_zone = &quot;cn-bj2-02&quot;            create_time       = &quot;2019-09-09T11:40:31+08:00&quot;            description       = &quot; &quot;            features          = [                &quot;NetEnhanced&quot;,                &quot;HotPlug&quot;,            ]            id                = &quot;uimage-aqvo5l&quot;            name              = &quot;CentOS 7.4 64位&quot;            os_name           = &quot;CentOS 7.4 64位&quot;            os_type           = &quot;linux&quot;            size              = 20            status            = &quot;Available&quot;            type              = &quot;base&quot;        &#125;,        &#123;            availability_zone = &quot;cn-bj2-02&quot;            create_time       = &quot;2020-05-07T17:40:42+08:00&quot;            description       = &quot;&quot;            features          = [                &quot;NetEnhanced&quot;,                &quot;HotPlug&quot;,                &quot;CloudInit&quot;,            ]            id                = &quot;uimage-hq5elw&quot;            name              = &quot;CentOS 7.6 64位&quot;            os_name           = &quot;CentOS 7.6 64位&quot;            os_type           = &quot;linux&quot;            size              = 20            status            = &quot;Available&quot;            type              = &quot;base&quot;        &#125;,        &#123;            availability_zone = &quot;cn-bj2-02&quot;            create_time       = &quot;2019-04-16T21:05:05+08:00&quot;            description       = &quot;&quot;            features          = [                &quot;NetEnhanced&quot;,                &quot;HotPlug&quot;,            ]            id                = &quot;uimage-3p0wg0&quot;            name              = &quot;CentOS 7.3 64位&quot;            os_name           = &quot;CentOS 7.3 64位&quot;            os_type           = &quot;linux&quot;            size              = 20            status            = &quot;Available&quot;            type              = &quot;base&quot;        &#125;,        &#123;            availability_zone = &quot;cn-bj2-02&quot;            create_time       = &quot;2019-04-16T21:05:02+08:00&quot;            description       = &quot;&quot;            features          = [                &quot;NetEnhanced&quot;,                &quot;HotPlug&quot;,            ]            id                = &quot;uimage-4keil1&quot;            name              = &quot;CentOS 7.1 64位&quot;            os_name           = &quot;CentOS 7.1 64位&quot;            os_type           = &quot;linux&quot;            size              = 20            status            = &quot;Available&quot;            type              = &quot;base&quot;        &#125;,        &#123;            availability_zone = &quot;cn-bj2-02&quot;            create_time       = &quot;2019-04-16T21:04:53+08:00&quot;            description       = &quot;&quot;            features          = [                &quot;NetEnhanced&quot;,                &quot;HotPlug&quot;,            ]            id                = &quot;uimage-22noyd&quot;            name              = &quot;CentOS 7.5 64位&quot;            os_name           = &quot;CentOS 7.5 64位&quot;            os_type           = &quot;linux&quot;            size              = 20            status            = &quot;Available&quot;            type              = &quot;base&quot;        &#125;,    ]    most_recent = false    name_regex  = &quot;^CentOS 7&quot;    total_count = 7&#125;# ucloud_instance.web[1]:resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;    auto_renew        = true    availability_zone = &quot;cn-bj2-04&quot;    boot_disk_size    = 20    boot_disk_type    = &quot;local_normal&quot;    charge_type       = &quot;dynamic&quot;    cpu               = 1    cpu_platform      = &quot;Intel/Broadwell&quot;    create_time       = &quot;2020-11-28T23:09:04+08:00&quot;    disk_set          = [        &#123;            id      = &quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;            is_boot = true            size    = 20            type    = &quot;local_normal&quot;        &#125;,    ]    expire_time       = &quot;2020-11-29T00:09:06+08:00&quot;    id                = &quot;uhost-td3x545p&quot;    image_id          = &quot;uimage-dhe5m2&quot;    instance_type     = &quot;n-standard-1&quot;    ip_set            = [        &#123;            internet_type = &quot;Private&quot;            ip            = &quot;10.9.44.37&quot;        &#125;,    ]    memory            = 4    name              = &quot;cn-bj2-04-0&quot;    private_ip        = &quot;10.9.44.37&quot;    root_password     = (sensitive value)    security_group    = &quot;firewall-juhsrlvr&quot;    status            = &quot;Running&quot;    subnet_id         = &quot;subnet-dtu3dgpr&quot;    tag               = &quot;Default&quot;    vpc_id            = &quot;uvnet-f1c3jq2b&quot;&#125;# ucloud_instance.web[2]:resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;    auto_renew        = true    availability_zone = &quot;cn-bj2-03&quot;    boot_disk_size    = 20    boot_disk_type    = &quot;local_normal&quot;    charge_type       = &quot;dynamic&quot;    cpu               = 1    cpu_platform      = &quot;Intel/IvyBridge&quot;    create_time       = &quot;2020-11-28T23:09:01+08:00&quot;    disk_set          = [        &#123;            id      = &quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;            is_boot = true            size    = 20            type    = &quot;local_normal&quot;        &#125;,    ]    expire_time       = &quot;2020-11-29T00:09:02+08:00&quot;    id                = &quot;uhost-txa2owrp&quot;    image_id          = &quot;uimage-pxplaj&quot;    instance_type     = &quot;n-standard-1&quot;    ip_set            = [        &#123;            internet_type = &quot;Private&quot;            ip            = &quot;10.9.45.234&quot;        &#125;,    ]    memory            = 4    name              = &quot;cn-bj2-03-1&quot;    private_ip        = &quot;10.9.45.234&quot;    root_password     = (sensitive value)    security_group    = &quot;firewall-juhsrlvr&quot;    status            = &quot;Running&quot;    subnet_id         = &quot;subnet-dtu3dgpr&quot;    tag               = &quot;Default&quot;    vpc_id            = &quot;uvnet-f1c3jq2b&quot;&#125;# ucloud_instance.web[3]:resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;    auto_renew        = true    availability_zone = &quot;cn-bj2-04&quot;    boot_disk_size    = 20    boot_disk_type    = &quot;local_normal&quot;    charge_type       = &quot;dynamic&quot;    cpu               = 1    cpu_platform      = &quot;Intel/Broadwell&quot;    create_time       = &quot;2020-11-28T23:09:04+08:00&quot;    disk_set          = [        &#123;            id      = &quot;31e2cad6-79a1-4475-a9f5-2c5c95605b18&quot;            is_boot = true            size    = 20            type    = &quot;local_normal&quot;        &#125;,    ]    expire_time       = &quot;2020-11-29T00:09:04+08:00&quot;    id                = &quot;uhost-v3qxdbju&quot;    image_id          = &quot;uimage-dhe5m2&quot;    instance_type     = &quot;n-standard-1&quot;    ip_set            = [        &#123;            internet_type = &quot;Private&quot;            ip            = &quot;10.9.85.40&quot;        &#125;,    ]    memory            = 4    name              = &quot;cn-bj2-04-1&quot;    private_ip        = &quot;10.9.85.40&quot;    root_password     = (sensitive value)    security_group    = &quot;firewall-juhsrlvr&quot;    status            = &quot;Running&quot;    subnet_id         = &quot;subnet-dtu3dgpr&quot;    tag               = &quot;Default&quot;    vpc_id            = &quot;uvnet-f1c3jq2b&quot;&#125;# ucloud_instance.web[0]:resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;    auto_renew        = true    availability_zone = &quot;cn-bj2-03&quot;    boot_disk_size    = 20    boot_disk_type    = &quot;local_normal&quot;    charge_type       = &quot;dynamic&quot;    cpu               = 1    cpu_platform      = &quot;Intel/IvyBridge&quot;    create_time       = &quot;2020-11-28T23:09:04+08:00&quot;    disk_set          = [        &#123;            id      = &quot;da27595d-9645-4883-bf95-87b9076ab7e4&quot;            is_boot = true            size    = 20            type    = &quot;local_normal&quot;        &#125;,    ]    expire_time       = &quot;2020-11-29T00:09:04+08:00&quot;    id                = &quot;uhost-scq1prqj&quot;    image_id          = &quot;uimage-pxplaj&quot;    instance_type     = &quot;n-standard-1&quot;    ip_set            = [        &#123;            internet_type = &quot;Private&quot;            ip            = &quot;10.9.107.152&quot;        &#125;,    ]    memory            = 4    name              = &quot;cn-bj2-03-0&quot;    private_ip        = &quot;10.9.107.152&quot;    root_password     = (sensitive value)    security_group    = &quot;firewall-juhsrlvr&quot;    status            = &quot;Running&quot;    subnet_id         = &quot;subnet-dtu3dgpr&quot;    tag               = &quot;Default&quot;    vpc_id            = &quot;uvnet-f1c3jq2b&quot;&#125;\n可以看到，主机的确是均匀地分散在两个可用区了。\n但是这样做在调整可用区时会发生大问题，例如：\n1234567variable &quot;az&quot; &#123;  type = list(string)  default = [    &quot;cn-bj2-03&quot;,#    &quot;cn-bj2-04&quot;,  ]&#125;\n我们禁用了 cn-bj2-04 可用区，按道理我们期待的变更计划应该是将两台原本属于 cn-bj2-04 的主机删除，在 cn-bj2-03 可用区新增两台主机。让我们看看会发生什么：\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152$ terraform planRefreshing Terraform state in-memory prior to plan...The refreshed state will be used to calculate this plan, but will not bepersisted to local or remote state storage.data.ucloud_images.centos: Refreshing state... [id=475496684]ucloud_instance.web[0]: Refreshing state... [id=uhost-scq1prqj]ucloud_instance.web[3]: Refreshing state... [id=uhost-v3qxdbju]ucloud_instance.web[2]: Refreshing state... [id=uhost-txa2owrp]ucloud_instance.web[1]: Refreshing state... [id=uhost-td3x545p]------------------------------------------------------------------------An execution plan has been generated and is shown below.Resource actions are indicated with the following symbols:  ~ update in-place-/+ destroy and then create replacementTerraform will perform the following actions:  # ucloud_instance.web[1] must be replaced-/+ resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;      ~ auto_renew        = true -&gt; (known after apply)      ~ availability_zone = &quot;cn-bj2-04&quot; -&gt; &quot;cn-bj2-03&quot; # forces replacement      ~ boot_disk_size    = 20 -&gt; (known after apply)      ~ boot_disk_type    = &quot;local_normal&quot; -&gt; (known after apply)        charge_type       = &quot;dynamic&quot;      ~ cpu               = 1 -&gt; (known after apply)      ~ cpu_platform      = &quot;Intel/Broadwell&quot; -&gt; (known after apply)      ~ create_time       = &quot;2020-11-28T23:09:04+08:00&quot; -&gt; (known after apply)      + data_disk_size    = (known after apply)      + data_disk_type    = (known after apply)      ~ disk_set          = [          - &#123;              - id      = &quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;              - is_boot = true              - size    = 20              - type    = &quot;local_normal&quot;            &#125;,        ] -&gt; (known after apply)      ~ expire_time       = &quot;2020-11-29T00:09:06+08:00&quot; -&gt; (known after apply)      ~ id                = &quot;uhost-td3x545p&quot; -&gt; (known after apply)      ~ image_id          = &quot;uimage-dhe5m2&quot; -&gt; &quot;uimage-rkn1v2&quot;        instance_type     = &quot;n-standard-1&quot;      ~ ip_set            = [          - &#123;              - internet_type = &quot;Private&quot;              - ip            = &quot;10.9.44.37&quot;            &#125;,        ] -&gt; (known after apply)      + isolation_group   = (known after apply)      ~ memory            = 4 -&gt; (known after apply)      ~ name              = &quot;cn-bj2-04-0&quot; -&gt; &quot;cn-bj2-03-1&quot;      ~ private_ip        = &quot;10.9.44.37&quot; -&gt; (known after apply)      + remark            = (known after apply)      ~ root_password     = (sensitive value)      ~ security_group    = &quot;firewall-juhsrlvr&quot; -&gt; (known after apply)      ~ status            = &quot;Running&quot; -&gt; (known after apply)      ~ subnet_id         = &quot;subnet-dtu3dgpr&quot; -&gt; (known after apply)        tag               = &quot;Default&quot;      ~ vpc_id            = &quot;uvnet-f1c3jq2b&quot; -&gt; (known after apply)    &#125;  # ucloud_instance.web[2] will be updated in-place  ~ resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;        auto_renew        = true        availability_zone = &quot;cn-bj2-03&quot;        boot_disk_size    = 20        boot_disk_type    = &quot;local_normal&quot;        charge_type       = &quot;dynamic&quot;        cpu               = 1        cpu_platform      = &quot;Intel/IvyBridge&quot;        create_time       = &quot;2020-11-28T23:09:01+08:00&quot;        disk_set          = [            &#123;                id      = &quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;                is_boot = true                size    = 20                type    = &quot;local_normal&quot;            &#125;,        ]        expire_time       = &quot;2020-11-29T00:09:02+08:00&quot;        id                = &quot;uhost-txa2owrp&quot;        image_id          = &quot;uimage-pxplaj&quot;        instance_type     = &quot;n-standard-1&quot;        ip_set            = [            &#123;                internet_type = &quot;Private&quot;                ip            = &quot;10.9.45.234&quot;            &#125;,        ]        memory            = 4      ~ name              = &quot;cn-bj2-03-1&quot; -&gt; &quot;cn-bj2-03-2&quot;        private_ip        = &quot;10.9.45.234&quot;        root_password     = (sensitive value)        security_group    = &quot;firewall-juhsrlvr&quot;        status            = &quot;Running&quot;        subnet_id         = &quot;subnet-dtu3dgpr&quot;        tag               = &quot;Default&quot;        vpc_id            = &quot;uvnet-f1c3jq2b&quot;    &#125;  # ucloud_instance.web[3] must be replaced-/+ resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;      ~ auto_renew        = true -&gt; (known after apply)      ~ availability_zone = &quot;cn-bj2-04&quot; -&gt; &quot;cn-bj2-03&quot; # forces replacement      ~ boot_disk_size    = 20 -&gt; (known after apply)      ~ boot_disk_type    = &quot;local_normal&quot; -&gt; (known after apply)        charge_type       = &quot;dynamic&quot;      ~ cpu               = 1 -&gt; (known after apply)      ~ cpu_platform      = &quot;Intel/Broadwell&quot; -&gt; (known after apply)      ~ create_time       = &quot;2020-11-28T23:09:04+08:00&quot; -&gt; (known after apply)      + data_disk_size    = (known after apply)      + data_disk_type    = (known after apply)      ~ disk_set          = [          - &#123;              - id      = &quot;31e2cad6-79a1-4475-a9f5-2c5c95605b18&quot;              - is_boot = true              - size    = 20              - type    = &quot;local_normal&quot;            &#125;,        ] -&gt; (known after apply)      ~ expire_time       = &quot;2020-11-29T00:09:04+08:00&quot; -&gt; (known after apply)      ~ id                = &quot;uhost-v3qxdbju&quot; -&gt; (known after apply)      ~ image_id          = &quot;uimage-dhe5m2&quot; -&gt; &quot;uimage-rkn1v2&quot;        instance_type     = &quot;n-standard-1&quot;      ~ ip_set            = [          - &#123;              - internet_type = &quot;Private&quot;              - ip            = &quot;10.9.85.40&quot;            &#125;,        ] -&gt; (known after apply)      + isolation_group   = (known after apply)      ~ memory            = 4 -&gt; (known after apply)      ~ name              = &quot;cn-bj2-04-1&quot; -&gt; &quot;cn-bj2-03-3&quot;      ~ private_ip        = &quot;10.9.85.40&quot; -&gt; (known after apply)      + remark            = (known after apply)      ~ root_password     = (sensitive value)      ~ security_group    = &quot;firewall-juhsrlvr&quot; -&gt; (known after apply)      ~ status            = &quot;Running&quot; -&gt; (known after apply)      ~ subnet_id         = &quot;subnet-dtu3dgpr&quot; -&gt; (known after apply)        tag               = &quot;Default&quot;      ~ vpc_id            = &quot;uvnet-f1c3jq2b&quot; -&gt; (known after apply)    &#125;Plan: 2 to add, 1 to change, 2 to destroy.------------------------------------------------------------------------Note: You didn&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraformcan&#x27;t guarantee that exactly these actions will be performed if&quot;terraform apply&quot; is subsequently run.\n变更计划与期望略有不同。我们仔细看细节：\n1234567891011121314151617181920212223242526272829303132333435363738# ucloud_instance.web[2] will be updated in-place~ resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;      auto_renew        = true      availability_zone = &quot;cn-bj2-03&quot;      boot_disk_size    = 20      boot_disk_type    = &quot;local_normal&quot;      charge_type       = &quot;dynamic&quot;      cpu               = 1      cpu_platform      = &quot;Intel/IvyBridge&quot;      create_time       = &quot;2020-11-28T23:09:01+08:00&quot;      disk_set          = [          &#123;              id      = &quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;              is_boot = true              size    = 20              type    = &quot;local_normal&quot;          &#125;,      ]      expire_time       = &quot;2020-11-29T00:09:02+08:00&quot;      id                = &quot;uhost-txa2owrp&quot;      image_id          = &quot;uimage-pxplaj&quot;      instance_type     = &quot;n-standard-1&quot;      ip_set            = [          &#123;              internet_type = &quot;Private&quot;              ip            = &quot;10.9.45.234&quot;          &#125;,      ]      memory            = 4    ~ name              = &quot;cn-bj2-03-1&quot; -&gt; &quot;cn-bj2-03-2&quot;      private_ip        = &quot;10.9.45.234&quot;      root_password     = (sensitive value)      security_group    = &quot;firewall-juhsrlvr&quot;      status            = &quot;Running&quot;      subnet_id         = &quot;subnet-dtu3dgpr&quot;      tag               = &quot;Default&quot;      vpc_id            = &quot;uvnet-f1c3jq2b&quot;  &#125;\n原本名为 cn-bj2-03-1 的主机被更名为 cn-bj2-03-2 了，原本属于 cn-bj2-04 的第一台主机的变更计划是：\n123456789101112131415161718192021222324252627282930313233343536373839404142  # ucloud_instance.web[1] must be replaced-/+ resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;      ~ auto_renew        = true -&gt; (known after apply)      ~ availability_zone = &quot;cn-bj2-04&quot; -&gt; &quot;cn-bj2-03&quot; # forces replacement      ~ boot_disk_size    = 20 -&gt; (known after apply)      ~ boot_disk_type    = &quot;local_normal&quot; -&gt; (known after apply)        charge_type       = &quot;dynamic&quot;      ~ cpu               = 1 -&gt; (known after apply)      ~ cpu_platform      = &quot;Intel/Broadwell&quot; -&gt; (known after apply)      ~ create_time       = &quot;2020-11-28T23:09:04+08:00&quot; -&gt; (known after apply)      + data_disk_size    = (known after apply)      + data_disk_type    = (known after apply)      ~ disk_set          = [          - &#123;              - id      = &quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;              - is_boot = true              - size    = 20              - type    = &quot;local_normal&quot;            &#125;,        ] -&gt; (known after apply)      ~ expire_time       = &quot;2020-11-29T00:09:06+08:00&quot; -&gt; (known after apply)      ~ id                = &quot;uhost-td3x545p&quot; -&gt; (known after apply)      ~ image_id          = &quot;uimage-dhe5m2&quot; -&gt; &quot;uimage-rkn1v2&quot;        instance_type     = &quot;n-standard-1&quot;      ~ ip_set            = [          - &#123;              - internet_type = &quot;Private&quot;              - ip            = &quot;10.9.44.37&quot;            &#125;,        ] -&gt; (known after apply)      + isolation_group   = (known after apply)      ~ memory            = 4 -&gt; (known after apply)      ~ name              = &quot;cn-bj2-04-0&quot; -&gt; &quot;cn-bj2-03-1&quot;      ~ private_ip        = &quot;10.9.44.37&quot; -&gt; (known after apply)      + remark            = (known after apply)      ~ root_password     = (sensitive value)      ~ security_group    = &quot;firewall-juhsrlvr&quot; -&gt; (known after apply)      ~ status            = &quot;Running&quot; -&gt; (known after apply)      ~ subnet_id         = &quot;subnet-dtu3dgpr&quot; -&gt; (known after apply)        tag               = &quot;Default&quot;      ~ vpc_id            = &quot;uvnet-f1c3jq2b&quot; -&gt; (known after apply)    &#125;\n它的名字从 cn-bj2-04-0 变成了 cn-bj2-03-1。\n仔细想想，实际上这是一个比较低效的变更计划。原本属于 cn-bj2-03 的两台主机应该不做任何变更，只需要删除 cn-bj2-04 的主机，再补充两台 cn-bj2-03 的主机即可。这是因为我们使用的是 count，而 count 只看元素在列表中的序号。当我们删除一个可用区时，实际上会引起主机序号的重大变化，导致出现大量低效的变更，这就是我们在讲 count 与 for_each 时强调过的，如果创建的资源实例彼此之间几乎完全一致，那么 count 比较合适。否则，那么使用 for_each 会更加安全。\n让我们尝试使用 for_each 改写这段逻辑：\n1234567891011121314151617181920212223242526272829variable &quot;az&quot; &#123;  type    = list(string)  default = [    &quot;cn-bj2-03&quot;,    &quot;cn-bj2-04&quot;,  ]&#125;variable &quot;instance_count&quot; &#123;  type    = number  default = 4&#125;locals &#123;  instance_names = [for i in range(var.instance_count):&quot;$&#123;var.az[i%length(var.az)]&#125;-$&#123;floor(i/length(var.az))&#125;&quot;]&#125;data &quot;ucloud_images&quot; &quot;centos&quot; &#123;  name_regex = &quot;^CentOS 7&quot;&#125;resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;  for_each          = toset(local.instance_names)  name              = each.value  availability_zone = var.az[index(local.instance_names, each.value) % length(var.az)]  image_id          = data.ucloud_images.centos.images[0].id  instance_type     = &quot;n-standard-1&quot;  charge_type       = &quot;dynamic&quot;&#125;\n为了生成主机独一无二的名字，我们首先用 range 函数生成了一个序号集合，比如目标主机数是 4，那么 range(4) 的结果就是 [0, 1, 2, 3]；然后我们通过取模运算使得名字前缀在可用区列表之间循环递增，最后用 floor(i/length(var.az)) 计算出当前序号对应在当前可用区是第几台。例如 4 号主机在第二个可用区就是第二台，生成的名字应该就是 cn-bj-04-1。\n执行结果是：\n12345678910111213141516171819202122$ terraform apply -auto-approvedata.ucloud_images.centos: Refreshing state...ucloud_instance.web[&quot;cn-bj2-03-1&quot;]: Creating...ucloud_instance.web[&quot;cn-bj2-03-0&quot;]: Creating...ucloud_instance.web[&quot;cn-bj2-04-0&quot;]: Creating...ucloud_instance.web[&quot;cn-bj2-04-1&quot;]: Creating...ucloud_instance.web[&quot;cn-bj2-03-1&quot;]: Still creating... [10s elapsed]ucloud_instance.web[&quot;cn-bj2-03-0&quot;]: Still creating... [10s elapsed]ucloud_instance.web[&quot;cn-bj2-04-0&quot;]: Still creating... [10s elapsed]ucloud_instance.web[&quot;cn-bj2-04-1&quot;]: Still creating... [10s elapsed]ucloud_instance.web[&quot;cn-bj2-03-1&quot;]: Still creating... [20s elapsed]ucloud_instance.web[&quot;cn-bj2-03-0&quot;]: Still creating... [20s elapsed]ucloud_instance.web[&quot;cn-bj2-04-0&quot;]: Still creating... [20s elapsed]ucloud_instance.web[&quot;cn-bj2-04-1&quot;]: Still creating... [20s elapsed]ucloud_instance.web[&quot;cn-bj2-04-1&quot;]: Creation complete after 21s [id=uhost-fjci1i4o]ucloud_instance.web[&quot;cn-bj2-04-0&quot;]: Creation complete after 23s [id=uhost-bkkhmref]ucloud_instance.web[&quot;cn-bj2-03-1&quot;]: Creation complete after 26s [id=uhost-amosgdaa]ucloud_instance.web[&quot;cn-bj2-03-0&quot;]: Still creating... [30s elapsed]ucloud_instance.web[&quot;cn-bj2-03-0&quot;]: Still creating... [40s elapsed]ucloud_instance.web[&quot;cn-bj2-03-0&quot;]: Creation complete after 45s [id=uhost-kltudgnf]Apply complete! Resources: 4 added, 0 changed, 0 destroyed.\n如果我们去掉一个可用区：\n1234567variable &quot;az&quot; &#123;  type = list(string)  default = [    &quot;cn-bj2-03&quot;,#    &quot;cn-bj2-04&quot;,  ]&#125;\n我们可以检查一下执行计划：\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167$ terraform planRefreshing Terraform state in-memory prior to plan...The refreshed state will be used to calculate this plan, but will not bepersisted to local or remote state storage.data.ucloud_images.centos: Refreshing state... [id=475496684]ucloud_instance.web[&quot;cn-bj2-03-1&quot;]: Refreshing state... [id=uhost-amosgdaa]ucloud_instance.web[&quot;cn-bj2-04-0&quot;]: Refreshing state... [id=uhost-bkkhmref]ucloud_instance.web[&quot;cn-bj2-03-0&quot;]: Refreshing state... [id=uhost-kltudgnf]ucloud_instance.web[&quot;cn-bj2-04-1&quot;]: Refreshing state... [id=uhost-fjci1i4o]------------------------------------------------------------------------An execution plan has been generated and is shown below.Resource actions are indicated with the following symbols:  + create  - destroyTerraform will perform the following actions:  # ucloud_instance.web[&quot;cn-bj2-03-2&quot;] will be created  + resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;      + auto_renew        = (known after apply)      + availability_zone = &quot;cn-bj2-03&quot;      + boot_disk_size    = (known after apply)      + boot_disk_type    = (known after apply)      + charge_type       = &quot;dynamic&quot;      + cpu               = (known after apply)      + cpu_platform      = (known after apply)      + create_time       = (known after apply)      + data_disk_size    = (known after apply)      + data_disk_type    = (known after apply)      + disk_set          = (known after apply)      + expire_time       = (known after apply)      + id                = (known after apply)      + image_id          = &quot;uimage-rkn1v2&quot;      + instance_type     = &quot;n-standard-1&quot;      + ip_set            = (known after apply)      + isolation_group   = (known after apply)      + memory            = (known after apply)      + name              = &quot;cn-bj2-03-2&quot;      + private_ip        = (known after apply)      + remark            = (known after apply)      + root_password     = (sensitive value)      + security_group    = (known after apply)      + status            = (known after apply)      + subnet_id         = (known after apply)      + tag               = &quot;Default&quot;      + vpc_id            = (known after apply)    &#125;  # ucloud_instance.web[&quot;cn-bj2-03-3&quot;] will be created  + resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;      + auto_renew        = (known after apply)      + availability_zone = &quot;cn-bj2-03&quot;      + boot_disk_size    = (known after apply)      + boot_disk_type    = (known after apply)      + charge_type       = &quot;dynamic&quot;      + cpu               = (known after apply)      + cpu_platform      = (known after apply)      + create_time       = (known after apply)      + data_disk_size    = (known after apply)      + data_disk_type    = (known after apply)      + disk_set          = (known after apply)      + expire_time       = (known after apply)      + id                = (known after apply)      + image_id          = &quot;uimage-rkn1v2&quot;      + instance_type     = &quot;n-standard-1&quot;      + ip_set            = (known after apply)      + isolation_group   = (known after apply)      + memory            = (known after apply)      + name              = &quot;cn-bj2-03-3&quot;      + private_ip        = (known after apply)      + remark            = (known after apply)      + root_password     = (sensitive value)      + security_group    = (known after apply)      + status            = (known after apply)      + subnet_id         = (known after apply)      + tag               = &quot;Default&quot;      + vpc_id            = (known after apply)    &#125;  # ucloud_instance.web[&quot;cn-bj2-04-0&quot;] will be destroyed  - resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;      - auto_renew        = true -&gt; null      - availability_zone = &quot;cn-bj2-04&quot; -&gt; null      - boot_disk_size    = 20 -&gt; null      - boot_disk_type    = &quot;local_normal&quot; -&gt; null      - charge_type       = &quot;dynamic&quot; -&gt; null      - cpu               = 1 -&gt; null      - cpu_platform      = &quot;Intel/Broadwell&quot; -&gt; null      - create_time       = &quot;2020-11-28T22:35:53+08:00&quot; -&gt; null      - disk_set          = [          - &#123;              - id      = &quot;b214d840-ffec-4958-a3da-3580846fd2a3&quot;              - is_boot = true              - size    = 20              - type    = &quot;local_normal&quot;            &#125;,        ] -&gt; null      - expire_time       = &quot;2020-11-28T23:35:53+08:00&quot; -&gt; null      - id                = &quot;uhost-bkkhmref&quot; -&gt; null      - image_id          = &quot;uimage-dhe5m2&quot; -&gt; null      - instance_type     = &quot;n-standard-1&quot; -&gt; null      - ip_set            = [          - &#123;              - internet_type = &quot;Private&quot;              - ip            = &quot;10.9.48.82&quot;            &#125;,        ] -&gt; null      - memory            = 4 -&gt; null      - name              = &quot;cn-bj2-04-0&quot; -&gt; null      - private_ip        = &quot;10.9.48.82&quot; -&gt; null      - root_password     = (sensitive value)      - security_group    = &quot;firewall-juhsrlvr&quot; -&gt; null      - status            = &quot;Running&quot; -&gt; null      - subnet_id         = &quot;subnet-dtu3dgpr&quot; -&gt; null      - tag               = &quot;Default&quot; -&gt; null      - vpc_id            = &quot;uvnet-f1c3jq2b&quot; -&gt; null    &#125;  # ucloud_instance.web[&quot;cn-bj2-04-1&quot;] will be destroyed  - resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;      - auto_renew        = true -&gt; null      - availability_zone = &quot;cn-bj2-04&quot; -&gt; null      - boot_disk_size    = 20 -&gt; null      - boot_disk_type    = &quot;local_normal&quot; -&gt; null      - charge_type       = &quot;dynamic&quot; -&gt; null      - cpu               = 1 -&gt; null      - cpu_platform      = &quot;Intel/Broadwell&quot; -&gt; null      - create_time       = &quot;2020-11-28T22:35:53+08:00&quot; -&gt; null      - disk_set          = [          - &#123;              - id      = &quot;6a3f274f-e072-4a46-90f8-edc7dbaa27f7&quot;              - is_boot = true              - size    = 20              - type    = &quot;local_normal&quot;            &#125;,        ] -&gt; null      - expire_time       = &quot;2020-11-28T23:35:53+08:00&quot; -&gt; null      - id                = &quot;uhost-fjci1i4o&quot; -&gt; null      - image_id          = &quot;uimage-dhe5m2&quot; -&gt; null      - instance_type     = &quot;n-standard-1&quot; -&gt; null      - ip_set            = [          - &#123;              - internet_type = &quot;Private&quot;              - ip            = &quot;10.9.176.28&quot;            &#125;,        ] -&gt; null      - memory            = 4 -&gt; null      - name              = &quot;cn-bj2-04-1&quot; -&gt; null      - private_ip        = &quot;10.9.176.28&quot; -&gt; null      - root_password     = (sensitive value)      - security_group    = &quot;firewall-juhsrlvr&quot; -&gt; null      - status            = &quot;Running&quot; -&gt; null      - subnet_id         = &quot;subnet-dtu3dgpr&quot; -&gt; null      - tag               = &quot;Default&quot; -&gt; null      - vpc_id            = &quot;uvnet-f1c3jq2b&quot; -&gt; null    &#125;Plan: 2 to add, 0 to change, 2 to destroy.------------------------------------------------------------------------Note: You didn&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraformcan&#x27;t guarantee that exactly these actions will be performed if&quot;terraform apply&quot; is subsequently run.\n可以看到，原来属于 cn-bj2-03 的两台主机原封不动，删除了属于 cn-bj2-04 的两台主机，并且在 cn-bj2-03 可用区新增两台主机。\n\n1.9.4.1. provisioner 与 user_data\n\n\n1.9.4.1. provisioner 与 user_data\n我们在介绍资源时介绍了预置器 provisioner。同时不少公有云厂商的虚拟机都提供了 cloud-init 功能，可以让我们在虚拟机实例第一次启动时执行一段自定义的脚本来执行一些初始化操作。例如我们在Terraform 初步体验一章里举的例子，在 UCloud 主机第一次启动时我们通过 user_data 来调用 yum 安装并配置了 ngnix 服务。预置器与 cloud-init 都可以用于初始化虚拟机，那么我们应该用哪一种呢？\n首先要指出的是，provisioner 的官方文档里明确指出，由于预置器内部的行为 Terraform 无法感知，无法将它执行的变更纳入到声明式的代码管理中，所以预置器应被作为最后的手段使用，那么也就是说，如果 cloud-init 能够满足我们的要求，那么我们应该优先使用 cloud-init。\n但是仍然存在一些 cloud-init 无法满足的场景。例如一个最常见的情况是，比如我们要在 cloud-init 当中格式化卷，后续的所有操作都必须在主机成功格式化并挂载卷之后才能顺利进行下去。但是比如 aws_instance，它的创建是不会等待 user_data 代码执行完成的，只要虚拟机创建成功开始启动，Terraform 就会认为资源创建完成从而继续后续的创建了。\n解决这个问题目前来看还是只能依靠预置器。我们以一段 UCloud 云主机代码为例：\n12345678910111213141516171819202122232425resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;  availability_zone         = &quot;cn-bj2-03&quot;  image_id                  = data.ucloud_images.centos.images[0].id  instance_type             = &quot;n-standard-1&quot;  charge_type               = &quot;dynamic&quot;  network_interface &#123;    eip_internet_type = &quot;bgp&quot;    eip_charge_mode   = &quot;traffic&quot;    eip_bandwidth     = 1  &#125;  delete_eips_with_instance = true  root_password             = var.root_password  provisioner &quot;remote-exec&quot; &#123;    connection &#123;      type     = &quot;ssh&quot;      host     = [for ipset in self.ip_set: ipset.ip if ipset.internet_type==&quot;BGP&quot;][0]      user     = &quot;root&quot;      password = var.root_password      timeout  = &quot;1h&quot;    &#125;    inline = [      &quot;sleep 1h&quot;    ]  &#125;&#125;\n我们在资源声明中附加了一个 remote-exec 类型的预置器，它的 host 取值使用了 self.ip_set，self 在当前上下文中指代 provisioner 所属的 ucloud_instance.web，ip_set 是 ucloud_instance 的一个输出属性，内含云主机的内网 IP 以及绑定的弹性公网 IP 信息。我们用一个 for 表达式过滤出弹性公网 IP 地址，然后使用 ssh 连接。预置器执行的脚本代码很简单，休眠一小时。如果我们执行这段代码：\n12345678910111213141516171819202122232425262728293031323334353637383940$ terraform apply -auto-approvedata.ucloud_images.centos: Refreshing state...ucloud_instance.web: Creating...ucloud_instance.web: Still creating... [10s elapsed]ucloud_instance.web: Still creating... [20s elapsed]ucloud_instance.web: Provisioning with &#x27;remote-exec&#x27;...ucloud_instance.web (remote-exec): Connecting to remote host via SSH...ucloud_instance.web (remote-exec):   Host: 106.75.87.148ucloud_instance.web (remote-exec):   User: rootucloud_instance.web (remote-exec):   Password: trueucloud_instance.web (remote-exec):   Private key: falseucloud_instance.web (remote-exec):   Certificate: falseucloud_instance.web (remote-exec):   SSH Agent: trueucloud_instance.web (remote-exec):   Checking Host Key: falseucloud_instance.web: Still creating... [30s elapsed]ucloud_instance.web (remote-exec): Connecting to remote host via SSH...ucloud_instance.web (remote-exec):   Host: 106.75.87.148ucloud_instance.web (remote-exec):   User: rootucloud_instance.web (remote-exec):   Password: trueucloud_instance.web (remote-exec):   Private key: falseucloud_instance.web (remote-exec):   Certificate: falseucloud_instance.web (remote-exec):   SSH Agent: trueucloud_instance.web (remote-exec):   Checking Host Key: falseucloud_instance.web: Still creating... [40s elapsed]ucloud_instance.web (remote-exec): Connecting to remote host via SSH...ucloud_instance.web (remote-exec):   Host: 106.75.87.148ucloud_instance.web (remote-exec):   User: rootucloud_instance.web (remote-exec):   Password: trueucloud_instance.web (remote-exec):   Private key: falseucloud_instance.web (remote-exec):   Certificate: falseucloud_instance.web (remote-exec):   SSH Agent: trueucloud_instance.web (remote-exec):   Checking Host Key: falseucloud_instance.web (remote-exec): Connected!ucloud_instance.web: Still creating... [50s elapsed]ucloud_instance.web: Still creating... [1m0s elapsed]ucloud_instance.web: Still creating... [1m10s elapsed]ucloud_instance.web: Still creating... [1m20s elapsed]ucloud_instance.web: Still creating... [1m30s elapsed]ucloud_instance.web: Still creating... [1m40s elapsed]...\n不出所料的话，该过程会持续一小时，也就是说，无论预置器脚本中执行的操作耗时多长，ucloud_instance 的创建都会等待它完成，或是触发超时。\n在这里我们可以使用这种方法的前提是我们使用的 UCloud 云主机的资源定义允许我们定义资源时声明 network_interface 属性，直接绑定一个公网 IP。如果我们使用的云厂商 Provider 无法让我们在创建主机时绑定公网 IP，而是必须事后绑定弹性 IP 呢？又或者，初始化脚本必须在云主机成功绑定了云盘之后才能成功运行？这种情况下我们还有最后的武器，就是 null_resource。\nnull_resource 可能是 Terraform 体系中最“不 Terraform”的存在，它就是我们用来在 Terraform 这样一个声明式世界里干各种命令式脏活的工具。null_resouce 本身是一个空的 resource，只有一个名为 triggers 的参数以及 id 作为输出属性。\n我们看下这个例子：\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253data &quot;ucloud_images&quot; &quot;centos&quot; &#123;  name_regex = &quot;^CentOS 7&quot;&#125;resource &quot;ucloud_eip&quot; &quot;eip&quot; &#123;  internet_type = &quot;bgp&quot;  bandwidth     = 1  charge_mode   = &quot;traffic&quot;&#125;resource &quot;ucloud_disk&quot; &quot;data_disk&quot; &#123;  availability_zone = &quot;cn-bj2-03&quot;  disk_size         = 10  charge_type       = &quot;dynamic&quot;  disk_type         = &quot;data_disk&quot;&#125;resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;  availability_zone = &quot;cn-bj2-03&quot;  image_id          = data.ucloud_images.centos.images[0].id  instance_type     = &quot;n-standard-1&quot;  charge_type       = &quot;dynamic&quot;  root_password     = var.root_password&#125;resource &quot;ucloud_eip_association&quot; &quot;eip_association&quot; &#123;  eip_id      = ucloud_eip.eip.id  resource_id = ucloud_instance.web.id&#125;resource &quot;ucloud_disk_attachment&quot; &quot;data_disk&quot; &#123;  availability_zone = &quot;cn-bj2-03&quot;  disk_id           = ucloud_disk.data_disk.id  instance_id       = ucloud_instance.web.id&#125;resource &quot;null_resource&quot; &quot;web_init&quot; &#123;  depends_on = [    ucloud_eip_association.eip_association,    ucloud_disk_attachment.data_disk  ]  provisioner &quot;remote-exec&quot; &#123;    connection &#123;      type     = &quot;ssh&quot;      host     = ucloud_eip.eip.public_ip      user     = &quot;root&quot;      password = var.root_password    &#125;    inline = [      &quot;echo hello&quot;    ]  &#125;&#125;\n我们假设需要远程执行的操纵是必须在云盘挂载成功以后才可以运行的，那么我们可以声明一个 null_resource，把 provisioner 声明放在那里，通过显式声明 depends_on 确保它的执行一定是在云盘挂载结束以后。\n另外这个例子里我们运行的脚本非常简单，考虑一种更加复杂一些的场景，我们运行的脚本是通过文件读取的，我们希望在文件内容发生变化时能够重新在服务器上运行该脚本，这时我们可以使用 null_resource 的 triggers 参数：\n123456789101112131415161718resource &quot;null_resource&quot; &quot;web_init&quot; &#123;  depends_on = [    ucloud_eip_association.eip_association,    ucloud_disk_attachment.data_disk  ]  triggers = &#123;    script_hash = filemd5(&quot;$&#123;path.module&#125;/init.sh&quot;)  &#125;  provisioner &quot;remote-exec&quot; &#123;    connection &#123;      type     = &quot;ssh&quot;      host     = ucloud_eip.eip.public_ip      user     = &quot;root&quot;      password = var.root_password    &#125;    script = &quot;$&#123;path.module&#125;/init.sh&quot;  &#125;&#125;\n现在 provisioner 运行的脚本是通过 script 参数传入的脚本文件路径，而我们通过 filemd5 函数把文件内容的哈希值传入了 triggers。triggers 会在值发生改变时触发 null_resource 的重建，这样脚本发生些许变化都会导致重新执行。\n官方文档上还给出了对于 triggers 的另一个妙用：\n12345678910111213141516171819202122232425resource &quot;aws_instance&quot; &quot;cluster&quot; &#123;  count = 3  # ...&#125;resource &quot;null_resource&quot; &quot;cluster&quot; &#123;  # Changes to any instance of the cluster requires re-provisioning  triggers = &#123;    cluster_instance_ids = &quot;$&#123;join(&quot;,&quot;, aws_instance.cluster.*.id)&#125;&quot;  &#125;  # Bootstrap script can run on any instance of the cluster  # So we just choose the first in this case  connection &#123;    host = &quot;$&#123;element(aws_instance.cluster.*.public_ip, 0)&#125;&quot;  &#125;  provisioner &quot;remote-exec&quot; &#123;    # Bootstrap script called with private_ip of each node in the clutser    inline = [      &quot;bootstrap-cluster.sh $&#123;join(&quot; &quot;, aws_instance.cluster.*.private_ip)&#125;&quot;,    ]  &#125;&#125;\n这个例子里，我们需要所有 AWS 主机的内网 IP 参与才能够成功初始化集群，可能是类似 Kafka 或是 RabbitMQ 这样的应用，我们需要把集群节点的IP写入配置文件。如何确保未来机器数量发生调整以后，机器上的配置文件始终能够获得完整的集群内网 IP 信息，这里使用 triggers 就可以轻松完成目标。\n另外在绝大多数生产环境中，服务器都不允许拥有独立的公网 IP，或是禁止从服务器对外服务的公网 IP 直接连接 ssh。这时一般我们会在集群中配置一台堡垒机，通过堡垒机进行跳转连接。可以访问通过堡垒机使用SSH的官方文档获取详细信息，在此不再赘述。\ndestroy-provisioner中使用变量\n\n\n1.9.5.1. destroy-provisioner 中使用变量\n\n\n1.9.5.1.1. 解决方法\n\n\n\n1.9.5.1. destroy-provisioner 中使用变量\n我们可以在定义一个 provisioner 块时设置 when 为 destroy，资源在销毁之前会首先执行 provisioner，可以帮助我们执行一些析构逻辑。但是如果我们在 Destroy-Provisioner 中引用了变量的话，比如这样的代码：\n1234567891011resource &quot;aws_volume_attachment&quot; &quot;attachement_myservice&quot; &#123;  count         = &quot;$&#123;length(var.network_myservice_subnet_ids)&#125;&quot;  device_name   = &quot;/dev/xvdg&quot;  volume_id     =   &quot;$&#123;element(aws_ebs_volume.ebs_myservice.*.id, count.index)&#125;&quot;  instance_id   =   &quot;$&#123;element(aws_instance.myservice.*.id, count.index)&#125;&quot;  provisioner &quot;local-exec&quot; &#123;    command = &quot;aws ec2 stop-instances --instance-ids $&#123;element(aws_instance.myservice.*.id, count.index)&#125; --region $&#123;var.region&#125; &amp;&amp; sleep 30&quot;    when = &quot;destroy&quot;  &#125;&#125;\n那么我们会看见这样的报错信息：\n12345|  Error: Invalid reference from destroy provisioner│ │ Destroy-time provisioners and their connection configurations may only reference attributes of the related resource, via &#x27;self&#x27;, &#x27;count.index&#x27;, or &#x27;each.key&#x27;.│ │ References to other resources during the destroy phase can cause dependency cycles and interact poorly with create_before_destroy.\n从 0.12 开始 Terraform 会对在 Destroy-Time Provisioner 中引用除 self、count.index、each.key 以外的变量做警告，从 0.13 开始则会直接报错。\n1.9.5.1.1. 解决方法\n目前官方推荐的做法是把需要引用的变量值通过 triggers “捕获”一下再引用，例如：\n1234567891011resource &quot;null_resource&quot; &quot;foo&quot; &#123;  triggers &#123;    interpreter = var.local_exec_interpreter  &#125;  provisioner &#123;    when = destroy    interpreter = self.triggers.interpreter    ...  &#125;&#125;\n通过这种方法就可以避免这个问题。\n\n\n1.9.6.1. 利用 null_resource 的 triggers 触发其他资源更新\n\n\n1.9.6.1.1. 问题描述\n\n\n1.9.6.1.2. 问题原因\n\n\n1.9.6.1.3. 巧用 null_resource 的 triggers\n\n\n1.9.6.1.4. 一个小实验\n\n\n\n1.9.6.1. 利用 null_resource 的 triggers 触发其他资源更新\n社区有人提了一个 Terraform 问题，他写了这样一段 Terraform 代码：\n123456789101112131415161718192021222324252627resource &quot;azurerm_key_vault_secret&quot; &quot;service_bus_connection_string&quot; &#123;  name = &quot;service-bus-connection-string&quot;  value        = azurerm_servicebus_topic_authorization_rule.mysb.primary_connection_string  key_vault_id = azurerm_key_vault.main.id&#125;resource &quot;azurerm_function_app&quot; &quot;main&quot; &#123;  name                = &quot;myfn&quot;  location            = azurerm_resource_group.main.location  resource_group_name = azurerm_resource_group.main.name  app_service_plan_id = azurerm_app_service_plan.main.id  enable_builtin_logging = true  https_only             = true  os_type                = &quot;linux&quot;  storage_account_name       = azurerm_storage_account.main.name  storage_account_access_key = azurerm_storage_account.main.primary_access_key  version = &quot;~3&quot;  app_settings = &#123;    AzureWebJobsServiceBus      = &quot;@Microsoft.KeyVault(SecretUri=$&#123;azurerm_key_vault_secret.service_bus_connection_string.id&#125;)&quot;  &#125;&#125;\n意思大概是他把一段含有机密信息的连接字符串保存在 Azure KeyVault 服务中，然后创建了一个 Azure Faas 函数，通过 KeyVault 机密引用地址传递该机密。\n1.9.6.1.1. 问题描述\n这位老兄发现，如果他修改了机密的内容，也就是 azurerm_key_vault_secret 声明里的 value = azurerm_servicebus_topic_authorization_rule.mysb.primary_connection_string 这一段的值的时候，KeyVault 保存的机密内容的确会正确更新，但 Azure Function 读取到的还是旧的机密引用地址，也就是这段代码中得到的 KeyVault 机密引用地址没有更新：\n123app_settings = &#123;  AzureWebJobsServiceBus      = &quot;@Microsoft.KeyVault(SecretUri=$&#123;azurerm_key_vault_secret.service_bus_connection_string.id&#125;)&quot;&#125;\n更加奇怪的是，这之后他什么都没有做，只是重新再执行一次 terraform apply，该引用地址又被正确更新了？！\n1.9.6.1.2. 问题原因\n因为 KeyVault Secret 被设计成是不可变的，所以更新 azurerm_key_vault_secret 的 value 会导致资源被重新创建。Terraform 官网上的相关文档中对该参数的定义如下：\n\nvalue - (Required) Specifies the value of the Key Vault Secret.\n\n在 Terraform 中 ，一个参数如果被标记为 Required，那么它不但是必填项，同时类似数据库记录的主键的概念，主键不同的记录被认定是两条不同的记录，修改记录的主键值可以看作是删除重建之。Terraform 资源的 Required 参数如果发生变化会触发重新创建资源，这就导致了修改 value 后，该 azurerm_key_vault_secret 的 id 也会发生变化。\n那么为什么在 azurerm_key_vault_secret 被重新创建之后，我们会发现 azurerm_function_app 中引用的 id 没有变化呢？\nTerraform 的工作流含有 Plan 和 Apply 两个主要阶段，首先会分析 Terraform 代码，调用 terraform refresh（可以用参数跳过该步骤）读取资源在云端目前的最新状态，再加上 State 文件中记录的状态，三个状态对比出一个执行计划，使得最终产生的云端状态能够符合当前代码描述的状态。\n就这个场景而言，Terraform 能够意识到 azurerm_key_vault_secret 的参数发生了变化，这会导致某种程度的更新，但它无法意识到这个更新会导致 azurerm_key_vault_secret 的 id 发生变化，进而导致 azurerm_function_app 也必须进行更新，所以就发生了他第一次执行 terraform apply 后看到的情况。\n当他第二次执行 terraform apply 时，Terraform 记录的 State 文件里，azurerm_key_vault_secret 的 id和azurerm_function_app 里使用的 id 已经对不上了，这时 Terraform 会再生成一个更新 azurerm_function_app 的 Plan，执行后一切恢复正常。\n有没有办法让 azurerm_function_app 能在第一次生成 Plan 时就感知到这个变更？\n1.9.6.1.3. 巧用 null_resource 的 triggers\nHashiCorp 提供了一个非常常用的内建 Provider —— null。其中最知名的资源就是 null_resource 了，一般它都是和 provisioner 搭配出现，可以用来在某些资源创建完成后执行一些自定义脚本等等。但是它还有一个很有用的参数：\n\nThe triggers argument allows specifying an arbitrary set of values that, when changed, will cause the resource to be replaced.\n\ntriggers 参数可以用来指向一些值，只要这些值的内容发生了变动，会导致 null_resource 资源被重新创建，从而生成一个新的 id。\n1.9.6.1.4. 一个小实验\n我们尝试构建一个简单的实验环境来验证一下，首先是这样一段代码：\n12345678910resource &quot;azurerm_key_vault_secret&quot; &quot;example&quot; &#123;  name         = &quot;secret-sauce&quot;  value        = &quot;szechuan&quot;  key_vault_id = azurerm_key_vault.example.id&#125;resource &quot;local_file&quot; &quot;output&quot; &#123;  filename = &quot;$&#123;path.module&#125;/output.txt&quot;  content = azurerm_key_vault_secret.example.id&#125;\n我们创建一个 azurerm_key_vault_secret，然后把它的 id 输出到一个文件里。随后我们复制一下该文件，比如叫 output.bak 好了。随后我们修改 azurerm_key_vault_secret 的 value 到一个新的值，执行 terraform apply 以后，我们会发现 output.txt 与 output.bak 的内容完全一样，说明 value 的更新并没有触发 local_file 的更新。\n随后我们把代码改成这样：\n12345678910111213141516resource &quot;azurerm_key_vault_secret&quot; &quot;example&quot; &#123;  name         = &quot;secret-sauce&quot;  value        = &quot;szechuan2&quot;  key_vault_id = azurerm_key_vault.example.id&#125;resource &quot;null_resource&quot; &quot;example&quot; &#123;  triggers = &#123;    trigger = azurerm_key_vault_secret.example.value  &#125;&#125;resource &quot;local_file&quot; &quot;output&quot; &#123;  filename = &quot;$&#123;path.module&#125;/output.txt&quot;  content = null_resource.example.id == null_resource.example.id ? azurerm_key_vault_secret.example.id : &quot;&quot;&#125;\n我们在代码中插入了一个 null_resource，并设置 triggers 的内容，盯住 azurerm_key_vault_secret.example.value。在 value 发生变化时，null_resource 的 id 也会发生变化。\n然后我们在 local_file 的代码中，content 的赋值改成了这样一个三目表达式：null_resource.example.id == null_resource.example.id ? azurerm_key_vault_secret.example.id : &quot;&quot;。这个表达式里实际上 null_resource.example.id 是不起作用的，自己等于自己的永真条件会导致仍然使用 azurerm_key_vault_secret.example.id 作为值，但是由于掺入了 null_resource.example.id，使得 Terraform 在第一次计算 Plan 时就感知到 local_file 的内容发生了变化，从而使得我们可以一次 terraform apply 搞定。\n\n1.9.7.1. 利用 null_resource 搭配 replace_triggered_by 更新无法从服务端读取内容的属性\n\n\n1.9.7.1. 利用 null_resource 搭配 replace_triggered_by 更新无法从服务端读取内容的属性\n曾经处理的一个提问，有人写了这样一段 Terraform 代码：\n12345678910111213141516171819202122232425262728293031323334resource &quot;azurerm_container_group&quot; &quot;this&quot; &#123;  name                = var.name  location            = var.location  resource_group_name = var.resource_group_name  ip_address_type     = &quot;Private&quot;  network_profile_id  = azurerm_network_profile.this.id  os_type             = &quot;Linux&quot;  container &#123;    name   = &quot;someName&quot;    image  = &quot;someImage&quot;    cpu    = &quot;0.5&quot;    memory = &quot;0.5&quot;    commands = [&quot;some&quot;, &quot;commands&quot;]    ports &#123;      port     = 53      protocol = &quot;UDP&quot;    &#125;    volume &#123;      mount_path = &quot;/app/conf&quot;      name       = &quot;someName&quot;      read_only  = true      secret = &#123;        Corefile = base64encode(someContent)      &#125;    &#125;  &#125;  tags = var.tags&#125;\n结果每次执行 apply 操作时，都会发现 Terraform 试图重建这个容器：\n123456789101112131415161718192021222324252627282930# module.dns_forwarder.azurerm_container_group.this must be replaced-/+ resource &quot;azurerm_container_group&quot; &quot;this&quot; &#123;      ~ exposed_port        = [          - &#123;              - port     = 53              - protocol = &quot;UDP&quot;            &#125;,        ] -&gt; (known after apply)      + fqdn                = (known after apply)      ~ id                  = &quot;/subscriptions/&lt;mySubId&gt;/resourceGroups/&lt;myRgName&gt;/providers/Microsoft.ContainerInstance/containerGroups/&lt;myContainerGroupName&gt;&quot; -&gt; (known after apply)      ~ ip_address          = &quot;someIp&quot; -&gt; (known after apply)        name                = &quot;someName&quot;      - tags                = &#123;&#125; -&gt; null        # (6 unchanged attributes hidden)      ~ container &#123;          - environment_variables        = &#123;&#125; -&gt; null            name                         = &quot;someName&quot;          - secure_environment_variables = (sensitive value)            # (4 unchanged attributes hidden)          ~ volume &#123;                name       = &quot;someName&quot;              ~ secret     = (sensitive value) # forces replacement                # (3 unchanged attributes hidden)            &#125;            # (1 unchanged block hidden)        &#125;    &#125;\n这个问题的原因是 API 在读取容器信息时不会返回 volume 的 secret 数据，这其实是一个还挺合理的设定，机密数据的确不应该可以直接从 API 返回，但这就导致 Terraform 每次制定变更计划时都会试图重新设置这个值(因为会理解成服务端这个值被修改成了空)，而容器是不可变的，要修改容器的任何配置都会导致容器被重建。\n有没有办法能够避免这种问题？经验告诉我们，可以使用 ignore_changes 让 Terraform 忽略这个属性的变更来避免重建，但如果 secret 真的变了怎么办？\n我们可以这样干，第一，在 azurerm_container_group 添加这样一段 lifecycle 块：\n1234lifecycle &#123;    ignore_changes       = [container[0].volume[0].secret]    replace_triggered_by = [null_resource.secret_trigger.id]&#125;\n这会忽略 secret 的变化，但我们同时声明了一个 replace_triggered_by，在 null_resource.secret_trigger.id 的值发生变化时可以删除重建 azurerm_container_group 实例。\n其次，我们把 secret 的内容提取到一个 local 里，这时 azurerm_container_group 的 volume 看起来大概是这样的：\n12345678volume &#123;    mount_path = &quot;/app/conf&quot;    name       = &quot;somename&quot;    read_only  = true    secret     = &#123;      Corefile = local.secret    &#125;&#125;\nlocal.secret 存放着使用的机密数据。这时我们再定义一个 null_resource 充当触发器：\n123456789locals &#123;  secret = base64encode(&quot;abcdefg&quot;)&#125;resource &quot;null_resource&quot; &quot;secret_trigger&quot; &#123;  triggers = &#123;    trigger = local.secret  &#125;&#125;\n这样在机密数据真的发生变化的时候，triggers 会触发 null_resource 的重建，导致 null_resource.secret_trigger.id 发生变化，进而触发 azurerm_container_group 的重建。\n\n1.9.8.1. 创建资源的条件依赖另一个资源的输出时怎么办\n\n\n1.9.8.1. 创建资源的条件依赖另一个资源的输出时怎么办\n我们在有条件创建当中介绍了如何可以通过判断用户的输入参数来决定是否要创建某个资源，让我们来看一下这样一个 Module 的例子：\n123456789101112131415variable &quot;vpc_id&quot; &#123;  type    = string  default = null&#125;resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;  count       = var.vpc_id == null ? 1 : 0  cidr_blocks = [&quot;10.0.0.0/16&quot;]  name        = &quot;vpc&quot;&#125;resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;  cidr_block = &quot;10.0.0.0/24&quot;  vpc_id     = var.vpc_id == null ? ucloud_vpc.vpc[0].id : var.vpc_id&#125;\n我们想在 Module 中创建一个 ucloud_subnet，用户可以输入一个 vpc_id 配置给它，也可以不输入，这时 Module 会创建一个 ucloud_vpc 来用。\n假如我们使用这个模块，不传入 vpc_id：\n123module vpc &#123;  source = &quot;./vpc&quot;&#125;\n这段代码生成的 Plan 内容如下：\n12345678910111213141516171819202122232425262728293031Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:  + createTerraform will perform the following actions:  # module.vpc.ucloud_subnet.subnet will be created  + resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;      + cidr_block  = &quot;10.0.0.0/24&quot;      + create_time = (known after apply)      + id          = (known after apply)      + name        = (known after apply)      + remark      = (known after apply)      + tag         = &quot;Default&quot;      + vpc_id      = (known after apply)    &#125;  # module.vpc.ucloud_vpc.vpc[0] will be created  + resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;      + cidr_blocks  = [          + &quot;10.0.0.0/16&quot;,        ]      + create_time  = (known after apply)      + id           = (known after apply)      + name         = &quot;vpc&quot;      + network_info = (known after apply)      + remark       = (known after apply)      + tag          = &quot;Default&quot;      + update_time  = (known after apply)    &#125;Plan: 2 to add, 0 to change, 0 to destroy.\n完全符合预期。假如我们希望由模块的调用者来创建 Vpc 的话：\n12345678910resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;  cidr_blocks = [&quot;10.0.0.0/16&quot;]  name        = &quot;vpc&quot;&#125;module vpc &#123;  source = &quot;./vpc&quot;  vpc_id = ucloud_vpc.vpc.id&#125;\n我们执行 terraform plan 的话，会得到这样的结果：\n123456789╷│ Error: Invalid count argument│ │   on vpc/main.tf line 16, in resource &quot;ucloud_vpc&quot; &quot;vpc&quot;:│   16:   count       = var.vpc_id == null ? 1 : 0│ │ The &quot;count&quot; value depends on resource attributes that cannot be determined until apply, so Terraform cannot predict how many instances will be created. To work around this,│ use the -target argument to first apply only the resources that the count depends on.╵\nTerraform 试图向我们抱怨，我们在 count 参数的表达式里使用了一个必须在 apply 阶段才能知道的值，所以它无法在 plan 阶段就计算出 count 的值。它建议我们先用 terraform apply 命令搭配 -target 参数把 Vpc 先创建出来，消除后续计算 Plan 时尚不知晓的值来解决这个问题。\n这当然是一种很麻烦的方法，所以我们在设计 Module 时就要考虑到这种问题。有一种很简单的方法可以解决这个问题：\n12345678910111213141516171819variable &quot;vpc&quot; &#123;  type    = object(    &#123;      id = string    &#125;  )  default = null&#125;resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;  count       = var.vpc == null ? 1 : 0  cidr_blocks = [&quot;10.0.0.0/16&quot;]  name        = &quot;vpc&quot;&#125;resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;  cidr_block = &quot;10.0.0.0/24&quot;  vpc_id     = var.vpc == null ? ucloud_vpc.vpc[0].id : var.vpc.id&#125;\n我们把用来判断创建条件的输入参数类型改成 object，调用 Module 的代码就变成了：\n12345678910111213141516171819202122232425262728Terraform will perform the following actions:  # ucloud_vpc.vpc will be created  + resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;      + cidr_blocks  = [          + &quot;10.0.0.0/16&quot;,        ]      + create_time  = (known after apply)      + id           = (known after apply)      + name         = &quot;vpc&quot;      + network_info = (known after apply)      + remark       = (known after apply)      + tag          = &quot;Default&quot;      + update_time  = (known after apply)    &#125;  # module.vpc.ucloud_subnet.subnet will be created  + resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;      + cidr_block  = &quot;10.0.0.0/24&quot;      + create_time = (known after apply)      + id          = (known after apply)      + name        = (known after apply)      + remark      = (known after apply)      + tag         = &quot;Default&quot;      + vpc_id      = (known after apply)    &#125;Plan: 2 to add, 0 to change, 0 to destroy.\n成功计算出 Plan。请注意虽然这个 Plan 仍然是创建两个资源，但 ucloud_vpc 资源并不是 Module 创建的。\n这个方法的原理就是虽然 var.vpc.id 仍然是一个只有在 apply 阶段才能知道的值，但 var.vpc 本身是一个在 plan 阶段就可以知道的值，直接可以判读它是否为 null，所以该方法可以绕过这个限制。\n\n1.9.9.1. 利用 create_before_destroy 调整资源 Update 的执行顺序\n\n\n1.9.9.1. 利用 create_before_destroy 调整资源 Update 的执行顺序\n最近处理了一个问题，有人写了这样一段代码：\n12345678910111213141516171819202122232425262728293031323334353637383940414243provider &quot;azurerm&quot; &#123;  features &#123;    resource_group &#123;      prevent_deletion_if_contains_resources = false    &#125;  &#125;&#125;resource &quot;azurerm_resource_group&quot; &quot;rg&quot; &#123;  location = &quot;eastus&quot;  name     = &quot;example&quot;&#125;locals &#123;  environments = toset([&quot;one&quot;, &quot;two&quot;, &quot;three&quot;])&#125;resource &quot;azurerm_public_ip&quot; &quot;lb&quot; &#123;  for_each = local.environments  name                = &quot;frontend-lb-$&#123;each.key&#125;&quot;  location            = azurerm_resource_group.rg.location  resource_group_name = azurerm_resource_group.rg.name  allocation_method   = &quot;Static&quot;  ip_version          = &quot;IPv4&quot;  sku                 = &quot;Standard&quot;  zones               = [1, 2, 3]&#125;resource &quot;azurerm_lb&quot; &quot;this&quot; &#123;  name                = &quot;azurelb&quot;  location            = azurerm_resource_group.rg.location  resource_group_name = azurerm_resource_group.rg.name  sku                 = &quot;Standard&quot;  dynamic &quot;frontend_ip_configuration&quot; &#123;    for_each = local.environments    content &#123;      name                 = frontend_ip_configuration.key      public_ip_address_id = azurerm_public_ip.lb[frontend_ip_configuration.key].id    &#125;  &#125;&#125;\n当他从 local.environments 中删除一个元素，然后执行 terraform apply 时，他遇到了下面的问题：\n1│ Error: deleting Public Ip Address: (Name &quot;azurelb&quot; / Resource Group &quot;example&quot;): network.PublicIPAddressesClient#Delete: Failure sending request: StatusCode=400 -- Original Error: Code=&quot;PublicIPAddressCannotBeDeleted&quot; Message=&quot;Public IP address /subscriptions/subscription-id/resourceGroups/resource-group/providers/Microsoft.Network/publicIPAddresses/one can not be deleted since it is still allocated to resource /subscriptions/subscription-id/resourceGroups/resource-group/providers/Microsoft.Network/loadBalancers/azurelb/frontendIPConfigurations/one. In order to delete the public IP, disassociate/detach the Public IP address from the resource.  To learn how to do this, see aka.ms/deletepublicip.&quot; Details=[]\n这其实是一个还挺常见的问题，azurerm_lb.this 依赖于 azurerm_public_ip.lb[index]，正确的变更顺序应该是先更新 azurerm_lb.this，再删除 azurerm_public_ip.lb 的成员，但是 Terraform 默认的执行顺序会首先尝试执行删除操作，这时因为 ip 仍然被 LoadBalancer 使用着，所以会引发一个错误。\n解决方法是给 azurerm_public.lb 添加一个 create_before_destroy：\n123456789101112131415resource &quot;azurerm_public_ip&quot; &quot;lb&quot; &#123;  for_each = local.environments  name                = &quot;frontend-lb-$&#123;each.key&#125;&quot;  location            = azurerm_resource_group.rg.location  resource_group_name = azurerm_resource_group.rg.name  allocation_method   = &quot;Static&quot;  ip_version          = &quot;IPv4&quot;  sku                 = &quot;Standard&quot;  zones               = [1, 2, 3]  lifecycle &#123;    create_before_destroy = true  &#125;&#125;\ncreate_before_destroy 名字里虽然看起来是与 Create 有关，实际上它也会将 Update 与 Create 放在一起调整，声明该参数后实际上是将 azurerm_public_ip.lb 的 Delete 推迟到执行 Update 之后再执行了，该问题得解。\n\n\n1.9.10.1. Terraform 与自动化\n\n\n1.9.10.1.1. 自动化的 Terraform 命令行工作流\n\n\n1.9.10.1.2. 控制自动化中的 Terraform 输出\n\n\n1.9.10.1.3. 在不同的机器上运行 plan 和 apply\n\n\n1.9.10.1.4. 交互式审批计划\n\n\n1.9.10.1.5. 自动批准计划\n\n\n1.9.10.1.6. 用 terraform plan 命令测试 Pull Requests\n\n\n1.9.10.1.7. 多环境部署\n\n\n1.9.10.1.8. 预先安装的插件\n\n\n\n1.9.10.1. Terraform 与自动化\n如果团队使用 Terraform 作为变更管理和部署管道的核心工具，可能需要以某种自动化方式编排 Terraform 的运行，以确保运行之间的一致性，并提供其他有趣的功能，例如与版本控制系统钩子的集成。\nTerraform 的自动化可以有多种形式，并且程度不同。一些团队继续在本地运行 Terraform，但使用脚本代码来准备一致的工作目录来运行 Terraform，而另一些团队则完全在 Jenkins 等 CI 工具中运行 Terraform。\n本篇涵盖了实现此类自动化时应考虑的一些事项，既确保 Terraform 的安全运行，又适应 Terraform 工作流程中当前需要仔细注意的一些限制。它假设 Terraform 将在非交互式环境中运行，无法在终端提示输入。对于脚本代码来说不一定如此，但在 CI 工具中运行时通常如此。\n1.9.10.1.1. 自动化的 Terraform 命令行工作流\n在自动化流程中运行 Terraform 时，重点通常是核心的 plan/apply 循环。那么，使用 Terraform 命令行的流程大体如下：\n\n初始化 Terraform 工作目录。\n针对当前代码，为产生变化的资源计算变更计划\n让操作员审查计划，以确保其可接受\n应用计划描述的更改。\n\n步骤 1、2 和 4 可以使用熟悉的 Terraform 命令以及一些附加选项来执行：\n\nterraform init -input=false 初始化工作目录。\nterraform plan -out=tfplan -input=false 创建计划文件并将其保存到名为 tfplan 的本地文件。\nterraform apply -input=false tfplan 执行存储在文件 tfplan 中的计划。\n\n-input=false 参数命令 Terraform 不应尝试提示输入，而是要求配置文件或命令行提供所有必要的值。因此，可能需要在 terraform plan 上使用 -var 和 -var-file 参数来指定所有传统上在交互式使用下手动输入的变量值。\n强烈建议使用支持远程状态的 Backend，因为 Terraform 可以自动将持久保存状态，后续运行可以在找回并更新状态。选择支持状态锁定的 Backend 还将提供针对 Terraform 并发运行的竞争安全保障。\n1.9.10.1.2. 控制自动化中的 Terraform 输出\n默认情况下，一些 Terraform 命令会提示用户下一步可能执行的步骤，通常包括具体的下一步要运行的命令。\n自动化工具通常会封装正在运行的命令的具体细节，只提供抽象的步骤，这时 Terraform 输出的此类消息反而令人困惑，且无法操作，如果它们无意中鼓励用户完全绕过自动化工具，则可能还是有害的。\n当环境变量 TF_IN_AUTOMATION 设置为任何非空值时，Terraform 会对其输出进行一些细微调整，不再强调要运行的特定命令。所做的具体更改会随着时间的推移而变化，但一般来说，Terraform 发现该变量时，会认为存在某种包装了 Terraform 的应用程序，它们会帮助用户进行下一步。\n为了降低复杂性，该功能主要针对 Terraform 主要的工作流程命令实现。无论该变量为何值如何，其他辅助命令仍可能会产生命令行建议。\n1.9.10.1.3. 在不同的机器上运行 plan 和 apply\n在 CI 工具中运行时，可能很难或无法确保 plan 和 apply 命令在同一台计算机上的同一目录中运行，并且所有的文件都保持相同。\n在不同的机器上运行 plan 和 apply 需要一些额外的步骤来确保正确的行为。稳健的策略如下：\n\nplan 完成后，保存整个工作目录，包括 init 期间创建的 .terraform 子目录，并将其保存在 apply 阶段可以访问得到的位置。常见的选择是作为所选 CI 工具中的“Build Artifact”。\n在运行 apply 之前，获取上一步中创建的存档并将其解压到相同的绝对路径。这会重新创建 plan 后出现的所有内容，避免在 plan 步骤期间创建本地文件的奇怪问题。\n\nTerraform 目前为此类自动化系统设置了一些必须满足的前提条件：\n\n保存的计划文件可以包含子模块的绝对路径以及代码中引用的其他数据文件。因此，必须确保在相同的绝对路径中还原保存的工作目录。这通常是通过在某种隔离中运行 Terraform 来实现的，例如可以控制文件系统布局的 Docker 容器。\nTerraform 假设该计划将在与其创建时相同的操作系统和 CPU 架构上 Apply。例如，这意味着无法在 Windows 计算机上创建计划，然后将其应用到 Linux 服务器上。\nTerraform 期望用于生成计划的 Provider 程序插件在应用计划时可用且相同，以确保正确执行计划。如果在创建和应用计划之间升级 Terraform 或任何插件，将会产生错误。\nTerraform 无法自动检测用于创建计划的凭据是否授予对用于应用该计划的相同资源的访问权限。如果对每个凭据使用不同的凭据（例如，使用只读凭据生成计划），那么确保两套凭据在它们所属的相应服务的帐户中保持一致非常重要。\n\n警告：计划文件包含代码的完整副本、计划所要应用的状态数据以及传递给 terraform plan 的所有变量。如果其中包含任意敏感数据，则包含计划文件的存档工作目录应受到相应保护。对于 Provider 使用的身份验证凭据，建议尽可能使用环境变量，因为这些变量不会被包含在计划中或由 Terraform 以任何其他方式保存到磁盘。\n1.9.10.1.4. 交互式审批计划\n自动化 Terraform 工作流程的另一个挑战是需要在计划和应用之间进行交互式审批步骤。为了稳健地实现这一点，重要的是要确保一次只能有一个计划未完成，或者两个步骤相互连接，以便批准计划将足够的信息传递到应用步骤，以确保应用正确的计划，与后来也存在的一些计划相反。\n不同的 CI 工具以不同的方式解决这个问题，但通常这是通过构建管道功能实现的，其中可以按顺序应用不同的步骤，后面的步骤可以访问前面步骤生成的数据。\n推荐的方法是一次只允许一个计划处于未应用状态。应用计划时，针对同一状态生成的任何其他现有计划都会失效，因为现在必须相对于新状态重新计算它们。通过强制计划按顺序获得批准（或驳回），可以避免这种情况。\n1.9.10.1.5. 自动批准计划\n虽然强烈建议对生产环境应用计划前要进行人工审查，但有时在预生产或开发环境中部署时需要采取更自动化的方法。\n如果不需要手动批准，可以使用更简单的命令序列：\n\nterraform init -input=false\nterraform apply -input=false -auto-approve\n\napply 命令的这个变体隐式地创建一个新计划，然后立即应用它。 -auto-approve 选项告诉 Terraform 在应用计划之前不需要对计划进行交互式批准。\n警告：当 Terraform 有权对基础设施进行破坏性更改时，始终建议对计划进行人工审查，除非在发生意外更改时可以容忍停机。仅对非关键基础设施使用自动批准。\n1.9.10.1.6. 用 terraform plan 命令测试 Pull Requests\nterraform plan 可以用来对 Terraform 配置的有效性进行某些有限的验证，而不影响实际的基础设施。尽管 plan 命令会更新状态以匹配实际资源，从而确保准确的计划，但更新后的状态文件并不会持久保存，因此可以安全地使用该命令来生成仅为了帮助代码审查而创建的“一次性”计划。\n实现此类工作流程时，可以在相关代码审查工具（例如，Github Pull Request）中使用钩子，为每个正在审查的新提交触发 CI 工具。在这种情况下，Terraform 可以按如下方式运行：\n\nterraform plan -input=false\n\n与在“主”工作流程中一样，可能需要根据需要设置 -var 或 -var-file。在这种情况下不使用 -out 选项，因为为代码审查目的而生成的计划永远不会被应用。相反，一旦合并更改，就可以从主版本控制分支创建并应用新计划。\n警告：请注意，通过输入变量或环境变量将敏感秘密数据传递给 Terraform 将使任何可以提交 PR 的人都可以看到，因此在开源项目或任何私人项目上必须谨慎使用此流程部分，或所有贡献者不应能够直接访问凭据等。\n1.9.10.1.7. 多环境部署\nTerraform 的自动化通常会被用来创建数个相同的配置，比如为预发布、测试或多租户基础设施等场景生成平行的环境。这种情况下的自动化可以帮助确保为每个环境使用正确的设置，并且在每次操作之前正确配置工作目录。\n多环境编排最有趣的两个命令是 terraform init 和 terraform workspace。前者可以与其他参数一起使用，以针对环境之间的差异定制 Backend 配置，而后者可用于在单个 Backend 中存储的相同配置的多个状态之间安全切换。\n如果可能，建议对所有环境使用单一后端配置，并使用 terraform workspace 命令在工作空间之间切换：\n\nterraform init -input=false\nterraform workspace select QA\n\n在此使用模型中，Backend 存储中使用固定的命名方案，以允许多个状态共存，而无需任何进一步的配置。\n或者，自动化工具可以将环境变量 TF_WORKSPACE 设置为现有工作空间名称，这将覆盖使用 terraform workspace select 命令所做的任何选择。建议仅在非交互式使用中使用此环境变量，因为在本地 shell 环境中，很容易忘记设置该变量并将变更应用到错误的状态。\n在一些更复杂的情况下，不可能跨环境共享相同的 Backend 配置。例如，环境可能运行在完全独立的不同帐户的服务里，因此需要对 Backend 本身使用不同的凭据或端点。在这种情况下，可以通过 terraform init 的 -backend-config 选项覆盖后端配置设置。\n1.9.10.1.8. 预先安装的插件\n在默认使用情况下，terraform init 会自动下载并安装代码中使用的所有 Provider 程序的插件，并将它们放置在 .terraform 目录的子目录中。这为简单的情况提供了更简单的工作流程，并允许每段代码可以使用不同版本的插件。\n在自动化环境中，可能需要禁用此行为，而是提供一组已安装在运行 Terraform 的系统上的固定插件。这样就避免了每次执行时重新下载插件的开销，并允许系统管理员控制可以使用哪些插件。\n要使用此机制，请在系统上的某个位置创建一个 Terraform 运行时会将插件可执行文件放入其中的目录。已发布的插件文件可在 releases.hashicorp.com 上下载。请务必下载适合目标操作系统和体系结构的文件。\n提取必要的插件后，新插件目录的内容将如下所示：\n1234$ ls -lah /usr/lib/custom-terraform-plugins-rwxrwxr-x 1 user user  84M Jun 13 15:13 terraform-provider-aws-v1.0.0-x3-rwxrwxr-x 1 user user  84M Jun 13 15:15 terraform-provider-rundeck-v2.3.0-x3-rwxrwxr-x 1 user user  84M Jun 13 15:15 terraform-provider-mysql-v1.2.0-x3\n文件名末尾的版本信息很重要，它使得 Terraform 可以推断每个插件的版本号。可以安装同一 Provider 程序插件的多个版本，Terraform 将使用与 Terraform 代码中的 Provider 程序版本约束相匹配的最新版本。\n填充此目录后，可以使用 terraform init 的 -plugin-dir 选项跳过常规的自动下载和插件发现行为：\n\nterraform init -input=false -plugin-dir=/usr/lib/custom-terraform-plugins\n\n使用该组参数时，只有给定目录中的插件可以被使用。这使系统管理员可以对执行环境进行强力控制，但另一方面，它会阻止使用尚未安装到本地插件目录中的较新插件版本。哪种方法更合适将取决于每个组织内的特定情况。\n还可以通过创建 terraform.d/plugins/OS_ARCH 目录与配置一起提前安装插件，在自动下载其他插件之前将搜索该目录。 -get-plugins=false 参数可禁止 Terraform 自动下载其他插件。\n","dateCreated":"2023-01-30T17:43:45+08:00","dateModified":"2025-06-17T23:06:53+08:00","datePublished":"2023-01-30T17:43:45+08:00","description":"","headline":"Terraform-小技巧","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"},"publisher":{"@type":"Organization","name":"Kein Chan","sameAs":["https://github.com/chankein/","https://www.linkedin.com/profile/","mailto:kein.chan85@gmail.com"],"image":"profile.jpg","logo":{"@type":"ImageObject","url":"profile.jpg"}},"url":"https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/","keywords":"Terraform"}</script>
    <meta name="description" content="1.9.1.1. 有条件创建   1.9.1.1. 有条件创建 Terraform被设计成声明式而非命令式，例如没有常见的 if 条件语句，后来才加上了 count 和 for_each 实现的循环语句(但循环的次数必须是在 plan 阶段就能够确认的，无法根据其他 resource 的输出动态决定) 有时候我们需要根据某种条件来判断是否创建一个资源。虽然我们无法使用if来完成条件判断，但我们还">
<meta property="og:type" content="blog">
<meta property="og:title" content="Terraform-小技巧">
<meta property="og:url" content="https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/index.html">
<meta property="og:site_name" content="Kein&#39;s blog">
<meta property="og:description" content="1.9.1.1. 有条件创建   1.9.1.1. 有条件创建 Terraform被设计成声明式而非命令式，例如没有常见的 if 条件语句，后来才加上了 count 和 for_each 实现的循环语句(但循环的次数必须是在 plan 阶段就能够确认的，无法根据其他 resource 的输出动态决定) 有时候我们需要根据某种条件来判断是否创建一个资源。虽然我们无法使用if来完成条件判断，但我们还">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2023-01-30T09:43:45.000Z">
<meta property="article:modified_time" content="2025-06-17T15:06:53.924Z">
<meta property="article:author" content="Kein Chan">
<meta property="article:tag" content="Terraform">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://keinchan.com../../../../../assets/images/profile.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="../../../../../assets/css/style-l9zwheso7r7pnk98nvirovsz9dl7fhkrc9mlb5vmuxw7tk5movrk0eevsrpr.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="../../../../../index.html"
            aria-label=""
        >
            Kein&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打開鏈接: ../../../../../#about"
            >
        
        
            <img class="header-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="../../../../../#about"
                    aria-label="閱讀有關作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
                </a>
                <h4 class="sidebar-profile-name">Kein Chan</h4>
                
                    <h5 class="sidebar-profile-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../index.html"
                            
                            rel="noopener"
                            title="首頁"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首頁</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-categories"
                            
                            rel="noopener"
                            title="分類"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分類</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-tags"
                            
                            rel="noopener"
                            title="標籤"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">標籤</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-archives"
                            
                            rel="noopener"
                            title="所有文章"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">所有文章</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜尋"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜尋</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="關於"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">關於</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/chankein/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/profile/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../mailto:kein.chan85@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Email"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Email</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../atom.xml"
                            
                            rel="noopener"
                            title="Atom"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Atom</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Terraform-小技巧
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2023-01-30T17:43:45+08:00">
	
		    2023 年 1 月 30 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="../../../../../categories/devops/">devops</a>, <a class="category-link" href="../../../../../categories/devops/Terraform/">Terraform</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <ul>
<li><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"><strong>1.9.1.1.</strong> 有条件创建</a></li>
</ul>
<p><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"></a></p>
<h2 id="1-9-1-1-有条件创建"><a href="#%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA"></a>1.9.1.1. 有条件创建</h2>
<p>Terraform被设计成声明式而非命令式，例如没有常见的 <code>if</code> 条件语句，后来才加上了 <code>count</code> 和 <code>for_each</code> 实现的循环语句(但循环的次数必须是在 <code>plan</code> 阶段就能够确认的，无法根据其他 <code>resource</code> 的输出动态决定)</p>
<p>有时候我们需要根据某种条件来判断是否创建一个资源。虽然我们无法使用if来完成条件判断，但我们还有 <code>count</code> 和 <code>for_each</code> 可以帮助我们完成这个目标。</p>
<p>我们以 UCloud 为例，假如我们正在编写一个旨在被复用的模块，模块的逻辑要创建一台虚拟机，我们的代码可以是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">data ucloud_vpcs &quot;default&quot; &#123;</span><br><span class="line">  name_regex = &quot;^Default&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-02&quot;</span><br><span class="line">  image_id = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type = &quot;n-basic-2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;uhost_id&quot; &#123;</span><br><span class="line">  value = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常简单。但是如果我们想进一步，让模块的调用者决定创建的主机是否要搭配一个弹性公网 IP 该怎么办？</p>
<p>我们可以在上面的代码后面接上这样的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;allocate_public_ip&quot; &#123;</span><br><span class="line">  description = &quot;Decide whether to allocate a public ip and bind it to the host&quot;</span><br><span class="line">  type = bool</span><br><span class="line">  default = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip&quot; &quot;public_ip&quot; &#123;</span><br><span class="line">  count = var.allocate_public_ip ? 1 : 0</span><br><span class="line">  name = &quot;public_ip_for_$&#123;ucloud_instance.web.name&#125;&quot;</span><br><span class="line">  internet_type = &quot;bgp&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip_association&quot; &quot;public_ip_binding&quot; &#123;</span><br><span class="line">  count = var.allocate_public_ip ? 1 : 0</span><br><span class="line">  eip_id = ucloud_eip.public_ip[0].id</span><br><span class="line">  resource_id = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们首先创建了名为 <code>allocate_public_ip</code> 的输入变量，然后在编写弹性 IP 相关资源代码的时候都声明了 <code>count</code> 参数，值使用了条件表达式，根据 <code>allocate_public_ip</code> 这个输入变量的值决定是 <code>1</code> 还是 <code>0</code>。这实际上实现了按条件创建资源。</p>
<p>需要注意的是，由于我们使用了 <code>count</code>，所以现在弹性 IP 相关的资源实际上是多实例资源类型的。我们在 <code>ucloud_eip_association.public_ip_binding</code> 中引用 <code>ucloud_eip.public</code> 时，还是要加上访问下标。由于 <code>ucloud_eip_association.public_ip_binding</code> 与 <code>ucloud_eip.public</code> 实际上是同生同死，所以在这里他们之间的引用还比较简单；如果是其他没有声明 <code>count</code> 的资源引用它们的话，还要针对 <code>allocate_public_ip</code> 为 <code>false</code> 时 <code>ucloud_eip.public</code> 实际为空做相应处理，比如在 <code>output</code> 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output &quot;public_ip&quot; &#123;</span><br><span class="line">  value = join(&quot;&quot;, ucloud_eip.public_ip[*].public_ip)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>join</code> 函数就可以在即使没有创建弹性 IP 时也能返回空字符串。或者我们也可以用条件表达式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output &quot;public_ip&quot; &#123;</span><br><span class="line">  value = length(ucloud_eip.public_ip[*].public_ip) &gt; 0 ? ucloud_eip.public_ip[0].public_ip : &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"><strong>1.9.2.1.</strong> 依赖反转</a></li>
</ul>
<p><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"></a></p>
<h2 id="1-9-2-1-依赖反转"><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC"></a>1.9.2.1. 依赖反转</h2>
<p>Terraform 编排的基础设施对象彼此之间可能互相存在依赖关系，有时我们在编写一些旨在重用的模块时，模块内定义的资源可能本身需要依赖其他一些资源，这些资源可能已经存在，也可能有待创建。</p>
<p>举一个例子，假设我们编写了一个模块，定义了在 UCloud 上同一个 VPC 中的两台服务器；第一台服务器部署了一个 Web 应用，它被分配在一个 DMZ 子网里；第二台服务器部署了一个数据库，它被分配在一个内网子网里。现在的问题是，在我们编写模块时，我们并没有关于 VPC 和子网的任何信息，我们甚至连服务器应该部署在哪个可用区都不知道。VPC 和子网可能已经存在，也可以有待创建。</p>
<p>我们可以定义这样的一个模块代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    ucloud = &#123;</span><br><span class="line">      source  = &quot;ucloud/ucloud&quot;</span><br><span class="line">      version = &quot;~&gt;1.22.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;network_config&quot; &#123;</span><br><span class="line">  type = object(&#123;</span><br><span class="line">    vpc_id         = string</span><br><span class="line">    web_app_config = object(&#123;</span><br><span class="line">      az        = string</span><br><span class="line">      subnet_id = string</span><br><span class="line">    &#125;)</span><br><span class="line">    db_config      = object(&#123;</span><br><span class="line">      az        = string</span><br><span class="line">      subnet_id = string</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;web_app&quot; &#123;</span><br><span class="line">  name_regex = &quot;^WebApp&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;mysql&quot; &#123;</span><br><span class="line">  name_regex = &quot;^MySql 5.7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web_app&quot; &#123;</span><br><span class="line">  availability_zone = var.network_config.web_app_config.az</span><br><span class="line">  image_id          = data.ucloud_images.web_app.images[0].id</span><br><span class="line">  instance_type     = &quot;n-basic-2&quot;</span><br><span class="line">  vpc_id            = var.network_config.vpc_id</span><br><span class="line">  subnet_id         = var.network_config.web_app_config.subnet_id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;mysql&quot; &#123;</span><br><span class="line">  availability_zone = var.network_config.db_config.az</span><br><span class="line">  image_id          = data.ucloud_images.mysql.images[0].id</span><br><span class="line">  instance_type     = &quot;n-basic-2&quot;</span><br><span class="line">  vpc_id            = var.network_config.vpc_id</span><br><span class="line">  subnet_id         = var.network_config.db_config.subnet_id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在代码中我们把依赖的网络参数定义为一个复杂类型，一个强类型对象结构。这样的话模块代码就不用再关注网络层究竟是查询而来的还是创建的，模块中只定义了抽象的网络层定义，其具体实现由调用者从外部注入，从而实现了依赖反转。</p>
<p>如果调用者需要创建网络层，那么代码可以是这样的(假设我们把前面编写的模块保存在 <code>./machine</code> 目录下而成为一个内嵌模块)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  cidr_blocks = [</span><br><span class="line">    &quot;192.168.0.0/16&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;dmz&quot; &#123;</span><br><span class="line">  cidr_block = &quot;192.168.0.0/24&quot;</span><br><span class="line">  vpc_id     = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;db&quot; &#123;</span><br><span class="line">  cidr_block = &quot;192.168.1.0/24&quot;</span><br><span class="line">  vpc_id     = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module &quot;machine&quot; &#123;</span><br><span class="line">  source         = &quot;./machine&quot;</span><br><span class="line">  network_config = &#123;</span><br><span class="line">    vpc_id         = ucloud_vpc.vpc.id</span><br><span class="line">    web_app_config = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = ucloud_subnet.dmz.id</span><br><span class="line">    &#125;</span><br><span class="line">    db_config      = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = ucloud_subnet.db.id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者我们想使用现存的网络来托管服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">data &quot;ucloud_vpcs&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  name_regex = &quot;^AVeryImportantVpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_subnets&quot; dmz_subnet &#123;</span><br><span class="line">  vpc_id     = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">  name_regex = &quot;^DMZ&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_subnets&quot; &quot;db_subnet&quot; &#123;</span><br><span class="line">  vpc_id     = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">  name_regex = &quot;^DataBase&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module &quot;machine&quot; &#123;</span><br><span class="line">  source         = &quot;./machine&quot;</span><br><span class="line">  network_config = &#123;</span><br><span class="line">    vpc_id         = data.ucloud_vpcs.vpc.vpcs[0].id</span><br><span class="line">    web_app_config = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = data.ucloud_subnets.dmz_subnet.subnets[0].id</span><br><span class="line">    &#125;</span><br><span class="line">    db_config      = &#123;</span><br><span class="line">      az        = &quot;cn-bj2-02&quot;</span><br><span class="line">      subnet_id = data.ucloud_subnets.db_subnet.subnets[0].id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于模块代码中对网络层的定义是抽象的，并没有指定必须是 <code>resource</code> 或是 <code>data</code>，所以使得模块的调用者可以自己决定如何构造模块的依赖层，作为参数注入模块。</p>
<ul>
<li><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"><strong>1.9.3.1.</strong> 多可用区分布</a></li>
</ul>
<p><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"></a></p>
<h2 id="1-9-3-1-多可用区分布"><a href="#%E5%A4%9A%E5%8F%AF%E7%94%A8%E5%8C%BA%E5%88%86%E5%B8%83"></a>1.9.3.1. 多可用区分布</h2>
<p>这是一个相当常见的小技巧。多数公有云为了高可用性，都在单一区域内提供了多可用区的设计。一个可区是一个逻辑上的数据中心，单个可用区可能由于各种自然灾害、网络故障而导致不可用，所以公有云应用部署高可用应用应时刻考虑跨可用区设计。</p>
<p>假如我们想要创建 N 台不同的云主机实例，在 Terraform 0.12 之前的版本中，我们只能用 <code>count</code> 配合模运算来达成这个目的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type    = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;instance_count&quot; &#123;</span><br><span class="line">  type    = number</span><br><span class="line">  default = 4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  count             = var.instance_count</span><br><span class="line">  availability_zone = var.az[count.index % length(var.az)]</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  name              = &quot;$&#123;var.az[count.index % length(var.az)]&#125;-$&#123;floor(count.index/length(var.az))&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说就是使用 <code>count</code> 创建多实例资源时，用 <code>var.az[count.index % length(var.az)]</code> 可以循环使用每个可用区，使得机器尽可能均匀分布在各个可用区。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web[2]: Creating...</span><br><span class="line">ucloud_instance.web[0]: Creating...</span><br><span class="line">ucloud_instance.web[1]: Creating...</span><br><span class="line">ucloud_instance.web[3]: Creating...</span><br><span class="line">ucloud_instance.web[2]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[1]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[3]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[2]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[1]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[3]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[2]: Creation complete after 22s [<span class="built_in">id</span>=uhost-txa2owrp]</span><br><span class="line">ucloud_instance.web[3]: Creation complete after 24s [<span class="built_in">id</span>=uhost-v3qxdbju]</span><br><span class="line">ucloud_instance.web[1]: Creation complete after 26s [<span class="built_in">id</span>=uhost-td3x545p]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web[0]: Creation complete after 43s [<span class="built_in">id</span>=uhost-scq1prqj]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 4 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure>
<p>我们可以看一下创建的主机信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line">$ terraform show</span><br><span class="line"><span class="comment"># data.ucloud_images.centos:</span></span><br><span class="line">data <span class="string">&quot;ucloud_images&quot;</span> <span class="string">&quot;centos&quot;</span> &#123;</span><br><span class="line">    <span class="built_in">id</span>          = <span class="string">&quot;475496684&quot;</span></span><br><span class="line">    ids         = [</span><br><span class="line">        <span class="string">&quot;uimage-22noyd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-3p0wg0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-4keil1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-aqvo5l&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-f1chxn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-hq5elw&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uimage-rkn1v2&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    images      = [</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-23T17:39:46+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.0 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.0 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:03+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-f1chxn&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.2 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.2 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-09-09T11:40:31+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot; &quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-aqvo5l&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.4 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.4 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2020-05-07T17:40:42+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CloudInit&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-hq5elw&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.6 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.6 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:05+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-3p0wg0&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.3 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.3 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:05:02+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-4keil1&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.1 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.1 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            availability_zone = <span class="string">&quot;cn-bj2-02&quot;</span></span><br><span class="line">            create_time       = <span class="string">&quot;2019-04-16T21:04:53+08:00&quot;</span></span><br><span class="line">            description       = <span class="string">&quot;&quot;</span></span><br><span class="line">            features          = [</span><br><span class="line">                <span class="string">&quot;NetEnhanced&quot;</span>,</span><br><span class="line">                <span class="string">&quot;HotPlug&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">            <span class="built_in">id</span>                = <span class="string">&quot;uimage-22noyd&quot;</span></span><br><span class="line">            name              = <span class="string">&quot;CentOS 7.5 64位&quot;</span></span><br><span class="line">            os_name           = <span class="string">&quot;CentOS 7.5 64位&quot;</span></span><br><span class="line">            os_type           = <span class="string">&quot;linux&quot;</span></span><br><span class="line">            size              = 20</span><br><span class="line">            status            = <span class="string">&quot;Available&quot;</span></span><br><span class="line">            <span class="built_in">type</span>              = <span class="string">&quot;base&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    most_recent = <span class="literal">false</span></span><br><span class="line">    name_regex  = <span class="string">&quot;^CentOS 7&quot;</span></span><br><span class="line">    total_count = 7</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[1]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-04-0&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[2]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[3]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;31e2cad6-79a1-4475-a9f5-2c5c95605b18&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-v3qxdbju&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-04-1&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ucloud_instance.web[0]:</span></span><br><span class="line">resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">    auto_renew        = <span class="literal">true</span></span><br><span class="line">    availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">    boot_disk_size    = 20</span><br><span class="line">    boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">    charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">    cpu               = 1</span><br><span class="line">    cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">    create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span></span><br><span class="line">    disk_set          = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">id</span>      = <span class="string">&quot;da27595d-9645-4883-bf95-87b9076ab7e4&quot;</span></span><br><span class="line">            is_boot = <span class="literal">true</span></span><br><span class="line">            size    = 20</span><br><span class="line">            <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span></span><br><span class="line">    <span class="built_in">id</span>                = <span class="string">&quot;uhost-scq1prqj&quot;</span></span><br><span class="line">    image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">    instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">    ip_set            = [</span><br><span class="line">        &#123;</span><br><span class="line">            internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">            ip            = <span class="string">&quot;10.9.107.152&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">    memory            = 4</span><br><span class="line">    name              = <span class="string">&quot;cn-bj2-03-0&quot;</span></span><br><span class="line">    private_ip        = <span class="string">&quot;10.9.107.152&quot;</span></span><br><span class="line">    root_password     = (sensitive value)</span><br><span class="line">    security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">    status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">    subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">    tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">    vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，主机的确是均匀地分散在两个可用区了。</p>
<p>但是这样做在调整可用区时会发生大问题，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">#    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们禁用了 <code>cn-bj2-04</code> 可用区，按道理我们期待的变更计划应该是将两台原本属于 <code>cn-bj2-04</code> 的主机删除，在 <code>cn-bj2-03</code> 可用区新增两台主机。让我们看看会发生什么：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to <span class="built_in">local</span> or remote state storage.</span><br><span class="line"></span><br><span class="line">data.ucloud_images.centos: Refreshing state... [<span class="built_in">id</span>=475496684]</span><br><span class="line">ucloud_instance.web[0]: Refreshing state... [<span class="built_in">id</span>=uhost-scq1prqj]</span><br><span class="line">ucloud_instance.web[3]: Refreshing state... [<span class="built_in">id</span>=uhost-v3qxdbju]</span><br><span class="line">ucloud_instance.web[2]: Refreshing state... [<span class="built_in">id</span>=uhost-txa2owrp]</span><br><span class="line">ucloud_instance.web[1]: Refreshing state... [<span class="built_in">id</span>=uhost-td3x545p]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">An execution plan has been generated and is shown below.</span><br><span class="line">Resource actions are indicated with the following symbols:</span><br><span class="line">  ~ update in-place</span><br><span class="line">-/+ destroy and <span class="keyword">then</span> create replacement</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[1] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.44.37&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[2] will be updated in-place</span></span><br><span class="line">  ~ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">        auto_renew        = <span class="literal">true</span></span><br><span class="line">        availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">        boot_disk_size    = 20</span><br><span class="line">        boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">        cpu               = 1</span><br><span class="line">        cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">        create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">        disk_set          = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">                is_boot = <span class="literal">true</span></span><br><span class="line">                size    = 20</span><br><span class="line">                <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">        expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">        <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">        image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">        ip_set            = [</span><br><span class="line">            &#123;</span><br><span class="line">                internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">                ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ]</span><br><span class="line">        memory            = 4</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-03-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">        private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">        root_password     = (sensitive value)</span><br><span class="line">        security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">        status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">        subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">        vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[3] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;31e2cad6-79a1-4475-a9f5-2c5c95605b18&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-v3qxdbju&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.85.40&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-3&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.85.40&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 1 to change, 2 to destroy.</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Note: You didn<span class="string">&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraform</span></span><br><span class="line"><span class="string">can&#x27;</span>t guarantee that exactly these actions will be performed <span class="keyword">if</span></span><br><span class="line"><span class="string">&quot;terraform apply&quot;</span> is subsequently run.</span><br></pre></td></tr></table></figure>
<p>变更计划与期望略有不同。我们仔细看细节：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ucloud_instance.web[2] will be updated in-place</span></span><br><span class="line">~ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      auto_renew        = <span class="literal">true</span></span><br><span class="line">      availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      boot_disk_size    = 20</span><br><span class="line">      boot_disk_type    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">      charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      cpu               = 1</span><br><span class="line">      cpu_platform      = <span class="string">&quot;Intel/IvyBridge&quot;</span></span><br><span class="line">      create_time       = <span class="string">&quot;2020-11-28T23:09:01+08:00&quot;</span></span><br><span class="line">      disk_set          = [</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="built_in">id</span>      = <span class="string">&quot;1d7f07c9-7342-431b-85bb-d3ee0022063d&quot;</span></span><br><span class="line">              is_boot = <span class="literal">true</span></span><br><span class="line">              size    = 20</span><br><span class="line">              <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">      ]</span><br><span class="line">      expire_time       = <span class="string">&quot;2020-11-29T00:09:02+08:00&quot;</span></span><br><span class="line">      <span class="built_in">id</span>                = <span class="string">&quot;uhost-txa2owrp&quot;</span></span><br><span class="line">      image_id          = <span class="string">&quot;uimage-pxplaj&quot;</span></span><br><span class="line">      instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ip_set            = [</span><br><span class="line">          &#123;</span><br><span class="line">              internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              ip            = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">      ]</span><br><span class="line">      memory            = 4</span><br><span class="line">    ~ name              = <span class="string">&quot;cn-bj2-03-1&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">      private_ip        = <span class="string">&quot;10.9.45.234&quot;</span></span><br><span class="line">      root_password     = (sensitive value)</span><br><span class="line">      security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span></span><br><span class="line">      status            = <span class="string">&quot;Running&quot;</span></span><br><span class="line">      subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span></span><br><span class="line">      tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>原本名为 <code>cn-bj2-03-1</code> 的主机被更名为 <code>cn-bj2-03-2</code> 了，原本属于 <code>cn-bj2-04</code> 的第一台主机的变更计划是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># ucloud_instance.web[1] must be replaced</span></span><br><span class="line">-/+ resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      ~ auto_renew        = <span class="literal">true</span> -&gt; (known after apply)</span><br><span class="line">      ~ availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03&quot;</span> <span class="comment"># forces replacement</span></span><br><span class="line">      ~ boot_disk_size    = 20 -&gt; (known after apply)</span><br><span class="line">      ~ boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; (known after apply)</span><br><span class="line">        charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      ~ cpu               = 1 -&gt; (known after apply)</span><br><span class="line">      ~ cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ create_time       = <span class="string">&quot;2020-11-28T23:09:04+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      ~ disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;df06380a-00e1-42df-8c07-eec67d817f97&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      ~ expire_time       = <span class="string">&quot;2020-11-29T00:09:06+08:00&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ <span class="built_in">id</span>                = <span class="string">&quot;uhost-td3x545p&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">        instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      ~ ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.44.37&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      ~ memory            = 4 -&gt; (known after apply)</span><br><span class="line">      ~ name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; <span class="string">&quot;cn-bj2-03-1&quot;</span></span><br><span class="line">      ~ private_ip        = <span class="string">&quot;10.9.44.37&quot;</span> -&gt; (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      ~ root_password     = (sensitive value)</span><br><span class="line">      ~ security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ status            = <span class="string">&quot;Running&quot;</span> -&gt; (known after apply)</span><br><span class="line">      ~ subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; (known after apply)</span><br><span class="line">        tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      ~ vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; (known after apply)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>它的名字从 <code>cn-bj2-04-0</code> 变成了 <code>cn-bj2-03-1</code>。</p>
<p>仔细想想，实际上这是一个比较低效的变更计划。原本属于 <code>cn-bj2-03</code> 的两台主机应该不做任何变更，只需要删除 <code>cn-bj2-04</code> 的主机，再补充两台 <code>cn-bj2-03</code> 的主机即可。这是因为我们使用的是 <code>count</code>，而 <code>count</code> 只看元素在列表中的序号。当我们删除一个可用区时，实际上会引起主机序号的重大变化，导致出现大量低效的变更，这就是我们在讲 <code>count</code> 与 <code>for_each</code> 时强调过的，如果创建的资源实例彼此之间几乎完全一致，那么 <code>count</code> 比较合适。否则，那么使用 <code>for_each</code> 会更加安全。</p>
<p>让我们尝试使用 <code>for_each</code> 改写这段逻辑：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type    = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;instance_count&quot; &#123;</span><br><span class="line">  type    = number</span><br><span class="line">  default = 4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">locals &#123;</span><br><span class="line">  instance_names = [for i in range(var.instance_count):&quot;$&#123;var.az[i%length(var.az)]&#125;-$&#123;floor(i/length(var.az))&#125;&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  for_each          = toset(local.instance_names)</span><br><span class="line">  name              = each.value</span><br><span class="line">  availability_zone = var.az[index(local.instance_names, each.value) % length(var.az)]</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了生成主机独一无二的名字，我们首先用 <code>range</code> 函数生成了一个序号集合，比如目标主机数是 <code>4</code>，那么 <code>range(4)</code> 的结果就是 <code>[0, 1, 2, 3]</code>；然后我们通过取模运算使得名字前缀在可用区列表之间循环递增，最后用 <code>floor(i/length(var.az))</code> 计算出当前序号对应在当前可用区是第几台。例如 4 号主机在第二个可用区就是第二台，生成的名字应该就是 <code>cn-bj-04-1</code>。</p>
<p>执行结果是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Creating...</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Creation complete after 21s [<span class="built_in">id</span>=uhost-fjci1i4o]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Creation complete after 23s [<span class="built_in">id</span>=uhost-bkkhmref]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Creation complete after 26s [<span class="built_in">id</span>=uhost-amosgdaa]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Creation complete after 45s [<span class="built_in">id</span>=uhost-kltudgnf]</span><br><span class="line"></span><br><span class="line">Apply complete! Resources: 4 added, 0 changed, 0 destroyed.</span><br></pre></td></tr></table></figure>
<p>如果我们去掉一个可用区：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;az&quot; &#123;</span><br><span class="line">  type = list(string)</span><br><span class="line">  default = [</span><br><span class="line">    &quot;cn-bj2-03&quot;,</span><br><span class="line">#    &quot;cn-bj2-04&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以检查一下执行计划：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">$ terraform plan</span><br><span class="line">Refreshing Terraform state in-memory prior to plan...</span><br><span class="line">The refreshed state will be used to calculate this plan, but will not be</span><br><span class="line">persisted to <span class="built_in">local</span> or remote state storage.</span><br><span class="line"></span><br><span class="line">data.ucloud_images.centos: Refreshing state... [<span class="built_in">id</span>=475496684]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-1&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-amosgdaa]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-0&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-bkkhmref]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-03-0&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-kltudgnf]</span><br><span class="line">ucloud_instance.web[<span class="string">&quot;cn-bj2-04-1&quot;</span>]: Refreshing state... [<span class="built_in">id</span>=uhost-fjci1i4o]</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">An execution plan has been generated and is shown below.</span><br><span class="line">Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line">  - destroy</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-03-2&quot;] will be created</span></span><br><span class="line">  + resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      + auto_renew        = (known after apply)</span><br><span class="line">      + availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      + boot_disk_size    = (known after apply)</span><br><span class="line">      + boot_disk_type    = (known after apply)</span><br><span class="line">      + charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      + cpu               = (known after apply)</span><br><span class="line">      + cpu_platform      = (known after apply)</span><br><span class="line">      + create_time       = (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      + disk_set          = (known after apply)</span><br><span class="line">      + expire_time       = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                = (known after apply)</span><br><span class="line">      + image_id          = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">      + instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      + ip_set            = (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      + memory            = (known after apply)</span><br><span class="line">      + name              = <span class="string">&quot;cn-bj2-03-2&quot;</span></span><br><span class="line">      + private_ip        = (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      + root_password     = (sensitive value)</span><br><span class="line">      + security_group    = (known after apply)</span><br><span class="line">      + status            = (known after apply)</span><br><span class="line">      + subnet_id         = (known after apply)</span><br><span class="line">      + tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      + vpc_id            = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-03-3&quot;] will be created</span></span><br><span class="line">  + resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      + auto_renew        = (known after apply)</span><br><span class="line">      + availability_zone = <span class="string">&quot;cn-bj2-03&quot;</span></span><br><span class="line">      + boot_disk_size    = (known after apply)</span><br><span class="line">      + boot_disk_type    = (known after apply)</span><br><span class="line">      + charge_type       = <span class="string">&quot;dynamic&quot;</span></span><br><span class="line">      + cpu               = (known after apply)</span><br><span class="line">      + cpu_platform      = (known after apply)</span><br><span class="line">      + create_time       = (known after apply)</span><br><span class="line">      + data_disk_size    = (known after apply)</span><br><span class="line">      + data_disk_type    = (known after apply)</span><br><span class="line">      + disk_set          = (known after apply)</span><br><span class="line">      + expire_time       = (known after apply)</span><br><span class="line">      + <span class="built_in">id</span>                = (known after apply)</span><br><span class="line">      + image_id          = <span class="string">&quot;uimage-rkn1v2&quot;</span></span><br><span class="line">      + instance_type     = <span class="string">&quot;n-standard-1&quot;</span></span><br><span class="line">      + ip_set            = (known after apply)</span><br><span class="line">      + isolation_group   = (known after apply)</span><br><span class="line">      + memory            = (known after apply)</span><br><span class="line">      + name              = <span class="string">&quot;cn-bj2-03-3&quot;</span></span><br><span class="line">      + private_ip        = (known after apply)</span><br><span class="line">      + remark            = (known after apply)</span><br><span class="line">      + root_password     = (sensitive value)</span><br><span class="line">      + security_group    = (known after apply)</span><br><span class="line">      + status            = (known after apply)</span><br><span class="line">      + subnet_id         = (known after apply)</span><br><span class="line">      + tag               = <span class="string">&quot;Default&quot;</span></span><br><span class="line">      + vpc_id            = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-04-0&quot;] will be destroyed</span></span><br><span class="line">  - resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      - auto_renew        = <span class="literal">true</span> -&gt; null</span><br><span class="line">      - availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; null</span><br><span class="line">      - boot_disk_size    = 20 -&gt; null</span><br><span class="line">      - boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; null</span><br><span class="line">      - charge_type       = <span class="string">&quot;dynamic&quot;</span> -&gt; null</span><br><span class="line">      - cpu               = 1 -&gt; null</span><br><span class="line">      - cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; null</span><br><span class="line">      - create_time       = <span class="string">&quot;2020-11-28T22:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;b214d840-ffec-4958-a3da-3580846fd2a3&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - expire_time       = <span class="string">&quot;2020-11-28T23:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - <span class="built_in">id</span>                = <span class="string">&quot;uhost-bkkhmref&quot;</span> -&gt; null</span><br><span class="line">      - image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; null</span><br><span class="line">      - instance_type     = <span class="string">&quot;n-standard-1&quot;</span> -&gt; null</span><br><span class="line">      - ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.48.82&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - memory            = 4 -&gt; null</span><br><span class="line">      - name              = <span class="string">&quot;cn-bj2-04-0&quot;</span> -&gt; null</span><br><span class="line">      - private_ip        = <span class="string">&quot;10.9.48.82&quot;</span> -&gt; null</span><br><span class="line">      - root_password     = (sensitive value)</span><br><span class="line">      - security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; null</span><br><span class="line">      - status            = <span class="string">&quot;Running&quot;</span> -&gt; null</span><br><span class="line">      - subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; null</span><br><span class="line">      - tag               = <span class="string">&quot;Default&quot;</span> -&gt; null</span><br><span class="line">      - vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ucloud_instance.web[&quot;cn-bj2-04-1&quot;] will be destroyed</span></span><br><span class="line">  - resource <span class="string">&quot;ucloud_instance&quot;</span> <span class="string">&quot;web&quot;</span> &#123;</span><br><span class="line">      - auto_renew        = <span class="literal">true</span> -&gt; null</span><br><span class="line">      - availability_zone = <span class="string">&quot;cn-bj2-04&quot;</span> -&gt; null</span><br><span class="line">      - boot_disk_size    = 20 -&gt; null</span><br><span class="line">      - boot_disk_type    = <span class="string">&quot;local_normal&quot;</span> -&gt; null</span><br><span class="line">      - charge_type       = <span class="string">&quot;dynamic&quot;</span> -&gt; null</span><br><span class="line">      - cpu               = 1 -&gt; null</span><br><span class="line">      - cpu_platform      = <span class="string">&quot;Intel/Broadwell&quot;</span> -&gt; null</span><br><span class="line">      - create_time       = <span class="string">&quot;2020-11-28T22:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - disk_set          = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - <span class="built_in">id</span>      = <span class="string">&quot;6a3f274f-e072-4a46-90f8-edc7dbaa27f7&quot;</span></span><br><span class="line">              - is_boot = <span class="literal">true</span></span><br><span class="line">              - size    = 20</span><br><span class="line">              - <span class="built_in">type</span>    = <span class="string">&quot;local_normal&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - expire_time       = <span class="string">&quot;2020-11-28T23:35:53+08:00&quot;</span> -&gt; null</span><br><span class="line">      - <span class="built_in">id</span>                = <span class="string">&quot;uhost-fjci1i4o&quot;</span> -&gt; null</span><br><span class="line">      - image_id          = <span class="string">&quot;uimage-dhe5m2&quot;</span> -&gt; null</span><br><span class="line">      - instance_type     = <span class="string">&quot;n-standard-1&quot;</span> -&gt; null</span><br><span class="line">      - ip_set            = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - internet_type = <span class="string">&quot;Private&quot;</span></span><br><span class="line">              - ip            = <span class="string">&quot;10.9.176.28&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; null</span><br><span class="line">      - memory            = 4 -&gt; null</span><br><span class="line">      - name              = <span class="string">&quot;cn-bj2-04-1&quot;</span> -&gt; null</span><br><span class="line">      - private_ip        = <span class="string">&quot;10.9.176.28&quot;</span> -&gt; null</span><br><span class="line">      - root_password     = (sensitive value)</span><br><span class="line">      - security_group    = <span class="string">&quot;firewall-juhsrlvr&quot;</span> -&gt; null</span><br><span class="line">      - status            = <span class="string">&quot;Running&quot;</span> -&gt; null</span><br><span class="line">      - subnet_id         = <span class="string">&quot;subnet-dtu3dgpr&quot;</span> -&gt; null</span><br><span class="line">      - tag               = <span class="string">&quot;Default&quot;</span> -&gt; null</span><br><span class="line">      - vpc_id            = <span class="string">&quot;uvnet-f1c3jq2b&quot;</span> -&gt; null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 2 to destroy.</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Note: You didn<span class="string">&#x27;t specify an &quot;-out&quot; parameter to save this plan, so Terraform</span></span><br><span class="line"><span class="string">can&#x27;</span>t guarantee that exactly these actions will be performed <span class="keyword">if</span></span><br><span class="line"><span class="string">&quot;terraform apply&quot;</span> is subsequently run.</span><br></pre></td></tr></table></figure>
<p>可以看到，原来属于 <code>cn-bj2-03</code> 的两台主机原封不动，删除了属于 <code>cn-bj2-04</code> 的两台主机，并且在 <code>cn-bj2-03</code> 可用区新增两台主机。</p>
<ul>
<li><a href="#provisioner-%E4%B8%8E-userdata"><strong>1.9.4.1.</strong> provisioner 与 user_data</a></li>
</ul>
<p><a href="#provisioner-%E4%B8%8E-userdata"></a></p>
<h2 id="1-9-4-1-provisioner-与-user-data"><a href="#provisioner-%E4%B8%8E-userdata"></a>1.9.4.1. provisioner 与 user_data</h2>
<p>我们在介绍资源时介绍了<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/6.%E8%B5%84%E6%BA%90.html#provisioner-%E5%92%8C-connection">预置器 <code>provisioner</code></a>。同时不少公有云厂商的虚拟机都提供了 cloud-init 功能，可以让我们在虚拟机实例第一次启动时执行一段自定义的脚本来执行一些初始化操作。例如我们在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/1.Terraform%E5%88%9D%E6%AD%A5%E4%BD%93%E9%AA%8C/">Terraform 初步体验</a>一章里举的例子，在 UCloud 主机第一次启动时我们通过 <code>user_data</code> 来调用 yum 安装并配置了 ngnix 服务。预置器与 cloud-init 都可以用于初始化虚拟机，那么我们应该用哪一种呢？</p>
<p>首先要指出的是，<code>provisioner</code> 的官方文档里明确指出，由于预置器内部的行为 Terraform 无法感知，无法将它执行的变更纳入到声明式的代码管理中，所以预置器应被作为最后的手段使用，那么也就是说，如果 cloud-init 能够满足我们的要求，那么我们应该优先使用 cloud-init。</p>
<p>但是仍然存在一些 cloud-init 无法满足的场景。例如一个最常见的情况是，比如我们要在 cloud-init 当中格式化卷，后续的所有操作都必须在主机成功格式化并挂载卷之后才能顺利进行下去。但是比如 <code>aws_instance</code>，它的创建是不会等待 <code>user_data</code> 代码执行完成的，只要虚拟机创建成功开始启动，Terraform 就会认为资源创建完成从而继续后续的创建了。</p>
<p>解决这个问题目前来看还是只能依靠预置器。我们以一段 UCloud 云主机代码为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone         = &quot;cn-bj2-03&quot;</span><br><span class="line">  image_id                  = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type             = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type               = &quot;dynamic&quot;</span><br><span class="line">  network_interface &#123;</span><br><span class="line">    eip_internet_type = &quot;bgp&quot;</span><br><span class="line">    eip_charge_mode   = &quot;traffic&quot;</span><br><span class="line">    eip_bandwidth     = 1</span><br><span class="line">  &#125;</span><br><span class="line">  delete_eips_with_instance = true</span><br><span class="line">  root_password             = var.root_password</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = [for ipset in self.ip_set: ipset.ip if ipset.internet_type==&quot;BGP&quot;][0]</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">      timeout  = &quot;1h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;sleep 1h&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在资源声明中附加了一个 <code>remote-exec</code> 类型的预置器，它的 <code>host</code> 取值使用了 <code>self.ip_set</code>，<code>self</code> 在当前上下文中指代 <code>provisioner</code> 所属的 <code>ucloud_instance.web</code>，<code>ip_set</code> 是 <code>ucloud_instance</code> 的一个输出属性，内含云主机的内网 IP 以及绑定的弹性公网 IP 信息。我们用一个 <code>for</code> 表达式过滤出弹性公网 IP 地址，然后使用 ssh 连接。预置器执行的脚本代码很简单，休眠一小时。如果我们执行这段代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ terraform apply -auto-approve</span><br><span class="line">data.ucloud_images.centos: Refreshing state...</span><br><span class="line">ucloud_instance.web: Creating...</span><br><span class="line">ucloud_instance.web: Still creating... [10s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [20s elapsed]</span><br><span class="line">ucloud_instance.web: Provisioning with <span class="string">&#x27;remote-exec&#x27;</span>...</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web: Still creating... [30s elapsed]</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web: Still creating... [40s elapsed]</span><br><span class="line">ucloud_instance.web (remote-exec): Connecting to remote host via SSH...</span><br><span class="line">ucloud_instance.web (remote-exec):   Host: 106.75.87.148</span><br><span class="line">ucloud_instance.web (remote-exec):   User: root</span><br><span class="line">ucloud_instance.web (remote-exec):   Password: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Private key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Certificate: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec):   SSH Agent: <span class="literal">true</span></span><br><span class="line">ucloud_instance.web (remote-exec):   Checking Host Key: <span class="literal">false</span></span><br><span class="line">ucloud_instance.web (remote-exec): Connected!</span><br><span class="line">ucloud_instance.web: Still creating... [50s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m0s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m10s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m20s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m30s elapsed]</span><br><span class="line">ucloud_instance.web: Still creating... [1m40s elapsed]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>不出所料的话，该过程会持续一小时，也就是说，无论预置器脚本中执行的操作耗时多长，<code>ucloud_instance</code> 的创建都会等待它完成，或是触发超时。</p>
<p>在这里我们可以使用这种方法的前提是我们使用的 UCloud 云主机的资源定义允许我们定义资源时声明 <code>network_interface</code> 属性，直接绑定一个公网 IP。如果我们使用的云厂商 Provider 无法让我们在创建主机时绑定公网 IP，而是必须事后绑定弹性 IP 呢？又或者，初始化脚本必须在云主机成功绑定了云盘之后才能成功运行？这种情况下我们还有最后的武器，就是 <code>null_resource</code>。</p>
<p><code>null_resource</code> 可能是 Terraform 体系中最“不 Terraform”的存在，它就是我们用来在 Terraform 这样一个声明式世界里干各种命令式脏活的工具。<code>null_resouce</code> 本身是一个空的 <code>resource</code>，只有一个名为 <code>triggers</code> 的参数以及 <code>id</code> 作为输出属性。</p>
<p>我们看下这个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">data &quot;ucloud_images&quot; &quot;centos&quot; &#123;</span><br><span class="line">  name_regex = &quot;^CentOS 7&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip&quot; &quot;eip&quot; &#123;</span><br><span class="line">  internet_type = &quot;bgp&quot;</span><br><span class="line">  bandwidth     = 1</span><br><span class="line">  charge_mode   = &quot;traffic&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_disk&quot; &quot;data_disk&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  disk_size         = 10</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  disk_type         = &quot;data_disk&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  image_id          = data.ucloud_images.centos.images[0].id</span><br><span class="line">  instance_type     = &quot;n-standard-1&quot;</span><br><span class="line">  charge_type       = &quot;dynamic&quot;</span><br><span class="line">  root_password     = var.root_password</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_eip_association&quot; &quot;eip_association&quot; &#123;</span><br><span class="line">  eip_id      = ucloud_eip.eip.id</span><br><span class="line">  resource_id = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_disk_attachment&quot; &quot;data_disk&quot; &#123;</span><br><span class="line">  availability_zone = &quot;cn-bj2-03&quot;</span><br><span class="line">  disk_id           = ucloud_disk.data_disk.id</span><br><span class="line">  instance_id       = ucloud_instance.web.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;web_init&quot; &#123;</span><br><span class="line">  depends_on = [</span><br><span class="line">    ucloud_eip_association.eip_association,</span><br><span class="line">    ucloud_disk_attachment.data_disk</span><br><span class="line">  ]</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = ucloud_eip.eip.public_ip</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">    &#125;</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;echo hello&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们假设需要远程执行的操纵是必须在云盘挂载成功以后才可以运行的，那么我们可以声明一个 <code>null_resource</code>，把 <code>provisioner</code> 声明放在那里，通过显式声明 <code>depends_on</code> 确保它的执行一定是在云盘挂载结束以后。</p>
<p>另外这个例子里我们运行的脚本非常简单，考虑一种更加复杂一些的场景，我们运行的脚本是通过文件读取的，我们希望在文件内容发生变化时能够重新在服务器上运行该脚本，这时我们可以使用 <code>null_resource</code> 的 <code>triggers</code> 参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;null_resource&quot; &quot;web_init&quot; &#123;</span><br><span class="line">  depends_on = [</span><br><span class="line">    ucloud_eip_association.eip_association,</span><br><span class="line">    ucloud_disk_attachment.data_disk</span><br><span class="line">  ]</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    script_hash = filemd5(&quot;$&#123;path.module&#125;/init.sh&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    connection &#123;</span><br><span class="line">      type     = &quot;ssh&quot;</span><br><span class="line">      host     = ucloud_eip.eip.public_ip</span><br><span class="line">      user     = &quot;root&quot;</span><br><span class="line">      password = var.root_password</span><br><span class="line">    &#125;</span><br><span class="line">    script = &quot;$&#123;path.module&#125;/init.sh&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在 <code>provisioner</code> 运行的脚本是通过 <code>script</code> 参数传入的脚本文件路径，而我们通过 <code>filemd5</code> 函数把文件内容的哈希值传入了 <code>triggers</code>。<code>triggers</code> 会在值发生改变时触发 <code>null_resource</code> 的重建，这样脚本发生些许变化都会导致重新执行。</p>
<p>官方文档上还给出了对于 <code>triggers</code> 的另一个妙用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_instance&quot; &quot;cluster&quot; &#123;</span><br><span class="line">  count = 3</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;cluster&quot; &#123;</span><br><span class="line">  # Changes to any instance of the cluster requires re-provisioning</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    cluster_instance_ids = &quot;$&#123;join(&quot;,&quot;, aws_instance.cluster.*.id)&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # Bootstrap script can run on any instance of the cluster</span><br><span class="line">  # So we just choose the first in this case</span><br><span class="line">  connection &#123;</span><br><span class="line">    host = &quot;$&#123;element(aws_instance.cluster.*.public_ip, 0)&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  provisioner &quot;remote-exec&quot; &#123;</span><br><span class="line">    # Bootstrap script called with private_ip of each node in the clutser</span><br><span class="line">    inline = [</span><br><span class="line">      &quot;bootstrap-cluster.sh $&#123;join(&quot; &quot;, aws_instance.cluster.*.private_ip)&#125;&quot;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子里，我们需要所有 AWS 主机的内网 IP 参与才能够成功初始化集群，可能是类似 Kafka 或是 RabbitMQ 这样的应用，我们需要把集群节点的IP写入配置文件。如何确保未来机器数量发生调整以后，机器上的配置文件始终能够获得完整的集群内网 IP 信息，这里使用 <code>triggers</code> 就可以轻松完成目标。</p>
<p>另外在绝大多数生产环境中，服务器都不允许拥有独立的公网 IP，或是禁止从服务器对外服务的公网 IP 直接连接 ssh。这时一般我们会在集群中配置一台堡垒机，通过堡垒机进行跳转连接。可以访问<a target="_blank" rel="noopener" href="https://www.terraform.io/docs/provisioners/connection.html#connecting-through-a-bastion-host-with-ssh">通过堡垒机使用SSH的官方文档</a>获取详细信息，在此不再赘述。</p>
<h2 id="destroy-provisioner中使用变量"><a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/">destroy-provisioner中使用变量</a></h2>
<ul>
<li>
<p><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"><strong>1.9.5.1.</strong> destroy-provisioner 中使用变量</a></p>
</li>
<li>
<p><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><strong>1.9.5.1.1.</strong> 解决方法</a></p>
</li>
</ul>
<p><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"></a></p>
<h2 id="1-9-5-1-destroy-provisioner-中使用变量"><a href="#destroy-provisioner-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%98%E9%87%8F"></a>1.9.5.1. destroy-provisioner 中使用变量</h2>
<p>我们可以在定义一个 <code>provisioner</code> 块时设置 <code>when</code> 为 <code>destroy</code>，资源在销毁<strong>之前</strong>会首先执行 <code>provisioner</code>，可以帮助我们执行一些析构逻辑。但是如果我们在 Destroy-Provisioner 中引用了变量的话，比如这样的代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">&quot;aws_volume_attachment&quot;</span> <span class="string">&quot;attachement_myservice&quot;</span> &#123;</span><br><span class="line">  count         = <span class="string">&quot;$&#123;length(var.network_myservice_subnet_ids)&#125;&quot;</span></span><br><span class="line">  device_name   = <span class="string">&quot;/dev/xvdg&quot;</span></span><br><span class="line">  volume_id     =   <span class="string">&quot;$&#123;element(aws_ebs_volume.ebs_myservice.*.id, count.index)&#125;&quot;</span></span><br><span class="line">  instance_id   =   <span class="string">&quot;$&#123;element(aws_instance.myservice.*.id, count.index)&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">  provisioner <span class="string">&quot;local-exec&quot;</span> &#123;</span><br><span class="line">    command = <span class="string">&quot;aws ec2 stop-instances --instance-ids $&#123;element(aws_instance.myservice.*.id, count.index)&#125; --region $&#123;var.region&#125; &amp;&amp; sleep 30&quot;</span></span><br><span class="line">    when = <span class="string">&quot;destroy&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们会看见这样的报错信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|  Error: Invalid reference from destroy provisioner</span><br><span class="line">│ </span><br><span class="line">│ Destroy-time provisioners and their connection configurations may only reference attributes of the related resource, via &#x27;self&#x27;, &#x27;count.index&#x27;, or &#x27;each.key&#x27;.</span><br><span class="line">│ </span><br><span class="line">│ References to other resources during the destroy phase can cause dependency cycles and interact poorly with create_before_destroy.</span><br></pre></td></tr></table></figure>
<p>从 <code>0.12</code> 开始 Terraform 会对在 Destroy-Time Provisioner 中引用除 <code>self</code>、<code>count.index</code>、<code>each.key</code> 以外的变量做警告，从 <code>0.13</code> 开始则会直接报错。</p>
<h2 id="1-9-5-1-1-解决方法"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"></a>1.9.5.1.1. 解决方法</h2>
<p>目前官方推荐的做法是把需要引用的变量值通过 <code>triggers</code> “捕获”一下再引用，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">&quot;null_resource&quot;</span> <span class="string">&quot;foo&quot;</span> &#123;</span><br><span class="line">  triggers &#123;</span><br><span class="line">    interpreter = <span class="keyword">var</span>.local_exec_interpreter</span><br><span class="line">  &#125;</span><br><span class="line">  provisioner &#123;</span><br><span class="line">    when = destroy</span><br><span class="line"></span><br><span class="line">    interpreter = self.triggers.interpreter</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这种方法就可以避免这个问题。</p>
<ul>
<li>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"><strong>1.9.6.1.</strong> 利用 null_resource 的 triggers 触发其他资源更新</a></p>
</li>
<li>
<p><a href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><strong>1.9.6.1.1.</strong> 问题描述</a></p>
</li>
<li>
<p><a href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><strong>1.9.6.1.2.</strong> 问题原因</a></p>
</li>
<li>
<p><a href="#%E5%B7%A7%E7%94%A8-nullresource-%E7%9A%84-triggers"><strong>1.9.6.1.3.</strong> 巧用 null_resource 的 triggers</a></p>
</li>
<li>
<p><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%AE%9E%E9%AA%8C"><strong>1.9.6.1.4.</strong> 一个小实验</a></p>
</li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"></a></p>
<h2 id="1-9-6-1-利用-null-resource-的-triggers-触发其他资源更新"><a href="#%E5%88%A9%E7%94%A8-nullresource-%E7%9A%84-triggers-%E8%A7%A6%E5%8F%91%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90%E6%9B%B4%E6%96%B0"></a>1.9.6.1. 利用 null_resource 的 triggers 触发其他资源更新</h2>
<p>社区有人提了一个 Terraform 问题，他写了这样一段 Terraform 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;service_bus_connection_string&quot; &#123;</span><br><span class="line">  name = &quot;service-bus-connection-string&quot;</span><br><span class="line"></span><br><span class="line">  value        = azurerm_servicebus_topic_authorization_rule.mysb.primary_connection_string</span><br><span class="line">  key_vault_id = azurerm_key_vault.main.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_function_app&quot; &quot;main&quot; &#123;</span><br><span class="line">  name                = &quot;myfn&quot;</span><br><span class="line">  location            = azurerm_resource_group.main.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.main.name</span><br><span class="line"></span><br><span class="line">  app_service_plan_id = azurerm_app_service_plan.main.id</span><br><span class="line"></span><br><span class="line">  enable_builtin_logging = true</span><br><span class="line">  https_only             = true</span><br><span class="line">  os_type                = &quot;linux&quot;</span><br><span class="line"></span><br><span class="line">  storage_account_name       = azurerm_storage_account.main.name</span><br><span class="line">  storage_account_access_key = azurerm_storage_account.main.primary_access_key</span><br><span class="line"></span><br><span class="line">  version = &quot;~3&quot;</span><br><span class="line"></span><br><span class="line">  app_settings = &#123;</span><br><span class="line">    AzureWebJobsServiceBus      = &quot;@Microsoft.KeyVault(SecretUri=$&#123;azurerm_key_vault_secret.service_bus_connection_string.id&#125;)&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>意思大概是他把一段含有机密信息的连接字符串保存在 Azure KeyVault 服务中，然后创建了一个 Azure Faas 函数，通过 KeyVault 机密引用地址传递该机密。</p>
<h2 id="1-9-6-1-1-问题描述"><a href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"></a>1.9.6.1.1. 问题描述</h2>
<p>这位老兄发现，如果他修改了机密的内容，也就是 <code>azurerm_key_vault_secret</code> 声明里的 <code>value = azurerm_servicebus_topic_authorization_rule.mysb.primary_connection_string</code> 这一段的值的时候，KeyVault 保存的机密内容的确会正确更新，但 Azure Function 读取到的还是旧的机密引用地址，也就是这段代码中得到的 KeyVault 机密引用地址没有更新：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app_settings = &#123;</span><br><span class="line">  AzureWebJobsServiceBus      = &quot;@Microsoft.KeyVault(SecretUri=$&#123;azurerm_key_vault_secret.service_bus_connection_string.id&#125;)&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更加奇怪的是，这之后他什么都没有做，只是重新再执行一次 <code>terraform apply</code>，该引用地址又被正确更新了？！</p>
<h2 id="1-9-6-1-2-问题原因"><a href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"></a>1.9.6.1.2. 问题原因</h2>
<p>因为 KeyVault Secret 被设计成是不可变的，所以更新 <code>azurerm_key_vault_secret</code> 的 <code>value</code> 会导致资源被重新创建。Terraform 官网上的相关文档中对该参数的定义如下：</p>
<blockquote>
<p><code>value</code> - (Required) Specifies the value of the Key Vault Secret.</p>
</blockquote>
<p>在 Terraform 中 ，一个参数如果被标记为 <code>Required</code>，那么它不但是必填项，同时类似数据库记录的主键的概念，主键不同的记录被认定是两条不同的记录，修改记录的主键值可以看作是删除重建之。Terraform 资源的 <code>Required</code> 参数如果发生变化会触发重新创建资源，这就导致了修改 <code>value</code> 后，该 <code>azurerm_key_vault_secret</code> 的 <code>id</code> 也会发生变化。</p>
<p>那么为什么在 <code>azurerm_key_vault_secret</code> 被重新创建之后，我们会发现 <code>azurerm_function_app</code> 中引用的 <code>id</code> 没有变化呢？</p>
<p>Terraform 的工作流含有 Plan 和 Apply 两个主要阶段，首先会分析 Terraform 代码，调用 <code>terraform refresh</code>（可以用参数跳过该步骤）读取资源在云端目前的最新状态，再加上 State 文件中记录的状态，三个状态对比出一个执行计划，使得最终产生的云端状态能够符合当前代码描述的状态。</p>
<p>就这个场景而言，Terraform 能够意识到 <code>azurerm_key_vault_secret</code> 的参数发生了变化，这会导致某种程度的更新，但它无法意识到这个更新会导致 <code>azurerm_key_vault_secret</code> 的 <code>id</code> 发生变化，进而导致 <code>azurerm_function_app</code> 也必须进行更新，所以就发生了他第一次执行 <code>terraform apply</code> 后看到的情况。</p>
<p>当他第二次执行 <code>terraform apply</code> 时，Terraform 记录的 State 文件里，<code>azurerm_key_vault_secret</code> 的 <code>id</code>和<code>azurerm_function_app</code> 里使用的 <code>id</code> 已经对不上了，这时 Terraform 会再生成一个更新 <code>azurerm_function_app</code> 的 Plan，执行后一切恢复正常。</p>
<p>有没有办法让 <code>azurerm_function_app</code> 能在第一次生成 Plan 时就感知到这个变更？</p>
<h2 id="1-9-6-1-3-巧用-null-resource-的-triggers"><a href="#%E5%B7%A7%E7%94%A8-nullresource-%E7%9A%84-triggers"></a>1.9.6.1.3. 巧用 null_resource 的 triggers</h2>
<p>HashiCorp 提供了一个非常常用的内建 Provider —— <code>null</code>。其中最知名的资源就是 <code>null_resource</code> 了，一般它都是和 <code>provisioner</code> 搭配出现，可以用来在某些资源创建完成后执行一些自定义脚本等等。但是它还有一个很有用的参数：</p>
<blockquote>
<p>The <code>triggers</code> argument allows specifying an arbitrary set of values that, when changed, will cause the resource to be replaced.</p>
</blockquote>
<p><code>triggers</code> 参数可以用来指向一些值，只要这些值的内容发生了变动，会导致 <code>null_resource</code> 资源被重新创建，从而生成一个新的 <code>id</code>。</p>
<h2 id="1-9-6-1-4-一个小实验"><a href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%AE%9E%E9%AA%8C"></a>1.9.6.1.4. 一个小实验</h2>
<p>我们尝试构建一个简单的实验环境来验证一下，首先是这样一段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;example&quot; &#123;</span><br><span class="line">  name         = &quot;secret-sauce&quot;</span><br><span class="line">  value        = &quot;szechuan&quot;</span><br><span class="line">  key_vault_id = azurerm_key_vault.example.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;local_file&quot; &quot;output&quot; &#123;</span><br><span class="line">  filename = &quot;$&#123;path.module&#125;/output.txt&quot;</span><br><span class="line">  content = azurerm_key_vault_secret.example.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们创建一个 <code>azurerm_key_vault_secret</code>，然后把它的 <code>id</code> 输出到一个文件里。随后我们复制一下该文件，比如叫 <code>output.bak</code> 好了。随后我们修改 <code>azurerm_key_vault_secret</code> 的 <code>value</code> 到一个新的值，执行 <code>terraform apply</code> 以后，我们会发现 <code>output.txt</code> 与 <code>output.bak</code> 的内容完全一样，说明 <code>value</code> 的更新并没有触发 <code>local_file</code> 的更新。</p>
<p>随后我们把代码改成这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_key_vault_secret&quot; &quot;example&quot; &#123;</span><br><span class="line">  name         = &quot;secret-sauce&quot;</span><br><span class="line">  value        = &quot;szechuan2&quot;</span><br><span class="line">  key_vault_id = azurerm_key_vault.example.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;example&quot; &#123;</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    trigger = azurerm_key_vault_secret.example.value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;local_file&quot; &quot;output&quot; &#123;</span><br><span class="line">  filename = &quot;$&#123;path.module&#125;/output.txt&quot;</span><br><span class="line">  content = null_resource.example.id == null_resource.example.id ? azurerm_key_vault_secret.example.id : &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在代码中插入了一个 <code>null_resource</code>，并设置 <code>triggers</code> 的内容，盯住 <code>azurerm_key_vault_secret.example.value</code>。在 <code>value</code> 发生变化时，<code>null_resource</code> 的 <code>id</code> 也会发生变化。</p>
<p>然后我们在 <code>local_file</code> 的代码中，<code>content</code> 的赋值改成了这样一个三目表达式：<code>null_resource.example.id == null_resource.example.id ? azurerm_key_vault_secret.example.id : &quot;&quot;</code>。这个表达式里实际上 <code>null_resource.example.id</code> 是不起作用的，自己等于自己的永真条件会导致仍然使用 <code>azurerm_key_vault_secret.example.id</code> 作为值，但是由于掺入了 <code>null_resource.example.id</code>，使得 Terraform 在第一次计算 Plan 时就感知到 <code>local_file</code> 的内容发生了变化，从而使得我们可以一次 <code>terraform apply</code> 搞定。</p>
<ul>
<li><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"><strong>1.9.7.1.</strong> 利用 null_resource 搭配 replace_triggered_by 更新无法从服务端读取内容的属性</a></li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"></a></p>
<h2 id="1-9-7-1-利用-null-resource-搭配-replace-triggered-by-更新无法从服务端读取内容的属性"><a href="#%E5%88%A9%E7%94%A8-nullresource-%E6%90%AD%E9%85%8D-replacetriggeredby-%E6%9B%B4%E6%96%B0%E6%97%A0%E6%B3%95%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%BB%E5%8F%96%E5%86%85%E5%AE%B9%E7%9A%84%E5%B1%9E%E6%80%A7"></a>1.9.7.1. 利用 null_resource 搭配 replace_triggered_by 更新无法从服务端读取内容的属性</h2>
<p>曾经处理的一个提问，有人写了这样一段 Terraform 代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_container_group&quot; &quot;this&quot; &#123;</span><br><span class="line">  name                = var.name</span><br><span class="line">  location            = var.location</span><br><span class="line">  resource_group_name = var.resource_group_name</span><br><span class="line">  ip_address_type     = &quot;Private&quot;</span><br><span class="line">  network_profile_id  = azurerm_network_profile.this.id</span><br><span class="line">  os_type             = &quot;Linux&quot;</span><br><span class="line"></span><br><span class="line">  container &#123;</span><br><span class="line">    name   = &quot;someName&quot;</span><br><span class="line">    image  = &quot;someImage&quot;</span><br><span class="line">    cpu    = &quot;0.5&quot;</span><br><span class="line">    memory = &quot;0.5&quot;</span><br><span class="line"></span><br><span class="line">    commands = [&quot;some&quot;, &quot;commands&quot;]</span><br><span class="line"></span><br><span class="line">    ports &#123;</span><br><span class="line">      port     = 53</span><br><span class="line">      protocol = &quot;UDP&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    volume &#123;</span><br><span class="line">      mount_path = &quot;/app/conf&quot;</span><br><span class="line">      name       = &quot;someName&quot;</span><br><span class="line">      read_only  = true</span><br><span class="line">      secret = &#123;</span><br><span class="line">        Corefile = base64encode(someContent)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tags = var.tags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果每次执行 <code>apply</code> 操作时，都会发现 Terraform 试图重建这个容器：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># module.dns_forwarder.azurerm_container_group.this must be replaced</span><br><span class="line">-/+ resource &quot;azurerm_container_group&quot; &quot;this&quot; &#123;</span><br><span class="line">      ~ exposed_port        = [</span><br><span class="line">          - &#123;</span><br><span class="line">              - port     = 53</span><br><span class="line">              - protocol = &quot;UDP&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">        ] -&gt; (known after apply)</span><br><span class="line">      + fqdn                = (known after apply)</span><br><span class="line">      ~ id                  = &quot;/subscriptions/&lt;mySubId&gt;/resourceGroups/&lt;myRgName&gt;/providers/Microsoft.ContainerInstance/containerGroups/&lt;myContainerGroupName&gt;&quot; -&gt; (known after apply)</span><br><span class="line">      ~ ip_address          = &quot;someIp&quot; -&gt; (known after apply)</span><br><span class="line">        name                = &quot;someName&quot;</span><br><span class="line">      - tags                = &#123;&#125; -&gt; null</span><br><span class="line">        # (6 unchanged attributes hidden)</span><br><span class="line"></span><br><span class="line">      ~ container &#123;</span><br><span class="line">          - environment_variables        = &#123;&#125; -&gt; null</span><br><span class="line">            name                         = &quot;someName&quot;</span><br><span class="line">          - secure_environment_variables = (sensitive value)</span><br><span class="line">            # (4 unchanged attributes hidden)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          ~ volume &#123;</span><br><span class="line">                name       = &quot;someName&quot;</span><br><span class="line">              ~ secret     = (sensitive value) # forces replacement</span><br><span class="line">                # (3 unchanged attributes hidden)</span><br><span class="line">            &#125;</span><br><span class="line">            # (1 unchanged block hidden)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个问题的原因是 API 在读取容器信息时不会返回 <code>volume</code> 的 <code>secret</code> 数据，这其实是一个还挺合理的设定，机密数据的确不应该可以直接从 API 返回，但这就导致 Terraform 每次制定变更计划时都会试图重新设置这个值(因为会理解成服务端这个值被修改成了空)，而容器是不可变的，要修改容器的任何配置都会导致容器被重建。</p>
<p>有没有办法能够避免这种问题？经验告诉我们，可以使用 <code>ignore_changes</code> 让 Terraform 忽略这个属性的变更来避免重建，但如果 <code>secret</code> 真的变了怎么办？</p>
<p>我们可以这样干，第一，在 <code>azurerm_container_group</code> 添加这样一段 <code>lifecycle</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lifecycle &#123;</span><br><span class="line">    ignore_changes       = [container[0].volume[0].secret]</span><br><span class="line">    replace_triggered_by = [null_resource.secret_trigger.id]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这会忽略 <code>secret</code> 的变化，但我们同时声明了一个 <code>replace_triggered_by</code>，在 <code>null_resource.secret_trigger.id</code> 的值发生变化时可以删除重建 <code>azurerm_container_group</code> 实例。</p>
<p>其次，我们把 <code>secret</code> 的内容提取到一个 <code>local</code> 里，这时 <code>azurerm_container_group</code> 的 <code>volume</code> 看起来大概是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">volume &#123;</span><br><span class="line">    mount_path = &quot;/app/conf&quot;</span><br><span class="line">    name       = &quot;somename&quot;</span><br><span class="line">    read_only  = true</span><br><span class="line">    secret     = &#123;</span><br><span class="line">      Corefile = local.secret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>local.secret</code> 存放着使用的机密数据。这时我们再定义一个 <code>null_resource</code> 充当触发器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  secret = base64encode(&quot;abcdefg&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;secret_trigger&quot; &#123;</span><br><span class="line">  triggers = &#123;</span><br><span class="line">    trigger = local.secret</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在机密数据真的发生变化的时候，<code>triggers</code> 会触发 <code>null_resource</code> 的重建，导致 <code>null_resource.secret_trigger.id</code> 发生变化，进而触发 <code>azurerm_container_group</code> 的重建。</p>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"><strong>1.9.8.1.</strong> 创建资源的条件依赖另一个资源的输出时怎么办</a></li>
</ul>
<p><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"></a></p>
<h2 id="1-9-8-1-创建资源的条件依赖另一个资源的输出时怎么办"><a href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E7%9A%84%E6%9D%A1%E4%BB%B6%E4%BE%9D%E8%B5%96%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E7%9A%84%E8%BE%93%E5%87%BA%E6%97%B6%E6%80%8E%E4%B9%88%E5%8A%9E"></a>1.9.8.1. 创建资源的条件依赖另一个资源的输出时怎么办</h2>
<p>我们在<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/8.%E6%8A%80%E5%B7%A7/1.%E6%9C%89%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA">有条件创建</a>当中介绍了如何可以通过判断用户的输入参数来决定是否要创建某个资源，让我们来看一下这样一个 Module 的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;vpc_id&quot; &#123;</span><br><span class="line">  type    = string</span><br><span class="line">  default = null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  count       = var.vpc_id == null ? 1 : 0</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">  cidr_block = &quot;10.0.0.0/24&quot;</span><br><span class="line">  vpc_id     = var.vpc_id == null ? ucloud_vpc.vpc[0].id : var.vpc_id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们想在 Module 中创建一个 <code>ucloud_subnet</code>，用户可以输入一个 <code>vpc_id</code> 配置给它，也可以不输入，这时 Module 会创建一个 <code>ucloud_vpc</code> 来用。</p>
<p>假如我们使用这个模块，不传入 <code>vpc_id</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module vpc &#123;</span><br><span class="line">  source = &quot;./vpc&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码生成的 Plan 内容如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"></span><br><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_subnet.subnet will be created</span><br><span class="line">  + resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">      + cidr_block  = &quot;10.0.0.0/24&quot;</span><br><span class="line">      + create_time = (known after apply)</span><br><span class="line">      + id          = (known after apply)</span><br><span class="line">      + name        = (known after apply)</span><br><span class="line">      + remark      = (known after apply)</span><br><span class="line">      + tag         = &quot;Default&quot;</span><br><span class="line">      + vpc_id      = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_vpc.vpc[0] will be created</span><br><span class="line">  + resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">      + cidr_blocks  = [</span><br><span class="line">          + &quot;10.0.0.0/16&quot;,</span><br><span class="line">        ]</span><br><span class="line">      + create_time  = (known after apply)</span><br><span class="line">      + id           = (known after apply)</span><br><span class="line">      + name         = &quot;vpc&quot;</span><br><span class="line">      + network_info = (known after apply)</span><br><span class="line">      + remark       = (known after apply)</span><br><span class="line">      + tag          = &quot;Default&quot;</span><br><span class="line">      + update_time  = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>
<p>完全符合预期。假如我们希望由模块的调用者来创建 Vpc 的话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module vpc &#123;</span><br><span class="line">  source = &quot;./vpc&quot;</span><br><span class="line"></span><br><span class="line">  vpc_id = ucloud_vpc.vpc.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们执行 <code>terraform plan</code> 的话，会得到这样的结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">╷</span><br><span class="line">│ Error: Invalid count argument</span><br><span class="line">│ </span><br><span class="line">│   on vpc/main.tf line 16, in resource &quot;ucloud_vpc&quot; &quot;vpc&quot;:</span><br><span class="line">│   16:   count       = var.vpc_id == null ? 1 : 0</span><br><span class="line">│ </span><br><span class="line">│ The &quot;count&quot; value depends on resource attributes that cannot be determined until apply, so Terraform cannot predict how many instances will be created. To work around this,</span><br><span class="line">│ use the -target argument to first apply only the resources that the count depends on.</span><br><span class="line">╵</span><br></pre></td></tr></table></figure>
<p>Terraform 试图向我们抱怨，我们在 <code>count</code> 参数的表达式里使用了一个必须在 <code>apply</code> 阶段才能知道的值，所以它无法在 <code>plan</code> 阶段就计算出 <code>count</code> 的值。它建议我们先用 <code>terraform apply</code> 命令搭配 <code>-target</code> 参数把 Vpc 先创建出来，消除后续计算 Plan 时尚不知晓的值来解决这个问题。</p>
<p>这当然是一种很麻烦的方法，所以我们在设计 Module 时就要考虑到这种问题。有一种很简单的方法可以解决这个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;vpc&quot; &#123;</span><br><span class="line">  type    = object(</span><br><span class="line">    &#123;</span><br><span class="line">      id = string</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  default = null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">  count       = var.vpc == null ? 1 : 0</span><br><span class="line">  cidr_blocks = [&quot;10.0.0.0/16&quot;]</span><br><span class="line">  name        = &quot;vpc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">  cidr_block = &quot;10.0.0.0/24&quot;</span><br><span class="line">  vpc_id     = var.vpc == null ? ucloud_vpc.vpc[0].id : var.vpc.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把用来判断创建条件的输入参数类型改成 <code>object</code>，调用 Module 的代码就变成了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Terraform will perform the following actions:</span><br><span class="line"></span><br><span class="line">  # ucloud_vpc.vpc will be created</span><br><span class="line">  + resource &quot;ucloud_vpc&quot; &quot;vpc&quot; &#123;</span><br><span class="line">      + cidr_blocks  = [</span><br><span class="line">          + &quot;10.0.0.0/16&quot;,</span><br><span class="line">        ]</span><br><span class="line">      + create_time  = (known after apply)</span><br><span class="line">      + id           = (known after apply)</span><br><span class="line">      + name         = &quot;vpc&quot;</span><br><span class="line">      + network_info = (known after apply)</span><br><span class="line">      + remark       = (known after apply)</span><br><span class="line">      + tag          = &quot;Default&quot;</span><br><span class="line">      + update_time  = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  # module.vpc.ucloud_subnet.subnet will be created</span><br><span class="line">  + resource &quot;ucloud_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">      + cidr_block  = &quot;10.0.0.0/24&quot;</span><br><span class="line">      + create_time = (known after apply)</span><br><span class="line">      + id          = (known after apply)</span><br><span class="line">      + name        = (known after apply)</span><br><span class="line">      + remark      = (known after apply)</span><br><span class="line">      + tag         = &quot;Default&quot;</span><br><span class="line">      + vpc_id      = (known after apply)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Plan: 2 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>
<p>成功计算出 Plan。请注意虽然这个 Plan 仍然是创建两个资源，但 <code>ucloud_vpc</code> 资源并不是 Module 创建的。</p>
<p>这个方法的原理就是虽然 <code>var.vpc.id</code> 仍然是一个只有在 <code>apply</code> 阶段才能知道的值，但 <code>var.vpc</code> 本身是一个在 <code>plan</code> 阶段就可以知道的值，直接可以判读它是否为 <code>null</code>，所以该方法可以绕过这个限制。</p>
<ul>
<li><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><strong>1.9.9.1.</strong> 利用 create_before_destroy 调整资源 Update 的执行顺序</a></li>
</ul>
<p><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"></a></p>
<h2 id="1-9-9-1-利用-create-before-destroy-调整资源-Update-的执行顺序"><a href="#%E5%88%A9%E7%94%A8-createbeforedestroy-%E8%B0%83%E6%95%B4%E8%B5%84%E6%BA%90-update-%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"></a>1.9.9.1. 利用 create_before_destroy 调整资源 Update 的执行顺序</h2>
<p>最近处理了一个问题，有人写了这样一段代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;azurerm&quot; &#123;</span><br><span class="line">  features &#123;</span><br><span class="line">    resource_group &#123;</span><br><span class="line">      prevent_deletion_if_contains_resources = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_resource_group&quot; &quot;rg&quot; &#123;</span><br><span class="line">  location = &quot;eastus&quot;</span><br><span class="line">  name     = &quot;example&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">locals &#123;</span><br><span class="line">  environments = toset([&quot;one&quot;, &quot;two&quot;, &quot;three&quot;])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_public_ip&quot; &quot;lb&quot; &#123;</span><br><span class="line">  for_each = local.environments</span><br><span class="line"></span><br><span class="line">  name                = &quot;frontend-lb-$&#123;each.key&#125;&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  allocation_method   = &quot;Static&quot;</span><br><span class="line">  ip_version          = &quot;IPv4&quot;</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line">  zones               = [1, 2, 3]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;azurerm_lb&quot; &quot;this&quot; &#123;</span><br><span class="line">  name                = &quot;azurelb&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line"></span><br><span class="line">  dynamic &quot;frontend_ip_configuration&quot; &#123;</span><br><span class="line">    for_each = local.environments</span><br><span class="line">    content &#123;</span><br><span class="line">      name                 = frontend_ip_configuration.key</span><br><span class="line">      public_ip_address_id = azurerm_public_ip.lb[frontend_ip_configuration.key].id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当他从 <code>local.environments</code> 中删除一个元素，然后执行 <code>terraform apply</code> 时，他遇到了下面的问题：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">│ Error: deleting Public Ip Address: (Name &quot;azurelb&quot; / Resource Group &quot;example&quot;): network.PublicIPAddressesClient#Delete: Failure sending request: StatusCode=400 -- Original Error: Code=&quot;PublicIPAddressCannotBeDeleted&quot; Message=&quot;Public IP address /subscriptions/subscription-id/resourceGroups/resource-group/providers/Microsoft.Network/publicIPAddresses/one can not be deleted since it is still allocated to resource /subscriptions/subscription-id/resourceGroups/resource-group/providers/Microsoft.Network/loadBalancers/azurelb/frontendIPConfigurations/one. In order to delete the public IP, disassociate/detach the Public IP address from the resource.  To learn how to do this, see aka.ms/deletepublicip.&quot; Details=[]</span><br></pre></td></tr></table></figure>
<p>这其实是一个还挺常见的问题，<code>azurerm_lb.this</code> 依赖于 <code>azurerm_public_ip.lb[index]</code>，正确的变更顺序应该是先更新 <code>azurerm_lb.this</code>，再删除 <code>azurerm_public_ip.lb</code> 的成员，但是 Terraform 默认的执行顺序会首先尝试执行删除操作，这时因为 ip 仍然被 LoadBalancer 使用着，所以会引发一个错误。</p>
<p>解决方法是给 <code>azurerm_public.lb</code> 添加一个 <code>create_before_destroy</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;azurerm_public_ip&quot; &quot;lb&quot; &#123;</span><br><span class="line">  for_each = local.environments</span><br><span class="line"></span><br><span class="line">  name                = &quot;frontend-lb-$&#123;each.key&#125;&quot;</span><br><span class="line">  location            = azurerm_resource_group.rg.location</span><br><span class="line">  resource_group_name = azurerm_resource_group.rg.name</span><br><span class="line">  allocation_method   = &quot;Static&quot;</span><br><span class="line">  ip_version          = &quot;IPv4&quot;</span><br><span class="line">  sku                 = &quot;Standard&quot;</span><br><span class="line">  zones               = [1, 2, 3]</span><br><span class="line"></span><br><span class="line">  lifecycle &#123;</span><br><span class="line">    create_before_destroy = true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>create_before_destroy</code> 名字里虽然看起来是与 Create 有关，实际上它也会将 Update 与 Create 放在一起调整，声明该参数后实际上是将 <code>azurerm_public_ip.lb</code> 的 Delete 推迟到执行 Update 之后再执行了，该问题得解。</p>
<ul>
<li>
<p><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"><strong>1.9.10.1.</strong> Terraform 与自动化</a></p>
</li>
<li>
<p><a href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84-terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E4%BD%9C%E6%B5%81"><strong>1.9.10.1.1.</strong> 自动化的 Terraform 命令行工作流</a></p>
</li>
<li>
<p><a href="#%E6%8E%A7%E5%88%B6%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%AD%E7%9A%84-terraform-%E8%BE%93%E5%87%BA"><strong>1.9.10.1.2.</strong> 控制自动化中的 Terraform 输出</a></p>
</li>
<li>
<p><a href="#%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%9C%BA%E5%99%A8%E4%B8%8A%E8%BF%90%E8%A1%8C-plan-%E5%92%8C-apply"><strong>1.9.10.1.3.</strong> 在不同的机器上运行 plan 和 apply</a></p>
</li>
<li>
<p><a href="#%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%AE%A1%E6%89%B9%E8%AE%A1%E5%88%92"><strong>1.9.10.1.4.</strong> 交互式审批计划</a></p>
</li>
<li>
<p><a href="#%E8%87%AA%E5%8A%A8%E6%89%B9%E5%87%86%E8%AE%A1%E5%88%92"><strong>1.9.10.1.5.</strong> 自动批准计划</a></p>
</li>
<li>
<p><a href="#%E7%94%A8-terraform-plan-%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95-pull-requests"><strong>1.9.10.1.6.</strong> 用 terraform plan 命令测试 Pull Requests</a></p>
</li>
<li>
<p><a href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><strong>1.9.10.1.7.</strong> 多环境部署</a></p>
</li>
<li>
<p><a href="#%E9%A2%84%E5%85%88%E5%AE%89%E8%A3%85%E7%9A%84%E6%8F%92%E4%BB%B6"><strong>1.9.10.1.8.</strong> 预先安装的插件</a></p>
</li>
</ul>
<p><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"></a></p>
<h2 id="1-9-10-1-Terraform-与自动化"><a href="#terraform-%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"></a>1.9.10.1. Terraform 与自动化</h2>
<p>如果团队使用 Terraform 作为变更管理和部署管道的核心工具，可能需要以某种自动化方式编排 Terraform 的运行，以确保运行之间的一致性，并提供其他有趣的功能，例如与版本控制系统钩子的集成。</p>
<p>Terraform 的自动化可以有多种形式，并且程度不同。一些团队继续在本地运行 Terraform，但使用脚本代码来准备一致的工作目录来运行 Terraform，而另一些团队则完全在 Jenkins 等 CI 工具中运行 Terraform。</p>
<p>本篇涵盖了实现此类自动化时应考虑的一些事项，既确保 Terraform 的安全运行，又适应 Terraform 工作流程中当前需要仔细注意的一些限制。它假设 Terraform 将在非交互式环境中运行，无法在终端提示输入。对于脚本代码来说不一定如此，但在 CI 工具中运行时通常如此。</p>
<h2 id="1-9-10-1-1-自动化的-Terraform-命令行工作流"><a href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84-terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E4%BD%9C%E6%B5%81"></a>1.9.10.1.1. 自动化的 Terraform 命令行工作流</h2>
<p>在自动化流程中运行 Terraform 时，重点通常是核心的 <code>plan</code>/<code>apply</code> 循环。那么，使用 Terraform 命令行的流程大体如下：</p>
<ol>
<li>初始化 Terraform 工作目录。</li>
<li>针对当前代码，为产生变化的资源计算变更计划</li>
<li>让操作员审查计划，以确保其可接受</li>
<li>应用计划描述的更改。</li>
</ol>
<p>步骤 1、2 和 4 可以使用熟悉的 Terraform 命令以及一些附加选项来执行：</p>
<ul>
<li><code>terraform init -input=false</code> 初始化工作目录。</li>
<li><code>terraform plan -out=tfplan -input=false</code> 创建计划文件并将其保存到名为 <code>tfplan</code> 的本地文件。</li>
<li><code>terraform apply -input=false tfplan</code> 执行存储在文件 <code>tfplan</code> 中的计划。</li>
</ul>
<p><code>-input=false</code> 参数命令 Terraform 不应尝试提示输入，而是要求配置文件或命令行提供所有必要的值。因此，可能需要在 <code>terraform plan</code> 上使用 <code>-var</code> 和 <code>-var-file</code> 参数来指定所有传统上在交互式使用下手动输入的变量值。</p>
<p>强烈建议使用支持远程状态的 Backend，因为 Terraform 可以自动将持久保存状态，后续运行可以在找回并更新状态。选择支持状态锁定的 Backend 还将提供针对 Terraform 并发运行的竞争安全保障。</p>
<h2 id="1-9-10-1-2-控制自动化中的-Terraform-输出"><a href="#%E6%8E%A7%E5%88%B6%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%AD%E7%9A%84-terraform-%E8%BE%93%E5%87%BA"></a>1.9.10.1.2. 控制自动化中的 Terraform 输出</h2>
<p>默认情况下，一些 Terraform 命令会提示用户下一步可能执行的步骤，通常包括具体的下一步要运行的命令。</p>
<p>自动化工具通常会封装正在运行的命令的具体细节，只提供抽象的步骤，这时 Terraform 输出的此类消息反而令人困惑，且无法操作，如果它们无意中鼓励用户完全绕过自动化工具，则可能还是有害的。</p>
<p>当环境变量 <code>TF_IN_AUTOMATION</code> 设置为任何非空值时，Terraform 会对其输出进行一些细微调整，不再强调要运行的特定命令。所做的具体更改会随着时间的推移而变化，但一般来说，Terraform 发现该变量时，会认为存在某种包装了 Terraform 的应用程序，它们会帮助用户进行下一步。</p>
<p>为了降低复杂性，该功能主要针对 Terraform 主要的工作流程命令实现。无论该变量为何值如何，其他辅助命令仍可能会产生命令行建议。</p>
<h2 id="1-9-10-1-3-在不同的机器上运行-plan-和-apply"><a href="#%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%9C%BA%E5%99%A8%E4%B8%8A%E8%BF%90%E8%A1%8C-plan-%E5%92%8C-apply"></a>1.9.10.1.3. 在不同的机器上运行 plan 和 apply</h2>
<p>在 CI 工具中运行时，可能很难或无法确保 <code>plan</code> 和 <code>apply</code> 命令在同一台计算机上的同一目录中运行，并且所有的文件都保持相同。</p>
<p>在不同的机器上运行 <code>plan</code> 和 <code>apply</code> 需要一些额外的步骤来确保正确的行为。稳健的策略如下：</p>
<ul>
<li><code>plan</code> 完成后，保存整个工作目录，包括 <code>init</code> 期间创建的 <code>.terraform</code> 子目录，并将其保存在 <code>apply</code> 阶段可以访问得到的位置。常见的选择是作为所选 CI 工具中的“Build Artifact”。</li>
<li>在运行 <code>apply</code> 之前，获取上一步中创建的存档并将其解压到相同的绝对路径。这会重新创建 <code>plan</code> 后出现的所有内容，避免在 <code>plan</code> 步骤期间创建本地文件的奇怪问题。</li>
</ul>
<p>Terraform 目前为此类自动化系统设置了一些必须满足的前提条件：</p>
<ul>
<li>保存的计划文件可以包含子模块的绝对路径以及代码中引用的其他数据文件。因此，必须确保在相同的绝对路径中还原保存的工作目录。这通常是通过在某种隔离中运行 Terraform 来实现的，例如可以控制文件系统布局的 Docker 容器。</li>
<li>Terraform 假设该计划将在与其创建时相同的操作系统和 CPU 架构上 Apply。例如，这意味着无法在 Windows 计算机上创建计划，然后将其应用到 Linux 服务器上。</li>
<li>Terraform 期望用于生成计划的 Provider 程序插件在应用计划时可用且相同，以确保正确执行计划。如果在创建和应用计划之间升级 Terraform 或任何插件，将会产生错误。</li>
<li>Terraform 无法自动检测用于创建计划的凭据是否授予对用于应用该计划的相同资源的访问权限。如果对每个凭据使用不同的凭据（例如，使用只读凭据生成计划），那么确保两套凭据在它们所属的相应服务的帐户中保持一致非常重要。</li>
</ul>
<p><strong>警告</strong>：计划文件包含代码的完整副本、计划所要应用的状态数据以及传递给 <code>terraform plan</code> 的所有变量。如果其中包含任意敏感数据，则包含计划文件的存档工作目录应受到相应保护。对于 Provider 使用的身份验证凭据，建议尽可能使用环境变量，因为这些变量不会被包含在计划中或由 Terraform 以任何其他方式保存到磁盘。</p>
<h2 id="1-9-10-1-4-交互式审批计划"><a href="#%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%AE%A1%E6%89%B9%E8%AE%A1%E5%88%92"></a>1.9.10.1.4. 交互式审批计划</h2>
<p>自动化 Terraform 工作流程的另一个挑战是需要在计划和应用之间进行交互式审批步骤。为了稳健地实现这一点，重要的是要确保一次只能有一个计划未完成，或者两个步骤相互连接，以便批准计划将足够的信息传递到应用步骤，以确保应用正确的计划，与后来也存在的一些计划相反。</p>
<p>不同的 CI 工具以不同的方式解决这个问题，但通常这是通过构建管道功能实现的，其中可以按顺序应用不同的步骤，后面的步骤可以访问前面步骤生成的数据。</p>
<p>推荐的方法是一次只允许一个计划处于未应用状态。应用计划时，针对同一状态生成的任何其他现有计划都会失效，因为现在必须相对于新状态重新计算它们。通过强制计划按顺序获得批准（或驳回），可以避免这种情况。</p>
<h2 id="1-9-10-1-5-自动批准计划"><a href="#%E8%87%AA%E5%8A%A8%E6%89%B9%E5%87%86%E8%AE%A1%E5%88%92"></a>1.9.10.1.5. 自动批准计划</h2>
<p>虽然强烈建议对生产环境应用计划前要进行人工审查，但有时在预生产或开发环境中部署时需要采取更自动化的方法。</p>
<p>如果不需要手动批准，可以使用更简单的命令序列：</p>
<ul>
<li><code>terraform init -input=false</code></li>
<li><code>terraform apply -input=false -auto-approve</code></li>
</ul>
<p><code>apply</code> 命令的这个变体隐式地创建一个新计划，然后立即应用它。 <code>-auto-approve</code> 选项告诉 Terraform 在应用计划之前不需要对计划进行交互式批准。</p>
<p><strong>警告</strong>：当 Terraform 有权对基础设施进行破坏性更改时，始终建议对计划进行人工审查，除非在发生意外更改时可以容忍停机。仅对非关键基础设施使用自动批准。</p>
<h2 id="1-9-10-1-6-用-terraform-plan-命令测试-Pull-Requests"><a href="#%E7%94%A8-terraform-plan-%E5%91%BD%E4%BB%A4%E6%B5%8B%E8%AF%95-pull-requests"></a>1.9.10.1.6. 用 terraform plan 命令测试 Pull Requests</h2>
<p><code>terraform plan</code> 可以用来对 Terraform 配置的有效性进行某些有限的验证，而不影响实际的基础设施。尽管 <code>plan</code> 命令会更新状态以匹配实际资源，从而确保准确的计划，但更新后的状态文件并不会持久保存，因此可以安全地使用该命令来生成仅为了帮助代码审查而创建的“一次性”计划。</p>
<p>实现此类工作流程时，可以在相关代码审查工具（例如，Github Pull Request）中使用钩子，为每个正在审查的新提交触发 CI 工具。在这种情况下，Terraform 可以按如下方式运行：</p>
<ul>
<li><code>terraform plan -input=false</code></li>
</ul>
<p>与在“主”工作流程中一样，可能需要根据需要设置 <code>-var</code> 或 <code>-var-file</code>。在这种情况下不使用 <code>-out</code> 选项，因为为代码审查目的而生成的计划永远不会被应用。相反，一旦合并更改，就可以从主版本控制分支创建并应用新计划。</p>
<p><strong>警告</strong>：请注意，通过输入变量或环境变量将敏感秘密数据传递给 Terraform 将使任何可以提交 PR 的人都可以看到，因此在开源项目或任何私人项目上必须谨慎使用此流程部分，或所有贡献者不应能够直接访问凭据等。</p>
<h2 id="1-9-10-1-7-多环境部署"><a href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"></a>1.9.10.1.7. 多环境部署</h2>
<p>Terraform 的自动化通常会被用来创建数个相同的配置，比如为预发布、测试或多租户基础设施等场景生成平行的环境。这种情况下的自动化可以帮助确保为每个环境使用正确的设置，并且在每次操作之前正确配置工作目录。</p>
<p>多环境编排最有趣的两个命令是 <code>terraform init</code> 和 <code>terraform workspace</code>。前者可以与其他参数一起使用，以针对环境之间的差异定制 Backend 配置，而后者可用于在单个 Backend 中存储的相同配置的多个状态之间安全切换。</p>
<p>如果可能，建议对所有环境使用单一后端配置，并使用 <code>terraform workspace</code> 命令在工作空间之间切换：</p>
<ul>
<li><code>terraform init -input=false</code></li>
<li><code>terraform workspace select QA</code></li>
</ul>
<p>在此使用模型中，Backend 存储中使用固定的命名方案，以允许多个状态共存，而无需任何进一步的配置。</p>
<p>或者，自动化工具可以将环境变量 <code>TF_WORKSPACE</code> 设置为现有工作空间名称，这将覆盖使用 <code>terraform workspace select</code> 命令所做的任何选择。建议仅在非交互式使用中使用此环境变量，因为在本地 shell 环境中，很容易忘记设置该变量并将变更应用到错误的状态。</p>
<p>在一些更复杂的情况下，不可能跨环境共享相同的 Backend 配置。例如，环境可能运行在完全独立的不同帐户的服务里，因此需要对 Backend 本身使用不同的凭据或端点。在这种情况下，可以通过 <code>terraform init</code> 的 <code>-backend-config</code> 选项覆盖后端配置设置。</p>
<h2 id="1-9-10-1-8-预先安装的插件"><a href="#%E9%A2%84%E5%85%88%E5%AE%89%E8%A3%85%E7%9A%84%E6%8F%92%E4%BB%B6"></a>1.9.10.1.8. 预先安装的插件</h2>
<p>在默认使用情况下，<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/12.init.html"><code>terraform init</code></a> 会自动下载并安装代码中使用的所有 Provider 程序的插件，并将它们放置在 <code>.terraform</code> 目录的子目录中。这为简单的情况提供了更简单的工作流程，并允许每段代码可以使用不同版本的插件。</p>
<p>在自动化环境中，可能需要禁用此行为，而是提供一组已安装在运行 Terraform 的系统上的固定插件。这样就避免了每次执行时重新下载插件的开销，并允许系统管理员控制可以使用哪些插件。</p>
<p>要使用此机制，请在系统上的某个位置创建一个 Terraform 运行时会将插件可执行文件放入其中的目录。已发布的插件文件可在 <a target="_blank" rel="noopener" href="https://releases.hashicorp.com/">releases.hashicorp.com</a> 上下载。请务必下载适合目标操作系统和体系结构的文件。</p>
<p>提取必要的插件后，新插件目录的内容将如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -lah /usr/lib/custom-terraform-plugins</span></span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:13 terraform-provider-aws-v1.0.0-x3</span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:15 terraform-provider-rundeck-v2.3.0-x3</span><br><span class="line">-rwxrwxr-x 1 user user  84M Jun 13 15:15 terraform-provider-mysql-v1.2.0-x3</span><br></pre></td></tr></table></figure>
<p>文件名末尾的版本信息很重要，它使得 Terraform 可以推断每个插件的版本号。可以安装同一 Provider 程序插件的多个版本，Terraform 将使用与 Terraform 代码中的 Provider 程序版本约束相匹配的最新版本。</p>
<p>填充此目录后，可以使用 <code>terraform init</code> 的 <code>-plugin-dir</code> 选项跳过常规的自动下载和插件发现行为：</p>
<ul>
<li><code>terraform init -input=false -plugin-dir=/usr/lib/custom-terraform-plugins</code></li>
</ul>
<p>使用该组参数时，只有给定目录中的插件可以被使用。这使系统管理员可以对执行环境进行强力控制，但另一方面，它会阻止使用尚未安装到本地插件目录中的较新插件版本。哪种方法更合适将取决于每个组织内的特定情况。</p>
<p>还可以通过创建 <code>terraform.d/plugins/OS_ARCH</code> 目录与配置一起提前安装插件，在自动下载其他插件之前将搜索该目录。 <code>-get-plugins=false</code> 参数可禁止 Terraform 自动下载其他插件。</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">標籤</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="../../../../../tags/Terraform/" rel="tag">Terraform</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../../04/12/Algorithms/Dijkstra%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/"
                    data-tooltip="Dijkstra简单介绍"
                    aria-label="上一篇: Dijkstra简单介绍"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    data-tooltip="Terraform-测试"
                    aria-label="下一篇: Terraform-测试"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Kein Chan. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../../04/12/Algorithms/Dijkstra%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/"
                    data-tooltip="Dijkstra简单介绍"
                    aria-label="上一篇: Dijkstra简单介绍"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    data-tooltip="Terraform-测试"
                    aria-label="下一篇: Terraform-测试"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                        aria-label="global.share_on_linkedin"
                    >
                        <i class="fab fa-linkedin" aria-hidden="true"></i><span>global.share_on_linkedin</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://keinchan.com/2023/01/30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                        aria-label="分享到 Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
        
            <h4 id="about-card-name">Kein Chan</h4>
        
            <div id="about-card-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>全棧工程師</br>資深技術顧問</br>數據科學家</br>Hit廣島觀光大使</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Tokyo/Macau
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="../assets/images/logo-algolia-nebula-blue-full.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">沒有找到文章</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/04/27/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/"
                            aria-label=": R语言-环境安装"
                        >
                            <h3 class="media-heading">R语言-环境安装</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月27日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/04/28/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E5%9F%BA%E7%A1%80/"
                            aria-label=": R语言-基础"
                        >
                            <h3 class="media-heading">R语言-基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月28日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/01/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE/"
                            aria-label=": R语言-读取数据"
                        >
                            <h3 class="media-heading">R语言-读取数据</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月1日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/02/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BB%98%E5%9B%BE/"
                            aria-label=": R语言-绘图"
                        >
                            <h3 class="media-heading">R语言-绘图</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月2日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/03/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/"
                            aria-label=": R语言-线性回归"
                        >
                            <h3 class="media-heading">R语言-线性回归</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月3日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/22/Algorithms/1.%E7%AE%97%E6%B3%95%E5%9C%A8%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8/"
                            aria-label=": 1. 算法在计算中的作用"
                        >
                            <h3 class="media-heading">1. 算法在计算中的作用</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月22日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/23/Algorithms/2.%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/"
                            aria-label=": 2. 算法基础"
                        >
                            <h3 class="media-heading">2. 算法基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/24/Algorithms/3.%E5%87%BD%E6%95%B0%E7%9A%84%E5%A2%9E%E9%95%BF/"
                            aria-label=": 3. 函数的增长"
                        >
                            <h3 class="media-heading">3. 函数的增长</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月24日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/25/Algorithms/4.%E5%88%86%E6%B2%BB%E7%AD%96%E7%95%A5/"
                            aria-label=": 4. 分治策略"
                        >
                            <h3 class="media-heading">4. 分治策略</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月25日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/26/Algorithms/5.%E6%A6%82%E7%8E%87%E5%88%86%E6%9E%90%E5%92%8C%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/"
                            aria-label=": 5. 概率分析和随机算法"
                        >
                            <h3 class="media-heading">5. 概率分析和随机算法</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月26日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="沒有找到文章"
                data-message-one="找到 1 篇文章"
                data-message-other="找到 {n} 篇文章">
                找到 234 篇文章
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('../../../../../assets/images/cover.jpeg');"></div>
        <!--SCRIPTS-->

<script src="../../../../../assets/js/script-qtzvvb63gamuirvfphht7lytrxkfllzng1escnm2phjtlt4tvvxi5gl0wx4o.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
