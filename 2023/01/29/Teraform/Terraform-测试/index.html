
<!DOCTYPE html>
<html lang="zh-tw">
    
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    
      <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/locale/zh-tw.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
    <script>
      window.algoliaConfig = {
        appId: 'AWFC86Q51O',
        apiKey: 'c9d952906eb1b154d75cf863e75c1ede',
        indexName: 'MyBlog'
      };
      var algoliaIndex = algoliasearch(
        algoliaConfig.appId,
        algoliaConfig.apiKey
      ).initIndex(algoliaConfig.indexName);
    </script>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Kein&#39;s blog">
    <title>Terraform-测试 - Kein&#39;s blog</title>
    <meta name="author" content="Kein Chan">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kein Chan","sameAs":["https://github.com/chankein/","https://www.linkedin.com/profile/","mailto:kein.chan85@gmail.com"],"image":"profile.jpg"},"articleBody":"\n\n1.8.1. 测试\n\n\n1.8.1.1. 集成测试或单元测试\n\n\n1.8.1.2. 语法\n\n\n1.8.1.2.1. 示例\n\n\n1.8.1.3. run 块\n\n\n1.8.1.3.1. 断言\n\n\n1.8.1.4. variable 块\n\n\n1.8.1.4.1. 通过命令行或定义文件指定变量\n\n\n1.8.1.4.2. 变量定义优先级\n\n\n1.8.1.4.3. 变量中的引用\n\n\n1.8.1.5. provider 块\n\n\n1.8.1.6. module 块\n\n\n1.8.1.6.1. 模块状态\n\n\n1.8.1.7. 预期失败\n\n\n\n1.8.1. 测试\n-&gt; 注意： 该测试框架在 Terraform v1.6.0 及以后版本中可用。\nTerraform 测试功能允许模块作者验证配置变更不会引入破坏性更改。测试针对特定的、临时的资源进行，防止对现有的基础设施或状态产生任何风险。\n1.8.1.1. 集成测试或单元测试\n默认情况下，Terraform 测试会创建真实的基础设施，并可以对这些基础设施进行断言和验证。这相当于集成测试，它通过调用 Terraform 创建基础设施并对其进行验证来测试 Terraform 的核心功能。\n你可以通过更新 run 块中的 command 属性（下面有示例）来覆盖默认的测试行为。默认情况下，每个 run 块都会执行 command = apply，命令 Terraform 对你的配置执行完整的 apply 操作。将 command 值替换为 command = plan 会告诉 Terraform 不为这个 run 块创建新的基础设施。这将允许测试作者验证他们的基础设施中的逻辑操作和自定义条件，相当于编写了单元测试。\nTerraform v1.7.0 引入了在 terraform test 执行期间模拟 Provider 返回数据的能力。这可以用于编写更详细和完整的单元测试。\n1.8.1.2. 语法\n每个 Terraform 测试都保存在一个测试文件中。Terraform 根据文件扩展名发现测试文件：.tftest.hcl 或 .tftest.json。\n每个测试文件包含以下根级别的属性和块：\n\n一个到多个 run 块。\n零个到一个 variables 块。\n零个到多个 provider 块。\n\nTerraform 按顺序执行 run 块，模拟一系列直接在配置目录中执行的 Terraform 命令。 variables 和 provider 块的顺序并不重要，Terraform 在测试操作开始时处理这些块中的所有值。我们建议首先在测试文件的开头定义你的 variables 和 provider 块。\n1.8.1.2.1. 示例\n以下示例演示了一个简单的 Terraform 配置，该配置创建了一个 AWS S3 存储桶，并使用输入变量来修改其名称。我们将创建一个示例测试文件（如下）来验证存储桶的名称是否如预期那样被创建。\n1234567891011121314151617# main.tfprovider &quot;aws&quot; &#123;    region = &quot;eu-central-1&quot;&#125;variable &quot;bucket_prefix&quot; &#123;  type = string&#125;resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;  bucket = &quot;$&#123;var.bucket_prefix&#125;-bucket&quot;&#125;output &quot;bucket_name&quot; &#123;  value = aws_s3_bucket.bucket.bucket&#125;\n以下测试文件运行了一个单独的Terraform plan 命令，该命令创建了S3存储桶，然后通过检查实际名称是否与预期名称匹配，来验证计算名称的逻辑是否正确。\n12345678910111213141516# valid_string_concat.tftest.hclvariables &#123;  bucket_prefix = &quot;test&quot;&#125;run &quot;valid_string_concat&quot; &#123;  command = plan  assert &#123;    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;    error_message = &quot;S3 bucket name did not match expected&quot;  &#125;&#125;\n1.8.1.3. run 块\n每个 run 块都有以下字段和块：\n\n\n\n字段或块名称\n描述\n默认值\n\n\n\n\ncommand\n一个可选属性，可以是 apply 或 plan。\napply\n\n\nplan_options.mode\n一个可选属性，可以是 normal 或 refresh-only。\nnormal\n\n\nplan_options.refresh\n一个可选的 bool 属性。\ntrue\n\n\nplan_options.replace\n一个可选属性，包含一个资源地址列表，引用测试配置中的资源。\n\n\n\nplan_options.target\n一个可选属性，包含一个资源地址列表，引用测试配置中的资源。\n\n\n\nvariables\n一个可选的 variables 块。\n\n\n\nmodule\n一个可选的 module 块。\n\n\n\nproviders\n一个可选的 providers 属性。\n\n\n\nassert\n可选的 assert 块。\n\n\n\nexpect_failures\n一个可选属性。\n\n\n\n\ncommand 属性和 plan_options 块告诉 Terraform 对于每个 run 块执行哪个命令和选项。如果您没有指定 command 属性或 plan_options 块，那么默认操作是普通的 terraform apply 操作。\ncommand 属性指明操作应该是一个 plan 操作还是一个 apply 操作。\nplan_options 块允许测试的作者定义他们通常需要通过命令行标志和选项定义的 plan mode 和 选项。我们将在 变量 部分介绍 -var 和 -var-file 选项。\n1.8.1.3.1. 断言\nTerraform 测试的 run 块断言是自定义条件，由条件和错误消息组成。\n在 Terraform 测试命令执行结束时，Terraform 会将所有失败的断言作为测试通过或失败状态的一部分展示出来。\n断言中的引用\n测试中的断言可以引用主 Terraform 配置中的其他自定义条件可用的任何现有命名值。\n此外，测试断言可以直接引用当前和先前 run 块的输出。比如引用了上一个示例中的输出的一个合法的表达式条件：condition = output.bucket_name == &quot;test_bucket&quot;。\n1.8.1.4. variable 块\n你可以直接在你的测试文件中为 输入变量 设置值。\n你可以在测试文件的根级别或者 run 块内部定义 variables 块。Terraform 将测试文件中的所有变量值传递到文件中的所有 run 块。你可以通过在某个 run 块中直接设置变量值来覆盖从根部继承的值。\n在上述 示例 的测试文件中添加：\n12345678910111213141516171819202122232425262728293031# variable_precedence.tftest.hclvariables &#123;  bucket_prefix = &quot;test&quot;&#125;run &quot;uses_root_level_value&quot; &#123;  command = plan  assert &#123;    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;    error_message = &quot;S3 bucket name did not match expected&quot;  &#125;&#125;run &quot;overrides_root_level_value&quot; &#123;  command = plan  variables &#123;    bucket_prefix = &quot;other&quot;  &#125;  assert &#123;    condition     = aws_s3_bucket.bucket.bucket == &quot;other-bucket&quot;    error_message = &quot;S3 bucket name did not match expected&quot;  &#125;&#125;\n我们添加了第二个 run 块，该块指定 bucket_prefix 变量值为 other，覆盖了测试文件提供的，并在第一个 run 块中使用的值 —— test。\n1.8.1.4.1. 通过命令行或定义文件指定变量\n除了通过测试文件指定变量值外，Terraform test 命令还支持指定变量值的其他方法。\n您可以通过 命令行 和 变量定义文件 为所有测试指定变量值。\n像普通的 Terraform 命令一样，Terraform 会自动加载测试目录中定义的任何变量文件。自动变量文件包括 terraform.tfvars、terraform.tfvars.json，以及所有以 .auto.tfvars 或 .auto.tfvars.json 结尾的文件。\n注意： 从测试目录中的自动变量文件加载的变量值只适用于在同一测试目录中定义的测试。以所有其他方式定义的变量将适用于给定测试运行中的所有测试。\n这在使用敏感变量值和设置 Provider 配置时特别有用。否则，测试文件可能会直接暴露这些敏感值。\n1.8.1.4.2. 变量定义优先级\n除了测试文件中设置的变量值，变量定义优先级 在测试中保持不变。在测试文件中定义的变量具有最高优先级，可以覆盖环境变量、变量文件或命令行输入。\n对于在测试目录中定义的测试，任何在测试目录的自动变量文件中定义的变量值都将覆盖主配置目录的自动变量文件中定义的值。\n1.8.1.4.3. 变量中的引用\n在 run 块中定义的 variable 中可以引用在先前 run 块中执行的模块的输出和在更高优先级定义的变量。\n例如，以下代码块显示了变量如何引用更高优先级的变量和先前的 run 块：\n1234567891011121314151617181920212223variables &#123;  global_value = &quot;some value&quot;&#125;run &quot;run_block_one&quot; &#123;  variables &#123;    local_value = var.global_value  &#125;  # ...  # 这里应该有一些测试断言  # ...&#125;run &quot;run_block_two&quot; &#123;  variables &#123;    local_value = run.run_block_one.output_one  &#125;  # ...  # 这里应该有一些测试断言  # ...&#125;\n上面，run_block_one 中的 local_value 从 global_value 变量获取值。如果你想给多个变量分配相同的值，这种模式很有用。你可以在文件级别一次指定一个变量的值，然后与不同的变量共享它。\n相比之下，run_block_two 中的 local_value 引用了 run_block_one 的 output_one 的输出值。这种模式对于在 run 块之间传递值特别有用，特别是如果 run 块正在执行模块部分中详细描述的不同模块。\n1.8.1.5. provider 块\n您可以通过使用 provider 和 providers 块和属性，在测试文件中设置或覆盖 Terraform 代码所需的 Provider。\n您可以在 Terraform 测试文件的根级别，定义 provider 块，就像在 Terraform 配置代码中创建它们一样。然后，Terraform 会将这些 provider 块传递到其配置中，每个 run 块执行时都是如此。\n默认情况下，您指定的每个 Provider 都直接在每个 run 块中可用。您可以通过使用 providers 属性在特定 run 块中设置 Provider 的可用性。这个块的行为和语法与 providers meta-argument 的行为相匹配。\n如果您在测试文件中不提供 Provider 配置，Terraform 会尝试使用 Provider 的默认设置初始化其配置中的所有 Provider。例如，任何旨在配置 Provider 的环境变量仍然可用，并且 Terraform 可以使用它们来创建默认 Provider。\n下面，我们将扩展我们之前的 示例，用测试代码而不是 Terraform 配置代码来指定 region。在这个示例中，我们将测试以下配置文件：\n123456789101112131415161718192021# main.tfterraform &#123;  required_providers &#123;    aws = &#123;      source = &quot;hashicorp/aws&quot;    &#125;  &#125;&#125;variable &quot;bucket_prefix&quot; &#123;  type = string&#125;resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;  bucket = &quot;$&#123;var.bucket_prefix&#125;-bucket&quot;&#125;output &quot;bucket_name&quot; &#123;  value = aws_s3_bucket.bucket.bucket&#125;\n我们现在可以在以下测试文件中定义如下的 provider 块：\n1234567891011121314151617181920# customised_provider.tftest.hclprovider &quot;aws&quot; &#123;    region = &quot;eu-central-1&quot;&#125;variables &#123;  bucket_prefix = &quot;test&quot;&#125;run &quot;valid_string_concat&quot; &#123;  command = plan  assert &#123;    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;    error_message = &quot;S3 bucket name did not match expected&quot;  &#125;&#125;\n现在我们也可以创建一个更复杂的示例配置，使用多个 Provider 以及别名：\n123456789101112131415161718192021222324# main.tfterraform &#123;  required_providers &#123;    aws = &#123;      source                = &quot;hashicorp/aws&quot;      configuration_aliases = [aws.secondary]    &#125;  &#125;&#125;variable &quot;bucket_prefix&quot; &#123;  default = &quot;test&quot;  type    = string&#125;resource &quot;aws_s3_bucket&quot; &quot;primary_bucket&quot; &#123;  bucket = &quot;$&#123;var.bucket_prefix&#125;-primary&quot;&#125;resource &quot;aws_s3_bucket&quot; &quot;secondary_bucket&quot; &#123;  provider = aws.secondary  bucket   = &quot;$&#123;var.bucket_prefix&#125;-secondary&quot;&#125;\n在我们的测试文件中，我们可以设定多个 Provider：\n12345678910111213141516171819202122232425# customised_providers.tftest.hclprovider &quot;aws&quot; &#123;  region = &quot;us-east-1&quot;&#125;provider &quot;aws&quot; &#123;  alias  = &quot;secondary&quot;  region = &quot;eu-central-1&quot;&#125;run &quot;providers&quot; &#123;  command = plan  assert &#123;    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-primary&quot;    error_message = &quot;invalid value for primary S3 bucket&quot;  &#125;  assert &#123;    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-secondary&quot;    error_message = &quot;invalid value for secondary S3 bucket&quot;  &#125;&#125;\n我们也可以在特定 run 块中声明特定的 Provider：\n123456789101112131415161718192021222324252627282930# main.tfterraform &#123;  required_providers &#123;    aws = &#123;      source                = &quot;hashicorp/aws&quot;      configuration_aliases = [aws.secondary]    &#125;  &#125;&#125;data &quot;aws_region&quot; &quot;primary&quot; &#123;&#125;data &quot;aws_region&quot; &quot;secondary&quot; &#123;  provider = aws.secondary&#125;variable &quot;bucket_prefix&quot; &#123;  default = &quot;test&quot;  type    = string&#125;resource &quot;aws_s3_bucket&quot; &quot;primary_bucket&quot; &#123;  bucket = &quot;$&#123;var.bucket_prefix&#125;-$&#123;data.aws_region.primary.name&#125;-primary&quot;&#125;resource &quot;aws_s3_bucket&quot; &quot;secondary_bucket&quot; &#123;  provider = aws.secondary  bucket   = &quot;$&#123;var.bucket_prefix&#125;-$&#123;data.aws_region.secondary.name&#125;-secondary&quot;&#125;\n我们的测试文件可以为不同的 run 块配置的 Provider：\n1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950# customised_providers.tftest.hclprovider &quot;aws&quot; &#123;  region = &quot;us-east-1&quot;&#125;provider &quot;aws&quot; &#123;  alias  = &quot;secondary&quot;  region = &quot;eu-central-1&quot;&#125;provider &quot;aws&quot; &#123;  alias  = &quot;tertiary&quot;  region = &quot;eu-west-2&quot;&#125;run &quot;default_providers&quot; &#123;  command = plan  assert &#123;    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-us-east-1-primary&quot;    error_message = &quot;invalid value for primary S3 bucket&quot;  &#125;  assert &#123;    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-eu-central-1-secondary&quot;    error_message = &quot;invalid value for secondary S3 bucket&quot;  &#125;&#125;run &quot;customised_providers&quot; &#123;  command = plan  providers = &#123;    aws           = aws    aws.secondary = aws.tertiary  &#125;  assert &#123;    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-us-east-1-primary&quot;    error_message = &quot;invalid value for primary S3 bucket&quot;  &#125;  assert &#123;    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-eu-west-2-secondary&quot;    error_message = &quot;invalid value for secondary S3 bucket&quot;  &#125;&#125;\n注意： 在使用 command = apply 运行测试时，run 块之间切换 Provider 可能会导致运行和测试失败，因为由一个 Provider 定义创建的资源在被另一个修改时将无法使用。\n从 Terraform v1.7.0 开始，provider 块也可以引用测试文件变量和 run 块输出。这意味着测试框架可以从一个 Provider 获取凭证和其他设置信息，并在初始化第二个 Provider 时使用这些信息。\n在下面的示例中，首先初始化 vault Provider，然后在一个设置模块中使用它来提取 aws Provider 的凭证。有关 setup 模块的更多信息，请参阅 模块。\n123456789101112131415161718192021222324252627provider &quot;vault&quot; &#123;  # ... vault configuration ...&#125;provider &quot;aws&quot; &#123;  region     = &quot;us-east-1&quot;  # The `aws` provider can reference the outputs of the &quot;vault_setup&quot; run block.  access_key = run.vault_setup.aws_access_key  secret_key = run.vault_setup.aws_secret_key&#125;run &quot;vault_setup&quot; &#123;  module &#123;    # This module should only include reference to the Vault provider. Terraform    # will automatically work out which providers to supply based on the module    # configuration. The tests will error if a run block requires access to a    # provider that references outputs from a run block that has not executed.    source = &quot;./testing/vault-setup&quot;  &#125;&#125;run &quot;use_aws_provider&quot; &#123;  # This run block can then use both the `aws` and `vault` providers, as the  # previous run block provided all the data required for the `aws` provider.&#125;\n1.8.1.6. module 块\n您可以修改特定的 run 块执行的模块。\n默认情况下，Terraform 针对正在测试的配置代码，依次执行所有 run 块中设定的命令。Terraform 在您执行 terraform test 命令的目录（或者您用 -chdir 参数指向的目录）内测试配置。每个 run 块也允许用户使用 module 块更改目标配置。\n与传统的 module 块不同，测试文件中的 module 块 仅 支持 source 属性和 version 属性。通常通过传统的 module 块提供的其余属性应由 run 块内的替代属性和块提供。\n注意： Terraform 测试文件只支持 source 属性中的 本地 和 注册表 模块。\n在执行其他模块时，run 块内的所有其他块和属性都受支持，assert 块执行时使用来自其他模块的值。这在 模块状态 中有更详细的说明。\n测试文件中 modules 块的两个示例用例是：\n\n一个设置模块，为待测 Terraform 配置代码创建测试所需的基础设施。\n一个加载模块，用于加载和验证 Terraform 配置代码未直接创建的次要基础设施（如数据源）。\n\n以下示例演示了这两种用例。\n首先，我们有一个模块，它将创建并将多个文件加载到已创建的 S3 存储桶中。这是我们要测试的配置。\n1234567891011121314151617181920212223# main.tfvariable &quot;bucket&quot; &#123;  type = string&#125;variable &quot;files&quot; &#123;  type = map(string)&#125;data &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;  bucket = var.bucket&#125;resource &quot;aws_s3_object&quot; &quot;object&quot; &#123;  for_each = var.files  bucket = data.aws_s3_bucket.bucket.id  key = each.key  source = each.value  etag = filemd5(each.value)&#125;\n然后，我们使用配置模块创建这个 S3 存储桶，这样在测试时就可以使用它：\n123456789# testing/setup/main.tfvariable &quot;bucket&quot; &#123;  type = string&#125;resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;  bucket = var.bucket&#125;\n第三步，我们使用一个加载模块，读取 S3 存储桶中的文件。这是一个比较牵强的例子，因为我们完全可以直接在创建这些文件的模块中创建这些数据源，但它在这里可以很好地演示如何编写测试：\n123456789# testing/loader/main.tfvariable &quot;bucket&quot; &#123;  type = string&#125;data &quot;aws_s3_objects&quot; &quot;objects&quot; &#123;  bucket = var.bucket&#125;\n最后，我们使用测试文件把刚才创建的多个助手模块以及待测模块编织在一起形成一个有效的测试配置：\n1234567891011121314151617181920212223242526272829303132333435363738# file_count.tftest.hclvariables &#123;  bucket = &quot;my_test_bucket&quot;  files = &#123;    &quot;file-one.txt&quot;: &quot;data/files/file_one.txt&quot;    &quot;file-two.txt&quot;: &quot;data/files/file_two.txt&quot;  &#125;&#125;provider &quot;aws&quot; &#123;  region = &quot;us-east-1&quot;&#125;run &quot;setup&quot; &#123;  # Create the S3 bucket we will use later.  module &#123;    source = &quot;./testing/setup&quot;  &#125;&#125;run &quot;execute&quot; &#123;  # This is empty, we just run the configuration under test using all the default settings.&#125;run &quot;verify&quot; &#123;  # Load and count the objects created in the &quot;execute&quot; run block.  module &#123;    source = &quot;./testing/loader&quot;  &#125;  assert &#123;    condition = length(data.aws_s3_objects.objects.keys) == 2    error_message = &quot;created the wrong number of s3 objects&quot;  &#125;&#125;\n1.8.1.6.1. 模块状态\n当 Terraform 执行 terraform test 命令时，Terraform 会为每个测试文件在内存中维护一个或多个状态文件。\n总是至少有一个状态文件维护在测试下的 Terraform 配置代码的状态。这个状态文件由所有没有 module 块指定要加载的替代模块的 run 块共享。\n此外，Terraform 加载的每个替代模块都有一个状态文件。一个替代模块的状态文件被执行给定模块的所有 run 块共享。\nTerraform 团队对任何需要手动状态管理或在 test 命令中对同一状态执行不同配置的用例感兴趣。如果你有一个用例，请提交一个 issue并与我们分享。\n以下示例使用注释来解释每个 run 块的状态文件的来源。在下面的示例中，Terraform 创建并管理了总共三个状态文件。第一个状态文件是针对测试下的主模块，第二个是针对设置模块，第三个是针对加载模块。\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970run &quot;setup&quot; &#123;  # This run block references an alternate module and is the first run block  # to reference this particular alternate module. Therefore, Terraform creates  # and populates a new empty state file for this run block.  module &#123;    source = &quot;./testing/setup&quot;  &#125;&#125;run &quot;init&quot; &#123;  # This run block does not reference an alternate module, so it uses the main  # state file for the configuration under test. As this is the first run block  # to reference the main configuration, the previously empty state file now  # contains the resources created by this run block.  assert &#123;    # In practice we&#x27;d do some interesting checks and tests here but the    # assertions aren&#x27;t important for this example.  &#125;  # ... more assertions ...&#125;run &quot;update_setup&quot; &#123;  # We&#x27;ve now re-referenced the setup module, so the state file that was created  # for the first &quot;setup&quot; run block will be reused. It will contain any  # resources that were created as part of the other run block before this run  # block executes and will be updated with any changes made by this run block  # after.  module &#123;    source = &quot;./testing/setup&quot;  &#125;  variables &#123;    # In practice, we&#x27;d likely make some changes to the module compared to the    # first run block here. Otherwise, there would be no point recalling the    # module.  &#125;&#125;run &quot;update&quot; &#123;  # As with the &quot;init&quot; run block, we are executing against the main configuration  # again. This means we&#x27;d load the main state file that was initially populated  # by the &quot;init&quot; run block, and any changes made by this &quot;run&quot; block will be  # carried forward to any future run blocks that execute against the main  # configuration.  # ... updated variables ...  # ... assertions ...&#125;run &quot;loader&quot; &#123;  # This run block is now referencing our second alternate module so will create  # our third and final state file. The other two state files are managing  # resources from the main configuration and resources from the setup module.  # We are getting a new state file for this run block as the loader module has  # not previously been referenced by any run blocks.  module &#123;    source = &quot;./testing/loader&quot;  &#125;&#125;\n模块的清理\n在测试文件执行结束时，Terraform 会试图销毁在该测试文件执行过程中创建的每个资源。当 Terraform 加载替代模块时，Terraform 销毁这些对象的顺序很重要。例如，在第一个 模块 示例中，Terraform 不能在 “execute” run 块中创建的对象之前销毁在 “setup” run 块中创建的资源，因为我们在 “setup” 步骤中创建的 S3 桶在包含对象的情况下无法被销毁。\nTerraform 按照 run 块的反向顺序销毁资源。在最近的 例子 中，有三个状态文件。一个用于主状态，一个用于 ./testing/loader 模块，还有一个用于 ./testing/setup 模块。由于 ./testing/loader 状态文件最近被最后一个运行块引用，因此首先被销毁。主状态文件将被第二个销毁，因为它被 “update” run 块引用。然后 ./testing/setup 状态文件将被最后销毁。\n请注意，前两个 run 块 “setup” 和 “init” 在销毁操作中不做任何事情，因为它们的状态文件被后续的 run 块使用，并且已经被销毁。\n如果你使用单个设置模块作为替代模块，并且它首先执行，或者你不使用任何替代模块，那么销毁顺序不会影响你。更复杂的情况可能需要仔细考虑，以确保资源的销毁可以自动完成。\n1.8.1.7. 预期失败\n默认情况下，如果在执行 Terraform 测试文件期间，任何自定义条件，包括 check 块断言失败，则整体命令会将测试报告为失败。\n然而，我们经常想要测试代码运行失败时的行为。Terraform 为此用例提供了 expect_failures 属性。\n在每个 run 块中，expect_failures 属性可以设置应该导致自定义条件检查失败的可检查对象（资源，数据源，检查块，输入变量和输出）的列表。如果您指定的可检查对象报告问题，测则试通过，如果没有报告错误，那么测试总体上失败。\n您仍然可以在 expect_failures 块附近编写断言，但您应该注意，除了 check 块断言外，所有自定义条件都会停止 Terraform 的执行。这在测试执行期间仍然适用，所以这些断言应该只考虑你确定会在可检查对象应该失败之前可知的值。您可以使用引用或在主配置中的 depends_on 元参数来管理这一点。\n这也意味着，除了 check 块，你只能可靠地包含一个可检查的对象。我们支持在 expect_failures 属性中列出可检查对象的列表，仅用于 check 块。\n下面的一个快速示例演示了测试输入变量的 validation 块。配置文件接受一个必须是偶数的单一输入变量。\n12345678910# main.tfvariable &quot;input&quot; &#123;  type = number  validation &#123;    condition = var.input % 2 == 0    error_message = &quot;must be even number&quot;  &#125;&#125;\n测试文件包含了两个 run 块。一个验证了我们的自定义条件在偶数条件下是通过的，另一个验证输入奇数时会失败。\n12345678910111213141516171819202122232425# input_validation.tftest.hclvariables &#123;  input = 0&#125;run &quot;zero&quot; &#123;  # The variable defined above is even, so we expect the validation to pass.  command = plan&#125;run &quot;one&quot; &#123;  # This time we set the variable is odd, so we expect the validation to fail.  command = plan  variables &#123;    input = 1  &#125;  expect_failures = [    var.input,  ]&#125;\n注意：Terraform 只期望在 run 块的 command 属性指定的操作中出现失败。\n在使用 command = apply 的 run 块中使用 expect_failures 时要小心。一个 run 块中的 command = apply 如果期望自定义条件失败，那么如果该自定义条件在 plan 期间失败，整体将会失败。\n这在逻辑上是正确的，因为 run 块期望能够运行应用操作，但由于 plan 失败而不能运行，但这也可能会引起混淆，因为即使那个失败被标记为预期的，你还是会在诊断中看到失败。\n有时，Terraform 在计划阶段不执行自定义条件，因为该条件依赖于只有在 Terraform 创建引用资源后才可用的计算属性。在这些情况下，你可以在设置 command = apply 时使用 expect_failures 块。然而，大多数情况下，我们建议只在 command = plan 时使用 expect_failures。\n注意：预期的失败只适用于用户定义的自定义条件。\n除了在可检查对象中指定的预期失败之外的其他种类的失败仍会导致整体测试失败。例如，一个期望布尔值作为输入的变量，如果 Terraform 收到的是错误的值类型，即使该变量包含在 expect_failures 属性中，也会导致周围的测试失败。\nexpect_failures 属性包含在其中是为了允许作者测试他们的配置和任何定义的逻辑。像前面的例子中的类型不匹配错误，不是 Terraform 作者应该担心和测试的事情，因为 Terraform 本身会处理强制类型约束。因此，你只能在自定义条件中 expect_failures。\n","dateCreated":"2023-01-29T17:43:45+08:00","dateModified":"2025-06-17T23:03:47+08:00","datePublished":"2023-01-29T17:43:45+08:00","description":"","headline":"Terraform-测试","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"},"publisher":{"@type":"Organization","name":"Kein Chan","sameAs":["https://github.com/chankein/","https://www.linkedin.com/profile/","mailto:kein.chan85@gmail.com"],"image":"profile.jpg","logo":{"@type":"ImageObject","url":"profile.jpg"}},"url":"https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/","keywords":"Terraform"}</script>
    <meta name="description" content="1.8.1. 测试   1.8.1.1. 集成测试或单元测试   1.8.1.2. 语法   1.8.1.2.1. 示例   1.8.1.3. run 块   1.8.1.3.1. 断言   1.8.1.4. variable 块   1.8.1.4.1. 通过命令行或定义文件指定变量   1.8.1.4.2. 变量定义优先级   1.8.1.4.3. 变量中的引用   1.8.1.5. pr">
<meta property="og:type" content="blog">
<meta property="og:title" content="Terraform-测试">
<meta property="og:url" content="https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/index.html">
<meta property="og:site_name" content="Kein&#39;s blog">
<meta property="og:description" content="1.8.1. 测试   1.8.1.1. 集成测试或单元测试   1.8.1.2. 语法   1.8.1.2.1. 示例   1.8.1.3. run 块   1.8.1.3.1. 断言   1.8.1.4. variable 块   1.8.1.4.1. 通过命令行或定义文件指定变量   1.8.1.4.2. 变量定义优先级   1.8.1.4.3. 变量中的引用   1.8.1.5. pr">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2023-01-29T09:43:45.000Z">
<meta property="article:modified_time" content="2025-06-17T15:03:47.584Z">
<meta property="article:author" content="Kein Chan">
<meta property="article:tag" content="Terraform">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://keinchan.com../../../../../assets/images/profile.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="../../../../../assets/css/style-l9zwheso7r7pnk98nvirovsz9dl7fhkrc9mlb5vmuxw7tk5movrk0eevsrpr.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="../../../../../index.html"
            aria-label=""
        >
            Kein&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打開鏈接: ../../../../../#about"
            >
        
        
            <img class="header-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="../../../../../#about"
                    aria-label="閱讀有關作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
                </a>
                <h4 class="sidebar-profile-name">Kein Chan</h4>
                
                    <h5 class="sidebar-profile-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../index.html"
                            
                            rel="noopener"
                            title="首頁"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首頁</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-categories"
                            
                            rel="noopener"
                            title="分類"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分類</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-tags"
                            
                            rel="noopener"
                            title="標籤"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">標籤</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../all-archives"
                            
                            rel="noopener"
                            title="所有文章"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">所有文章</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜尋"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜尋</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="關於"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">關於</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/chankein/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/profile/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../mailto:kein.chan85@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Email"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Email</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="../../../../../atom.xml"
                            
                            rel="noopener"
                            title="Atom"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Atom</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Terraform-测试
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2023-01-29T17:43:45+08:00">
	
		    2023 年 1 月 29 日
    	
    </time>
    
        <span>分類 </span>
        
    <a class="category-link" href="../../../../../categories/devops/">devops</a>, <a class="category-link" href="../../../../../categories/devops/Terraform/">Terraform</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <ul>
<li>
<p><a href="#%E6%B5%8B%E8%AF%95"><strong>1.8.1.</strong> 测试</a></p>
</li>
<li>
<p><a href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%88%96%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><strong>1.8.1.1.</strong> 集成测试或单元测试</a></p>
</li>
<li>
<p><a href="#%E8%AF%AD%E6%B3%95"><strong>1.8.1.2.</strong> 语法</a></p>
</li>
<li>
<p><a href="#%E7%A4%BA%E4%BE%8B"><strong>1.8.1.2.1.</strong> 示例</a></p>
</li>
<li>
<p><a href="#run-%E5%9D%97"><strong>1.8.1.3.</strong> run 块</a></p>
</li>
<li>
<p><a href="#%E6%96%AD%E8%A8%80"><strong>1.8.1.3.1.</strong> 断言</a></p>
</li>
<li>
<p><a href="#variable-%E5%9D%97"><strong>1.8.1.4.</strong> variable 块</a></p>
</li>
<li>
<p><a href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%88%96%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9A%E5%8F%98%E9%87%8F"><strong>1.8.1.4.1.</strong> 通过命令行或定义文件指定变量</a></p>
</li>
<li>
<p><a href="#%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E4%BC%98%E5%85%88%E7%BA%A7"><strong>1.8.1.4.2.</strong> 变量定义优先级</a></p>
</li>
<li>
<p><a href="#%E5%8F%98%E9%87%8F%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"><strong>1.8.1.4.3.</strong> 变量中的引用</a></p>
</li>
<li>
<p><a href="#provider-%E5%9D%97"><strong>1.8.1.5.</strong> provider 块</a></p>
</li>
<li>
<p><a href="#module-%E5%9D%97"><strong>1.8.1.6.</strong> module 块</a></p>
</li>
<li>
<p><a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81"><strong>1.8.1.6.1.</strong> 模块状态</a></p>
</li>
<li>
<p><a href="#%E9%A2%84%E6%9C%9F%E5%A4%B1%E8%B4%A5"><strong>1.8.1.7.</strong> 预期失败</a></p>
</li>
</ul>
<p><a href="#%E6%B5%8B%E8%AF%95"></a></p>
<h2 id="1-8-1-测试"><a href="#%E6%B5%8B%E8%AF%95"></a>1.8.1. 测试</h2>
<p>-&gt; <strong>注意：</strong> 该测试框架在 Terraform v1.6.0 及以后版本中可用。</p>
<p>Terraform 测试功能允许模块作者验证配置变更不会引入破坏性更改。测试针对特定的、临时的资源进行，防止对现有的基础设施或状态产生任何风险。</p>
<h2 id="1-8-1-1-集成测试或单元测试"><a href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%88%96%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"></a>1.8.1.1. 集成测试或单元测试</h2>
<p>默认情况下，Terraform 测试会创建真实的基础设施，并可以对这些基础设施进行断言和验证。这相当于集成测试，它通过调用 Terraform 创建基础设施并对其进行验证来测试 Terraform 的核心功能。</p>
<p>你可以通过更新 <a href="#run-%E5%9D%97"><code>run</code></a> 块中的 <code>command</code> 属性（下面有示例）来覆盖默认的测试行为。默认情况下，每个 <code>run</code> 块都会执行 <code>command = apply</code>，命令 Terraform 对你的配置执行完整的 <code>apply</code> 操作。将 <code>command</code> 值替换为 <code>command = plan</code> 会告诉 Terraform 不为这个 <code>run</code> 块创建新的基础设施。这将允许测试作者验证他们的基础设施中的逻辑操作和自定义条件，相当于编写了单元测试。</p>
<p>Terraform v1.7.0 引入了在 <code>terraform test</code> 执行期间模拟 Provider 返回数据的能力。这可以用于编写更详细和完整的单元测试。</p>
<h2 id="1-8-1-2-语法"><a href="#%E8%AF%AD%E6%B3%95"></a>1.8.1.2. 语法</h2>
<p>每个 Terraform 测试都保存在一个测试文件中。Terraform 根据文件扩展名发现测试文件：<code>.tftest.hcl</code> 或 <code>.tftest.json</code>。</p>
<p>每个测试文件包含以下根级别的属性和块：</p>
<ul>
<li>一个到多个 <a href="#run-%E5%9D%97"><code>run</code></a> 块。</li>
<li>零个到一个 <a href="#variable-%E5%9D%97"><code>variables</code></a> 块。</li>
<li>零个到多个 <a href="#provider-%E5%9D%97"><code>provider</code></a> 块。</li>
</ul>
<p>Terraform 按顺序执行 <code>run</code> 块，模拟一系列直接在配置目录中执行的 Terraform 命令。 <code>variables</code> 和 <code>provider</code> 块的顺序并不重要，Terraform 在测试操作开始时处理这些块中的所有值。我们建议首先在测试文件的开头定义你的 <code>variables</code> 和 <code>provider</code> 块。</p>
<h3 id="1-8-1-2-1-示例"><a href="#%E7%A4%BA%E4%BE%8B"></a>1.8.1.2.1. 示例</h3>
<p>以下示例演示了一个简单的 Terraform 配置，该配置创建了一个 AWS S3 存储桶，并使用输入变量来修改其名称。我们将创建一个示例测试文件（如下）来验证存储桶的名称是否如预期那样被创建。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-bucket&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;bucket_name&quot; &#123;</span><br><span class="line">  value = aws_s3_bucket.bucket.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下测试文件运行了一个单独的Terraform <code>plan</code> 命令，该命令创建了S3存储桶，然后通过检查实际名称是否与预期名称匹配，来验证计算名称的逻辑是否正确。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># valid_string_concat.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;valid_string_concat&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-8-1-3-run-块"><a href="#run-%E5%9D%97"></a>1.8.1.3. run 块</h2>
<p>每个 <code>run</code> 块都有以下字段和块：</p>
<table>
<thead>
<tr>
<th>字段或块名称</th>
<th>描述</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>一个可选属性，可以是 <code>apply</code> 或 <code>plan</code>。</td>
<td><code>apply</code></td>
</tr>
<tr>
<td><code>plan_options.mode</code></td>
<td>一个可选属性，可以是 <code>normal</code> 或 <code>refresh-only</code>。</td>
<td><code>normal</code></td>
</tr>
<tr>
<td><code>plan_options.refresh</code></td>
<td>一个可选的 <code>bool</code> 属性。</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>plan_options.replace</code></td>
<td>一个可选属性，包含一个资源地址列表，引用测试配置中的资源。</td>
<td></td>
</tr>
<tr>
<td><code>plan_options.target</code></td>
<td>一个可选属性，包含一个资源地址列表，引用测试配置中的资源。</td>
<td></td>
</tr>
<tr>
<td><a href="#variable-%E5%9D%97"><code>variables</code></a></td>
<td>一个可选的 <code>variables</code> 块。</td>
<td></td>
</tr>
<tr>
<td><a href="#module-%E5%9D%97"><code>module</code></a></td>
<td>一个可选的 <code>module</code> 块。</td>
<td></td>
</tr>
<tr>
<td><a href="#provider-%E5%9D%97"><code>providers</code></a></td>
<td>一个可选的 <code>providers</code> 属性。</td>
<td></td>
</tr>
<tr>
<td><a href="#%E6%96%AD%E8%A8%80"><code>assert</code></a></td>
<td>可选的 <code>assert</code> 块。</td>
<td></td>
</tr>
<tr>
<td><code>expect_failures</code></td>
<td>一个可选属性。</td>
<td></td>
</tr>
</tbody>
</table>
<p><code>command</code> 属性和 <code>plan_options</code> 块告诉 Terraform 对于每个 <code>run</code> 块执行哪个命令和选项。如果您没有指定 <code>command</code> 属性或 <code>plan_options</code> 块，那么默认操作是普通的 <code>terraform apply</code> 操作。</p>
<p><code>command</code> 属性指明操作应该是一个 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/14.plan"><code>plan</code></a> 操作还是一个 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/6.Terraform%E5%91%BD%E4%BB%A4%E8%A1%8C/4.apply"><code>apply</code></a> 操作。</p>
<p><code>plan_options</code> 块允许测试的作者定义他们通常需要通过命令行标志和选项定义的 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/commands/plan#planning-modes">plan mode</a> 和 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/cli/commands/plan#planning-options">选项</a>。我们将在 <a href="#variable-%E5%9D%97">变量</a> 部分介绍 <code>-var</code> 和 <code>-var-file</code> 选项。</p>
<h3 id="1-8-1-3-1-断言"><a href="#%E6%96%AD%E8%A8%80"></a>1.8.1.3.1. 断言</h3>
<p>Terraform 测试的 <code>run</code> 块断言是<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">自定义条件</a>，由<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">条件</a>和<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions#error-messages">错误消息</a>组成。</p>
<p>在 Terraform 测试命令执行结束时，Terraform 会将所有失败的断言作为测试通过或失败状态的一部分展示出来。</p>
<h4 id="断言中的引用"><a href="#%E6%96%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"></a>断言中的引用</h4>
<p>测试中的断言可以引用主 Terraform 配置中的其他自定义条件可用的任何现有<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/8.%E8%A1%A8%E8%BE%BE%E5%BC%8F#%E5%BC%95%E7%94%A8%E5%91%BD%E5%90%8D%E5%80%BC">命名值</a>。</p>
<p>此外，测试断言可以直接引用当前和先前 <code>run</code> 块的输出。比如引用了<a href="#%E7%A4%BA%E4%BE%8B">上一个示例</a>中的输出的一个合法的表达式条件：<code>condition = output.bucket_name == &quot;test_bucket&quot;</code>。</p>
<h2 id="1-8-1-4-variable-块"><a href="#variable-%E5%9D%97"></a>1.8.1.4. variable 块</h2>
<p>你可以直接在你的测试文件中为 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F">输入变量</a> 设置值。</p>
<p>你可以在测试文件的根级别或者 <code>run</code> 块内部定义 <code>variables</code> 块。Terraform 将测试文件中的所有变量值传递到文件中的所有 <code>run</code> 块。你可以通过在某个 <code>run</code> 块中直接设置变量值来覆盖从根部继承的值。</p>
<p>在上述 <a href="#%E7%A4%BA%E4%BE%8B">示例</a> 的测试文件中添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># variable_precedence.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;uses_root_level_value&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;overrides_root_level_value&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    bucket_prefix = &quot;other&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;other-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们添加了第二个 <code>run</code> 块，该块指定 <code>bucket_prefix</code> 变量值为 <code>other</code>，覆盖了测试文件提供的，并在第一个 <code>run</code> 块中使用的值 —— <code>test</code>。</p>
<h3 id="1-8-1-4-1-通过命令行或定义文件指定变量"><a href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%88%96%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9A%E5%8F%98%E9%87%8F"></a>1.8.1.4.1. 通过命令行或定义文件指定变量</h3>
<p>除了通过测试文件指定变量值外，Terraform <code>test</code> 命令还支持指定变量值的其他方法。</p>
<p>您可以通过 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0">命令行</a> 和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E5%8F%82%E6%95%B0%E6%96%87%E4%BB%B6">变量定义文件</a> 为所有测试指定变量值。</p>
<p>像普通的 Terraform 命令一样，Terraform 会自动加载测试目录中定义的任何变量文件。自动变量文件包括 <code>terraform.tfvars</code>、<code>terraform.tfvars.json</code>，以及所有以 <code>.auto.tfvars</code> 或 <code>.auto.tfvars.json</code> 结尾的文件。</p>
<p><strong>注意：</strong> 从测试目录中的自动变量文件加载的变量值只适用于在同一测试目录中定义的测试。以所有其他方式定义的变量将适用于给定测试运行中的所有测试。</p>
<p>这在使用敏感变量值和设置 Provider 配置时特别有用。否则，测试文件可能会直接暴露这些敏感值。</p>
<h3 id="1-8-1-4-2-变量定义优先级"><a href="#%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89%E4%BC%98%E5%85%88%E7%BA%A7"></a>1.8.1.4.2. 变量定义优先级</h3>
<p>除了测试文件中设置的变量值，<a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/3.Terraform%E4%BB%A3%E7%A0%81%E7%9A%84%E4%B9%A6%E5%86%99/3.%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F#%E8%BE%93%E5%85%A5%E5%8F%98%E9%87%8F%E8%B5%8B%E5%80%BC%E4%BC%98%E5%85%88%E7%BA%A7">变量定义优先级</a> 在测试中保持不变。在测试文件中定义的变量具有最高优先级，可以覆盖环境变量、变量文件或命令行输入。</p>
<p>对于在测试目录中定义的测试，任何在测试目录的自动变量文件中定义的变量值都将覆盖主配置目录的自动变量文件中定义的值。</p>
<h3 id="1-8-1-4-3-变量中的引用"><a href="#%E5%8F%98%E9%87%8F%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8"></a>1.8.1.4.3. 变量中的引用</h3>
<p>在 <code>run</code> 块中定义的 <code>variable</code> 中可以引用在先前 <code>run</code> 块中执行的模块的输出和在更高优先级定义的变量。</p>
<p>例如，以下代码块显示了变量如何引用更高优先级的变量和先前的 <code>run</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">variables &#123;</span><br><span class="line">  global_value = &quot;some value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;run_block_one&quot; &#123;</span><br><span class="line">  variables &#123;</span><br><span class="line">    local_value = var.global_value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">  # 这里应该有一些测试断言</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;run_block_two&quot; &#123;</span><br><span class="line">  variables &#123;</span><br><span class="line">    local_value = run.run_block_one.output_one</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ...</span><br><span class="line">  # 这里应该有一些测试断言</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面，<code>run_block_one</code> 中的 <code>local_value</code> 从 <code>global_value</code> 变量获取值。如果你想给多个变量分配相同的值，这种模式很有用。你可以在文件级别一次指定一个变量的值，然后与不同的变量共享它。</p>
<p>相比之下，<code>run_block_two</code> 中的 <code>local_value</code> 引用了 <code>run_block_one</code> 的 <code>output_one</code> 的输出值。这种模式对于在 <code>run</code> 块之间传递值特别有用，特别是如果 <code>run</code> 块正在执行<a href="#module-%E5%9D%97">模块</a>部分中详细描述的不同模块。</p>
<h2 id="1-8-1-5-provider-块"><a href="#provider-%E5%9D%97"></a>1.8.1.5. provider 块</h2>
<p>您可以通过使用 <code>provider</code> 和 <code>providers</code> 块和属性，在测试文件中设置或覆盖 Terraform 代码所需的 Provider。</p>
<p>您可以在 Terraform 测试文件的根级别，定义 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/providers/configuration"><code>provider</code> 块</a>，就像在 Terraform <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/providers">配置代码中</a>创建它们一样。然后，Terraform 会将这些 <code>provider</code> 块传递到其配置中，每个 <code>run</code> 块执行时都是如此。</p>
<p>默认情况下，您指定的每个 Provider 都直接在每个 <code>run</code> 块中可用。您可以通过使用 <code>providers</code> 属性在特定 <code>run</code> 块中设置 Provider 的可用性。这个块的行为和语法与 <a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/meta-arguments/module-providers">providers meta-argument</a> 的行为相匹配。</p>
<p>如果您在测试文件中不提供 Provider 配置，Terraform 会尝试使用 Provider 的默认设置初始化其配置中的所有 Provider。例如，任何旨在配置 Provider 的环境变量仍然可用，并且 Terraform 可以使用它们来创建默认 Provider。</p>
<p>下面，我们将扩展我们之前的 <a href="#%E7%A4%BA%E4%BE%8B">示例</a>，用测试代码而不是 Terraform 配置代码来指定 <code>region</code>。在这个示例中，我们将测试以下配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source = &quot;hashicorp/aws&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-bucket&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;bucket_name&quot; &#123;</span><br><span class="line">  value = aws_s3_bucket.bucket.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们现在可以在以下测试文件中定义如下的 <code>provider</code> 块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># customised_provider.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket_prefix = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;valid_string_concat&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.bucket.bucket == &quot;test-bucket&quot;</span><br><span class="line">    error_message = &quot;S3 bucket name did not match expected&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们也可以创建一个更复杂的示例配置，使用多个 Provider 以及别名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source                = &quot;hashicorp/aws&quot;</span><br><span class="line">      configuration_aliases = [aws.secondary]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  default = &quot;test&quot;</span><br><span class="line">  type    = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;primary_bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-primary&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;secondary_bucket&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">  bucket   = &quot;$&#123;var.bucket_prefix&#125;-secondary&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们的测试文件中，我们可以设定多个 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># customised_providers.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;secondary&quot;</span><br><span class="line">  region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们也可以在特定 <code>run</code> 块中声明特定的 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source                = &quot;hashicorp/aws&quot;</span><br><span class="line">      configuration_aliases = [aws.secondary]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_region&quot; &quot;primary&quot; &#123;&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_region&quot; &quot;secondary&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bucket_prefix&quot; &#123;</span><br><span class="line">  default = &quot;test&quot;</span><br><span class="line">  type    = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;primary_bucket&quot; &#123;</span><br><span class="line">  bucket = &quot;$&#123;var.bucket_prefix&#125;-$&#123;data.aws_region.primary.name&#125;-primary&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;secondary_bucket&quot; &#123;</span><br><span class="line">  provider = aws.secondary</span><br><span class="line">  bucket   = &quot;$&#123;var.bucket_prefix&#125;-$&#123;data.aws_region.secondary.name&#125;-secondary&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的测试文件可以为不同的 <code>run</code> 块配置的 Provider：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># customised_providers.tftest.hcl</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;secondary&quot;</span><br><span class="line">  region = &quot;eu-central-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  alias  = &quot;tertiary&quot;</span><br><span class="line">  region = &quot;eu-west-2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;default_providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-us-east-1-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-eu-central-1-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;customised_providers&quot; &#123;</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  providers = &#123;</span><br><span class="line">    aws           = aws</span><br><span class="line">    aws.secondary = aws.tertiary</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.primary_bucket.bucket == &quot;test-us-east-1-primary&quot;</span><br><span class="line">    error_message = &quot;invalid value for primary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition     = aws_s3_bucket.secondary_bucket.bucket == &quot;test-eu-west-2-secondary&quot;</span><br><span class="line">    error_message = &quot;invalid value for secondary S3 bucket&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> 在使用 <code>command = apply</code> 运行测试时，<code>run</code> 块之间切换 Provider 可能会导致运行和测试失败，因为由一个 Provider 定义创建的资源在被另一个修改时将无法使用。</p>
<p>从 Terraform v1.7.0 开始，<code>provider</code> 块也可以引用测试文件变量和 <code>run</code> 块输出。这意味着测试框架可以从一个 Provider 获取凭证和其他设置信息，并在初始化第二个 Provider 时使用这些信息。</p>
<p>在下面的示例中，首先初始化 <code>vault</code> Provider，然后在一个设置模块中使用它来提取 <code>aws</code> Provider 的凭证。有关 setup 模块的更多信息，请参阅 <a href="#module-%E5%9D%97">模块</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">provider &quot;vault&quot; &#123;</span><br><span class="line">  # ... vault configuration ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region     = &quot;us-east-1&quot;</span><br><span class="line"></span><br><span class="line">  # The `aws` provider can reference the outputs of the &quot;vault_setup&quot; run block.</span><br><span class="line">  access_key = run.vault_setup.aws_access_key</span><br><span class="line">  secret_key = run.vault_setup.aws_secret_key</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;vault_setup&quot; &#123;</span><br><span class="line">  module &#123;</span><br><span class="line">    # This module should only include reference to the Vault provider. Terraform</span><br><span class="line">    # will automatically work out which providers to supply based on the module</span><br><span class="line">    # configuration. The tests will error if a run block requires access to a</span><br><span class="line">    # provider that references outputs from a run block that has not executed.</span><br><span class="line">    source = &quot;./testing/vault-setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;use_aws_provider&quot; &#123;</span><br><span class="line">  # This run block can then use both the `aws` and `vault` providers, as the</span><br><span class="line">  # previous run block provided all the data required for the `aws` provider.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-8-1-6-module-块"><a href="#module-%E5%9D%97"></a>1.8.1.6. module 块</h2>
<p>您可以修改特定的 <code>run</code> 块执行的模块。</p>
<p>默认情况下，Terraform 针对正在测试的配置代码，依次执行所有 <code>run</code> 块中设定的命令。Terraform 在您执行 <code>terraform test</code> 命令的目录（或者您用 <code>-chdir</code> 参数指向的目录）内测试配置。每个 <code>run</code> 块也允许用户使用 <code>module</code> 块更改目标配置。</p>
<p>与传统的 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97"><code>module</code> 块</a>不同，测试文件中的 <code>module</code> 块 <em>仅</em> 支持 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%A8%A1%E5%9D%97%E6%BA%90"><code>source</code></a> 属性和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%A8%A1%E5%9D%97%E7%89%88%E6%9C%AC%E7%BA%A6%E6%9D%9F"><code>version</code></a> 属性。通常通过传统的 <code>module</code> 块提供的其余属性应由 <code>run</code> 块内的替代属性和块提供。</p>
<p><strong>注意：</strong> Terraform 测试文件只支持 <code>source</code> 属性中的 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#%E6%9C%AC%E5%9C%B0%E8%B7%AF%E5%BE%84">本地</a> 和 <a target="_blank" rel="noopener" href="https://lonegunmanb.github.io/introduction-terraform/7.test/5.Terraform%E6%A8%A1%E5%9D%97/2.%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97#terraform-registry">注册表</a> 模块。</p>
<p>在执行其他模块时，<code>run</code> 块内的所有其他块和属性都受支持，<code>assert</code> 块执行时使用来自其他模块的值。这在 <a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81">模块状态</a> 中有更详细的说明。</p>
<p>测试文件中 <code>modules</code> 块的两个示例用例是：</p>
<ol>
<li>一个设置模块，为待测 Terraform 配置代码创建测试所需的基础设施。</li>
<li>一个加载模块，用于加载和验证 Terraform 配置代码未直接创建的次要基础设施（如数据源）。</li>
</ol>
<p>以下示例演示了这两种用例。</p>
<p>首先，我们有一个模块，它将创建并将多个文件加载到已创建的 S3 存储桶中。这是我们要测试的配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;files&quot; &#123;</span><br><span class="line">  type = map(string)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_object&quot; &quot;object&quot; &#123;</span><br><span class="line">  for_each = var.files</span><br><span class="line"></span><br><span class="line">  bucket = data.aws_s3_bucket.bucket.id</span><br><span class="line">  key = each.key</span><br><span class="line">  source = each.value</span><br><span class="line"></span><br><span class="line">  etag = filemd5(each.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们使用配置模块创建这个 S3 存储桶，这样在测试时就可以使用它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># testing/setup/main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三步，我们使用一个加载模块，读取 S3 存储桶中的文件。这是一个比较牵强的例子，因为我们完全可以直接在创建这些文件的模块中创建这些数据源，但它在这里可以很好地演示如何编写测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># testing/loader/main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;bucket&quot; &#123;</span><br><span class="line">  type = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_s3_objects&quot; &quot;objects&quot; &#123;</span><br><span class="line">  bucket = var.bucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们使用测试文件把刚才创建的多个助手模块以及待测模块编织在一起形成一个有效的测试配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># file_count.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  bucket = &quot;my_test_bucket&quot;</span><br><span class="line">  files = &#123;</span><br><span class="line">    &quot;file-one.txt&quot;: &quot;data/files/file_one.txt&quot;</span><br><span class="line">    &quot;file-two.txt&quot;: &quot;data/files/file_two.txt&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;setup&quot; &#123;</span><br><span class="line">  # Create the S3 bucket we will use later.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;execute&quot; &#123;</span><br><span class="line">  # This is empty, we just run the configuration under test using all the default settings.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;verify&quot; &#123;</span><br><span class="line">  # Load and count the objects created in the &quot;execute&quot; run block.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/loader&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    condition = length(data.aws_s3_objects.objects.keys) == 2</span><br><span class="line">    error_message = &quot;created the wrong number of s3 objects&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-8-1-6-1-模块状态"><a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81"></a>1.8.1.6.1. 模块状态</h3>
<p>当 Terraform 执行 <code>terraform test</code> 命令时，Terraform 会为每个测试文件在内存中维护一个或多个状态文件。</p>
<p>总是至少有一个状态文件维护在测试下的 Terraform 配置代码的状态。这个状态文件由所有没有 <code>module</code> 块指定要加载的替代模块的 <code>run</code> 块共享。</p>
<p>此外，Terraform 加载的每个替代模块都有一个状态文件。一个替代模块的状态文件被执行给定模块的所有 <code>run</code> 块共享。</p>
<p>Terraform 团队对任何需要手动状态管理或在 <code>test</code> 命令中对同一状态执行不同配置的用例感兴趣。如果你有一个用例，请提交一个 <a target="_blank" rel="noopener" href="https://github.com/hashicorp/terraform/issues/new/choose">issue</a>并与我们分享。</p>
<p>以下示例使用注释来解释每个 <code>run</code> 块的状态文件的来源。在下面的示例中，Terraform 创建并管理了总共三个状态文件。第一个状态文件是针对测试下的主模块，第二个是针对设置模块，第三个是针对加载模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">run &quot;setup&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block references an alternate module and is the first run block</span><br><span class="line">  # to reference this particular alternate module. Therefore, Terraform creates</span><br><span class="line">  # and populates a new empty state file for this run block.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;init&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block does not reference an alternate module, so it uses the main</span><br><span class="line">  # state file for the configuration under test. As this is the first run block</span><br><span class="line">  # to reference the main configuration, the previously empty state file now</span><br><span class="line">  # contains the resources created by this run block.</span><br><span class="line"></span><br><span class="line">  assert &#123;</span><br><span class="line">    # In practice we&#x27;d do some interesting checks and tests here but the</span><br><span class="line">    # assertions aren&#x27;t important for this example.</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ... more assertions ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;update_setup&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # We&#x27;ve now re-referenced the setup module, so the state file that was created</span><br><span class="line">  # for the first &quot;setup&quot; run block will be reused. It will contain any</span><br><span class="line">  # resources that were created as part of the other run block before this run</span><br><span class="line">  # block executes and will be updated with any changes made by this run block</span><br><span class="line">  # after.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/setup&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    # In practice, we&#x27;d likely make some changes to the module compared to the</span><br><span class="line">    # first run block here. Otherwise, there would be no point recalling the</span><br><span class="line">    # module.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;update&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # As with the &quot;init&quot; run block, we are executing against the main configuration</span><br><span class="line">  # again. This means we&#x27;d load the main state file that was initially populated</span><br><span class="line">  # by the &quot;init&quot; run block, and any changes made by this &quot;run&quot; block will be</span><br><span class="line">  # carried forward to any future run blocks that execute against the main</span><br><span class="line">  # configuration.</span><br><span class="line"></span><br><span class="line">  # ... updated variables ...</span><br><span class="line"></span><br><span class="line">  # ... assertions ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;loader&quot; &#123;</span><br><span class="line"></span><br><span class="line">  # This run block is now referencing our second alternate module so will create</span><br><span class="line">  # our third and final state file. The other two state files are managing</span><br><span class="line">  # resources from the main configuration and resources from the setup module.</span><br><span class="line">  # We are getting a new state file for this run block as the loader module has</span><br><span class="line">  # not previously been referenced by any run blocks.</span><br><span class="line"></span><br><span class="line">  module &#123;</span><br><span class="line">    source = &quot;./testing/loader&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="模块的清理"><a href="#%E6%A8%A1%E5%9D%97%E7%9A%84%E6%B8%85%E7%90%86"></a>模块的清理</h4>
<p>在测试文件执行结束时，Terraform 会试图销毁在该测试文件执行过程中创建的每个资源。当 Terraform 加载替代模块时，Terraform 销毁这些对象的顺序很重要。例如，在第一个 <a href="#module-%E5%9D%97">模块</a> 示例中，Terraform 不能在 “execute” <code>run</code> 块中创建的对象之前销毁在 “setup” <code>run</code> 块中创建的资源，因为我们在 “setup” 步骤中创建的 S3 桶在包含对象的情况下无法被销毁。</p>
<p>Terraform 按照 <code>run</code> 块的反向顺序销毁资源。在最近的 <a href="#%E6%A8%A1%E5%9D%97%E7%8A%B6%E6%80%81">例子</a> 中，有三个状态文件。一个用于主状态，一个用于 <code>./testing/loader</code> 模块，还有一个用于 <code>./testing/setup</code> 模块。由于 <code>./testing/loader</code> 状态文件最近被最后一个运行块引用，因此首先被销毁。主状态文件将被第二个销毁，因为它被 “update” <code>run</code> 块引用。然后 <code>./testing/setup</code> 状态文件将被最后销毁。</p>
<p>请注意，前两个 <code>run</code> 块 “setup” 和 “init” 在销毁操作中不做任何事情，因为它们的状态文件被后续的 run 块使用，并且已经被销毁。</p>
<p>如果你使用单个设置模块作为替代模块，并且它首先执行，或者你不使用任何替代模块，那么销毁顺序不会影响你。更复杂的情况可能需要仔细考虑，以确保资源的销毁可以自动完成。</p>
<h2 id="1-8-1-7-预期失败"><a href="#%E9%A2%84%E6%9C%9F%E5%A4%B1%E8%B4%A5"></a>1.8.1.7. 预期失败</h2>
<p>默认情况下，如果在执行 Terraform 测试文件期间，任何<a target="_blank" rel="noopener" href="https://developer.hashicorp.com/terraform/language/expressions/custom-conditions">自定义条件</a>，包括 <code>check</code> 块断言失败，则整体命令会将测试报告为失败。</p>
<p>然而，我们经常想要测试代码运行失败时的行为。Terraform 为此用例提供了 <code>expect_failures</code> 属性。</p>
<p>在每个 <code>run</code> 块中，<code>expect_failures</code> 属性可以设置应该导致自定义条件检查失败的可检查对象（资源，数据源，检查块，输入变量和输出）的列表。如果您指定的可检查对象报告问题，测则试通过，如果没有报告错误，那么测试总体上失败。</p>
<p>您仍然可以在 <code>expect_failures</code> 块附近编写断言，但您应该注意，除了 <code>check</code> 块断言外，所有自定义条件都会停止 Terraform 的执行。这在测试执行期间仍然适用，所以这些断言应该只考虑你确定会在可检查对象应该失败之前可知的值。您可以使用引用或在主配置中的 <code>depends_on</code> 元参数来管理这一点。</p>
<p>这也意味着，除了 <code>check</code> 块，你只能可靠地包含一个可检查的对象。我们支持在 <code>expect_failures</code> 属性中列出可检查对象的列表，仅用于 <code>check</code> 块。</p>
<p>下面的一个快速示例演示了测试输入变量的 <code>validation</code> 块。配置文件接受一个必须是偶数的单一输入变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># main.tf</span><br><span class="line"></span><br><span class="line">variable &quot;input&quot; &#123;</span><br><span class="line">  type = number</span><br><span class="line"></span><br><span class="line">  validation &#123;</span><br><span class="line">    condition = var.input % 2 == 0</span><br><span class="line">    error_message = &quot;must be even number&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试文件包含了两个 <code>run</code> 块。一个验证了我们的自定义条件在偶数条件下是通过的，另一个验证输入奇数时会失败。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># input_validation.tftest.hcl</span><br><span class="line"></span><br><span class="line">variables &#123;</span><br><span class="line">  input = 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;zero&quot; &#123;</span><br><span class="line">  # The variable defined above is even, so we expect the validation to pass.</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run &quot;one&quot; &#123;</span><br><span class="line">  # This time we set the variable is odd, so we expect the validation to fail.</span><br><span class="line"></span><br><span class="line">  command = plan</span><br><span class="line"></span><br><span class="line">  variables &#123;</span><br><span class="line">    input = 1</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  expect_failures = [</span><br><span class="line">    var.input,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：Terraform 只期望在 <code>run</code> 块的 <code>command</code> 属性指定的操作中出现失败。</p>
<p>在使用 <code>command = apply</code> 的 <code>run</code> 块中使用 <code>expect_failures</code> 时要小心。一个 <code>run</code> 块中的 <code>command = apply</code> 如果期望自定义条件失败，那么如果该自定义条件在 <code>plan</code> 期间失败，整体将会失败。</p>
<p>这在逻辑上是正确的，因为 <code>run</code> 块期望能够运行应用操作，但由于 <code>plan</code> 失败而不能运行，但这也可能会引起混淆，因为即使那个失败被标记为预期的，你还是会在诊断中看到失败。</p>
<p>有时，Terraform 在计划阶段不执行自定义条件，因为该条件依赖于只有在 Terraform 创建引用资源后才可用的计算属性。在这些情况下，你可以在设置 <code>command = apply</code> 时使用 <code>expect_failures</code> 块。然而，大多数情况下，我们建议只在 <code>command = plan</code> 时使用 <code>expect_failures</code>。</p>
<p><strong>注意</strong>：预期的失败只适用于用户定义的自定义条件。</p>
<p>除了在可检查对象中指定的预期失败之外的其他种类的失败仍会导致整体测试失败。例如，一个期望布尔值作为输入的变量，如果 Terraform 收到的是错误的值类型，即使该变量包含在 <code>expect_failures</code> 属性中，也会导致周围的测试失败。</p>
<p><code>expect_failures</code> 属性包含在其中是为了允许作者测试他们的配置和任何定义的逻辑。像前面的例子中的类型不匹配错误，不是 Terraform 作者应该担心和测试的事情，因为 Terraform 本身会处理强制类型约束。因此，你只能在自定义条件中 <code>expect_failures</code>。</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">標籤</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="../../../../../tags/Terraform/" rel="tag">Terraform</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    data-tooltip="Terraform-小技巧"
                    aria-label="上一篇: Terraform-小技巧"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../28/Teraform/Terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C2/"
                    data-tooltip="Terraform-命令行2"
                    aria-label="下一篇: Terraform-命令行2"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Kein Chan. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../30/Teraform/Terraform-%E5%B0%8F%E6%8A%80%E5%B7%A7/"
                    data-tooltip="Terraform-小技巧"
                    aria-label="上一篇: Terraform-小技巧"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="../../../28/Teraform/Terraform-%E5%91%BD%E4%BB%A4%E8%A1%8C2/"
                    data-tooltip="Terraform-命令行2"
                    aria-label="下一篇: Terraform-命令行2"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                        aria-label="global.share_on_linkedin"
                    >
                        <i class="fab fa-linkedin" aria-hidden="true"></i><span>global.share_on_linkedin</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://keinchan.com/2023/01/29/Teraform/Terraform-%E6%B5%8B%E8%AF%95/"
                        aria-label="分享到 Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="../../../../../assets/images/profile.jpg" alt="作者的圖片"/>
        
            <h4 id="about-card-name">Kein Chan</h4>
        
            <div id="about-card-bio"><p>這是獨立全棧工程師Kein Chan的技術博客</br>分享一些技術教程,命令備忘(cheat-sheet)等</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>全棧工程師</br>資深技術顧問</br>數據科學家</br>Hit廣島觀光大使</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Tokyo/Macau
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="../assets/images/logo-algolia-nebula-blue-full.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">沒有找到文章</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/04/27/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/"
                            aria-label=": R语言-环境安装"
                        >
                            <h3 class="media-heading">R语言-环境安装</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月27日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/04/28/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E5%9F%BA%E7%A1%80/"
                            aria-label=": R语言-基础"
                        >
                            <h3 class="media-heading">R语言-基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月28日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/01/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE/"
                            aria-label=": R语言-读取数据"
                        >
                            <h3 class="media-heading">R语言-读取数据</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月1日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/02/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BB%98%E5%9B%BE/"
                            aria-label=": R语言-绘图"
                        >
                            <h3 class="media-heading">R语言-绘图</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月2日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2013/05/03/R%E8%AF%AD%E8%A8%80/R%E8%AF%AD%E8%A8%80-%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/"
                            aria-label=": R语言-线性回归"
                        >
                            <h3 class="media-heading">R语言-线性回归</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月3日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/22/Algorithms/1.%E7%AE%97%E6%B3%95%E5%9C%A8%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8/"
                            aria-label=": 1. 算法在计算中的作用"
                        >
                            <h3 class="media-heading">1. 算法在计算中的作用</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月22日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/23/Algorithms/2.%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/"
                            aria-label=": 2. 算法基础"
                        >
                            <h3 class="media-heading">2. 算法基础</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/24/Algorithms/3.%E5%87%BD%E6%95%B0%E7%9A%84%E5%A2%9E%E9%95%BF/"
                            aria-label=": 3. 函数的增长"
                        >
                            <h3 class="media-heading">3. 函数的增长</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月24日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/25/Algorithms/4.%E5%88%86%E6%B2%BB%E7%AD%96%E7%95%A5/"
                            aria-label=": 4. 分治策略"
                        >
                            <h3 class="media-heading">4. 分治策略</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月25日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://keinchan.com/2015/02/26/Algorithms/5.%E6%A6%82%E7%8E%87%E5%88%86%E6%9E%90%E5%92%8C%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/"
                            aria-label=": 5. 概率分析和随机算法"
                        >
                            <h3 class="media-heading">5. 概率分析和随机算法</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2015年2月26日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="沒有找到文章"
                data-message-one="找到 1 篇文章"
                data-message-other="找到 {n} 篇文章">
                找到 235 篇文章
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('../../../../../assets/images/cover.jpeg');"></div>
        <!--SCRIPTS-->

<script src="../../../../../assets/js/script-qtzvvb63gamuirvfphht7lytrxkfllzng1escnm2phjtlt4tvvxi5gl0wx4o.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
